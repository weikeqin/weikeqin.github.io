<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"weikeqin.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true,"width":240},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="不积跬步无以至千里">
<meta property="og:type" content="website">
<meta property="og:title" content="天道酬勤">
<meta property="og:url" content="http://weikeqin.com/page/9/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="不积跬步无以至千里">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="tech,Java,Redis,MySQL,ElasticSearch,Neo4j,DDD">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://weikeqin.com/page/9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>天道酬勤</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113485469-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-113485469-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">天道酬勤</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">坚持，努力，让好事发生</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/11/22/sentinel-flow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/22/sentinel-flow/" class="post-title-link" itemprop="url">Sentinel限流源码解读</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-22 09:05:52" itemprop="dateCreated datePublished" datetime="2020-11-22T09:05:52+08:00">2020-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-11 23:33:24" itemprop="dateModified" datetime="2023-03-11T23:33:24+08:00">2023-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          
            <span id="/2020/11/22/sentinel-flow/" class="post-meta-item leancloud_visitors" data-flag-title="Sentinel限流源码解读" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/11/22/sentinel-flow/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/11/22/sentinel-flow/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-原理"><a href="#1-原理" class="headerlink" title="(1) 原理"></a>(1) 原理</h1><p>  流量控制（flow control），其原理是监控应用流量的 QPS 或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</p>
<p> 假如让自己实现一个限流算法，怎么实现？</p>
<h2 id="1-1-计数器限流算法"><a href="#1-1-计数器限流算法" class="headerlink" title="(1.1) 计数器限流算法"></a>(1.1) 计数器限流算法</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="2-限流配置"><a href="#2-限流配置" class="headerlink" title="(2) 限流配置"></a>(2) 限流配置</h1><p>sentinel<br>限流类型(2种)<br>  线程数限流<br>  QPS数限流</p>
<p>限流策略/流控模式(3种)<br>  直接限流、关联限流、链路限流</p>
<p>流控效果(3种)<br>  直接拒绝、Ware Up、排队等待</p>
<br>


<h1 id="3-限流源码"><a href="#3-限流源码" class="headerlink" title="(3) 限流源码"></a>(3) 限流源码</h1><p>  源码流程图  todo<br>  时序图 todo</p>
<p>限流有比较重要的几个点<br>1.限流配置 限流配置管理<br>2.限流算法 限流实现<br>3.</p>
<h2 id="3-1-限流配置管理-FlowRuleManager"><a href="#3-1-限流配置管理-FlowRuleManager" class="headerlink" title="(3.1) 限流配置管理-FlowRuleManager"></a>(3.1) 限流配置管理-FlowRuleManager</h2><p>  FlowRuleManager对象主要职责是管理资源的限流配置</p>
<p>  资源对应的流控配置保存在 <code>Map&lt;String, List&lt;FlowRule&gt;&gt; flowRules</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 一个资源可以有多个规则/配置。这些规则按以下顺序生效：
 *  来自指定呼叫方的请求
 *  没有指定的调用者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowRuleManager</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/** 资源和对应限流配置集合 重要 */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> flowRules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">FlowPropertyListener</span> <span class="token constant">LISTENER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowPropertyListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**  */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">SentinelProperty</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> currentProperty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicSentinelProperty</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** 
     * 定时任务线程池 
     * SCHEDULER 的 corePool size 必须设置为 1，这样两个任务startMetricTimerListener()才能由SCHEDULER有序运行
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"PMD.ThreadPoolCreationRule"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token constant">SCHEDULER</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"sentinel-metrics-record-task"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        currentProperty<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token constant">LISTENER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">startMetricTimerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  这里用到了观察者模式，<code>DynamicSentinelProperty</code>是被观察者，<code>FlowRuleManager</code>是观察者，FlowRuleManager观察到配置变更后会通过<code>configUpdate</code>方法更新配置信息。</p>
<h3 id="3-1-1-限流规则对象-FlowRule"><a href="#3-1-1-限流规则对象-FlowRule" class="headerlink" title="(3.1.1) 限流规则对象-FlowRule"></a>(3.1.1) 限流规则对象-FlowRule</h3><p>  FlowRule对象的主要用来存配置信息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRule</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setLimitApp</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">LIMIT_APP_DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 流控类型  0:线程数限流  1:QPS限流
     * 默认使用 QPS限流
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> grade <span class="token operator">=</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 流量控制阈值。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> count<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 限流策略
     * 基于调用链的流量控制策略。 
     *
     * &#123;@link RuleConstant#STRATEGY_DIRECT&#125; 直接限流 (by origin);
     * &#123;@link RuleConstant#STRATEGY_RELATE&#125; 关联限流 (with relevant resource);
     * &#123;@link RuleConstant#STRATEGY_CHAIN&#125; 链路限流 (by entrance resource).
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> strategy <span class="token operator">=</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 具有相关资源或上下文的流量控制中的参考资源。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> refResource<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 流控效果
     *　
     * 0.直接拒绝(reject directly) 
     * 1.热启动(warm up)  
     * 2. 匀速排队(rate limiter) 
     * 3. 热启动 + 匀速排队 warm up + rate limiter
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> controlBehavior <span class="token operator">=</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">CONTROL_BEHAVIOR_DEFAULT</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 流控效果为预热启动时的预热时长 
     * 默认10s
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> warmUpPeriodSec <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 流控效果为排队等待时的等待时长
     * 默认500
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxQueueingTimeMs <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 集群模式
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> clusterMode<span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 集群模式的流规则配置。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ClusterFlowConfig</span> clusterConfig<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 流量整形(节流)控制器。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">TrafficShapingController</span> controller<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractRule</span> <span class="token keyword">implements</span> <span class="token class-name">Rule</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * 规则id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 规则名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> resource<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 将受来源限制的应用程序名称。
     * 默认的limitApp是"default"，即允许所有源应用。
     * 
     * 对于权限规则，多个源名称可以用逗号（','）分隔。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> limitApp<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="3-2-插槽-FlowSlot"><a href="#3-2-插槽-FlowSlot" class="headerlink" title="(3.2) 插槽-FlowSlot"></a>(3.2) 插槽-FlowSlot</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 结合从前面的插槽(NodeSelectorSlot、ClusterNodeBuilderSlot 和 StatisticSlot)收集的
 * 运行时统计信息，FlowSlot 将使用预设规则来决定是否应阻止传入请求。
 *
 * 如果触发任何规则，SphU.entry(resourceName) 将抛出 FlowException。 
 * 用户可以通过捕获 FlowException 来自定义自己的逻辑。
 *
 * 一个资源可以有多个流规则。 FlowSlot 遍历这些规则，直到其中一条被触发或者所有规则都被遍历。
 *
 * 每个FlowRule主要由这些因素组成：等级、策略、路径。 我们可以结合这些因素来达到不同的效果。
 * 
 * 等级由 FlowRule 中的 grade 字段定义。 
 * 此处，0 用于线程隔离，1 用于请求计数整形 (QPS)。 
 * 线程计数和请求计数都是在真实运行时收集的，
 * 我们可以通过以下命令查看这些统计信息：
 * &lt;pre>
 * curl http://localhost:8719/tree
 *
 * idx id    thread pass  blocked   success total aRt   1m-pass   1m-block   1m-all   exception
 * 2   abc647 0      460    46          46   1    27      630       276        897      0
 * &lt;/pre>
 *
 * thread 当前正在处理资源的线程数 
 * pass 一秒内传入请求数 
 * blocked 一秒内被阻塞的请求数 
 * success 一秒内被Sentinel成功处理的请求数 
 * RT 请求在一秒内的平均响应时间 
 * total 一秒内传入请求和阻塞请求的总和 
 * 1m-pass 为一分钟内传入请求数 
 * 1m-block 为一分钟内被阻塞的请求数 
 * 1m-all 是一分钟内传入和阻止的请求总数 
 * exception 为一秒内业务（自定义）异常的计数 
 * 
 * 这个阶段通常用于保护资源不被占用。 (达到限流阈值，服务快撑不住了)
 * 如果资源需要很长时间才能完成，线程将开始占用。 响应时间越长，占用的线程越多。
 * 
 * 除了计数器之外，线程池或信号量也可以用来实现这一点。
 * - 线程池：分配一个线程池来处理这些资源。 当池中不再有空闲线程时，拒绝请求而不影响其他资源。
 * - 信号量：使用信号量来控制该资源中线程的并发数。
 * 
 * 使用线程池的好处是，超时可以优雅的走开。 但它也给我们带来了上下文切换和额外线程的成本。 
 * 如果传入请求已经在单独的线程中提供服务，例如 Servlet HTTP 请求，那么如果使用线程池，线程数几乎会翻倍。
 * 
 * 
 * 流量整形 
 * 当QPS超过阈值时，Sentinel会采取动作控制传入的请求，由流规则中的 controlBehavior 字段配置。
 *   1.立即拒绝(Immediately reject)：默认行为。 超出的请求立即被拒绝 并抛出 FlowException
 *   2.热启动(Warmup) : 如果一段时间以来系统的负载很低，大量的请求来了，系统可能无法一次处理所有这些请求。 
 *        然而，如果我们稳定地增加传入请求，系统可以预热并最终能够处理所有请求。 
 *        可以通过在流规则中设置字段 warmUpPeriodSec 来配置此预热期。
 *   3.统一速率限制  此策略严格控制请求之间的间隔。换句话说，它允许请求以稳定、统一的速率传递。
 *        https://raw.githubusercontent.com/wiki/alibaba/Sentinel/image/uniform-speed-queue.png 
 *        该策略是漏桶算法的实现  https://en.wikipedia.org/wiki/Leaky_bucket  
 *        它用于以稳定的速率处理请求，通常用于突发业务（例如消息处理）。
 *        当大量超出系统容量的请求同时到达时，使用此策略的系统将处理请求及其固定速率，直到所有请求都已处理或超时。
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ORDER_FLOW_SLOT</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowSlot</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">FlowRuleChecker</span> checker<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FlowSlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlowRuleChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * Package-private for test.
     *
     * @param checker flow rule checker
     * @since 1.6.1
     */</span>
    <span class="token class-name">FlowSlot</span><span class="token punctuation">(</span><span class="token class-name">FlowRuleChecker</span> checker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">AssertUtil</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>checker<span class="token punctuation">,</span> <span class="token string">"flow checker should not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>checker <span class="token operator">=</span> checker<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>
                      <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 校验</span>
        <span class="token function">checkFlow</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 限流规则校验</span>
    <span class="token keyword">void</span> <span class="token function">checkFlow</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//   </span>
        checker<span class="token punctuation">.</span><span class="token function">checkFlow</span><span class="token punctuation">(</span>ruleProvider<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fireExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ruleProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Flow rule map should not be null.</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> flowRules <span class="token operator">=</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">getFlowRuleMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> flowRules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="3-2-1-流量控制规则的规则检查-FlowRuleChecker"><a href="#3-2-1-流量控制规则的规则检查-FlowRuleChecker" class="headerlink" title="(3.2.1) 流量控制规则的规则检查-FlowRuleChecker"></a>(3.2.1) 流量控制规则的规则检查-FlowRuleChecker</h3><p>  <code>FlowRuleChecker</code>的主要作用是 流量控制规则的规则检查</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 流量控制规则的规则检查器。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowRuleChecker</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkFlow</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ruleProvider<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span>
                          <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ruleProvider <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> resource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 获取资源对应的规则集合 </span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> rules <span class="token operator">=</span> ruleProvider<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 是否可以通过流量控制规则检查</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canPassCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 被限流，抛异常FlowException</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FlowException</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPassCheck</span><span class="token punctuation">(</span><span class="token comment">/*@NonNull*/</span> <span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span>
                                                <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> limitApp <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>limitApp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 是否是集群节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">isClusterMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 集群检查</span>
        <span class="token keyword">return</span> <span class="token function">passClusterCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 本地检查</span>
    <span class="token keyword">return</span> <span class="token function">passLocalCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">passLocalCheck</span><span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span>
                                      <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// </span>
    <span class="token class-name">Node</span> selectedNode <span class="token operator">=</span> <span class="token function">selectNodeByRequesterAndStrategy</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> rule<span class="token punctuation">.</span><span class="token function">getRater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">canPass</span><span class="token punctuation">(</span>selectedNode<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  */</span>
<span class="token keyword">static</span> <span class="token class-name">Node</span> <span class="token function">selectNodeByRequesterAndStrategy</span><span class="token punctuation">(</span><span class="token comment">/*@NonNull*/</span> <span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 限流服务 默认为default</span>
    <span class="token class-name">String</span> limitApp <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 流控策略</span>
    <span class="token keyword">int</span> strategy <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// </span>
    <span class="token class-name">String</span> origin <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>limitApp<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">filterOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 流控策略 = 直接拒绝</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Matches limit origin, return origin statistic node.</span>
            <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// </span>
        <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">LIMIT_APP_DEFAULT</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// limitApp = "default" </span>
        <span class="token comment">// 流控策略 = 直接拒绝</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 返回集群节点</span>
            <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// </span>
        <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">LIMIT_APP_OTHER</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">isOtherOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// limitApp = "other" &amp;&amp; </span>
        <span class="token comment">// 流控策略 = 直接拒绝</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// </span>
        <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token class-name">Node</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 资源名</span>
    <span class="token class-name">String</span> refResource <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getRefResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 流控策略</span>
    <span class="token keyword">int</span> strategy <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>refResource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 流控策略-关联限流</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_RELATE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// </span>
        <span class="token keyword">return</span> <span class="token class-name">ClusterBuilderSlot</span><span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span>refResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 流控策略-链路限流</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_CHAIN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>refResource<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// No node.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="3-3-流控效果-TrafficShapingController"><a href="#3-3-流控效果-TrafficShapingController" class="headerlink" title="(3.3) 流控效果-TrafficShapingController"></a>(3.3) 流控效果-TrafficShapingController</h2><p>  TrafficShapingController 实现类有3类共4个</p>
<p>  DefaultController      快速失败流控效果实现    默认节流控制器（立即拒绝策略）。<br>  RateLimiterController  排队等待流控效果实现<br>  WarmUpController       冷启动流控效果实现<br>  WarmUpRateLimiterController 冷启动排队等待流控效果实现</p>
<h3 id="3-3-1-默认快速失败限流-DefaultController"><a href="#3-3-1-默认快速失败限流-DefaultController" class="headerlink" title="(3.3.1) 默认快速失败限流-DefaultController"></a>(3.3.1) 默认快速失败限流-DefaultController</h3><p>  快速失败限流器</p>
<blockquote>
<p>如果  </p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 默认节流控制器（立即拒绝策略）。 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultController</span> <span class="token keyword">implements</span> <span class="token class-name">TrafficShapingController</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_AVG_USED_TOKENS</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">double</span> count<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> grade<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultController</span><span class="token punctuation">(</span><span class="token keyword">double</span> count<span class="token punctuation">,</span> <span class="token keyword">int</span> grade<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>grade <span class="token operator">=</span> grade<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 1.获取已经使用的令牌 (qps数或线程数)
 * 2.如果 已使用数+申请数 &lt;= 阈值，通过
 * 3.如果 已使用数+申请数 > 阈值 
 *     判断是否允许 透支(使用下个窗口令牌)
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPass</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 当前令牌数  (qps数或线程数)</span>
    <span class="token keyword">int</span> curCount <span class="token operator">=</span> <span class="token function">avgUsedTokens</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断已使用令牌数和申请的令牌数 是否大于 配置的令牌数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curCount <span class="token operator">+</span> acquireCount <span class="token operator">></span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果阈值类型是QPS 并且 优先获取时，允许使用下个窗口令牌/透支</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prioritized <span class="token operator">&amp;&amp;</span> grade <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">long</span> currentTime<span class="token punctuation">;</span>
            <span class="token keyword">long</span> waitInMs<span class="token punctuation">;</span>
            <span class="token comment">// 当前时间戳</span>
            currentTime <span class="token operator">=</span> <span class="token class-name">TimeUtil</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 预占用下个时间段的令牌</span>
            <span class="token comment">// 计算下一个时间窗口需要等待的时间</span>
            waitInMs <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">tryOccupyNext</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果等待时间 &lt; 最大等待超时时间</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>waitInMs <span class="token operator">&lt;</span> <span class="token class-name">OccupyTimeoutProperty</span><span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                node<span class="token punctuation">.</span><span class="token function">addWaitingRequest</span><span class="token punctuation">(</span>currentTime <span class="token operator">+</span> waitInMs<span class="token punctuation">,</span> acquireCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                node<span class="token punctuation">.</span><span class="token function">addOccupiedPass</span><span class="token punctuation">(</span>acquireCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span>waitInMs<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// PriorityWaitException indicates that the request will pass after waiting for &#123;@link @waitInMs&#125;.</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PriorityWaitException</span><span class="token punctuation">(</span>waitInMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 不通过 开始限流</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** 获取令牌个数 */</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">avgUsedTokens</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant">DEFAULT_AVG_USED_TOKENS</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 线程个数 或 通过QPS数</span>
    <span class="token keyword">return</span> grade <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_THREAD</span> <span class="token operator">?</span> node<span class="token punctuation">.</span><span class="token function">curThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">passQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>  StatisticNode::tryOccupyNext</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">tryOccupyNext</span><span class="token punctuation">(</span><span class="token keyword">long</span> currentTime<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span> <span class="token keyword">double</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// </span>
    <span class="token keyword">double</span> maxCount <span class="token operator">=</span> threshold <span class="token operator">*</span> <span class="token class-name">IntervalProperty</span><span class="token punctuation">.</span><span class="token constant">INTERVAL</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token comment">// 当前时间窗口内已经预占的令牌数</span>
    <span class="token keyword">long</span> currentBorrow <span class="token operator">=</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">waiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBorrow <span class="token operator">>=</span> maxCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">OccupyTimeoutProperty</span><span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">int</span> windowLength <span class="token operator">=</span> <span class="token class-name">IntervalProperty</span><span class="token punctuation">.</span><span class="token constant">INTERVAL</span> <span class="token operator">/</span> <span class="token class-name">SampleCountProperty</span><span class="token punctuation">.</span><span class="token constant">SAMPLE_COUNT</span><span class="token punctuation">;</span>
    <span class="token comment">// 桶/时间窗口开始时间</span>
    <span class="token keyword">long</span> earliestTime <span class="token operator">=</span> currentTime <span class="token operator">-</span> currentTime <span class="token operator">%</span> windowLength <span class="token operator">+</span> windowLength <span class="token operator">-</span> <span class="token class-name">IntervalProperty</span><span class="token punctuation">.</span><span class="token constant">INTERVAL</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/*
     * Note: here &#123;@code currentPass&#125; may be less than it really is NOW, because time difference
     * since call rollingCounterInSecond.pass(). So in high concurrency, the following code may
     * lead more tokens be borrowed.
     */</span>

    <span class="token keyword">long</span> currentPass <span class="token operator">=</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算经过多少时间后可以申请到令牌</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>earliestTime <span class="token operator">&lt;</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> waitInMs <span class="token operator">=</span> idx <span class="token operator">*</span> windowLength <span class="token operator">+</span> windowLength <span class="token operator">-</span> currentTime <span class="token operator">%</span> windowLength<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>waitInMs <span class="token operator">>=</span> <span class="token class-name">OccupyTimeoutProperty</span><span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">long</span> windowPass <span class="token operator">=</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">getWindowPass</span><span class="token punctuation">(</span>earliestTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPass <span class="token operator">+</span> currentBorrow <span class="token operator">+</span> acquireCount <span class="token operator">-</span> windowPass <span class="token operator">&lt;=</span> maxCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> waitInMs<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        earliestTime <span class="token operator">+=</span> windowLength<span class="token punctuation">;</span>
        currentPass <span class="token operator">-=</span> windowPass<span class="token punctuation">;</span>
        idx<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token class-name">OccupyTimeoutProperty</span><span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>  StatisticNode</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">passQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">getWindowIntervalInSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>





<h1 id="4-sentinel限流规则初始化"><a href="#4-sentinel限流规则初始化" class="headerlink" title="(4) sentinel限流规则初始化"></a>(4) sentinel限流规则初始化</h1><ol>
<li>FlowRule对象用来存配置信息 </li>
<li>FlowRuleManager用来加载配置信息 </li>
<li>后台定时任务每秒获取一次最新配置 通过 MetricTimerListener 实现<br>  SentinelConfig初始化配置及获取最新配置<br>  MetricTimerListener 定时的数据采集，然后写到log文件里去 <pre><code>遍历集群节点 汇总统计的数据
</code></pre>
  StatisticNode 使用滑动窗口实时统计数据  </li>
</ol>
<h2 id="流控策略"><a href="#流控策略" class="headerlink" title="流控策略"></a>流控策略</h2><p>  LimitApp的作用域只在配置的流控策略为RuleConstant.STRATEGY_DIRECT（直接关联）时起作用。<br>    其有三种配置，分别为default，origin_name，other<br>    default 如果配置为default，表示统计不区分来源，当前资源的任何来源流量都会被统计（其实就是选择 Node 为 clusterNode 维度）<br>    origin_name 如果配置为指定名称的 origin_name，则只会对当前配置的来源流量做统计<br>    other 如果配置为other 则会对其他全部来源生效但不包括第二条配置的来源</p>
<p>  当策略配置为 RuleConstant.STRATEGY_RELATE 或 RuleConstant.STRATEGY_CHAIN 时<br>    STRATEGY_RELATE 关联其他的指定资源，如资源A想以资源B的流量状况来决定是否需要限流，这时资源A规则配置可以使用 STRATEGY_RELATE 策略<br>    STRATEGY_CHAIN 对指定入口的流量限流，因为流量可以有多个不同的入口（EntranceNode）</p>
<h2 id="流控策略校验"><a href="#流控策略校验" class="headerlink" title="流控策略校验"></a>流控策略校验</h2><p>  同一个资源名可以配置多条规则，规则的生效顺序为：{some_origin_name} &gt; other &gt; default</p>
<p>  校验 FlowRuleChecker#selectNodeByRequesterAndStrategy</p>
<p>  String limitApp = rule.getLimitApp(); // 不设置默认为default，设置了就是自己指定的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 调用方限流-直接限流-针对特定的调用者  origin变量 不为`default` 或 `other`，并且配置的limitApp和origin变量 相等</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>limitApp<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">filterOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Matches limit origin, return origin statistic node.</span>
        <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 调用方限流-直接限流-默认</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">LIMIT_APP_DEFAULT</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Return the cluster node.</span>
        <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 调用方限流-直接限流-其它</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">LIMIT_APP_OTHER</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">isOtherOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// </span>
<span class="token keyword">static</span> <span class="token class-name">Node</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> refResource <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getRefResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> strategy <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>refResource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_RELATE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">ClusterBuilderSlot</span><span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span>refResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_CHAIN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>refResource<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// No node.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="流控效果-流量控制实现"><a href="#流控效果-流量控制实现" class="headerlink" title="流控效果  流量控制实现"></a>流控效果  流量控制实现</h2><p>  // 加载流控规则<br>  FlowRuleManager.loadRules(rules);</p>
<p>  com.alibaba.csp.sentinel.slots.block.flowFlowRuleUtil::buildFlowRuleMap</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Build the flow rule map from raw list of flow rules, grouping by provided group function.
 *
 * @param list          raw list of flow rules
 * @param groupFunction grouping function of the map (by key)
 * @param filter        rule filter
 * @param shouldSort    whether the rules should be sorted
 * @param &lt;K>           type of key
 * @return constructed new flow rule map; empty map if list is null or empty, or no wanted rules
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">></span></span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">buildFlowRuleMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">></span></span> groupFunction<span class="token punctuation">,</span>
                                                          <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> filter<span class="token punctuation">,</span> <span class="token keyword">boolean</span> shouldSort<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 存储所有的流控规则</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> newRuleMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> newRuleMap<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> tmpMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 循环加载流控规则 </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidRule</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[FlowRuleManager] Ignoring invalid flow rule when loading new flow rules: "</span> <span class="token operator">+</span> rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>filter<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            rule<span class="token punctuation">.</span><span class="token function">setLimitApp</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">LIMIT_APP_DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 获取流控规则的阈值</span>
        <span class="token class-name">TrafficShapingController</span> rater <span class="token operator">=</span> <span class="token function">generateRater</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule<span class="token punctuation">.</span><span class="token function">setRater</span><span class="token punctuation">(</span>rater<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">K</span> key <span class="token operator">=</span> groupFunction<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> flowRules <span class="token operator">=</span> tmpMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>flowRules <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Use hash set here to remove duplicate rules.</span>
            flowRules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tmpMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> flowRules<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        flowRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> comparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRuleComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> entries <span class="token operator">:</span> tmpMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldSort<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Sort the rules.</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>rules<span class="token punctuation">,</span> comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        newRuleMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> newRuleMap<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 0. 直接拒绝(reject directly), </span>
<span class="token comment">// 1. 热启动(warm up), </span>
<span class="token comment">// 2. 匀速排队 rate limiter, </span>
<span class="token comment">// 3. 热启动 + 匀速排队 warm up + rate limiter</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">TrafficShapingController</span> <span class="token function">generateRater</span><span class="token punctuation">(</span><span class="token comment">/*@Valid*/</span> <span class="token class-name">FlowRule</span> rule<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 是否是QPS限流</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getControlBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">CONTROL_BEHAVIOR_WARM_UP</span><span class="token operator">:</span>
                <span class="token comment">// 1  热启动 warm up   缓慢放量</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WarmUpController</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getWarmUpPeriodSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">ColdFactorProperty</span><span class="token punctuation">.</span>coldFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">CONTROL_BEHAVIOR_RATE_LIMITER</span><span class="token operator">:</span>
                <span class="token comment">// 3 热启动 + 匀速排队 warm up + rate limiter</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RateLimiterController</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getMaxQueueingTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">CONTROL_BEHAVIOR_WARM_UP_RATE_LIMITER</span><span class="token operator">:</span>
                <span class="token comment">// 2 匀速排队 rate limiter</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WarmUpRateLimiterController</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getWarmUpPeriodSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    rule<span class="token punctuation">.</span><span class="token function">getMaxQueueingTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ColdFactorProperty</span><span class="token punctuation">.</span>coldFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">CONTROL_BEHAVIOR_DEFAULT</span><span class="token operator">:</span>
                <span class="token comment">// 直接拒绝</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">// Default mode or unknown mode: default traffic shaping controller (fast-reject).</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 直接拒绝 </span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultController</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luozhiyun/p/11439993.html">Sentinel源码分析—FlowRuleManager加载规则做了什么？</a><br>[2] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luozhiyun/p/11451557.html">Sentinel源码分析—Sentinel是如何进行流量统计的？</a><br>[3] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luozhiyun/p/11489128.html">Sentinel源码分析— QPS流量控制是如何实现的？</a><br>[4] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/taromilk/p/11877242.html">Sentinel源码解析四（流控策略和流控效果）</a><br>[5] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/wuzhenzhao/p/11453649.html">sentinel 滑动窗口 限流</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/11/22/sentinel-introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/22/sentinel-introduction/" class="post-title-link" itemprop="url">Sentinel学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-22 08:52:01" itemprop="dateCreated datePublished" datetime="2020-11-22T08:52:01+08:00">2020-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-11 23:33:24" itemprop="dateModified" datetime="2023-03-11T23:33:24+08:00">2023-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/middleware/" itemprop="url" rel="index"><span itemprop="name">middleware</span></a>
                </span>
            </span>

          
            <span id="/2020/11/22/sentinel-introduction/" class="post-meta-item leancloud_visitors" data-flag-title="Sentinel学习" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/11/22/sentinel-introduction/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/11/22/sentinel-introduction/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-什么是Sentinel"><a href="#1-什么是Sentinel" class="headerlink" title="(1) 什么是Sentinel"></a>(1) 什么是Sentinel</h1><p> <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/introduction.html">Sentinel介绍</a></p>
<p>  随着微服务的流行，服务和服务之间的稳定性变得越来越重要。<br>  Sentinel 是面向分布式、多语言异构化服务架构的流量治理组件，主要以流量为切入点，从流量路由、流量控制、流量整形、熔断降级、系统自适应过载保护、热点流量防护等多个维度来帮助开发者保障微服务的稳定性。</p>
<p>  <img src="/img/distributed/sentinel/sentinel-slot-chain-architecture.png" alt="Sentinel架构"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/11/22/sentinel-introduction/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/11/19/jvm-turning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/19/jvm-turning/" class="post-title-link" itemprop="url">JVM调优</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-19 10:18:43" itemprop="dateCreated datePublished" datetime="2020-11-19T10:18:43+08:00">2020-11-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-28 11:51:47" itemprop="dateModified" datetime="2022-05-28T11:51:47+08:00">2022-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jvm/" itemprop="url" rel="index"><span itemprop="name">jvm</span></a>
                </span>
            </span>

          
            <span id="/2020/11/19/jvm-turning/" class="post-meta-item leancloud_visitors" data-flag-title="JVM调优" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/11/19/jvm-turning/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/11/19/jvm-turning/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  JVM调优前一定要只要遇到什么问题、优化后的目标。否则投入多收获少。得不偿失。</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.623+0800</span><span class="token operator">:</span> <span class="token number">5.285</span><span class="token operator">:</span> <span class="token punctuation">[</span>GC <span class="token operator">(</span>Allocation Failure<span class="token operator">)</span> <span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.624+0800</span><span class="token operator">:</span> <span class="token number">5.285</span><span class="token operator">:</span> <span class="token punctuation">[</span>ParNew2020<span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span>17T04<span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">16.648</span><span class="token operator">+</span><span class="token number">0800</span><span class="token operator">:</span> <span class="token number">5.309</span><span class="token operator">:</span> <span class="token punctuation">[</span>SoftReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0002508</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.648+0800</span><span class="token operator">:</span> <span class="token number">5.309</span><span class="token operator">:</span> <span class="token punctuation">[</span>WeakReference<span class="token punctuation">,</span> <span class="token number">332</span> refs<span class="token punctuation">,</span> <span class="token number">0.0001633</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.648+0800</span><span class="token operator">:</span> <span class="token number">5.310</span><span class="token operator">:</span> <span class="token punctuation">[</span>FinalReference<span class="token punctuation">,</span> <span class="token number">5452</span> refs<span class="token punctuation">,</span> <span class="token number">0.0057402</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.654+0800</span><span class="token operator">:</span> <span class="token number">5.315</span><span class="token operator">:</span> <span class="token punctuation">[</span>PhantomReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0002858</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.654+0800</span><span class="token operator">:</span> <span class="token number">5.316</span><span class="token operator">:</span> <span class="token punctuation">[</span>JNI Weak Reference<span class="token punctuation">,</span> <span class="token number">0.0000681</span> secs<span class="token punctuation">]</span>
Desired survivor size <span class="token number">107347968</span> bytes<span class="token punctuation">,</span> new threshold <span class="token number">6</span> <span class="token operator">(</span>max <span class="token number">6</span><span class="token operator">)</span>
<span class="token operator">-</span> age   <span class="token number">1</span><span class="token operator">:</span>   <span class="token number">17515352</span> bytes<span class="token punctuation">,</span>   <span class="token number">17515352</span> total
<span class="token operator">:</span> <span class="token number">1677824K</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">17187K</span><span class="token operator">(</span><span class="token number">1887488K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.0309183</span> secs<span class="token punctuation">]</span> <span class="token number">1677824K</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">17187K</span><span class="token operator">(</span><span class="token number">6081792K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.0310078</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.14</span> sys<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.03</span> secs<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2020-11-17T</span><span class="token time number">04:59:17.966+0800</span><span class="token operator">:</span> <span class="token number">6.628</span><span class="token operator">:</span> <span class="token punctuation">[</span>CMS<span class="token operator">-</span>concurrent<span class="token operator">-</span>abortable<span class="token operator">-</span>preclean<span class="token operator">:</span> <span class="token number">1.144</span><span class="token operator">/</span><span class="token number">1.845</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">4.88</span> sys<span class="token operator">=</span><span class="token number">0.32</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">1.84</span> secs<span class="token punctuation">]</span>
<span class="token date number">2020-11-17T</span><span class="token time number">04:59:17.966+0800</span><span class="token operator">:</span> <span class="token number">6.628</span><span class="token operator">:</span> <span class="token punctuation">[</span>GC <span class="token operator">(</span>CMS Final Remark<span class="token operator">)</span> <span class="token punctuation">[</span>YG occupancy<span class="token operator">:</span> <span class="token number">925231</span> K <span class="token operator">(</span><span class="token number">1887488</span> K<span class="token operator">)</span><span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:17.967+0800</span><span class="token operator">:</span> <span class="token number">6.628</span><span class="token operator">:</span> <span class="token punctuation">[</span>Rescan <span class="token operator">(</span>parallel<span class="token operator">)</span> <span class="token punctuation">,</span> <span class="token number">0.0808829</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.047+0800</span><span class="token operator">:</span> <span class="token number">6.709</span><span class="token operator">:</span> <span class="token punctuation">[</span>weak refs processing2020<span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span>17T04<span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">18.047</span><span class="token operator">+</span><span class="token number">0800</span><span class="token operator">:</span> <span class="token number">6.709</span><span class="token operator">:</span> <span class="token punctuation">[</span>SoftReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0002601</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.048+0800</span><span class="token operator">:</span> <span class="token number">6.709</span><span class="token operator">:</span> <span class="token punctuation">[</span>WeakReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0001719</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.048+0800</span><span class="token operator">:</span> <span class="token number">6.709</span><span class="token operator">:</span> <span class="token punctuation">[</span>FinalReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0001500</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.048+0800</span><span class="token operator">:</span> <span class="token number">6.709</span><span class="token operator">:</span> <span class="token punctuation">[</span>PhantomReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0002673</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.048+0800</span><span class="token operator">:</span> <span class="token number">6.710</span><span class="token operator">:</span> <span class="token punctuation">[</span>JNI Weak Reference<span class="token punctuation">,</span> <span class="token number">0.0000138</span> secs<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0009146</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.048+0800</span><span class="token operator">:</span> <span class="token number">6.710</span><span class="token operator">:</span> <span class="token punctuation">[</span>class unloading<span class="token punctuation">,</span> <span class="token number">0.0111246</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.059+0800</span><span class="token operator">:</span> <span class="token number">6.721</span><span class="token operator">:</span> <span class="token punctuation">[</span>scrub symbol table<span class="token punctuation">,</span> <span class="token number">0.0063213</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.066+0800</span><span class="token operator">:</span> <span class="token number">6.727</span><span class="token operator">:</span> <span class="token punctuation">[</span>scrub string table<span class="token punctuation">,</span> <span class="token number">0.0006271</span> secs<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span> CMS<span class="token operator">-</span>remark<span class="token operator">:</span> <span class="token number">0K</span><span class="token operator">(</span><span class="token number">4194304K</span><span class="token operator">)</span><span class="token punctuation">]</span> <span class="token number">925231K</span><span class="token operator">(</span><span class="token number">6081792K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.1009594</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.33</span> sys<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.10</span> secs<span class="token punctuation">]</span>
<span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.068+0800</span><span class="token operator">:</span> <span class="token number">6.729</span><span class="token operator">:</span> <span class="token punctuation">[</span>CMS<span class="token operator">-</span>concurrent<span class="token operator">-</span>sweep<span class="token operator">-</span>start<span class="token punctuation">]</span>
<span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.068+0800</span><span class="token operator">:</span> <span class="token number">6.729</span><span class="token operator">:</span> <span class="token punctuation">[</span>CMS<span class="token operator">-</span>concurrent<span class="token operator">-</span>sweep<span class="token operator">:</span> <span class="token number">0.000</span><span class="token operator">/</span><span class="token number">0.000</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.00</span> sys<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.00</span> secs<span class="token punctuation">]</span>
<span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.068+0800</span><span class="token operator">:</span> <span class="token number">6.729</span><span class="token operator">:</span> <span class="token punctuation">[</span>CMS<span class="token operator">-</span>concurrent<span class="token operator">-</span>reset<span class="token operator">-</span>start<span class="token punctuation">]</span>
<span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.165+0800</span><span class="token operator">:</span> <span class="token number">6.827</span><span class="token operator">:</span> <span class="token punctuation">[</span>CMS<span class="token operator">-</span>concurrent<span class="token operator">-</span>reset<span class="token operator">:</span> <span class="token number">0.098</span><span class="token operator">/</span><span class="token number">0.098</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.11</span> sys<span class="token operator">=</span><span class="token number">0.08</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.10</span> secs<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>GC (Allocation Failure)<br>Concurrent Abortable Preclean<br>CMS-concurrent-abortable-preclean</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[] <a href=""></a><br>[] <a href=""></a><br>[] <a target="_blank" rel="noopener" href="https://club.perfma.com/article/1921017">JVM调优实战：解决CMS concurrent-abortable-preclean LongGC的问题</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/10/11/time-wheel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/11/time-wheel/" class="post-title-link" itemprop="url">时间轮笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-11 16:14:08" itemprop="dateCreated datePublished" datetime="2020-10-11T16:14:08+08:00">2020-10-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-01-14 22:32:20" itemprop="dateModified" datetime="2023-01-14T22:32:20+08:00">2023-01-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/basic/" itemprop="url" rel="index"><span itemprop="name">basic</span></a>
                </span>
            </span>

          
            <span id="/2020/10/11/time-wheel/" class="post-meta-item leancloud_visitors" data-flag-title="时间轮笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/10/11/time-wheel/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/10/11/time-wheel/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p> 如果一台机器上有10w个定时任务，如何做到高效触发？</p>
<p> rpc调用时超时怎么实现？</p>
<p> 订单超时未支付变更订单状态怎么实现？</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/10/11/time-wheel/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/09/20/hystrix-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/20/hystrix-notes/" class="post-title-link" itemprop="url">Hystrix笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-20 21:32:17" itemprop="dateCreated datePublished" datetime="2020-09-20T21:32:17+08:00">2020-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-29 16:28:50" itemprop="dateModified" datetime="2022-05-29T16:28:50+08:00">2022-05-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/basic/" itemprop="url" rel="index"><span itemprop="name">basic</span></a>
                </span>
            </span>

          
            <span id="/2020/09/20/hystrix-notes/" class="post-meta-item leancloud_visitors" data-flag-title="Hystrix笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/09/20/hystrix-notes/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/09/20/hystrix-notes/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>362</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p> Hystrix是一个延迟和容错库，旨在隔离对远程系统，服务和第三方库的访问点，停止级联故障，并在不可避免发生故障的复杂分布式系统中实现弹性。 </p>
<p> Hystrix is a latency and fault tolerance library designed to isolate points of access to remote systems, services and 3rd party libraries, stop cascading failure and enable resilience in complex distributed systems where failure is inevitable. </p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/09/20/hystrix-notes/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/09/19/java-generics/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/19/java-generics/" class="post-title-link" itemprop="url">Java泛型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-19 14:12:39" itemprop="dateCreated datePublished" datetime="2020-09-19T14:12:39+08:00">2020-09-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-04 12:58:32" itemprop="dateModified" datetime="2022-06-04T12:58:32+08:00">2022-06-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/2020/09/19/java-generics/" class="post-meta-item leancloud_visitors" data-flag-title="Java泛型" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/09/19/java-generics/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/09/19/java-generics/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>16 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>　泛型主要解决了代码的复用问题。 提高了代码的抽象性。</p>
<h1 id="1-为什么会引入泛型"><a href="#1-为什么会引入泛型" class="headerlink" title="(1) 为什么会引入泛型"></a>(1) 为什么会引入泛型</h1><p>　泛型的意义：适用于多种数据类型执行相同的代码（代码复用） </p>
<p>　通过一个例子来阐述，先看下下面的代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">byte</span> x<span class="token punctuation">,</span> <span class="token keyword">byte</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">short</span> x<span class="token punctuation">,</span> <span class="token keyword">short</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>　如果没有泛型，要实现不同类型的加法，每种类型都需要重载一个add方法。</p>
<p>　通过泛型，我们可以复用为一个方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Number</span><span class="token punctuation">></span></span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">T</span> x<span class="token punctuation">,</span> <span class="token class-name">T</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/09/19/java-generics/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/09/12/java-reference/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/12/java-reference/" class="post-title-link" itemprop="url">Java里的引用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-12 15:41:37" itemprop="dateCreated datePublished" datetime="2020-09-12T15:41:37+08:00">2020-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-28 11:51:47" itemprop="dateModified" datetime="2022-05-28T11:51:47+08:00">2022-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/2020/09/12/java-reference/" class="post-meta-item leancloud_visitors" data-flag-title="Java里的引用" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/09/12/java-reference/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/09/12/java-reference/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是Java里的引用"><a href="#什么是Java里的引用" class="headerlink" title="什么是Java里的引用"></a>什么是Java里的引用</h1><p>  引用可以理解为指针</p>
<h1 id="有什么用"><a href="#有什么用" class="headerlink" title="有什么用"></a>有什么用</h1><p>  不同引用不同用途<br>  强引用<br>  软引用<br>  弱引用<br>  虚引用 </p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/09/12/java-reference/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/09/12/java-threadlocal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/12/java-threadlocal/" class="post-title-link" itemprop="url">Java ThreadLocal 笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-12 10:27:08" itemprop="dateCreated datePublished" datetime="2020-09-12T10:27:08+08:00">2020-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-28 11:51:47" itemprop="dateModified" datetime="2022-05-28T11:51:47+08:00">2022-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/2020/09/12/java-threadlocal/" class="post-meta-item leancloud_visitors" data-flag-title="Java ThreadLocal 笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/09/12/java-threadlocal/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/09/12/java-threadlocal/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>　　Java多线程一般都会问到 ThreadLocal，既能考数据结构，又能考线程，还能考JVM。用起来很简单，但是理解需要花费时间。</p>
<h1 id="ThreadLocal是什么"><a href="#ThreadLocal是什么" class="headerlink" title="ThreadLocal是什么"></a>ThreadLocal是什么</h1><p>　ThreadLocal 线程本地变量/线程本地存储</p>
<blockquote>
<p> 此类提供线程局部变量。这些变量不同于普通的对应变量，因为每个访问一个（通过其get或set方法）的线程都有自己独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，它们希望将状态与线程相关联（例如，用户ID或事务ID）。<br>只要线程是活动的并且ThreadLocal实例是可访问的，则每个线程都对其线程局部变量的副本持有隐式引用。 线程消失后，其线程本地实例的所有副本都将进行垃圾回收（除非存在对这些副本的其他引用）。 </p>
<p> This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its get or set method) has its own, independently initialized copy of the variable. ThreadLocal instances are typically private static fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID).</p>
<p> Each thread holds an implicit reference to its copy of a thread-local variable as long as the thread is alive and the ThreadLocal instance is accessible; after a thread goes away, all of its copies of thread-local instances are subject to garbage collection (unless other references to these copies exist).<br><br></p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/09/12/java-threadlocal/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/08/30/rpc-serialization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/30/rpc-serialization/" class="post-title-link" itemprop="url">RPC序列化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-30 15:41:31" itemprop="dateCreated datePublished" datetime="2020-08-30T15:41:31+08:00">2020-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-09 22:39:36" itemprop="dateModified" datetime="2022-09-09T22:39:36+08:00">2022-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
                </span>
            </span>

          
            <span id="/2020/08/30/rpc-serialization/" class="post-meta-item leancloud_visitors" data-flag-title="RPC序列化" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/08/30/rpc-serialization/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/30/rpc-serialization/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="为什么需要序列化？"><a href="#为什么需要序列化？" class="headerlink" title="为什么需要序列化？"></a>为什么需要序列化？</h1><p>平时编程时通常使用“对象”来进行数据</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  当需要对数据进行存储或者传输时，“对象”就不这么好用了，往往需要把数据转化成连续空间的“二进制字节流”。</p>
<p>一些典型的场景是：<br>(1) <code>数据库索引的磁盘存储</code>：数据库的索引在内存里是b+树，但这个格式是不能够直接存储到磁盘上的，所以需要把b+树转化为连续空间的二进制字节流，才能存储到磁盘上；<br>(2) <code>缓存的KV存储</code>：redis/memcache是KV类型的缓存，缓存存储的value必须是连续空间的二进制字节流，不能是对象；<br>(3) <code>数据的网络传输</code>：socket发送的数据必须是连续空间的二进制字节流，不能是对象；</p>
<p>  序列化(Serialization)，就是将”对象”形态的数据转化为”连续空间二进制字节流”形态数据的过程。</p>
<h1 id="有哪些常用的序列化？"><a href="#有哪些常用的序列化？" class="headerlink" title="有哪些常用的序列化？"></a>有哪些常用的序列化？</h1><p>文本类序列化方式：JSON、xml、csv<br>二进制类序列化方式：Hessian、Protobuf、thrift、Avro、 </p>
<p>文本类序列化方式 优点就是可读性好，构造方便，调试也简单。不过缺点也明显，传输体积大，性能差。</p>
<p>实际上任何一种序列化框架，核心思想就是设计一种序列化协议，将对象的类型、属性类型、属性值一一按照固定的格式写到二进制字节流中来完成序列化，再按照固定的格式一一读出对象的类型、属性类型、属性值，通过这些信息重新创建出一个新的对象，来完成反序列化</p>
<h2 id="文本类"><a href="#文本类" class="headerlink" title="文本类"></a>文本类</h2><h3 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h3><h2 id="二进制类序列化方式"><a href="#二进制类序列化方式" class="headerlink" title="二进制类序列化方式"></a>二进制类序列化方式</h2><h3 id="Hessian"><a href="#Hessian" class="headerlink" title="Hessian"></a>Hessian</h3><p>Hessian 是动态类型、二进制、紧凑的，并且可跨语言移植的一种序列化框架。<br>Hessian 协议要比 JDK、JSON 更加紧凑，性能上要比 JDK、JSON 序列化高效很多，而且生成的字节数也更小。</p>
<p> Hessian 本身也有问题，官方版本对 Java 里面一些常见对象的类型不支持，比如：<br> Linked 系列，LinkedHashMap、LinkedHashSet 等，但是可以通过扩展 CollectionDeserializer 类修复；<br> Locale 类，可以通过扩展 ContextSerializerFactory 类修复；<br> Byte/Short 反序列化的时候变成 Integer。</p>
<h3 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h3><p>Protobuf  是 Google 公司内部的混合语言数据标准，是一种轻便、高效的结构化数据存储格式，可以用于结构化数据序列化，支持 Java、Python、C++、Go 等语言。</p>
<p>Protobuf 使用的时候需要定义 IDL（Interface description language），然后使用不同语言的 IDL 编译器，生成序列化工具类</p>
<p>优点是：<br>序列化后体积相比 JSON、Hessian 小很多；<br>IDL 能清晰地描述语义，所以足以帮助并保证应用程序之间的类型不会丢失，无需类似 XML 解析器；<br>序列化反序列化速度很快，不需要通过反射获取类型；<br>消息格式升级和兼容性不错，可以做到向后兼容。</p>
<h3 id="thrift"><a href="#thrift" class="headerlink" title="thrift"></a>thrift</h3><p>thrift TProtocol </p>
<h1 id="序列化协议要考虑什么因素？"><a href="#序列化协议要考虑什么因素？" class="headerlink" title="序列化协议要考虑什么因素？"></a>序列化协议要考虑什么因素？</h1><p>  安全性、通用性、兼容性、性能、效率、空间开销</p>
<p>不管使用成熟协议xml/json，还是自定义二进制协议来序列化对象，序列化协议设计时都需要考虑以下这些因素。<br>（1）解析效率：这个应该是序列化协议应该首要考虑的因素，像xml/json解析起来比较耗时，需要解析doom树，二进制自定义协议解析起来效率就很高；<br>（2）压缩率，传输有效性：同样一个对象，xml/json传输起来有大量的xml标签，信息有效性低，二进制自定义协议占用的空间相对来说就小多了；<br>（3）扩展性与兼容性：是否能够方便的增加字段，增加字段后旧版客户端是否需要强制升级，都是需要考虑的问题，xml/json和上面的二进制协议都能够方便的扩展；<br>（4）可读性与可调试性：这个很好理解，xml/json的可读性就比二进制协议好很多；<br>（5）跨语言：上面的两个协议都是跨语言的，有些序列化协议是与开发语言紧密相关的，例如dubbo的序列化协议就只能支持Java的RPC调用；<br>（6）通用性：xml/json非常通用，都有很好的第三方解析库，各个语言解析起来都十分方便，上面自定义的二进制协议虽然能够跨语言，但每个语言都要写一个简易的协议客户端；</p>
<h1 id="RPC-框架在使用时要注意哪些问题？"><a href="#RPC-框架在使用时要注意哪些问题？" class="headerlink" title="RPC 框架在使用时要注意哪些问题？"></a>RPC 框架在使用时要注意哪些问题？</h1><h2 id="对象构造得过于复杂"><a href="#对象构造得过于复杂" class="headerlink" title="对象构造得过于复杂"></a>对象构造得过于复杂</h2><p>属性很多，并且存在多层的嵌套，比如 A 对象关联 B 对象，B 对象又聚合 C 对象，C 对象又关联聚合很多其他对象，对象依赖关系过于复杂。序列化框架在序列化与反序列化对象时，对象越复杂就越浪费性能，消耗 CPU，这会严重影响 RPC 框架整体的性能；另外，对象越复杂，在序列化与反序列化的过程中，出现问题的概率就越高。</p>
<h2 id="对象过于庞大"><a href="#对象过于庞大" class="headerlink" title="对象过于庞大"></a>对象过于庞大</h2><p>我经常遇到业务过来咨询，为啥他们的 RPC 请求经常超时，排查后发现他们的入参对象非常得大，比如为一个大 List 或者大 Map，序列化之后字节长度达到了上兆字节。这种情况同样会严重地浪费了性能、CPU，并且序列化一个如此大的对象是很耗费时间的，这肯定会直接影响到请求的耗时。</p>
<h2 id="使用序列化框架不支持的类作为入参类"><a href="#使用序列化框架不支持的类作为入参类" class="headerlink" title="使用序列化框架不支持的类作为入参类"></a>使用序列化框架不支持的类作为入参类</h2><p>比如 Hessian 框架，他天然是不支持 LinkedHashMap、LinkedHashSet 等，而且大多数情况下最好不要使用第三方集合类，如 Guava 中的集合类，很多开源的序列化框架都是优先支持编程语言原生的对象。因此如果入参是集合类，应尽量选用原生的、最为常用的集合类，如 HashMap、ArrayList。</p>
<h2 id="对象有复杂的继承关系"><a href="#对象有复杂的继承关系" class="headerlink" title="对象有复杂的继承关系"></a>对象有复杂的继承关系</h2><p>大多数序列化框架在序列化对象时都会将对象的属性一一进行序列化，当有继承关系时，会不停地寻找父类，遍历属性。就像问题 1 一样，对象关系越复杂，就越浪费性能，同时又很容易出现序列化上的问题。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/202779">RPC 实战与核心原理 - 03 | 序列化：对象怎么在网络中传输？</a><br>[2] <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/9GZtmV4HIgg0o2OcZiqXgw">必须知道的RPC内核细节（值得收藏）！！！</a><br>[3] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/118848">消息队列高手课 - 12 | 序列化与反序列化：如何通过网络传输结构化的数据？</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/08/30/rpc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/30/rpc/" class="post-title-link" itemprop="url">远程过程调用(Remote Procedure Call)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-30 13:25:47" itemprop="dateCreated datePublished" datetime="2020-08-30T13:25:47+08:00">2020-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-11 08:38:02" itemprop="dateModified" datetime="2022-07-11T08:38:02+08:00">2022-07-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
                </span>
            </span>

          
            <span id="/2020/08/30/rpc/" class="post-meta-item leancloud_visitors" data-flag-title="远程过程调用(Remote Procedure Call)" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/08/30/rpc/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/30/rpc/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  一个人是否了解RPC的原理和技术细节，问2个问题就可以知道，<br>  1、描述一下RPC的通信流程。<br>  2、在通信时有哪些步骤，分别用到了什么技术？</p>
<p>  这个题没有标准答案，这个需要自己理解以后才能描述。</p>
<br>

<h1 id="1-什么是RPC"><a href="#1-什么是RPC" class="headerlink" title="(1) 什么是RPC"></a>(1) 什么是RPC</h1><p>  RPC 的全称是 Remote Procedure Call，即远程过程调用。</p>
<p>  <img src="/img/rpc/rpc-call-process-user.png" alt="用户视角RPC调用"></p>
<p>  像调用本地函数一样，调用一个远端服务。<br>什么是“远程”，为什么“远”？<br>先来看下什么是<code>近</code>，即<code>本地函数调用</code>。</p>
<h2 id="1-1-本地函数调用"><a href="#1-1-本地函数调用" class="headerlink" title="(1.1) 本地函数调用"></a>(1.1) 本地函数调用</h2><p>  下面是一个两数相加的本地函数</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token class-name">Add</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p> <img src="/img/rpc/local-function-call.png" alt="本地函数调用"></p>
<p>这行代码的时候，到底发生了什么？<br>（1）传递两个入参；<br>（2）调用了本地代码段中的函数，执行运算逻辑；<br>（3）返回一个出参；<br>这三个动作，都发生在同一个进程空间里，这是本地函数调用。</p>
<p>  有办法，调用一个跨进程的函数呢？</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/08/30/rpc/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">313</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



<script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5rcgvdncuwu&amp;m=7&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>


      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/lozad.js/1.14.0/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdnjs.cloudflare.com/ajax/libs/valine/1.5.1/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'Ca876j76FoCQi1SShjT0qC6k-gzGzoHsz',
      appKey     : 'IeozLmM20GuvfcslfWgdNXP0',
      placeholder: "期待您的评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
