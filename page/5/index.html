<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"weikeqin.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true,"width":240},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="不积跬步无以至千里">
<meta property="og:type" content="website">
<meta property="og:title" content="天道酬勤">
<meta property="og:url" content="http://weikeqin.com/page/5/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="不积跬步无以至千里">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="tech,Java,Redis,MySQL,ElasticSearch,Neo4j,DDD">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://weikeqin.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>天道酬勤</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113485469-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-113485469-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">天道酬勤</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">让好事发生</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/02/26/redis-command-execution-process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/26/redis-command-execution-process/" class="post-title-link" itemprop="url">Redis命令执行流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-26 19:22:27" itemprop="dateCreated datePublished" datetime="2022-02-26T19:22:27+08:00">2022-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-01-30 23:09:30" itemprop="dateModified" datetime="2023-01-30T23:09:30+08:00">2023-01-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/02/26/redis-command-execution-process/" class="post-meta-item leancloud_visitors" data-flag-title="Redis命令执行流程" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/02/26/redis-command-execution-process/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/02/26/redis-command-execution-process/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-Redis实现分布式锁"><a href="#1-Redis实现分布式锁" class="headerlink" title="(1) Redis实现分布式锁"></a>(1) Redis实现分布式锁</h1><p>  通过Redis <code>SET key value NX</code> 可以简单地实现分布式锁。</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>  SET key_lock value1 NX
OK
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>  SET key_lock value1 NX
<span class="token operator">(</span>nil<span class="token operator">)</span>
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 在解锁时可以先判断key是否存在，然后对比值是否相等，相等后再删除key，释放锁。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/02/26/redis-command-execution-process/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/02/20/counter-service-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/20/counter-service-design/" class="post-title-link" itemprop="url">计数服务设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-20 23:19:06" itemprop="dateCreated datePublished" datetime="2022-02-20T23:19:06+08:00">2022-02-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-23 23:22:29" itemprop="dateModified" datetime="2023-07-23T23:22:29+08:00">2023-07-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/architecture/" itemprop="url" rel="index"><span itemprop="name">architecture</span></a>
                </span>
            </span>

          
            <span id="/2022/02/20/counter-service-design/" class="post-meta-item leancloud_visitors" data-flag-title="计数服务设计" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/02/20/counter-service-design/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/02/20/counter-service-design/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  看了微博在2012年 微博计数器的设计 后，现在在想假设自己要设计一个有<code>点赞数</code>、<code>收藏数</code>、<code>评论数</code>、<code>转发数</code> 的计数系统，会怎么做？</p>
<p>  微博计数器的设计 文章链接 <a target="_blank" rel="noopener" href="https://blog.cydu.net/weidesign/2012/09/09/weibo-counter-service-design-2/">https://blog.cydu.net/weidesign/2012/09/09/weibo-counter-service-design-2/</a></p>
<br>

<h1 id="1-背景"><a href="#1-背景" class="headerlink" title="(1) 背景"></a>(1) 背景</h1><p>  以抖音、微博、微信 为例，推荐的视频、微博、朋友圈 会有<code>点赞数</code>、<code>收藏数</code>、<code>评论数</code>、<code>转发数</code>，假如让你设计，你会怎么做？</p>
<p>微博的比较经典，这里以微博为例，原理都一样。<br>考虑因素如下：<br>1、预估用户  14亿<br>2、预估活跃用户数 0.01 ~ 6亿。<br>3、假设每个用户每天发1<del>3个微博，  每天大概有 0.01亿 ~ 18亿条微博。 每条微博上都有<code>点赞数</code>、<code>收藏数</code>、<code>评论数</code>、<code>转发数</code>。<br>   3</del>5年大概有 0.01<em>365</em>3 ~ 18<em>365</em>3亿条微博，也就是 10.95亿 ~ 1 9710亿条微博。</p>
<br>
<br>


<h1 id="2-信息Id设计"><a href="#2-信息Id设计" class="headerlink" title="(2) 信息Id设计"></a>(2) 信息Id设计</h1><p>  如果只考虑用户信息的ID查询，只要保证动态Id唯一即可；考虑到要按照用户维度去展示用户的信息列表，信息ID里最好包含用户ID，这样方便查询某个用户发布的所有的信息(动态)。<br>  类似于电商场景查询某个用户的所有订单。</p>
<p>  信息有个唯一表示，用rec_id表示<br>  根据推荐信息唯一标识rec_id获取<code>点赞数</code>、<code>收藏数</code>、<code>评论数</code>、<code>转发数</code> 是一个简单查询。</p>
<h2 id="2-1-用数字表示信息ID"><a href="#2-1-用数字表示信息ID" class="headerlink" title="(2.1) 用数字表示信息ID"></a>(2.1) 用数字表示信息ID</h2><p> int类型占用4字节，32位，最多可以表示 2^32个数字，考虑上符号，以及0，正数最多有 <code>2^31-1</code> = <code>21 4748 3647</code> 个，大概21亿多。</p>
<p> long类型占用8字节，64位，最多可以表示 2^64个数字，考虑到id都是正数，而且一般不用0，所以最多有 <code>2^63-1</code> = <code>922 3372 0368 5477 5807</code> 个，大概922亿亿个。</p>
<p>  可以用8字节的Long类型表示信息ID(msg_id)，msg_id的设计可以参考雪花算法的思想， 64位可以按照 符号位(1位)、城市(6位)、用户(8-10位)、时间戳()、随机字符()等来设计。</p>
<br>


<h1 id="3-计数器设计方案"><a href="#3-计数器设计方案" class="headerlink" title="(3) 计数器设计方案"></a>(3) 计数器设计方案</h1><h2 id="3-1-数据库方案"><a href="#3-1-数据库方案" class="headerlink" title="(3.1) 数据库方案"></a>(3.1) 数据库方案</h2><p>  在刚开始阶段，用户较少并且用户发布的信息/动态较少时，可以使用数据库来存储。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> msg_count <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键id'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>    
    <span class="token identifier"><span class="token punctuation">`</span>msg_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'信息id'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>like_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'点赞数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>favor_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'收藏数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>repost_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'转发数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>comment_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'评论数'</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uq_idx_msg_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>msg_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'信息(动态)计数表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-1-1-实现业务功能"><a href="#3-1-1-实现业务功能" class="headerlink" title="(3.1.1) 实现业务功能"></a>(3.1.1) 实现业务功能</h3><p>  查询点赞数 <code>UPDATE msg_count SET like_num = like_num + 1 WHERE msg_id = xxx ;</code><br>  更新点赞数 <code>SELECT msg_count WHERE msg_id = xxx ;</code></p>
<h3 id="3-1-2-存储"><a href="#3-1-2-存储" class="headerlink" title="(3.1.2) 存储"></a>(3.1.2) 存储</h3><p>  按照上面的表设计，一条计数数据占用64字节，MySQL一页可以存储 16K/64=256条数据<br>  MySQL一页可以存储 16K / (主键ID 8字节 + 指针 6字节) = 1170 条数据</p>
<p>  假设MySQL查一条数据需要二次IO，读取二页，那么MySQL单表 可以存储 <code>1170 * 256</code> = <code>29 9520</code> 条数据。<br>  假设MySQL查一条数据需要三次IO，读取三页，那么MySQL单表 可以存储 <code>1170 * 1170 * 256</code> = <code>3 5043 8400</code> 条数据。<br>  从数据存储角度看，MySQL单表存储上亿条数据没问题。</p>
<p>  假设一个表存一亿条数据，需要一千多个表就可以存储千亿条数据。<br>  从维护角度看，可以让单表数据量500万，这样单表 数据备份，改表等时间会短一点。</p>
<p><strong>未来扩缩容</strong></p>
<p>  按信息ID(msg_id)取模，把数据拆分到N个表(N是2的幂次方)。<br>  如果要扩容，把N个表拆成 <code>N * 2^x</code>，迁移数据时只需要把 1个表拆数据到 <code>2^x</code>个表即可。</p>
<h3 id="3-1-3-性能"><a href="#3-1-3-性能" class="headerlink" title="(3.1.3) 性能"></a>(3.1.3) 性能</h3><p>  从查询角度看，百万的查询量，分摊到一千个每个表，每个表查询QPS大概是100左右，从单表查询QPS来看是没什么问题的，但是从 CPU、内存、IO角度看是有资源的问题<br>  每秒百万请求量，那么MySQL需要把数据读取到内存，会有页数据对应的内存淘汰，假设有一半的数据在内存，msg_count表单条计数数据64字节 * 每秒100 0000访问量 / 2 = 6400 0000字节，也就是MySQL至少需要64G内存，</p>
<p>  从业务角度看，也是会有问题的，单表平均QPS大概100，但实际上往往一个热点微博可能导致所在表的QPS上万。</p>
<h3 id="3-1-4-存储数据量过大怎么办-分库分表"><a href="#3-1-4-存储数据量过大怎么办-分库分表" class="headerlink" title="(3.1.4) 存储数据量过大怎么办-分库分表"></a>(3.1.4) 存储数据量过大怎么办-分库分表</h3><p>  对于一亿甚至几亿以下的数据规模来说，拆表能够解决很多问题。</p>
<p>  类似于电商交易场景的订单分库分表，按照<code>uid</code>和<code>order_id</code>分库分表<br>  技术系统可以按照<code>uid</code>或者<code>msg_id</code>分库分表</p>
<h4 id="3-1-4-1-按照uid分库分表"><a href="#3-1-4-1-按照uid分库分表" class="headerlink" title="(3.1.4.1) 按照uid分库分表"></a>(3.1.4.1) 按照uid分库分表</h4><ol>
<li>写入时一个用户的所有动态(微博)在一个表里。</li>
<li>用户在查看自己的动态(微博)列表时，可以批量获取点赞数，评论数、转发数。</li>
<li>如果用户是一个热点用户，发的动态(微博)比较多，查询压力会在同一个表，这张表可能会成为热点表。<br>   可以通过mq或日志计数，如果<code>计数结果&gt;设置阈值</code>，把热点动态的计数放到缓存里。<br>   不过如果一个动态(微博)是热点，可能mq计数还没把数据放到缓存里数据库就挂了。</li>
<li>如果直接根据msg_id来查，会找不到对应的库表，需要根据uid和msg_id来查。  或者msg_id里可以记录uid的一些信息。</li>
</ol>
<h4 id="3-1-4-2-按照msg-id分库分表"><a href="#3-1-4-2-按照msg-id分库分表" class="headerlink" title="(3.1.4.2) 按照msg_id分库分表"></a>(3.1.4.2) 按照msg_id分库分表</h4><ol>
<li>写入时一个用户的所有动态(微博)在多个表里。</li>
<li>用户在查看自己的动态(微博)列表时，获取点赞数，评论数、转发数 需要进行多次查询。</li>
<li>如果用户是一个热点用户，发的动态(微博)比较多，</li>
</ol>
<h4 id="3-1-4-3-按照create-time分库分表"><a href="#3-1-4-3-按照create-time分库分表" class="headerlink" title="(3.1.4.3) 按照create_time分库分表"></a>(3.1.4.3) 按照create_time分库分表</h4><p>  这个一般是数据归档使用<br>  如果按照 create_time 分库分表，在C端高并发场景，同一天的热点数据在同一个表，有热点时单表肯定扛不住。</p>
<br>


<h3 id="3-1-5-访问量太大怎么办"><a href="#3-1-5-访问量太大怎么办" class="headerlink" title="(3.1.5) 访问量太大怎么办?"></a>(3.1.5) 访问量太大怎么办?</h3><p>  使用缓存+数据库，先查缓存，缓存查不到再查数据库。</p>
<p>优点<br>  只需要改少量代码。<br>  方案成熟, 数据复制，管理，修复方案都很成熟。</p>
<p>问题：<br>  1、空数据也得Cache(有一半以上的微博是没有转发也没有评论的，但是依然有大量的访问会查询数据库);<br>  2、Cache频繁失效(由于计数更新非常快，所以经常需要失效Cache再重新缓存，还会导致数据不一致);</p>
<p>  更好的硬件解决。 上FusionIO + HandleSocket + 大内存 优化。</p>
<p>  总的来说，MySQL分库分表 + Cache加速的方案 对于数据规模和访问量不是特别巨大的情况下，是非常不错的解决方案。</p>
<br>


<h2 id="3-2-Redis缓存方案"><a href="#3-2-Redis缓存方案" class="headerlink" title="(3.2) Redis缓存方案"></a>(3.2) Redis缓存方案</h2><p>  Redis作为一个简单的内存数据库，提供了多种数据类型，可以使用<code>string</code>类型的 incr 来计数。<br>  具体命令参考 <a target="_blank" rel="noopener" href="https://redis.io/commands/incr/">https://redis.io/commands/incr/</a> </p>
<p>  简单的来估算一下数据存储量，按照Redis 6.0的实现，在64位系统，指针为8字节来估算</p>
<p>  假设 key 为8字节，value为 4字节，通过incr存储的话  </p>
<p>  key value 会存储在 dictEntry里，详细的结构:  <code>redisServer -&gt; db0 -&gt; dict -&gt; ht[0] -&gt; dictht -&gt; dictEntry</code></p>
<p>  <img data-src="/img/database/redis/index-model/redis-index-model.png" alt="redis索引模型"></p>
<p>  从后往前 </p>
<ol>
<li>存储key为8字节数字(64位 8字节 long类型/int64，Eg:9223372036854775807 )，但通过 <code>sdsdup</code> 以字符串的形式存储，至少需要 8(struct sdshdr) + 19(数字转字符串后长度是19) + 1(结束字符) = 28字节;</li>
<li>存储val为4字节数字(32位 4字节 int类型/int32，Eg: 2147483647 )，通过 createStringObjectFromLongLong 创建一个robj，由于val &gt; REDIS_SHARED_INTEGERS (默认1000), 所以存储时用的 encoding为 REDIS_ENCODING_INT，占用8字节，加上redisObject，一共占用16字节 (这里redis有个优化，把redisObject的指针ptr直接存储int类型，节省了一个指针的开销，所以不是占用 16+8字节 而是16字节)</li>
<li>为了存储到Redis的dict里，需要一个dictEntry对象，占用 3*8字节=24字节</li>
<li>放到 <code>db-&gt;dict-&gt;ht[0]-&gt;table</code> 中存储dictEntry的指针，需要8个字节;</li>
<li>存储一个64位key，32位value的计数，Redis也至少需要耗费: 16 + 28 + 24 + 8 = 76 字节。</li>
<li>1000亿个key全内存的话，就至少需要 ( 100 * 1000 * 1000 * 1000 ) * 76 = 100G * 76 = 7.6TB 的内存</li>
</ol>
<p>  从技术角度讲<br>  只算value，有效的业务数据其实是 <code>1000亿*32位</code> = <code>100G * 4字节</code> = <code>400GB</code>，需要<code>7.6TB</code>来存储，内存的有效利用率约为: <code>400GB/7600GB = 5.3%</code>。<br>  key和value全算上，有效业务数据是 <code>1000亿*(64位+32位)</code> = <code>100G * 12字节</code> = <code>1200GB</code>，需要<code>7.6TB</code>存储，内存有效利用率约为：<code>1200GB/7600GB = 15.7%</code></p>
<br>



<h2 id="3-3-计数服务-优化Redis源码"><a href="#3-3-计数服务-优化Redis源码" class="headerlink" title="(3.3) 计数服务-优化Redis源码"></a>(3.3) 计数服务-优化Redis源码</h2><p>  计数器是一个普通的基础服务，但是因为数据量太大了，从而量变引发了质变。<br>  所以做Counter时的一个思路就是: 牺牲部分的通用性，针对微博转发和评论的大数据量和高并发访问的特点来进行定点优化。</p>
<h3 id="3-3-1-优化Redis结构体"><a href="#3-3-1-优化Redis结构体" class="headerlink" title="(3.3.1) 优化Redis结构体"></a>(3.3.1) 优化Redis结构体</h3><p> 方案二中Redis对内存使用的分析，我们发现是非常”奢侈”的, 大量的重复存储着指针和预留的字段，而且造成大量的碎片内存的使用，当然Redis主要是出于通用性的考虑。<br>  针对这种情况，设计了一个更轻量更简单的数据结构，能更好的利用内存，核心思路:</p>
<p>改动点</p>
<ol>
<li>定制化数据结构。</li>
<li>hash冲突时把<code>链地址法优化</code>为<code>开放寻址法</code> 。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * 哈希表节点/Entry实体 
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">updateDictEntry</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">int64_t</span> msg_id<span class="token punctuation">;</span>  <span class="token comment">// 信息ID 对应微博ID  </span>
    <span class="token keyword">int</span> repost_num<span class="token punctuation">;</span>  <span class="token comment">// 转发数</span>
    <span class="token keyword">int</span> comment_num<span class="token punctuation">;</span> <span class="token comment">// 评论数</span>
<span class="token punctuation">&#125;</span> dictEntry<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  优化前后对比<br>  <a href="/">优化前内存占用</a></p>
<p>  <a href="/img/database/redis/memory/weibo-redis-memory-structure-main.png">优化后内存占用</a></p>
<ol>
<li>Value的长度短于指针长度</li>
<li>开放寻址Hash表(双重散列)</li>
<li>以节省指针存储</li>
</ol>
<p>  优化后一条数据占用内存<br>  业务数据 有效内存利用率为 </p>
<h3 id="3-3-1-业务维度优化"><a href="#3-3-1-业务维度优化" class="headerlink" title="(3.3.1) 业务维度优化"></a>(3.3.1) 业务维度优化</h3><ol>
<li>大量微博(一半以上)没有转发或没有评论，甚至是都没有<br>针对这种情况的优化:</li>
</ol>
<p>抛弃 存储+Cache 的思路.因为这些为0的数据，也必须进到Cache中(无论是旁路还是穿透).<br>查询量并不小，这对于Cache的利用率影响非常非常的大(有一半的数据是空的。) 而我们采用类似 存储即Cache(存储本身就在内存中) 时，这一类的数据是可以不存储的，当查不到的时候，就返回0。<br>通过这种优化:</p>
<p>1000亿个数字，我们可以减少3/5，即最多只需要存 400亿个数字。这算是最经典的稀疏数组的优化存储方式了。</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><ol start="2">
<li>微博的评论数和转发数的关联度非常的高。<br>他们都有相同的主Key, 有大量转发的微博一般也有评论，有大量评论的一般转发量也不小。 而且访问量最大的Feed页基本上取评论数的时候，也会取转发数。。。</li>
</ol>
<p>针对这种情况的优化:</p>
<p>我们将评论数和转发数 可以考虑存储在一起，这样的话，可以节省大量key的存储空间。 由 微博ID+评论数; 微博ID+转发数 变为: 微博ID+评论数+转发数的结构。<br>PS: 这个优化和上一个优化是有一些小冲突的，部分有转发没有评论的微博，需要多存一个0; 但是经过数据评估，我们发现这个优化还是相当必要的:<br>key存储的空间比评论数还要长，一个8字节，一个4字节;<br>对于应用层来说，批量请求可以减少一次访问，能够降请求的压力，同时提升响应的时间;<br>(具体的数字不方便透露，但是这个结论大家可以随机抽取一批公开的微博来验证)</p>
<h2 id="3-4-KV存储"><a href="#3-4-KV存储" class="headerlink" title="(3.4) KV存储"></a>(3.4) KV存储</h2><h1 id="4-系统安全问题"><a href="#4-系统安全问题" class="headerlink" title="(4) 系统安全问题"></a>(4) 系统安全问题</h1><h2 id="4-1-系统怎么应对爬虫？"><a href="#4-1-系统怎么应对爬虫？" class="headerlink" title="(4.1)  系统怎么应对爬虫？"></a>(4.1)  系统怎么应对爬虫？</h2><p>  网关+风控处理</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://blog.cydu.net/weidesign/2012/08/30/weibo-counter-service-design-1/">[WeiDesign]微博计数器的设计(上)</a><br>[2] <a target="_blank" rel="noopener" href="https://blog.cydu.net/weidesign/2012/09/09/weibo-counter-service-design-2/">[WeiDesign]微博计数器的设计(下)</a><br>[3] <a target="_blank" rel="noopener" href="https://blog.cydu.net/weidesign/2012/12/06/weibo-counter-service-design-for-velocity/">[WeiDesign]微博计数器的设计 velocity</a><br>[4] <a target="_blank" rel="noopener" href="https://blog.cydu.net/public/doc/Velocity%E5%88%86%E4%BA%AB_%E5%BE%AE%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B9%8B%E5%BE%AE%E5%8D%9A%E8%AE%A1%E6%95%B0%E5%99%A8%E6%9C%8D%E5%8A%A1_%E6%9D%9C%E4%BC%A0%E8%B5%A2_20121205.pdf">Velocity分享_微架构设计之微博计数器服务_杜传赢_20121205.pdf</a><br>[5] <a target="_blank" rel="noopener" href="https://www.modb.pro/db/80391">微博计数:从关系服务到访问计数,Redis持续优化支撑万亿级访问（含PPT）</a><br>[6] <a target="_blank" rel="noopener" href="https://www.infoq.cn/article/ky0ag3enlta7oh6nqiit">微博每日数十亿级业务下的计数器如何扩展Redis？</a><br>[7] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/179373">高并发系统设计40问 - 37计数系统设计（一）：面对海量数据的计数器要如何做？</a><br>[8] <a target="_blank" rel="noopener" href="https://instagram-engineering.com/storing-hundreds-of-millions-of-simple-key-value-pairs-in-redis-1091ae80f74c">Storing hundreds of millions of simple key-value pairs in Redis</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/22/redis-data-structure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/22/redis-data-structure/" class="post-title-link" itemprop="url">redis数据结构-存亿级数据需要耗费多少内存</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-22 15:53:48" itemprop="dateCreated datePublished" datetime="2022-01-22T15:53:48+08:00">2022-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-05 22:16:45" itemprop="dateModified" datetime="2023-02-05T22:16:45+08:00">2023-02-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/01/22/redis-data-structure/" class="post-meta-item leancloud_visitors" data-flag-title="redis数据结构-存亿级数据需要耗费多少内存" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/22/redis-data-structure/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/22/redis-data-structure/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>　　同事在实现一个弹窗需求时遇到一个问题，找大家讨论方案，产品的需求是小程序首页各种弹窗太多了，用户一进来需要点多个弹窗，要求服务端限制在首页一个用户一天只能弹一次。当时考虑了数据库和缓存，从实现简易程度、扩展性、速度综合考虑最后选了redis缓存。</p>
<h1 id="Redis数据类型"><a href="#Redis数据类型" class="headerlink" title="Redis数据类型"></a>Redis数据类型</h1><p> <img data-src=""></p>
<p>五种数据形式的底层实现<br>  string：简单动态字符串<br>  list：双向链表，压缩列表<br>  hash：压缩列表，哈希表<br>  Sorted Set：压缩列表，跳表<br>  set：哈希表，整数数组</p>
<h1 id="3-redis常用数据类型-对象"><a href="#3-redis常用数据类型-对象" class="headerlink" title="(3) redis常用数据类型/对象"></a>(3) redis常用数据类型/对象</h1><p>  上面介绍了 6 种底层数据结构，Redis 并没有直接使用这些数据结构来实现键值数据库，而是基于这些数据结构创建了一个对象系统，这个系统包含字符串对象、列表对象、哈希对象、集合对象和有序集合这五种类型的对象，每个对象都使用到了至少一种前边讲的底层数据结构。</p>
<p>redis常用的数据对象有以下几种</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* The actual Redis Object *&#x2F;
#define OBJ_STRING 0    &#x2F;* String object. *&#x2F;
#define OBJ_LIST 1      &#x2F;* List object. *&#x2F;
#define OBJ_SET 2       &#x2F;* Set object. *&#x2F;
#define OBJ_ZSET 3      &#x2F;* Sorted set object. *&#x2F;
#define OBJ_HASH 4      &#x2F;* Hash object. *&#x2F;

#define OBJ_MODULE 5    &#x2F;* Module object. *&#x2F;
#define OBJ_STREAM 6    &#x2F;* Stream object. *&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="3-1-字符串对象-OBJ-STRING"><a href="#3-1-字符串对象-OBJ-STRING" class="headerlink" title="(3.1) 字符串对象 OBJ_STRING"></a>(3.1) 字符串对象 OBJ_STRING</h2><h2 id="3-2-列表对象-OBJ-LIST"><a href="#3-2-列表对象-OBJ-LIST" class="headerlink" title="(3.2) 列表对象 OBJ_LIST"></a>(3.2) 列表对象 OBJ_LIST</h2><h2 id="3-3-集合对象-OBJ-SET"><a href="#3-3-集合对象-OBJ-SET" class="headerlink" title="(3.3) 集合对象 OBJ_SET"></a>(3.3) 集合对象 OBJ_SET</h2><h2 id="3-4-有序集合对象-OBJ-ZSET"><a href="#3-4-有序集合对象-OBJ-ZSET" class="headerlink" title="(3.4) 有序集合对象 OBJ_ZSET"></a>(3.4) 有序集合对象 OBJ_ZSET</h2><p>  Sorted Set内部实现数据结构是跳表和压缩列表。<br>  跳表主要服务范围操作，提供O(logN)的复杂度。<br>  zset有个ZSCORE的操作，用于返回单个集合member的分数，它的操作复杂度是O(1)，这就是收益于你这看到的hash table。这个hash table保存了集合元素和相应的分数，所以做ZSCORE操作时，直接查这个表就可以，复杂度就降为O(1)了。</p>
<h2 id="3-5-哈希对象-OBJ-HASH"><a href="#3-5-哈希对象-OBJ-HASH" class="headerlink" title="(3.5) 哈希对象 OBJ_HASH"></a>(3.5) 哈希对象 OBJ_HASH</h2><h1 id="2-redis常用数据结构"><a href="#2-redis常用数据结构" class="headerlink" title="(2) redis常用数据结构"></a>(2) redis常用数据结构</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Objects encoding. Some kind of objects like Strings and Hashes can be
 * internally represented in multiple ways. The 'encoding' field of the object
 * is set to one of this fields for this object. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_RAW</span> <span class="token expression"><span class="token number">0</span>     </span><span class="token comment">/* Raw representation */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_INT</span> <span class="token expression"><span class="token number">1</span>     </span><span class="token comment">/* Encoded as integer */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_HT</span> <span class="token expression"><span class="token number">2</span>      </span><span class="token comment">/* Encoded as hash table */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_ZIPMAP</span> <span class="token expression"><span class="token number">3</span>  </span><span class="token comment">/* Encoded as zipmap */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_LINKEDLIST</span> <span class="token expression"><span class="token number">4</span> </span><span class="token comment">/* No longer used: old list encoding. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_ZIPLIST</span> <span class="token expression"><span class="token number">5</span> </span><span class="token comment">/* Encoded as ziplist */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_INTSET</span> <span class="token expression"><span class="token number">6</span>  </span><span class="token comment">/* Encoded as intset */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_SKIPLIST</span> <span class="token expression"><span class="token number">7</span>  </span><span class="token comment">/* Encoded as skiplist */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_EMBSTR</span> <span class="token expression"><span class="token number">8</span>  </span><span class="token comment">/* Embedded sds string encoding */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_QUICKLIST</span> <span class="token expression"><span class="token number">9</span> </span><span class="token comment">/* Encoded as linked list of ziplists */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_STREAM</span> <span class="token expression"><span class="token number">10</span> </span><span class="token comment">/* Encoded as a radix tree of listpacks */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-1-简单动态字符串SDS"><a href="#2-1-简单动态字符串SDS" class="headerlink" title="(2.1) 简单动态字符串SDS"></a>(2.1) 简单动态字符串SDS</h2><p>　　代码见<br>　　SDS包括 RAW INT EMDSTR </p>
<h2 id="2-2-链表"><a href="#2-2-链表" class="headerlink" title="(2.2) 链表"></a>(2.2) 链表</h2><h2 id="2-3-字典"><a href="#2-3-字典" class="headerlink" title="(2.3) 字典"></a>(2.3) 字典</h2><h2 id="2-4-跳跃表"><a href="#2-4-跳跃表" class="headerlink" title="(2.4) 跳跃表"></a>(2.4) 跳跃表</h2><h2 id="2-5-整数集合"><a href="#2-5-整数集合" class="headerlink" title="(2.5) 整数集合"></a>(2.5) 整数集合</h2><h2 id="2-6-压缩列表"><a href="#2-6-压缩列表" class="headerlink" title="(2.6) 压缩列表"></a>(2.6) 压缩列表</h2><h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><h2 id="Redis为什么会把整数数组和压缩列表作为底层数据结构"><a href="#Redis为什么会把整数数组和压缩列表作为底层数据结构" class="headerlink" title="Redis为什么会把整数数组和压缩列表作为底层数据结构?"></a>Redis为什么会把整数数组和压缩列表作为底层数据结构?</h2><p>  整数数组和压缩列表在查找时间复杂度方面并没有很大的优势，那为什么 Redis 还会把它们作为底层数据结构呢？</p>
<p>1、内存利用率，数组和压缩列表都是非常紧凑的数据结构，它比链表占用的内存要更少。<br>  Redis是内存数据库，大量数据存到内存中，此时需要做尽可能的优化，提高内存的利用率。</p>
<p>2、数组对CPU高速缓存支持更友好，所以Redis在设计时，集合数据元素较少情况下，默认采用内存紧凑排列的方式存储，同时利用CPU高速缓存不会降低访问速度。当数据元素超过设定阈值后，避免查询时间复杂度太高，转为哈希和跳表数据结构存储，保证查询效率。</p>
<p>数组对cpu缓存友好的原因是: cpu预读取一个cache line大小的数据, 数组数据排列紧凑、相同大小空间保存的元素更多, 访问下一个元素时、恰好已经在cpu缓存了. 如果是随机访问、就不能充分利用cpu缓存了, 拿int元素举例: 一个元素4byte, CacheLine 假设64byte, 可以预读取 16个挨着的元素, 如果下次随机访问的元素不在这16个元素里、就需要重新从内存读取了.</p>
<h1 id="4-手动测试过程"><a href="#4-手动测试过程" class="headerlink" title="(4) 手动测试过程"></a>(4) 手动测试过程</h1><p>　1、flushall 清空所有数据<br>　2、测试用string类型存 key=1000000，value=1<br>　3、插入100万uid用了55M左右(实际占用操作系统64M)<br>　4、插入1000万用了587M(实际占用从操作系统622M)</p>
<p> 　感觉不太对，key是long类型 8字节，100万*8=8M， 100万key占8M 100万value占8M 多余的55-8-8=39M去哪了？</p>
<h2 id="4-1-测试代码"><a href="#4-1-测试代码" class="headerlink" title="(4.1) 测试代码"></a>(4.1) 测试代码</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisMemoryTest</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token class-name">JedisPoolUtil</span><span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 1000万 18位用户id
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 18位用户id</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token number">123456789012345678L</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">10000000</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">123456789012345678L</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> res <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-2-redis-flushall后-info-memory信息"><a href="#4-2-redis-flushall后-info-memory信息" class="headerlink" title="(4.2) redis flushall后 info memory信息"></a>(4.2) redis flushall后 info memory信息</h2><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"><span class="token comment"># Memory</span>
used_memory:1180064
used_memory_human:1.13M
used_memory_rss:954368
used_memory_rss_human:932.00K
used_memory_peak:1219088
used_memory_peak_human:1.16M
used_memory_peak_perc:96.80%
used_memory_overhead:1132016
used_memory_startup:1079584
used_memory_dataset:48048
used_memory_dataset_perc:47.82%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="4-3-redis-插入100万数据后的info-memory信息"><a href="#4-3-redis-插入100万数据后的info-memory信息" class="headerlink" title="(4.3) redis 插入100万数据后的info memory信息"></a>(4.3) redis 插入100万数据后的info memory信息</h2><p>　</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> info memory
<span class="token comment"># Memory</span>
used_memory:57558992
used_memory_human:54.89M
used_memory_rss:66695168
used_memory_rss_human:63.61M
used_memory_peak:58020704
used_memory_peak_human:55.33M
used_memory_peak_perc:99.20%
used_memory_overhead:49520624
used_memory_startup:1079584
used_memory_dataset:8038368
used_memory_dataset_perc:14.23%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-4-redis-插入100万数据后的info-memory信息"><a href="#4-4-redis-插入100万数据后的info-memory信息" class="headerlink" title="(4.4) redis 插入100万数据后的info memory信息"></a>(4.4) redis 插入100万数据后的info memory信息</h2><p>　</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">
<span class="token comment"># Memory</span>
used_memory:615390352
used_memory_human:586.88M
used_memory_rss:421154816
used_memory_rss_human:401.64M
used_memory_peak:653409248
used_memory_peak_human:623.14M
used_memory_peak_perc:94.18%
used_memory_overhead:535349840
used_memory_startup:1079584
used_memory_dataset:80040512
used_memory_dataset_perc:13.03%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://github.com/redis/redis/tree/6.0">redis源码 - github</a><br>[2] <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HgwmTlmV_d2dOmAl-fYzkQ">十二张图详解Redis的数据结构和对象系统</a><br>[3] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/279649">“万金油”的String，为什么不好用了</a></p>
<!--
127.0.0.1:6379>
127.0.0.1:6379> flushall
OK
127.0.0.1:6379>
127.0.0.1:6379> dbsize
(integer) 0
127.0.0.1:6379> info
# Server
redis_version:6.0.9
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:2f127c9309e399ac
redis_mode:standalone
os:Darwin 21.1.0 x86_64
arch_bits:64
multiplexing_api:kqueue
atomicvar_api:atomic-builtin
gcc_version:4.2.1
process_id:8785
run_id:2ab931b023bfa36f2dd53f86285eedefbff94d82
tcp_port:6379
uptime_in_seconds:37912
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:15511216
executable:/Users/weikeqin/SoftWare/redis/redis-6.0.9/./src/redis-server
config_file:/Users/weikeqin/SoftWare/redis/redis-6.0.9/redis.conf
io_threads_active:0

# Clients
connected_clients:3
client_recent_max_input_buffer:112
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

# Memory
used_memory:1180064
used_memory_human:1.13M
used_memory_rss:954368
used_memory_rss_human:932.00K
used_memory_peak:1219088
used_memory_peak_human:1.16M
used_memory_peak_perc:96.80%
used_memory_overhead:1132016
used_memory_startup:1079584
used_memory_dataset:48048
used_memory_dataset_perc:47.82%
allocator_allocated:1133456
allocator_active:916480
allocator_resident:916480
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:0.81
allocator_frag_bytes:18446744073709334640
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.04
rss_overhead_bytes:37888
mem_fragmentation_ratio:0.84
mem_fragmentation_bytes:-179088
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52432
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0

# Persistence
loading:0
rdb_changes_since_last_save:4
rdb_bgsave_in_progress:0
rdb_last_save_time:1642901160
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:0
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

# Stats
total_connections_received:3
total_commands_processed:19
instantaneous_ops_per_sec:0
total_net_input_bytes:563
total_net_output_bytes:48551
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:84
evicted_keys:0
keyspace_hits:4
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:545
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:40
total_writes_processed:19
io_threaded_reads_processed:0
io_threaded_writes_processed:0

# Replication
role:master
connected_slaves:0
master_replid:ca93fb6c88be31059c24ddbcf2744d57b94c08f6
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

# CPU
used_cpu_sys:19.074490
used_cpu_user:4.556408
used_cpu_sys_children:0.002266
used_cpu_user_children:0.000434

# Modules

# Cluster
cluster_enabled:0

# Keyspace
127.0.0.1:6379>
127.0.0.1:6379> info memory
# Memory
used_memory:1178576
used_memory_human:1.12M
used_memory_rss:983040
used_memory_rss_human:960.00K
used_memory_peak:1219088
used_memory_peak_human:1.16M
used_memory_peak_perc:96.68%
used_memory_overhead:1132016
used_memory_startup:1079584
used_memory_dataset:46560
used_memory_dataset_perc:47.03%
allocator_allocated:1133456
allocator_active:945152
allocator_resident:945152
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:0.83
allocator_frag_bytes:18446744073709363312
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.04
rss_overhead_bytes:37888
mem_fragmentation_ratio:0.87
mem_fragmentation_bytes:-150416
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52432
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0
127.0.0.1:6379>
127.0.0.1:6379>



127.0.0.1:6379> dbsize
(integer) 1000000
127.0.0.1:6379>
127.0.0.1:6379> info memory
# Memory
used_memory:57558992
used_memory_human:54.89M
used_memory_rss:66695168
used_memory_rss_human:63.61M
used_memory_peak:58020704
used_memory_peak_human:55.33M
used_memory_peak_perc:99.20%
used_memory_overhead:49520624
used_memory_startup:1079584
used_memory_dataset:8038368
used_memory_dataset_perc:14.23%
allocator_allocated:57522064
allocator_active:66657280
allocator_resident:66657280
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:1.16
allocator_frag_bytes:9135216
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.00
rss_overhead_bytes:37888
mem_fragmentation_ratio:1.16
mem_fragmentation_bytes:9173104
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52432
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0
127.0.0.1:6379>
127.0.0.1:6379>
127.0.0.1:6379>
127.0.0.1:6379>
127.0.0.1:6379> info
# Server
redis_version:6.0.9
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:2f127c9309e399ac
redis_mode:standalone
os:Darwin 21.1.0 x86_64
arch_bits:64
multiplexing_api:kqueue
atomicvar_api:atomic-builtin
gcc_version:4.2.1
process_id:8785
run_id:2ab931b023bfa36f2dd53f86285eedefbff94d82
tcp_port:6379
uptime_in_seconds:38131
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:15511435
executable:/Users/weikeqin/SoftWare/redis/redis-6.0.9/./src/redis-server
config_file:/Users/weikeqin/SoftWare/redis/redis-6.0.9/redis.conf
io_threads_active:0

# Clients
connected_clients:3
client_recent_max_input_buffer:112
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

# Memory
used_memory:57560480
used_memory_human:54.89M
used_memory_rss:66695168
used_memory_rss_human:63.61M
used_memory_peak:58020704
used_memory_peak_human:55.33M
used_memory_peak_perc:99.21%
used_memory_overhead:49520624
used_memory_startup:1079584
used_memory_dataset:8039856
used_memory_dataset_perc:14.23%
allocator_allocated:57522064
allocator_active:66657280
allocator_resident:66657280
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:1.16
allocator_frag_bytes:9135216
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.00
rss_overhead_bytes:37888
mem_fragmentation_ratio:1.16
mem_fragmentation_bytes:9173104
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52432
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0

# Persistence
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1642901282
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:0
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

# Stats
total_connections_received:14
total_commands_processed:1000023
instantaneous_ops_per_sec:0
total_net_input_bytes:33000645
total_net_output_bytes:5054469
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:87
evicted_keys:0
keyspace_hits:4
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:1318
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:1000055
total_writes_processed:1000023
io_threaded_reads_processed:0
io_threaded_writes_processed:0

# Replication
role:master
connected_slaves:0
master_replid:ca93fb6c88be31059c24ddbcf2744d57b94c08f6
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

# CPU
used_cpu_sys:33.077658
used_cpu_user:11.821818
used_cpu_sys_children:0.100676
used_cpu_user_children:0.725147

# Modules

# Cluster
cluster_enabled:0

# Keyspace
db0:keys=1000000,expires=0,avg_ttl=0
127.0.0.1:6379>
127.0.0.1:6379>
127.0.0.1:6379> flushall
OK
(0.82s)
127.0.0.1:6379>



127.0.0.1:6379> dbsize
(integer) 10000000
127.0.0.1:6379>
127.0.0.1:6379>
127.0.0.1:6379> info
# Server
redis_version:6.0.9
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:2f127c9309e399ac
redis_mode:standalone
os:Darwin 21.1.0 x86_64
arch_bits:64
multiplexing_api:kqueue
atomicvar_api:atomic-builtin
gcc_version:4.2.1
process_id:8785
run_id:2ab931b023bfa36f2dd53f86285eedefbff94d82
tcp_port:6379
uptime_in_seconds:40987
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:15514291
executable:/Users/weikeqin/SoftWare/redis/redis-6.0.9/./src/redis-server
config_file:/Users/weikeqin/SoftWare/redis/redis-6.0.9/redis.conf
io_threads_active:0

# Clients
connected_clients:3
client_recent_max_input_buffer:208
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

# Memory
used_memory:615389936
used_memory_human:586.88M
used_memory_rss:1769472
used_memory_rss_human:1.69M
used_memory_peak:651222816
used_memory_peak_human:621.05M
used_memory_peak_perc:94.50%
used_memory_overhead:535349840
used_memory_startup:1079584
used_memory_dataset:80040096
used_memory_dataset_perc:13.03%
allocator_allocated:615351520
allocator_active:1731584
allocator_resident:1731584
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:0.00
allocator_frag_bytes:18446744073095931680
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.02
rss_overhead_bytes:37888
mem_fragmentation_ratio:0.00
mem_fragmentation_bytes:-613582048
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52528
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0

# Persistence
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1642902295
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:5
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

# Stats
total_connections_received:106
total_commands_processed:11000124
instantaneous_ops_per_sec:0
total_net_input_bytes:373003398
total_net_output_bytes:55068514
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:120
evicted_keys:0
keyspace_hits:4
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:3497
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:11000267
total_writes_processed:11000205
io_threaded_reads_processed:0
io_threaded_writes_processed:0

# Replication
role:master
connected_slaves:0
master_replid:ca93fb6c88be31059c24ddbcf2744d57b94c08f6
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

# CPU
used_cpu_sys:181.499349
used_cpu_user:99.340829
used_cpu_sys_children:3.358057
used_cpu_user_children:29.351075

# Modules

# Cluster
cluster_enabled:0

# Keyspace
db0:keys=10000000,expires=0,avg_ttl=0
127.0.0.1:6379>



127.0.0.1:6379> info
# Server
redis_version:6.0.9
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:2f127c9309e399ac
redis_mode:standalone
os:Darwin 21.1.0 x86_64
arch_bits:64
multiplexing_api:kqueue
atomicvar_api:atomic-builtin
gcc_version:4.2.1
process_id:8785
run_id:2ab931b023bfa36f2dd53f86285eedefbff94d82
tcp_port:6379
uptime_in_seconds:41739
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:15515043
executable:/Users/weikeqin/SoftWare/redis/redis-6.0.9/./src/redis-server
config_file:/Users/weikeqin/SoftWare/redis/redis-6.0.9/redis.conf
io_threads_active:0

# Clients
connected_clients:3
client_recent_max_input_buffer:208
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

# Memory
used_memory:615390352
used_memory_human:586.88M
used_memory_rss:421154816
used_memory_rss_human:401.64M
used_memory_peak:653409248
used_memory_peak_human:623.14M
used_memory_peak_perc:94.18%
used_memory_overhead:535349840
used_memory_startup:1079584
used_memory_dataset:80040512
used_memory_dataset_perc:13.03%
allocator_allocated:615351936
allocator_active:421116928
allocator_resident:421116928
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:0.68
allocator_frag_bytes:18446744073515316608
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.00
rss_overhead_bytes:37888
mem_fragmentation_ratio:0.68
mem_fragmentation_bytes:-194197120
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52528
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0

# Persistence
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1642904993
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:6
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

# Stats
total_connections_received:197
total_commands_processed:21000208
instantaneous_ops_per_sec:0
total_net_input_bytes:723005702
total_net_output_bytes:105073310
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:128
evicted_keys:0
keyspace_hits:4
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:8234
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:21000442
total_writes_processed:21000369
io_threaded_reads_processed:0
io_threaded_writes_processed:0

# Replication
role:master
connected_slaves:0
master_replid:ca93fb6c88be31059c24ddbcf2744d57b94c08f6
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

# CPU
used_cpu_sys:328.154683
used_cpu_user:183.784965
used_cpu_sys_children:6.240064
used_cpu_user_children:52.613884

# Modules

# Cluster
cluster_enabled:0

# Keyspace
db0:keys=10000000,expires=0,avg_ttl=0
127.0.0.1:6379>

-->



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/16/redis-persistence/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/16/redis-persistence/" class="post-title-link" itemprop="url">Redis持久化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-16 15:32:10" itemprop="dateCreated datePublished" datetime="2022-01-16T15:32:10+08:00">2022-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-05 22:17:14" itemprop="dateModified" datetime="2023-02-05T22:17:14+08:00">2023-02-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/01/16/redis-persistence/" class="post-meta-item leancloud_visitors" data-flag-title="Redis持久化" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/16/redis-persistence/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/16/redis-persistence/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>299</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>　　经常会遇到的一个问题是数据库如何保证不丢数据？　同样的假如把Redis当数据库用，如何保证不丢数据？</p>
<p>　MySQL里有 redo log、bin log、undo log，MySQL通过binlog全量备份+增量备份保证数据不丢。通过redo log和bin log保证数据一致性。</p>
<p>　Redis里有没有类似的功能呢？</p>
<p>　Redis包含 <code>rdb log</code>、<code>aof log</code>，可以通过RDB全量备份+aof增量备份保证数据几乎不丢。 </p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/01/16/redis-persistence/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/16/redis-aof/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/16/redis-aof/" class="post-title-link" itemprop="url">Redis AOF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-16 14:44:05" itemprop="dateCreated datePublished" datetime="2022-01-16T14:44:05+08:00">2022-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-04-27 00:49:29" itemprop="dateModified" datetime="2023-04-27T00:49:29+08:00">2023-04-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/01/16/redis-aof/" class="post-meta-item leancloud_visitors" data-flag-title="Redis AOF" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/16/redis-aof/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/16/redis-aof/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  经常会被问到一个问题，假如Redis宕机，内存中的数据全部丢失，怎么恢复数据？</p>
<p>Redis 分别提供了 RDB 和 AOF 两种持久化机制：<br>  RDB将数据库的快照(snapshot)以二进制的方式保存到磁盘中。类似于MySQL全量备份。<br>  AOF则以协议文本的方式，将所有对数据库进行过写入的命令(及其参数)记录到AOF文件，以此达到记录数据库状态的目的。 类似于MySQL binlog 增量更新。</p>
<h1 id="1-AOF日志是什么"><a href="#1-AOF日志是什么" class="headerlink" title="(1) AOF日志是什么"></a>(1) AOF日志是什么</h1><p>  Redis AOF（Append-Only File）是一种持久化机制，它记录Redis接收到的每个写操作。它通过将每个写操作追加到磁盘上的文件中来实现。这个文件称为AOF文件。</p>
<p>  AOF文件以Redis特定的格式编写，以实现最佳性能。它也是只追加的，这意味着一旦数据被写入文件，就不能被修改或删除。这使得它成为一种可靠和安全的数据持久化方式。</p>
<p>  <img src="/img/database/redis/log/aof/redis-write-aof-log.png"></p>
<p>  和我们常见的WAL日志不同，WAL(Write Ahead Log)是写前日志，在实际写数据前，先把修改的数据记到日志文件中，再去执行命令，这个就要求数据库需要额外的检查命令是否正确。</p>
<p>  AOF(Append Only File)日志是一种写后日志，在Redis先执行命令，把数据写入内存后，然后才记录日志，日志会追加到文件末尾，所以叫AOF日志。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/01/16/redis-aof/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/15/redis-rdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/15/redis-rdb/" class="post-title-link" itemprop="url">Redis RDB</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-15 21:33:23" itemprop="dateCreated datePublished" datetime="2022-01-15T21:33:23+08:00">2022-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-26 21:28:16" itemprop="dateModified" datetime="2023-02-26T21:28:16+08:00">2023-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/01/15/redis-rdb/" class="post-meta-item leancloud_visitors" data-flag-title="Redis RDB" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/15/redis-rdb/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/15/redis-rdb/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  有一个常见的问题，如果Redis挂了，在启动Redis的时候怎么快速恢复数据？</p>
<p>  如果Redis挂了，在启动的时候可以通过AOF或RDB恢复数据。</p>
<h1 id="1-什么是RDB"><a href="#1-什么是RDB" class="headerlink" title="(1) 什么是RDB"></a>(1) 什么是RDB</h1><p>  <code>RDB</code>是Redis DataBase 的缩写，中文名为快照/内存快照。<br>  RDB持久化是把当前进程数据生成快照保存到磁盘上的过程，可以抽象为<code>全量备份</code>。</p>
<p>  MySQL的全量备份通过<code>mysqldump</code>命令触发，Redis的RDB通过什么命令触发？<br>  RDB可以通过<code>save</code>、<code>bgsave</code> 或 <code>主从复制</code>触发。</p>
<br>


<h1 id="2-为什么要用RDB"><a href="#2-为什么要用RDB" class="headerlink" title="(2) 为什么要用RDB"></a>(2) 为什么要用RDB</h1><p>  Redis是个基于内存的数据库。那服务一旦宕机，内存中的数据将全部丢失。为了保存数据，需要有一个持久化方式，RDB是全量备份的方法。</p>
<p>  主从复制是分布式数据系统保证可靠性的一个重要机制。RDB为Redis主从提供了数据同步机制。</p>
<h2 id="2-1-RDB优缺点"><a href="#2-1-RDB优缺点" class="headerlink" title="(2.1) RDB优缺点"></a>(2.1) RDB优缺点</h2><p>优点<br>  RDB文件是某个时间节点的快照，默认使用LZF算法进行压缩，压缩后的文件体积远远小于内存大小，适用于备份、全量复制等场景；<br>  Redis加载RDB文件恢复数据要远远快于AOF方式；</p>
<p>缺点<br>  RDB方式实时性不够，无法做到秒级的持久化；<br>  每次调用bgsave都需要fork子进程，fork子进程属于重量级操作，频繁执行成本较高；<br>  RDB文件是二进制的，没有可读性，AOF文件在了解其结构的情况下可以手动修改或者补全；<br>  版本兼容RDB文件问题；</p>
<br>


<h1 id="3-RDB的原理"><a href="#3-RDB的原理" class="headerlink" title="(3) RDB的原理"></a>(3) RDB的原理</h1><p>  <img data-src="/img/database/redis/persistence/rdb/redis-rdb-overview.png" alt="Redis RDB数据格式"></p>
<br>



<h1 id="4-源码解读"><a href="#4-源码解读" class="headerlink" title="(4) 源码解读"></a>(4) 源码解读</h1><h2 id="4-1-RDB创建的入口函数和触发时机"><a href="#4-1-RDB创建的入口函数和触发时机" class="headerlink" title="(4.1) RDB创建的入口函数和触发时机"></a>(4.1) RDB创建的入口函数和触发时机</h2><p>  RDB 文件创建的三个时机，分别是 <code>save命令执行</code>、<code>bgsave命令执行</code> 以及 <code>主从复制</code>。<br>  对应源码<code>rdb.c</code>文件中的3个函数 </p>
<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">作用</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">rdbSave</td>
<td align="left">Redis Server在本地磁盘创建RDB文件。</td>
<td align="left">对应save命令</td>
</tr>
<tr>
<td align="left">rdbSaveBackground</td>
<td align="left">Redis Server 使用后台子进程方式，在本地磁盘创建 RDB文件</td>
<td align="left">对应bgsaveCommand</td>
</tr>
<tr>
<td align="left">rdbSaveToSlavesSockets</td>
<td align="left">Redis Server 在采用不落盘方式传输RDB文件进行主从复制时，创建RDB文件</td>
<td align="left">对应了Redis Server 执行主从复制命令，以及周期性检测主从复制状态时触发RDB生成</td>
</tr>
</tbody></table>
<h3 id="4-1-1-同步阻塞保存-rdbSave"><a href="#4-1-1-同步阻塞保存-rdbSave" class="headerlink" title="(4.1.1) 同步阻塞保存-rdbSave"></a>(4.1.1) 同步阻塞保存-rdbSave</h3><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;*
 * 把数据库的数据保存到磁盘上
 *
 * 失败时返回 C_ERR
 * 成功时返回 C_OK 
 *
 * @param *filename 文件名
 * @param *rsi 
 *&#x2F;
int rdbSave(char *filename, rdbSaveInfo *rsi) &#123;
    char tmpfile[256];
    char cwd[MAXPATHLEN]; &#x2F;* Current working dir path for error messages. *&#x2F;
    FILE *fp &#x3D; NULL;
    rio rdb;
    int error &#x3D; 0;

    snprintf(tmpfile,256,&quot;temp-%d.rdb&quot;, (int) getpid());

    &#x2F;&#x2F; 打开文件
    fp &#x3D; fopen(tmpfile,&quot;w&quot;);
    &#x2F;&#x2F; 文件不存在，为空
    if (!fp) &#123;
        &#x2F;&#x2F;  
        char *cwdp &#x3D; getcwd(cwd,MAXPATHLEN);

        &#x2F;&#x2F; 提示 打开文件失败
        serverLog(LL_WARNING,
            &quot;Failed opening the RDB file %s (in server root dir %s) &quot;
            &quot;for saving: %s&quot;,
            filename,
            cwdp ? cwdp : &quot;unknown&quot;,
            strerror(errno));
        return C_ERR;
    &#125;

    &#x2F;&#x2F; rio初始化
    rioInitWithFile(&amp;rdb,fp);

    &#x2F;&#x2F; 标记开始保存
    startSaving(RDBFLAGS_NONE);

    &#x2F;&#x2F; fsync 在 rdb 保存时递增 
    if (server.rdb_save_incremental_fsync)
        &#x2F;&#x2F; todo 自动同步？
        rioSetAutoSync(&amp;rdb,REDIS_AUTOSYNC_BYTES);

    &#x2F;&#x2F; 真正把Redis数据库里的数据保存到文件 
    if (rdbSaveRio(&amp;rdb,&amp;error,RDBFLAGS_NONE,rsi) &#x3D;&#x3D; C_ERR) &#123;
        errno &#x3D; error;
        goto werr;
    &#125;

    &#x2F;&#x2F; 确保数据不会保留在操作系统的输出缓冲区中

    &#x2F;&#x2F; fflush 把缓冲区的数据写到文件里
    if (fflush(fp)) goto werr;

    &#x2F;&#x2F; fsync 确保一直到写磁盘操作结束才会返回
    if (fsync(fileno(fp))) goto werr;

    &#x2F;&#x2F; 关闭文件
    if (fclose(fp)) &#123; fp &#x3D; NULL; goto werr; &#125;
    fp &#x3D; NULL;
    

    &#x2F;&#x2F; 使用 文件重命名 确保仅当生成的数据库文件正常时才自动更改数据库文件。 

    &#x2F;&#x2F; 把缓存文件重命名正式文件时，可能没权限，会重命名失败  
    if (rename(tmpfile,filename) &#x3D;&#x3D; -1) &#123;  &#x2F;&#x2F; 重命名失败
        char *cwdp &#x3D; getcwd(cwd,MAXPATHLEN);

        &#x2F;&#x2F; 打印日志 
        serverLog(LL_WARNING,
            &quot;Error moving temp DB file %s on the final &quot;
            &quot;destination %s (in server root dir %s): %s&quot;,
            tmpfile,
            filename,
            cwdp ? cwdp : &quot;unknown&quot;,
            strerror(errno));
        unlink(tmpfile);
        stopSaving(0);
        return C_ERR;
    &#125;

    &#x2F;&#x2F; 打印日志  数据库数据已经保存到磁盘 
    serverLog(LL_NOTICE,&quot;DB saved on disk&quot;);
    &#x2F;&#x2F; 更新
    server.dirty &#x3D; 0;
    &#x2F;&#x2F; 更新上次保存时间
    server.lastsave &#x3D; time(NULL);
    &#x2F;&#x2F; 更新上次保存状态
    server.lastbgsave_status &#x3D; C_OK;
    &#x2F;&#x2F; 停止保存 发布事件
    stopSaving(1);
    return C_OK;

werr:
    serverLog(LL_WARNING,&quot;Write error saving DB on disk: %s&quot;, strerror(errno));
    &#x2F;&#x2F; 关闭文件
    if (fp) fclose(fp);
    &#x2F;&#x2F; 删除缓存文件
    unlink(tmpfile);
    &#x2F;&#x2F; 停止保存 发布事件
    stopSaving(0);
    return C_ERR;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  Redis保存RDB文件的代码确实不错，在使用资源前校验资源的合法性，使用后确保数据都保存到磁盘，还通过重命名确认保存成功，并且在完后后货失败后释放对应资源。  </p>
<p>  虽然很细节很简单，但是很健壮。</p>
<br>


<h3 id="4-1-2-异步保存-rdbSaveBackground"><a href="#4-1-2-异步保存-rdbSaveBackground" class="headerlink" title="(4.1.2) 异步保存-rdbSaveBackground"></a>(4.1.2) 异步保存-rdbSaveBackground</h3><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;*
 * 
 * @param *filename 文件名
 * @param *rsi 
 *&#x2F;
int rdbSaveBackground(char *filename, rdbSaveInfo *rsi) &#123;
    pid_t childpid;

    &#x2F;&#x2F; 有活跃的子进程 
    if (hasActiveChildProcess()) return C_ERR;

    &#x2F;&#x2F;  
    server.dirty_before_bgsave &#x3D; server.dirty;
    &#x2F;&#x2F;
    server.lastbgsave_try &#x3D; time(NULL);
    &#x2F;&#x2F; 打开子
    openChildInfoPipe();

    &#x2F;&#x2F; 复制进程
    if ((childpid &#x3D; redisFork(CHILD_TYPE_RDB)) &#x3D;&#x3D; 0) &#123;  &#x2F;&#x2F; 
        int retval;

        &#x2F;&#x2F; 子进程设置调用名称
        redisSetProcTitle(&quot;redis-rdb-bgsave&quot;);
        &#x2F;&#x2F; 设置 bgsave子进程的cpu关联列表
        redisSetCpuAffinity(server.bgsave_cpulist);
        &#x2F;&#x2F; 在子进程里调用 rdbSave() 同步保存 
        retval &#x3D; rdbSave(filename,rsi);
        if (retval &#x3D;&#x3D; C_OK) &#123;
            &#x2F;&#x2F; 发送子进程写时复制(Copy On Write)信息 
            sendChildCOWInfo(CHILD_TYPE_RDB, &quot;RDB&quot;);
        &#125;
        &#x2F;&#x2F; 退出子进程
        exitFromChild((retval &#x3D;&#x3D; C_OK) ? 0 : 1);
    &#125; else &#123;
        &#x2F;* Parent *&#x2F;
        if (childpid &#x3D;&#x3D; -1) &#123;
            &#x2F;&#x2F; 关闭 
            closeChildInfoPipe();
            &#x2F;&#x2F; 后台保存状态错误
            server.lastbgsave_status &#x3D; C_ERR;
            &#x2F;&#x2F; 不能后台保存  子进程复制出错
            serverLog(LL_WARNING,&quot;Can&#39;t save in background: fork: %s&quot;,
                strerror(errno));
            return C_ERR;
        &#125;

        &#x2F;&#x2F; 
        serverLog(LL_NOTICE,&quot;Background saving started by pid %d&quot;,childpid);
        server.rdb_save_time_start &#x3D; time(NULL);
        server.rdb_child_pid &#x3D; childpid;
        server.rdb_child_type &#x3D; RDB_CHILD_TYPE_DISK;
        updateDictResizePolicy();
        return C_OK;
    &#125;
    return C_OK; &#x2F;* unreached *&#x2F;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4-1-3-主从同步生成RDB-rdbSaveToSlavesSockets"><a href="#4-1-3-主从同步生成RDB-rdbSaveToSlavesSockets" class="headerlink" title="(4.1.3) 主从同步生成RDB-rdbSaveToSlavesSockets"></a>(4.1.3) 主从同步生成RDB-rdbSaveToSlavesSockets</h3><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* 
 * 生成一个 RDB 子进程，它将 RDB 写入当前处于 SLAVE_STATE_WAIT_BGSAVE_START 状态的从属 sockets。
 *&#x2F;
int rdbSaveToSlavesSockets(rdbSaveInfo *rsi) &#123;

    listNode *ln;
    listIter li;
    pid_t childpid;
    int pipefds[2], rdb_pipe_write, safe_to_exit_pipe;

    &#x2F;&#x2F; 有活跃子进程 
    if (hasActiveChildProcess()) return C_ERR;

    &#x2F;&#x2F; 即使之前的fork子进程退出了，在我们排干管道之前不要开一个新的。
    if (server.rdb_pipe_conns) return C_ERR;

    &#x2F;* Before to fork, create a pipe that is used to transfer the rdb bytes to
     * the parent, we can&#39;t let it write directly to the sockets, since in case
     * of TLS we must let the parent handle a continuous TLS state when the
     * child terminates and parent takes over. *&#x2F;
    if (pipe(pipefds) &#x3D;&#x3D; -1) return C_ERR;
    &#x2F;&#x2F; 
    server.rdb_pipe_read &#x3D; pipefds[0]; &#x2F;* read end *&#x2F;
    &#x2F;&#x2F; 
    rdb_pipe_write &#x3D; pipefds[1]; &#x2F;* write end *&#x2F;
    &#x2F;&#x2F; 
    anetNonBlock(NULL, server.rdb_pipe_read);

    &#x2F;&#x2F; 创建另一个管道，父进程使用该管道向子进程发出可以退出的信号。 
    if (pipe(pipefds) &#x3D;&#x3D; -1) &#123;
        &#x2F;&#x2F; 关闭rdb管道写操作 
        close(rdb_pipe_write);
        &#x2F;&#x2F; 关闭rdb管道读
        close(server.rdb_pipe_read);
        return C_ERR;
    &#125;
    safe_to_exit_pipe &#x3D; pipefds[0]; &#x2F;* read end *&#x2F;
    server.rdb_child_exit_pipe &#x3D; pipefds[1]; &#x2F;* write end *&#x2F;

    &#x2F;&#x2F; 收集我们要将 RDB 传输到的 从节点 的连接，这些从节点处于 WAIT_BGSAVE_START 状态。 
    &#x2F;&#x2F; 创建 connection数组  长度&#x3D;从节点个数
    server.rdb_pipe_conns &#x3D; zmalloc(sizeof(connection *)*listLength(server.slaves));
    server.rdb_pipe_numconns &#x3D; 0;
    server.rdb_pipe_numconns_writing &#x3D; 0;
    &#x2F;&#x2F; 链表迭代器 
    listRewind(server.slaves,&amp;li);
    &#x2F;&#x2F; 遍历链表
    while((ln &#x3D; listNext(&amp;li))) &#123;
        &#x2F;&#x2F; 从节点 
        client *slave &#x3D; ln-&gt;value;
        if (slave-&gt;replstate &#x3D;&#x3D; SLAVE_STATE_WAIT_BGSAVE_START) &#123; &#x2F;&#x2F; 
            &#x2F;&#x2F; 连接赋值
            server.rdb_pipe_conns[server.rdb_pipe_numconns++] &#x3D; slave-&gt;conn;
            &#x2F;&#x2F; 发送 FULLRESYNC 回复
            replicationSetupSlaveForFullResync(slave,getPsyncInitialOffset());
        &#125;
    &#125;

    &#x2F;&#x2F; 创建父子进程通信管道
    openChildInfoPipe();
    &#x2F;&#x2F; 创建子进程
    if ((childpid &#x3D; redisFork(CHILD_TYPE_RDB)) &#x3D;&#x3D; 0) &#123;
        &#x2F;* Child *&#x2F;
        int retval, dummy;
        rio rdb;

        rioInitWithFd(&amp;rdb,rdb_pipe_write);

        &#x2F;&#x2F; 设置进程名称  
        redisSetProcTitle(&quot;redis-rdb-to-slaves&quot;);
        &#x2F;&#x2F; 设置 子进程的cpu关联列表
        redisSetCpuAffinity(server.bgsave_cpulist);

        &#x2F;&#x2F; 写RDB数据
        retval &#x3D; rdbSaveRioWithEOFMark(&amp;rdb,NULL,rsi);
        if (retval &#x3D;&#x3D; C_OK &amp;&amp; rioFlush(&amp;rdb) &#x3D;&#x3D; 0)
            retval &#x3D; C_ERR;

        if (retval &#x3D;&#x3D; C_OK) &#123;
            &#x2F;&#x2F; 发送子进程写时复制信息 
            sendChildCOWInfo(CHILD_TYPE_RDB, &quot;RDB&quot;);
        &#125;

        &#x2F;&#x2F;   
        rioFreeFd(&amp;rdb);
        &#x2F;&#x2F; 关闭rdb写管道    &#x2F;&#x2F; 唤醒读取着，告诉他们我们已经完成 
        close(rdb_pipe_write);
        &#x2F;&#x2F; 关闭rdb子进程退出管道    &#x2F;&#x2F; 关闭写结束，以便我们可以检测到父级的关闭。
        close(server.rdb_child_exit_pipe); 
        &#x2F;&#x2F; 等待退出直到父进程告诉我们它是安全的。 我们不期望读取任何内容，只是在管道关闭时收到错误。 
        dummy &#x3D; read(safe_to_exit_pipe, pipefds, 1);
        &#x2F;&#x2F; 
        UNUSED(dummy);
        &#x2F;&#x2F; 退出子进程
        exitFromChild((retval &#x3D;&#x3D; C_OK) ? 0 : 1);
    &#125; else &#123;
        &#x2F;* Parent *&#x2F;
        close(safe_to_exit_pipe);
        if (childpid &#x3D;&#x3D; -1) &#123;
            &#x2F;&#x2F; 打日志  不能后台保存 fork错误 
            serverLog(LL_WARNING,&quot;Can&#39;t save in background: fork: %s&quot;,
                strerror(errno));

            &#x2F;* Undo the state change. The caller will perform cleanup on
             * all the slaves in BGSAVE_START state, but an early call to
             * replicationSetupSlaveForFullResync() turned it into BGSAVE_END *&#x2F;
            &#x2F;&#x2F;  
            listRewind(server.slaves,&amp;li);
            while((ln &#x3D; listNext(&amp;li))) &#123;
                client *slave &#x3D; ln-&gt;value;
                if (slave-&gt;replstate &#x3D;&#x3D; SLAVE_STATE_WAIT_BGSAVE_END) &#123;
                    slave-&gt;replstate &#x3D; SLAVE_STATE_WAIT_BGSAVE_START;
                &#125;
            &#125;
            &#x2F;&#x2F; 关闭 rdb写管道
            close(rdb_pipe_write);
            &#x2F;&#x2F; 
            close(server.rdb_pipe_read);
            &#x2F;&#x2F; 释放内存
            zfree(server.rdb_pipe_conns);
            server.rdb_pipe_conns &#x3D; NULL;
            server.rdb_pipe_numconns &#x3D; 0;
            server.rdb_pipe_numconns_writing &#x3D; 0;
            &#x2F;&#x2F; 
            closeChildInfoPipe();
        &#125; else &#123;
            serverLog(LL_NOTICE,&quot;Background RDB transfer started by pid %d&quot;,
                childpid);
            server.rdb_save_time_start &#x3D; time(NULL);
            server.rdb_child_pid &#x3D; childpid;
            server.rdb_child_type &#x3D; RDB_CHILD_TYPE_SOCKET;
            updateDictResizePolicy();
            &#x2F;&#x2F; 在父进程关闭rdb写管道，以便它可以检测到孩子的关闭。
            close(rdb_pipe_write);
            &#x2F;&#x2F; 创建文件事件  设置回调函数 rdbPipeReadHandler
            if (aeCreateFileEvent(server.el, server.rdb_pipe_read, AE_READABLE, rdbPipeReadHandler,NULL) &#x3D;&#x3D; AE_ERR) &#123;
                serverPanic(&quot;Unrecoverable error creating server.rdb_pipe_read file event.&quot;);
            &#125;
        &#125;
        return (childpid &#x3D;&#x3D; -1) ? C_ERR : C_OK;
    &#125;
    return C_OK; &#x2F;* Unreached. *&#x2F;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>



<h2 id="4-2-RDB文件如何生成"><a href="#4-2-RDB文件如何生成" class="headerlink" title="(4.2) RDB文件如何生成"></a>(4.2) RDB文件如何生成</h2><p>  生成RDB文件的主要逻辑在<code>rdbSaveRio</code>函数</p>
<p>  <img data-src="/img/database/redis/persistence/rdb/redis-rdb-overview.png" alt="Redis RDB数据格式"></p>
<p>  主要步骤如下：</p>
<ol>
<li>保存元数据信息，比如<code>魔数</code>、<code>属性信息</code> (类似RPC序列化里的)</li>
<li>保存所有数据库字典里的<code>键值对</code>(包括内存淘汰策略、过期时间)</li>
<li>保存<code>结束符</code>、<code>校验和</code> 等。</li>
</ol>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* 
 * 生成 RDB 格式的数据库转储，将其发送到指定的 Redis I&#x2F;O 通道。 
 * 成功时返回 C_OK，否则返回 C_ERR，并且由于I&#x2F;O错误可能会丢失部分输出或全部输出。
 *
 * 当函数返回 C_ERR 并且如果 &#39;error&#39; 不为 NULL 时，
 * &#39;error&#39; 指向的整数将设置为紧接在 I&#x2F;O 错误之后的 errno 的值。
 *
 * @param *rdb
 * @param *error
 * @param rdbflags
 * @param *rsi
 *&#x2F;
int rdbSaveRio(rio *rdb, int *error, int rdbflags, rdbSaveInfo *rsi) &#123;
    dictIterator *di &#x3D; NULL;
    dictEntry *de;
    char magic[10];
    int j;
    uint64_t cksum;
    size_t processed &#x3D; 0;

    if (server.rdb_checksum)
        rdb-&gt;update_cksum &#x3D; rioGenericUpdateChecksum;

    &#x2F;&#x2F; 生成魔数magic    
    snprintf(magic,sizeof(magic),&quot;REDIS%04d&quot;,RDB_VERSION);
    &#x2F;&#x2F; 将magic写入RDB文件
    if (rdbWriteRaw(rdb,magic,9) &#x3D;&#x3D; -1) goto werr;

    &#x2F;&#x2F; 写入属性信息
    if (rdbSaveInfoAuxFields(rdb,rdbflags,rsi) &#x3D;&#x3D; -1) goto werr;

    &#x2F;&#x2F; 写入 信息
    if (rdbSaveModulesAux(rdb, REDISMODULE_AUX_BEFORE_RDB) &#x3D;&#x3D; -1) goto werr;

    &#x2F;&#x2F;  
    for (j &#x3D; 0; j &lt; server.dbnum; j++) &#123;
        &#x2F;&#x2F; 获取redisDb 
        redisDb *db &#x3D; server.db+j;
        &#x2F;&#x2F; 字典
        dict *d &#x3D; db-&gt;dict;
        &#x2F;&#x2F; 字典为空 跳过
        if (dictSize(d) &#x3D;&#x3D; 0) continue;
        &#x2F;&#x2F; 迭代器
        di &#x3D; dictGetSafeIterator(d);


        &#x2F;&#x2F; 写 SELECT DB 操作符  &#x2F;&#x2F; 解决数据一致性问题  避免从节点写到其它库里
        if (rdbSaveType(rdb,RDB_OPCODE_SELECTDB) &#x3D;&#x3D; -1) goto werr;
        &#x2F;&#x2F; 保存编码长度 
        if (rdbSaveLen(rdb,j) &#x3D;&#x3D; -1) goto werr;

        &#x2F;* Write the RESIZE DB opcode. *&#x2F;
        uint64_t db_size, expires_size;
        &#x2F;&#x2F; 数据个数
        db_size &#x3D; dictSize(db-&gt;dict);
        &#x2F;&#x2F; 过期数据个数
        expires_size &#x3D; dictSize(db-&gt;expires);
        &#x2F;&#x2F; 
        if (rdbSaveType(rdb,RDB_OPCODE_RESIZEDB) &#x3D;&#x3D; -1) goto werr;
        &#x2F;&#x2F; 
        if (rdbSaveLen(rdb,db_size) &#x3D;&#x3D; -1) goto werr;
        &#x2F;&#x2F; 
        if (rdbSaveLen(rdb,expires_size) &#x3D;&#x3D; -1) goto werr;

        &#x2F;&#x2F; 遍历DB里的每个entry 
        while((de &#x3D; dictNext(di)) !&#x3D; NULL) &#123;
            &#x2F;&#x2F; 获取key  二进制安全的key
            sds keystr &#x3D; dictGetKey(de);
            &#x2F;&#x2F; 
            robj key, *o &#x3D; dictGetVal(de);
            long long expire;

            &#x2F;&#x2F; 初始化key的状态
            initStaticStringObject(key,keystr);
            &#x2F;&#x2F; 获取key的过期时间
            expire &#x3D; getExpire(db,&amp;key);
            &#x2F;&#x2F; 保存键值对
            if (rdbSaveKeyValuePair(rdb,&amp;key,o,expire) &#x3D;&#x3D; -1) goto werr;


            &#x2F;&#x2F; 当此RDB作为AOF重写的一部分生成时，在重写时将累积的差异从父级移动到子级，以便最终写入更小。 

            if (rdbflags &amp; RDBFLAGS_AOF_PREAMBLE &amp;&amp;
                rdb-&gt;processed_bytes &gt; processed+AOF_READ_DIFF_INTERVAL_BYTES)
            &#123;
                &#x2F;&#x2F;  
                processed &#x3D; rdb-&gt;processed_bytes;
                &#x2F;&#x2F; 
                aofReadDiffFromParent();
            &#125;
        &#125;
        &#x2F;&#x2F; 
        dictReleaseIterator(di);
        di &#x3D; NULL;  &#x2F;&#x2F; 这样我们就不会因为错误而再次发布它。 
    &#125;

    &#x2F;* If we are storing the replication information on disk, persist
     * the script cache as well: on successful PSYNC after a restart, we need
     * to be able to process any EVALSHA inside the replication backlog the
     * master will send us. *&#x2F;
    if (rsi &amp;&amp; dictSize(server.lua_scripts)) &#123;
        &#x2F;&#x2F; 
        di &#x3D; dictGetIterator(server.lua_scripts);
        &#x2F;&#x2F; 遍历
        while((de &#x3D; dictNext(di)) !&#x3D; NULL) &#123;
            &#x2F;&#x2F;  
            robj *body &#x3D; dictGetVal(de);
            &#x2F;&#x2F; 
            if (rdbSaveAuxField(rdb,&quot;lua&quot;,3,body-&gt;ptr,sdslen(body-&gt;ptr)) &#x3D;&#x3D; -1)
                goto werr;
        &#125;
        &#x2F;&#x2F; 
        dictReleaseIterator(di);
        di &#x3D; NULL;  &#x2F;&#x2F; 这样我们就不会因为错误而再次发布它。 
    &#125;

    &#x2F;&#x2F;  
    if (rdbSaveModulesAux(rdb, REDISMODULE_AUX_AFTER_RDB) &#x3D;&#x3D; -1) goto werr;

    &#x2F;&#x2F; 保存RDB文件结束符
    if (rdbSaveType(rdb,RDB_OPCODE_EOF) &#x3D;&#x3D; -1) goto werr;

    &#x2F;&#x2F; CRC64 校验和。 如果禁用校验和计算，它将为零，在这种情况下加载代码会跳过检查。
    cksum &#x3D; rdb-&gt;cksum;
    &#x2F;&#x2F; 小端编码
    memrev64ifbe(&amp;cksum);
    &#x2F;&#x2F; 写入校验和
    if (rioWrite(rdb,&amp;cksum,8) &#x3D;&#x3D; 0) goto werr;
    return C_OK;

werr:
    if (error) *error &#x3D; errno;
    if (di) dictReleaseIterator(di);
    return C_ERR;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/rdb.h</span>

<span class="token comment">/* Special RDB opcodes (saved/loaded with rdbSaveType/rdbLoadType). */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_MODULE_AUX</span> <span class="token expression"><span class="token number">247</span>   </span><span class="token comment">/* Module auxiliary data. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_IDLE</span>       <span class="token expression"><span class="token number">248</span>   </span><span class="token comment">/* LRU idle time. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_FREQ</span>       <span class="token expression"><span class="token number">249</span>   </span><span class="token comment">/* LFU frequency. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_AUX</span>        <span class="token expression"><span class="token number">250</span>   </span><span class="token comment">/* RDB aux field. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_RESIZEDB</span>   <span class="token expression"><span class="token number">251</span>   </span><span class="token comment">/* Hash table resize hint. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_EXPIRETIME_MS</span> <span class="token expression"><span class="token number">252</span>    </span><span class="token comment">/* Expire time in milliseconds. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_EXPIRETIME</span> <span class="token expression"><span class="token number">253</span>       </span><span class="token comment">/* Old expire time in seconds. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_SELECTDB</span>   <span class="token expression"><span class="token number">254</span>   </span><span class="token comment">/* DB number of the following keys. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_EOF</span>        <span class="token expression"><span class="token number">255</span>   </span><span class="token comment">/* End of the RDB file. */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* 
 * 保存一些默认的 AUX 字段，其中包含有关生成的 RDB 的信息。
 *&#x2F;
int rdbSaveInfoAuxFields(rio *rdb, int rdbflags, rdbSaveInfo *rsi) &#123;
    &#x2F;&#x2F;  
    int redis_bits &#x3D; (sizeof(void*) &#x3D;&#x3D; 8) ? 64 : 32;
    &#x2F;&#x2F; 
    int aof_preamble &#x3D; (rdbflags &amp; RDBFLAGS_AOF_PREAMBLE) !&#x3D; 0;

    &#x2F;&#x2F; 在创建 RDB 时添加一些关于状态的字段。

    &#x2F;&#x2F; 保存 Redis版本信息
    if (rdbSaveAuxFieldStrStr(rdb,&quot;redis-ver&quot;,REDIS_VERSION) &#x3D;&#x3D; -1) return -1;
    &#x2F;&#x2F; 保存 Redis运行平台的架构信息 (32位还是64位) 
    if (rdbSaveAuxFieldStrInt(rdb,&quot;redis-bits&quot;,redis_bits) &#x3D;&#x3D; -1) return -1;
    &#x2F;&#x2F; 保存 RDB文件的创建时间
    if (rdbSaveAuxFieldStrInt(rdb,&quot;ctime&quot;,time(NULL)) &#x3D;&#x3D; -1) return -1;
    &#x2F;&#x2F; 保存 Redis Server已使用的内存空间大小
    if (rdbSaveAuxFieldStrInt(rdb,&quot;used-mem&quot;,zmalloc_used_memory()) &#x3D;&#x3D; -1) return -1;

    &#x2F;* Handle saving options that generate aux fields. *&#x2F;
    if (rsi) &#123;
        &#x2F;&#x2F; 保存  
        if (rdbSaveAuxFieldStrInt(rdb,&quot;repl-stream-db&quot;,rsi-&gt;repl_stream_db)
            &#x3D;&#x3D; -1) return -1;

        &#x2F;&#x2F; 保存 复制id &#x3D; Redis Server 的 server.replid
        if (rdbSaveAuxFieldStrStr(rdb,&quot;repl-id&quot;,server.replid)
            &#x3D;&#x3D; -1) return -1;

        &#x2F;&#x2F; 保存 复制偏移量 &#x3D; 主节点的复制偏移量  
        if (rdbSaveAuxFieldStrInt(rdb,&quot;repl-offset&quot;,server.master_repl_offset)
            &#x3D;&#x3D; -1) return -1;
    &#125;

    &#x2F;&#x2F; 保存 aof-preamble
    if (rdbSaveAuxFieldStrInt(rdb,&quot;aof-preamble&quot;,aof_preamble) &#x3D;&#x3D; -1) return -1;
    return 1;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;&#x2F; file: src&#x2F;rdb.c

&#x2F;* 
 * 保存键值对
 * 
 * 保存键值对，带过期时间、类型、键、值 
 * 错误时返回-1
 * 如果key实际保存成功，则返回1，否则返回0(key已过期)。
 * 
 * @param *rdb 
 * @param *key 
 * @param *val
 * @param expiretime
 *&#x2F;
int rdbSaveKeyValuePair(rio *rdb, robj *key, robj *val, long long expiretime) &#123;
    &#x2F;&#x2F; 内存淘汰策略
    int savelru &#x3D; server.maxmemory_policy &amp; MAXMEMORY_FLAG_LRU;
    int savelfu &#x3D; server.maxmemory_policy &amp; MAXMEMORY_FLAG_LFU;

    &#x2F;&#x2F; 过期时间
    if (expiretime !&#x3D; -1) &#123;  &#x2F;&#x2F; key是会过期的
        &#x2F;&#x2F; 保存过期时间类型(ms)
        if (rdbSaveType(rdb,RDB_OPCODE_EXPIRETIME_MS) &#x3D;&#x3D; -1) return -1;
        &#x2F;&#x2F; 保存过期时间(ms级)
        if (rdbSaveMillisecondTime(rdb,expiretime) &#x3D;&#x3D; -1) return -1;
    &#125;

    &#x2F;&#x2F; 保存LRU信息
    if (savelru) &#123;  &#x2F;&#x2F; 如果使用lru
        &#x2F;&#x2F; 对象空闲时间  ms
        uint64_t idletime &#x3D; estimateObjectIdleTime(val);
        idletime &#x2F;&#x3D; 1000; &#x2F;&#x2F; 使用秒就足够了，而且需要的空间更少。 
        &#x2F;&#x2F; 保存类型为LRU空闲时间
        if (rdbSaveType(rdb,RDB_OPCODE_IDLE) &#x3D;&#x3D; -1) return -1;
        &#x2F;&#x2F; 保存对象空间时间 (秒级)
        if (rdbSaveLen(rdb,idletime) &#x3D;&#x3D; -1) return -1;
    &#125;

    &#x2F;&#x2F; 保存LFU信息
    if (savelfu) &#123;
        uint8_t buf[1];
        &#x2F;&#x2F; 
        buf[0] &#x3D; LFUDecrAndReturn(val);

        &#x2F;&#x2F; 我们可以用两个字节对其进行编码：操作码和一个8位计数器，因为频率是 0-255 范围内的对数。
        &#x2F;&#x2F; 请注意，我们不存储减半时间，因为在加载时将其重置一次不会对频率产生太大影响。  

        &#x2F;&#x2F; 保存类型为LFU
        if (rdbSaveType(rdb,RDB_OPCODE_FREQ) &#x3D;&#x3D; -1) return -1;
        &#x2F;&#x2F; 保存LFU信息
        if (rdbWriteRaw(rdb,buf,1) &#x3D;&#x3D; -1) return -1;
    &#125;


    &#x2F;&#x2F; 保存类型
    if (rdbSaveObjectType(rdb,val) &#x3D;&#x3D; -1) return -1;
    &#x2F;&#x2F; 保存key
    if (rdbSaveStringObject(rdb,key) &#x3D;&#x3D; -1) return -1;
    &#x2F;&#x2F; 保存value
    if (rdbSaveObject(rdb,val,key) &#x3D;&#x3D; -1) return -1;

    &#x2F;&#x2F; 如果需要延迟返回（用于测试）
    if (server.rdb_key_save_delay)
        usleep(server.rdb_key_save_delay);

    return 1;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="4-2-1-写入数据-rdbWriteRaw"><a href="#4-2-1-写入数据-rdbWriteRaw" class="headerlink" title="(4.2.1) 写入数据-rdbWriteRaw"></a>(4.2.1) 写入数据-rdbWriteRaw</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">rdbWriteRaw</span><span class="token punctuation">(</span>rio <span class="token operator">*</span>rdb<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rdb <span class="token operator">&amp;&amp;</span> <span class="token function">rioWrite</span><span class="token punctuation">(</span>rdb<span class="token punctuation">,</span>p<span class="token punctuation">,</span>len<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/io.h</span>

<span class="token comment">/*
 * 
 * @param *r 
 * @param *buf 要写入的数据
 * @param len 数据长度
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token class-name">size_t</span> <span class="token function">rioWrite</span><span class="token punctuation">(</span>rio <span class="token operator">*</span>r<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>flags <span class="token operator">&amp;</span> RIO_FLAG_WRITE_ERROR<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 长度大于-0</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 要写入的字节数 </span>
        <span class="token class-name">size_t</span> bytes_to_write <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>max_processing_chunk <span class="token operator">&amp;&amp;</span> r<span class="token operator">-></span>max_processing_chunk <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token operator">-></span>max_processing_chunk <span class="token operator">:</span> len<span class="token punctuation">;</span>
        <span class="token comment">// 更新校验和</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>update_cksum<span class="token punctuation">)</span> r<span class="token operator">-></span><span class="token function">update_cksum</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>bytes_to_write<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 写入数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>bytes_to_write<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            r<span class="token operator">-></span>flags <span class="token operator">|=</span> RIO_FLAG_WRITE_ERROR<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//</span>
        buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf <span class="token operator">+</span> bytes_to_write<span class="token punctuation">;</span>
        <span class="token comment">// 更新要写入的长度</span>
        len <span class="token operator">-=</span> bytes_to_write<span class="token punctuation">;</span>
        <span class="token comment">// </span>
        r<span class="token operator">-></span>processed_bytes <span class="token operator">+=</span> bytes_to_write<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/415563">Redis 源码剖析与实战 - 18 | 如何生成和解读RDB文件？</a><br>[2] <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/6.0/src/rdb.c">redis-rdb.c - github</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/08/redis-io-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/08/redis-io-model/" class="post-title-link" itemprop="url">Redis IO模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-08 08:56:06" itemprop="dateCreated datePublished" datetime="2022-01-08T08:56:06+08:00">2022-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-26 16:03:40" itemprop="dateModified" datetime="2023-02-26T16:03:40+08:00">2023-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/01/08/redis-io-model/" class="post-meta-item leancloud_visitors" data-flag-title="Redis IO模型" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/08/redis-io-model/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/08/redis-io-model/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>24 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  RedisIO模型</p>
<p>  Redis服务器端单线程可以达到每秒可以达到数万QPS的处理能力。如此高性能的其中一个原因就是运用了Linux提供的IO多路复用机制epoll。</p>
<p>  <img src="/img/database/redis/io-model/linux-io-multiplexing-epoll.png" alt="IO模型"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/01/08/redis-io-model/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/02/redis-index-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/02/redis-index-model/" class="post-title-link" itemprop="url">Redis索引模型-Redis是怎么根据key查找到对应value的？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-02 19:49:01" itemprop="dateCreated datePublished" datetime="2022-01-02T19:49:01+08:00">2022-01-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-13 08:51:58" itemprop="dateModified" datetime="2023-07-13T08:51:58+08:00">2023-07-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/01/02/redis-index-model/" class="post-meta-item leancloud_visitors" data-flag-title="Redis索引模型-Redis是怎么根据key查找到对应value的？" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/02/redis-index-model/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/02/redis-index-model/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-redis整体存储结构"><a href="#1-redis整体存储结构" class="headerlink" title="(1) redis整体存储结构"></a>(1) redis整体存储结构</h1><p>  <img src="/img/database/redis/index-model/redis-index-model.png" alt="redis索引模型"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/01/02/redis-index-model/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/01/redis-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/01/redis-design/" class="post-title-link" itemprop="url">Redis架构学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-01 15:11:34" itemprop="dateCreated datePublished" datetime="2022-01-01T15:11:34+08:00">2022-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-05 22:18:34" itemprop="dateModified" datetime="2023-02-05T22:18:34+08:00">2023-02-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/01/01/redis-design/" class="post-meta-item leancloud_visitors" data-flag-title="Redis架构学习" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/01/redis-design/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/01/redis-design/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>455</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>　在平时学习过很多Redis的知识点，解决过很多问题，但是感觉整体比较零散。为了比较系统、完整的了解Redis，总结出一篇博客，方便自己和大家了解。</p>
<p>　在看内容之前，先问大家一个问题，在使用redis get命令和set命令时，大家知道Redis是怎么执行的，涉及到哪些模块吗？</p>
<h1 id="1-Redis架构"><a href="#1-Redis架构" class="headerlink" title="(1)　Redis架构"></a>(1)　Redis架构</h1><p>　<img src="/file/redis/design/redis-design.png" alt="Redis架构"></p>
<p>Redis系统架构主要包含 事件处理、数据管理、功能扩展、系统扩展等内容。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/01/01/redis-design/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2021/11/20/go-mutex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/20/go-mutex/" class="post-title-link" itemprop="url">go语言 互斥锁 sync.Mutex</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-20 08:44:37" itemprop="dateCreated datePublished" datetime="2021-11-20T08:44:37+08:00">2021-11-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-11-26 16:13:33" itemprop="dateModified" datetime="2022-11-26T16:13:33+08:00">2022-11-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/basic/" itemprop="url" rel="index"><span itemprop="name">basic</span></a>
                </span>
            </span>

          
            <span id="/2021/11/20/go-mutex/" class="post-meta-item leancloud_visitors" data-flag-title="go语言 互斥锁 sync.Mutex" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/11/20/go-mutex/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/11/20/go-mutex/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>　　相比于 Go 语言宣扬的“用通讯的方式共享数据”，通过共享数据的方式来传递信息和协调线程运行的做法其实更加主流，毕竟大多数的现代编程语言，都是用后一种方式作为并发编程的解决方案的。<br>　　我们来了解一下go中的互斥锁sync.Mutex</p>
<h1 id="1-sync-Mutex是什么"><a href="#1-sync-Mutex是什么" class="headerlink" title="(1)　sync.Mutex是什么"></a>(1)　sync.Mutex是什么</h1><p>　　sync.Mutex是go语言里的一种互斥锁，是保证同步的一种工具。<br>　　类似生活中去医院看病时挂号等医生叫号的过程，有很多患者挂号(协程)，只有一个医生(资源)，被叫号的患者(拿到锁)可以到诊室里让医生看病。看完病离开诊室(释放锁)。</p>
<br>


<h1 id="2-为什么要用sync-Mutex"><a href="#2-为什么要用sync-Mutex" class="headerlink" title="(2)　为什么要用sync.Mutex"></a>(2)　为什么要用sync.Mutex</h1><p>  先看一个例子</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"sync"</span>

<span class="token keyword">var</span> sum <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>Mutex

<span class="token comment">// 开10个协程并发执行1000次 sum++</span>
<span class="token comment">// 如果不加 mu.lock() mu.unlock() 最后的结果不是10000 一般会小于10000</span>
<span class="token comment">// 把 // mu.lock() // mu.unlock() 前面的注释删除，结果就是10000</span>
<span class="token comment">// 这个是缓存导致的可见性问题。</span>
<span class="token comment">// 具体原因是因为sum++不是原子操作，CPU分2条指令执行，CPU执行第2条指令时获取到的缓存sum值和主内存sum值不一致导致</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	<span class="token comment">// fatal error: sync: unlock of unlocked mutex</span>
	<span class="token comment">// // mu.Unlock()</span>

	<span class="token comment">// 开10个协程并发执行1000次 sum=sum+1</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">funcAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// 等所有协程执行完</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"result:"</span><span class="token punctuation">,</span> sum<span class="token punctuation">)</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">funcAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 对sum加锁</span>
		<span class="token comment">//mu.Lock()</span>
		sum<span class="token operator">++</span>
		<span class="token comment">// 对sum解锁</span>
		<span class="token comment">//mu.Unlock()</span>
		<span class="token comment">//println("result=", sum)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// 没有下面这一行代码 提示 fatal error: all goroutines are asleep - deadlock!</span>
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的代码主要功能是开10个协程并发执行1000次 sum++，并打印结果，可以自己执行一下，会发现执行的结果&lt;10000。<br>把第33行 36行前的注释删掉，程序执行的结果就是结果就是10000</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/11/20/go-mutex/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">312</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



<script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5rcgvdncuwu&amp;m=7&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>


      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>




  <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-firestore.js"></script>
  <script>
    firebase.initializeApp({
      apiKey   : 'AIzaSyAvOJeiZUMxRcERhV-fROleWDW_X-WnaVs',
      projectId: 'blog-928ff'
    });

    function getCount(doc, increaseCount) {
      // IncreaseCount will be false when not in article page
      return doc.get().then(d => {
        var count = 0;
        if (!d.exists) { // Has no data, initialize count
          if (increaseCount) {
            doc.set({
              count: 1
            });
            count = 1;
          }
        } else { // Has data
          count = d.data().count;
          if (increaseCount) {
            // If first view this article
            doc.set({ // Increase count
              count: count + 1
            });
            count++;
          }
        }

        return count;
      });
    }

    function appendCountTo(el) {
      return count => {
        el.innerText = count;
      }
    }
  </script>
  <script>
    (function() {
      var db = firebase.firestore();
      var articles = db.collection('articles');

      if (CONFIG.page.isPost) { // Is article page
        var title = document.querySelector('.post-title').innerText.trim();
        var doc = articles.doc(title);
        var increaseCount = CONFIG.hostname === location.hostname;
        if (localStorage.getItem(title)) {
          increaseCount = false;
        } else {
          // Mark as visited
          localStorage.setItem(title, true);
        }
        getCount(doc, increaseCount).then(appendCountTo(document.querySelector('.firestore-visitors-count')));
      } else if (CONFIG.page.isHome) { // Is index page
        var promises = [...document.querySelectorAll('.post-title')].map(element => {
          var title = element.innerText.trim();
          var doc = articles.doc(title);
          return getCount(doc);
        });
        Promise.all(promises).then(counts => {
          var metas = document.querySelectorAll('.firestore-visitors-count');
          counts.forEach((val, idx) => {
            appendCountTo(metas[idx])(val);
          });
        });
      }
    })();
  </script>




      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'Ca876j76FoCQi1SShjT0qC6k-gzGzoHsz',
      appKey     : 'IeozLmM20GuvfcslfWgdNXP0',
      placeholder: "期待您的评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
