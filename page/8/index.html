<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"weikeqin.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="不积跬步无以至千里">
<meta property="og:type" content="website">
<meta property="og:title" content="天道酬勤">
<meta property="og:url" content="http://weikeqin.com/page/8/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="不积跬步无以至千里">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="tech,Java,MySQL,Redis,ElasticSearch,DDD">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://weikeqin.com/page/8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>天道酬勤</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113485469-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-113485469-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">天道酬勤</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">304</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/u/0/107737814703120725006" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;u&#x2F;0&#x2F;107737814703120725006" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wkq278276130" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wkq278276130" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/keqin.wei.5" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;keqin.wei.5" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/8054088/wkq" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;8054088&#x2F;wkq" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/11/29/sentinel-core-process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/29/sentinel-core-process/" class="post-title-link" itemprop="url">Sentinel核心流程源码解读</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-29 17:07:07" itemprop="dateCreated datePublished" datetime="2020-11-29T17:07:07+08:00">2020-11-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-01-14 23:24:58" itemprop="dateModified" datetime="2023-01-14T23:24:58+08:00">2023-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/stability/" itemprop="url" rel="index"><span itemprop="name">stability</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>29k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>26 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  Sentinel整体架构如下<br>  <img src="/img/distributed/sentinel/sentinel-slot-chain-architecture.png" alt="Sentinel架构"><br>  图里从下往上可以看到，核心的部分包含 <code>规则(rules)</code>、 <code>处理插槽(slot)</code>、 <code>调用链路(invocation tree)</code>、 <code>集群节点(cluster node)</code>、 <code>滑动窗口(slading winodw)</code> 5部分。 </p>
<p>  Sentinel代码使用 tag 1.8.6 ，对应github链接 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/tree/1.8.6">https://github.com/alibaba/Sentinel/tree/1.8.6</a> </p>
<h1 id="1-核心流程源码解读"><a href="#1-核心流程源码解读" class="headerlink" title="(1) 核心流程源码解读"></a>(1) 核心流程源码解读</h1><p>  核心源码包含以下几个部分<br>  1.规则(rules)-限流规则/熔断规则<br>  2.构建功能插槽(solt)责任链<br>  3.调用链路(invocation tree)<br>  4.集群节点(cluster node)<br>  5.滑动窗口(slading winodw)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 配置规则.</span>
        <span class="token function">initFlowRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//while (true) &#123;</span>
            <span class="token comment">// 1.5.0 版本开始可以直接利用 try-with-resources 特性</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">"HelloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 被保护的逻辑</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 处理被流控的逻辑</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"blocked!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token comment">//&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initFlowRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FlowRule</span> rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">"HelloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>FLOW_GRADE_QPS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Set limit QPS to 2.</span>
        rule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// </span>
        <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="2-加载限流规则"><a href="#2-加载限流规则" class="headerlink" title="(2) 加载限流规则"></a>(2) 加载限流规则</h1><p>  资源对应限流规则</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FlowRule</span> rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rule<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">"HelloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rule<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>FLOW_GRADE_QPS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Set limit QPS to 2.</span>
rule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// </span>
<span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h1 id="3-构建功能插槽-ProcessSolt-责任链"><a href="#3-构建功能插槽-ProcessSolt-责任链" class="headerlink" title="(3) 构建功能插槽(ProcessSolt)责任链"></a>(3) 构建功能插槽(ProcessSolt)责任链</h1><p>  这块对应的代码是 <code>SlotChainProvider.newSlotChain();</code><br>  在构建功能插槽的时候使用责任链设计模式和使用SPI提高扩展性</p>
<p>  构建完的责任链类似这种<br>  <img src="/img/distributed/sentinel/slot-chain-builder.png" alt="功能插槽责任链"></p>
<p>  整体上的代码如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slotchain</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * A provider for creating slot chains via resolved slot chain builder SPI.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SlotChainProvider</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">SlotChainBuilder</span> slotChainBuilder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * The load and pick process is not thread-safe, but it's okay since the method should be only invoked
     * via &#123;@code lookProcessChain&#125; in &#123;@link com.alibaba.csp.sentinel.CtSph&#125; under lock.
     *
     * @return new created slot chain
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ProcessorSlotChain</span> <span class="token function">newSlotChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>slotChainBuilder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> slotChainBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 使用SPI构建插槽实例 </span>
        <span class="token comment">// 这块通过SPI读取配置文件加载类  </span>
        <span class="token comment">// 读取的配置文件 META-INF/services/com.alibaba.csp.sentinel.slotchain.SlotChainBuilder</span>
        <span class="token comment">// slotChainBuilder=com.alibaba.csp.sentinel.slots.DefaultSlotChainBuilder</span>
        <span class="token comment">// Resolve the slot chain builder SPI.</span>
        slotChainBuilder <span class="token operator">=</span> <span class="token class-name">SpiLoader</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">SlotChainBuilder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadFirstInstanceOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>slotChainBuilder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 不应该走到这儿  走到这儿肯定有问题</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[SlotChainProvider] Wrong state when resolving slot chain builder, using default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            slotChainBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSlotChainBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[SlotChainProvider] Global slot chain builder resolved: &#123;&#125;"</span><span class="token punctuation">,</span>
                slotChainBuilder<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 构建功能插槽责任链</span>
        <span class="token keyword">return</span> slotChainBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  这儿比较重要的方法有两个，一个是 <code>SpiLoader.of(SlotChainBuilder.class).loadFirstInstanceOrDefault()</code>，另一个是 <code>slotChainBuilder.build()</code></p>
<h2 id="3-1-构造默认的slotChainBuilder"><a href="#3-1-构造默认的slotChainBuilder" class="headerlink" title="(3.1) 构造默认的slotChainBuilder"></a>(3.1) 构造默认的slotChainBuilder</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>spi</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SpiLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * Load the first-found Provider instance,if not found, return default Provider instance
     *
     * @return Provider instance
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">S</span> <span class="token function">loadFirstInstanceOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 使用SPI读取配置文件获取全限定类目，并通过ClassLoader加载class</span>
        <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">S</span><span class="token punctuation">></span></span> clazz <span class="token operator">:</span> classList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultClass <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> clazz <span class="token operator">!=</span> defaultClass<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 实例化  newInstance </span>
        <span class="token keyword">return</span> <span class="token function">loadDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="3-2-构造ProcessorSlot责任链"><a href="#3-2-构造ProcessorSlot责任链" class="headerlink" title="(3.2) 构造ProcessorSlot责任链"></a>(3.2) 构造ProcessorSlot责任链</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots</span><span class="token punctuation">;</span>

<span class="token comment">/**
 *　默认 ProcessorSlotChain 的构建器　　
 *  
 * 
 * Builder for a default &#123;@link ProcessorSlotChain&#125;.
 *
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>isDefault <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultSlotChainBuilder</span> <span class="token keyword">implements</span> <span class="token class-name">SlotChainBuilder</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ProcessorSlotChain</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 创建默认的 DefaultProcessorSlotChain </span>
        <span class="token class-name">ProcessorSlotChain</span> chain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultProcessorSlotChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用SPI读取配置，并通过ClassLoader加载class </span>
        <span class="token comment">// 读取的配置文件 META-INF/services/com.alibaba.csp.sentinel.slotchain.ProcessorSlot</span>
        <span class="token comment">// 这儿会读取到8个 ProcessorSlot</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessorSlot</span><span class="token punctuation">></span></span> sortedSlotList <span class="token operator">=</span> <span class="token class-name">SpiLoader</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">ProcessorSlot</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadInstanceListSorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProcessorSlot</span> slot <span class="token operator">:</span> sortedSlotList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>slot <span class="token keyword">instanceof</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"The ProcessorSlot("</span> <span class="token operator">+</span> slot<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">") is not an instance of AbstractLinkedProcessorSlot, can't be added into ProcessorSlotChain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            <span class="token comment">// 按照字典序设置ProcessorSlot责任链</span>
            chain<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> chain<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  <code>META-INF/services/com.alibaba.csp.sentinel.slotchain.ProcessorSlot</code>文件内容如下</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">#</span> Sentinel default ProcessorSlots
com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>nodeselector<span class="token punctuation">.</span>NodeSelectorSlot
com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>clusterbuilder<span class="token punctuation">.</span>ClusterBuilderSlot
com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>LogSlot
com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>statistic<span class="token punctuation">.</span>StatisticSlot
com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>authority<span class="token punctuation">.</span>AuthoritySlot
com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>system<span class="token punctuation">.</span>SystemSlot
com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow<span class="token punctuation">.</span>FlowSlot
com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>degrade<span class="token punctuation">.</span>DegradeSlot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  可以仔细看一下，文件里的内容已经按照<code>字典序</code>排序了</p>
<p>  构建完成的功能插槽责任链类似下面这样:<br>  <img src="/img/distributed/sentinel/slot/process-slot/process-slot-chain-abstract.png" alt="功能插槽责任链抽象"></p>
<p>  对应的代码Debug截图：<br>  <img src="/img/distributed/sentinel/slot/process-slot/process-slot-chain-v8.png" alt="构建完成的功能插槽责任链"></p>
<h3 id="3-2-1-默认功能插槽责任链-DefaultProcessorSlotChain"><a href="#3-2-1-默认功能插槽责任链-DefaultProcessorSlotChain" class="headerlink" title="(3.2.1) 默认功能插槽责任链-DefaultProcessorSlotChain"></a>(3.2.1) 默认功能插槽责任链-DefaultProcessorSlotChain</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slotchain</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultProcessorSlotChain</span> <span class="token keyword">extends</span> <span class="token class-name">ProcessorSlotChain</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 头结点 first</span>
    <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> first <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 省略部分代码</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// 尾结点 end</span>
    <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> end <span class="token operator">=</span> first<span class="token punctuation">;</span>

    <span class="token comment">/** 添加头节点 */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> protocolProcessor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        protocolProcessor<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        first<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span>protocolProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">==</span> first<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            end <span class="token operator">=</span> protocolProcessor<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/** 添加尾结点 */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> protocolProcessor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        end<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span>protocolProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        end <span class="token operator">=</span> protocolProcessor<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        first<span class="token punctuation">.</span><span class="token function">transformEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> t<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        first<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="3-3-功能插槽责任链-ProcessorSlot"><a href="#3-3-功能插槽责任链-ProcessorSlot" class="headerlink" title="(3.3) 功能插槽责任链-ProcessorSlot"></a>(3.3) 功能插槽责任链-ProcessorSlot</h2><p>  执行各个功能插槽的入口是<code>chain.entry()</code><br>  这里的chain是<code>DefaultProcessorSlotChain</code>，<code>chain.entry()</code>会不断调用对应的<code>entry()</code>方法</p>
<p>  先来了解一下 有哪些功能插槽 及 主要作用</p>
<h3 id="3-3-1-Sentinel里的功能插槽"><a href="#3-3-1-Sentinel里的功能插槽" class="headerlink" title="(3.3.1) Sentinel里的功能插槽"></a>(3.3.1) Sentinel里的功能插槽</h3><table>
<thead>
<tr>
<th align="left">处理插槽</th>
<th align="left">作用</th>
<th align="left">备注</th>
<th align="left">全限定类名</th>
</tr>
</thead>
<tbody><tr>
<td align="left">NodeSelectorSlot</td>
<td align="left">负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来</td>
<td align="left">用于根据调用路径来限流降级</td>
<td align="left">com.alibaba.csp.sentinel.slots.nodeselector.NodeSelectorSlot</td>
</tr>
<tr>
<td align="left">ClusterBuilderSlot</td>
<td align="left">负责维护资源运行统计信息（响应时间、qps、线程数、异常），以及调用者列表</td>
<td align="left">这些信息将用作为多维度限流，降级的依据</td>
<td align="left">com.alibaba.csp.sentinel.slots.clusterbuilder.ClusterBuilderSlot</td>
</tr>
<tr>
<td align="left">LogSlot</td>
<td align="left">记录(BlockException)异常日志  (限流、熔断)</td>
<td align="left"></td>
<td align="left">com.alibaba.csp.sentinel.slots.logger.LogSlot</td>
</tr>
<tr>
<td align="left">StatisticSlot</td>
<td align="left">用于记录、统计不同纬度的 runtime 指标监控信息；</td>
<td align="left"></td>
<td align="left">com.alibaba.csp.sentinel.slots.statistic.StatisticSlot</td>
</tr>
<tr>
<td align="left">AuthoritySlot</td>
<td align="left">根据配置的黑白名单和调用来源信息，来做黑白名单控制；</td>
<td align="left"></td>
<td align="left">com.alibaba.csp.sentinel.slots.block.authority.AuthoritySlot</td>
</tr>
<tr>
<td align="left">SystemSlot</td>
<td align="left">通过系统的状态，例如 load1 等，来控制总的入口流量；</td>
<td align="left"></td>
<td align="left">com.alibaba.csp.sentinel.slots.system.SystemSlot</td>
</tr>
<tr>
<td align="left">FlowSlot</td>
<td align="left">用于根据预设的限流规则以及前面 slot 统计的状态，来进行流量控制；</td>
<td align="left"></td>
<td align="left">com.alibaba.csp.sentinel.slots.block.flow.FlowSlot</td>
</tr>
<tr>
<td align="left">DegradeSlot</td>
<td align="left">通过统计信息以及预设的规则，来做熔断降级；</td>
<td align="left"></td>
<td align="left">com.alibaba.csp.sentinel.slots.block.degrade.DegradeSlot</td>
</tr>
</tbody></table>
<h3 id="3-3-2-功能插槽-ProcessorSlot"><a href="#3-3-2-功能插槽-ProcessorSlot" class="headerlink" title="(3.3.2) 功能插槽-ProcessorSlot"></a>(3.3.2) 功能插槽-ProcessorSlot</h3><p>  源码  <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slotchain/ProcessorSlot.java">https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slotchain/ProcessorSlot.java</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slotchain</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 一些处理的容器 和 处理完成时的通知方式。 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * 插槽入口
     *
     * @param context         当前上下文
     * @param resourceWrapper 当前资源
     * @param param           泛型参数 &#123;@link com.alibaba.csp.sentinel.node.Node&#125;
     * @param count           需要的令牌个数
     * @param prioritized     entry优先级
     * @param args            原始调用的参数
     * @throws Throwable blocked exception or unexpected error
     */</span>
    <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">T</span> param<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span>
               <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 表示entry()方法结束
     *
     * @param context         当前上下文
     * @param resourceWrapper 当前资源
     * @param obj             相关对象 (e.g. Node)
     * @param count           需要的令牌个数
     * @param prioritized     entry优先级
     * @param args            原始调用的参数
     * @throws Throwable blocked exception or unexpected error
     */</span>
    <span class="token keyword">void</span> <span class="token function">fireEntry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span>
                   <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 退出插槽
     *
     * @param context         当前上下文
     * @param resourceWrapper 当前资源
     * @param count           需要的令牌个数
     * @param args            原始调用的参数
     */</span>
    <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 表示exit结束
     *
     * @param context         当前上下文
     * @param resourceWrapper 当前资源
     * @param count           需要的令牌个数
     * @param args            原始调用的参数
     */</span>
    <span class="token keyword">void</span> <span class="token function">fireExit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>  调用功能插槽时都是从entry方法进入</p>
<h2 id="3-4-默认的8个功能插槽"><a href="#3-4-默认的8个功能插槽" class="headerlink" title="(3.4) 默认的8个功能插槽"></a>(3.4) 默认的8个功能插槽</h2><h3 id="3-4-1-调用链路-资源路径-插槽-NodeSelectorSlot"><a href="#3-4-1-调用链路-资源路径-插槽-NodeSelectorSlot" class="headerlink" title="(3.4.1) 调用链路(资源路径)插槽-NodeSelectorSlot"></a>(3.4.1) 调用链路(资源路径)插槽-NodeSelectorSlot</h3><p>  NodeSelectorSlot主要作用是负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级； </p>
<p>  源码：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/nodeselector/NodeSelectorSlot.java#L136">https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/nodeselector/NodeSelectorSlot.java#L136</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>nodeselector</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * &lt;/p>
 * This class will try to build the calling traces via
 * &lt;ol>
 * &lt;li>adding a new &#123;@link DefaultNode&#125; if needed as the last child in the context.
 * The context's last node is the current node or the parent node of the context. &lt;/li>
 * &lt;li>setting itself to the context current node.&lt;/li>
 * &lt;/ol>
 * &lt;/p>
 *
 * &lt;p>It works as follow:&lt;/p>
 * &lt;pre>
 * ContextUtil.enter("entrance1", "appA");
 * Entry nodeA = SphU.entry("nodeA");
 * if (nodeA != null) &#123;
 *     nodeA.exit();
 * &#125;
 * ContextUtil.exit();
 * &lt;/pre>
 *
 * Above code will generate the following invocation structure in memory:
 *
 * &lt;pre>
 *
 *              machine-root
 *                  /
 *                 /
 *           EntranceNode1
 *               /
 *              /
 *        DefaultNode(nodeA)- - - - - -> ClusterNode(nodeA);
 * &lt;/pre>
 *
 * &lt;p>
 * Here the &#123;@link EntranceNode&#125; represents "entrance1" given by
 * &#123;@code ContextUtil.enter("entrance1", "appA")&#125;.
 * &lt;/p>
 * &lt;p>
 * Both DefaultNode(nodeA) and ClusterNode(nodeA) holds statistics of "nodeA", which is given
 * by &#123;@code SphU.entry("nodeA")&#125;
 * &lt;/p>
 * &lt;p>
 * The &#123;@link ClusterNode&#125; is uniquely identified by the ResourceId; the &#123;@link DefaultNode&#125;
 * is identified by both the resource id and &#123;@link Context&#125;. In other words, one resource
 * id will generate multiple &#123;@link DefaultNode&#125; for each distinct context, but only one
 * &#123;@link ClusterNode&#125;.
 * &lt;/p>
 * &lt;p>
 * the following code shows one resource id in two different context:
 * &lt;/p>
 *
 * &lt;pre>
 *    ContextUtil.enter("entrance1", "appA");
 *    Entry nodeA = SphU.entry("nodeA");
 *    if (nodeA != null) &#123;
 *        nodeA.exit();
 *    &#125;
 *    ContextUtil.exit();
 *
 *    ContextUtil.enter("entrance2", "appA");
 *    nodeA = SphU.entry("nodeA");
 *    if (nodeA != null) &#123;
 *        nodeA.exit();
 *    &#125;
 *    ContextUtil.exit();
 * &lt;/pre>
 *
 * Above code will generate the following invocation structure in memory:
 *
 * &lt;pre>
 *
 *                  machine-root
 *                  /         \
 *                 /           \
 *         EntranceNode1   EntranceNode2
 *               /               \
 *              /                 \
 *      DefaultNode(nodeA)   DefaultNode(nodeA)
 *             |                    |
 *             +- - - - - - - - - - +- - - - - - -> ClusterNode(nodeA);
 * &lt;/pre>
 *
 * &lt;p>
 * As we can see, two &#123;@link DefaultNode&#125; are created for "nodeA" in two context, but only one
 * &#123;@link ClusterNode&#125; is created.
 * &lt;/p>
 *
 * &lt;p>
 * We can also check this structure by calling: &lt;br/>
 * &#123;@code curl http://localhost:8719/tree?type=root&#125;
 * &lt;/p>
 *
 * @author jialiang.linjl
 * @see EntranceNode
 * @see ContextUtil
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>isSingleton <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> order <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ORDER_NODE_SELECTOR_SLOT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NodeSelectorSlot</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * &#123;@link DefaultNode&#125;s of the same resource in different context.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
         * It's interesting that we use context name rather resource name as the map key.
         *
         * Remember that same resource(&#123;@link ResourceWrapper#equals(Object)&#125;) will share
         * the same &#123;@link ProcessorSlotChain&#125; globally, no matter in which context. So if
         * code goes into &#123;@link #entry(Context, ResourceWrapper, DefaultNode, int, Object...)&#125;,
         * the resource name must be same but context name may not.
         *
         * If we use &#123;@link com.alibaba.csp.sentinel.SphU#entry(String resource)&#125; to
         * enter same resource in different context, using context name as map key can
         * distinguish the same resource. In this case, multiple &#123;@link DefaultNode&#125;s will be created
         * of the same resource name, for every distinct context (different context name) each.
         *
         * Consider another question. One resource may have multiple &#123;@link DefaultNode&#125;,
         * so what is the fastest way to get total statistics of the same resource?
         * The answer is all &#123;@link DefaultNode&#125;s with same resource name share one
         * &#123;@link ClusterNode&#125;. See &#123;@link ClusterBuilderSlot&#125; for detail.
         */</span>
        <span class="token comment">// 根据上下文名称获取节点 </span>
        <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 单例模式-DCL</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> cacheMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cacheMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    map <span class="token operator">=</span> cacheMap<span class="token punctuation">;</span>
                    <span class="token comment">// 构建调用树</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultNode</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getLastNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        context<span class="token punctuation">.</span><span class="token function">setCurNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>node</span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultNode</span> <span class="token keyword">extends</span> <span class="token class-name">StatisticNode</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * 孩子节点集合
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> childList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 添加孩子节点
     *
     * @param node valid child node
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addChild</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Trying to add null child to node &lt;&#123;&#125;>, ignored"</span><span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// DCL</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 添加孩子节点</span>
                    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> newSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>childList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newSet<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>childList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    childList <span class="token operator">=</span> newSet<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Add child &lt;&#123;&#125;> to node &lt;&#123;&#125;>"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultNode</span><span class="token punctuation">)</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;pre>
 *
 *                  machine-root
 *                  /         \
 *                 /           \
 *         EntranceNode1   EntranceNode2
 *               /               \
 *              /                 \
 *      DefaultNode(nodeA)   DefaultNode(nodeA)
 *             |                    |
 *             +- - - - - - - - - - +- - - - - - -> ClusterNode(nodeA);
 * &lt;/pre>
 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h3 id="3-4-2-节点统计信息插槽-ClusterBuilderSlot"><a href="#3-4-2-节点统计信息插槽-ClusterBuilderSlot" class="headerlink" title="(3.4.2) 节点统计信息插槽-ClusterBuilderSlot"></a>(3.4.2) 节点统计信息插槽-ClusterBuilderSlot</h3><p>  <code>ClusterBuilderSlot</code>负责维护资源运行统计信息（响应时间、qps、线程数、异常），以及调用者列表</p>
<p>  <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/clusterbuilder/ClusterBuilderSlot.java#L77">https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/clusterbuilder/ClusterBuilderSlot.java#L77</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>clusterbuilder</span><span class="token punctuation">;</span>
 
<span class="token comment">/**
 * 该槽维护资源运行统计信息（响应时间、qps、线程数、异常），以及调用者列表，由 ContextUtil#enter(String origin)标记 
 * 一个资源只有一个集群节点，而一个资源可以有多个默认节点。
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>isSingleton <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> order <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ORDER_CLUSTER_BUILDER_SLOT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClusterBuilderSlot</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * 相同的资源 ResourceWrapper#equals(Object) 将在全局范围内共享相同的ProcessorSlotChain，无论在哪个上下文中。
     * 因此，如果代码进入 entry()，资源名称必须相同，但上下文名称可能不同。
     * 
     * 为了获取同一资源在不同上下文中的总统计信息，同一资源在全局共享相同的ClusterNode。所有ClusterNode都缓存在此映射中。
     * 
     * 应用程序运行的时间越长，这个映射就会变得越稳定。所以我们不是并发映射而是锁。因为这个锁只发生在最开始，而并发映射将一直持有锁。
     * 
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceWrapper</span><span class="token punctuation">,</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">></span></span> clusterNodeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ClusterNode</span> clusterNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>
                      <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 单例-DCL</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clusterNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clusterNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 创建集群节点​​。</span>
                    clusterNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">.</span><span class="token function">getResourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceWrapper</span><span class="token punctuation">,</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">></span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>clusterNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>clusterNodeMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 添加到缓存里</span>
                    newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clusterNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 更新缓存</span>
                    clusterNodeMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        node<span class="token punctuation">.</span><span class="token function">setClusterNode</span><span class="token punctuation">(</span>clusterNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * 如果设置了原始上下文，我们应该获取 或 创建原始直接的Node。
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Node</span> originNode <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrCreateOriginNode</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setOriginNode</span><span class="token punctuation">(</span>originNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h3 id="3-4-3-日志插槽-LogSlot"><a href="#3-4-3-日志插槽-LogSlot" class="headerlink" title="(3.4.3) 日志插槽-LogSlot"></a>(3.4.3) 日志插槽-LogSlot</h3><p>  LogSlot主要负责记录限流异常的响应，以提供用于故障排除的具体日志。<br>  记录的日志存储在 <code>sentinel-block.log</code> 文件里</p>
<p>  源码: <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/logger/LogSlot.java#L35">https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/logger/LogSlot.java#L35</a> </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>logger</span><span class="token punctuation">;</span>

 
<span class="token comment">/**
 * 一个处理插槽，它是对记录限流异常的响应，以提供用于故障排除的具体日志。
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ORDER_LOG_SLOT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogSlot</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 记录异常日志(包括限流和降级) </span>
            <span class="token comment">// 日志会记录在 sentinel-block.log 文件里</span>
            <span class="token class-name">EagleEyeLogUtil</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getRuleLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected entry exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token function">fireExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected entry exit exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>  <code>sentinel-block.log</code> 文件内容如下:</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2020-10-30</span> <span class="token time number">14:39:29</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>HelloWorld<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>default<span class="token punctuation">,</span><span class="token operator">|</span><span class="token number">46944</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token date number">2020-10-30</span> <span class="token time number">14:39:30</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>HelloWorld<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>default<span class="token punctuation">,</span><span class="token operator">|</span><span class="token number">138183</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token date number">2020-10-30</span> <span class="token time number">14:39:31</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>HelloWorld<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>default<span class="token punctuation">,</span><span class="token operator">|</span><span class="token number">188067</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token date number">2020-11-25</span> <span class="token time number">20:12:24</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>sentinelTest<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>default<span class="token punctuation">,</span><span class="token operator">|</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token date number">2020-11-25</span> <span class="token time number">20:12:25</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>sentinelTest<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>default<span class="token punctuation">,</span><span class="token operator">|</span><span class="token number">540</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token date number">2020-11-25</span> <span class="token time number">21:00:57</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>sentinelTest<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>default<span class="token punctuation">,</span><span class="token operator">|</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token date number">2020-11-25</span> <span class="token time number">21:00:58</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>sentinelTest<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>default<span class="token punctuation">,</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token date number">2020-11-25</span> <span class="token time number">21:00:59</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>sentinelTest<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>default<span class="token punctuation">,</span><span class="token operator">|</span><span class="token number">62</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token date number">2020-11-25</span> <span class="token time number">21:01:00</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>sentinelTest<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>default<span class="token punctuation">,</span><span class="token operator">|</span><span class="token number">838</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token date number">2020-12-10</span> <span class="token time number">10:39:24</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>SentinelResourceMethod1<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>app1<span class="token punctuation">,</span>app1<span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token date number">2020-12-10</span> <span class="token time number">10:39:25</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>SentinelResourceMethod1<span class="token punctuation">,</span>FlowException<span class="token punctuation">,</span>app1<span class="token punctuation">,</span>app1<span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h3 id="3-4-4-实时统计插槽-StatisticSlot"><a href="#3-4-4-实时统计插槽-StatisticSlot" class="headerlink" title="(3.4.4) 实时统计插槽-StatisticSlot"></a>(3.4.4) 实时统计插槽-StatisticSlot</h3><p>  源码 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/statistic/StatisticSlot.java#L55">https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/statistic/StatisticSlot.java#L55</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>statistic</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 专用于实时统计的处理器插槽。
 * 在进入这个槽的时候，我们需要单独统计以下信息：
 *   ClusterNode：资源ID的集群节点的总统计。
 *   源节点：来自不同调用者/源的集群节点的统计信息。 
 *   DefaultNode：特定上下文中特定资源名称的统计信息。
 *   最后是所有入口的总和统计。
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ORDER_STATISTIC_SLOT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatisticSlot</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>
                      <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Do some checking.</span>
            <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Request passed, add thread count and pass count.</span>
            node<span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            node<span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Add count for origin node.</span>
                context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getEntryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span>IN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Add count for global inbound entry node for global statistics.</span>
                <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Handle pass event with registered entry callback handlers.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProcessorSlotEntryCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> handler <span class="token operator">:</span> <span class="token class-name">StatisticSlotCallbackRegistry</span><span class="token punctuation">.</span><span class="token function">getEntryCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                handler<span class="token punctuation">.</span><span class="token function">onPass</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PriorityWaitException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            node<span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Add count for origin node.</span>
                context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getEntryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span>IN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Add count for global inbound entry node for global statistics.</span>
                <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// Handle pass event with registered entry callback handlers.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProcessorSlotEntryCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> handler <span class="token operator">:</span> <span class="token class-name">StatisticSlotCallbackRegistry</span><span class="token punctuation">.</span><span class="token function">getEntryCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                handler<span class="token punctuation">.</span><span class="token function">onPass</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Blocked, set block exception to current entry.</span>
            context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBlockError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Add block count.</span>
            node<span class="token punctuation">.</span><span class="token function">increaseBlockQps</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increaseBlockQps</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getEntryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span>IN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Add count for global inbound entry node for global statistics.</span>
                <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">increaseBlockQps</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Handle block event with registered entry callback handlers.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProcessorSlotEntryCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> handler <span class="token operator">:</span> <span class="token class-name">StatisticSlotCallbackRegistry</span><span class="token punctuation">.</span><span class="token function">getEntryCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                handler<span class="token punctuation">.</span><span class="token function">onBlocked</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Unexpected internal error, set error to current entry.</span>
            context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span> node <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getCurNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBlockError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Calculate response time (use completeStatTime as the time of completion).</span>
        <span class="token keyword">long</span> completeStatTime <span class="token operator">=</span> <span class="token class-name">TimeUtil</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCompleteTimestamp</span><span class="token punctuation">(</span>completeStatTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> rt <span class="token operator">=</span> completeStatTime <span class="token operator">-</span> context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCreateTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Throwable</span> error <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Record response time and success count.</span>
        <span class="token function">recordCompleteFor</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> rt<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">recordCompleteFor</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> rt<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getEntryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span>IN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">recordCompleteFor</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">,</span> count<span class="token punctuation">,</span> rt<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Handle exit event with registered exit callback handlers.</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessorSlotExitCallback</span><span class="token punctuation">></span></span> exitCallbacks <span class="token operator">=</span> <span class="token class-name">StatisticSlotCallbackRegistry</span><span class="token punctuation">.</span><span class="token function">getExitCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProcessorSlotExitCallback</span> handler <span class="token operator">:</span> exitCallbacks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        handler<span class="token punctuation">.</span><span class="token function">onExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// fix bug https://github.com/alibaba/Sentinel/issues/2374</span>
    <span class="token function">fireExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>



<h3 id="3-4-5-权限规则检查插槽-AuthoritySlot"><a href="#3-4-5-权限规则检查插槽-AuthoritySlot" class="headerlink" title="(3.4.5) 权限规则检查插槽-AuthoritySlot"></a>(3.4.5) 权限规则检查插槽-AuthoritySlot</h3><p>  <code>AuthoritySlot</code> 的主要作用是 权限规则检查。</p>
<p>  源码 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/authority/AuthoritySlot.java">https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/authority/AuthoritySlot.java</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>authority</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 致力于权限规则检查的一个处理插槽。
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ORDER_AUTHORITY_SLOT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthoritySlot</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 权限校验  </span>
        <span class="token function">checkBlackWhiteAuthority</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// </span>
        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token comment">/**  */</span>
    <span class="token keyword">void</span> <span class="token function">checkBlackWhiteAuthority</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthorityException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取所有资源的权限规则</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> authorityRules <span class="token operator">=</span> <span class="token class-name">AuthorityRuleManager</span><span class="token punctuation">.</span><span class="token function">getAuthorityRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>authorityRules <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 获取当前资源的权限规则  </span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRule</span><span class="token punctuation">></span></span> rules <span class="token operator">=</span> authorityRules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AuthorityRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 检查权限</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">AuthorityRuleChecker</span><span class="token punctuation">.</span><span class="token function">passCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 权限校验不通过抛AuthorityException异常</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthorityException</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h3 id="3-4-6-系统规则检查插槽-SystemSlot"><a href="#3-4-6-系统规则检查插槽-SystemSlot" class="headerlink" title="(3.4.6) 系统规则检查插槽-SystemSlot"></a>(3.4.6) 系统规则检查插槽-SystemSlot</h3><p>  SystemSlot主要作用是系统规则检查。</p>
<p>  源码: <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/system/SystemSlot.java#L36">https://github.com/alibaba/Sentinel/blob/1.8.6/sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/system/SystemSlot.java#L36</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>system</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 致力于系统规则检查的一个处理插槽。
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ORDER_SYSTEM_SLOT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemSlot</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>
                      <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 系统规则检查                </span>
        <span class="token class-name">SystemRuleManager</span><span class="token punctuation">.</span><span class="token function">checkSystem</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// </span>
        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fireExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>system</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Sentinel System Rule 使入站流量和容量满足。 它考虑了传入请求的平均 rt、qps、线程数。 
 * 它还提供了系统负载的度量，但仅在 Linux 上可用。
 *
 * rt、qps、线程数很好理解。 如果传入请求的 rt、qps、线程数超过其阈值，请求将被拒绝。
 * 但是，我们使用不同的方法来计算负载。
 *
 * 将系统视为管道，约束之间的转换导致三个不同区域（交通限制、容量限制和危险区域）具有不同性质的行为。 
 * 当运行中没有足够的请求来填充管道时，RTprop 会确定行为； 否则，系统容量占主导地位。 
 * 约束线在飞行中相交 = Capacity × RTprop。 
 * 由于管道已满，超过这一点，机载容量过剩产生了一个队列，导致RTT对机载流量的线性依赖和系统负载的增加。
 * 在危险区域，系统将停止响应。 
 * 
 * 参考 BBR 算法了解更多。
 * 
 * 注意，SystemRule仅对入站请求有效，出站流量不受SystemRule限制 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SystemRuleManager</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * 将系统规则应用于资源。 只会检查入站流量。
     *
     * @param 资源
     * @throws BlockException 当超过任何系统规则的阈值时。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkSystem</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 确保检查开关打开。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>checkSystemStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 仅用于入站流量 </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getEntryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span>IN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Constants.ENTRY_NODE 是 入站流量的全局统计节点。</span>

        <span class="token comment">// total qps</span>
        <span class="token keyword">double</span> currentQps <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">passQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentQps <span class="token operator">+</span> count <span class="token operator">></span> qps<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemBlockException</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"qps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// total thread</span>
        <span class="token keyword">int</span> currentThread <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">curThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentThread <span class="token operator">></span> maxThread<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemBlockException</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 延时</span>
        <span class="token keyword">double</span> rt <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">avgRt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rt <span class="token operator">></span> maxRt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemBlockException</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"rt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 负载  BBR algorithm.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>highestSystemLoadIsSet <span class="token operator">&amp;&amp;</span> <span class="token function">getCurrentSystemAvgLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> highestSystemLoad<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkBbr</span><span class="token punctuation">(</span>currentThread<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemBlockException</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"load"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// cpu usage</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>highestCpuUsageIsSet <span class="token operator">&amp;&amp;</span> <span class="token function">getCurrentCpuUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> highestCpuUsage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SystemBlockException</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="3-4-7-插槽-FlowSlot"><a href="#3-4-7-插槽-FlowSlot" class="headerlink" title="(3.4.7) 插槽-FlowSlot"></a>(3.4.7) 插槽-FlowSlot</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 结合从前面的插槽(NodeSelectorSlot、ClusterNodeBuilderSlot 和 StatisticSlot)收集的
 * 运行时统计信息，FlowSlot 将使用预设规则来决定是否应阻止传入请求。
 *
 * 如果触发任何规则，SphU.entry(resourceName) 将抛出 FlowException。 
 * 用户可以通过捕获 FlowException 来自定义自己的逻辑。
 *
 * 一个资源可以有多个流规则。 FlowSlot 遍历这些规则，直到其中一条被触发或者所有规则都被遍历。
 *
 * 每个FlowRule主要由这些因素组成：等级、策略、路径。 我们可以结合这些因素来达到不同的效果。
 * 
 * 等级由 FlowRule 中的 grade 字段定义。 
 * 此处，0 用于线程隔离，1 用于请求计数整形 (QPS)。 
 * 线程计数和请求计数都是在真实运行时收集的，
 * 我们可以通过以下命令查看这些统计信息：
 * &lt;pre>
 * curl http://localhost:8719/tree
 *
 * idx id    thread pass  blocked   success total aRt   1m-pass   1m-block   1m-all   exception
 * 2   abc647 0      460    46          46   1    27      630       276        897      0
 * &lt;/pre>
 *
 * thread 当前正在处理资源的线程数 
 * pass 一秒内传入请求数 
 * blocked 一秒内被阻塞的请求数 
 * success 一秒内被Sentinel成功处理的请求数 
 * RT 请求在一秒内的平均响应时间 
 * total 一秒内传入请求和阻塞请求的总和 
 * 1m-pass 为一分钟内传入请求数 
 * 1m-block 为一分钟内被阻塞的请求数 
 * 1m-all 是一分钟内传入和阻止的请求总数 
 * exception 为一秒内业务（自定义）异常的计数 
 * 
 * 这个阶段通常用于保护资源不被占用。 (达到限流阈值，服务快撑不住了)
 * 如果资源需要很长时间才能完成，线程将开始占用。 响应时间越长，占用的线程越多。
 * 
 * 除了计数器之外，线程池或信号量也可以用来实现这一点。
 * - 线程池：分配一个线程池来处理这些资源。 当池中不再有空闲线程时，拒绝请求而不影响其他资源。
 * - 信号量：使用信号量来控制该资源中线程的并发数。
 * 
 * 使用线程池的好处是，超时可以优雅的走开。 但它也给我们带来了上下文切换和额外线程的成本。 
 * 如果传入请求已经在单独的线程中提供服务，例如 Servlet HTTP 请求，那么如果使用线程池，线程数几乎会翻倍。
 * 
 * 
 * 流量整形 
 * 当QPS超过阈值时，Sentinel会采取动作控制传入的请求，由流规则中的 controlBehavior 字段配置。
 *   1.立即拒绝(Immediately reject)：默认行为。 超出的请求立即被拒绝 并抛出 FlowException
 *   2.热启动(Warmup) : 如果一段时间以来系统的负载很低，大量的请求来了，系统可能无法一次处理所有这些请求。 
 *        然而，如果我们稳定地增加传入请求，系统可以预热并最终能够处理所有请求。 
 *        可以通过在流规则中设置字段 warmUpPeriodSec 来配置此预热期。
 *   3.统一速率限制  此策略严格控制请求之间的间隔。换句话说，它允许请求以稳定、统一的速率传递。
 *        https://raw.githubusercontent.com/wiki/alibaba/Sentinel/image/uniform-speed-queue.png 
 *        该策略是漏桶算法的实现  https://en.wikipedia.org/wiki/Leaky_bucket  
 *        它用于以稳定的速率处理请求，通常用于突发业务（例如消息处理）。
 *        当大量超出系统容量的请求同时到达时，使用此策略的系统将处理请求及其固定速率，直到所有请求都已处理或超时。
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ORDER_FLOW_SLOT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowSlot</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">FlowRuleChecker</span> checker<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FlowSlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlowRuleChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * Package-private for test.
     *
     * @param checker flow rule checker
     * @since 1.6.1
     */</span>
    <span class="token class-name">FlowSlot</span><span class="token punctuation">(</span><span class="token class-name">FlowRuleChecker</span> checker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">AssertUtil</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>checker<span class="token punctuation">,</span> <span class="token string">"flow checker should not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>checker <span class="token operator">=</span> checker<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>
                      <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 校验</span>
        <span class="token function">checkFlow</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">checkFlow</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//   </span>
        checker<span class="token punctuation">.</span><span class="token function">checkFlow</span><span class="token punctuation">(</span>ruleProvider<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fireExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ruleProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Flow rule map should not be null.</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> flowRules <span class="token operator">=</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">getFlowRuleMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> flowRules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-4-8-熔断降级插槽-DegradeSlot"><a href="#3-4-8-熔断降级插槽-DegradeSlot" class="headerlink" title="(3.4.8) 熔断降级插槽-DegradeSlot"></a>(3.4.8) 熔断降级插槽-DegradeSlot</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>degrade</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 专门用于熔断/电路断路 的处理插槽
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ORDER_DEGRADE_SLOT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DegradeSlot</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>
                      <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//                 </span>
        <span class="token function">performChecking</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  */</span>
<span class="token keyword">void</span> <span class="token function">performChecking</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> r<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取资源对应的熔断器/断路器</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CircuitBreaker</span><span class="token punctuation">></span></span> circuitBreakers <span class="token operator">=</span> <span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">getCircuitBreakers</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>circuitBreakers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> circuitBreakers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CircuitBreaker</span> cb <span class="token operator">:</span> circuitBreakers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 判断是否可以通过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cb<span class="token punctuation">.</span><span class="token function">tryPass</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 抛出熔断异常 DegradeException </span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DegradeException</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span><span class="token function">getRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cb<span class="token punctuation">.</span><span class="token function">getRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<br>

<h2 id="3-5-调用堆栈"><a href="#3-5-调用堆栈" class="headerlink" title="3.5 调用堆栈"></a>3.5 调用堆栈</h2><p><img src="/img/distributed/sentinel/slot/process-slot/process-slot-stack-v2.png" alt="调用8个功能插槽后的代码堆栈"></p>
<br>




<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/introduction.html">Sentinel介绍</a><br>[2] <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/basic-implementation.html">Sentinel工作主流程</a></p>
<!--
 【Sentinel源码专题一】熔断限流利器Sentinel核心流程与插件-黄益明  https://i.xiaojukeji.com/way/article/39232  
 【Sentinel源码专题二】Sentinel核心算法设计与实现-周向阳  https://i.xiaojukeji.com/way/article/39402  
 【Sentinel源码专题三】Sentinel异步实现与集群限流-傅饶  https://i.xiaojukeji.com/way/article/10892736  
-->


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/11/29/sentinel-degrade/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/29/sentinel-degrade/" class="post-title-link" itemprop="url">Sentinel熔断源码解读</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-29 09:11:58" itemprop="dateCreated datePublished" datetime="2020-11-29T09:11:58+08:00">2020-11-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-01-14 23:23:28" itemprop="dateModified" datetime="2023-01-14T23:23:28+08:00">2023-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/stability/" itemprop="url" rel="index"><span itemprop="name">stability</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>17k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>15 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-什么是熔断"><a href="#1-什么是熔断" class="headerlink" title="(1) 什么是熔断"></a>(1) 什么是熔断</h1><p>  在生活中，我们经常看到家里的闸里会有保险丝，保险丝会在电流过大时熔断。</p>
<h1 id="2-为什么需要熔断"><a href="#2-为什么需要熔断" class="headerlink" title="(2) 为什么需要熔断"></a>(2) 为什么需要熔断</h1><p>  像保险丝在电流过大时熔断保护电路一样<br>  计算机软件系统里的熔断是为了保护系统不被过大的资源消耗拖垮</p>
<h1 id="3-熔断的原理"><a href="#3-熔断的原理" class="headerlink" title="(3) 熔断的原理"></a>(3) 熔断的原理</h1><p>  断路器</p>
<h2 id="3-1-状态机"><a href="#3-1-状态机" class="headerlink" title="(3.1) 状态机"></a>(3.1) 状态机</h2><p>  熔断状态机</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/11/29/sentinel-degrade/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/11/22/current-limiting-algorithm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/22/current-limiting-algorithm/" class="post-title-link" itemprop="url">限流算法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-22 10:50:00" itemprop="dateCreated datePublished" datetime="2020-11-22T10:50:00+08:00">2020-11-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-01-14 22:32:20" itemprop="dateModified" datetime="2023-01-14T22:32:20+08:00">2023-01-14</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  什么是限流，为什么要限流？</p>
<p>  常见的限流算法有3类：<code>计数器算法</code>、 <code>令牌桶算法</code>、 <code>漏桶算法</code></p>
<h1 id="1-计数器算法"><a href="#1-计数器算法" class="headerlink" title="(1) 计数器算法"></a>(1) 计数器算法</h1><h2 id="1-1-普通计数器算法"><a href="#1-1-普通计数器算法" class="headerlink" title="(1.1) 普通计数器算法"></a>(1.1) 普通计数器算法</h2><p>  假设系统每秒能同时处理100个请求，保存一个计数器，如果开始处理一个请求，计数器加一，请求处理完毕之后计数器减一。</p>
<p>  每次请求来的时候看看计数器的值，如果超过阈值要么拒绝。</p>
<p>  计数器的值要是存内存中就算单机限流算法。存在分布式存储中，集群机器访问就算分布式限流算法。</p>
<p>  缺点就是：假设我们允许的阈值是1万，此时计数器的值为0， 当1万个请求在前1秒内一股脑儿的都涌进来，这突发的流量可是顶不住的。<br>  缓缓的增加处理和一下子涌入对于程序来说是不一样的。</p>
<h2 id="1-1-固定窗口限流"><a href="#1-1-固定窗口限流" class="headerlink" title="(1.1) 固定窗口限流"></a>(1.1) 固定窗口限流</h2><p>  它相比于计数限流主要是多了个时间窗口的概念。计数器每过一个时间窗口就重置。  </p>
<h3 id="1-1-1-定义"><a href="#1-1-1-定义" class="headerlink" title="(1.1.1) 定义"></a>(1.1.1) 定义</h3><p>规则如下：</p>
<blockquote>
<p>请求次数小于阈值，允许访问并且计数器 +1；<br>请求次数大于阈值，拒绝访问；<br>这个时间窗口过了之后，计数器清零；</p>
</blockquote>
<h3 id="1-1-2-问题"><a href="#1-1-2-问题" class="headerlink" title="(1.1.2) 问题"></a>(1.1.2) 问题</h3><p>  固定窗口临界问题<br>  系统每秒最多接受100个请求<br>  假设有一个恶意用户，他在<code>09:59:800</code>时，瞬间发送了100个请求，并且<code>10:00:000</code>又瞬间发送了100个请求，那么其实这个用户在1秒里面，瞬间发送了200个请求。</p>
<p>  通过在时间窗口的重置节点处突发请求，可以瞬间超过我们的速率限制。用户有可能通过算法的这个漏洞，瞬间压垮我们的应用。</p>
<p>  刚才的问题其实是因为我们统计的精度太低。那么如何很好地处理这个问题呢？</p>
<h2 id="1-2-滑动窗口算法"><a href="#1-2-滑动窗口算法" class="headerlink" title="(1.2) 滑动窗口算法"></a>(1.2) 滑动窗口算法</h2><p>  相对于固定窗口，滑动窗口除了需要引入计数器之外还需要记录时间窗口内每个请求到达的时间点，因此对内存的占用会比较多。</p>
<h3 id="1-2-1-定义"><a href="#1-2-1-定义" class="headerlink" title="(1.2.1) 定义"></a>(1.2.1) 定义</h3><p>  将时间窗口进行划分，每过一个时间单位，时间窗口就会往右滑动一格。每一个格子都有自己独立的计数器counter</p>
<p>规则如下，假设时间窗口为1秒：</p>
<blockquote>
<p>记录每次请求的时间<br>统计每次请求的时间 至 往前推1秒这个时间窗口内请求数，并且 1 秒前的数据可以删除。<br>统计的请求数小于阈值就记录这个请求的时间，并允许通过，反之拒绝。</p>
</blockquote>
<p>  <img src="/img/distributed/sentinel/slading-window/slading-window-v1.png" alt="滑动窗口"></p>
<p> 1s有1000ms，我们把1秒分成5个时间窗口，一个时间窗口就是200ms。<br> 每过200ms，我们的时间窗口就会往右滑动一格。每一个格子都有自己独立的计数器counter，比如当一个请求 在<code>09:59:800</code>的时候到达，那么<code>800~1000</code>对应的counter就会加1。</p>
<h3 id="1-2-2-短时间内的流量攻击"><a href="#1-2-2-短时间内的流量攻击" class="headerlink" title="(1.2.2) 短时间内的流量攻击"></a>(1.2.2) 短时间内的流量攻击</h3><p>  但是滑动窗口和固定窗口都无法解决短时间之内集中流量的突击。</p>
<p>  我们所想的限流场景，例如每秒限制100个请求。希望请求每 10ms 来一个，这样我们的流量处理就很平滑，但是真实场景很难控制请求的频率。因此可能存在 5ms 内就打满了阈值的情况。</p>
<p>  当然对于这种情况还是有变型处理的，例如设置多条限流规则。不仅限制每秒100个请求，再设置每10ms不超过 2 个。</p>
<h3 id="1-2-3-滑动窗口与TCP滑动窗口"><a href="#1-2-3-滑动窗口与TCP滑动窗口" class="headerlink" title="(1.2.3) 滑动窗口与TCP滑动窗口"></a>(1.2.3) 滑动窗口与TCP滑动窗口</h3><p>  这个滑动窗口可与TCP的滑动窗口不一样。TCP的滑动窗口是接收方告知发送方自己能接多少“货”，然后发送方控制发送的速率。</p>
<br>


<h1 id="2-令牌桶算法"><a href="#2-令牌桶算法" class="headerlink" title="(2) 令牌桶算法"></a>(2) 令牌桶算法</h1><p>所有的请求在处理之前都需要拿到一个可用的令牌才会被处理<br>  1、所有的请求在处理之前都需要拿到一个可用的令牌才会被处理；<br>  2、根据限流大小，设置按照一定的速率往桶里添加令牌；<br>  3、桶设置最大的放置令牌限制，当桶满时、新添加的令牌就被丢弃或者拒绝；<br>  4、请求达到后首先要获取令牌桶中的令牌，拿着令牌才可以进行其他的业务逻辑，处理完业务逻辑之后，将令牌直接删除；<br>  5、令牌桶有最低限额，当桶中的令牌达到最低限额的时候，请求处理完之后将不会删除令牌，以此保证足够的限流；</p>
<p>  应对突发流量的时候令牌桶表现的更佳。</p>
<p>  假设服务没预热，那是不是上线时候桶里没令牌？没令牌请求过来不就直接拒了么？这就误杀了，明明系统没啥负载现在。</p>
<br>

<h1 id="3-漏桶算法"><a href="#3-漏桶算法" class="headerlink" title="(3) 漏桶算法"></a>(3) 漏桶算法</h1><p>  漏桶算法，可以粗略的认为就是注水漏水过程，往桶中以一定速率流出水，以任意速率流入水，当水超过桶流量则丢弃，因为桶容量是不变的，保证了整体的速率。</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>  请求来了放入桶中<br>  桶内请求量满了拒绝请求<br>  服务定速从桶内拿请求处理</p>
<p>  面对突发请求，漏桶算法的处理速度和平时是一样的，这其实不是我们想要的。<br>  拿漏桶来说，漏桶中请求是暂时存在桶内的。这其实不符合互联网业务低延迟的要求。</p>
<h1 id="4-总结"><a href="#4-总结" class="headerlink" title="(4) 总结"></a>(4) 总结</h1><p>  漏桶和令牌桶其实比较适合阻塞式限流场景，即没令牌我就等着，这就不会误杀了，而漏桶本就是等着。比较适合后台任务类的限流。<br>  基于时间窗口的限流比较适合对时间敏感的场景，请求过不了您就快点儿告诉我。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000041548601">5种限流算法，7种限流方式，挡住突发流量？</a><br>[2] <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000023552181">图解+代码|常见限流算法以及限流在单机分布式场景下的思考</a><br>[3] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/linjiqin/p/9707713.html">三种常见的限流算法</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/11/22/sentinel-flow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/22/sentinel-flow/" class="post-title-link" itemprop="url">Sentinel限流源码解读</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-22 09:05:52" itemprop="dateCreated datePublished" datetime="2020-11-22T09:05:52+08:00">2020-11-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-01-14 23:12:38" itemprop="dateModified" datetime="2023-01-14T23:12:38+08:00">2023-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/stability/" itemprop="url" rel="index"><span itemprop="name">stability</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>17k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>15 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-原理"><a href="#1-原理" class="headerlink" title="(1) 原理"></a>(1) 原理</h1><p>  流量控制（flow control），其原理是监控应用流量的 QPS 或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</p>
<p> 假如让自己实现一个限流算法，怎么实现？</p>
<h2 id="1-1-计数器限流算法"><a href="#1-1-计数器限流算法" class="headerlink" title="(1.1) 计数器限流算法"></a>(1.1) 计数器限流算法</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="2-限流配置"><a href="#2-限流配置" class="headerlink" title="(2) 限流配置"></a>(2) 限流配置</h1><p>sentinel<br>限流类型(2种)<br>  线程数限流<br>  QPS数限流</p>
<p>限流策略/流控模式(3种)<br>  直接限流、关联限流、链路限流</p>
<p>流控效果(3种)<br>  直接拒绝、Ware Up、排队等待</p>
<br>


<h1 id="3-限流源码"><a href="#3-限流源码" class="headerlink" title="(3) 限流源码"></a>(3) 限流源码</h1><p>  源码流程图  todo<br>  时序图 todo</p>
<p>限流有比较重要的几个点<br>1.限流配置 限流配置管理<br>2.限流算法 限流实现<br>3.</p>
<h2 id="3-1-限流配置管理-FlowRuleManager"><a href="#3-1-限流配置管理-FlowRuleManager" class="headerlink" title="(3.1) 限流配置管理-FlowRuleManager"></a>(3.1) 限流配置管理-FlowRuleManager</h2><p>  FlowRuleManager对象主要职责是管理资源的限流配置</p>
<p>  资源对应的流控配置保存在 <code>Map&lt;String, List&lt;FlowRule&gt;&gt; flowRules</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 一个资源可以有多个规则/配置。这些规则按以下顺序生效：
 *  来自指定呼叫方的请求
 *  没有指定的调用者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowRuleManager</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/** 资源和对应限流配置集合 重要 */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> flowRules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">FlowPropertyListener</span> LISTENER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowPropertyListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**  */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">SentinelProperty</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> currentProperty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicSentinelProperty</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** 
     * 定时任务线程池 
     * SCHEDULER 的 corePool size 必须设置为 1，这样两个任务startMetricTimerListener()才能由SCHEDULER有序运行
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"PMD.ThreadPoolCreationRule"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> SCHEDULER <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"sentinel-metrics-record-task"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        currentProperty<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>LISTENER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">startMetricTimerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  这里用到了观察者模式，<code>DynamicSentinelProperty</code>是被观察者，<code>FlowRuleManager</code>是观察者，FlowRuleManager观察到配置变更后会通过<code>configUpdate</code>方法更新配置信息。</p>
<h3 id="3-1-1-限流规则对象-FlowRule"><a href="#3-1-1-限流规则对象-FlowRule" class="headerlink" title="(3.1.1) 限流规则对象-FlowRule"></a>(3.1.1) 限流规则对象-FlowRule</h3><p>  FlowRule对象的主要用来存配置信息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRule</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setLimitApp</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>LIMIT_APP_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 流控类型  0:线程数限流  1:QPS限流
     * 默认使用 QPS限流
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> grade <span class="token operator">=</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>FLOW_GRADE_QPS<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 流量控制阈值。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> count<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 限流策略
     * 基于调用链的流量控制策略。 
     *
     * &#123;@link RuleConstant#STRATEGY_DIRECT&#125; 直接限流 (by origin);
     * &#123;@link RuleConstant#STRATEGY_RELATE&#125; 关联限流 (with relevant resource);
     * &#123;@link RuleConstant#STRATEGY_CHAIN&#125; 链路限流 (by entrance resource).
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> strategy <span class="token operator">=</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_DIRECT<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 具有相关资源或上下文的流量控制中的参考资源。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> refResource<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 流控效果
     *　
     * 0.直接拒绝(reject directly) 
     * 1.热启动(warm up)  
     * 2. 匀速排队(rate limiter) 
     * 3. 热启动 + 匀速排队 warm up + rate limiter
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> controlBehavior <span class="token operator">=</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>CONTROL_BEHAVIOR_DEFAULT<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 流控效果为预热启动时的预热时长 
     * 默认10s
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> warmUpPeriodSec <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 流控效果为排队等待时的等待时长
     * 默认500
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxQueueingTimeMs <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 集群模式
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> clusterMode<span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 集群模式的流规则配置。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ClusterFlowConfig</span> clusterConfig<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 流量整形(节流)控制器。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">TrafficShapingController</span> controller<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractRule</span> <span class="token keyword">implements</span> <span class="token class-name">Rule</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * 规则id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 规则名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> resource<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 将受来源限制的应用程序名称。
     * 默认的limitApp是"default"，即允许所有源应用。
     * 
     * 对于权限规则，多个源名称可以用逗号（','）分隔。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> limitApp<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="3-2-插槽-FlowSlot"><a href="#3-2-插槽-FlowSlot" class="headerlink" title="(3.2) 插槽-FlowSlot"></a>(3.2) 插槽-FlowSlot</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 结合从前面的插槽(NodeSelectorSlot、ClusterNodeBuilderSlot 和 StatisticSlot)收集的
 * 运行时统计信息，FlowSlot 将使用预设规则来决定是否应阻止传入请求。
 *
 * 如果触发任何规则，SphU.entry(resourceName) 将抛出 FlowException。 
 * 用户可以通过捕获 FlowException 来自定义自己的逻辑。
 *
 * 一个资源可以有多个流规则。 FlowSlot 遍历这些规则，直到其中一条被触发或者所有规则都被遍历。
 *
 * 每个FlowRule主要由这些因素组成：等级、策略、路径。 我们可以结合这些因素来达到不同的效果。
 * 
 * 等级由 FlowRule 中的 grade 字段定义。 
 * 此处，0 用于线程隔离，1 用于请求计数整形 (QPS)。 
 * 线程计数和请求计数都是在真实运行时收集的，
 * 我们可以通过以下命令查看这些统计信息：
 * &lt;pre>
 * curl http://localhost:8719/tree
 *
 * idx id    thread pass  blocked   success total aRt   1m-pass   1m-block   1m-all   exception
 * 2   abc647 0      460    46          46   1    27      630       276        897      0
 * &lt;/pre>
 *
 * thread 当前正在处理资源的线程数 
 * pass 一秒内传入请求数 
 * blocked 一秒内被阻塞的请求数 
 * success 一秒内被Sentinel成功处理的请求数 
 * RT 请求在一秒内的平均响应时间 
 * total 一秒内传入请求和阻塞请求的总和 
 * 1m-pass 为一分钟内传入请求数 
 * 1m-block 为一分钟内被阻塞的请求数 
 * 1m-all 是一分钟内传入和阻止的请求总数 
 * exception 为一秒内业务（自定义）异常的计数 
 * 
 * 这个阶段通常用于保护资源不被占用。 (达到限流阈值，服务快撑不住了)
 * 如果资源需要很长时间才能完成，线程将开始占用。 响应时间越长，占用的线程越多。
 * 
 * 除了计数器之外，线程池或信号量也可以用来实现这一点。
 * - 线程池：分配一个线程池来处理这些资源。 当池中不再有空闲线程时，拒绝请求而不影响其他资源。
 * - 信号量：使用信号量来控制该资源中线程的并发数。
 * 
 * 使用线程池的好处是，超时可以优雅的走开。 但它也给我们带来了上下文切换和额外线程的成本。 
 * 如果传入请求已经在单独的线程中提供服务，例如 Servlet HTTP 请求，那么如果使用线程池，线程数几乎会翻倍。
 * 
 * 
 * 流量整形 
 * 当QPS超过阈值时，Sentinel会采取动作控制传入的请求，由流规则中的 controlBehavior 字段配置。
 *   1.立即拒绝(Immediately reject)：默认行为。 超出的请求立即被拒绝 并抛出 FlowException
 *   2.热启动(Warmup) : 如果一段时间以来系统的负载很低，大量的请求来了，系统可能无法一次处理所有这些请求。 
 *        然而，如果我们稳定地增加传入请求，系统可以预热并最终能够处理所有请求。 
 *        可以通过在流规则中设置字段 warmUpPeriodSec 来配置此预热期。
 *   3.统一速率限制  此策略严格控制请求之间的间隔。换句话说，它允许请求以稳定、统一的速率传递。
 *        https://raw.githubusercontent.com/wiki/alibaba/Sentinel/image/uniform-speed-queue.png 
 *        该策略是漏桶算法的实现  https://en.wikipedia.org/wiki/Leaky_bucket  
 *        它用于以稳定的速率处理请求，通常用于突发业务（例如消息处理）。
 *        当大量超出系统容量的请求同时到达时，使用此策略的系统将处理请求及其固定速率，直到所有请求都已处理或超时。
 */</span>
<span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>ORDER_FLOW_SLOT<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowSlot</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">FlowRuleChecker</span> checker<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FlowSlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlowRuleChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * Package-private for test.
     *
     * @param checker flow rule checker
     * @since 1.6.1
     */</span>
    <span class="token class-name">FlowSlot</span><span class="token punctuation">(</span><span class="token class-name">FlowRuleChecker</span> checker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">AssertUtil</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>checker<span class="token punctuation">,</span> <span class="token string">"flow checker should not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>checker <span class="token operator">=</span> checker<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>
                      <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 校验</span>
        <span class="token function">checkFlow</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 限流规则校验</span>
    <span class="token keyword">void</span> <span class="token function">checkFlow</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//   </span>
        checker<span class="token punctuation">.</span><span class="token function">checkFlow</span><span class="token punctuation">(</span>ruleProvider<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fireExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ruleProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Flow rule map should not be null.</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> flowRules <span class="token operator">=</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">getFlowRuleMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> flowRules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="3-2-1-流量控制规则的规则检查-FlowRuleChecker"><a href="#3-2-1-流量控制规则的规则检查-FlowRuleChecker" class="headerlink" title="(3.2.1) 流量控制规则的规则检查-FlowRuleChecker"></a>(3.2.1) 流量控制规则的规则检查-FlowRuleChecker</h3><p>  <code>FlowRuleChecker</code>的主要作用是 流量控制规则的规则检查</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 流量控制规则的规则检查器。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowRuleChecker</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkFlow</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ruleProvider<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span>
                          <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ruleProvider <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> resource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 获取资源对应的规则集合 </span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> rules <span class="token operator">=</span> ruleProvider<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 是否可以通过流量控制规则检查</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canPassCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 被限流，抛异常FlowException</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FlowException</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPassCheck</span><span class="token punctuation">(</span><span class="token comment">/*@NonNull*/</span> <span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span>
                                                <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> limitApp <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>limitApp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 是否是集群节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">isClusterMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 集群检查</span>
        <span class="token keyword">return</span> <span class="token function">passClusterCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 本地检查</span>
    <span class="token keyword">return</span> <span class="token function">passLocalCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">passLocalCheck</span><span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span>
                                      <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// </span>
    <span class="token class-name">Node</span> selectedNode <span class="token operator">=</span> <span class="token function">selectNodeByRequesterAndStrategy</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> rule<span class="token punctuation">.</span><span class="token function">getRater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">canPass</span><span class="token punctuation">(</span>selectedNode<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  */</span>
<span class="token keyword">static</span> <span class="token class-name">Node</span> <span class="token function">selectNodeByRequesterAndStrategy</span><span class="token punctuation">(</span><span class="token comment">/*@NonNull*/</span> <span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 限流服务 默认为default</span>
    <span class="token class-name">String</span> limitApp <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 流控策略</span>
    <span class="token keyword">int</span> strategy <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// </span>
    <span class="token class-name">String</span> origin <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>limitApp<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">filterOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 流控策略 = 直接拒绝</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_DIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Matches limit origin, return origin statistic node.</span>
            <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// </span>
        <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>LIMIT_APP_DEFAULT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// limitApp = "default" </span>
        <span class="token comment">// 流控策略 = 直接拒绝</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_DIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 返回集群节点</span>
            <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// </span>
        <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>LIMIT_APP_OTHER<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">isOtherOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// limitApp = "other" &amp;&amp; </span>
        <span class="token comment">// 流控策略 = 直接拒绝</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_DIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// </span>
        <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token class-name">Node</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 资源名</span>
    <span class="token class-name">String</span> refResource <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getRefResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 流控策略</span>
    <span class="token keyword">int</span> strategy <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>refResource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 流控策略-关联限流</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_RELATE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// </span>
        <span class="token keyword">return</span> <span class="token class-name">ClusterBuilderSlot</span><span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span>refResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 流控策略-链路限流</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_CHAIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>refResource<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// No node.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="3-3-流控效果-TrafficShapingController"><a href="#3-3-流控效果-TrafficShapingController" class="headerlink" title="(3.3) 流控效果-TrafficShapingController"></a>(3.3) 流控效果-TrafficShapingController</h2><p>  TrafficShapingController 实现类有3类共4个</p>
<p>  DefaultController      快速失败流控效果实现    默认节流控制器（立即拒绝策略）。<br>  RateLimiterController  排队等待流控效果实现<br>  WarmUpController       冷启动流控效果实现<br>  WarmUpRateLimiterController 冷启动排队等待流控效果实现</p>
<h3 id="3-3-1-默认快速失败限流-DefaultController"><a href="#3-3-1-默认快速失败限流-DefaultController" class="headerlink" title="(3.3.1) 默认快速失败限流-DefaultController"></a>(3.3.1) 默认快速失败限流-DefaultController</h3><p>  快速失败限流器</p>
<blockquote>
<p>如果  </p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 默认节流控制器（立即拒绝策略）。 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultController</span> <span class="token keyword">implements</span> <span class="token class-name">TrafficShapingController</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_AVG_USED_TOKENS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">double</span> count<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> grade<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultController</span><span class="token punctuation">(</span><span class="token keyword">double</span> count<span class="token punctuation">,</span> <span class="token keyword">int</span> grade<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>grade <span class="token operator">=</span> grade<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 1.获取已经使用的令牌 (qps数或线程数)
 * 2.如果 已使用数+申请数 &lt;= 阈值，通过
 * 3.如果 已使用数+申请数 > 阈值 
 *     判断是否允许 透支(使用下个窗口令牌)
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPass</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 当前令牌数  (qps数或线程数)</span>
    <span class="token keyword">int</span> curCount <span class="token operator">=</span> <span class="token function">avgUsedTokens</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断已使用令牌数和申请的令牌数 是否大于 配置的令牌数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curCount <span class="token operator">+</span> acquireCount <span class="token operator">></span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果阈值类型是QPS 并且 优先获取时，允许使用下个窗口令牌/透支</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prioritized <span class="token operator">&amp;&amp;</span> grade <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>FLOW_GRADE_QPS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">long</span> currentTime<span class="token punctuation">;</span>
            <span class="token keyword">long</span> waitInMs<span class="token punctuation">;</span>
            <span class="token comment">// 当前时间戳</span>
            currentTime <span class="token operator">=</span> <span class="token class-name">TimeUtil</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 预占用下个时间段的令牌</span>
            <span class="token comment">// 计算下一个时间窗口需要等待的时间</span>
            waitInMs <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">tryOccupyNext</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果等待时间 &lt; 最大等待超时时间</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>waitInMs <span class="token operator">&lt;</span> <span class="token class-name">OccupyTimeoutProperty</span><span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                node<span class="token punctuation">.</span><span class="token function">addWaitingRequest</span><span class="token punctuation">(</span>currentTime <span class="token operator">+</span> waitInMs<span class="token punctuation">,</span> acquireCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                node<span class="token punctuation">.</span><span class="token function">addOccupiedPass</span><span class="token punctuation">(</span>acquireCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span>waitInMs<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// PriorityWaitException indicates that the request will pass after waiting for &#123;@link @waitInMs&#125;.</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PriorityWaitException</span><span class="token punctuation">(</span>waitInMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 不通过 开始限流</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** 获取令牌个数 */</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">avgUsedTokens</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> DEFAULT_AVG_USED_TOKENS<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 线程个数 或 通过QPS数</span>
    <span class="token keyword">return</span> grade <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>FLOW_GRADE_THREAD <span class="token operator">?</span> node<span class="token punctuation">.</span><span class="token function">curThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">passQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>  StatisticNode::tryOccupyNext</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">tryOccupyNext</span><span class="token punctuation">(</span><span class="token keyword">long</span> currentTime<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span> <span class="token keyword">double</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// </span>
    <span class="token keyword">double</span> maxCount <span class="token operator">=</span> threshold <span class="token operator">*</span> <span class="token class-name">IntervalProperty</span><span class="token punctuation">.</span>INTERVAL <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token comment">// 当前时间窗口内已经预占的令牌数</span>
    <span class="token keyword">long</span> currentBorrow <span class="token operator">=</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">waiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBorrow <span class="token operator">>=</span> maxCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">OccupyTimeoutProperty</span><span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">int</span> windowLength <span class="token operator">=</span> <span class="token class-name">IntervalProperty</span><span class="token punctuation">.</span>INTERVAL <span class="token operator">/</span> <span class="token class-name">SampleCountProperty</span><span class="token punctuation">.</span>SAMPLE_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// 桶/时间窗口开始时间</span>
    <span class="token keyword">long</span> earliestTime <span class="token operator">=</span> currentTime <span class="token operator">-</span> currentTime <span class="token operator">%</span> windowLength <span class="token operator">+</span> windowLength <span class="token operator">-</span> <span class="token class-name">IntervalProperty</span><span class="token punctuation">.</span>INTERVAL<span class="token punctuation">;</span>

    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/*
     * Note: here &#123;@code currentPass&#125; may be less than it really is NOW, because time difference
     * since call rollingCounterInSecond.pass(). So in high concurrency, the following code may
     * lead more tokens be borrowed.
     */</span>

    <span class="token keyword">long</span> currentPass <span class="token operator">=</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算经过多少时间后可以申请到令牌</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>earliestTime <span class="token operator">&lt;</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> waitInMs <span class="token operator">=</span> idx <span class="token operator">*</span> windowLength <span class="token operator">+</span> windowLength <span class="token operator">-</span> currentTime <span class="token operator">%</span> windowLength<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>waitInMs <span class="token operator">>=</span> <span class="token class-name">OccupyTimeoutProperty</span><span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">long</span> windowPass <span class="token operator">=</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">getWindowPass</span><span class="token punctuation">(</span>earliestTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPass <span class="token operator">+</span> currentBorrow <span class="token operator">+</span> acquireCount <span class="token operator">-</span> windowPass <span class="token operator">&lt;=</span> maxCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> waitInMs<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        earliestTime <span class="token operator">+=</span> windowLength<span class="token punctuation">;</span>
        currentPass <span class="token operator">-=</span> windowPass<span class="token punctuation">;</span>
        idx<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token class-name">OccupyTimeoutProperty</span><span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>  StatisticNode</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">passQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">getWindowIntervalInSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>





<h1 id="4-sentinel限流规则初始化"><a href="#4-sentinel限流规则初始化" class="headerlink" title="(4) sentinel限流规则初始化"></a>(4) sentinel限流规则初始化</h1><ol>
<li>FlowRule对象用来存配置信息 </li>
<li>FlowRuleManager用来加载配置信息 </li>
<li>后台定时任务每秒获取一次最新配置 通过 MetricTimerListener 实现<br>  SentinelConfig初始化配置及获取最新配置<br>  MetricTimerListener 定时的数据采集，然后写到log文件里去 <pre><code>遍历集群节点 汇总统计的数据
</code></pre>
  StatisticNode 使用滑动窗口实时统计数据  </li>
</ol>
<h2 id="流控策略"><a href="#流控策略" class="headerlink" title="流控策略"></a>流控策略</h2><p>  LimitApp的作用域只在配置的流控策略为RuleConstant.STRATEGY_DIRECT（直接关联）时起作用。<br>    其有三种配置，分别为default，origin_name，other<br>    default 如果配置为default，表示统计不区分来源，当前资源的任何来源流量都会被统计（其实就是选择 Node 为 clusterNode 维度）<br>    origin_name 如果配置为指定名称的 origin_name，则只会对当前配置的来源流量做统计<br>    other 如果配置为other 则会对其他全部来源生效但不包括第二条配置的来源</p>
<p>  当策略配置为 RuleConstant.STRATEGY_RELATE 或 RuleConstant.STRATEGY_CHAIN 时<br>    STRATEGY_RELATE 关联其他的指定资源，如资源A想以资源B的流量状况来决定是否需要限流，这时资源A规则配置可以使用 STRATEGY_RELATE 策略<br>    STRATEGY_CHAIN 对指定入口的流量限流，因为流量可以有多个不同的入口（EntranceNode）</p>
<h2 id="流控策略校验"><a href="#流控策略校验" class="headerlink" title="流控策略校验"></a>流控策略校验</h2><p>  同一个资源名可以配置多条规则，规则的生效顺序为：{some_origin_name} &gt; other &gt; default</p>
<p>  校验 FlowRuleChecker#selectNodeByRequesterAndStrategy</p>
<p>  String limitApp = rule.getLimitApp(); // 不设置默认为default，设置了就是自己指定的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 调用方限流-直接限流-针对特定的调用者  origin变量 不为`default` 或 `other`，并且配置的limitApp和origin变量 相等</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>limitApp<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">filterOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_DIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Matches limit origin, return origin statistic node.</span>
        <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 调用方限流-直接限流-默认</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>LIMIT_APP_DEFAULT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_DIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Return the cluster node.</span>
        <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 调用方限流-直接限流-其它</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>LIMIT_APP_OTHER<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">isOtherOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_DIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// </span>
<span class="token keyword">static</span> <span class="token class-name">Node</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> refResource <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getRefResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> strategy <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>refResource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_RELATE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">ClusterBuilderSlot</span><span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span>refResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>STRATEGY_CHAIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>refResource<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// No node.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="流控效果-流量控制实现"><a href="#流控效果-流量控制实现" class="headerlink" title="流控效果  流量控制实现"></a>流控效果  流量控制实现</h2><p>  // 加载流控规则<br>  FlowRuleManager.loadRules(rules);</p>
<p>  com.alibaba.csp.sentinel.slots.block.flowFlowRuleUtil::buildFlowRuleMap</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Build the flow rule map from raw list of flow rules, grouping by provided group function.
 *
 * @param list          raw list of flow rules
 * @param groupFunction grouping function of the map (by key)
 * @param filter        rule filter
 * @param shouldSort    whether the rules should be sorted
 * @param &lt;K>           type of key
 * @return constructed new flow rule map; empty map if list is null or empty, or no wanted rules
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">></span></span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">buildFlowRuleMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">></span></span> groupFunction<span class="token punctuation">,</span>
                                                          <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> filter<span class="token punctuation">,</span> <span class="token keyword">boolean</span> shouldSort<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 存储所有的流控规则</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> newRuleMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> newRuleMap<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> tmpMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 循环加载流控规则 </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidRule</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[FlowRuleManager] Ignoring invalid flow rule when loading new flow rules: "</span> <span class="token operator">+</span> rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>filter<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            rule<span class="token punctuation">.</span><span class="token function">setLimitApp</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>LIMIT_APP_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 获取流控规则的阈值</span>
        <span class="token class-name">TrafficShapingController</span> rater <span class="token operator">=</span> <span class="token function">generateRater</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule<span class="token punctuation">.</span><span class="token function">setRater</span><span class="token punctuation">(</span>rater<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">K</span> key <span class="token operator">=</span> groupFunction<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> flowRules <span class="token operator">=</span> tmpMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>flowRules <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Use hash set here to remove duplicate rules.</span>
            flowRules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tmpMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> flowRules<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        flowRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> comparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRuleComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> entries <span class="token operator">:</span> tmpMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldSort<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Sort the rules.</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>rules<span class="token punctuation">,</span> comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        newRuleMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> newRuleMap<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 0. 直接拒绝(reject directly), </span>
<span class="token comment">// 1. 热启动(warm up), </span>
<span class="token comment">// 2. 匀速排队 rate limiter, </span>
<span class="token comment">// 3. 热启动 + 匀速排队 warm up + rate limiter</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">TrafficShapingController</span> <span class="token function">generateRater</span><span class="token punctuation">(</span><span class="token comment">/*@Valid*/</span> <span class="token class-name">FlowRule</span> rule<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 是否是QPS限流</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>FLOW_GRADE_QPS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getControlBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>CONTROL_BEHAVIOR_WARM_UP<span class="token operator">:</span>
                <span class="token comment">// 1  热启动 warm up   缓慢放量</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WarmUpController</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getWarmUpPeriodSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">ColdFactorProperty</span><span class="token punctuation">.</span>coldFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>CONTROL_BEHAVIOR_RATE_LIMITER<span class="token operator">:</span>
                <span class="token comment">// 3 热启动 + 匀速排队 warm up + rate limiter</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RateLimiterController</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getMaxQueueingTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>CONTROL_BEHAVIOR_WARM_UP_RATE_LIMITER<span class="token operator">:</span>
                <span class="token comment">// 2 匀速排队 rate limiter</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WarmUpRateLimiterController</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getWarmUpPeriodSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    rule<span class="token punctuation">.</span><span class="token function">getMaxQueueingTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ColdFactorProperty</span><span class="token punctuation">.</span>coldFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span>CONTROL_BEHAVIOR_DEFAULT<span class="token operator">:</span>
                <span class="token comment">// 直接拒绝</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">// Default mode or unknown mode: default traffic shaping controller (fast-reject).</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 直接拒绝 </span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultController</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luozhiyun/p/11439993.html">Sentinel源码分析—FlowRuleManager加载规则做了什么？</a><br>[2] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luozhiyun/p/11451557.html">Sentinel源码分析—Sentinel是如何进行流量统计的？</a><br>[3] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luozhiyun/p/11489128.html">Sentinel源码分析— QPS流量控制是如何实现的？</a><br>[4] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/taromilk/p/11877242.html">Sentinel源码解析四（流控策略和流控效果）</a><br>[5] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/wuzhenzhao/p/11453649.html">sentinel 滑动窗口 限流</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/11/22/sentinel-introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/22/sentinel-introduction/" class="post-title-link" itemprop="url">Sentinel学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-22 08:52:01" itemprop="dateCreated datePublished" datetime="2020-11-22T08:52:01+08:00">2020-11-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-01-14 23:05:51" itemprop="dateModified" datetime="2023-01-14T23:05:51+08:00">2023-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/stability/" itemprop="url" rel="index"><span itemprop="name">stability</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-什么是Sentinel"><a href="#1-什么是Sentinel" class="headerlink" title="(1) 什么是Sentinel"></a>(1) 什么是Sentinel</h1><p> <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/introduction.html">Sentinel介绍</a></p>
<p>  随着微服务的流行，服务和服务之间的稳定性变得越来越重要。<br>  Sentinel 是面向分布式、多语言异构化服务架构的流量治理组件，主要以流量为切入点，从流量路由、流量控制、流量整形、熔断降级、系统自适应过载保护、热点流量防护等多个维度来帮助开发者保障微服务的稳定性。</p>
<p>  <img src="/img/distributed/sentinel/sentinel-slot-chain-architecture.png" alt="Sentinel架构"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/11/22/sentinel-introduction/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/11/19/jvm-turning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/19/jvm-turning/" class="post-title-link" itemprop="url">JVM调优</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-19 10:18:43" itemprop="dateCreated datePublished" datetime="2020-11-19T10:18:43+08:00">2020-11-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-05-28 11:51:47" itemprop="dateModified" datetime="2022-05-28T11:51:47+08:00">2022-05-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/jvm/" itemprop="url" rel="index"><span itemprop="name">jvm</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  JVM调优前一定要只要遇到什么问题、优化后的目标。否则投入多收获少。得不偿失。</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.623+0800</span><span class="token operator">:</span> <span class="token number">5.285</span><span class="token operator">:</span> <span class="token punctuation">[</span>GC <span class="token operator">(</span>Allocation Failure<span class="token operator">)</span> <span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.624+0800</span><span class="token operator">:</span> <span class="token number">5.285</span><span class="token operator">:</span> <span class="token punctuation">[</span>ParNew2020<span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span>17T04<span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">16.648</span><span class="token operator">+</span><span class="token number">0800</span><span class="token operator">:</span> <span class="token number">5.309</span><span class="token operator">:</span> <span class="token punctuation">[</span>SoftReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0002508</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.648+0800</span><span class="token operator">:</span> <span class="token number">5.309</span><span class="token operator">:</span> <span class="token punctuation">[</span>WeakReference<span class="token punctuation">,</span> <span class="token number">332</span> refs<span class="token punctuation">,</span> <span class="token number">0.0001633</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.648+0800</span><span class="token operator">:</span> <span class="token number">5.310</span><span class="token operator">:</span> <span class="token punctuation">[</span>FinalReference<span class="token punctuation">,</span> <span class="token number">5452</span> refs<span class="token punctuation">,</span> <span class="token number">0.0057402</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.654+0800</span><span class="token operator">:</span> <span class="token number">5.315</span><span class="token operator">:</span> <span class="token punctuation">[</span>PhantomReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0002858</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:16.654+0800</span><span class="token operator">:</span> <span class="token number">5.316</span><span class="token operator">:</span> <span class="token punctuation">[</span>JNI Weak Reference<span class="token punctuation">,</span> <span class="token number">0.0000681</span> secs<span class="token punctuation">]</span>
Desired survivor size <span class="token number">107347968</span> bytes<span class="token punctuation">,</span> new threshold <span class="token number">6</span> <span class="token operator">(</span>max <span class="token number">6</span><span class="token operator">)</span>
<span class="token operator">-</span> age   <span class="token number">1</span><span class="token operator">:</span>   <span class="token number">17515352</span> bytes<span class="token punctuation">,</span>   <span class="token number">17515352</span> total
<span class="token operator">:</span> <span class="token number">1677824K</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">17187K</span><span class="token operator">(</span><span class="token number">1887488K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.0309183</span> secs<span class="token punctuation">]</span> <span class="token number">1677824K</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">17187K</span><span class="token operator">(</span><span class="token number">6081792K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.0310078</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.14</span> sys<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.03</span> secs<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2020-11-17T</span><span class="token time number">04:59:17.966+0800</span><span class="token operator">:</span> <span class="token number">6.628</span><span class="token operator">:</span> <span class="token punctuation">[</span>CMS<span class="token operator">-</span>concurrent<span class="token operator">-</span>abortable<span class="token operator">-</span>preclean<span class="token operator">:</span> <span class="token number">1.144</span><span class="token operator">/</span><span class="token number">1.845</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">4.88</span> sys<span class="token operator">=</span><span class="token number">0.32</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">1.84</span> secs<span class="token punctuation">]</span>
<span class="token date number">2020-11-17T</span><span class="token time number">04:59:17.966+0800</span><span class="token operator">:</span> <span class="token number">6.628</span><span class="token operator">:</span> <span class="token punctuation">[</span>GC <span class="token operator">(</span>CMS Final Remark<span class="token operator">)</span> <span class="token punctuation">[</span>YG occupancy<span class="token operator">:</span> <span class="token number">925231</span> K <span class="token operator">(</span><span class="token number">1887488</span> K<span class="token operator">)</span><span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:17.967+0800</span><span class="token operator">:</span> <span class="token number">6.628</span><span class="token operator">:</span> <span class="token punctuation">[</span>Rescan <span class="token operator">(</span>parallel<span class="token operator">)</span> <span class="token punctuation">,</span> <span class="token number">0.0808829</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.047+0800</span><span class="token operator">:</span> <span class="token number">6.709</span><span class="token operator">:</span> <span class="token punctuation">[</span>weak refs processing2020<span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span>17T04<span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">18.047</span><span class="token operator">+</span><span class="token number">0800</span><span class="token operator">:</span> <span class="token number">6.709</span><span class="token operator">:</span> <span class="token punctuation">[</span>SoftReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0002601</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.048+0800</span><span class="token operator">:</span> <span class="token number">6.709</span><span class="token operator">:</span> <span class="token punctuation">[</span>WeakReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0001719</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.048+0800</span><span class="token operator">:</span> <span class="token number">6.709</span><span class="token operator">:</span> <span class="token punctuation">[</span>FinalReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0001500</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.048+0800</span><span class="token operator">:</span> <span class="token number">6.709</span><span class="token operator">:</span> <span class="token punctuation">[</span>PhantomReference<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0</span> refs<span class="token punctuation">,</span> <span class="token number">0.0002673</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.048+0800</span><span class="token operator">:</span> <span class="token number">6.710</span><span class="token operator">:</span> <span class="token punctuation">[</span>JNI Weak Reference<span class="token punctuation">,</span> <span class="token number">0.0000138</span> secs<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0009146</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.048+0800</span><span class="token operator">:</span> <span class="token number">6.710</span><span class="token operator">:</span> <span class="token punctuation">[</span>class unloading<span class="token punctuation">,</span> <span class="token number">0.0111246</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.059+0800</span><span class="token operator">:</span> <span class="token number">6.721</span><span class="token operator">:</span> <span class="token punctuation">[</span>scrub symbol table<span class="token punctuation">,</span> <span class="token number">0.0063213</span> secs<span class="token punctuation">]</span><span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.066+0800</span><span class="token operator">:</span> <span class="token number">6.727</span><span class="token operator">:</span> <span class="token punctuation">[</span>scrub string table<span class="token punctuation">,</span> <span class="token number">0.0006271</span> secs<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span> CMS<span class="token operator">-</span>remark<span class="token operator">:</span> <span class="token number">0K</span><span class="token operator">(</span><span class="token number">4194304K</span><span class="token operator">)</span><span class="token punctuation">]</span> <span class="token number">925231K</span><span class="token operator">(</span><span class="token number">6081792K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.1009594</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.33</span> sys<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.10</span> secs<span class="token punctuation">]</span>
<span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.068+0800</span><span class="token operator">:</span> <span class="token number">6.729</span><span class="token operator">:</span> <span class="token punctuation">[</span>CMS<span class="token operator">-</span>concurrent<span class="token operator">-</span>sweep<span class="token operator">-</span>start<span class="token punctuation">]</span>
<span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.068+0800</span><span class="token operator">:</span> <span class="token number">6.729</span><span class="token operator">:</span> <span class="token punctuation">[</span>CMS<span class="token operator">-</span>concurrent<span class="token operator">-</span>sweep<span class="token operator">:</span> <span class="token number">0.000</span><span class="token operator">/</span><span class="token number">0.000</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.00</span> sys<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.00</span> secs<span class="token punctuation">]</span>
<span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.068+0800</span><span class="token operator">:</span> <span class="token number">6.729</span><span class="token operator">:</span> <span class="token punctuation">[</span>CMS<span class="token operator">-</span>concurrent<span class="token operator">-</span>reset<span class="token operator">-</span>start<span class="token punctuation">]</span>
<span class="token date number">2020-11-17T</span><span class="token time number">04:59:18.165+0800</span><span class="token operator">:</span> <span class="token number">6.827</span><span class="token operator">:</span> <span class="token punctuation">[</span>CMS<span class="token operator">-</span>concurrent<span class="token operator">-</span>reset<span class="token operator">:</span> <span class="token number">0.098</span><span class="token operator">/</span><span class="token number">0.098</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.11</span> sys<span class="token operator">=</span><span class="token number">0.08</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.10</span> secs<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>GC (Allocation Failure)<br>Concurrent Abortable Preclean<br>CMS-concurrent-abortable-preclean</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[] <a href=""></a><br>[] <a href=""></a><br>[] <a target="_blank" rel="noopener" href="https://club.perfma.com/article/1921017">JVM调优实战：解决CMS concurrent-abortable-preclean LongGC的问题</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/10/11/time-wheel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/10/11/time-wheel/" class="post-title-link" itemprop="url">时间轮笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-10-11 16:14:08" itemprop="dateCreated datePublished" datetime="2020-10-11T16:14:08+08:00">2020-10-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-01-14 22:32:20" itemprop="dateModified" datetime="2023-01-14T22:32:20+08:00">2023-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/basic/" itemprop="url" rel="index"><span itemprop="name">basic</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> 如果一台机器上有10w个定时任务，如何做到高效触发？</p>
<p> rpc调用时超时怎么实现？</p>
<p> 订单超时未支付变更订单状态怎么实现？</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/10/11/time-wheel/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/09/20/hystrix-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/20/hystrix-notes/" class="post-title-link" itemprop="url">Hystrix笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-20 21:32:17" itemprop="dateCreated datePublished" datetime="2020-09-20T21:32:17+08:00">2020-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-05-29 16:28:50" itemprop="dateModified" datetime="2022-05-29T16:28:50+08:00">2022-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/basic/" itemprop="url" rel="index"><span itemprop="name">basic</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>362</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> Hystrix是一个延迟和容错库，旨在隔离对远程系统，服务和第三方库的访问点，停止级联故障，并在不可避免发生故障的复杂分布式系统中实现弹性。 </p>
<p> Hystrix is a latency and fault tolerance library designed to isolate points of access to remote systems, services and 3rd party libraries, stop cascading failure and enable resilience in complex distributed systems where failure is inevitable. </p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/09/20/hystrix-notes/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/09/19/java-generics/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/19/java-generics/" class="post-title-link" itemprop="url">Java泛型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-19 14:12:39" itemprop="dateCreated datePublished" datetime="2020-09-19T14:12:39+08:00">2020-09-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-04 12:58:32" itemprop="dateModified" datetime="2022-06-04T12:58:32+08:00">2022-06-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>18k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>16 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　泛型主要解决了代码的复用问题。 提高了代码的抽象性。</p>
<h1 id="1-为什么会引入泛型"><a href="#1-为什么会引入泛型" class="headerlink" title="(1) 为什么会引入泛型"></a>(1) 为什么会引入泛型</h1><p>　泛型的意义：适用于多种数据类型执行相同的代码（代码复用） </p>
<p>　通过一个例子来阐述，先看下下面的代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">byte</span> x<span class="token punctuation">,</span> <span class="token keyword">byte</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">short</span> x<span class="token punctuation">,</span> <span class="token keyword">short</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>　如果没有泛型，要实现不同类型的加法，每种类型都需要重载一个add方法。</p>
<p>　通过泛型，我们可以复用为一个方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Number</span><span class="token punctuation">></span></span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">T</span> x<span class="token punctuation">,</span> <span class="token class-name">T</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/09/19/java-generics/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/09/12/java-reference/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/12/java-reference/" class="post-title-link" itemprop="url">Java里的引用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-12 15:41:37" itemprop="dateCreated datePublished" datetime="2020-09-12T15:41:37+08:00">2020-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-05-28 11:51:47" itemprop="dateModified" datetime="2022-05-28T11:51:47+08:00">2022-05-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="什么是Java里的引用"><a href="#什么是Java里的引用" class="headerlink" title="什么是Java里的引用"></a>什么是Java里的引用</h1><p>  引用可以理解为指针</p>
<h1 id="有什么用"><a href="#有什么用" class="headerlink" title="有什么用"></a>有什么用</h1><p>  不同引用不同用途<br>  强引用<br>  软引用<br>  弱引用<br>  虚引用 </p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/09/12/java-reference/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>
</div>
<div class="busuanzi-count">
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://unpkg.com/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
