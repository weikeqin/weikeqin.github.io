<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"weikeqin.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="不积跬步无以至千里">
<meta property="og:type" content="website">
<meta property="og:title" content="天道酬勤">
<meta property="og:url" content="http://weikeqin.com/page/4/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="不积跬步无以至千里">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="tech,Java,MySQL,Redis,ElasticSearch,DDD">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://weikeqin.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>天道酬勤</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113485469-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-113485469-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <script>
    !function(e,t,n,g,i){e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=('https:'==document.location.protocol?'https://':'http://')+g,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.growingio.com/2.1/gio.js","gio");
    gio('init', 'b1961366471d57d5', {});
    gio('send');
  </script>


  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">天道酬勤</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/weikeqin" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/07/10/thrift-client/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/10/thrift-client/" class="post-title-link" itemprop="url">thrift客户端</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-10 15:56:59" itemprop="dateCreated datePublished" datetime="2022-07-10T15:56:59+08:00">2022-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-11-27 23:54:40" itemprop="dateModified" datetime="2022-11-27T23:54:40+08:00">2022-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
                </span>
            </span>

          
            <span id="/2022/07/10/thrift-client/" class="post-meta-item leancloud_visitors" data-flag-title="thrift客户端" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/07/10/thrift-client/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/07/10/thrift-client/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-设计"><a href="#1-设计" class="headerlink" title="(1) 设计"></a>(1) 设计</h1><p>  TClient ，<br>  TStandardClient、WrappedTClient 实现了<code>TClient</code>接口的<code>Call</code>方法 </p>
<p> <img src=""></p>
<h1 id="2-demo"><a href="#2-demo" class="headerlink" title="(2) demo"></a>(2) demo</h1><p>  <a target="_blank" rel="noopener" href="https://github.com/weikeqin/thrift-tutorial-go-demo">https://github.com/weikeqin/thrift-tutorial-go-demo</a> </p>
<p>  以client调用add方法为例</p>
<p>  调用下游Add()方法代码 </p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 创建thrift client</span>
	thriftClient <span class="token operator">:=</span> <span class="token function">getThriftClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 创建 calculatorClientProxy   其实是一个代理类(静态代理) 代理了idl定义的所有方法</span>
	<span class="token comment">// tutorial是由idl生成的</span>
	calculatorClientProxy <span class="token operator">:=</span> tutorial<span class="token punctuation">.</span><span class="token function">NewCalculatorClient</span><span class="token punctuation">(</span>thriftClient<span class="token punctuation">)</span>
	<span class="token comment">// 调用Add方法</span>
	sum<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> calculatorClientProxy<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>defaultCtx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"1+2="</span><span class="token punctuation">,</span> sum<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/07/10/thrift-client/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/07/02/thrift-transport/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/02/thrift-transport/" class="post-title-link" itemprop="url">thrift 传输方式(Transport)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-02 15:19:24" itemprop="dateCreated datePublished" datetime="2022-07-02T15:19:24+08:00">2022-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-17 23:23:54" itemprop="dateModified" datetime="2022-07-17T23:23:54+08:00">2022-07-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
                </span>
            </span>

          
            <span id="/2022/07/02/thrift-transport/" class="post-meta-item leancloud_visitors" data-flag-title="thrift 传输方式(Transport)" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/07/02/thrift-transport/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/07/02/thrift-transport/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-传输方式-Transport-作用"><a href="#1-传输方式-Transport-作用" class="headerlink" title="(1) 传输方式(Transport)作用"></a>(1) 传输方式(Transport)作用</h1><p>  传输方式(Transport)作为rpc框架接收报文的入口，提供各种底层实现如socket创建、读写、接收连接等。<br>  同时实现各种复写传输层包括http、framed、buffered、压缩传输等。</p>
<h2 id="1-1-支持的传输方式"><a href="#1-1-支持的传输方式" class="headerlink" title="(1.1) 支持的传输方式"></a>(1.1) 支持的传输方式</h2><p>  thrift支持多种传输方式 </p>
<table>
<thead>
<tr>
<th>传输方式</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>TSocket</td>
<td>阻塞型 socket，用于客户端，采用系统函数 read 和 write 进行读写数据。</td>
</tr>
<tr>
<td>TServerSocket</td>
<td>非阻塞型 socket，用于服务器端，accecpt 到的 socket 类型都是 TSocket（即阻塞型 socket）。</td>
</tr>
<tr>
<td>TBufferedTransport</td>
<td></td>
</tr>
<tr>
<td>TFramedTransport</td>
<td></td>
</tr>
<tr>
<td>TMemoryBuffer</td>
<td></td>
</tr>
<tr>
<td>TFileTransport</td>
<td></td>
</tr>
<tr>
<td>TFDTransport</td>
<td></td>
</tr>
<tr>
<td>TSimpleFileTransport</td>
<td></td>
</tr>
<tr>
<td>TZlibTransport</td>
<td></td>
</tr>
<tr>
<td>TSSLSocket</td>
<td></td>
</tr>
<tr>
<td>TSSLServerSocket</td>
<td></td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/07/02/thrift-transport/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/06/26/thrift-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/26/thrift-design/" class="post-title-link" itemprop="url">thrift架构设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-26 19:01:13" itemprop="dateCreated datePublished" datetime="2022-06-26T19:01:13+08:00">2022-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-30 23:44:12" itemprop="dateModified" datetime="2022-07-30T23:44:12+08:00">2022-07-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
                </span>
            </span>

          
            <span id="/2022/06/26/thrift-design/" class="post-meta-item leancloud_visitors" data-flag-title="thrift架构设计" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/06/26/thrift-design/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/06/26/thrift-design/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  Thrift是一个轻量、支持多语言、可扩展、高性能的远程服务调用框架。<br>  提供了数据传输、序列化、应用层处理的清晰抽象。</p>
<p>The Apache Thrift software framework, for scalable cross-language services development, combines a software stack with a code generation engine to build services that work efficiently and seamlessly between C++, Java, Python, PHP, Ruby, Erlang, Perl, Haskell, C#, Cocoa, JavaScript, Node.js, Smalltalk, OCaml and Delphi and other languages.</p>
<h1 id="1-thrift架构分层"><a href="#1-thrift架构分层" class="headerlink" title="(1) thrift架构分层"></a>(1) thrift架构分层</h1><p>  <img src="/img/rpc/thrift/thrift-layers.png" alt="thrift-layers"></p>
<table>
<thead>
<tr>
<th>分层</th>
<th>职责</th>
</tr>
</thead>
<tbody><tr>
<td>服务调用层 (客户端/服务端)</td>
<td>客户端、服务端调用。</td>
</tr>
<tr>
<td>协议层</td>
<td>消息解析</td>
</tr>
<tr>
<td>传输层包装</td>
<td>功能增强，实现各种复写传输层包括http、framed、buffered、压缩传输等</td>
</tr>
<tr>
<td>低级传输层</td>
<td>靠近网络层、作为rpc框架接收报文的入口，提供各种底层实现如socket创建、读写、接收连接等。</td>
</tr>
<tr>
<td>语言层</td>
<td>thrift采用接口描述语言定义并创建服务，支持可扩展的跨语言服务开发</td>
</tr>
<tr>
<td>操作系统层</td>
<td>由编程语言提供各种操作系统的支持</td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/06/26/thrift-design/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/06/26/thrift-protocol/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/26/thrift-protocol/" class="post-title-link" itemprop="url">thrift 协议(TProtocol)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-26 17:07:14" itemprop="dateCreated datePublished" datetime="2022-06-26T17:07:14+08:00">2022-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-01-14 22:32:20" itemprop="dateModified" datetime="2023-01-14T22:32:20+08:00">2023-01-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
                </span>
            </span>

          
            <span id="/2022/06/26/thrift-protocol/" class="post-meta-item leancloud_visitors" data-flag-title="thrift 协议(TProtocol)" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/06/26/thrift-protocol/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/06/26/thrift-protocol/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>24 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>　协议大家平时都会遇到，只是没有特别注意。<br>　像平时大家阅读文章的时候都是从上到下、从左往右 按行阅读，这可以看做一种阅读协议。 ( 备注: 古人在竹简上写的文字则是从上往下、从右往左 按列阅读。)<br>　更详细的规则比如：作文的第一行是标题，段首要空两格的是一个自然段，遇到一个句号是一句话。</p>
<p>  详细的标点符号用法(通信协议)参考教育部的规范  <a target="_blank" rel="noopener" href="http://www.moe.gov.cn/ewebeditor/uploadfile/2015/01/13/20150113091548267.pdf">标点符号用法 - 教育部</a></p>
<p>  在计算机远程方法调用时，传输的都是二进制的01，调用方(写数据)和被调用方(读数据)怎么约定通信协议的？</p>
<h1 id="1-协议-TProtocol-的作用"><a href="#1-协议-TProtocol-的作用" class="headerlink" title="(1) 协议(TProtocol)的作用"></a>(1) 协议(TProtocol)的作用</h1><p>  协议的作用就类似于文字中的符号，作为应用拆解请求消息的边界，保证二进制数据经过网络传输后，还能被正确地还原语义。</p>
<p>  <img src="/img/rpc/protocol/rpc-protocol-v2.png"></p>
<p>  具体点就是从二进制数据中解析出<code>协议版本</code>、<code>方法名</code>、<code>消息类型</code>、<code>序列Id</code>、<code>序列化方式</code>、<code>消息长度</code>、<code>协议体</code>等内容。</p>
<p>  <img src="/img/rpc/thrift/protocol/thrift-protocol-message.png" alt="thrift-protocol-message"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/06/26/thrift-protocol/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/05/01/kafka-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/01/kafka-design/" class="post-title-link" itemprop="url">Kafka架构设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-01 11:14:43" itemprop="dateCreated datePublished" datetime="2022-05-01T11:14:43+08:00">2022-05-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-11-26 16:08:56" itemprop="dateModified" datetime="2022-11-26T16:08:56+08:00">2022-11-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/basic/" itemprop="url" rel="index"><span itemprop="name">basic</span></a>
                </span>
            </span>

          
            <span id="/2022/05/01/kafka-design/" class="post-meta-item leancloud_visitors" data-flag-title="Kafka架构设计" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/05/01/kafka-design/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/05/01/kafka-design/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>344</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  Kafka是一个消息队列。被大家用在分布式消息队列或者流数据处理场景。<br>  有几个问题，大家不知道思考过没有？<br>  1、Kafka有哪些组件，作用分别是什么，为什么这么设计？<br>  2、Kafka是怎么保证高性能、高并发、高可用的呢？</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/05/01/kafka-design/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/04/23/redis-log/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/23/redis-log/" class="post-title-link" itemprop="url">Redis日志</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-23 09:03:33" itemprop="dateCreated datePublished" datetime="2022-04-23T09:03:33+08:00">2022-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-05 22:14:04" itemprop="dateModified" datetime="2023-02-05T22:14:04+08:00">2023-02-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/04/23/redis-log/" class="post-meta-item leancloud_visitors" data-flag-title="Redis日志" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/04/23/redis-log/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/04/23/redis-log/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>54</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> redis里有 redis.log(程序运行日志)、slowlog(慢查询日志) 等</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="http://redisbook.com/preview/slowlog/content.html">slowlog</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/04/17/blog-speed-optimization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/17/blog-speed-optimization/" class="post-title-link" itemprop="url">博客访问速度优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-17 22:04:46" itemprop="dateCreated datePublished" datetime="2022-04-17T22:04:46+08:00">2022-04-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-12-04 21:17:40" itemprop="dateModified" datetime="2022-12-04T21:17:40+08:00">2022-12-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
                </span>
            </span>

          
            <span id="/2022/04/17/blog-speed-optimization/" class="post-meta-item leancloud_visitors" data-flag-title="博客访问速度优化" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/04/17/blog-speed-optimization/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/04/17/blog-speed-optimization/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>　　在原来coding pages服务和github pages服务都可以免费试用时，在域名解析时配置 国内访问coding pages部署的博客静态文件，国外访问github pages部署的静态文件。国内国外访问速度都基本都在200ms内。</p>
<p>  <img src="/img/blog/blog-domain-network-design-2020.jpg" alt="网站网络设计"></p>
<p>　　自从 coding.net 停止免费的pages服务后，只有github pages可以免费试用，国内访问博客只能访问github pages服务，导致访问速度很慢。被人吐槽了一次，所以想优化一下。</p>
<p>优化思路比较简单，<br>1、国内ip访问国内的博客服务  比如gitee pages服务<br>2、通过缓存加快访问速度  比如CDN缓存</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/17/blog-speed-optimization/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/03/26/elasticsearch-index-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/26/elasticsearch-index-model/" class="post-title-link" itemprop="url">elasticsearch索引模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-26 22:43:40" itemprop="dateCreated datePublished" datetime="2022-03-26T22:43:40+08:00">2022-03-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-11 23:33:24" itemprop="dateModified" datetime="2023-03-11T23:33:24+08:00">2023-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
                </span>
            </span>

          
            <span id="/2022/03/26/elasticsearch-index-model/" class="post-meta-item leancloud_visitors" data-flag-title="elasticsearch索引模型" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/03/26/elasticsearch-index-model/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/03/26/elasticsearch-index-model/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  一个shard就对应了一个lucene的library<br>  Elasticsearch索引使用的存储内容主要取决于lucene中的数据存储</p>
<h1 id="1-elasticsearch存储简介"><a href="#1-elasticsearch存储简介" class="headerlink" title="(1) elasticsearch存储简介"></a>(1) elasticsearch存储简介</h1><p>  Elasticsearch中的数据是如何存储</p>
<p>  Elasticsearch对外提供的是index的概念，可以类比为DB，<br>  用户查询是在index上完成的，每个index由若干个shard组成，以此来达到分布式可扩展的能力。</p>
<p>  <img src=""></p>
<p>  shard是Elasticsearch数据存储的最小单位，index的存储容量为所有shard的存储容量之和。<br>  Elasticsearch集群的存储容量则为所有index存储容量之和。</p>
<p>  一个shard就对应了一个lucene的library。对于一个shard，Elasticsearch增加了translog的功能，类似于MySQL的WAL(Write Ahead Log)日志，是数据写入过程中的中间数据，其余的数据都在lucene库中管理的。</p>
<table>
<thead>
<tr>
<th align="left">elasticsearch</th>
<th align="left">MySQL</th>
<th align="left">Excel</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Node/Cluster (分片)</td>
<td align="left">Cluster</td>
<td align="left">文件夹/Excel集合</td>
</tr>
<tr>
<td align="left">index(索引)</td>
<td align="left">Database(数据库)</td>
<td align="left">一个Excel</td>
</tr>
<tr>
<td align="left">Type</td>
<td align="left">Table(一个表)</td>
<td align="left">Excel里的一个Sheet</td>
</tr>
<tr>
<td align="left">Document (文档)</td>
<td align="left">Row(表里一行数据)</td>
<td align="left">Sheet里的一行</td>
</tr>
<tr>
<td align="left">field (字段)</td>
<td align="left">field(一个字段)</td>
<td align="left">Sheet里的一个单元格</td>
</tr>
</tbody></table>
<h1 id="2-lucene简介"><a href="#2-lucene简介" class="headerlink" title="(2) lucene简介"></a>(2) lucene简介</h1><p>lucene基本概念<br>segment : lucene内部的数据是由一个个segment组成的，写入lucene的数据并不直接落盘，而是先写在内存中，经过了refresh间隔，lucene才将该时间段写入的全部数据refresh成一个segment，segment多了之后会进行merge成更大的segment。lucene查询时会遍历每个segment完成。由于lucene* 写入的数据是在内存中完成，所以写入效率非常高。但是也存在丢失数据的风险，所以Elasticsearch基于此现象实现了translog，只有在segment数据落盘后，Elasticsearch才会删除对应的translog。<br>doc : doc表示lucene中的一条记录<br>field ：field表示记录中的字段概念，一个doc由若干个field组成。<br>term ：term是lucene中索引的最小单位，某个field对应的内容如果是全文检索类型，会将内容进行分词，分词的结果就是由term组成的。如果是不分词的字段，那么该字段的内容就是一个term。<br>倒排索引（inverted index）: lucene索引的通用叫法，即实现了term到doc list的映射。<br>正排数据：搜索引擎的通用叫法，即原始数据，可以理解为一个doc list。<br>docvalues :Elasticsearch中的列式存储的名称，Elasticsearch除了存储原始存储、倒排索引，还存储了一份docvalues，用作分析和排序。</p>
<h1 id="3-索引原理"><a href="#3-索引原理" class="headerlink" title="(3) 索引原理"></a>(3) 索引原理</h1><h2 id="3-1-新增数据"><a href="#3-1-新增数据" class="headerlink" title="(3.1) 新增数据"></a>(3.1) 新增数据</h2><h2 id="3-2-修改数据"><a href="#3-2-修改数据" class="headerlink" title="(3.2) 修改数据"></a>(3.2) 修改数据</h2><h2 id="3-3-删除数据"><a href="#3-3-删除数据" class="headerlink" title="(3.3) 删除数据"></a>(3.3) 删除数据</h2><h2 id="3-4-查询数据"><a href="#3-4-查询数据" class="headerlink" title="(3.4) 查询数据"></a>(3.4) 查询数据</h2><p>  根据主键id查询<br>  根据关键字查询 </p>
<h2 id="3-5-倒排索引合并"><a href="#3-5-倒排索引合并" class="headerlink" title="(3.5) 倒排索引合并"></a>(3.5) 倒排索引合并</h2><p>  <a target="_blank" rel="noopener" href="https://blog.csdn.net/alex_xfboy/article/details/85328787">Lucene系列七：倒排数组合并</a></p>
<p>  MySQL里经常会有 <code>SELECT * FROM table_user WHERE city=&#39;北京&#39; and user_name = &#39;lisi&#39; </code><br>  elasticsearch里也会有类似的查询 </p>
<p>  单个词匹配可以得到这个term的倒排链(docId列表)<br>  lucene的优势在哪呢？<br>  问题其实就变成了求有序集合求并集的问题</p>
<h3 id="多个有序集合求并集"><a href="#多个有序集合求并集" class="headerlink" title="多个有序集合求并集"></a>多个有序集合求并集</h3><p>  <a target="_blank" rel="noopener" href="https://www.infoq.cn/article/database-timestamp-02">时间序列数据库的秘密 (2)——索引</a></p>
<p>  elasticsearch 利用 Skip List 合并</p>
<p>  把多个 posting list 用 AND 的关系合并，得出 posting list 的交集</p>
<p>  每个 list 需要指出 Advance 这个操作，快速移动指向的位置。什么样的 list 可以这样 Advance 往前做蛙跳？skip list</p>
<p>  利用 bitset 合并</p>
<p><strong>(1) 多层for循环</strong></p>
<p>  最简单的办法是多层for循环，这样的时间复杂度是 O(n^x)，这个明显是不能接受的。<br>  两层是 O(n^2)，三层是O(n^3)</p>
<p><strong>(2) 拉链法</strong> </p>
<p>  有序集合1 {1,3,5,7,8,9} 和 有序集合2 {2,3,4,5,6,7}，两个指针指向首元素，比较元素的大小（如果相同，放入结果集，随意移动一个指针，否则，移动值较小的一个指针，直到队尾），</p>
<p>  优势（集合中的元素最多被比较一次，时间复杂度为O(n)，多个有序集合可以同时进行，这适用于多个分词的item求url_id交集）<br>  这个方法就像一条拉链的两边齿轮，一一比对就像拉链，故称为拉链法</p>
<p><strong>(3) 水平分桶</strong> </p>
<p>  水平分桶，多线程并行</p>
<p>  有序集合1{1,3,5,7,8,9, 10,30,50,70,80,90} 和 有序集合2{2,3,4,5,6,7, 20,30,40,50,60,70}，先进行分桶拆分【桶1的范围为[1, 9]、桶2的范围为[10, 100]、桶3的范围为[101, max_int]】，<br>  于是拆分成集合1【a={1,3,5,7,8,9}、b={10,30,50,70,80,90}、c={}】和 集合2【d={2,3,4,5,6,7}、e={20,30,40,50,60,70}、e={}】，<br>  利用多线程对桶1（a和d）、桶2（b和e）、桶3（c和e）分别求交集，最后求并集。</p>
<p>  每个区间利用多线程并行求交集，各个线程结果集的并集，作为最终的结果集，能够大大的减少执行时间</p>
<p><strong>(4) bitmap</strong></p>
<p>  bitmap，大大提高运算并行度，时间复杂度O(n)</p>
<p>  假设list1{1,3,5,7,8,9} 和 list2{2,3,4,5,6,7} 的所有元素都在桶值[1, 16]的范围之内，可以用16个bit来描述这两个集合，原集合中的元素x，在这个16bitmap中的第x个bit为1，此时两个bitmap求交集，只需要将两个bitmap进行”与”操作，结果集bitmap的3，5，7位是1，表明原集合的交集为{3,5,7}</p>
<p>  水平分桶（每个桶内的数据一定处于一个范围之内），使用bitmap来表示集合，能极大提高求交集的效率，但时间复杂度仍旧是O(n)，但bitmap需要大量连续空间，占用内存较大。</p>
<p>  从Lucene 5 开始采用了一种改进的位图方式，即roaring bitmaps ( 官网<a target="_blank" rel="noopener" href="http://roaringbitmap.org/">http://roaringbitmap.org/</a> )，它是一个压缩性能比bitmap更好的位图实现。</p>
<p><strong>(5) 跳表</strong><br>  跳表，时间复杂度为O(log(n))</p>
<p>  集合1 {1,2,3,4,20,21,22,23,50,60,70}  和  集合2{50,70} 求交集，如果用拉链法，会发现1,2,3,4,20,21,22,23都要被无效遍历一次，每个元素都要被比对，时间复杂度为O(n)，能不能每次比对“跳过一些元素”呢？集合1{1,2,3,4,20,21,22,23,50,60,70}建立跳表时，一级只有{1,20,50}三个元素，二级与普通链表相同，集合2{50,70}由于元素较少，只建立了一级普通链表。这样在进行拉链法时，复杂度由O(n)降至O(log(n))</p>
<h1 id="4-lucene索引实现"><a href="#4-lucene索引实现" class="headerlink" title="(4) lucene索引实现"></a>(4) lucene索引实现</h1><p>Lucene简介、索引原理、Lucene索引实现 </p>
<p>Lucene现使用的倒排表结构叫Frame of reference,它主要有两个特点：<br>　　1. 数据压缩，可以看下图怎么将6个数字从原先的24bytes压缩到7bytes。<br>　　2. 跳跃表加速合并，因为布尔查询时，and 和or 操作都需要合并倒排表，这时就需要快速定位相同文档号，所以利用跳跃表来进行相同文档号查找。</p>
<p>  ElasticSearch倒排表  <a target="_blank" rel="noopener" href="https://www.elastic.co/cn/blog/frame-of-reference-and-roaring-bitmaps">https://www.elastic.co/cn/blog/frame-of-reference-and-roaring-bitmaps</a>  </p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/sessionbest/articles/8689030.html">Lucene底层实现原理，它的索引结构</a><br>[2] <a target="_blank" rel="noopener" href="https://www.cxyzjd.com/article/star1210644725/110675823">Elasticsearch 存储原理-lucene底层数据结构</a><br>[3] <a target="_blank" rel="noopener" href="https://dragonsong.tech/posts/rd/es/index_structure/">简析ES/Lucene索引的基本设计原理</a><br>[4] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/cangqinglang/p/15540047.html">Elasticsearch 如何做到快速检索 - 倒排索引的秘密 </a><br>[5] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/137574234"></a><br>[] <a target="_blank" rel="noopener" href="https://www.infoq.cn/article/database-timestamp-02">时间序列数据库的秘密 (2)——索引</a></p>
<p>[] <a target="_blank" rel="noopener" href="https://www.elastic.co/cn/blog/frame-of-reference-and-roaring-bitmaps">Frame of Reference and Roaring Bitmaps</a><br>[] <a target="_blank" rel="noopener" href="https://www.elastic.co/cn/blog/found-elasticsearch-from-the-bottom-up"></a><br>[] <a target="_blank" rel="noopener" href="http://blog.mikemccandless.com/2014/05/choosing-fast-unique-identifier-uuid.html"></a></p>
<p>[10] <a target="_blank" rel="noopener" href="https://www.infoq.cn/article/ejeg02vroegvalw4j_ll">Lucene 查询原理及解析</a><br>[11] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/bonelee/p/6226185.html">lucene字典实现原理——FST</a><br>[12] <a target="_blank" rel="noopener" href="https://blog.csdn.net/u014274324/article/details/107127456">Lucene查询分析</a><br>[13] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/rsapaper/p/13625987.html">Lucene 查询原理</a><br>[14] <a target="_blank" rel="noopener" href="https://blog.csdn.net/alex_xfboy/article/details/85328787">Lucene系列七：倒排数组合并</a><br>[15] <a target="_blank" rel="noopener" href="https://blog.csdn.net/star1210644725/article/details/110675823">Elasticsearch 存储原理-lucene底层数据结构</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/03/06/redis-cache-eviction-strategy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/06/redis-cache-eviction-strategy/" class="post-title-link" itemprop="url">Redis 缓存淘汰策略</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-06 19:32:45" itemprop="dateCreated datePublished" datetime="2022-03-06T19:32:45+08:00">2022-03-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-04-16 18:14:42" itemprop="dateModified" datetime="2023-04-16T18:14:42+08:00">2023-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/03/06/redis-cache-eviction-strategy/" class="post-meta-item leancloud_visitors" data-flag-title="Redis 缓存淘汰策略" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/03/06/redis-cache-eviction-strategy/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/03/06/redis-cache-eviction-strategy/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>39k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>35 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-缓存淘汰是什么"><a href="#1-缓存淘汰是什么" class="headerlink" title="(1) 缓存淘汰是什么"></a>(1) 缓存淘汰是什么</h1><h1 id="2-为什么要缓存淘汰"><a href="#2-为什么要缓存淘汰" class="headerlink" title="(2) 为什么要缓存淘汰"></a>(2) 为什么要缓存淘汰</h1><h1 id="3-缓存淘汰算法-页面置换算法原理"><a href="#3-缓存淘汰算法-页面置换算法原理" class="headerlink" title="(3) 缓存淘汰算法/页面置换算法原理"></a>(3) 缓存淘汰算法/页面置换算法原理</h1><h2 id="3-1-LRU"><a href="#3-1-LRU" class="headerlink" title="(3.1) LRU"></a>(3.1) LRU</h2><p>  LRU 算法背后的想法非常朴素：它认为刚刚被访问的数据，肯定还会被再次访问。<br>  选择最近最久未被使用的数据进行淘汰。</p>
<p>优点：</p>
<p>不足：<br>  可能造成缓存污染。</p>
<p><code>缓存污染</code>：在一些场景下，有些数据被访问的次数非常少，甚至只会被访问一次。当这些数据服务完访问请求后，如果还继续留存在缓存中的话，就只会白白占用缓存空间。</p>
<p>  典型场景：全表扫描，对所有数据进行一次读取，每个数据都被读取到了，</p>
<h2 id="3-2-LFU"><a href="#3-2-LFU" class="headerlink" title="(3.2) LFU"></a>(3.2) LFU</h2><p>  记录数据被访问的频率，选择在最近使用最少的数据进行淘汰。</p>
<p>  LFU算法是根据数据访问的频率来选择被淘汰数据的，所以LFU算法会记录每个数据的访问次数。当一个数据被再次访问时，就会增加该数据的访问次数。</p>
<p>  不过，访问次数和访问频率还不能完全等同。访问频率是指在一定时间内的访问次数，也就是说，在计算访问频率时，我们不仅需要记录访问次数，还要记录这些访问是在多长时间内执行的。</p>
<br>


<h1 id="4-Redis里缓存有哪些淘汰策略"><a href="#4-Redis里缓存有哪些淘汰策略" class="headerlink" title="(4) Redis里缓存有哪些淘汰策略"></a>(4) Redis里缓存有哪些淘汰策略</h1><table>
<thead>
<tr>
<th align="left">内存淘汰策略</th>
<th align="left">解释</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">noeviction</td>
<td align="left">不进行数据淘汰</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">allkeys-random</td>
<td align="left">在所有key里随机筛选数据</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">allkeys-lru</td>
<td align="left">在所有key里筛选最近最久未使用的数据</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">allkeys-lfu</td>
<td align="left">在所有key里筛选最近最少使用的数据</td>
<td align="left">Redis 4.0 新增</td>
</tr>
<tr>
<td align="left">volatile-ttl</td>
<td align="left">在有过期时间key里根据过期时间的先后筛选</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">volatile-random</td>
<td align="left">在有过期时间key里随机筛选数据</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">volatile-lru</td>
<td align="left">在有过期时间key里筛选最近最久未使用的数据</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">volatile-lfu</td>
<td align="left">在有过期时间key里筛选最近最少使用的数据</td>
<td align="left">Redis 4.0 新增</td>
</tr>
</tbody></table>
<p>lru (Least Recently Used)   最近最久未使用<br>lfu (Least Frequently Used)  最近最少使用</p>
<p>  在redis3.0之前，默认淘汰策略是<code>volatile-lru</code>；在redis3.0及之后(包括3.0)，默认淘汰策略是<code>noeviction</code>。</p>
<p>  在3.0及之后的版本，Redis 在使用的内存空间超过 maxmemory 值时，并不会淘汰数据。</p>
<p>  对应到 Redis 缓存，也就是指，一旦缓存被写满了，再有写请求来时，Redis 不再提供服务，而是直接返回错误。</p>
<h2 id="4-1-Redis内存淘汰机制如何启用"><a href="#4-1-Redis内存淘汰机制如何启用" class="headerlink" title="(4.1) Redis内存淘汰机制如何启用"></a>(4.1) Redis内存淘汰机制如何启用</h2><p>  Redis 的内存淘汰机制是如何启用近似 LRU 算法的</p>
<p>和Redis配置文件<code>redis.conf</code>中的两个配置参数有关：</p>
<p>  <code>maxmemory</code>，该配置项设定了 Redis server 可以使用的最大内存容量，一旦 server 使用的实际内存量超出该阈值时，server 就会根据 maxmemory-policy 配置项定义的策略，执行内存淘汰操作；</p>
<p>  <code>maxmemory-policy</code>，该配置项设定了 Redis server 的内存淘汰策略，主要包括近似 LRU 算法、LFU 算法、按 TTL 值淘汰和随机淘汰等几种算法。</p>
<br>


<h1 id="5-Redis里缓存淘汰算法原理"><a href="#5-Redis里缓存淘汰算法原理" class="headerlink" title="(5) Redis里缓存淘汰算法原理"></a>(5) Redis里缓存淘汰算法原理</h1><h2 id="5-1-Redis-LRU"><a href="#5-1-Redis-LRU" class="headerlink" title="(5.1) Redis-LRU"></a>(5.1) Redis-LRU</h2><p>  LRU 算法在实际实现时，需要用链表管理所有的缓存数据，这会带来额外的空间开销。</p>
<p>  而且，当有数据被访问时，需要在链表上把该数据移动到 MRU 端，如果有大量数据被访问，就会带来很多链表移动操作，会很耗时，进而会降低 Redis 性能。</p>
<p>  在 Redis 中，LRU 算法被做了简化，以减轻数据淘汰对缓存性能的影响。</p>
<p>  Redis 并没有为所有的数据维护一个全局的链表，而是通过随机采样方式，选取一定数量（例如 100 个）的数据放入候选集合，后续在候选集合中根据 lru 字段值的大小进行筛选。</p>
<!--
  具体来说，Redis 默认会记录每个数据的最近一次访问的时间戳（由键值对数据结构 RedisObject 中的 lru 字段记录）。
  然后，Redis 在决定淘汰的数据时，第一次会随机选出 N 个数据，把它们作为一个候选集合。接下来，Redis 会比较这 N 个数据的 lru 字段，把 lru 字段值最小的数据从缓存中淘汰出去。

Redis 提供了一个配置参数 maxmemory-samples，这个参数就是 Redis 选出的数据个数 N。

 我们执行如下命令，可以让 Redis 选出 100 个数据作为候选数据集：

CONFIG SET maxmemory-samples 100

当需要再次淘汰数据时，Redis 需要挑选数据进入第一次淘汰时创建的候选集合。这儿的挑选标准是：能进入候选集合的数据的 lru 字段值必须小于候选集合中最小的 lru 值。当有新数据进入候选数据集后，如果候选数据集中的数据个数达到了 maxmemory-samples，Redis 就把候选数据集中 lru 字段值最小的数据淘汰出去。

这样一来，Redis 缓存不用为所有的数据维护一个大链表，也不用在每次数据访问时都移动链表项，提升了缓存的性能。

-->


<h2 id="3-2-Redis-LFU"><a href="#3-2-Redis-LFU" class="headerlink" title="(3.2) Redis-LFU"></a>(3.2) Redis-LFU</h2><p>  LFU 缓存策略是在 LRU 策略基础上，为每个数据增加了一个计数器，来统计这个数据的访问次数。</p>
<p>  当使用 LFU 策略筛选淘汰数据时，首先会根据数据的访问次数进行筛选，把访问次数最低的数据淘汰出缓存。<br>  如果两个数据的访问次数相同，LFU 策略再比较这两个数据的访问时效性，把距离上一次访问时间更久的数据淘汰出缓存。</p>
<p>Redis 在实现 LFU 策略的时候，只是把原来 24bit 大小的 lru 字段，又进一步拆分成了两部分。<br>ldt 值：lru 字段的前 16bit，表示数据的访问时间戳；<br>counter 值：lru 字段的后 8bit，表示数据的访问次数。</p>
<p>在实现 LFU 策略时，Redis 并没有采用数据每被访问一次，就给对应的 counter 值加 1 的计数规则，而是采用了一个更优化的计数规则。</p>
<p>LFU 策略实现的计数规则是：每当数据被访问一次时，首先，用计数器当前的值乘以配置项 lfu_log_factor 再加 1，再取其倒数，得到一个 p 值；然后，把这个 p 值和一个取值范围在（0，1）间的随机数 r 值比大小，只有 p 值大于 r 值时，计数器才加 1。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">double</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>RAND_MAX<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">double</span> p <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>baseval<span class="token operator">*</span>server<span class="token punctuation">.</span>lfu_log_factor<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> p<span class="token punctuation">)</span> counter<span class="token operator">++</span><span class="token punctuation">;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<br>


<h1 id="4-LRU源码解读"><a href="#4-LRU源码解读" class="headerlink" title="(4) LRU源码解读"></a>(4) LRU源码解读</h1><h2 id="4-1-全局LRU时钟值的计算"><a href="#4-1-全局LRU时钟值的计算" class="headerlink" title="(4.1) 全局LRU时钟值的计算"></a>(4.1) 全局LRU时钟值的计算</h2><p>   LRU算法需要知道数据的最近一次访问时间。因此，Redis设计了LRU时钟来记录数据每次访问的时间戳。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.h </span>

<span class="token comment">/*
 * redis对象
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObject</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 数据类型 （string/list/hash/set/zset等）</span>
    <span class="token keyword">unsigned</span> encoding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 编码方式 </span>
    <span class="token keyword">unsigned</span> lru<span class="token operator">:</span>LRU_BITS<span class="token punctuation">;</span>  <span class="token comment">// LRU时间(相对于全局 lru_clock) </span>
                            <span class="token comment">// 或 LFU数据(低8位保存频率 和 高16位保存访问时间)。  </span>
                            <span class="token comment">// LRU_BITS为24个bits</span>
    <span class="token keyword">int</span> refcount<span class="token punctuation">;</span>  <span class="token comment">// 引用计数  4字节</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>  <span class="token comment">// 指针 指向对象的值  8字节</span>
<span class="token punctuation">&#125;</span> robj<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.c</span>

<span class="token keyword">void</span> <span class="token function">initServerConfig</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 计算全局LRU时钟值</span>
    server<span class="token punctuation">.</span>lruclock <span class="token operator">=</span> <span class="token function">getLRUClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* 
 * 根据时钟分辨率返回 LRU 时钟。 
 * 这是一个减少位格式的时间，可用于设置和检查 redisObject 结构的 object->lru 字段。
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">getLRUClock</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// mstime()是毫秒时间戳  // mstime()/1000=秒级时间戳</span>
    <span class="token comment">// 与运算 保证值 &lt;= LRU_CLOCK_MAX</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">mstime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>LRU_CLOCK_RESOLUTION<span class="token punctuation">)</span> <span class="token operator">&amp;</span> LRU_CLOCK_MAX<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  从代码可以看出，LRU时钟精度是1000毫秒，也就是1秒。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LRU_BITS</span> <span class="token expression"><span class="token number">24</span></span></span>

<span class="token comment">// obj->lru的最大值 // LRU_CLOCK_MAX = 1^24 - 1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LRU_CLOCK_MAX</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>LRU_BITS<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> </span><span class="token comment">/* Max value of obj->lru */</span></span>

<span class="token comment">// LRU 时钟分辨率(毫秒)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LRU_CLOCK_RESOLUTION</span> <span class="token expression"><span class="token number">1000</span> </span><span class="token comment">/* LRU clock resolution in ms */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.c</span>

<span class="token comment">/* 
 * 返回UNIX毫秒时间戳
 * Return the UNIX time in milliseconds 
 */</span>
<span class="token class-name">mstime_t</span> <span class="token function">mstime</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">ustime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.c</span>

<span class="token comment">/*
 * 返回UNIX微秒时间戳 
 * Return the UNIX time in microseconds 
 */</span>
<span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">ustime</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> ust<span class="token punctuation">;</span>

    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ust <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>tv<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000000</span><span class="token punctuation">;</span>
    ust <span class="token operator">+=</span> tv<span class="token punctuation">.</span>tv_usec<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ust<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="4-2-在运行过程中LRU时钟值是如何更新的"><a href="#4-2-在运行过程中LRU时钟值是如何更新的" class="headerlink" title="(4.2) 在运行过程中LRU时钟值是如何更新的"></a>(4.2) 在运行过程中LRU时钟值是如何更新的</h2><p>  和 Redis server 在事件驱动框架中，定期运行的时间事件所对应的 serverCron 函数有关。</p>
<p>  serverCron 函数作为时间事件的回调函数，本身会按照一定的频率周期性执行，其频率值是由 Redis 配置文件 redis.conf 中的 hz 配置项决定的。</p>
<p>  hz 配置项的默认值是 10，这表示 serverCron 函数会每 100 毫秒(1秒 / 10 = 100 毫秒)运行一次。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.c</span>

<span class="token comment">/* This is our timer interrupt, called server.hz times per second.
 * Here is where we do a number of things that need to be done asynchronously.
 * For instance:
 *
 * - Active expired keys collection (it is also performed in a lazy way on
 *   lookup).
 * - Software watchdog.
 * - Update some statistic.
 * - Incremental rehashing of the DBs hash tables.
 * - Triggering BGSAVE / AOF rewrite, and handling of terminated children.
 * - Clients timeout of different kinds.
 * - Replication reconnection.
 * - Many more...
 *
 * Everything directly called here will be called server.hz times per second,
 * so in order to throttle execution of things we want to do less frequently
 * a macro is used: run_with_period(milliseconds) &#123; .... &#125;
 */</span>

<span class="token keyword">int</span> <span class="token function">serverCron</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">aeEventLoop</span> <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/* We have just LRU_BITS bits per object for LRU information.
     * So we use an (eventually wrapping) LRU clock.
     *
     * Note that even if the counter wraps it's not a big problem,
     * everything will still work but some object will appear younger
     * to Redis. However for this to happen a given object should never be
     * touched for all the time needed to the counter to wrap, which is
     * not likely.
     *
     * Note that you can change the resolution altering the
     * LRU_CLOCK_RESOLUTION define. */</span>
    <span class="token comment">// 默认情况下，每100毫秒调用getLRUClock函数更新一次全局LRU时钟值 </span>
    server<span class="token punctuation">.</span>lruclock <span class="token operator">=</span> <span class="token function">getLRUClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  这样一来，每个键值对就可以从全局 LRU 时钟获取最新的访问时间戳了。</p>
<h2 id="4-3-key-value-LRU时钟值的初始化与更新"><a href="#4-3-key-value-LRU时钟值的初始化与更新" class="headerlink" title="(4.3) key-value-LRU时钟值的初始化与更新"></a>(4.3) key-value-LRU时钟值的初始化与更新</h2><h3 id="4-3-1-key-LRU时钟初始化"><a href="#4-3-1-key-LRU时钟初始化" class="headerlink" title="(4.3.1) key-LRU时钟初始化"></a>(4.3.1) key-LRU时钟初始化</h3><p>  对于key-value来说，它的 LRU 时钟值最初是在这个键值对被创建的时候，进行初始化设置的，这个初始化操作是在 createObject 函数中调用的。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/object.c</span>

<span class="token comment">/*
 * 创建一个redisObject对象
 *
 * @param type redisObject的类型
 * @param *ptr 值的指针
 */</span>
robj <span class="token operator">*</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 为redisObject结构体分配内存空间</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">// 省略部分代码 </span>

    <span class="token comment">// 将lru字段设置为当前的 lruclock（分钟分辨率），或者 LFU 计数器。 </span>
    <span class="token comment">// 判断内存过期策略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lfu </span>
        <span class="token comment">// LFU_INIT_VAL=5 对应二进制是 0101 </span>
        <span class="token comment">// 或运算 </span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lru </span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="4-3-2-key-LRU时钟更新"><a href="#4-3-2-key-LRU时钟更新" class="headerlink" title="(4.3.2) key-LRU时钟更新"></a>(4.3.2) key-LRU时钟更新</h3><p>  只要一个key被访问了，它的 LRU 时钟值就会被更新。而当一个键值对被访问时，访问操作最终都会调用 <code>lookupKey</code> 函数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/db.c</span>

<span class="token comment">/* 
 * 低级key查找API
 * 实际上并没有直接从应该依赖lookupKeyRead()、lookupKeyWrite()和lookupKeyReadWithFlags()的命令实现中调用。
 */</span>
robj <span class="token operator">*</span><span class="token function">lookupKey</span><span class="token punctuation">(</span>redisDb <span class="token operator">*</span>db<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    dictEntry <span class="token operator">*</span>de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>db<span class="token operator">-></span>dict<span class="token punctuation">,</span>key<span class="token operator">-></span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果节点存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 从节点里获取redisObject</span>
        robj <span class="token operator">*</span>val <span class="token operator">=</span> <span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* 
         * 更新老化算法的访问时间。
         * 如果我们有一个正在保存的子进程，请不要这样做，因为这会触发疯狂写入副本。
         */</span>
        <span class="token comment">// 没有活跃子进程 并且  </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasActiveChildProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> LOOKUP_NOTOUCH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 更新lfu</span>
                <span class="token function">updateLFU</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 更新lru时间</span>
                val<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<br>


<h2 id="4-4-近似LRU算法的实际执行"><a href="#4-4-近似LRU算法的实际执行" class="headerlink" title="(4.4) 近似LRU算法的实际执行"></a>(4.4) 近似LRU算法的实际执行</h2><p>  Redis 之所以实现近似 LRU 算法的目的，是为了减少内存资源和操作时间上的开销。<br>  何时触发算法执行？<br>  算法具体如何执行？</p>
<h3 id="4-4-1-触发时机"><a href="#4-4-1-触发时机" class="headerlink" title="(4.4.1) 触发时机"></a>(4.4.1) 触发时机</h3><p>  近似 LRU 算法的主要逻辑是在 freeMemoryIfNeeded 函数中实现的</p>
<p>  processCommand -&gt; freeMemoryIfNeededAndSafe -&gt; freeMemoryIfNeeded</p>
<h3 id="4-4-2-近似LRU算法执行"><a href="#4-4-2-近似LRU算法执行" class="headerlink" title="(4.4.2) 近似LRU算法执行"></a>(4.4.2) 近似LRU算法执行</h3><p>主要分3大步</p>
<ol>
<li>判断当前内存使用情况-getMaxmemoryState</li>
<li>更新待淘汰的候选键值对集合-evictionPoolPopulate</li>
<li>选择被淘汰的键值对并删除-freeMemoryIfNeeded</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* This function is periodically called to see if there is memory to free
 * according to the current "maxmemory" settings. In case we are over the
 * memory limit, the function will try to free some memory to return back
 * under the limit.
 *
 * The function returns C_OK if we are under the memory limit or if we
 * were over the limit, but the attempt to free memory was successful.
 * Otherwise if we are over the memory limit, but not enough memory
 * was freed to return back under the limit, the function returns C_ERR. 
 */</span>
<span class="token keyword">int</span> <span class="token function">freeMemoryIfNeeded</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> keys_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* By default replicas should ignore maxmemory
     * and just be masters exact copies. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>repl_slave_ignore_maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token class-name">size_t</span> mem_reported<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">,</span> mem_freed<span class="token punctuation">;</span>
    <span class="token class-name">mstime_t</span> latency<span class="token punctuation">,</span> eviction_latency<span class="token punctuation">,</span> lazyfree_latency<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> delta<span class="token punctuation">;</span>
    <span class="token keyword">int</span> slaves <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>

    <span class="token comment">/* When clients are paused the dataset should be static not just from the
     * POV of clients not being able to write, but also from the POV of
     * expires and evictions of keys not being performed. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientsArePaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">// 如果当前内存使用量没有超过 maxmemory，返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_reported<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>mem_tofree<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span>
        <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">// 已经释放的内存大小</span>
    mem_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_NO_EVICTION<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* We need to free memory, but policy forbids. */</span>

    <span class="token comment">// 已经释放的内存大小 &lt; 计划要释放的内存大小</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>mem_freed <span class="token operator">&lt;</span> mem_tofree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> next_db <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        sds bestkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bestdbid<span class="token punctuation">;</span>
        redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>
        dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MAXMEMORY_FLAG_LRU<span class="token operator">|</span>MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token operator">||</span>
            server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 淘汰池 / 采样key集合</span>
            <span class="token keyword">struct</span> <span class="token class-name">evictionPoolEntry</span> <span class="token operator">*</span>pool <span class="token operator">=</span> EvictionPoolLRU<span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>bestkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> total_keys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> keys<span class="token punctuation">;</span>

                <span class="token comment">// 在keys过期时我们不想创建本地数据库去选择(哪些key删除)，</span>
                <span class="token comment">// 因此开始在每个数据库中填充采样key的淘汰池。 </span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>i<span class="token punctuation">;</span>
                    dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token operator">?</span>
                            db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keys <span class="token operator">=</span> <span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> dict<span class="token punctuation">,</span> db<span class="token operator">-></span>dict<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        total_keys <span class="token operator">+=</span> keys<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>total_keys<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">/* No keys to evict. */</span>

                <span class="token comment">/* Go backward from best to worst element to evict. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>dict<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>expires<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token comment">/* Remove the entry from the pool. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span>
                        <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                    <span class="token comment">/* If the key exists, is our pick. Otherwise it is
                     * a ghost and we need to try the next element. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">/* Ghost... Iterate again. */</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* volatile-random and allkeys-random policy */</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM <span class="token operator">||</span>
                 server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_RANDOM<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">/* When evicting a random key, we try to evict a key for
             * each DB, so we use the static 'next_db' variable to
             * incrementally visit all DBs. */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">++</span>next_db<span class="token punctuation">)</span> <span class="token operator">%</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span>
                db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>j<span class="token punctuation">;</span>
                dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM<span class="token punctuation">)</span> <span class="token operator">?</span>
                        db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    de <span class="token operator">=</span> <span class="token function">dictGetRandomKey</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> j<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Finally remove the selected key. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>bestdbid<span class="token punctuation">;</span>
            robj <span class="token operator">*</span>keyobj <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">propagateExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* We compute the amount of memory freed by db*Delete() alone.
             * It is possible that actually the memory needed to propagate
             * the DEL in AOF and replication link is greater than the one
             * we are freeing removing the key, but we can't account for
             * that otherwise we would never exit the loop.
             *
             * Same for CSC invalidation messages generated by signalModifiedKey.
             *
             * AOF and Output buffer memory will be freed eventually so
             * we only care about memory used by the key space. */</span>
            delta <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span>
                <span class="token function">dbAsyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">dbSyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-del"</span><span class="token punctuation">,</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            delta <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mem_freed <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>stat_evictedkeys<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_EVICTED<span class="token punctuation">,</span> <span class="token string">"evicted"</span><span class="token punctuation">,</span>
                keyobj<span class="token punctuation">,</span> db<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">decrRefCount</span><span class="token punctuation">(</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            keys_freed<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token comment">/* When the memory to free starts to be big enough, we may
             * start spending so much time here that is impossible to
             * deliver data to the slaves fast enough, so we force the
             * transmission here inside the loop. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slaves<span class="token punctuation">)</span> <span class="token function">flushSlavesOutputBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Normally our stop condition is the ability to release
             * a fixed, pre-computed amount of memory. However when we
             * are deleting objects in another thread, it's better to
             * check, from time to time, if we already reached our target
             * memory, since the "mem_freed" amount is computed only
             * across the dbAsyncDelete() call, while the thread can
             * release the memory all the time. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>keys_freed <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">/* Let's satisfy our stop condition. */</span>
                    mem_freed <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* nothing to free... */</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>

cant_free<span class="token operator">:</span>
    <span class="token comment">/* We are here if we are not able to reclaim memory. There is only one
     * last thing we can try: check if the lazyfree thread has jobs in queue
     * and wait... */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">bioPendingJobsOfType</span><span class="token punctuation">(</span>BIO_LAZY_FREE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-lazyfree"</span><span class="token punctuation">,</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-cycle"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="4-4-2-1-判断当前内存使用情况-getMaxmemoryState"><a href="#4-4-2-1-判断当前内存使用情况-getMaxmemoryState" class="headerlink" title="(4.4.2.1) 判断当前内存使用情况-getMaxmemoryState"></a>(4.4.2.1) 判断当前内存使用情况-getMaxmemoryState</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* Get the memory status from the point of view of the maxmemory directive:
 * if the memory used is under the maxmemory setting then C_OK is returned.
 * Otherwise, if we are over the memory limit, the function returns
 * C_ERR.
 *
 * The function may return additional info via reference, only if the
 * pointers to the respective arguments is not NULL. Certain fields are
 * populated only when C_ERR is returned:
 *
 *  'total'     total amount of bytes used.
 *              (Populated both for C_ERR and C_OK)
 *
 *  'logical'   the amount of memory used minus the slaves/AOF buffers.
 *              (Populated when C_ERR is returned)
 *
 *  'tofree'    the amount of memory that should be released
 *              in order to return back into the memory limits.
 *              (Populated when C_ERR is returned)
 *
 *  'level'     this usually ranges from 0 to 1, and reports the amount of
 *              memory currently used. May be > 1 if we are over the memory
 *              limit.
 *              (Populated both for C_ERR and C_OK)
 */</span>
<span class="token keyword">int</span> <span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span>total<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>logical<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>tofree<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> mem_reported<span class="token punctuation">,</span> mem_used<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">;</span>

    <span class="token comment">/* Check if we are over the memory usage limit. If we are not, no need
     * to subtract the slaves output buffers. We can just return ASAP. */</span>
    mem_reported <span class="token operator">=</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token operator">*</span>total <span class="token operator">=</span> mem_reported<span class="token punctuation">;</span>

    <span class="token comment">/* We may return ASAP if there is no need to compute the level. */</span>
    <span class="token keyword">int</span> return_ok_asap <span class="token operator">=</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>maxmemory <span class="token operator">||</span> mem_reported <span class="token operator">&lt;=</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>return_ok_asap <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>level<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Remove the size of slaves output buffers and AOF buffer from the
     * count of used memory. */</span>
    mem_used <span class="token operator">=</span> mem_reported<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> overhead <span class="token operator">=</span> <span class="token function">freeMemoryGetNotCountedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mem_used <span class="token operator">=</span> <span class="token punctuation">(</span>mem_used <span class="token operator">></span> overhead<span class="token punctuation">)</span> <span class="token operator">?</span> mem_used<span class="token operator">-</span>overhead <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* Compute the ratio of memory usage. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>level <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>mem_used <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>return_ok_asap<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Check if we are still over the memory limit. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_used <span class="token operator">&lt;=</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Compute how much memory we need to free. */</span>
    mem_tofree <span class="token operator">=</span> mem_used <span class="token operator">-</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>logical<span class="token punctuation">)</span> <span class="token operator">*</span>logical <span class="token operator">=</span> mem_used<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tofree<span class="token punctuation">)</span> <span class="token operator">*</span>tofree <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>

    <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="4-4-2-2-更新待淘汰的候选键值对集合-evictionPoolPopulate"><a href="#4-4-2-2-更新待淘汰的候选键值对集合-evictionPoolPopulate" class="headerlink" title="(4.4.2.2) 更新待淘汰的候选键值对集合-evictionPoolPopulate"></a>(4.4.2.2) 更新待淘汰的候选键值对集合-evictionPoolPopulate</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* This is an helper function for freeMemoryIfNeeded(), it is used in order
 * to populate the evictionPool with a few entries every time we want to
 * expire a key. Keys with idle time smaller than one of the current
 * keys are added. Keys are always added if there are free entries.
 *
 * We insert keys on place in ascending order, so keys with the smaller
 * idle time are on the left, and keys with the higher idle time on the
 * right. */</span>

<span class="token keyword">void</span> <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span><span class="token keyword">int</span> dbid<span class="token punctuation">,</span> dict <span class="token operator">*</span>sampledict<span class="token punctuation">,</span> dict <span class="token operator">*</span>keydict<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">evictionPoolEntry</span> <span class="token operator">*</span>pool<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> count<span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>samples<span class="token punctuation">[</span>server<span class="token punctuation">.</span>maxmemory_samples<span class="token punctuation">]</span><span class="token punctuation">;</span>

    count <span class="token operator">=</span> <span class="token function">dictGetSomeKeys</span><span class="token punctuation">(</span>sampledict<span class="token punctuation">,</span>samples<span class="token punctuation">,</span>server<span class="token punctuation">.</span>maxmemory_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> idle<span class="token punctuation">;</span>
        sds key<span class="token punctuation">;</span>
        robj <span class="token operator">*</span>o<span class="token punctuation">;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

        de <span class="token operator">=</span> samples<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        key <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* If the dictionary we are sampling from is not the main
         * dictionary (but the expires one) we need to lookup the key
         * again in the key dictionary to obtain the value object. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">!=</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sampledict <span class="token operator">!=</span> keydict<span class="token punctuation">)</span> de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>keydict<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            o <span class="token operator">=</span> <span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Calculate the idle time according to the policy. This is called
         * idle just because the code initially handled LRU, but is in fact
         * just a score where an higher score means better candidate. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LRU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            idle <span class="token operator">=</span> <span class="token function">estimateObjectIdleTime</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* When we use an LRU policy, we sort the keys by idle time
             * so that we expire keys starting from greater idle time.
             * However when the policy is an LFU one, we have a frequency
             * estimation, and we want to evict keys with lower frequency
             * first. So inside the pool we put objects using the inverted
             * frequency subtracting the actual frequency to the maximum
             * frequency of 255. */</span>
            idle <span class="token operator">=</span> <span class="token number">255</span><span class="token operator">-</span><span class="token function">LFUDecrAndReturn</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* In this case the sooner the expire the better. */</span>
            idle <span class="token operator">=</span> ULLONG_MAX <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"Unknown eviction policy in evictionPoolPopulate()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Insert the element inside the pool.
         * First, find the first empty bucket or the first populated
         * bucket that has an idle time smaller than our idle time. */</span>
        k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> EVPOOL_SIZE <span class="token operator">&amp;&amp;</span>
               pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>
               pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">&lt;</span> idle<span class="token punctuation">)</span> k<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Can't insert if the element is &lt; the worst element we have
             * and there are no empty buckets. */</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> EVPOOL_SIZE <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Inserting into empty position. No setup needed before insert. */</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Inserting in the middle. Now k points to the first element
             * greater than the element to insert.  */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/* Free space on the right? Insert at k shifting
                 * all the elements from k to end to the right. */</span>

                <span class="token comment">/* Save SDS before overwriting. */</span>
                sds cached <span class="token operator">=</span> pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span>
                <span class="token function">memmove</span><span class="token punctuation">(</span>pool<span class="token operator">+</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>pool<span class="token operator">+</span>k<span class="token punctuation">,</span>
                    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>EVPOOL_SIZE<span class="token operator">-</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached <span class="token operator">=</span> cached<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/* No free space on right? Insert at k-1 */</span>
                k<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token comment">/* Shift all elements on the left of k (included) to the
                 * left, so we discard the element with smaller idle time. */</span>
                sds cached <span class="token operator">=</span> pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span> <span class="token comment">/* Save SDS before overwriting. */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span> <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">memmove</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span>pool<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached <span class="token operator">=</span> cached<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Try to reuse the cached SDS string allocated in the pool entry,
         * because allocating and deallocating this object is costly
         * (according to the profiler, not my fantasy. Remember:
         * premature optimization bla bla bla. */</span>
        <span class="token keyword">int</span> klen <span class="token operator">=</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>klen <span class="token operator">></span> EVPOOL_CACHED_SDS_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token function">sdsdup</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">,</span>key<span class="token punctuation">,</span>klen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sdssetlen</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">,</span>klen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> idle<span class="token punctuation">;</span>
        pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid <span class="token operator">=</span> dbid<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-4-2-3-选择被淘汰的键值对并删除-freeMemoryIfNeeded"><a href="#4-4-2-3-选择被淘汰的键值对并删除-freeMemoryIfNeeded" class="headerlink" title="(4.4.2.3) 选择被淘汰的键值对并删除-freeMemoryIfNeeded"></a>(4.4.2.3) 选择被淘汰的键值对并删除-freeMemoryIfNeeded</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* This function is periodically called to see if there is memory to free
 * according to the current "maxmemory" settings. In case we are over the
 * memory limit, the function will try to free some memory to return back
 * under the limit.
 *
 * The function returns C_OK if we are under the memory limit or if we
 * were over the limit, but the attempt to free memory was successful.
 * Otherwise if we are over the memory limit, but not enough memory
 * was freed to return back under the limit, the function returns C_ERR. */</span>
<span class="token keyword">int</span> <span class="token function">freeMemoryIfNeeded</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> keys_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* By default replicas should ignore maxmemory
     * and just be masters exact copies. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>repl_slave_ignore_maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token class-name">size_t</span> mem_reported<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">,</span> mem_freed<span class="token punctuation">;</span>
    <span class="token class-name">mstime_t</span> latency<span class="token punctuation">,</span> eviction_latency<span class="token punctuation">,</span> lazyfree_latency<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> delta<span class="token punctuation">;</span>
    <span class="token keyword">int</span> slaves <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>

    <span class="token comment">/* When clients are paused the dataset should be static not just from the
     * POV of clients not being able to write, but also from the POV of
     * expires and evictions of keys not being performed. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientsArePaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_reported<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>mem_tofree<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span>
        <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    mem_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_NO_EVICTION<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* We need to free memory, but policy forbids. */</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>mem_freed <span class="token operator">&lt;</span> mem_tofree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> next_db <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        sds bestkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bestdbid<span class="token punctuation">;</span>
        redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>
        dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MAXMEMORY_FLAG_LRU<span class="token operator">|</span>MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token operator">||</span>
            server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">struct</span> <span class="token class-name">evictionPoolEntry</span> <span class="token operator">*</span>pool <span class="token operator">=</span> EvictionPoolLRU<span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>bestkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> total_keys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> keys<span class="token punctuation">;</span>

                <span class="token comment">/* We don't want to make local-db choices when expiring keys,
                 * so to start populate the eviction pool sampling keys from
                 * every DB. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>i<span class="token punctuation">;</span>
                    dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token operator">?</span>
                            db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keys <span class="token operator">=</span> <span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> dict<span class="token punctuation">,</span> db<span class="token operator">-></span>dict<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        total_keys <span class="token operator">+=</span> keys<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>total_keys<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">/* No keys to evict. */</span>

                <span class="token comment">/* Go backward from best to worst element to evict. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>dict<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>expires<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token comment">/* Remove the entry from the pool. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span>
                        <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                    <span class="token comment">/* If the key exists, is our pick. Otherwise it is
                     * a ghost and we need to try the next element. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">/* Ghost... Iterate again. */</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* volatile-random and allkeys-random policy */</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM <span class="token operator">||</span>
                 server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_RANDOM<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">/* When evicting a random key, we try to evict a key for
             * each DB, so we use the static 'next_db' variable to
             * incrementally visit all DBs. */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">++</span>next_db<span class="token punctuation">)</span> <span class="token operator">%</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span>
                db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>j<span class="token punctuation">;</span>
                dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM<span class="token punctuation">)</span> <span class="token operator">?</span>
                        db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    de <span class="token operator">=</span> <span class="token function">dictGetRandomKey</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> j<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Finally remove the selected key. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>bestdbid<span class="token punctuation">;</span>
            robj <span class="token operator">*</span>keyobj <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">propagateExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* We compute the amount of memory freed by db*Delete() alone.
             * It is possible that actually the memory needed to propagate
             * the DEL in AOF and replication link is greater than the one
             * we are freeing removing the key, but we can't account for
             * that otherwise we would never exit the loop.
             *
             * Same for CSC invalidation messages generated by signalModifiedKey.
             *
             * AOF and Output buffer memory will be freed eventually so
             * we only care about memory used by the key space. */</span>
            delta <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span>
                <span class="token function">dbAsyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">dbSyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-del"</span><span class="token punctuation">,</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            delta <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mem_freed <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>stat_evictedkeys<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_EVICTED<span class="token punctuation">,</span> <span class="token string">"evicted"</span><span class="token punctuation">,</span>
                keyobj<span class="token punctuation">,</span> db<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">decrRefCount</span><span class="token punctuation">(</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            keys_freed<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token comment">/* When the memory to free starts to be big enough, we may
             * start spending so much time here that is impossible to
             * deliver data to the slaves fast enough, so we force the
             * transmission here inside the loop. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slaves<span class="token punctuation">)</span> <span class="token function">flushSlavesOutputBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Normally our stop condition is the ability to release
             * a fixed, pre-computed amount of memory. However when we
             * are deleting objects in another thread, it's better to
             * check, from time to time, if we already reached our target
             * memory, since the "mem_freed" amount is computed only
             * across the dbAsyncDelete() call, while the thread can
             * release the memory all the time. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>keys_freed <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">/* Let's satisfy our stop condition. */</span>
                    mem_freed <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* nothing to free... */</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>

cant_free<span class="token operator">:</span>
    <span class="token comment">/* We are here if we are not able to reclaim memory. There is only one
     * last thing we can try: check if the lazyfree thread has jobs in queue
     * and wait... */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">bioPendingJobsOfType</span><span class="token punctuation">(</span>BIO_LAZY_FREE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-lazyfree"</span><span class="token punctuation">,</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-cycle"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>





<h1 id="5-LFU源码解读"><a href="#5-LFU源码解读" class="headerlink" title="(5) LFU源码解读"></a>(5) LFU源码解读</h1><p>  LFU 算法的启用，是通过设置 Redis 配置文件 redis.conf 中的 maxmemory 和 maxmemory-policy。</p>
<p>LFU 算法的实现可以分成三部分内容，分别是键值对访问频率记录、键值对访问频率初始化和更新，以及LFU算法淘汰数据。</p>
<h2 id="5-1-键值对访问频率记录"><a href="#5-1-键值对访问频率记录" class="headerlink" title="(5.1) 键值对访问频率记录"></a>(5.1) 键值对访问频率记录</h2><p>  每个键值对的值都对应了一个 redisObject 结构体，其中有一个 24 bits 的 lru 变量。</p>
<p>  LRU 算法和 LFU 算法并不会同时使用。为了节省内存开销，Redis 源码就复用了 lru 变量来记录 LFU 算法所需的访问频率信息。</p>
<p>  记录LFU算法的所需信息时，它会用24 bits中的低8 bits作为计数器，来记录键值对的访问次数，同时它会用24 bits中的高16 bits，记录访问的时间戳。</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">|</span><span class="token operator">&lt;</span><span class="token separator comment">---</span>访问时间戳<span class="token separator comment">---</span><span class="token operator">></span><span class="token operator">|</span><span class="token operator">&lt;</span> 计数器 <span class="token operator">></span><span class="token operator">|</span> 

     <span class="token number">16</span> bits      <span class="token number">8</span> bits
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">+</span> Last decr time <span class="token operator">|</span> LOG_C  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>            <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="5-2-键值对访问频率初始化和更新"><a href="#5-2-键值对访问频率初始化和更新" class="headerlink" title="(5.2) 键值对访问频率初始化和更新"></a>(5.2) 键值对访问频率初始化和更新</h2><h3 id="5-2-1-初始化"><a href="#5-2-1-初始化" class="headerlink" title="(5.2.1) 初始化"></a>(5.2.1) 初始化</h3><p>  键值对 lru变量初始化是在 创建redisObject调用 <code>createObject</code> 函数时完成的。</p>
<p>主要分2步：<br>第一部是 lru 变量的高16位，是以1分钟为精度的 UNIX 时间戳。(LFUGetTimeInMinutes)<br>第二部是 lru 变量的低8位，被设置为宏定义 LFU_INIT_VAL，默认值为 5。</p>
<p>  源码如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/object.c</span>

<span class="token comment">/*
 * 创建一个redisObject对象
 *
 * @param type redisObject的类型
 * @param *ptr 值的指针
 */</span>
robj <span class="token operator">*</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 为redisObject结构体分配内存空间</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">// 省略部分代码 </span>

    <span class="token comment">// 将lru字段设置为当前的 lruclock（分钟分辨率），或者 LFU 计数器。 </span>
    <span class="token comment">// 判断内存过期策略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lfu </span>
        <span class="token comment">// LFU_INIT_VAL=5 对应二进制是 0101 </span>
        <span class="token comment">// 或运算  高16位是时间，低8位是次数， LFU_INIT_VAL = 5</span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lru </span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  counter会被初始化为<code>LFU_INIT_VAL</code>，默认5。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* ----------------------------------------------------------------------------
 * LFU (Least Frequently Used) implementation.
 * 
 * 为了实现 LFU（最不常用）驱逐策略，我们在每个对象中总共有 24 位空间，因为我们为此目的重新使用了 LRU 字段。
 *
 * 我们将 24 位分成两个字段：
 *
 *          16 bits      8 bits
 *     +----------------+--------+
 *     + Last decr time | LOG_C  |
 *     +----------------+--------+
 *
 * LOG_C 是提供访问频率指示的对数计数器。 
 * 然而，这个字段也必须递减，否则过去经常访问的键将永远保持这样的排名，而我们希望算法适应访问模式的变化。
 *
 * 因此，剩余的 16 位用于存储“递减时间”，
 * 这是一个精度降低的 Unix 时间(我们将 16 位时间转换为分钟，因为我们不关心回绕)，
 * 其中 LOG_C 计数器减半 如果它具有高值，或者如果它具有低值则只是递减。
 *
 * 新key不会从零开始，以便能够在被淘汰之前收集一些访问，因此它们从 COUNTER_INIT_VAL 开始。
 * COUNTER_INIT_VAL = 5
 * 因此从5(或具有较小值)开始的键在访问时递增的可能性非常高。
 *
 * 在递减期间，如果对数计数器的当前值大于5的两倍，则对数计数器的值减半，否则它只减一。
 * 
 * --------------------------------------------------------------------------*/</span>

<span class="token comment">/* 
 * 以分钟为单位返回当前时间，只取最低有效16位。 
 * 返回的时间适合存储为 LFU 实现的 LDT(最后递减时间)。
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 65535 = 2^16 - 1 对应二进制是 1111 1111 1111 1111</span>
    <span class="token comment">// (server.unixtime/60) &amp; 1111 1111 1111 1111</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>unixtime<span class="token operator">/</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">65535</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="5-2-2-更新LFU值"><a href="#5-2-2-更新LFU值" class="headerlink" title="(5.2.2) 更新LFU值"></a>(5.2.2) 更新LFU值</h3><p>  当一个键值对被访问时，Redis 会调用 lookupKey 函数进行查找。lookupKey 函数会调用 updateLFU 函数来更新键值对的访问频率。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/db.c</span>

<span class="token comment">/* 
 * 访问对象时更新 LFU。
 * 首先，如果达到递减时间，则递减计数器。
 * 然后以对数方式递增计数器，并更新访问时间。
 */</span>
<span class="token keyword">void</span> <span class="token function">updateLFU</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取计数器</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> counter <span class="token operator">=</span> <span class="token function">LFUDecrAndReturn</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新计数器</span>
    counter <span class="token operator">=</span> <span class="token function">LFULogIncr</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="5-2-2-1-递减计数器-LFUDecrAndReturn"><a href="#5-2-2-1-递减计数器-LFUDecrAndReturn" class="headerlink" title="(5.2.2.1) 递减计数器-LFUDecrAndReturn"></a>(5.2.2.1) 递减计数器-LFUDecrAndReturn</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * 如果达到对象递减时间，则 递减LFU计数器 但 不更新对象的LFU字段，
 * 我们在真正访问对象时以显式方式更新访问时间和计数器。
 * 
 * 并且我们将根据 经过的时间/server.lfu_decay_time 将计数器减半。
 * 返回对象频率计数器。
 * redis.conf配置文件里 lfu-decay-time 默认是 1
 * And we will times halve the counter according to the times of
 * elapsed time than server.lfu_decay_time.
 * 
 * 此函数用于扫描数据集以获得最佳对象
 *  适合：当我们检查候选对象时，如果需要，我们会递减扫描对象的计数器。
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">LFUDecrAndReturn</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 高16位存的是 上次访问时间(分钟级的) Last decr time </span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ldt <span class="token operator">=</span> o<span class="token operator">-></span>lru <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">;</span>

    <span class="token comment">// 255 对应二进制 1111 1111 </span>
    <span class="token comment">// o->lru &amp; 1111 1111 相当于取低8位的值</span>
    <span class="token comment">// 获取计数器</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> counter <span class="token operator">=</span> o<span class="token operator">-></span>lru <span class="token operator">&amp;</span> <span class="token number">255</span><span class="token punctuation">;</span>

    <span class="token comment">// 0 &lt;= LFUTimeElapsed(ldt) &lt;  65535</span>
    <span class="token comment">// 过了的分钟数 / server.lfu_decay_time</span>
    <span class="token comment">// num_periods 是过了 n轮 衰减时间(lfu_decay_time)</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> num_periods <span class="token operator">=</span> server<span class="token punctuation">.</span>lfu_decay_time <span class="token operator">?</span> <span class="token function">LFUTimeElapsed</span><span class="token punctuation">(</span>ldt<span class="token punctuation">)</span> <span class="token operator">/</span> server<span class="token punctuation">.</span>lfu_decay_time <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果经过的轮数不为0 (超过1分钟了)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_periods<span class="token punctuation">)</span> 
        <span class="token comment">// 如果 n轮衰减 > 访问次数，counter设置为0，相当于重新开始计算</span>
        <span class="token comment">// 否则，n轮衰减 &lt;= 访问次数，counter设置为 counter - num_periods，相当于每过1轮衰减时间(lfu_decay_time)，减1</span>
        counter <span class="token operator">=</span> <span class="token punctuation">(</span>num_periods <span class="token operator">></span> counter<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> counter <span class="token operator">-</span> num_periods<span class="token punctuation">;</span>

    <span class="token comment">// 如果没有超过1分钟，num_periods=0，直接返回counter</span>
    <span class="token comment">// 如果超过1分钟，num_periods！=0，至少过了1轮衰减时间(lfu_decay_time)了，更新counter后返回</span>
    <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  <code>LFUDecrAndReturn</code> 得到的计数结果</p>
<ol>
<li>如果在当前分钟时间戳内，counter不变</li>
<li>如果不在当前分钟时间戳内，每过1轮衰减时间(lfu_decay_time)，counter减1 (代码里是过了num_periods轮，减num_periods)</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * 计算过了多少分钟
 * 
 * 给定对象的上次访问时间，计算自上次访问以来经过的最小分钟数。 
 * 处理溢出(ldt 大于当前 16 位分钟时间)，将时间视为正好回绕一次。
 * 
 * @param ldt 上一次访问的时间(分钟级)
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">LFUTimeElapsed</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> ldt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取分钟级时间戳</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算过了多少分钟</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">>=</span> ldt<span class="token punctuation">)</span> <span class="token keyword">return</span> now<span class="token operator">-</span>ldt<span class="token punctuation">;</span>

    <span class="token comment">// 实际上now永远是在ldt(上一次访问时间之后)</span>
    <span class="token comment">// 但是现在 now &lt; ldt，不符合预期 </span>
    <span class="token comment">// ldt是 (server.unixtime/60) &amp; 1111 1111 1111 1111 得到的，相当于取余，也就是至少过了1轮了 </span>
    <span class="token comment">// 假设 ldt = 65534  now = 1，其实过了2分钟</span>
    <span class="token keyword">return</span> <span class="token number">65535</span><span class="token operator">-</span>ldt<span class="token operator">+</span>now<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="5-2-2-2-更新LFU计数器-LFULogIncr"><a href="#5-2-2-2-更新LFU计数器-LFULogIncr" class="headerlink" title="(5.2.2.2) 更新LFU计数器-LFULogIncr"></a>(5.2.2.2) 更新LFU计数器-LFULogIncr</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * 以对数方式递增计数器。 当前计数器值越大，它真正实现的可能性就越小。 在255时饱和。
 *
 * Logarithmically increment a counter. 
 * The greater is the current counter value
 * the less likely is that it gets really implemented. 
 * Saturate it at 255. 
 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">LFULogIncr</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> counter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 最大255</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">255</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取一个随机数</span>
    <span class="token keyword">double</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>RAND_MAX<span class="token punctuation">;</span>

    <span class="token comment">// 基础值 = counter - 5</span>
    <span class="token keyword">double</span> baseval <span class="token operator">=</span> counter <span class="token operator">-</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token comment">// 最小=0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>baseval <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> baseval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 取对数 </span>
    <span class="token keyword">double</span> p <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>baseval<span class="token operator">*</span>server<span class="token punctuation">.</span>lfu_log_factor<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 随机数 &lt; 对数时，计数器+1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> p<span class="token punctuation">)</span> counter<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  counter并不是简单的访问一次就+1，而是采用了一个0-1之间的p因子控制增长。</p>
<p>  <img src="/img/database/redis/cache-eviction/lfu/redis-lfu-log-1.png" alt="对数"></p>
<p>取一个0-1之间的随机数r与p比较，当<code>r &lt; p</code>时，才增加counter<br><code>p</code>取决于当前counter值与<code>lfu_log_factor</code>因子，<code>counter</code>值与<code>lfu_log_factor</code>因子越大，<code>p</code>越小，<code>r&lt;p</code>的概率也越小，counter增长的概率也就越小。</p>
<p>  增长情况如下</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> factor <span class="token operator">|</span> <span class="token number">100</span> hits   <span class="token operator">|</span> <span class="token number">1000</span> hits  <span class="token operator">|</span> <span class="token number">100K</span> hits  <span class="token operator">|</span> <span class="token number">1M</span> hits    <span class="token operator">|</span> <span class="token number">10M</span> hits   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span> <span class="token number">104</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span> <span class="token number">18</span>         <span class="token operator">|</span> <span class="token number">49</span>         <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token number">10</span>     <span class="token operator">|</span> <span class="token number">10</span>         <span class="token operator">|</span> <span class="token number">18</span>         <span class="token operator">|</span> <span class="token number">142</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token number">100</span>    <span class="token operator">|</span> <span class="token number">8</span>          <span class="token operator">|</span> <span class="token number">11</span>         <span class="token operator">|</span> <span class="token number">49</span>         <span class="token operator">|</span> <span class="token number">143</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="5-3-LFU算法淘汰数据"><a href="#5-3-LFU算法淘汰数据" class="headerlink" title="(5.3) LFU算法淘汰数据"></a>(5.3) LFU算法淘汰数据</h2><p>主要有三步<br>第一步，调用 getMaxmemoryState 函数计算待释放的内存空间；<br>第二步，调用 evictionPoolPopulate 函数随机采样键值对，并插入到待淘汰集合 EvictionPoolLRU 中；<br>第三步，遍历待淘汰集合 EvictionPoolLRU，选择实际被淘汰数据，并删除。</p>
<h3 id="5-3-1-判断当前内存使用情况-getMaxmemoryState"><a href="#5-3-1-判断当前内存使用情况-getMaxmemoryState" class="headerlink" title="(5.3.1) 判断当前内存使用情况-getMaxmemoryState"></a>(5.3.1) 判断当前内存使用情况-getMaxmemoryState</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* Get the memory status from the point of view of the maxmemory directive:
 * if the memory used is under the maxmemory setting then C_OK is returned.
 * Otherwise, if we are over the memory limit, the function returns
 * C_ERR.
 *
 * The function may return additional info via reference, only if the
 * pointers to the respective arguments is not NULL. Certain fields are
 * populated only when C_ERR is returned:
 *
 *  'total'     total amount of bytes used.
 *              (Populated both for C_ERR and C_OK)
 *
 *  'logical'   the amount of memory used minus the slaves/AOF buffers.
 *              (Populated when C_ERR is returned)
 *
 *  'tofree'    the amount of memory that should be released
 *              in order to return back into the memory limits.
 *              (Populated when C_ERR is returned)
 *
 *  'level'     this usually ranges from 0 to 1, and reports the amount of
 *              memory currently used. May be > 1 if we are over the memory
 *              limit.
 *              (Populated both for C_ERR and C_OK)
 */</span>
<span class="token keyword">int</span> <span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span>total<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>logical<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>tofree<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> mem_reported<span class="token punctuation">,</span> mem_used<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">;</span>

    <span class="token comment">/* Check if we are over the memory usage limit. If we are not, no need
     * to subtract the slaves output buffers. We can just return ASAP. */</span>
    mem_reported <span class="token operator">=</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token operator">*</span>total <span class="token operator">=</span> mem_reported<span class="token punctuation">;</span>

    <span class="token comment">/* We may return ASAP if there is no need to compute the level. */</span>
    <span class="token keyword">int</span> return_ok_asap <span class="token operator">=</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>maxmemory <span class="token operator">||</span> mem_reported <span class="token operator">&lt;=</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>return_ok_asap <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>level<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Remove the size of slaves output buffers and AOF buffer from the
     * count of used memory. */</span>
    mem_used <span class="token operator">=</span> mem_reported<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> overhead <span class="token operator">=</span> <span class="token function">freeMemoryGetNotCountedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mem_used <span class="token operator">=</span> <span class="token punctuation">(</span>mem_used <span class="token operator">></span> overhead<span class="token punctuation">)</span> <span class="token operator">?</span> mem_used<span class="token operator">-</span>overhead <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* Compute the ratio of memory usage. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>level <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>mem_used <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>return_ok_asap<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Check if we are still over the memory limit. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_used <span class="token operator">&lt;=</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Compute how much memory we need to free. */</span>
    mem_tofree <span class="token operator">=</span> mem_used <span class="token operator">-</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>logical<span class="token punctuation">)</span> <span class="token operator">*</span>logical <span class="token operator">=</span> mem_used<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tofree<span class="token punctuation">)</span> <span class="token operator">*</span>tofree <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>

    <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="5-3-2-更新待淘汰的候选键值对集合-evictionPoolPopulate"><a href="#5-3-2-更新待淘汰的候选键值对集合-evictionPoolPopulate" class="headerlink" title="(5.3.2) 更新待淘汰的候选键值对集合-evictionPoolPopulate"></a>(5.3.2) 更新待淘汰的候选键值对集合-evictionPoolPopulate</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* This is an helper function for freeMemoryIfNeeded(), it is used in order
 * to populate the evictionPool with a few entries every time we want to
 * expire a key. Keys with idle time smaller than one of the current
 * keys are added. Keys are always added if there are free entries.
 *
 * We insert keys on place in ascending order, so keys with the smaller
 * idle time are on the left, and keys with the higher idle time on the
 * right. */</span>

<span class="token keyword">void</span> <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span><span class="token keyword">int</span> dbid<span class="token punctuation">,</span> dict <span class="token operator">*</span>sampledict<span class="token punctuation">,</span> dict <span class="token operator">*</span>keydict<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">evictionPoolEntry</span> <span class="token operator">*</span>pool<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> count<span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>samples<span class="token punctuation">[</span>server<span class="token punctuation">.</span>maxmemory_samples<span class="token punctuation">]</span><span class="token punctuation">;</span>

    count <span class="token operator">=</span> <span class="token function">dictGetSomeKeys</span><span class="token punctuation">(</span>sampledict<span class="token punctuation">,</span>samples<span class="token punctuation">,</span>server<span class="token punctuation">.</span>maxmemory_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> idle<span class="token punctuation">;</span>
        sds key<span class="token punctuation">;</span>
        robj <span class="token operator">*</span>o<span class="token punctuation">;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

        de <span class="token operator">=</span> samples<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        key <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* If the dictionary we are sampling from is not the main
         * dictionary (but the expires one) we need to lookup the key
         * again in the key dictionary to obtain the value object. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">!=</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sampledict <span class="token operator">!=</span> keydict<span class="token punctuation">)</span> de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>keydict<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            o <span class="token operator">=</span> <span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Calculate the idle time according to the policy. This is called
         * idle just because the code initially handled LRU, but is in fact
         * just a score where an higher score means better candidate. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LRU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            idle <span class="token operator">=</span> <span class="token function">estimateObjectIdleTime</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* When we use an LRU policy, we sort the keys by idle time
             * so that we expire keys starting from greater idle time.
             * However when the policy is an LFU one, we have a frequency
             * estimation, and we want to evict keys with lower frequency
             * first. So inside the pool we put objects using the inverted
             * frequency subtracting the actual frequency to the maximum
             * frequency of 255. */</span>
            idle <span class="token operator">=</span> <span class="token number">255</span><span class="token operator">-</span><span class="token function">LFUDecrAndReturn</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* In this case the sooner the expire the better. */</span>
            idle <span class="token operator">=</span> ULLONG_MAX <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"Unknown eviction policy in evictionPoolPopulate()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Insert the element inside the pool.
         * First, find the first empty bucket or the first populated
         * bucket that has an idle time smaller than our idle time. */</span>
        k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> EVPOOL_SIZE <span class="token operator">&amp;&amp;</span>
               pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>
               pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">&lt;</span> idle<span class="token punctuation">)</span> k<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Can't insert if the element is &lt; the worst element we have
             * and there are no empty buckets. */</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> EVPOOL_SIZE <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Inserting into empty position. No setup needed before insert. */</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Inserting in the middle. Now k points to the first element
             * greater than the element to insert.  */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/* Free space on the right? Insert at k shifting
                 * all the elements from k to end to the right. */</span>

                <span class="token comment">/* Save SDS before overwriting. */</span>
                sds cached <span class="token operator">=</span> pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span>
                <span class="token function">memmove</span><span class="token punctuation">(</span>pool<span class="token operator">+</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>pool<span class="token operator">+</span>k<span class="token punctuation">,</span>
                    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>EVPOOL_SIZE<span class="token operator">-</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached <span class="token operator">=</span> cached<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/* No free space on right? Insert at k-1 */</span>
                k<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token comment">/* Shift all elements on the left of k (included) to the
                 * left, so we discard the element with smaller idle time. */</span>
                sds cached <span class="token operator">=</span> pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span> <span class="token comment">/* Save SDS before overwriting. */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span> <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">memmove</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span>pool<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached <span class="token operator">=</span> cached<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Try to reuse the cached SDS string allocated in the pool entry,
         * because allocating and deallocating this object is costly
         * (according to the profiler, not my fantasy. Remember:
         * premature optimization bla bla bla. */</span>
        <span class="token keyword">int</span> klen <span class="token operator">=</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>klen <span class="token operator">></span> EVPOOL_CACHED_SDS_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token function">sdsdup</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">,</span>key<span class="token punctuation">,</span>klen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sdssetlen</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">,</span>klen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> idle<span class="token punctuation">;</span>
        pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid <span class="token operator">=</span> dbid<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-3-3-选择被淘汰的键值对并删除-freeMemoryIfNeeded"><a href="#5-3-3-选择被淘汰的键值对并删除-freeMemoryIfNeeded" class="headerlink" title="(5.3.3) 选择被淘汰的键值对并删除-freeMemoryIfNeeded"></a>(5.3.3) 选择被淘汰的键值对并删除-freeMemoryIfNeeded</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* This function is periodically called to see if there is memory to free
 * according to the current "maxmemory" settings. In case we are over the
 * memory limit, the function will try to free some memory to return back
 * under the limit.
 *
 * The function returns C_OK if we are under the memory limit or if we
 * were over the limit, but the attempt to free memory was successful.
 * Otherwise if we are over the memory limit, but not enough memory
 * was freed to return back under the limit, the function returns C_ERR. */</span>
<span class="token keyword">int</span> <span class="token function">freeMemoryIfNeeded</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> keys_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* By default replicas should ignore maxmemory
     * and just be masters exact copies. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>repl_slave_ignore_maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token class-name">size_t</span> mem_reported<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">,</span> mem_freed<span class="token punctuation">;</span>
    <span class="token class-name">mstime_t</span> latency<span class="token punctuation">,</span> eviction_latency<span class="token punctuation">,</span> lazyfree_latency<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> delta<span class="token punctuation">;</span>
    <span class="token keyword">int</span> slaves <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>

    <span class="token comment">/* When clients are paused the dataset should be static not just from the
     * POV of clients not being able to write, but also from the POV of
     * expires and evictions of keys not being performed. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientsArePaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_reported<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>mem_tofree<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span>
        <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    mem_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_NO_EVICTION<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* We need to free memory, but policy forbids. */</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>mem_freed <span class="token operator">&lt;</span> mem_tofree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> next_db <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        sds bestkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bestdbid<span class="token punctuation">;</span>
        redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>
        dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MAXMEMORY_FLAG_LRU<span class="token operator">|</span>MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token operator">||</span>
            server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">struct</span> <span class="token class-name">evictionPoolEntry</span> <span class="token operator">*</span>pool <span class="token operator">=</span> EvictionPoolLRU<span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>bestkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> total_keys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> keys<span class="token punctuation">;</span>

                <span class="token comment">/* We don't want to make local-db choices when expiring keys,
                 * so to start populate the eviction pool sampling keys from
                 * every DB. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>i<span class="token punctuation">;</span>
                    dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token operator">?</span>
                            db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keys <span class="token operator">=</span> <span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> dict<span class="token punctuation">,</span> db<span class="token operator">-></span>dict<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        total_keys <span class="token operator">+=</span> keys<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>total_keys<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">/* No keys to evict. */</span>

                <span class="token comment">/* Go backward from best to worst element to evict. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>dict<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>expires<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token comment">/* Remove the entry from the pool. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span>
                        <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                    <span class="token comment">/* If the key exists, is our pick. Otherwise it is
                     * a ghost and we need to try the next element. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">/* Ghost... Iterate again. */</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* volatile-random and allkeys-random policy */</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM <span class="token operator">||</span>
                 server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_RANDOM<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">/* When evicting a random key, we try to evict a key for
             * each DB, so we use the static 'next_db' variable to
             * incrementally visit all DBs. */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">++</span>next_db<span class="token punctuation">)</span> <span class="token operator">%</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span>
                db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>j<span class="token punctuation">;</span>
                dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM<span class="token punctuation">)</span> <span class="token operator">?</span>
                        db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    de <span class="token operator">=</span> <span class="token function">dictGetRandomKey</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> j<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Finally remove the selected key. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>bestdbid<span class="token punctuation">;</span>
            robj <span class="token operator">*</span>keyobj <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">propagateExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* We compute the amount of memory freed by db*Delete() alone.
             * It is possible that actually the memory needed to propagate
             * the DEL in AOF and replication link is greater than the one
             * we are freeing removing the key, but we can't account for
             * that otherwise we would never exit the loop.
             *
             * Same for CSC invalidation messages generated by signalModifiedKey.
             *
             * AOF and Output buffer memory will be freed eventually so
             * we only care about memory used by the key space. */</span>
            delta <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span>
                <span class="token function">dbAsyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">dbSyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-del"</span><span class="token punctuation">,</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            delta <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mem_freed <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>stat_evictedkeys<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_EVICTED<span class="token punctuation">,</span> <span class="token string">"evicted"</span><span class="token punctuation">,</span>
                keyobj<span class="token punctuation">,</span> db<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">decrRefCount</span><span class="token punctuation">(</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            keys_freed<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token comment">/* When the memory to free starts to be big enough, we may
             * start spending so much time here that is impossible to
             * deliver data to the slaves fast enough, so we force the
             * transmission here inside the loop. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slaves<span class="token punctuation">)</span> <span class="token function">flushSlavesOutputBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Normally our stop condition is the ability to release
             * a fixed, pre-computed amount of memory. However when we
             * are deleting objects in another thread, it's better to
             * check, from time to time, if we already reached our target
             * memory, since the "mem_freed" amount is computed only
             * across the dbAsyncDelete() call, while the thread can
             * release the memory all the time. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>keys_freed <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">/* Let's satisfy our stop condition. */</span>
                    mem_freed <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* nothing to free... */</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>

cant_free<span class="token operator">:</span>
    <span class="token comment">/* We are here if we are not able to reclaim memory. There is only one
     * last thing we can try: check if the lazyfree thread has jobs in queue
     * and wait... */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">bioPendingJobsOfType</span><span class="token punctuation">(</span>BIO_LAZY_FREE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-lazyfree"</span><span class="token punctuation">,</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-cycle"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>



<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/294640">Redis 核心技术与实战 - 24 | 替换策略：缓存满了怎么办？</a><br>[2] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/297270">Redis 核心技术与实战 - 27 | 缓存被污染了，该怎么办？</a><br>[3] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/412164">Redis 源码剖析与实战 - 15 | 为什么LRU算法原理和代码实现不一样？</a><br>[4] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/413038">Redis 源码剖析与实战 - 16 | LFU算法和其他算法相比有优势吗？</a><br>[5] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/linxiyue/p/10955533.html">Redis中的LFU算法</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/02/26/redis-command-execution-process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/26/redis-command-execution-process/" class="post-title-link" itemprop="url">Redis命令执行流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-26 19:22:27" itemprop="dateCreated datePublished" datetime="2022-02-26T19:22:27+08:00">2022-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-01-30 23:09:30" itemprop="dateModified" datetime="2023-01-30T23:09:30+08:00">2023-01-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2022/02/26/redis-command-execution-process/" class="post-meta-item leancloud_visitors" data-flag-title="Redis命令执行流程" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/02/26/redis-command-execution-process/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/02/26/redis-command-execution-process/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-Redis实现分布式锁"><a href="#1-Redis实现分布式锁" class="headerlink" title="(1) Redis实现分布式锁"></a>(1) Redis实现分布式锁</h1><p>  通过Redis <code>SET key value NX</code> 可以简单地实现分布式锁。</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>  SET key_lock value1 NX
OK
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>  SET key_lock value1 NX
<span class="token operator">(</span>nil<span class="token operator">)</span>
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 在解锁时可以先判断key是否存在，然后对比值是否相等，相等后再删除key，释放锁。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/02/26/redis-command-execution-process/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">310</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/weikeqin" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;weikeqin" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/u/0/107737814703120725006" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;u&#x2F;0&#x2F;107737814703120725006" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wkq278276130" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wkq278276130" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/keqin.wei.5" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;keqin.wei.5" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/8054088/wkq" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;8054088&#x2F;wkq" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



<script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5rcgvdncuwu&amp;m=7&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>


      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'Ca876j76FoCQi1SShjT0qC6k-gzGzoHsz',
      appKey     : 'IeozLmM20GuvfcslfWgdNXP0',
      placeholder: "期待您的评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
