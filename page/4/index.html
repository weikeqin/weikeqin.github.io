<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"weikeqin.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="不积跬步无以至千里">
<meta property="og:type" content="website">
<meta property="og:title" content="天道酬勤">
<meta property="og:url" content="http://weikeqin.com/page/4/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="不积跬步无以至千里">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="tech,Java,MySQL,Redis,ElasticSearch,DDD">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://weikeqin.com/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>天道酬勤</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113485469-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-113485469-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">天道酬勤</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">304</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/u/0/107737814703120725006" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;u&#x2F;0&#x2F;107737814703120725006" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wkq278276130" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wkq278276130" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/keqin.wei.5" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;keqin.wei.5" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/8054088/wkq" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;8054088&#x2F;wkq" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/04/23/redis-log/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/23/redis-log/" class="post-title-link" itemprop="url">Redis日志</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-23 09:03:33" itemprop="dateCreated datePublished" datetime="2022-04-23T09:03:33+08:00">2022-04-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-04 21:26:15" itemprop="dateModified" datetime="2022-12-04T21:26:15+08:00">2022-12-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>54</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p> redis里有 redis.log(程序运行日志)、slowlog(慢查询日志) 等</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="http://redisbook.com/preview/slowlog/content.html">slowlog</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/04/17/blog-speed-optimization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/17/blog-speed-optimization/" class="post-title-link" itemprop="url">博客访问速度优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-17 22:04:46" itemprop="dateCreated datePublished" datetime="2022-04-17T22:04:46+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-04 21:17:40" itemprop="dateModified" datetime="2022-12-04T21:17:40+08:00">2022-12-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　在原来coding pages服务和github pages服务都可以免费试用时，在域名解析时配置 国内访问coding pages部署的博客静态文件，国外访问github pages部署的静态文件。国内国外访问速度都基本都在200ms内。</p>
<p>  <img src="/img/blog/blog-domain-network-design-2020.jpg" alt="网站网络设计"></p>
<p>　　自从 coding.net 停止免费的pages服务后，只有github pages可以免费试用，国内访问博客只能访问github pages服务，导致访问速度很慢。被人吐槽了一次，所以想优化一下。</p>
<p>优化思路比较简单，<br>1、国内ip访问国内的博客服务  比如gitee pages服务<br>2、通过缓存加快访问速度  比如CDN缓存</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/17/blog-speed-optimization/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/03/06/redis-cache-eviction-strategy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/06/redis-cache-eviction-strategy/" class="post-title-link" itemprop="url">Redis 缓存淘汰策略</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-06 19:32:45" itemprop="dateCreated datePublished" datetime="2022-03-06T19:32:45+08:00">2022-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-02-04 12:21:29" itemprop="dateModified" datetime="2023-02-04T12:21:29+08:00">2023-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-缓存淘汰是什么"><a href="#1-缓存淘汰是什么" class="headerlink" title="(1) 缓存淘汰是什么"></a>(1) 缓存淘汰是什么</h1><h1 id="2-为什么要缓存淘汰"><a href="#2-为什么要缓存淘汰" class="headerlink" title="(2) 为什么要缓存淘汰"></a>(2) 为什么要缓存淘汰</h1><h1 id="3-缓存淘汰算法-页面置换算法原理"><a href="#3-缓存淘汰算法-页面置换算法原理" class="headerlink" title="(3) 缓存淘汰算法/页面置换算法原理"></a>(3) 缓存淘汰算法/页面置换算法原理</h1><h2 id="3-1-LRU"><a href="#3-1-LRU" class="headerlink" title="(3.1) LRU"></a>(3.1) LRU</h2><p>  LRU 算法背后的想法非常朴素：它认为刚刚被访问的数据，肯定还会被再次访问。<br>  选择最近最久未被使用的数据进行淘汰。</p>
<p>优点：</p>
<p>不足：<br>  可能造成缓存污染。</p>
<p><code>缓存污染</code>：在一些场景下，有些数据被访问的次数非常少，甚至只会被访问一次。当这些数据服务完访问请求后，如果还继续留存在缓存中的话，就只会白白占用缓存空间。</p>
<p>  典型场景：全表扫描，对所有数据进行一次读取，每个数据都被读取到了，</p>
<h2 id="3-2-LFU"><a href="#3-2-LFU" class="headerlink" title="(3.2) LFU"></a>(3.2) LFU</h2><p>  记录数据被访问的频率，选择在最近使用最少的数据进行淘汰。</p>
<p>  LFU算法是根据数据访问的频率来选择被淘汰数据的，所以LFU算法会记录每个数据的访问次数。当一个数据被再次访问时，就会增加该数据的访问次数。</p>
<p>  不过，访问次数和访问频率还不能完全等同。访问频率是指在一定时间内的访问次数，也就是说，在计算访问频率时，我们不仅需要记录访问次数，还要记录这些访问是在多长时间内执行的。</p>
<br>


<h1 id="4-Redis里缓存有哪些淘汰策略"><a href="#4-Redis里缓存有哪些淘汰策略" class="headerlink" title="(4) Redis里缓存有哪些淘汰策略"></a>(4) Redis里缓存有哪些淘汰策略</h1><table>
<thead>
<tr>
<th align="left">内存淘汰策略</th>
<th align="left">解释</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">noeviction</td>
<td align="left">不进行数据淘汰</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">allkeys-random</td>
<td align="left">在所有key里随机筛选数据</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">allkeys-lru</td>
<td align="left">在所有key里筛选最近最久未使用的数据</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">allkeys-lfu</td>
<td align="left">在所有key里筛选最近最少使用的数据</td>
<td align="left">Redis 4.0 新增</td>
</tr>
<tr>
<td align="left">volatile-ttl</td>
<td align="left">在有过期时间key里根据过期时间的先后筛选</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">volatile-random</td>
<td align="left">在有过期时间key里随机筛选数据</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">volatile-lru</td>
<td align="left">在有过期时间key里筛选最近最久未使用的数据</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">volatile-lfu</td>
<td align="left">在有过期时间key里筛选最近最少使用的数据</td>
<td align="left">Redis 4.0 新增</td>
</tr>
</tbody></table>
<p>lru (Least Recently Used)   最近最久未使用<br>lfu (Least Frequently Used)  最近最少使用</p>
<p>  在redis3.0之前，默认淘汰策略是<code>volatile-lru</code>；在redis3.0及之后(包括3.0)，默认淘汰策略是<code>noeviction</code>。</p>
<p>  在3.0及之后的版本，Redis 在使用的内存空间超过 maxmemory 值时，并不会淘汰数据。</p>
<p>  对应到 Redis 缓存，也就是指，一旦缓存被写满了，再有写请求来时，Redis 不再提供服务，而是直接返回错误。</p>
<h2 id="4-1-Redis内存淘汰机制如何启用"><a href="#4-1-Redis内存淘汰机制如何启用" class="headerlink" title="(4.1) Redis内存淘汰机制如何启用"></a>(4.1) Redis内存淘汰机制如何启用</h2><p>  Redis 的内存淘汰机制是如何启用近似 LRU 算法的</p>
<p>和Redis配置文件<code>redis.conf</code>中的两个配置参数有关：</p>
<p>  <code>maxmemory</code>，该配置项设定了 Redis server 可以使用的最大内存容量，一旦 server 使用的实际内存量超出该阈值时，server 就会根据 maxmemory-policy 配置项定义的策略，执行内存淘汰操作；</p>
<p>  <code>maxmemory-policy</code>，该配置项设定了 Redis server 的内存淘汰策略，主要包括近似 LRU 算法、LFU 算法、按 TTL 值淘汰和随机淘汰等几种算法。</p>
<br>


<h1 id="5-Redis里缓存淘汰算法原理"><a href="#5-Redis里缓存淘汰算法原理" class="headerlink" title="(5) Redis里缓存淘汰算法原理"></a>(5) Redis里缓存淘汰算法原理</h1><h2 id="5-1-Redis-LRU"><a href="#5-1-Redis-LRU" class="headerlink" title="(5.1) Redis-LRU"></a>(5.1) Redis-LRU</h2><p>  LRU 算法在实际实现时，需要用链表管理所有的缓存数据，这会带来额外的空间开销。</p>
<p>  而且，当有数据被访问时，需要在链表上把该数据移动到 MRU 端，如果有大量数据被访问，就会带来很多链表移动操作，会很耗时，进而会降低 Redis 性能。</p>
<p>  在 Redis 中，LRU 算法被做了简化，以减轻数据淘汰对缓存性能的影响。</p>
<p>  Redis 并没有为所有的数据维护一个全局的链表，而是通过随机采样方式，选取一定数量（例如 100 个）的数据放入候选集合，后续在候选集合中根据 lru 字段值的大小进行筛选。</p>
<!--
  具体来说，Redis 默认会记录每个数据的最近一次访问的时间戳（由键值对数据结构 RedisObject 中的 lru 字段记录）。
  然后，Redis 在决定淘汰的数据时，第一次会随机选出 N 个数据，把它们作为一个候选集合。接下来，Redis 会比较这 N 个数据的 lru 字段，把 lru 字段值最小的数据从缓存中淘汰出去。

Redis 提供了一个配置参数 maxmemory-samples，这个参数就是 Redis 选出的数据个数 N。

 我们执行如下命令，可以让 Redis 选出 100 个数据作为候选数据集：

<pre class="line-numbers language-log" data-language="log"><code class="language-log">CONFIG SET maxmemory<span class="token operator">-</span>samples <span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当需要再次淘汰数据时，Redis 需要挑选数据进入第一次淘汰时创建的候选集合。这儿的挑选标准是：能进入候选集合的数据的 lru 字段值必须小于候选集合中最小的 lru 值。当有新数据进入候选数据集后，如果候选数据集中的数据个数达到了 maxmemory-samples，Redis 就把候选数据集中 lru 字段值最小的数据淘汰出去。</p>
<p>这样一来，Redis 缓存不用为所有的数据维护一个大链表，也不用在每次数据访问时都移动链表项，提升了缓存的性能。</p>
<p>–&gt;</p>
<h2 id="3-2-Redis-LFU"><a href="#3-2-Redis-LFU" class="headerlink" title="(3.2) Redis-LFU"></a>(3.2) Redis-LFU</h2><p>  LFU 缓存策略是在 LRU 策略基础上，为每个数据增加了一个计数器，来统计这个数据的访问次数。</p>
<p>  当使用 LFU 策略筛选淘汰数据时，首先会根据数据的访问次数进行筛选，把访问次数最低的数据淘汰出缓存。<br>  如果两个数据的访问次数相同，LFU 策略再比较这两个数据的访问时效性，把距离上一次访问时间更久的数据淘汰出缓存。</p>
<p>Redis 在实现 LFU 策略的时候，只是把原来 24bit 大小的 lru 字段，又进一步拆分成了两部分。<br>ldt 值：lru 字段的前 16bit，表示数据的访问时间戳；<br>counter 值：lru 字段的后 8bit，表示数据的访问次数。</p>
<p>在实现 LFU 策略时，Redis 并没有采用数据每被访问一次，就给对应的 counter 值加 1 的计数规则，而是采用了一个更优化的计数规则。</p>
<p>LFU 策略实现的计数规则是：每当数据被访问一次时，首先，用计数器当前的值乘以配置项 lfu_log_factor 再加 1，再取其倒数，得到一个 p 值；然后，把这个 p 值和一个取值范围在（0，1）间的随机数 r 值比大小，只有 p 值大于 r 值时，计数器才加 1。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">double</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>RAND_MAX<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">double</span> p <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>baseval<span class="token operator">*</span>server<span class="token punctuation">.</span>lfu_log_factor<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> p<span class="token punctuation">)</span> counter<span class="token operator">++</span><span class="token punctuation">;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<br>


<h1 id="4-LRU源码解读"><a href="#4-LRU源码解读" class="headerlink" title="(4) LRU源码解读"></a>(4) LRU源码解读</h1><h2 id="4-1-全局LRU时钟值的计算"><a href="#4-1-全局LRU时钟值的计算" class="headerlink" title="(4.1) 全局LRU时钟值的计算"></a>(4.1) 全局LRU时钟值的计算</h2><p>   LRU算法需要知道数据的最近一次访问时间。因此，Redis设计了LRU时钟来记录数据每次访问的时间戳。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.h </span>

<span class="token comment">/*
 * redis对象
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObject</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 数据类型 （string/list/hash/set/zset等）</span>
    <span class="token keyword">unsigned</span> encoding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 编码方式 </span>
    <span class="token keyword">unsigned</span> lru<span class="token operator">:</span>LRU_BITS<span class="token punctuation">;</span>  <span class="token comment">// LRU时间(相对于全局 lru_clock) </span>
                            <span class="token comment">// 或 LFU数据(低8位保存频率 和 高16位保存访问时间)。  </span>
                            <span class="token comment">// LRU_BITS为24个bits</span>
    <span class="token keyword">int</span> refcount<span class="token punctuation">;</span>  <span class="token comment">// 引用计数  4字节</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>  <span class="token comment">// 指针 指向对象的值  8字节</span>
<span class="token punctuation">&#125;</span> robj<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.c</span>

<span class="token keyword">void</span> <span class="token function">initServerConfig</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 计算全局LRU时钟值</span>
    server<span class="token punctuation">.</span>lruclock <span class="token operator">=</span> <span class="token function">getLRUClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* 
 * 根据时钟分辨率返回 LRU 时钟。 
 * 这是一个减少位格式的时间，可用于设置和检查 redisObject 结构的 object->lru 字段。
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">getLRUClock</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// mstime()是毫秒时间戳  // mstime()/1000=秒级时间戳</span>
    <span class="token comment">// 与运算 保证值 &lt;= LRU_CLOCK_MAX</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">mstime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>LRU_CLOCK_RESOLUTION<span class="token punctuation">)</span> <span class="token operator">&amp;</span> LRU_CLOCK_MAX<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  从代码可以看出，LRU时钟精度是1000毫秒，也就是1秒。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LRU_BITS</span> <span class="token expression"><span class="token number">24</span></span></span>

<span class="token comment">// obj->lru的最大值 // LRU_CLOCK_MAX = 1^24 - 1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LRU_CLOCK_MAX</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>LRU_BITS<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> </span><span class="token comment">/* Max value of obj->lru */</span></span>

<span class="token comment">// LRU 时钟分辨率(毫秒)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LRU_CLOCK_RESOLUTION</span> <span class="token expression"><span class="token number">1000</span> </span><span class="token comment">/* LRU clock resolution in ms */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.c</span>

<span class="token comment">/* 
 * 返回UNIX毫秒时间戳
 * Return the UNIX time in milliseconds 
 */</span>
<span class="token class-name">mstime_t</span> <span class="token function">mstime</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">ustime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.c</span>

<span class="token comment">/*
 * 返回UNIX微秒时间戳 
 * Return the UNIX time in microseconds 
 */</span>
<span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">ustime</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> ust<span class="token punctuation">;</span>

    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ust <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>tv<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000000</span><span class="token punctuation">;</span>
    ust <span class="token operator">+=</span> tv<span class="token punctuation">.</span>tv_usec<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ust<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="4-2-在运行过程中LRU时钟值是如何更新的"><a href="#4-2-在运行过程中LRU时钟值是如何更新的" class="headerlink" title="(4.2) 在运行过程中LRU时钟值是如何更新的"></a>(4.2) 在运行过程中LRU时钟值是如何更新的</h2><p>  和 Redis server 在事件驱动框架中，定期运行的时间事件所对应的 serverCron 函数有关。</p>
<p>  serverCron 函数作为时间事件的回调函数，本身会按照一定的频率周期性执行，其频率值是由 Redis 配置文件 redis.conf 中的 hz 配置项决定的。</p>
<p>  hz 配置项的默认值是 10，这表示 serverCron 函数会每 100 毫秒(1秒 / 10 = 100 毫秒)运行一次。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.c</span>

<span class="token comment">/* This is our timer interrupt, called server.hz times per second.
 * Here is where we do a number of things that need to be done asynchronously.
 * For instance:
 *
 * - Active expired keys collection (it is also performed in a lazy way on
 *   lookup).
 * - Software watchdog.
 * - Update some statistic.
 * - Incremental rehashing of the DBs hash tables.
 * - Triggering BGSAVE / AOF rewrite, and handling of terminated children.
 * - Clients timeout of different kinds.
 * - Replication reconnection.
 * - Many more...
 *
 * Everything directly called here will be called server.hz times per second,
 * so in order to throttle execution of things we want to do less frequently
 * a macro is used: run_with_period(milliseconds) &#123; .... &#125;
 */</span>

<span class="token keyword">int</span> <span class="token function">serverCron</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">aeEventLoop</span> <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/* We have just LRU_BITS bits per object for LRU information.
     * So we use an (eventually wrapping) LRU clock.
     *
     * Note that even if the counter wraps it's not a big problem,
     * everything will still work but some object will appear younger
     * to Redis. However for this to happen a given object should never be
     * touched for all the time needed to the counter to wrap, which is
     * not likely.
     *
     * Note that you can change the resolution altering the
     * LRU_CLOCK_RESOLUTION define. */</span>
    <span class="token comment">// 默认情况下，每100毫秒调用getLRUClock函数更新一次全局LRU时钟值 </span>
    server<span class="token punctuation">.</span>lruclock <span class="token operator">=</span> <span class="token function">getLRUClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  这样一来，每个键值对就可以从全局 LRU 时钟获取最新的访问时间戳了。</p>
<h2 id="4-3-key-value-LRU时钟值的初始化与更新"><a href="#4-3-key-value-LRU时钟值的初始化与更新" class="headerlink" title="(4.3) key-value-LRU时钟值的初始化与更新"></a>(4.3) key-value-LRU时钟值的初始化与更新</h2><h3 id="4-3-1-key-LRU时钟初始化"><a href="#4-3-1-key-LRU时钟初始化" class="headerlink" title="(4.3.1) key-LRU时钟初始化"></a>(4.3.1) key-LRU时钟初始化</h3><p>  对于key-value来说，它的 LRU 时钟值最初是在这个键值对被创建的时候，进行初始化设置的，这个初始化操作是在 createObject 函数中调用的。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/object.c</span>

<span class="token comment">/*
 * 创建一个redisObject对象
 *
 * @param type redisObject的类型
 * @param *ptr 值的指针
 */</span>
robj <span class="token operator">*</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 为redisObject结构体分配内存空间</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">// 省略部分代码 </span>

    <span class="token comment">// 将lru字段设置为当前的 lruclock（分钟分辨率），或者 LFU 计数器。 </span>
    <span class="token comment">// 判断内存过期策略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lfu </span>
        <span class="token comment">// LFU_INIT_VAL=5 对应二进制是 0101 </span>
        <span class="token comment">// 或运算 </span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lru </span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="4-3-2-key-LRU时钟更新"><a href="#4-3-2-key-LRU时钟更新" class="headerlink" title="(4.3.2) key-LRU时钟更新"></a>(4.3.2) key-LRU时钟更新</h3><p>  只要一个key被访问了，它的 LRU 时钟值就会被更新。而当一个键值对被访问时，访问操作最终都会调用 <code>lookupKey</code> 函数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/db.c</span>

<span class="token comment">/* 
 * 低级key查找API
 * 实际上并没有直接从应该依赖lookupKeyRead()、lookupKeyWrite()和lookupKeyReadWithFlags()的命令实现中调用。
 */</span>
robj <span class="token operator">*</span><span class="token function">lookupKey</span><span class="token punctuation">(</span>redisDb <span class="token operator">*</span>db<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    dictEntry <span class="token operator">*</span>de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>db<span class="token operator">-></span>dict<span class="token punctuation">,</span>key<span class="token operator">-></span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果节点存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 从节点里获取redisObject</span>
        robj <span class="token operator">*</span>val <span class="token operator">=</span> <span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* 
         * 更新老化算法的访问时间。
         * 如果我们有一个正在保存的子进程，请不要这样做，因为这会触发疯狂写入副本。
         */</span>
        <span class="token comment">// 没有活跃子进程 并且  </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasActiveChildProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> LOOKUP_NOTOUCH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 更新lfu</span>
                <span class="token function">updateLFU</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 更新lru时间</span>
                val<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<br>


<h2 id="4-4-近似LRU算法的实际执行"><a href="#4-4-近似LRU算法的实际执行" class="headerlink" title="(4.4) 近似LRU算法的实际执行"></a>(4.4) 近似LRU算法的实际执行</h2><p>  Redis 之所以实现近似 LRU 算法的目的，是为了减少内存资源和操作时间上的开销。<br>  何时触发算法执行？<br>  算法具体如何执行？</p>
<h3 id="4-4-1-触发时机"><a href="#4-4-1-触发时机" class="headerlink" title="(4.4.1) 触发时机"></a>(4.4.1) 触发时机</h3><p>  近似 LRU 算法的主要逻辑是在 freeMemoryIfNeeded 函数中实现的</p>
<p>  processCommand -&gt; freeMemoryIfNeededAndSafe -&gt; freeMemoryIfNeeded</p>
<h3 id="4-4-2-近似LRU算法执行"><a href="#4-4-2-近似LRU算法执行" class="headerlink" title="(4.4.2) 近似LRU算法执行"></a>(4.4.2) 近似LRU算法执行</h3><p>主要分3大步</p>
<ol>
<li>判断当前内存使用情况-getMaxmemoryState</li>
<li>更新待淘汰的候选键值对集合-evictionPoolPopulate</li>
<li>选择被淘汰的键值对并删除-freeMemoryIfNeeded</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* This function is periodically called to see if there is memory to free
 * according to the current "maxmemory" settings. In case we are over the
 * memory limit, the function will try to free some memory to return back
 * under the limit.
 *
 * The function returns C_OK if we are under the memory limit or if we
 * were over the limit, but the attempt to free memory was successful.
 * Otherwise if we are over the memory limit, but not enough memory
 * was freed to return back under the limit, the function returns C_ERR. 
 */</span>
<span class="token keyword">int</span> <span class="token function">freeMemoryIfNeeded</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> keys_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* By default replicas should ignore maxmemory
     * and just be masters exact copies. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>repl_slave_ignore_maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token class-name">size_t</span> mem_reported<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">,</span> mem_freed<span class="token punctuation">;</span>
    <span class="token class-name">mstime_t</span> latency<span class="token punctuation">,</span> eviction_latency<span class="token punctuation">,</span> lazyfree_latency<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> delta<span class="token punctuation">;</span>
    <span class="token keyword">int</span> slaves <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>

    <span class="token comment">/* When clients are paused the dataset should be static not just from the
     * POV of clients not being able to write, but also from the POV of
     * expires and evictions of keys not being performed. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientsArePaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">// 如果当前内存使用量没有超过 maxmemory，返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_reported<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>mem_tofree<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span>
        <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">// 已经释放的内存大小</span>
    mem_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_NO_EVICTION<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* We need to free memory, but policy forbids. */</span>

    <span class="token comment">// 已经释放的内存大小 &lt; 计划要释放的内存大小</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>mem_freed <span class="token operator">&lt;</span> mem_tofree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> next_db <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        sds bestkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bestdbid<span class="token punctuation">;</span>
        redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>
        dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MAXMEMORY_FLAG_LRU<span class="token operator">|</span>MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token operator">||</span>
            server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 淘汰池 / 采样key集合</span>
            <span class="token keyword">struct</span> <span class="token class-name">evictionPoolEntry</span> <span class="token operator">*</span>pool <span class="token operator">=</span> EvictionPoolLRU<span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>bestkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> total_keys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> keys<span class="token punctuation">;</span>

                <span class="token comment">// 在keys过期时我们不想创建本地数据库去选择(哪些key删除)，</span>
                <span class="token comment">// 因此开始在每个数据库中填充采样key的淘汰池。 </span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>i<span class="token punctuation">;</span>
                    dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token operator">?</span>
                            db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keys <span class="token operator">=</span> <span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> dict<span class="token punctuation">,</span> db<span class="token operator">-></span>dict<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        total_keys <span class="token operator">+=</span> keys<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>total_keys<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">/* No keys to evict. */</span>

                <span class="token comment">/* Go backward from best to worst element to evict. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>dict<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>expires<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token comment">/* Remove the entry from the pool. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span>
                        <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                    <span class="token comment">/* If the key exists, is our pick. Otherwise it is
                     * a ghost and we need to try the next element. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">/* Ghost... Iterate again. */</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* volatile-random and allkeys-random policy */</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM <span class="token operator">||</span>
                 server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_RANDOM<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">/* When evicting a random key, we try to evict a key for
             * each DB, so we use the static 'next_db' variable to
             * incrementally visit all DBs. */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">++</span>next_db<span class="token punctuation">)</span> <span class="token operator">%</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span>
                db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>j<span class="token punctuation">;</span>
                dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM<span class="token punctuation">)</span> <span class="token operator">?</span>
                        db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    de <span class="token operator">=</span> <span class="token function">dictGetRandomKey</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> j<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Finally remove the selected key. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>bestdbid<span class="token punctuation">;</span>
            robj <span class="token operator">*</span>keyobj <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">propagateExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* We compute the amount of memory freed by db*Delete() alone.
             * It is possible that actually the memory needed to propagate
             * the DEL in AOF and replication link is greater than the one
             * we are freeing removing the key, but we can't account for
             * that otherwise we would never exit the loop.
             *
             * Same for CSC invalidation messages generated by signalModifiedKey.
             *
             * AOF and Output buffer memory will be freed eventually so
             * we only care about memory used by the key space. */</span>
            delta <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span>
                <span class="token function">dbAsyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">dbSyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-del"</span><span class="token punctuation">,</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            delta <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mem_freed <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>stat_evictedkeys<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_EVICTED<span class="token punctuation">,</span> <span class="token string">"evicted"</span><span class="token punctuation">,</span>
                keyobj<span class="token punctuation">,</span> db<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">decrRefCount</span><span class="token punctuation">(</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            keys_freed<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token comment">/* When the memory to free starts to be big enough, we may
             * start spending so much time here that is impossible to
             * deliver data to the slaves fast enough, so we force the
             * transmission here inside the loop. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slaves<span class="token punctuation">)</span> <span class="token function">flushSlavesOutputBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Normally our stop condition is the ability to release
             * a fixed, pre-computed amount of memory. However when we
             * are deleting objects in another thread, it's better to
             * check, from time to time, if we already reached our target
             * memory, since the "mem_freed" amount is computed only
             * across the dbAsyncDelete() call, while the thread can
             * release the memory all the time. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>keys_freed <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">/* Let's satisfy our stop condition. */</span>
                    mem_freed <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* nothing to free... */</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>

cant_free<span class="token operator">:</span>
    <span class="token comment">/* We are here if we are not able to reclaim memory. There is only one
     * last thing we can try: check if the lazyfree thread has jobs in queue
     * and wait... */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">bioPendingJobsOfType</span><span class="token punctuation">(</span>BIO_LAZY_FREE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-lazyfree"</span><span class="token punctuation">,</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-cycle"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="4-4-2-1-判断当前内存使用情况-getMaxmemoryState"><a href="#4-4-2-1-判断当前内存使用情况-getMaxmemoryState" class="headerlink" title="(4.4.2.1) 判断当前内存使用情况-getMaxmemoryState"></a>(4.4.2.1) 判断当前内存使用情况-getMaxmemoryState</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* Get the memory status from the point of view of the maxmemory directive:
 * if the memory used is under the maxmemory setting then C_OK is returned.
 * Otherwise, if we are over the memory limit, the function returns
 * C_ERR.
 *
 * The function may return additional info via reference, only if the
 * pointers to the respective arguments is not NULL. Certain fields are
 * populated only when C_ERR is returned:
 *
 *  'total'     total amount of bytes used.
 *              (Populated both for C_ERR and C_OK)
 *
 *  'logical'   the amount of memory used minus the slaves/AOF buffers.
 *              (Populated when C_ERR is returned)
 *
 *  'tofree'    the amount of memory that should be released
 *              in order to return back into the memory limits.
 *              (Populated when C_ERR is returned)
 *
 *  'level'     this usually ranges from 0 to 1, and reports the amount of
 *              memory currently used. May be > 1 if we are over the memory
 *              limit.
 *              (Populated both for C_ERR and C_OK)
 */</span>
<span class="token keyword">int</span> <span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span>total<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>logical<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>tofree<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> mem_reported<span class="token punctuation">,</span> mem_used<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">;</span>

    <span class="token comment">/* Check if we are over the memory usage limit. If we are not, no need
     * to subtract the slaves output buffers. We can just return ASAP. */</span>
    mem_reported <span class="token operator">=</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token operator">*</span>total <span class="token operator">=</span> mem_reported<span class="token punctuation">;</span>

    <span class="token comment">/* We may return ASAP if there is no need to compute the level. */</span>
    <span class="token keyword">int</span> return_ok_asap <span class="token operator">=</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>maxmemory <span class="token operator">||</span> mem_reported <span class="token operator">&lt;=</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>return_ok_asap <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>level<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Remove the size of slaves output buffers and AOF buffer from the
     * count of used memory. */</span>
    mem_used <span class="token operator">=</span> mem_reported<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> overhead <span class="token operator">=</span> <span class="token function">freeMemoryGetNotCountedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mem_used <span class="token operator">=</span> <span class="token punctuation">(</span>mem_used <span class="token operator">></span> overhead<span class="token punctuation">)</span> <span class="token operator">?</span> mem_used<span class="token operator">-</span>overhead <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* Compute the ratio of memory usage. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>level <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>mem_used <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>return_ok_asap<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Check if we are still over the memory limit. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_used <span class="token operator">&lt;=</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Compute how much memory we need to free. */</span>
    mem_tofree <span class="token operator">=</span> mem_used <span class="token operator">-</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>logical<span class="token punctuation">)</span> <span class="token operator">*</span>logical <span class="token operator">=</span> mem_used<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tofree<span class="token punctuation">)</span> <span class="token operator">*</span>tofree <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>

    <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="4-4-2-2-更新待淘汰的候选键值对集合-evictionPoolPopulate"><a href="#4-4-2-2-更新待淘汰的候选键值对集合-evictionPoolPopulate" class="headerlink" title="(4.4.2.2) 更新待淘汰的候选键值对集合-evictionPoolPopulate"></a>(4.4.2.2) 更新待淘汰的候选键值对集合-evictionPoolPopulate</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* This is an helper function for freeMemoryIfNeeded(), it is used in order
 * to populate the evictionPool with a few entries every time we want to
 * expire a key. Keys with idle time smaller than one of the current
 * keys are added. Keys are always added if there are free entries.
 *
 * We insert keys on place in ascending order, so keys with the smaller
 * idle time are on the left, and keys with the higher idle time on the
 * right. */</span>

<span class="token keyword">void</span> <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span><span class="token keyword">int</span> dbid<span class="token punctuation">,</span> dict <span class="token operator">*</span>sampledict<span class="token punctuation">,</span> dict <span class="token operator">*</span>keydict<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">evictionPoolEntry</span> <span class="token operator">*</span>pool<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> count<span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>samples<span class="token punctuation">[</span>server<span class="token punctuation">.</span>maxmemory_samples<span class="token punctuation">]</span><span class="token punctuation">;</span>

    count <span class="token operator">=</span> <span class="token function">dictGetSomeKeys</span><span class="token punctuation">(</span>sampledict<span class="token punctuation">,</span>samples<span class="token punctuation">,</span>server<span class="token punctuation">.</span>maxmemory_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> idle<span class="token punctuation">;</span>
        sds key<span class="token punctuation">;</span>
        robj <span class="token operator">*</span>o<span class="token punctuation">;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

        de <span class="token operator">=</span> samples<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        key <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* If the dictionary we are sampling from is not the main
         * dictionary (but the expires one) we need to lookup the key
         * again in the key dictionary to obtain the value object. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">!=</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sampledict <span class="token operator">!=</span> keydict<span class="token punctuation">)</span> de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>keydict<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            o <span class="token operator">=</span> <span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Calculate the idle time according to the policy. This is called
         * idle just because the code initially handled LRU, but is in fact
         * just a score where an higher score means better candidate. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LRU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            idle <span class="token operator">=</span> <span class="token function">estimateObjectIdleTime</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* When we use an LRU policy, we sort the keys by idle time
             * so that we expire keys starting from greater idle time.
             * However when the policy is an LFU one, we have a frequency
             * estimation, and we want to evict keys with lower frequency
             * first. So inside the pool we put objects using the inverted
             * frequency subtracting the actual frequency to the maximum
             * frequency of 255. */</span>
            idle <span class="token operator">=</span> <span class="token number">255</span><span class="token operator">-</span><span class="token function">LFUDecrAndReturn</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* In this case the sooner the expire the better. */</span>
            idle <span class="token operator">=</span> ULLONG_MAX <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"Unknown eviction policy in evictionPoolPopulate()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Insert the element inside the pool.
         * First, find the first empty bucket or the first populated
         * bucket that has an idle time smaller than our idle time. */</span>
        k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> EVPOOL_SIZE <span class="token operator">&amp;&amp;</span>
               pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>
               pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">&lt;</span> idle<span class="token punctuation">)</span> k<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Can't insert if the element is &lt; the worst element we have
             * and there are no empty buckets. */</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> EVPOOL_SIZE <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Inserting into empty position. No setup needed before insert. */</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Inserting in the middle. Now k points to the first element
             * greater than the element to insert.  */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/* Free space on the right? Insert at k shifting
                 * all the elements from k to end to the right. */</span>

                <span class="token comment">/* Save SDS before overwriting. */</span>
                sds cached <span class="token operator">=</span> pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span>
                <span class="token function">memmove</span><span class="token punctuation">(</span>pool<span class="token operator">+</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>pool<span class="token operator">+</span>k<span class="token punctuation">,</span>
                    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>EVPOOL_SIZE<span class="token operator">-</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached <span class="token operator">=</span> cached<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/* No free space on right? Insert at k-1 */</span>
                k<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token comment">/* Shift all elements on the left of k (included) to the
                 * left, so we discard the element with smaller idle time. */</span>
                sds cached <span class="token operator">=</span> pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span> <span class="token comment">/* Save SDS before overwriting. */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span> <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">memmove</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span>pool<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached <span class="token operator">=</span> cached<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Try to reuse the cached SDS string allocated in the pool entry,
         * because allocating and deallocating this object is costly
         * (according to the profiler, not my fantasy. Remember:
         * premature optimization bla bla bla. */</span>
        <span class="token keyword">int</span> klen <span class="token operator">=</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>klen <span class="token operator">></span> EVPOOL_CACHED_SDS_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token function">sdsdup</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">,</span>key<span class="token punctuation">,</span>klen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sdssetlen</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">,</span>klen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> idle<span class="token punctuation">;</span>
        pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid <span class="token operator">=</span> dbid<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-4-2-3-选择被淘汰的键值对并删除-freeMemoryIfNeeded"><a href="#4-4-2-3-选择被淘汰的键值对并删除-freeMemoryIfNeeded" class="headerlink" title="(4.4.2.3) 选择被淘汰的键值对并删除-freeMemoryIfNeeded"></a>(4.4.2.3) 选择被淘汰的键值对并删除-freeMemoryIfNeeded</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* This function is periodically called to see if there is memory to free
 * according to the current "maxmemory" settings. In case we are over the
 * memory limit, the function will try to free some memory to return back
 * under the limit.
 *
 * The function returns C_OK if we are under the memory limit or if we
 * were over the limit, but the attempt to free memory was successful.
 * Otherwise if we are over the memory limit, but not enough memory
 * was freed to return back under the limit, the function returns C_ERR. */</span>
<span class="token keyword">int</span> <span class="token function">freeMemoryIfNeeded</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> keys_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* By default replicas should ignore maxmemory
     * and just be masters exact copies. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>repl_slave_ignore_maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token class-name">size_t</span> mem_reported<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">,</span> mem_freed<span class="token punctuation">;</span>
    <span class="token class-name">mstime_t</span> latency<span class="token punctuation">,</span> eviction_latency<span class="token punctuation">,</span> lazyfree_latency<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> delta<span class="token punctuation">;</span>
    <span class="token keyword">int</span> slaves <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>

    <span class="token comment">/* When clients are paused the dataset should be static not just from the
     * POV of clients not being able to write, but also from the POV of
     * expires and evictions of keys not being performed. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientsArePaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_reported<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>mem_tofree<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span>
        <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    mem_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_NO_EVICTION<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* We need to free memory, but policy forbids. */</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>mem_freed <span class="token operator">&lt;</span> mem_tofree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> next_db <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        sds bestkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bestdbid<span class="token punctuation">;</span>
        redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>
        dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MAXMEMORY_FLAG_LRU<span class="token operator">|</span>MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token operator">||</span>
            server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">struct</span> <span class="token class-name">evictionPoolEntry</span> <span class="token operator">*</span>pool <span class="token operator">=</span> EvictionPoolLRU<span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>bestkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> total_keys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> keys<span class="token punctuation">;</span>

                <span class="token comment">/* We don't want to make local-db choices when expiring keys,
                 * so to start populate the eviction pool sampling keys from
                 * every DB. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>i<span class="token punctuation">;</span>
                    dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token operator">?</span>
                            db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keys <span class="token operator">=</span> <span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> dict<span class="token punctuation">,</span> db<span class="token operator">-></span>dict<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        total_keys <span class="token operator">+=</span> keys<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>total_keys<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">/* No keys to evict. */</span>

                <span class="token comment">/* Go backward from best to worst element to evict. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>dict<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>expires<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token comment">/* Remove the entry from the pool. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span>
                        <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                    <span class="token comment">/* If the key exists, is our pick. Otherwise it is
                     * a ghost and we need to try the next element. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">/* Ghost... Iterate again. */</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* volatile-random and allkeys-random policy */</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM <span class="token operator">||</span>
                 server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_RANDOM<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">/* When evicting a random key, we try to evict a key for
             * each DB, so we use the static 'next_db' variable to
             * incrementally visit all DBs. */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">++</span>next_db<span class="token punctuation">)</span> <span class="token operator">%</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span>
                db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>j<span class="token punctuation">;</span>
                dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM<span class="token punctuation">)</span> <span class="token operator">?</span>
                        db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    de <span class="token operator">=</span> <span class="token function">dictGetRandomKey</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> j<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Finally remove the selected key. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>bestdbid<span class="token punctuation">;</span>
            robj <span class="token operator">*</span>keyobj <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">propagateExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* We compute the amount of memory freed by db*Delete() alone.
             * It is possible that actually the memory needed to propagate
             * the DEL in AOF and replication link is greater than the one
             * we are freeing removing the key, but we can't account for
             * that otherwise we would never exit the loop.
             *
             * Same for CSC invalidation messages generated by signalModifiedKey.
             *
             * AOF and Output buffer memory will be freed eventually so
             * we only care about memory used by the key space. */</span>
            delta <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span>
                <span class="token function">dbAsyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">dbSyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-del"</span><span class="token punctuation">,</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            delta <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mem_freed <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>stat_evictedkeys<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_EVICTED<span class="token punctuation">,</span> <span class="token string">"evicted"</span><span class="token punctuation">,</span>
                keyobj<span class="token punctuation">,</span> db<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">decrRefCount</span><span class="token punctuation">(</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            keys_freed<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token comment">/* When the memory to free starts to be big enough, we may
             * start spending so much time here that is impossible to
             * deliver data to the slaves fast enough, so we force the
             * transmission here inside the loop. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slaves<span class="token punctuation">)</span> <span class="token function">flushSlavesOutputBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Normally our stop condition is the ability to release
             * a fixed, pre-computed amount of memory. However when we
             * are deleting objects in another thread, it's better to
             * check, from time to time, if we already reached our target
             * memory, since the "mem_freed" amount is computed only
             * across the dbAsyncDelete() call, while the thread can
             * release the memory all the time. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>keys_freed <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">/* Let's satisfy our stop condition. */</span>
                    mem_freed <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* nothing to free... */</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>

cant_free<span class="token operator">:</span>
    <span class="token comment">/* We are here if we are not able to reclaim memory. There is only one
     * last thing we can try: check if the lazyfree thread has jobs in queue
     * and wait... */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">bioPendingJobsOfType</span><span class="token punctuation">(</span>BIO_LAZY_FREE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-lazyfree"</span><span class="token punctuation">,</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-cycle"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>





<h1 id="5-LFU源码解读"><a href="#5-LFU源码解读" class="headerlink" title="(5) LFU源码解读"></a>(5) LFU源码解读</h1><p>  LFU 算法的启用，是通过设置 Redis 配置文件 redis.conf 中的 maxmemory 和 maxmemory-policy。</p>
<p>LFU 算法的实现可以分成三部分内容，分别是键值对访问频率记录、键值对访问频率初始化和更新，以及LFU算法淘汰数据。</p>
<h2 id="5-1-键值对访问频率记录"><a href="#5-1-键值对访问频率记录" class="headerlink" title="(5.1) 键值对访问频率记录"></a>(5.1) 键值对访问频率记录</h2><p>  每个键值对的值都对应了一个 redisObject 结构体，其中有一个 24 bits 的 lru 变量。</p>
<p>  LRU 算法和 LFU 算法并不会同时使用。为了节省内存开销，Redis 源码就复用了 lru 变量来记录 LFU 算法所需的访问频率信息。</p>
<p>  记录LFU算法的所需信息时，它会用24 bits中的低8 bits作为计数器，来记录键值对的访问次数，同时它会用24 bits中的高16 bits，记录访问的时间戳。</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">|</span><span class="token operator">&lt;</span><span class="token separator comment">---</span>访问时间戳<span class="token separator comment">---</span><span class="token operator">></span><span class="token operator">|</span><span class="token operator">&lt;</span> 计数器 <span class="token operator">></span><span class="token operator">|</span> 

     <span class="token number">16</span> bits      <span class="token number">8</span> bits
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">+</span> Last decr time <span class="token operator">|</span> LOG_C  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>            <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="5-2-键值对访问频率初始化和更新"><a href="#5-2-键值对访问频率初始化和更新" class="headerlink" title="(5.2) 键值对访问频率初始化和更新"></a>(5.2) 键值对访问频率初始化和更新</h2><h3 id="5-2-1-初始化"><a href="#5-2-1-初始化" class="headerlink" title="(5.2.1) 初始化"></a>(5.2.1) 初始化</h3><p>  键值对 lru变量初始化是在 创建redisObject调用 <code>createObject</code> 函数时完成的。</p>
<p>主要分2步：<br>第一部是 lru 变量的高16位，是以1分钟为精度的 UNIX 时间戳。(LFUGetTimeInMinutes)<br>第二部是 lru 变量的低8位，被设置为宏定义 LFU_INIT_VAL，默认值为 5。</p>
<p>  源码如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/object.c</span>

<span class="token comment">/*
 * 创建一个redisObject对象
 *
 * @param type redisObject的类型
 * @param *ptr 值的指针
 */</span>
robj <span class="token operator">*</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 为redisObject结构体分配内存空间</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">// 省略部分代码 </span>

    <span class="token comment">// 将lru字段设置为当前的 lruclock（分钟分辨率），或者 LFU 计数器。 </span>
    <span class="token comment">// 判断内存过期策略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lfu </span>
        <span class="token comment">// LFU_INIT_VAL=5 对应二进制是 0101 </span>
        <span class="token comment">// 或运算  高16位是时间，低8位是次数， LFU_INIT_VAL = 5</span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lru </span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  counter会被初始化为<code>LFU_INIT_VAL</code>，默认5。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* ----------------------------------------------------------------------------
 * LFU (Least Frequently Used) implementation.
 * 
 * 为了实现 LFU（最不常用）驱逐策略，我们在每个对象中总共有 24 位空间，因为我们为此目的重新使用了 LRU 字段。
 *
 * 我们将 24 位分成两个字段：
 *
 *          16 bits      8 bits
 *     +----------------+--------+
 *     + Last decr time | LOG_C  |
 *     +----------------+--------+
 *
 * LOG_C 是提供访问频率指示的对数计数器。 
 * 然而，这个字段也必须递减，否则过去经常访问的键将永远保持这样的排名，而我们希望算法适应访问模式的变化。
 *
 * 因此，剩余的 16 位用于存储“递减时间”，
 * 这是一个精度降低的 Unix 时间(我们将 16 位时间转换为分钟，因为我们不关心回绕)，
 * 其中 LOG_C 计数器减半 如果它具有高值，或者如果它具有低值则只是递减。
 *
 * 新key不会从零开始，以便能够在被淘汰之前收集一些访问，因此它们从 COUNTER_INIT_VAL 开始。
 * COUNTER_INIT_VAL = 5
 * 因此从5(或具有较小值)开始的键在访问时递增的可能性非常高。
 *
 * 在递减期间，如果对数计数器的当前值大于5的两倍，则对数计数器的值减半，否则它只减一。
 * 
 * --------------------------------------------------------------------------*/</span>

<span class="token comment">/* 
 * 以分钟为单位返回当前时间，只取最低有效16位。 
 * 返回的时间适合存储为 LFU 实现的 LDT(最后递减时间)。
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 65535 = 2^16 - 1 对应二进制是 1111 1111 1111 1111</span>
    <span class="token comment">// (server.unixtime/60) &amp; 1111 1111 1111 1111</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>unixtime<span class="token operator">/</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">65535</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="5-2-2-更新LFU值"><a href="#5-2-2-更新LFU值" class="headerlink" title="(5.2.2) 更新LFU值"></a>(5.2.2) 更新LFU值</h3><p>  当一个键值对被访问时，Redis 会调用 lookupKey 函数进行查找。lookupKey 函数会调用 updateLFU 函数来更新键值对的访问频率。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/db.c</span>

<span class="token comment">/* 
 * 访问对象时更新 LFU。
 * 首先，如果达到递减时间，则递减计数器。
 * 然后以对数方式递增计数器，并更新访问时间。
 */</span>
<span class="token keyword">void</span> <span class="token function">updateLFU</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取计数器</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> counter <span class="token operator">=</span> <span class="token function">LFUDecrAndReturn</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新计数器</span>
    counter <span class="token operator">=</span> <span class="token function">LFULogIncr</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="5-2-2-1-递减计数器-LFUDecrAndReturn"><a href="#5-2-2-1-递减计数器-LFUDecrAndReturn" class="headerlink" title="(5.2.2.1) 递减计数器-LFUDecrAndReturn"></a>(5.2.2.1) 递减计数器-LFUDecrAndReturn</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * 如果达到对象递减时间，则 递减LFU计数器 但 不更新对象的LFU字段，
 * 我们在真正访问对象时以显式方式更新访问时间和计数器。
 * 
 * 并且我们将根据 经过的时间/server.lfu_decay_time 将计数器减半。
 * 返回对象频率计数器。
 * redis.conf配置文件里 lfu-decay-time 默认是 1
 * And we will times halve the counter according to the times of
 * elapsed time than server.lfu_decay_time.
 * 
 * 此函数用于扫描数据集以获得最佳对象
 *  适合：当我们检查候选对象时，如果需要，我们会递减扫描对象的计数器。
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">LFUDecrAndReturn</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 高16位存的是 上次访问时间(分钟级的) Last decr time </span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ldt <span class="token operator">=</span> o<span class="token operator">-></span>lru <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">;</span>

    <span class="token comment">// 255 对应二进制 1111 1111 </span>
    <span class="token comment">// o->lru &amp; 1111 1111 相当于取低8位的值</span>
    <span class="token comment">// 获取计数器</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> counter <span class="token operator">=</span> o<span class="token operator">-></span>lru <span class="token operator">&amp;</span> <span class="token number">255</span><span class="token punctuation">;</span>

    <span class="token comment">// 0 &lt;= LFUTimeElapsed(ldt) &lt;  65535</span>
    <span class="token comment">// 过了的分钟数 / server.lfu_decay_time</span>
    <span class="token comment">// num_periods 是过了 n轮 衰减时间(lfu_decay_time)</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> num_periods <span class="token operator">=</span> server<span class="token punctuation">.</span>lfu_decay_time <span class="token operator">?</span> <span class="token function">LFUTimeElapsed</span><span class="token punctuation">(</span>ldt<span class="token punctuation">)</span> <span class="token operator">/</span> server<span class="token punctuation">.</span>lfu_decay_time <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果经过的轮数不为0 (超过1分钟了)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_periods<span class="token punctuation">)</span> 
        <span class="token comment">// 如果 n轮衰减 > 访问次数，counter设置为0，相当于重新开始计算</span>
        <span class="token comment">// 否则，n轮衰减 &lt;= 访问次数，counter设置为 counter - num_periods，相当于每过1轮衰减时间(lfu_decay_time)，减1</span>
        counter <span class="token operator">=</span> <span class="token punctuation">(</span>num_periods <span class="token operator">></span> counter<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> counter <span class="token operator">-</span> num_periods<span class="token punctuation">;</span>

    <span class="token comment">// 如果没有超过1分钟，num_periods=0，直接返回counter</span>
    <span class="token comment">// 如果超过1分钟，num_periods！=0，至少过了1轮衰减时间(lfu_decay_time)了，更新counter后返回</span>
    <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  <code>LFUDecrAndReturn</code> 得到的计数结果</p>
<ol>
<li>如果在当前分钟时间戳内，counter不变</li>
<li>如果不在当前分钟时间戳内，每过1轮衰减时间(lfu_decay_time)，counter减1 (代码里是过了num_periods轮，减num_periods)</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * 计算过了多少分钟
 * 
 * 给定对象的上次访问时间，计算自上次访问以来经过的最小分钟数。 
 * 处理溢出(ldt 大于当前 16 位分钟时间)，将时间视为正好回绕一次。
 * 
 * @param ldt 上一次访问的时间(分钟级)
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">LFUTimeElapsed</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> ldt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取分钟级时间戳</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算过了多少分钟</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">>=</span> ldt<span class="token punctuation">)</span> <span class="token keyword">return</span> now<span class="token operator">-</span>ldt<span class="token punctuation">;</span>

    <span class="token comment">// 实际上now永远是在ldt(上一次访问时间之后)</span>
    <span class="token comment">// 但是现在 now &lt; ldt，不符合预期 </span>
    <span class="token comment">// ldt是 (server.unixtime/60) &amp; 1111 1111 1111 1111 得到的，相当于取余，也就是至少过了1轮了 </span>
    <span class="token comment">// 假设 ldt = 65534  now = 1，其实过了2分钟</span>
    <span class="token keyword">return</span> <span class="token number">65535</span><span class="token operator">-</span>ldt<span class="token operator">+</span>now<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="5-2-2-2-更新LFU计数器-LFULogIncr"><a href="#5-2-2-2-更新LFU计数器-LFULogIncr" class="headerlink" title="(5.2.2.2) 更新LFU计数器-LFULogIncr"></a>(5.2.2.2) 更新LFU计数器-LFULogIncr</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * 以对数方式递增计数器。 当前计数器值越大，它真正实现的可能性就越小。 在255时饱和。
 *
 * Logarithmically increment a counter. 
 * The greater is the current counter value
 * the less likely is that it gets really implemented. 
 * Saturate it at 255. 
 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">LFULogIncr</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> counter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 最大255</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">255</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取一个随机数</span>
    <span class="token keyword">double</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>RAND_MAX<span class="token punctuation">;</span>

    <span class="token comment">// 基础值 = counter - 5</span>
    <span class="token keyword">double</span> baseval <span class="token operator">=</span> counter <span class="token operator">-</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token comment">// 最小=0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>baseval <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> baseval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 取对数 </span>
    <span class="token keyword">double</span> p <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>baseval<span class="token operator">*</span>server<span class="token punctuation">.</span>lfu_log_factor<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 随机数 &lt; 对数时，计数器+1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> p<span class="token punctuation">)</span> counter<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  counter并不是简单的访问一次就+1，而是采用了一个0-1之间的p因子控制增长。</p>
<p>  <img src="/img/database/redis/cache-eviction/lfu/redis-lfu-log-1.png" alt="对数"></p>
<p>取一个0-1之间的随机数r与p比较，当<code>r &lt; p</code>时，才增加counter<br><code>p</code>取决于当前counter值与<code>lfu_log_factor</code>因子，<code>counter</code>值与<code>lfu_log_factor</code>因子越大，<code>p</code>越小，<code>r&lt;p</code>的概率也越小，counter增长的概率也就越小。</p>
<p>  增长情况如下</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> factor <span class="token operator">|</span> <span class="token number">100</span> hits   <span class="token operator">|</span> <span class="token number">1000</span> hits  <span class="token operator">|</span> <span class="token number">100K</span> hits  <span class="token operator">|</span> <span class="token number">1M</span> hits    <span class="token operator">|</span> <span class="token number">10M</span> hits   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span> <span class="token number">104</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span> <span class="token number">18</span>         <span class="token operator">|</span> <span class="token number">49</span>         <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token number">10</span>     <span class="token operator">|</span> <span class="token number">10</span>         <span class="token operator">|</span> <span class="token number">18</span>         <span class="token operator">|</span> <span class="token number">142</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token number">100</span>    <span class="token operator">|</span> <span class="token number">8</span>          <span class="token operator">|</span> <span class="token number">11</span>         <span class="token operator">|</span> <span class="token number">49</span>         <span class="token operator">|</span> <span class="token number">143</span>        <span class="token operator">|</span> <span class="token number">255</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="5-3-LFU算法淘汰数据"><a href="#5-3-LFU算法淘汰数据" class="headerlink" title="(5.3) LFU算法淘汰数据"></a>(5.3) LFU算法淘汰数据</h2><p>主要有三步<br>第一步，调用 getMaxmemoryState 函数计算待释放的内存空间；<br>第二步，调用 evictionPoolPopulate 函数随机采样键值对，并插入到待淘汰集合 EvictionPoolLRU 中；<br>第三步，遍历待淘汰集合 EvictionPoolLRU，选择实际被淘汰数据，并删除。</p>
<h3 id="5-3-1-判断当前内存使用情况-getMaxmemoryState"><a href="#5-3-1-判断当前内存使用情况-getMaxmemoryState" class="headerlink" title="(5.3.1) 判断当前内存使用情况-getMaxmemoryState"></a>(5.3.1) 判断当前内存使用情况-getMaxmemoryState</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* Get the memory status from the point of view of the maxmemory directive:
 * if the memory used is under the maxmemory setting then C_OK is returned.
 * Otherwise, if we are over the memory limit, the function returns
 * C_ERR.
 *
 * The function may return additional info via reference, only if the
 * pointers to the respective arguments is not NULL. Certain fields are
 * populated only when C_ERR is returned:
 *
 *  'total'     total amount of bytes used.
 *              (Populated both for C_ERR and C_OK)
 *
 *  'logical'   the amount of memory used minus the slaves/AOF buffers.
 *              (Populated when C_ERR is returned)
 *
 *  'tofree'    the amount of memory that should be released
 *              in order to return back into the memory limits.
 *              (Populated when C_ERR is returned)
 *
 *  'level'     this usually ranges from 0 to 1, and reports the amount of
 *              memory currently used. May be > 1 if we are over the memory
 *              limit.
 *              (Populated both for C_ERR and C_OK)
 */</span>
<span class="token keyword">int</span> <span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span>total<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>logical<span class="token punctuation">,</span> <span class="token class-name">size_t</span> <span class="token operator">*</span>tofree<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> mem_reported<span class="token punctuation">,</span> mem_used<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">;</span>

    <span class="token comment">/* Check if we are over the memory usage limit. If we are not, no need
     * to subtract the slaves output buffers. We can just return ASAP. */</span>
    mem_reported <span class="token operator">=</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token operator">*</span>total <span class="token operator">=</span> mem_reported<span class="token punctuation">;</span>

    <span class="token comment">/* We may return ASAP if there is no need to compute the level. */</span>
    <span class="token keyword">int</span> return_ok_asap <span class="token operator">=</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>maxmemory <span class="token operator">||</span> mem_reported <span class="token operator">&lt;=</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>return_ok_asap <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>level<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Remove the size of slaves output buffers and AOF buffer from the
     * count of used memory. */</span>
    mem_used <span class="token operator">=</span> mem_reported<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> overhead <span class="token operator">=</span> <span class="token function">freeMemoryGetNotCountedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mem_used <span class="token operator">=</span> <span class="token punctuation">(</span>mem_used <span class="token operator">></span> overhead<span class="token punctuation">)</span> <span class="token operator">?</span> mem_used<span class="token operator">-</span>overhead <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* Compute the ratio of memory usage. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>level <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>mem_used <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>return_ok_asap<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Check if we are still over the memory limit. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_used <span class="token operator">&lt;=</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token comment">/* Compute how much memory we need to free. */</span>
    mem_tofree <span class="token operator">=</span> mem_used <span class="token operator">-</span> server<span class="token punctuation">.</span>maxmemory<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>logical<span class="token punctuation">)</span> <span class="token operator">*</span>logical <span class="token operator">=</span> mem_used<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tofree<span class="token punctuation">)</span> <span class="token operator">*</span>tofree <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>

    <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="5-3-2-更新待淘汰的候选键值对集合-evictionPoolPopulate"><a href="#5-3-2-更新待淘汰的候选键值对集合-evictionPoolPopulate" class="headerlink" title="(5.3.2) 更新待淘汰的候选键值对集合-evictionPoolPopulate"></a>(5.3.2) 更新待淘汰的候选键值对集合-evictionPoolPopulate</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* This is an helper function for freeMemoryIfNeeded(), it is used in order
 * to populate the evictionPool with a few entries every time we want to
 * expire a key. Keys with idle time smaller than one of the current
 * keys are added. Keys are always added if there are free entries.
 *
 * We insert keys on place in ascending order, so keys with the smaller
 * idle time are on the left, and keys with the higher idle time on the
 * right. */</span>

<span class="token keyword">void</span> <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span><span class="token keyword">int</span> dbid<span class="token punctuation">,</span> dict <span class="token operator">*</span>sampledict<span class="token punctuation">,</span> dict <span class="token operator">*</span>keydict<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">evictionPoolEntry</span> <span class="token operator">*</span>pool<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> count<span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>samples<span class="token punctuation">[</span>server<span class="token punctuation">.</span>maxmemory_samples<span class="token punctuation">]</span><span class="token punctuation">;</span>

    count <span class="token operator">=</span> <span class="token function">dictGetSomeKeys</span><span class="token punctuation">(</span>sampledict<span class="token punctuation">,</span>samples<span class="token punctuation">,</span>server<span class="token punctuation">.</span>maxmemory_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> idle<span class="token punctuation">;</span>
        sds key<span class="token punctuation">;</span>
        robj <span class="token operator">*</span>o<span class="token punctuation">;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

        de <span class="token operator">=</span> samples<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        key <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* If the dictionary we are sampling from is not the main
         * dictionary (but the expires one) we need to lookup the key
         * again in the key dictionary to obtain the value object. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">!=</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sampledict <span class="token operator">!=</span> keydict<span class="token punctuation">)</span> de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>keydict<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            o <span class="token operator">=</span> <span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Calculate the idle time according to the policy. This is called
         * idle just because the code initially handled LRU, but is in fact
         * just a score where an higher score means better candidate. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LRU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            idle <span class="token operator">=</span> <span class="token function">estimateObjectIdleTime</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* When we use an LRU policy, we sort the keys by idle time
             * so that we expire keys starting from greater idle time.
             * However when the policy is an LFU one, we have a frequency
             * estimation, and we want to evict keys with lower frequency
             * first. So inside the pool we put objects using the inverted
             * frequency subtracting the actual frequency to the maximum
             * frequency of 255. */</span>
            idle <span class="token operator">=</span> <span class="token number">255</span><span class="token operator">-</span><span class="token function">LFUDecrAndReturn</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* In this case the sooner the expire the better. */</span>
            idle <span class="token operator">=</span> ULLONG_MAX <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"Unknown eviction policy in evictionPoolPopulate()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Insert the element inside the pool.
         * First, find the first empty bucket or the first populated
         * bucket that has an idle time smaller than our idle time. */</span>
        k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> EVPOOL_SIZE <span class="token operator">&amp;&amp;</span>
               pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>
               pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">&lt;</span> idle<span class="token punctuation">)</span> k<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Can't insert if the element is &lt; the worst element we have
             * and there are no empty buckets. */</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> EVPOOL_SIZE <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Inserting into empty position. No setup needed before insert. */</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* Inserting in the middle. Now k points to the first element
             * greater than the element to insert.  */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/* Free space on the right? Insert at k shifting
                 * all the elements from k to end to the right. */</span>

                <span class="token comment">/* Save SDS before overwriting. */</span>
                sds cached <span class="token operator">=</span> pool<span class="token punctuation">[</span>EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span>
                <span class="token function">memmove</span><span class="token punctuation">(</span>pool<span class="token operator">+</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>pool<span class="token operator">+</span>k<span class="token punctuation">,</span>
                    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>EVPOOL_SIZE<span class="token operator">-</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached <span class="token operator">=</span> cached<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/* No free space on right? Insert at k-1 */</span>
                k<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token comment">/* Shift all elements on the left of k (included) to the
                 * left, so we discard the element with smaller idle time. */</span>
                sds cached <span class="token operator">=</span> pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span> <span class="token comment">/* Save SDS before overwriting. */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span> <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">memmove</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span>pool<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached <span class="token operator">=</span> cached<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Try to reuse the cached SDS string allocated in the pool entry,
         * because allocating and deallocating this object is costly
         * (according to the profiler, not my fantasy. Remember:
         * premature optimization bla bla bla. */</span>
        <span class="token keyword">int</span> klen <span class="token operator">=</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>klen <span class="token operator">></span> EVPOOL_CACHED_SDS_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token function">sdsdup</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">,</span>key<span class="token punctuation">,</span>klen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sdssetlen</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">,</span>klen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> idle<span class="token punctuation">;</span>
        pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid <span class="token operator">=</span> dbid<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-3-3-选择被淘汰的键值对并删除-freeMemoryIfNeeded"><a href="#5-3-3-选择被淘汰的键值对并删除-freeMemoryIfNeeded" class="headerlink" title="(5.3.3) 选择被淘汰的键值对并删除-freeMemoryIfNeeded"></a>(5.3.3) 选择被淘汰的键值对并删除-freeMemoryIfNeeded</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/evict.c</span>

<span class="token comment">/* This function is periodically called to see if there is memory to free
 * according to the current "maxmemory" settings. In case we are over the
 * memory limit, the function will try to free some memory to return back
 * under the limit.
 *
 * The function returns C_OK if we are under the memory limit or if we
 * were over the limit, but the attempt to free memory was successful.
 * Otherwise if we are over the memory limit, but not enough memory
 * was freed to return back under the limit, the function returns C_ERR. */</span>
<span class="token keyword">int</span> <span class="token function">freeMemoryIfNeeded</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> keys_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* By default replicas should ignore maxmemory
     * and just be masters exact copies. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>repl_slave_ignore_maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    <span class="token class-name">size_t</span> mem_reported<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">,</span> mem_freed<span class="token punctuation">;</span>
    <span class="token class-name">mstime_t</span> latency<span class="token punctuation">,</span> eviction_latency<span class="token punctuation">,</span> lazyfree_latency<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> delta<span class="token punctuation">;</span>
    <span class="token keyword">int</span> slaves <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>

    <span class="token comment">/* When clients are paused the dataset should be static not just from the
     * POV of clients not being able to write, but also from the POV of
     * expires and evictions of keys not being performed. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientsArePaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_reported<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>mem_tofree<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span>
        <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

    mem_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_NO_EVICTION<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* We need to free memory, but policy forbids. */</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>mem_freed <span class="token operator">&lt;</span> mem_tofree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> next_db <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        sds bestkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bestdbid<span class="token punctuation">;</span>
        redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>
        dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MAXMEMORY_FLAG_LRU<span class="token operator">|</span>MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token operator">||</span>
            server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">struct</span> <span class="token class-name">evictionPoolEntry</span> <span class="token operator">*</span>pool <span class="token operator">=</span> EvictionPoolLRU<span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>bestkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> total_keys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> keys<span class="token punctuation">;</span>

                <span class="token comment">/* We don't want to make local-db choices when expiring keys,
                 * so to start populate the eviction pool sampling keys from
                 * every DB. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>i<span class="token punctuation">;</span>
                    dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token operator">?</span>
                            db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keys <span class="token operator">=</span> <span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> dict<span class="token punctuation">,</span> db<span class="token operator">-></span>dict<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        total_keys <span class="token operator">+=</span> keys<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>total_keys<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">/* No keys to evict. */</span>

                <span class="token comment">/* Go backward from best to worst element to evict. */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>dict<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>expires<span class="token punctuation">,</span>
                            pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token comment">/* Remove the entry from the pool. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span>
                        <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                    <span class="token comment">/* If the key exists, is our pick. Otherwise it is
                     * a ghost and we need to try the next element. */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">/* Ghost... Iterate again. */</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* volatile-random and allkeys-random policy */</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM <span class="token operator">||</span>
                 server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_RANDOM<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">/* When evicting a random key, we try to evict a key for
             * each DB, so we use the static 'next_db' variable to
             * incrementally visit all DBs. */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">++</span>next_db<span class="token punctuation">)</span> <span class="token operator">%</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span>
                db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>j<span class="token punctuation">;</span>
                dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM<span class="token punctuation">)</span> <span class="token operator">?</span>
                        db<span class="token operator">-></span>dict <span class="token operator">:</span> db<span class="token operator">-></span>expires<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    de <span class="token operator">=</span> <span class="token function">dictGetRandomKey</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bestdbid <span class="token operator">=</span> j<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Finally remove the selected key. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>bestdbid<span class="token punctuation">;</span>
            robj <span class="token operator">*</span>keyobj <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">propagateExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* We compute the amount of memory freed by db*Delete() alone.
             * It is possible that actually the memory needed to propagate
             * the DEL in AOF and replication link is greater than the one
             * we are freeing removing the key, but we can't account for
             * that otherwise we would never exit the loop.
             *
             * Same for CSC invalidation messages generated by signalModifiedKey.
             *
             * AOF and Output buffer memory will be freed eventually so
             * we only care about memory used by the key space. */</span>
            delta <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span>
                <span class="token function">dbAsyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">dbSyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-del"</span><span class="token punctuation">,</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
            delta <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mem_freed <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>stat_evictedkeys<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_EVICTED<span class="token punctuation">,</span> <span class="token string">"evicted"</span><span class="token punctuation">,</span>
                keyobj<span class="token punctuation">,</span> db<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">decrRefCount</span><span class="token punctuation">(</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            keys_freed<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token comment">/* When the memory to free starts to be big enough, we may
             * start spending so much time here that is impossible to
             * deliver data to the slaves fast enough, so we force the
             * transmission here inside the loop. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slaves<span class="token punctuation">)</span> <span class="token function">flushSlavesOutputBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Normally our stop condition is the ability to release
             * a fixed, pre-computed amount of memory. However when we
             * are deleting objects in another thread, it's better to
             * check, from time to time, if we already reached our target
             * memory, since the "mem_freed" amount is computed only
             * across the dbAsyncDelete() call, while the thread can
             * release the memory all the time. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>keys_freed <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">/* Let's satisfy our stop condition. */</span>
                    mem_freed <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* nothing to free... */</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>

cant_free<span class="token operator">:</span>
    <span class="token comment">/* We are here if we are not able to reclaim memory. There is only one
     * last thing we can try: check if the lazyfree thread has jobs in queue
     * and wait... */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">bioPendingJobsOfType</span><span class="token punctuation">(</span>BIO_LAZY_FREE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-lazyfree"</span><span class="token punctuation">,</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-cycle"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>



<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/294640">Redis 核心技术与实战 - 24 | 替换策略：缓存满了怎么办？</a><br>[2] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/297270">Redis 核心技术与实战 - 27 | 缓存被污染了，该怎么办？</a><br>[3] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/412164">Redis 源码剖析与实战 - 15 | 为什么LRU算法原理和代码实现不一样？</a><br>[4] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/413038">Redis 源码剖析与实战 - 16 | LFU算法和其他算法相比有优势吗？</a><br>[5] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/linxiyue/p/10955533.html">Redis中的LFU算法</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/02/26/redis-command-execution-process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/26/redis-command-execution-process/" class="post-title-link" itemprop="url">Redis命令执行流程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-26 19:22:27" itemprop="dateCreated datePublished" datetime="2022-02-26T19:22:27+08:00">2022-02-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-01-30 23:09:30" itemprop="dateModified" datetime="2023-01-30T23:09:30+08:00">2023-01-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-Redis实现分布式锁"><a href="#1-Redis实现分布式锁" class="headerlink" title="(1) Redis实现分布式锁"></a>(1) Redis实现分布式锁</h1><p>  通过Redis <code>SET key value NX</code> 可以简单地实现分布式锁。</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>  SET key_lock value1 NX
OK
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>  SET key_lock value1 NX
<span class="token operator">(</span>nil<span class="token operator">)</span>
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 在解锁时可以先判断key是否存在，然后对比值是否相等，相等后再删除key，释放锁。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/02/26/redis-command-execution-process/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/02/20/counter-service-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/20/counter-service-design/" class="post-title-link" itemprop="url">计数服务设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-20 23:19:06" itemprop="dateCreated datePublished" datetime="2022-02-20T23:19:06+08:00">2022-02-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-02 17:06:34" itemprop="dateModified" datetime="2022-12-02T17:06:34+08:00">2022-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/basic/" itemprop="url" rel="index"><span itemprop="name">basic</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  在Feed流的推荐信息里，一般都会有<code>点赞数</code>、<code>收藏数</code>、<code>评论数</code>、<code>转发数</code> 的功能，假设让你设计这套计数系统，你会怎么设计？</p>
<h1 id="1-背景"><a href="#1-背景" class="headerlink" title="(1) 背景"></a>(1) 背景</h1><p>  以微信、抖音、快手、微博 为例，推荐的朋友圈、视频或文章里会有<code>点赞数</code>、<code>收藏数</code>、<code>评论数</code>、<code>转发数</code>，假如要设计，一般设计成一个简单的kv查询。</p>
<p>考虑因素如下：<br>1、预估用户  14亿<br>2、预估活跃用户数 0.01 ~ 6亿。<br>3、假设每个用户每天发1~3个信息/动态，  每天大概有 0.01亿 ~ 18亿条信息(动态)。 每条信息(动态)上都有<code>点赞数</code>、<code>收藏数</code>、<code>评论数</code>、<code>转发数</code>。</p>
<p>备注: 一条信息(动态)代表一个朋友圈动态或一个抖音视频或一篇微博动态。</p>
<br>

<h1 id="2-信息Id设计"><a href="#2-信息Id设计" class="headerlink" title="(2) 信息Id设计"></a>(2) 信息Id设计</h1><p>  如果只考虑用户信息的ID查询，只要保证动态Id唯一即可；考虑到要按照用户维度去展示用户的信息列表，信息ID里最好包含用户ID，这样方便查询某个用户发布的所有的信息(动态)。<br>  类似于电商场景查询某个用户的所有订单。</p>
<p>  信息有个唯一表示，用rec_id表示<br>  根据推荐信息唯一标识rec_id获取<code>点赞数</code>、<code>收藏数</code>、<code>评论数</code>、<code>转发数</code> 是一个简单查询。</p>
<h2 id="2-1-用数字表示信息ID"><a href="#2-1-用数字表示信息ID" class="headerlink" title="(2.1) 用数字表示信息ID"></a>(2.1) 用数字表示信息ID</h2><p> int类型占用4字节，32位，最多可以表示 2^32个数字，考虑上符号，以及0，正数最多有 2^31-1 = 21 4748 3647 个，大概21亿多。</p>
<p> long类型占用8字节，64位，最多可以表示 2^64个数字，考虑到id都是正数，而且一般不用0，所以最多有 2^63-1 = 922 3372 0368 5477 5807 个，大概922亿亿个。</p>
<p>  可以用8字节的Long类型表示信息ID(msg_id)，msg_id的设计可以参考雪花算法的思想， 64位可以按照 符号位(1位)、城市(6位)、用户(8-10位)、时间戳()、随机字符()等来设计。</p>
<br>


<h1 id="3-计数器设计"><a href="#3-计数器设计" class="headerlink" title="(3) 计数器设计"></a>(3) 计数器设计</h1><h2 id="3-1-使用数据库做计数器"><a href="#3-1-使用数据库做计数器" class="headerlink" title="(3.1) 使用数据库做计数器"></a>(3.1) 使用数据库做计数器</h2><p>  在刚开始阶段，用户较少并且用户发布的信息/动态较少时，可以使用数据库来存储。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> msg_count <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键id'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>msg_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>like_num<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'点赞数'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>comments_num<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'评论数'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>favor_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'收藏数'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>forwards_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'转发数'</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uq_idx_msg_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>msg_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'信息(动态)计数表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>  按信息ID(msg_id)取模，把数据拆分到N个表(N是2的幂次方)。<br>  如果要扩容，把N个表拆成 <code>N * 2^x</code>，迁移数据时只需要把 1个表拆到 <code>2^x</code>个表即可。</p>
<p>访问量太大怎么办?<br>  使用缓存+数据库，先查缓存，缓存查不到再查数据库。</p>
<p>问题：<br>  1、空数据也得Cache(有一半以上的微博是没有转发也没有评论的，但是依然有大量的访问会查询数据库);<br>  2、Cache频繁失效(由于计数更新非常快，所以经常需要失效Cache再重新缓存，还会导致数据不一致);</p>
<p>  更好的硬件解决。 上FusionIO + HandleSocket + 大内存 优化。</p>
<p>  总的来说，MySQL分库分表 + Cache加速的方案 对于数据规模和访问量不是特别巨大的情况下，是非常不错的解决方案。</p>
<br>


<h2 id="3-2-使用Redis做缓存"><a href="#3-2-使用Redis做缓存" class="headerlink" title="(3.2) 使用Redis做缓存"></a>(3.2) 使用Redis做缓存</h2><p>  Redis作为一个简单的内存数据库，提供了多种数据类型，可以使用<code>string</code>类型的 incr 来计数。<br>  具体命令参考 <a target="_blank" rel="noopener" href="https://redis.io/commands/incr/">https://redis.io/commands/incr/</a> </p>
<p>  简单的来估算一下数据存储量，按照Redis 6.0.0的实现，在64位系统，指针为8字节来估算</p>
<p>  假设 key 为8字节，value为 4字节，通过incr存储的话<br>  key value 会存储在 dictEntry里，详细的结构:  <code>redisServer -&gt; db0 -&gt; dict -&gt; ht[0] -&gt; dictht -&gt; dictEntry</code></p>
<p>  <img src="/img/database/redis/index-model/redis-index-model.png" alt="redis索引模型"></p>
<p>  放到db-&gt;dict-&gt;ht[0]-&gt;table中存储dictEntry的指针，需要8个字节;<br>  存储一个kv首先需要一个dictEntry，dictEntry里面有3个指针，每个指针占用8字节，占用 3*8字节=24字节<br>  key的指针指向一个RedisObject(16字节)，RedisObject的ptr又指向一个SDS，一个Key(msg_id 8字节)通过sds存储，需要 8+</p>
<h1 id="4-系统安全问题"><a href="#4-系统安全问题" class="headerlink" title="(4) 系统安全问题"></a>(4) 系统安全问题</h1><h2 id="4-1-系统怎么应对爬虫？"><a href="#4-1-系统怎么应对爬虫？" class="headerlink" title="(4.1)  系统怎么应对爬虫？"></a>(4.1)  系统怎么应对爬虫？</h2><p>  网关+风控处理</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://blog.cydu.net/weidesign/2012/08/30/weibo-counter-service-design-1/">[WeiDesign]微博计数器的设计(上)</a><br>[2] <a target="_blank" rel="noopener" href="https://blog.cydu.net/weidesign/2012/09/09/weibo-counter-service-design-2/">[WeiDesign]微博计数器的设计(下)</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/22/redis-data-structure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/22/redis-data-structure/" class="post-title-link" itemprop="url">redis数据结构-存亿级数据需要耗费多少内存</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-22 15:53:48" itemprop="dateCreated datePublished" datetime="2022-01-22T15:53:48+08:00">2022-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-04 16:02:42" itemprop="dateModified" datetime="2022-12-04T16:02:42+08:00">2022-12-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　同事在实现一个弹窗需求时遇到一个问题，找大家讨论方案，产品的需求是小程序首页各种弹窗太多了，用户一进来需要点多个弹窗，要求服务端限制在首页一个用户一天只能弹一次。当时考虑了数据库和缓存，从实现简易程度、扩展性、速度综合考虑最后选了redis缓存。</p>
<h1 id="Redis数据类型"><a href="#Redis数据类型" class="headerlink" title="Redis数据类型"></a>Redis数据类型</h1><p> <img src=""></p>
<p>五种数据形式的底层实现<br>  string：简单动态字符串<br>  list：双向链表，压缩列表<br>  hash：压缩列表，哈希表<br>  Sorted Set：压缩列表，跳表<br>  set：哈希表，整数数组</p>
<h1 id="3-redis常用数据类型-对象"><a href="#3-redis常用数据类型-对象" class="headerlink" title="(3) redis常用数据类型/对象"></a>(3) redis常用数据类型/对象</h1><p>  上面介绍了 6 种底层数据结构，Redis 并没有直接使用这些数据结构来实现键值数据库，而是基于这些数据结构创建了一个对象系统，这个系统包含字符串对象、列表对象、哈希对象、集合对象和有序集合这五种类型的对象，每个对象都使用到了至少一种前边讲的底层数据结构。</p>
<p>redis常用的数据对象有以下几种</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* The actual Redis Object *&#x2F;
#define OBJ_STRING 0    &#x2F;* String object. *&#x2F;
#define OBJ_LIST 1      &#x2F;* List object. *&#x2F;
#define OBJ_SET 2       &#x2F;* Set object. *&#x2F;
#define OBJ_ZSET 3      &#x2F;* Sorted set object. *&#x2F;
#define OBJ_HASH 4      &#x2F;* Hash object. *&#x2F;

#define OBJ_MODULE 5    &#x2F;* Module object. *&#x2F;
#define OBJ_STREAM 6    &#x2F;* Stream object. *&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="3-1-字符串对象-OBJ-STRING"><a href="#3-1-字符串对象-OBJ-STRING" class="headerlink" title="(3.1) 字符串对象 OBJ_STRING"></a>(3.1) 字符串对象 OBJ_STRING</h2><h2 id="3-2-列表对象-OBJ-LIST"><a href="#3-2-列表对象-OBJ-LIST" class="headerlink" title="(3.2) 列表对象 OBJ_LIST"></a>(3.2) 列表对象 OBJ_LIST</h2><h2 id="3-3-集合对象-OBJ-SET"><a href="#3-3-集合对象-OBJ-SET" class="headerlink" title="(3.3) 集合对象 OBJ_SET"></a>(3.3) 集合对象 OBJ_SET</h2><h2 id="3-4-有序集合对象-OBJ-ZSET"><a href="#3-4-有序集合对象-OBJ-ZSET" class="headerlink" title="(3.4) 有序集合对象 OBJ_ZSET"></a>(3.4) 有序集合对象 OBJ_ZSET</h2><p>  Sorted Set内部实现数据结构是跳表和压缩列表。<br>  跳表主要服务范围操作，提供O(logN)的复杂度。<br>  zset有个ZSCORE的操作，用于返回单个集合member的分数，它的操作复杂度是O(1)，这就是收益于你这看到的hash table。这个hash table保存了集合元素和相应的分数，所以做ZSCORE操作时，直接查这个表就可以，复杂度就降为O(1)了。</p>
<h2 id="3-5-哈希对象-OBJ-HASH"><a href="#3-5-哈希对象-OBJ-HASH" class="headerlink" title="(3.5) 哈希对象 OBJ_HASH"></a>(3.5) 哈希对象 OBJ_HASH</h2><h1 id="2-redis常用数据结构"><a href="#2-redis常用数据结构" class="headerlink" title="(2) redis常用数据结构"></a>(2) redis常用数据结构</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Objects encoding. Some kind of objects like Strings and Hashes can be
 * internally represented in multiple ways. The 'encoding' field of the object
 * is set to one of this fields for this object. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_RAW</span> <span class="token expression"><span class="token number">0</span>     </span><span class="token comment">/* Raw representation */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_INT</span> <span class="token expression"><span class="token number">1</span>     </span><span class="token comment">/* Encoded as integer */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_HT</span> <span class="token expression"><span class="token number">2</span>      </span><span class="token comment">/* Encoded as hash table */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_ZIPMAP</span> <span class="token expression"><span class="token number">3</span>  </span><span class="token comment">/* Encoded as zipmap */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_LINKEDLIST</span> <span class="token expression"><span class="token number">4</span> </span><span class="token comment">/* No longer used: old list encoding. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_ZIPLIST</span> <span class="token expression"><span class="token number">5</span> </span><span class="token comment">/* Encoded as ziplist */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_INTSET</span> <span class="token expression"><span class="token number">6</span>  </span><span class="token comment">/* Encoded as intset */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_SKIPLIST</span> <span class="token expression"><span class="token number">7</span>  </span><span class="token comment">/* Encoded as skiplist */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_EMBSTR</span> <span class="token expression"><span class="token number">8</span>  </span><span class="token comment">/* Embedded sds string encoding */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_QUICKLIST</span> <span class="token expression"><span class="token number">9</span> </span><span class="token comment">/* Encoded as linked list of ziplists */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_STREAM</span> <span class="token expression"><span class="token number">10</span> </span><span class="token comment">/* Encoded as a radix tree of listpacks */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-1-简单动态字符串SDS"><a href="#2-1-简单动态字符串SDS" class="headerlink" title="(2.1) 简单动态字符串SDS"></a>(2.1) 简单动态字符串SDS</h2><p>　　代码见<br>　　SDS包括 RAW INT EMDSTR </p>
<h2 id="2-2-链表"><a href="#2-2-链表" class="headerlink" title="(2.2) 链表"></a>(2.2) 链表</h2><h2 id="2-3-字典"><a href="#2-3-字典" class="headerlink" title="(2.3) 字典"></a>(2.3) 字典</h2><h2 id="2-4-跳跃表"><a href="#2-4-跳跃表" class="headerlink" title="(2.4) 跳跃表"></a>(2.4) 跳跃表</h2><h2 id="2-5-整数集合"><a href="#2-5-整数集合" class="headerlink" title="(2.5) 整数集合"></a>(2.5) 整数集合</h2><h2 id="2-6-压缩列表"><a href="#2-6-压缩列表" class="headerlink" title="(2.6) 压缩列表"></a>(2.6) 压缩列表</h2><h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><h2 id="Redis为什么会把整数数组和压缩列表作为底层数据结构"><a href="#Redis为什么会把整数数组和压缩列表作为底层数据结构" class="headerlink" title="Redis为什么会把整数数组和压缩列表作为底层数据结构?"></a>Redis为什么会把整数数组和压缩列表作为底层数据结构?</h2><p>  整数数组和压缩列表在查找时间复杂度方面并没有很大的优势，那为什么 Redis 还会把它们作为底层数据结构呢？</p>
<p>1、内存利用率，数组和压缩列表都是非常紧凑的数据结构，它比链表占用的内存要更少。<br>  Redis是内存数据库，大量数据存到内存中，此时需要做尽可能的优化，提高内存的利用率。</p>
<p>2、数组对CPU高速缓存支持更友好，所以Redis在设计时，集合数据元素较少情况下，默认采用内存紧凑排列的方式存储，同时利用CPU高速缓存不会降低访问速度。当数据元素超过设定阈值后，避免查询时间复杂度太高，转为哈希和跳表数据结构存储，保证查询效率。</p>
<p>数组对cpu缓存友好的原因是: cpu预读取一个cache line大小的数据, 数组数据排列紧凑、相同大小空间保存的元素更多, 访问下一个元素时、恰好已经在cpu缓存了. 如果是随机访问、就不能充分利用cpu缓存了, 拿int元素举例: 一个元素4byte, CacheLine 假设64byte, 可以预读取 16个挨着的元素, 如果下次随机访问的元素不在这16个元素里、就需要重新从内存读取了.</p>
<h1 id="4-手动测试过程"><a href="#4-手动测试过程" class="headerlink" title="(4) 手动测试过程"></a>(4) 手动测试过程</h1><p>　1、flushall 清空所有数据<br>　2、测试用string类型存 key=1000000，value=1<br>　3、插入100万uid用了55M左右(实际占用操作系统64M)<br>　4、插入1000万用了587M(实际占用从操作系统622M)</p>
<p> 　感觉不太对，key是long类型 8字节，100万*8=8M， 100万key占8M 100万value占8M 多余的55-8-8=39M去哪了？</p>
<h2 id="4-1-测试代码"><a href="#4-1-测试代码" class="headerlink" title="(4.1) 测试代码"></a>(4.1) 测试代码</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisMemoryTest</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token class-name">JedisPoolUtil</span><span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 1000万 18位用户id
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 18位用户id</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token number">123456789012345678L</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">10000000</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">123456789012345678L</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> res <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-2-redis-flushall后-info-memory信息"><a href="#4-2-redis-flushall后-info-memory信息" class="headerlink" title="(4.2) redis flushall后 info memory信息"></a>(4.2) redis flushall后 info memory信息</h2><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># Memory
used_memory:1180064
used_memory_human:1.13M
used_memory_rss:954368
used_memory_rss_human:932.00K
used_memory_peak:1219088
used_memory_peak_human:1.16M
used_memory_peak_perc:96.80%
used_memory_overhead:1132016
used_memory_startup:1079584
used_memory_dataset:48048
used_memory_dataset_perc:47.82%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="4-3-redis-插入100万数据后的info-memory信息"><a href="#4-3-redis-插入100万数据后的info-memory信息" class="headerlink" title="(4.3) redis 插入100万数据后的info memory信息"></a>(4.3) redis 插入100万数据后的info memory信息</h2><p>　</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">
127.0.0.1:6379&gt; info memory
# Memory
used_memory:57558992
used_memory_human:54.89M
used_memory_rss:66695168
used_memory_rss_human:63.61M
used_memory_peak:58020704
used_memory_peak_human:55.33M
used_memory_peak_perc:99.20%
used_memory_overhead:49520624
used_memory_startup:1079584
used_memory_dataset:8038368
used_memory_dataset_perc:14.23%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-4-redis-插入100万数据后的info-memory信息"><a href="#4-4-redis-插入100万数据后的info-memory信息" class="headerlink" title="(4.4) redis 插入100万数据后的info memory信息"></a>(4.4) redis 插入100万数据后的info memory信息</h2><p>　</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">
# Memory
used_memory:615390352
used_memory_human:586.88M
used_memory_rss:421154816
used_memory_rss_human:401.64M
used_memory_peak:653409248
used_memory_peak_human:623.14M
used_memory_peak_perc:94.18%
used_memory_overhead:535349840
used_memory_startup:1079584
used_memory_dataset:80040512
used_memory_dataset_perc:13.03%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://github.com/redis/redis/tree/6.0">redis源码 - github</a><br>[2] <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HgwmTlmV_d2dOmAl-fYzkQ">十二张图详解Redis的数据结构和对象系统</a><br>[3] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/279649">“万金油”的String，为什么不好用了</a></p>
<!--
127.0.0.1:6379>
127.0.0.1:6379> flushall
OK
127.0.0.1:6379>
127.0.0.1:6379> dbsize
(integer) 0
127.0.0.1:6379> info
# Server
redis_version:6.0.9
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:2f127c9309e399ac
redis_mode:standalone
os:Darwin 21.1.0 x86_64
arch_bits:64
multiplexing_api:kqueue
atomicvar_api:atomic-builtin
gcc_version:4.2.1
process_id:8785
run_id:2ab931b023bfa36f2dd53f86285eedefbff94d82
tcp_port:6379
uptime_in_seconds:37912
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:15511216
executable:/Users/weikeqin/SoftWare/redis/redis-6.0.9/./src/redis-server
config_file:/Users/weikeqin/SoftWare/redis/redis-6.0.9/redis.conf
io_threads_active:0

# Clients
connected_clients:3
client_recent_max_input_buffer:112
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

# Memory
used_memory:1180064
used_memory_human:1.13M
used_memory_rss:954368
used_memory_rss_human:932.00K
used_memory_peak:1219088
used_memory_peak_human:1.16M
used_memory_peak_perc:96.80%
used_memory_overhead:1132016
used_memory_startup:1079584
used_memory_dataset:48048
used_memory_dataset_perc:47.82%
allocator_allocated:1133456
allocator_active:916480
allocator_resident:916480
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:0.81
allocator_frag_bytes:18446744073709334640
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.04
rss_overhead_bytes:37888
mem_fragmentation_ratio:0.84
mem_fragmentation_bytes:-179088
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52432
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0

# Persistence
loading:0
rdb_changes_since_last_save:4
rdb_bgsave_in_progress:0
rdb_last_save_time:1642901160
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:0
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

# Stats
total_connections_received:3
total_commands_processed:19
instantaneous_ops_per_sec:0
total_net_input_bytes:563
total_net_output_bytes:48551
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:84
evicted_keys:0
keyspace_hits:4
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:545
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:40
total_writes_processed:19
io_threaded_reads_processed:0
io_threaded_writes_processed:0

# Replication
role:master
connected_slaves:0
master_replid:ca93fb6c88be31059c24ddbcf2744d57b94c08f6
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

# CPU
used_cpu_sys:19.074490
used_cpu_user:4.556408
used_cpu_sys_children:0.002266
used_cpu_user_children:0.000434

# Modules

# Cluster
cluster_enabled:0

# Keyspace
127.0.0.1:6379>
127.0.0.1:6379> info memory
# Memory
used_memory:1178576
used_memory_human:1.12M
used_memory_rss:983040
used_memory_rss_human:960.00K
used_memory_peak:1219088
used_memory_peak_human:1.16M
used_memory_peak_perc:96.68%
used_memory_overhead:1132016
used_memory_startup:1079584
used_memory_dataset:46560
used_memory_dataset_perc:47.03%
allocator_allocated:1133456
allocator_active:945152
allocator_resident:945152
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:0.83
allocator_frag_bytes:18446744073709363312
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.04
rss_overhead_bytes:37888
mem_fragmentation_ratio:0.87
mem_fragmentation_bytes:-150416
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52432
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0
127.0.0.1:6379>
127.0.0.1:6379>



127.0.0.1:6379> dbsize
(integer) 1000000
127.0.0.1:6379>
127.0.0.1:6379> info memory
# Memory
used_memory:57558992
used_memory_human:54.89M
used_memory_rss:66695168
used_memory_rss_human:63.61M
used_memory_peak:58020704
used_memory_peak_human:55.33M
used_memory_peak_perc:99.20%
used_memory_overhead:49520624
used_memory_startup:1079584
used_memory_dataset:8038368
used_memory_dataset_perc:14.23%
allocator_allocated:57522064
allocator_active:66657280
allocator_resident:66657280
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:1.16
allocator_frag_bytes:9135216
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.00
rss_overhead_bytes:37888
mem_fragmentation_ratio:1.16
mem_fragmentation_bytes:9173104
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52432
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0
127.0.0.1:6379>
127.0.0.1:6379>
127.0.0.1:6379>
127.0.0.1:6379>
127.0.0.1:6379> info
# Server
redis_version:6.0.9
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:2f127c9309e399ac
redis_mode:standalone
os:Darwin 21.1.0 x86_64
arch_bits:64
multiplexing_api:kqueue
atomicvar_api:atomic-builtin
gcc_version:4.2.1
process_id:8785
run_id:2ab931b023bfa36f2dd53f86285eedefbff94d82
tcp_port:6379
uptime_in_seconds:38131
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:15511435
executable:/Users/weikeqin/SoftWare/redis/redis-6.0.9/./src/redis-server
config_file:/Users/weikeqin/SoftWare/redis/redis-6.0.9/redis.conf
io_threads_active:0

# Clients
connected_clients:3
client_recent_max_input_buffer:112
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

# Memory
used_memory:57560480
used_memory_human:54.89M
used_memory_rss:66695168
used_memory_rss_human:63.61M
used_memory_peak:58020704
used_memory_peak_human:55.33M
used_memory_peak_perc:99.21%
used_memory_overhead:49520624
used_memory_startup:1079584
used_memory_dataset:8039856
used_memory_dataset_perc:14.23%
allocator_allocated:57522064
allocator_active:66657280
allocator_resident:66657280
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:1.16
allocator_frag_bytes:9135216
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.00
rss_overhead_bytes:37888
mem_fragmentation_ratio:1.16
mem_fragmentation_bytes:9173104
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52432
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0

# Persistence
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1642901282
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:0
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

# Stats
total_connections_received:14
total_commands_processed:1000023
instantaneous_ops_per_sec:0
total_net_input_bytes:33000645
total_net_output_bytes:5054469
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:87
evicted_keys:0
keyspace_hits:4
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:1318
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:1000055
total_writes_processed:1000023
io_threaded_reads_processed:0
io_threaded_writes_processed:0

# Replication
role:master
connected_slaves:0
master_replid:ca93fb6c88be31059c24ddbcf2744d57b94c08f6
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

# CPU
used_cpu_sys:33.077658
used_cpu_user:11.821818
used_cpu_sys_children:0.100676
used_cpu_user_children:0.725147

# Modules

# Cluster
cluster_enabled:0

# Keyspace
db0:keys=1000000,expires=0,avg_ttl=0
127.0.0.1:6379>
127.0.0.1:6379>
127.0.0.1:6379> flushall
OK
(0.82s)
127.0.0.1:6379>



127.0.0.1:6379> dbsize
(integer) 10000000
127.0.0.1:6379>
127.0.0.1:6379>
127.0.0.1:6379> info
# Server
redis_version:6.0.9
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:2f127c9309e399ac
redis_mode:standalone
os:Darwin 21.1.0 x86_64
arch_bits:64
multiplexing_api:kqueue
atomicvar_api:atomic-builtin
gcc_version:4.2.1
process_id:8785
run_id:2ab931b023bfa36f2dd53f86285eedefbff94d82
tcp_port:6379
uptime_in_seconds:40987
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:15514291
executable:/Users/weikeqin/SoftWare/redis/redis-6.0.9/./src/redis-server
config_file:/Users/weikeqin/SoftWare/redis/redis-6.0.9/redis.conf
io_threads_active:0

# Clients
connected_clients:3
client_recent_max_input_buffer:208
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

# Memory
used_memory:615389936
used_memory_human:586.88M
used_memory_rss:1769472
used_memory_rss_human:1.69M
used_memory_peak:651222816
used_memory_peak_human:621.05M
used_memory_peak_perc:94.50%
used_memory_overhead:535349840
used_memory_startup:1079584
used_memory_dataset:80040096
used_memory_dataset_perc:13.03%
allocator_allocated:615351520
allocator_active:1731584
allocator_resident:1731584
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:0.00
allocator_frag_bytes:18446744073095931680
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.02
rss_overhead_bytes:37888
mem_fragmentation_ratio:0.00
mem_fragmentation_bytes:-613582048
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52528
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0

# Persistence
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1642902295
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:5
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

# Stats
total_connections_received:106
total_commands_processed:11000124
instantaneous_ops_per_sec:0
total_net_input_bytes:373003398
total_net_output_bytes:55068514
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:120
evicted_keys:0
keyspace_hits:4
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:3497
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:11000267
total_writes_processed:11000205
io_threaded_reads_processed:0
io_threaded_writes_processed:0

# Replication
role:master
connected_slaves:0
master_replid:ca93fb6c88be31059c24ddbcf2744d57b94c08f6
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

# CPU
used_cpu_sys:181.499349
used_cpu_user:99.340829
used_cpu_sys_children:3.358057
used_cpu_user_children:29.351075

# Modules

# Cluster
cluster_enabled:0

# Keyspace
db0:keys=10000000,expires=0,avg_ttl=0
127.0.0.1:6379>



127.0.0.1:6379> info
# Server
redis_version:6.0.9
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:2f127c9309e399ac
redis_mode:standalone
os:Darwin 21.1.0 x86_64
arch_bits:64
multiplexing_api:kqueue
atomicvar_api:atomic-builtin
gcc_version:4.2.1
process_id:8785
run_id:2ab931b023bfa36f2dd53f86285eedefbff94d82
tcp_port:6379
uptime_in_seconds:41739
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:15515043
executable:/Users/weikeqin/SoftWare/redis/redis-6.0.9/./src/redis-server
config_file:/Users/weikeqin/SoftWare/redis/redis-6.0.9/redis.conf
io_threads_active:0

# Clients
connected_clients:3
client_recent_max_input_buffer:208
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

# Memory
used_memory:615390352
used_memory_human:586.88M
used_memory_rss:421154816
used_memory_rss_human:401.64M
used_memory_peak:653409248
used_memory_peak_human:623.14M
used_memory_peak_perc:94.18%
used_memory_overhead:535349840
used_memory_startup:1079584
used_memory_dataset:80040512
used_memory_dataset_perc:13.03%
allocator_allocated:615351936
allocator_active:421116928
allocator_resident:421116928
total_system_memory:8589934592
total_system_memory_human:8.00G
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:0.68
allocator_frag_bytes:18446744073515316608
allocator_rss_ratio:1.00
allocator_rss_bytes:0
rss_overhead_ratio:1.00
rss_overhead_bytes:37888
mem_fragmentation_ratio:0.68
mem_fragmentation_bytes:-194197120
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:52528
mem_aof_buffer:0
mem_allocator:libc
active_defrag_running:0
lazyfree_pending_objects:0

# Persistence
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1642904993
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:6
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

# Stats
total_connections_received:197
total_commands_processed:21000208
instantaneous_ops_per_sec:0
total_net_input_bytes:723005702
total_net_output_bytes:105073310
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:128
evicted_keys:0
keyspace_hits:4
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:8234
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:21000442
total_writes_processed:21000369
io_threaded_reads_processed:0
io_threaded_writes_processed:0

# Replication
role:master
connected_slaves:0
master_replid:ca93fb6c88be31059c24ddbcf2744d57b94c08f6
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

# CPU
used_cpu_sys:328.154683
used_cpu_user:183.784965
used_cpu_sys_children:6.240064
used_cpu_user_children:52.613884

# Modules

# Cluster
cluster_enabled:0

# Keyspace
db0:keys=10000000,expires=0,avg_ttl=0
127.0.0.1:6379>

-->



      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/16/redis-persistence/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/16/redis-persistence/" class="post-title-link" itemprop="url">Redis持久化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-16 15:32:10" itemprop="dateCreated datePublished" datetime="2022-01-16T15:32:10+08:00">2022-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-04 21:42:33" itemprop="dateModified" datetime="2022-12-04T21:42:33+08:00">2022-12-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>299</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　　经常会遇到的一个问题是数据库如何保证不丢数据？　同样的假如把Redis当数据库用，如何保证不丢数据？</p>
<p>　MySQL里有 redo log、bin log、undo log，MySQL通过binlog全量备份+增量备份保证数据不丢。通过redo log和bin log保证数据一致性。</p>
<p>　Redis里有没有类似的功能呢？</p>
<p>　Redis包含 <code>rdb log</code>、<code>aof log</code>，可以通过RDB全量备份+aof增量备份保证数据几乎不丢。 </p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/01/16/redis-persistence/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/16/redis-aof/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/16/redis-aof/" class="post-title-link" itemprop="url">Redis AOF</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-16 14:44:05" itemprop="dateCreated datePublished" datetime="2022-01-16T14:44:05+08:00">2022-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-02-04 12:21:29" itemprop="dateModified" datetime="2023-02-04T12:21:29+08:00">2023-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>22k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>20 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  问大家一个问题，假如Redis宕机，内存中的数据全部丢失，怎么恢复数据？</p>
<p>Redis 分别提供了 RDB 和 AOF 两种持久化机制：<br>  RDB将数据库的快照(snapshot)以二进制的方式保存到磁盘中。<br>  AOF则以协议文本的方式，将所有对数据库进行过写入的命令(及其参数)记录到AOF文件，以此达到记录数据库状态的目的。</p>
<h1 id="1-AOF日志是什么"><a href="#1-AOF日志是什么" class="headerlink" title="(1) AOF日志是什么"></a>(1) AOF日志是什么</h1><p>  AOF(Append Only File)日志是一种写后日志，在Redis先执行命令，把数据写入内存后，然后才记录日志，日志会追加到文件末尾，所以叫AOF日志。</p>
<p>  <img src="/img/database/redis/log/aof/redis-write-aof-log.png"></p>
<p>  和我们常见的WAL日志不同，WAL(Write Ahead Log)是写前日志，在实际写数据前，先把修改的数据记到日志文件中，再去执行命令，这个就要求数据库需要额外的检查命令是否正确。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/01/16/redis-aof/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/15/redis-rdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/15/redis-rdb/" class="post-title-link" itemprop="url">Redis RDB</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-15 21:33:23" itemprop="dateCreated datePublished" datetime="2022-01-15T21:33:23+08:00">2022-01-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-02-04 12:21:29" itemprop="dateModified" datetime="2023-02-04T12:21:29+08:00">2023-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>17k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>15 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  Redis 数据持久化的实现，其中包括 Redis 内存快照 RDB 文件的生成方法，以及 AOF 日志的记录与重写。</p>
<h1 id="1-什么是RDB"><a href="#1-什么是RDB" class="headerlink" title="(1) 什么是RDB"></a>(1) 什么是RDB</h1><p>  RDB是Redis DataBase 的缩写，中文名为快照/内存快照。<br>  RDB持久化是把当前进程数据生成快照保存到磁盘上的过程。</p>
<br>


<h1 id="2-为什么要用RDB"><a href="#2-为什么要用RDB" class="headerlink" title="(2) 为什么要用RDB"></a>(2) 为什么要用RDB</h1><p>  Redis是个基于内存的数据库。那服务一旦宕机，内存中的数据将全部丢失。为了保存数据，需要有一个持久化方式，RDB就是其中一种。</p>
<p>  主从复制是分布式数据系统保证可靠性的一个重要机制。RDB为Redis主从提供了数据同步机制。</p>
<h2 id="2-1-RDB优缺点"><a href="#2-1-RDB优缺点" class="headerlink" title="(2.1) RDB优缺点"></a>(2.1) RDB优缺点</h2><p>优点<br>  RDB文件是某个时间节点的快照，默认使用LZF算法进行压缩，压缩后的文件体积远远小于内存大小，适用于备份、全量复制等场景；<br>  Redis加载RDB文件恢复数据要远远快于AOF方式；</p>
<p>缺点<br>  RDB方式实时性不够，无法做到秒级的持久化；<br>  每次调用bgsave都需要fork子进程，fork子进程属于重量级操作，频繁执行成本较高；<br>  RDB文件是二进制的，没有可读性，AOF文件在了解其结构的情况下可以手动修改或者补全；<br>  版本兼容RDB文件问题；</p>
<br>


<h1 id="3-RDB的原理"><a href="#3-RDB的原理" class="headerlink" title="(3) RDB的原理"></a>(3) RDB的原理</h1><p>  <img src="/img/database/redis/persistence/rdb/redis-rdb-overview.png" alt="Redis RDB数据格式"></p>
<br>



<h1 id="4-源码解读"><a href="#4-源码解读" class="headerlink" title="(4) 源码解读"></a>(4) 源码解读</h1><h2 id="4-1-RDB创建的入口函数和触发时机"><a href="#4-1-RDB创建的入口函数和触发时机" class="headerlink" title="(4.1) RDB创建的入口函数和触发时机"></a>(4.1) RDB创建的入口函数和触发时机</h2><p>  RDB 文件创建的三个时机，分别是 <code>save命令执行</code>、<code>bgsave命令执行</code> 以及 <code>主从复制</code>。<br>  对应源码<code>rdb.c</code>文件中的3个函数 </p>
<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">作用</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">rdbSave</td>
<td align="left">Redis Server在本地磁盘创建RDB文件。</td>
<td align="left">对应save命令</td>
</tr>
<tr>
<td align="left">rdbSaveBackground</td>
<td align="left">Redis Server 使用后台子进程方式，在本地磁盘创建 RDB文件</td>
<td align="left">对应bgsaveCommand</td>
</tr>
<tr>
<td align="left">rdbSaveToSlavesSockets</td>
<td align="left">Redis Server 在采用不落盘方式传输RDB文件进行主从复制时，创建RDB文件</td>
<td align="left">对应了Redis Server 执行主从复制命令，以及周期性检测主从复制状态时触发RDB生成</td>
</tr>
</tbody></table>
<h3 id="4-1-1-同步阻塞保存-rdbSave"><a href="#4-1-1-同步阻塞保存-rdbSave" class="headerlink" title="(4.1.1) 同步阻塞保存-rdbSave"></a>(4.1.1) 同步阻塞保存-rdbSave</h3><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;*
 * 把数据库的数据保存到磁盘上
 *
 * 失败时返回 C_ERR
 * 成功时返回 C_OK 
 *
 * @param *filename 文件名
 * @param *rsi 
 *&#x2F;
int rdbSave(char *filename, rdbSaveInfo *rsi) &#123;
    char tmpfile[256];
    char cwd[MAXPATHLEN]; &#x2F;* Current working dir path for error messages. *&#x2F;
    FILE *fp &#x3D; NULL;
    rio rdb;
    int error &#x3D; 0;

    snprintf(tmpfile,256,&quot;temp-%d.rdb&quot;, (int) getpid());

    &#x2F;&#x2F; 打开文件
    fp &#x3D; fopen(tmpfile,&quot;w&quot;);
    &#x2F;&#x2F; 文件不存在，为空
    if (!fp) &#123;
        &#x2F;&#x2F;  
        char *cwdp &#x3D; getcwd(cwd,MAXPATHLEN);

        &#x2F;&#x2F; 提示 打开文件失败
        serverLog(LL_WARNING,
            &quot;Failed opening the RDB file %s (in server root dir %s) &quot;
            &quot;for saving: %s&quot;,
            filename,
            cwdp ? cwdp : &quot;unknown&quot;,
            strerror(errno));
        return C_ERR;
    &#125;

    &#x2F;&#x2F; rio初始化
    rioInitWithFile(&amp;rdb,fp);

    &#x2F;&#x2F; 标记开始保存
    startSaving(RDBFLAGS_NONE);

    &#x2F;&#x2F; fsync 在 rdb 保存时递增 
    if (server.rdb_save_incremental_fsync)
        &#x2F;&#x2F; todo 自动同步？
        rioSetAutoSync(&amp;rdb,REDIS_AUTOSYNC_BYTES);

    &#x2F;&#x2F; 真正把Redis数据库里的数据保存到文件 
    if (rdbSaveRio(&amp;rdb,&amp;error,RDBFLAGS_NONE,rsi) &#x3D;&#x3D; C_ERR) &#123;
        errno &#x3D; error;
        goto werr;
    &#125;

    &#x2F;&#x2F; 确保数据不会保留在操作系统的输出缓冲区中

    &#x2F;&#x2F; fflush 把缓冲区的数据写到文件里
    if (fflush(fp)) goto werr;

    &#x2F;&#x2F; fsync 确保一直到写磁盘操作结束才会返回
    if (fsync(fileno(fp))) goto werr;

    &#x2F;&#x2F; 关闭文件
    if (fclose(fp)) &#123; fp &#x3D; NULL; goto werr; &#125;
    fp &#x3D; NULL;
    

    &#x2F;&#x2F; 使用 文件重命名 确保仅当生成的数据库文件正常时才自动更改数据库文件。 

    &#x2F;&#x2F; 把缓存文件重命名正式文件时，可能没权限，会重命名失败  
    if (rename(tmpfile,filename) &#x3D;&#x3D; -1) &#123;  &#x2F;&#x2F; 重命名失败
        char *cwdp &#x3D; getcwd(cwd,MAXPATHLEN);

        &#x2F;&#x2F; 打印日志 
        serverLog(LL_WARNING,
            &quot;Error moving temp DB file %s on the final &quot;
            &quot;destination %s (in server root dir %s): %s&quot;,
            tmpfile,
            filename,
            cwdp ? cwdp : &quot;unknown&quot;,
            strerror(errno));
        unlink(tmpfile);
        stopSaving(0);
        return C_ERR;
    &#125;

    &#x2F;&#x2F; 打印日志  数据库数据已经保存到磁盘 
    serverLog(LL_NOTICE,&quot;DB saved on disk&quot;);
    &#x2F;&#x2F; 更新
    server.dirty &#x3D; 0;
    &#x2F;&#x2F; 更新上次保存时间
    server.lastsave &#x3D; time(NULL);
    &#x2F;&#x2F; 更新上次保存状态
    server.lastbgsave_status &#x3D; C_OK;
    &#x2F;&#x2F; 停止保存 发布事件
    stopSaving(1);
    return C_OK;

werr:
    serverLog(LL_WARNING,&quot;Write error saving DB on disk: %s&quot;, strerror(errno));
    &#x2F;&#x2F; 关闭文件
    if (fp) fclose(fp);
    &#x2F;&#x2F; 删除缓存文件
    unlink(tmpfile);
    &#x2F;&#x2F; 停止保存 发布事件
    stopSaving(0);
    return C_ERR;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  Redis保存RDB文件的代码确实不错，在使用资源前校验资源的合法性，使用后确保数据都保存到磁盘，还通过重命名确认保存成功，并且在完后后货失败后释放对应资源。  </p>
<p>  虽然很细节很简单，但是很健壮。</p>
<br>


<h3 id="4-1-2-异步保存-rdbSaveBackground"><a href="#4-1-2-异步保存-rdbSaveBackground" class="headerlink" title="(4.1.2) 异步保存-rdbSaveBackground"></a>(4.1.2) 异步保存-rdbSaveBackground</h3><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;*
 * 
 * @param *filename 文件名
 * @param *rsi 
 *&#x2F;
int rdbSaveBackground(char *filename, rdbSaveInfo *rsi) &#123;
    pid_t childpid;

    &#x2F;&#x2F; 有活跃的子进程 
    if (hasActiveChildProcess()) return C_ERR;

    &#x2F;&#x2F;  
    server.dirty_before_bgsave &#x3D; server.dirty;
    &#x2F;&#x2F;
    server.lastbgsave_try &#x3D; time(NULL);
    &#x2F;&#x2F; 打开子
    openChildInfoPipe();

    &#x2F;&#x2F; 复制进程
    if ((childpid &#x3D; redisFork(CHILD_TYPE_RDB)) &#x3D;&#x3D; 0) &#123;  &#x2F;&#x2F; 
        int retval;

        &#x2F;&#x2F; 子进程设置调用名称
        redisSetProcTitle(&quot;redis-rdb-bgsave&quot;);
        &#x2F;&#x2F; 设置 bgsave子进程的cpu关联列表
        redisSetCpuAffinity(server.bgsave_cpulist);
        &#x2F;&#x2F; 在子进程里调用 rdbSave() 同步保存 
        retval &#x3D; rdbSave(filename,rsi);
        if (retval &#x3D;&#x3D; C_OK) &#123;
            &#x2F;&#x2F; 发送子进程写时复制(Copy On Write)信息 
            sendChildCOWInfo(CHILD_TYPE_RDB, &quot;RDB&quot;);
        &#125;
        &#x2F;&#x2F; 退出子进程
        exitFromChild((retval &#x3D;&#x3D; C_OK) ? 0 : 1);
    &#125; else &#123;
        &#x2F;* Parent *&#x2F;
        if (childpid &#x3D;&#x3D; -1) &#123;
            &#x2F;&#x2F; 关闭 
            closeChildInfoPipe();
            &#x2F;&#x2F; 后台保存状态错误
            server.lastbgsave_status &#x3D; C_ERR;
            &#x2F;&#x2F; 不能后台保存  子进程复制出错
            serverLog(LL_WARNING,&quot;Can&#39;t save in background: fork: %s&quot;,
                strerror(errno));
            return C_ERR;
        &#125;

        &#x2F;&#x2F; 
        serverLog(LL_NOTICE,&quot;Background saving started by pid %d&quot;,childpid);
        server.rdb_save_time_start &#x3D; time(NULL);
        server.rdb_child_pid &#x3D; childpid;
        server.rdb_child_type &#x3D; RDB_CHILD_TYPE_DISK;
        updateDictResizePolicy();
        return C_OK;
    &#125;
    return C_OK; &#x2F;* unreached *&#x2F;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4-1-3-主从同步生成RDB-rdbSaveToSlavesSockets"><a href="#4-1-3-主从同步生成RDB-rdbSaveToSlavesSockets" class="headerlink" title="(4.1.3) 主从同步生成RDB-rdbSaveToSlavesSockets"></a>(4.1.3) 主从同步生成RDB-rdbSaveToSlavesSockets</h3><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* 
 * 生成一个 RDB 子进程，它将 RDB 写入当前处于 SLAVE_STATE_WAIT_BGSAVE_START 状态的从属 sockets。
 *&#x2F;
int rdbSaveToSlavesSockets(rdbSaveInfo *rsi) &#123;

    listNode *ln;
    listIter li;
    pid_t childpid;
    int pipefds[2], rdb_pipe_write, safe_to_exit_pipe;

    &#x2F;&#x2F; 有活跃子进程 
    if (hasActiveChildProcess()) return C_ERR;

    &#x2F;&#x2F; 即使之前的fork子进程退出了，在我们排干管道之前不要开一个新的。
    if (server.rdb_pipe_conns) return C_ERR;

    &#x2F;* Before to fork, create a pipe that is used to transfer the rdb bytes to
     * the parent, we can&#39;t let it write directly to the sockets, since in case
     * of TLS we must let the parent handle a continuous TLS state when the
     * child terminates and parent takes over. *&#x2F;
    if (pipe(pipefds) &#x3D;&#x3D; -1) return C_ERR;
    &#x2F;&#x2F; 
    server.rdb_pipe_read &#x3D; pipefds[0]; &#x2F;* read end *&#x2F;
    &#x2F;&#x2F; 
    rdb_pipe_write &#x3D; pipefds[1]; &#x2F;* write end *&#x2F;
    &#x2F;&#x2F; 
    anetNonBlock(NULL, server.rdb_pipe_read);

    &#x2F;&#x2F; 创建另一个管道，父进程使用该管道向子进程发出可以退出的信号。 
    if (pipe(pipefds) &#x3D;&#x3D; -1) &#123;
        &#x2F;&#x2F; 关闭rdb管道写操作 
        close(rdb_pipe_write);
        &#x2F;&#x2F; 关闭rdb管道读
        close(server.rdb_pipe_read);
        return C_ERR;
    &#125;
    safe_to_exit_pipe &#x3D; pipefds[0]; &#x2F;* read end *&#x2F;
    server.rdb_child_exit_pipe &#x3D; pipefds[1]; &#x2F;* write end *&#x2F;

    &#x2F;&#x2F; 收集我们要将 RDB 传输到的 从节点 的连接，这些从节点处于 WAIT_BGSAVE_START 状态。 
    &#x2F;&#x2F; 创建 connection数组  长度&#x3D;从节点个数
    server.rdb_pipe_conns &#x3D; zmalloc(sizeof(connection *)*listLength(server.slaves));
    server.rdb_pipe_numconns &#x3D; 0;
    server.rdb_pipe_numconns_writing &#x3D; 0;
    &#x2F;&#x2F; 链表迭代器 
    listRewind(server.slaves,&amp;li);
    &#x2F;&#x2F; 遍历链表
    while((ln &#x3D; listNext(&amp;li))) &#123;
        &#x2F;&#x2F; 从节点 
        client *slave &#x3D; ln-&gt;value;
        if (slave-&gt;replstate &#x3D;&#x3D; SLAVE_STATE_WAIT_BGSAVE_START) &#123; &#x2F;&#x2F; 
            &#x2F;&#x2F; 连接赋值
            server.rdb_pipe_conns[server.rdb_pipe_numconns++] &#x3D; slave-&gt;conn;
            &#x2F;&#x2F; 发送 FULLRESYNC 回复
            replicationSetupSlaveForFullResync(slave,getPsyncInitialOffset());
        &#125;
    &#125;

    &#x2F;&#x2F; 创建父子进程通信管道
    openChildInfoPipe();
    &#x2F;&#x2F; 创建子进程
    if ((childpid &#x3D; redisFork(CHILD_TYPE_RDB)) &#x3D;&#x3D; 0) &#123;
        &#x2F;* Child *&#x2F;
        int retval, dummy;
        rio rdb;

        rioInitWithFd(&amp;rdb,rdb_pipe_write);

        &#x2F;&#x2F; 设置进程名称  
        redisSetProcTitle(&quot;redis-rdb-to-slaves&quot;);
        &#x2F;&#x2F; 设置 子进程的cpu关联列表
        redisSetCpuAffinity(server.bgsave_cpulist);

        &#x2F;&#x2F; 写RDB数据
        retval &#x3D; rdbSaveRioWithEOFMark(&amp;rdb,NULL,rsi);
        if (retval &#x3D;&#x3D; C_OK &amp;&amp; rioFlush(&amp;rdb) &#x3D;&#x3D; 0)
            retval &#x3D; C_ERR;

        if (retval &#x3D;&#x3D; C_OK) &#123;
            &#x2F;&#x2F; 发送子进程写时复制信息 
            sendChildCOWInfo(CHILD_TYPE_RDB, &quot;RDB&quot;);
        &#125;

        &#x2F;&#x2F;   
        rioFreeFd(&amp;rdb);
        &#x2F;&#x2F; 关闭rdb写管道    &#x2F;&#x2F; 唤醒读取着，告诉他们我们已经完成 
        close(rdb_pipe_write);
        &#x2F;&#x2F; 关闭rdb子进程退出管道    &#x2F;&#x2F; 关闭写结束，以便我们可以检测到父级的关闭。
        close(server.rdb_child_exit_pipe); 
        &#x2F;&#x2F; 等待退出直到父进程告诉我们它是安全的。 我们不期望读取任何内容，只是在管道关闭时收到错误。 
        dummy &#x3D; read(safe_to_exit_pipe, pipefds, 1);
        &#x2F;&#x2F; 
        UNUSED(dummy);
        &#x2F;&#x2F; 退出子进程
        exitFromChild((retval &#x3D;&#x3D; C_OK) ? 0 : 1);
    &#125; else &#123;
        &#x2F;* Parent *&#x2F;
        close(safe_to_exit_pipe);
        if (childpid &#x3D;&#x3D; -1) &#123;
            &#x2F;&#x2F; 打日志  不能后台保存 fork错误 
            serverLog(LL_WARNING,&quot;Can&#39;t save in background: fork: %s&quot;,
                strerror(errno));

            &#x2F;* Undo the state change. The caller will perform cleanup on
             * all the slaves in BGSAVE_START state, but an early call to
             * replicationSetupSlaveForFullResync() turned it into BGSAVE_END *&#x2F;
            &#x2F;&#x2F;  
            listRewind(server.slaves,&amp;li);
            while((ln &#x3D; listNext(&amp;li))) &#123;
                client *slave &#x3D; ln-&gt;value;
                if (slave-&gt;replstate &#x3D;&#x3D; SLAVE_STATE_WAIT_BGSAVE_END) &#123;
                    slave-&gt;replstate &#x3D; SLAVE_STATE_WAIT_BGSAVE_START;
                &#125;
            &#125;
            &#x2F;&#x2F; 关闭 rdb写管道
            close(rdb_pipe_write);
            &#x2F;&#x2F; 
            close(server.rdb_pipe_read);
            &#x2F;&#x2F; 释放内存
            zfree(server.rdb_pipe_conns);
            server.rdb_pipe_conns &#x3D; NULL;
            server.rdb_pipe_numconns &#x3D; 0;
            server.rdb_pipe_numconns_writing &#x3D; 0;
            &#x2F;&#x2F; 
            closeChildInfoPipe();
        &#125; else &#123;
            serverLog(LL_NOTICE,&quot;Background RDB transfer started by pid %d&quot;,
                childpid);
            server.rdb_save_time_start &#x3D; time(NULL);
            server.rdb_child_pid &#x3D; childpid;
            server.rdb_child_type &#x3D; RDB_CHILD_TYPE_SOCKET;
            updateDictResizePolicy();
            &#x2F;&#x2F; 在父进程关闭rdb写管道，以便它可以检测到孩子的关闭。
            close(rdb_pipe_write);
            &#x2F;&#x2F; 创建文件事件  设置回调函数 rdbPipeReadHandler
            if (aeCreateFileEvent(server.el, server.rdb_pipe_read, AE_READABLE, rdbPipeReadHandler,NULL) &#x3D;&#x3D; AE_ERR) &#123;
                serverPanic(&quot;Unrecoverable error creating server.rdb_pipe_read file event.&quot;);
            &#125;
        &#125;
        return (childpid &#x3D;&#x3D; -1) ? C_ERR : C_OK;
    &#125;
    return C_OK; &#x2F;* Unreached. *&#x2F;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>



<h2 id="4-2-RDB文件如何生成"><a href="#4-2-RDB文件如何生成" class="headerlink" title="(4.2) RDB文件如何生成"></a>(4.2) RDB文件如何生成</h2><p>  生成RDB文件的主要逻辑在<code>rdbSaveRio</code>函数</p>
<p>  <img src="/img/database/redis/persistence/rdb/redis-rdb-overview.png" alt="Redis RDB数据格式"></p>
<p>  主要步骤如下：</p>
<ol>
<li>保存元数据信息，比如<code>魔数</code>、<code>属性信息</code> (类似RPC序列化里的)</li>
<li>保存所有数据库字典里的<code>键值对</code>(包括内存淘汰策略、过期时间)</li>
<li>保存<code>结束符</code>、<code>校验和</code> 等。</li>
</ol>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* 
 * 生成 RDB 格式的数据库转储，将其发送到指定的 Redis I&#x2F;O 通道。 
 * 成功时返回 C_OK，否则返回 C_ERR，并且由于I&#x2F;O错误可能会丢失部分输出或全部输出。
 *
 * 当函数返回 C_ERR 并且如果 &#39;error&#39; 不为 NULL 时，
 * &#39;error&#39; 指向的整数将设置为紧接在 I&#x2F;O 错误之后的 errno 的值。
 *
 * @param *rdb
 * @param *error
 * @param rdbflags
 * @param *rsi
 *&#x2F;
int rdbSaveRio(rio *rdb, int *error, int rdbflags, rdbSaveInfo *rsi) &#123;
    dictIterator *di &#x3D; NULL;
    dictEntry *de;
    char magic[10];
    int j;
    uint64_t cksum;
    size_t processed &#x3D; 0;

    if (server.rdb_checksum)
        rdb-&gt;update_cksum &#x3D; rioGenericUpdateChecksum;

    &#x2F;&#x2F; 生成魔数magic    
    snprintf(magic,sizeof(magic),&quot;REDIS%04d&quot;,RDB_VERSION);
    &#x2F;&#x2F; 将magic写入RDB文件
    if (rdbWriteRaw(rdb,magic,9) &#x3D;&#x3D; -1) goto werr;

    &#x2F;&#x2F; 写入属性信息
    if (rdbSaveInfoAuxFields(rdb,rdbflags,rsi) &#x3D;&#x3D; -1) goto werr;

    &#x2F;&#x2F; 写入 信息
    if (rdbSaveModulesAux(rdb, REDISMODULE_AUX_BEFORE_RDB) &#x3D;&#x3D; -1) goto werr;

    &#x2F;&#x2F;  
    for (j &#x3D; 0; j &lt; server.dbnum; j++) &#123;
        &#x2F;&#x2F; 获取redisDb 
        redisDb *db &#x3D; server.db+j;
        &#x2F;&#x2F; 字典
        dict *d &#x3D; db-&gt;dict;
        &#x2F;&#x2F; 字典为空 跳过
        if (dictSize(d) &#x3D;&#x3D; 0) continue;
        &#x2F;&#x2F; 迭代器
        di &#x3D; dictGetSafeIterator(d);


        &#x2F;&#x2F; 写 SELECT DB 操作符  &#x2F;&#x2F; 解决数据一致性问题  避免从节点写到其它库里
        if (rdbSaveType(rdb,RDB_OPCODE_SELECTDB) &#x3D;&#x3D; -1) goto werr;
        &#x2F;&#x2F; 保存编码长度 
        if (rdbSaveLen(rdb,j) &#x3D;&#x3D; -1) goto werr;

        &#x2F;* Write the RESIZE DB opcode. *&#x2F;
        uint64_t db_size, expires_size;
        &#x2F;&#x2F; 数据个数
        db_size &#x3D; dictSize(db-&gt;dict);
        &#x2F;&#x2F; 过期数据个数
        expires_size &#x3D; dictSize(db-&gt;expires);
        &#x2F;&#x2F; 
        if (rdbSaveType(rdb,RDB_OPCODE_RESIZEDB) &#x3D;&#x3D; -1) goto werr;
        &#x2F;&#x2F; 
        if (rdbSaveLen(rdb,db_size) &#x3D;&#x3D; -1) goto werr;
        &#x2F;&#x2F; 
        if (rdbSaveLen(rdb,expires_size) &#x3D;&#x3D; -1) goto werr;

        &#x2F;&#x2F; 遍历DB里的每个entry 
        while((de &#x3D; dictNext(di)) !&#x3D; NULL) &#123;
            &#x2F;&#x2F; 获取key  二进制安全的key
            sds keystr &#x3D; dictGetKey(de);
            &#x2F;&#x2F; 
            robj key, *o &#x3D; dictGetVal(de);
            long long expire;

            &#x2F;&#x2F; 初始化key的状态
            initStaticStringObject(key,keystr);
            &#x2F;&#x2F; 获取key的过期时间
            expire &#x3D; getExpire(db,&amp;key);
            &#x2F;&#x2F; 保存键值对
            if (rdbSaveKeyValuePair(rdb,&amp;key,o,expire) &#x3D;&#x3D; -1) goto werr;


            &#x2F;&#x2F; 当此RDB作为AOF重写的一部分生成时，在重写时将累积的差异从父级移动到子级，以便最终写入更小。 

            if (rdbflags &amp; RDBFLAGS_AOF_PREAMBLE &amp;&amp;
                rdb-&gt;processed_bytes &gt; processed+AOF_READ_DIFF_INTERVAL_BYTES)
            &#123;
                &#x2F;&#x2F;  
                processed &#x3D; rdb-&gt;processed_bytes;
                &#x2F;&#x2F; 
                aofReadDiffFromParent();
            &#125;
        &#125;
        &#x2F;&#x2F; 
        dictReleaseIterator(di);
        di &#x3D; NULL;  &#x2F;&#x2F; 这样我们就不会因为错误而再次发布它。 
    &#125;

    &#x2F;* If we are storing the replication information on disk, persist
     * the script cache as well: on successful PSYNC after a restart, we need
     * to be able to process any EVALSHA inside the replication backlog the
     * master will send us. *&#x2F;
    if (rsi &amp;&amp; dictSize(server.lua_scripts)) &#123;
        &#x2F;&#x2F; 
        di &#x3D; dictGetIterator(server.lua_scripts);
        &#x2F;&#x2F; 遍历
        while((de &#x3D; dictNext(di)) !&#x3D; NULL) &#123;
            &#x2F;&#x2F;  
            robj *body &#x3D; dictGetVal(de);
            &#x2F;&#x2F; 
            if (rdbSaveAuxField(rdb,&quot;lua&quot;,3,body-&gt;ptr,sdslen(body-&gt;ptr)) &#x3D;&#x3D; -1)
                goto werr;
        &#125;
        &#x2F;&#x2F; 
        dictReleaseIterator(di);
        di &#x3D; NULL;  &#x2F;&#x2F; 这样我们就不会因为错误而再次发布它。 
    &#125;

    &#x2F;&#x2F;  
    if (rdbSaveModulesAux(rdb, REDISMODULE_AUX_AFTER_RDB) &#x3D;&#x3D; -1) goto werr;

    &#x2F;&#x2F; 保存RDB文件结束符
    if (rdbSaveType(rdb,RDB_OPCODE_EOF) &#x3D;&#x3D; -1) goto werr;

    &#x2F;&#x2F; CRC64 校验和。 如果禁用校验和计算，它将为零，在这种情况下加载代码会跳过检查。
    cksum &#x3D; rdb-&gt;cksum;
    &#x2F;&#x2F; 小端编码
    memrev64ifbe(&amp;cksum);
    &#x2F;&#x2F; 写入校验和
    if (rioWrite(rdb,&amp;cksum,8) &#x3D;&#x3D; 0) goto werr;
    return C_OK;

werr:
    if (error) *error &#x3D; errno;
    if (di) dictReleaseIterator(di);
    return C_ERR;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/rdb.h</span>

<span class="token comment">/* Special RDB opcodes (saved/loaded with rdbSaveType/rdbLoadType). */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_MODULE_AUX</span> <span class="token expression"><span class="token number">247</span>   </span><span class="token comment">/* Module auxiliary data. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_IDLE</span>       <span class="token expression"><span class="token number">248</span>   </span><span class="token comment">/* LRU idle time. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_FREQ</span>       <span class="token expression"><span class="token number">249</span>   </span><span class="token comment">/* LFU frequency. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_AUX</span>        <span class="token expression"><span class="token number">250</span>   </span><span class="token comment">/* RDB aux field. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_RESIZEDB</span>   <span class="token expression"><span class="token number">251</span>   </span><span class="token comment">/* Hash table resize hint. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_EXPIRETIME_MS</span> <span class="token expression"><span class="token number">252</span>    </span><span class="token comment">/* Expire time in milliseconds. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_EXPIRETIME</span> <span class="token expression"><span class="token number">253</span>       </span><span class="token comment">/* Old expire time in seconds. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_SELECTDB</span>   <span class="token expression"><span class="token number">254</span>   </span><span class="token comment">/* DB number of the following keys. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RDB_OPCODE_EOF</span>        <span class="token expression"><span class="token number">255</span>   </span><span class="token comment">/* End of the RDB file. */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* 
 * 保存一些默认的 AUX 字段，其中包含有关生成的 RDB 的信息。
 *&#x2F;
int rdbSaveInfoAuxFields(rio *rdb, int rdbflags, rdbSaveInfo *rsi) &#123;
    &#x2F;&#x2F;  
    int redis_bits &#x3D; (sizeof(void*) &#x3D;&#x3D; 8) ? 64 : 32;
    &#x2F;&#x2F; 
    int aof_preamble &#x3D; (rdbflags &amp; RDBFLAGS_AOF_PREAMBLE) !&#x3D; 0;

    &#x2F;&#x2F; 在创建 RDB 时添加一些关于状态的字段。

    &#x2F;&#x2F; 保存 Redis版本信息
    if (rdbSaveAuxFieldStrStr(rdb,&quot;redis-ver&quot;,REDIS_VERSION) &#x3D;&#x3D; -1) return -1;
    &#x2F;&#x2F; 保存 Redis运行平台的架构信息 (32位还是64位) 
    if (rdbSaveAuxFieldStrInt(rdb,&quot;redis-bits&quot;,redis_bits) &#x3D;&#x3D; -1) return -1;
    &#x2F;&#x2F; 保存 RDB文件的创建时间
    if (rdbSaveAuxFieldStrInt(rdb,&quot;ctime&quot;,time(NULL)) &#x3D;&#x3D; -1) return -1;
    &#x2F;&#x2F; 保存 Redis Server已使用的内存空间大小
    if (rdbSaveAuxFieldStrInt(rdb,&quot;used-mem&quot;,zmalloc_used_memory()) &#x3D;&#x3D; -1) return -1;

    &#x2F;* Handle saving options that generate aux fields. *&#x2F;
    if (rsi) &#123;
        &#x2F;&#x2F; 保存  
        if (rdbSaveAuxFieldStrInt(rdb,&quot;repl-stream-db&quot;,rsi-&gt;repl_stream_db)
            &#x3D;&#x3D; -1) return -1;

        &#x2F;&#x2F; 保存 复制id &#x3D; Redis Server 的 server.replid
        if (rdbSaveAuxFieldStrStr(rdb,&quot;repl-id&quot;,server.replid)
            &#x3D;&#x3D; -1) return -1;

        &#x2F;&#x2F; 保存 复制偏移量 &#x3D; 主节点的复制偏移量  
        if (rdbSaveAuxFieldStrInt(rdb,&quot;repl-offset&quot;,server.master_repl_offset)
            &#x3D;&#x3D; -1) return -1;
    &#125;

    &#x2F;&#x2F; 保存 aof-preamble
    if (rdbSaveAuxFieldStrInt(rdb,&quot;aof-preamble&quot;,aof_preamble) &#x3D;&#x3D; -1) return -1;
    return 1;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;&#x2F; file: src&#x2F;rdb.c

&#x2F;* 
 * 保存键值对
 * 
 * 保存键值对，带过期时间、类型、键、值 
 * 错误时返回-1
 * 如果key实际保存成功，则返回1，否则返回0(key已过期)。
 * 
 * @param *rdb 
 * @param *key 
 * @param *val
 * @param expiretime
 *&#x2F;
int rdbSaveKeyValuePair(rio *rdb, robj *key, robj *val, long long expiretime) &#123;
    &#x2F;&#x2F; 内存淘汰策略
    int savelru &#x3D; server.maxmemory_policy &amp; MAXMEMORY_FLAG_LRU;
    int savelfu &#x3D; server.maxmemory_policy &amp; MAXMEMORY_FLAG_LFU;

    &#x2F;&#x2F; 过期时间
    if (expiretime !&#x3D; -1) &#123;  &#x2F;&#x2F; key是会过期的
        &#x2F;&#x2F; 保存过期时间类型(ms)
        if (rdbSaveType(rdb,RDB_OPCODE_EXPIRETIME_MS) &#x3D;&#x3D; -1) return -1;
        &#x2F;&#x2F; 保存过期时间(ms级)
        if (rdbSaveMillisecondTime(rdb,expiretime) &#x3D;&#x3D; -1) return -1;
    &#125;

    &#x2F;&#x2F; 保存LRU信息
    if (savelru) &#123;  &#x2F;&#x2F; 如果使用lru
        &#x2F;&#x2F; 对象空闲时间  ms
        uint64_t idletime &#x3D; estimateObjectIdleTime(val);
        idletime &#x2F;&#x3D; 1000; &#x2F;&#x2F; 使用秒就足够了，而且需要的空间更少。 
        &#x2F;&#x2F; 保存类型为LRU空闲时间
        if (rdbSaveType(rdb,RDB_OPCODE_IDLE) &#x3D;&#x3D; -1) return -1;
        &#x2F;&#x2F; 保存对象空间时间 (秒级)
        if (rdbSaveLen(rdb,idletime) &#x3D;&#x3D; -1) return -1;
    &#125;

    &#x2F;&#x2F; 保存LFU信息
    if (savelfu) &#123;
        uint8_t buf[1];
        &#x2F;&#x2F; 
        buf[0] &#x3D; LFUDecrAndReturn(val);

        &#x2F;&#x2F; 我们可以用两个字节对其进行编码：操作码和一个8位计数器，因为频率是 0-255 范围内的对数。
        &#x2F;&#x2F; 请注意，我们不存储减半时间，因为在加载时将其重置一次不会对频率产生太大影响。  

        &#x2F;&#x2F; 保存类型为LFU
        if (rdbSaveType(rdb,RDB_OPCODE_FREQ) &#x3D;&#x3D; -1) return -1;
        &#x2F;&#x2F; 保存LFU信息
        if (rdbWriteRaw(rdb,buf,1) &#x3D;&#x3D; -1) return -1;
    &#125;


    &#x2F;&#x2F; 保存类型
    if (rdbSaveObjectType(rdb,val) &#x3D;&#x3D; -1) return -1;
    &#x2F;&#x2F; 保存key
    if (rdbSaveStringObject(rdb,key) &#x3D;&#x3D; -1) return -1;
    &#x2F;&#x2F; 保存value
    if (rdbSaveObject(rdb,val,key) &#x3D;&#x3D; -1) return -1;

    &#x2F;&#x2F; 如果需要延迟返回（用于测试）
    if (server.rdb_key_save_delay)
        usleep(server.rdb_key_save_delay);

    return 1;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="4-2-1-写入数据-rdbWriteRaw"><a href="#4-2-1-写入数据-rdbWriteRaw" class="headerlink" title="(4.2.1) 写入数据-rdbWriteRaw"></a>(4.2.1) 写入数据-rdbWriteRaw</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">rdbWriteRaw</span><span class="token punctuation">(</span>rio <span class="token operator">*</span>rdb<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rdb <span class="token operator">&amp;&amp;</span> <span class="token function">rioWrite</span><span class="token punctuation">(</span>rdb<span class="token punctuation">,</span>p<span class="token punctuation">,</span>len<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/io.h</span>

<span class="token comment">/*
 * 
 * @param *r 
 * @param *buf 要写入的数据
 * @param len 数据长度
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token class-name">size_t</span> <span class="token function">rioWrite</span><span class="token punctuation">(</span>rio <span class="token operator">*</span>r<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>flags <span class="token operator">&amp;</span> RIO_FLAG_WRITE_ERROR<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 长度大于-0</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 要写入的字节数 </span>
        <span class="token class-name">size_t</span> bytes_to_write <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>max_processing_chunk <span class="token operator">&amp;&amp;</span> r<span class="token operator">-></span>max_processing_chunk <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token operator">-></span>max_processing_chunk <span class="token operator">:</span> len<span class="token punctuation">;</span>
        <span class="token comment">// 更新校验和</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>update_cksum<span class="token punctuation">)</span> r<span class="token operator">-></span><span class="token function">update_cksum</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>bytes_to_write<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 写入数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>bytes_to_write<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            r<span class="token operator">-></span>flags <span class="token operator">|=</span> RIO_FLAG_WRITE_ERROR<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//</span>
        buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf <span class="token operator">+</span> bytes_to_write<span class="token punctuation">;</span>
        <span class="token comment">// 更新要写入的长度</span>
        len <span class="token operator">-=</span> bytes_to_write<span class="token punctuation">;</span>
        <span class="token comment">// </span>
        r<span class="token operator">-></span>processed_bytes <span class="token operator">+=</span> bytes_to_write<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/415563">Redis 源码剖析与实战 - 18 | 如何生成和解读RDB文件？</a><br>[2] <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/6.0/src/rdb.c">redis-rdb.c - github</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/01/08/redis-io-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/08/redis-io-model/" class="post-title-link" itemprop="url">Redis IO模型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-08 08:56:06" itemprop="dateCreated datePublished" datetime="2022-01-08T08:56:06+08:00">2022-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-02-05 21:14:01" itemprop="dateModified" datetime="2023-02-05T21:14:01+08:00">2023-02-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>27k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>24 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  RedisIO模型</p>
<p>  Redis服务器端单线程可以达到每秒可以达到数万QPS的处理能力。如此高性能的其中一个原因就是运用了Linux提供的IO多路复用机制epoll。</p>
<p>  <img src="/img/database/redis/io-model/linux-io-multiplexing-epoll.png" alt="IO模型"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/01/08/redis-io-model/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>
</div>
<div class="busuanzi-count">
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://unpkg.com/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
