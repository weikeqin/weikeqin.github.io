<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="msvalidate.01" content="CBB4A6675274A9B82BB82B104F7915A7">
  <meta name="yandex-verification" content="4fa4531dcc9e1bfd">
  <meta name="baidu-site-verification" content="1d263b839540cec80d3497b2f877c5da">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"weikeqin.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"waline","storage":true,"lazyload":false,"nav":null,"activeClass":"waline"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="不积跬步无以至千里">
<meta property="og:type" content="website">
<meta property="og:title" content="你要如何衡量你的人生">
<meta property="og:url" content="http://weikeqin.com/page/4/index.html">
<meta property="og:site_name" content="你要如何衡量你的人生">
<meta property="og:description" content="不积跬步无以至千里">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="tech,Redis,MySQL,ElasticSearch,Neo4j,Java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://weikeqin.com/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>你要如何衡量你的人生 - 坚持，努力，让好事发生</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365"></script>






<link rel="dns-prefetch" href="https://fantastic-paletas-170a7a.netlify.app/.netlify/functions/comment">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">你要如何衡量你的人生</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">坚持，努力，让好事发生</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">316</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

<div class="revolvermaps">
    <script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5rcgvdncuwu&amp;m=7&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/09/04/linux-network-packet-receiving-process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你要如何衡量你的人生">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 你要如何衡量你的人生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/04/linux-network-packet-receiving-process/" class="post-title-link" itemprop="url">Linux网络包接收流程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-04 08:57:46" itemprop="dateCreated datePublished" datetime="2022-09-04T08:57:46+08:00">2022-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-27 23:54:40" itemprop="dateModified" datetime="2022-11-27T23:54:40+08:00">2022-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/basic/" itemprop="url" rel="index"><span itemprop="name">basic</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2022/09/04/linux-network-packet-receiving-process/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/09/04/linux-network-packet-receiving-process/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>208</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  在发现负责的服务网络超时时，一般会通过 监控平台、Metric、Trace、ErrorLog来观察系统状态，来判断问题在哪里。</p>
<p>  今天咱们来探讨一下，如果是负责的服务收包出现问题，怎么定位问题？</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/GoYDsfy9m0wRoXi_NCfCmg">开发内功修炼-图解Linux网络包接收过程</a><br>[2] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/107485">趣谈Linux操作系统 - 47 | 接收网络包（上）：如何搞明白合作伙伴让我们做什么？</a><br>[3] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/108227">趣谈Linux操作系统 - 48 | 接收网络包（下）：如何搞明白合作伙伴让我们做什么？</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/08/20/go-performance-tuning-tool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你要如何衡量你的人生">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 你要如何衡量你的人生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/20/go-performance-tuning-tool/" class="post-title-link" itemprop="url">go性能分析 及 线上问题定位</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-08-20 22:30:00" itemprop="dateCreated datePublished" datetime="2022-08-20T22:30:00+08:00">2022-08-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-04-09 20:05:17" itemprop="dateModified" datetime="2023-04-09T20:05:17+08:00">2023-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2022/08/20/go-performance-tuning-tool/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/08/20/go-performance-tuning-tool/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  医生的<code>温度计</code>、<code>听诊器</code>、<code>血压计</code>，可以获取<code>就诊者</code>的各种健康指标。</p>
<p>  如果把<code>研发工程师</code>比喻成<code>医生</code>，那<code>pprof</code>就是类似<code>温度计</code>、<code>听诊器</code>、<code>血压计</code>的一个工具集，可以用来分析<code>CPU</code>、<code>goroutine堆栈跟踪</code>、<code>内存分配及使用情况</code>、<code>互斥锁争用及耗时</code>、<code>goroutine阻塞</code> 等</p>
<p>  <img src="/img/go/pprof/go-pprof-flamegraph2.png" alt="火焰图"></p>
<h1 id="1-pprof是什么"><a href="#1-pprof是什么" class="headerlink" title="(1) pprof是什么"></a>(1) pprof是什么</h1><p>  性能分析是通过<code>分析器</code>(profiler)工具进行检测来实现的，在 Go 中使用称为 pprof。</p>
<p>  pprof工具可以用来监测进程的运行数据，用于监控程序的性能及状况，以下指标都可以监控</p>
<blockquote>
<p>CPU— 确定应用程序的时间花在了哪里<br>Goroutine— 报告正在运行的 goroutines 堆栈跟踪<br>Heap— 报告堆内存分配以监视当前内存使用情况并检查可能的内存泄漏<br>Mutex— 报告锁争情况来分析代码中互斥锁使用行为以及应用程序是否在锁定调用上花费了太多时间<br>Block— 显示 goroutines 阻塞等待同步原语的位置</p>
</blockquote>
<p>  <img src="/img/go/pprof/go-pprof.png"></p>
<h1 id="2-如何使用pprof"><a href="#2-如何使用pprof" class="headerlink" title="(2) 如何使用pprof"></a>(2) 如何使用pprof</h1><p>  pprof必须在代码里引入才能使用<br>  不像Java里的 <code>jps</code>、<code>jstat</code>、<code>jinfo</code>、<code>jstack</code>、<code>jmap</code> 工具可以单独使用</p>
<p>  pprof 可以从以下两个包中引入</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"net/http/pprof"</span>

<span class="token keyword">import</span> <span class="token string">"runtime/pprof"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>  其中 <code>net/http/pprof</code> 使用 <code>runtime/pprof</code> 包来进行封装，并在 http 端口上暴露出来。<br>  <code>runtime/pprof</code> 可以用来产生 dump 文件，再使用 go tool pprof 来分析这运行日志。</p>
<p>  使用 net/http/pprof 可以做到直接看到当前 web 服务的状态，包括 CPU 占用情况和内存使用情况等。</p>
<h2 id="2-1-通过网页可视化使用pprof"><a href="#2-1-通过网页可视化使用pprof" class="headerlink" title="(2.1) 通过网页可视化使用pprof"></a>(2.1) 通过网页可视化使用pprof</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"net/http"</span>
	<span class="token comment">// 代码里引入 pprof</span>
	<span class="token boolean">_</span> <span class="token string">"net/http/pprof"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 代码里引入http server </span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":6060"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

   <span class="token comment">// 省略业务代码</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  导入 <code>net/http/pprof</code> 的作用是，我们可以通过 <code>http://127.0.0.1:6060/debug/pprof/</code>  来访问 pprof<br>  通过 这个地址 可以通过网页很方便的查看各项指标</p>
<p>  即使在生产环境中启用 <code>pprof</code> 也是安全的</p>
<table>
<thead>
<tr>
<th align="left">作用</th>
<th align="left">关键字</th>
<th align="left">访问url</th>
</tr>
</thead>
<tbody><tr>
<td align="left">所有过去内存分配的样本</td>
<td align="left">allocs</td>
<td align="left"><code>http://127.0.0.1:6060/debug/pprof/allocs?debug=1</code></td>
</tr>
<tr>
<td align="left">导致同步基元阻塞的堆栈跟踪</td>
<td align="left">block</td>
<td align="left"><code>http://127.0.0.1:6060/debug/pprof/block?debug=1</code></td>
</tr>
<tr>
<td align="left">当前程序的命令行调用</td>
<td align="left">cmdline</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">所有当前 goroutines 的堆栈跟踪</td>
<td align="left">goroutine</td>
<td align="left"><code>http://127.0.0.1:6060/debug/pprof/goroutine?debug=1</code></td>
</tr>
<tr>
<td align="left">活动对象的内存分配示例</td>
<td align="left">heap</td>
<td align="left"><code>http://127.0.0.1:6060/debug/pprof/heap?debug=1</code></td>
</tr>
<tr>
<td align="left">争用互斥锁持有者的堆栈跟踪</td>
<td align="left">mutx</td>
<td align="left"><code>http://127.0.0.1:6060/debug/pprof/mutex?debug=1</code></td>
</tr>
<tr>
<td align="left">CPU性能分析</td>
<td align="left">profile</td>
<td align="left"><code>http://127.0.0.1:6060/debug/pprof/profile?debug=1</code></td>
</tr>
<tr>
<td align="left">创建新操作系统线程的堆栈跟踪</td>
<td align="left">threadcreate</td>
<td align="left"><code>http://127.0.0.1:6060/debug/pprof/threadcreate?debug=1</code></td>
</tr>
<tr>
<td align="left">当前程序执行的跟踪</td>
<td align="left">full goroutine stack dump</td>
<td align="left"><code>http://127.0.0.1:6060/debug/pprof/goroutine?debug=2</code></td>
</tr>
</tbody></table>
<h2 id="2-2-通过下载的pprof文件分析"><a href="#2-2-通过下载的pprof文件分析" class="headerlink" title="(2.2) 通过下载的pprof文件分析"></a>(2.2) 通过下载的pprof文件分析</h2><h3 id="2-2-1-下载并使用"><a href="#2-2-1-下载并使用" class="headerlink" title="(2.2.1) 下载并使用"></a>(2.2.1) 下载并使用</h3><p>  直接运行 <code>go tool pprof http://localhost:6060/debug/pprof/profile</code>，其会自动下载数据到本地，然后供分析。<br>  默认会下载到当前用户的 <code>~/pprof/pprof.samples.cpu.001.pb.gz</code> 目录下</p>
<p>  <code>go tool pprof http://localhost:6060/debug/pprof/profile</code> = <code>download filepath </code> + <code>go tool pprof filepath</code></p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token punctuation">[</span>weikeqin<span class="token operator">@</span>bogon thrift<span class="token operator">-</span>tutorial<span class="token operator">-</span>go<span class="token operator">-</span>demo <span class="token operator">(</span>master<span class="token operator">)</span><span class="token punctuation">]</span><span class="token operator">$</span> go tool pprof <span class="token url">http://localhost:6060/debug/pprof/profile</span> 
Fetching profile over HTTP from <span class="token url">http://localhost:6060/debug/pprof/profile</span>
Saved profile in <span class="token file-path string">/Users/weikeqin/pprof/pprof.samples.cpu.001.pb.gz</span>
<span class="token property">Type:</span> cpu
<span class="token property">Time:</span> <span class="token date number">Aug 20</span><span class="token punctuation">,</span> <span class="token number">2022</span> at <span class="token number">8</span><span class="token operator">:</span><span class="token number">37pm</span> <span class="token operator">(</span>CST<span class="token operator">)</span>
<span class="token property">Duration:</span> <span class="token number">30s</span><span class="token punctuation">,</span> Total samples <span class="token operator">=</span> <span class="token number">2.37s</span> <span class="token operator">(</span> <span class="token number">7.90</span><span class="token operator">%</span><span class="token operator">)</span>
Entering interactive mode <span class="token operator">(</span>type <span class="token string">"help"</span> for commands<span class="token punctuation">,</span> <span class="token string">"o"</span> for options<span class="token operator">)</span>
<span class="token operator">(</span>pprof<span class="token operator">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="2-2-2-下载数据离线分析"><a href="#2-2-2-下载数据离线分析" class="headerlink" title="(2.2.2) 下载数据离线分析"></a>(2.2.2) 下载数据离线分析</h3><p><strong>下载文件</strong></p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token punctuation">[</span>weikeqin<span class="token operator">@</span>computer <span class="token operator">~</span><span class="token punctuation">]</span><span class="token operator">$</span> curl <span class="token operator">-</span>o <span class="token file-path string">/Users/weikeqin/pprof/go_profile.out</span>  <span class="token url">http://localhost:6060/debug/pprof/profile</span>
  <span class="token operator">%</span> Total    <span class="token operator">%</span> Received <span class="token operator">%</span> Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span class="token number">100</span>   <span class="token number">107</span>  <span class="token number">100</span>   <span class="token number">107</span>    <span class="token number">0</span>     <span class="token number">0</span>      <span class="token number">3</span>      <span class="token number">0</span>  <span class="token time number">0:00:35</span>  <span class="token time number">0:00:30</span>  <span class="token time number">0:00:05</span>    <span class="token number">22</span>
<span class="token punctuation">[</span>weikeqin<span class="token operator">@</span>computer <span class="token operator">~</span><span class="token punctuation">]</span><span class="token operator">$</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  执行 <code>curl -o /Users/weikeqin/pprof/go_profile.out  http://localhost:6060/debug/pprof/profile</code> ，会下载原始数据文件到 <code>/Users/weikeqin/pprof/go_profile.out</code> 目录。</p>
<p><strong>分析文件</strong></p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token punctuation">[</span>weikeqin<span class="token operator">@</span>computer pprof<span class="token punctuation">]</span><span class="token operator">$</span> go tool pprof <span class="token file-path string">/Users/weikeqin/pprof/go_profile.out</span>
<span class="token property">Type:</span> cpu
<span class="token property">Time:</span> <span class="token date number">Aug 20</span><span class="token punctuation">,</span> <span class="token number">2022</span> at <span class="token number">3</span><span class="token operator">:</span><span class="token number">39pm</span> <span class="token operator">(</span>CST<span class="token operator">)</span>
<span class="token property">Duration:</span> <span class="token number">30.01s</span><span class="token punctuation">,</span> Total samples <span class="token operator">=</span> <span class="token number">0</span>
No samples were found with the default sample value type<span class="token punctuation">.</span>
Try <span class="token string">"sample_index"</span> command to analyze different sample values<span class="token punctuation">.</span>
Entering interactive mode <span class="token operator">(</span>type <span class="token string">"help"</span> for commands<span class="token punctuation">,</span> <span class="token string">"o"</span> for options<span class="token operator">)</span>
<span class="token operator">(</span>pprof<span class="token operator">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<br>



<h1 id="3-分析CPU占用情况"><a href="#3-分析CPU占用情况" class="headerlink" title="(3) 分析CPU占用情况"></a>(3) 分析CPU占用情况</h1><p>  通过 <code>http://127.0.0.1:6060/debug/pprof/profile?debug=1</code> 可以下载 <code>go_pprof_profile.out</code> 文件 </p>
<h2 id="3-1-CPU分析原理"><a href="#3-1-CPU分析原理" class="headerlink" title="(3.1) CPU分析原理"></a>(3.1) CPU分析原理</h2><p>  CPU 分析器依赖于操作系统和信号。</p>
<p>  当它被激活时，应用程序默认通过 SIGPROF 信号要求操作系统每 10 毫秒中断一次。当应用程序收到 SIGPROF 时，它会暂停当前活动并将执行转移到分析器。</p>
<p>  分析器收集诸如当前 goroutine 活动之类的数据，并汇总可以检索的执行统计信息；然后停止分析并继续执行直到下一次的 SIGPROF。</p>
<p>  我们可以访问 /debug/pprof/profile 路由来激活 CPU 分析。默认情况下，访问此路由会执行 30 秒的 CPU 分析。在 30 秒内，我们的应用程序每 10 毫秒中断一次。</p>
<p>  请注意，可以更改这两个默认值：使用 seconds 参数将分析应该持续多长时间传递给路由（例如 /debug/pprof/profile?seconds=15），也可以更改中断率（甚至小于 10 毫秒）。</p>
<p>  但多数情况下，10 毫秒应该足够了，在减小这个值（意味着增加频率）时，我们应该注意不要对性能产生影响。30 秒后，就可以下载 CPU 分析器的结果。</p>
<p>  注意：<br>  也可以通过  -cpuprofile 标志来开启 CPU 分析器，比如在运行基准测试时就可以用这种方式。</p>
<p>  例如，执行以下命令后可通过 /debug/pprof/profile 下载到相同的分析结果文件。</p>
<h2 id="3-2-通过命令分析CPU数值指标"><a href="#3-2-通过命令分析CPU数值指标" class="headerlink" title="(3.2) 通过命令分析CPU数值指标"></a>(3.2) 通过命令分析CPU数值指标</h2><p>  如果在代码里使用了 <code>http.ListenAndServe(&quot;:6060&quot;, nil)</code>，可以直接访问 <code>http://127.0.0.1:6060/debug/pprof/profile?debug=1</code> 获取profile文件 </p>
<p>  获取profile文件后使用 <code>go tool pprof go_profile.out</code> 来分析CPU占用情况</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">(</span>pprof<span class="token operator">)</span> 
<span class="token operator">(</span>pprof<span class="token operator">)</span> help 
  <span class="token property">Commands:</span>
    callgrind        Outputs a graph in callgrind format
    comments         Output all profile comments
    disasm           Output assembly listings annotated with samples
    dot              Outputs a graph in DOT format
    eog              Visualize graph through eog
    evince           Visualize graph through evince
    gif              Outputs a graph image in GIF format
    gv               Visualize graph through gv
    kcachegrind      Visualize report in KCachegrind
    list             Output annotated source for functions matching regexp
    pdf              Outputs a graph in PDF format
    peek             Output callers<span class="token operator">/</span>callees of functions matching regexp
    png              Outputs a graph image in PNG format
    proto            Outputs the profile in compressed protobuf format
    ps               Outputs a graph in PS format
    raw              Outputs a text representation of the raw profile
    svg              Outputs a graph in SVG format
    tags             Outputs all tags in the profile
    text             Outputs top entries in text form
    top              Outputs top entries in text form
    topproto         Outputs top entries in compressed protobuf format
    traces           Outputs all profile samples in text form
    tree             Outputs a text rendering of call graph
    web              Visualize graph through web browser
    weblist          Display annotated source in a web browser
    o<span class="token operator">/</span>options        List options and their current values
    q<span class="token operator">/</span>quit<span class="token operator">/</span>exit<span class="token operator">/</span><span class="token operator">^</span>D   Exit pprof

  <span class="token property">Options:</span>
    call_tree        Create a context<span class="token operator">-</span>sensitive call tree
    compact_labels   Show minimal headers
    divide_by        Ratio to divide all samples before visualization
    drop_negative    Ignore negative differences
    edgefraction     Hide edges below <span class="token operator">&lt;</span>f<span class="token operator">></span><span class="token operator">*</span>total
    focus            Restricts to samples going through a node matching regexp
    hide             Skips nodes matching regexp
    ignore           Skips paths going through any nodes matching regexp
    intel_syntax     Show assembly in Intel syntax
    mean             Average sample value over first value <span class="token operator">(</span>count<span class="token operator">)</span>
    nodecount        Max number of nodes to show
    nodefraction     Hide nodes below <span class="token operator">&lt;</span>f<span class="token operator">></span><span class="token operator">*</span>total
    noinlines        Ignore inlines<span class="token punctuation">.</span>
    normalize        Scales profile based on the base profile<span class="token punctuation">.</span>
    output           Output filename for file<span class="token operator">-</span>based outputs
    prune_from       Drops any functions below the matched frame<span class="token punctuation">.</span>
    relative_percentages Show percentages relative to focused subgraph
    sample_index     Sample value to report <span class="token operator">(</span><span class="token number">0</span><span class="token operator">-</span>based index or name<span class="token operator">)</span>
    show             Only show nodes matching regexp
    show_from        Drops functions above the highest matched frame<span class="token punctuation">.</span>
    source_path      Search path for source files
    tagfocus         Restricts to samples with tags in range or matched by regexp
    taghide          Skip tags matching this regexp
    tagignore        Discard samples with tags in range or matched by regexp
    tagleaf          Adds pseudo stack frames for labels key<span class="token operator">/</span>value pairs at the callstack leaf<span class="token punctuation">.</span>
    tagroot          Adds pseudo stack frames for labels key<span class="token operator">/</span>value pairs at the callstack root<span class="token punctuation">.</span>
    tagshow          Only consider tags matching this regexp
    trim             Honor nodefraction<span class="token operator">/</span>edgefraction<span class="token operator">/</span>nodecount defaults
    trim_path        Path to trim from source paths before search
    unit             Measurement units to display

  <span class="token property">Option groups (only set one per group):</span>
    granularity      
      functions        Aggregate at the function level<span class="token punctuation">.</span>
      filefunctions    Aggregate at the function level<span class="token punctuation">.</span>
      files            Aggregate at the file level<span class="token punctuation">.</span>
      lines            Aggregate at the source code line level<span class="token punctuation">.</span>
      addresses        Aggregate at the address level<span class="token punctuation">.</span>
    sort             
      cum              Sort entries based on cumulative weight
      flat             Sort entries based on own weight
  <span class="token operator">:</span>   Clear focus<span class="token operator">/</span>ignore<span class="token operator">/</span>hide<span class="token operator">/</span>tagfocus<span class="token operator">/</span>tagignore

  type <span class="token string">"help &lt;cmd|option>"</span> for more information
<span class="token operator">(</span>pprof<span class="token operator">)</span> 
<span class="token operator">(</span>pprof<span class="token operator">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="3-2-1-生成调用关系图"><a href="#3-2-1-生成调用关系图" class="headerlink" title="(3.2.1) 生成调用关系图"></a>(3.2.1) 生成调用关系图</h3><pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">(</span>pprof<span class="token operator">)</span>  web
<span class="token operator">(</span>pprof<span class="token operator">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>  会生成一个svg图片保存到 <code>file:///private/var/folders/ry/j30lp1sn19q7rbtq6020f6880000gn/T/pprof001.svg</code>，并且自动打开。</p>
<p>  <img src="/img/go/pprof/go-pprof-graph.svg" alt="调用关系图"></p>
<p>  每个方框代表一个函数，方框的大小和执行时间成正比，箭头代表调用关系，箭头上的时间代表被调用函数的执行时间</p>
<h3 id="3-2-2-查看top占用"><a href="#3-2-2-查看top占用" class="headerlink" title="(3.2.2) 查看top占用"></a>(3.2.2) 查看top占用</h3><pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">(</span>pprof<span class="token operator">)</span> top
Showing nodes accounting for <span class="token number">5.75s</span><span class="token punctuation">,</span> <span class="token number">94.73</span><span class="token operator">%</span> of <span class="token number">6.07s</span> total
Dropped <span class="token number">118</span> nodes <span class="token operator">(</span>cum <span class="token operator">&lt;</span><span class="token operator">=</span> <span class="token number">0.03s</span><span class="token operator">)</span>
Showing top <span class="token number">10</span> nodes out of <span class="token number">94</span>
      flat  flat<span class="token operator">%</span>   sum<span class="token operator">%</span>        cum   cum<span class="token operator">%</span>
     <span class="token number">3.46s</span> <span class="token number">57.00</span><span class="token operator">%</span> <span class="token number">57.00</span><span class="token operator">%</span>      <span class="token number">3.47s</span> <span class="token number">57.17</span><span class="token operator">%</span>  <span class="token domain constant">syscall.syscall6</span>
     <span class="token number">1.34s</span> <span class="token number">22.08</span><span class="token operator">%</span> <span class="token number">79.08</span><span class="token operator">%</span>      <span class="token number">1.34s</span> <span class="token number">22.08</span><span class="token operator">%</span>  <span class="token domain constant">runtime.kevent</span>
     <span class="token number">0.30s</span>  <span class="token number">4.94</span><span class="token operator">%</span> <span class="token number">84.02</span><span class="token operator">%</span>      <span class="token number">0.30s</span>  <span class="token number">4.94</span><span class="token operator">%</span>  <span class="token domain constant">syscall.syscall</span>
     <span class="token number">0.16s</span>  <span class="token number">2.64</span><span class="token operator">%</span> <span class="token number">86.66</span><span class="token operator">%</span>      <span class="token number">0.16s</span>  <span class="token number">2.64</span><span class="token operator">%</span>  runtime<span class="token punctuation">.</span>siftdownTimer
     <span class="token number">0.12s</span>  <span class="token number">1.98</span><span class="token operator">%</span> <span class="token number">88.63</span><span class="token operator">%</span>      <span class="token number">0.13s</span>  <span class="token number">2.14</span><span class="token operator">%</span>  <span class="token domain constant">runtime.chansend</span>
     <span class="token number">0.12s</span>  <span class="token number">1.98</span><span class="token operator">%</span> <span class="token number">90.61</span><span class="token operator">%</span>      <span class="token number">0.14s</span>  <span class="token number">2.31</span><span class="token operator">%</span>  <span class="token domain constant">runtime.walltime</span>
     <span class="token number">0.10s</span>  <span class="token number">1.65</span><span class="token operator">%</span> <span class="token number">92.26</span><span class="token operator">%</span>      <span class="token number">0.10s</span>  <span class="token number">1.65</span><span class="token operator">%</span>  <span class="token domain constant">runtime.madvise</span>
     <span class="token number">0.08s</span>  <span class="token number">1.32</span><span class="token operator">%</span> <span class="token number">93.57</span><span class="token operator">%</span>      <span class="token number">0.08s</span>  <span class="token number">1.32</span><span class="token operator">%</span>  runtime<span class="token punctuation">.</span>memclrNoHeapPointers
     <span class="token number">0.06s</span>  <span class="token number">0.99</span><span class="token operator">%</span> <span class="token number">94.56</span><span class="token operator">%</span>      <span class="token number">0.06s</span>  <span class="token number">0.99</span><span class="token operator">%</span>  <span class="token domain constant">runtime.nanotime1</span>
     <span class="token number">0.01s</span>  <span class="token number">0.16</span><span class="token operator">%</span> <span class="token number">94.73</span><span class="token operator">%</span>      <span class="token number">0.16s</span>  <span class="token number">2.64</span><span class="token operator">%</span>  <span class="token domain constant">runtime.mallocgc</span>
<span class="token operator">(</span>pprof<span class="token operator">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="3-3-CPU参数页面可视化分析"><a href="#3-3-CPU参数页面可视化分析" class="headerlink" title="(3.3) CPU参数页面可视化分析"></a>(3.3) CPU参数页面可视化分析</h2><p>  如果通过 <code>go tool pprof go_profile.out</code> 分析时觉得数字不直观时，可以通过页面可视化来查看</p>
<p>  其实就是开了一个http服务，然后把 <code>go_profile.out</code> 做成可视化的了</p>
<p>  比如 go_profile.out 对应的路径是 <code>/Users/weikeqin/WorkSpaces/golang/go_profile.out</code></p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token punctuation">[</span>weikeqin<span class="token operator">@</span>computer <span class="token operator">~</span><span class="token punctuation">]</span><span class="token operator">$</span> go tool pprof <span class="token operator">-</span>http<span class="token operator">=</span><span class="token operator">:</span><span class="token number">8080</span> <span class="token file-path string">/Users/weikeqin/WorkSpaces/golang/go_profile.out</span> 
Serving web UI on <span class="token url">http://localhost:8080</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>  <img src="/img/go/pprof/go-pprof-view.png"></p>
<h3 id="3-3-1-调用链路-graph"><a href="#3-3-1-调用链路-graph" class="headerlink" title="(3.3.1) 调用链路(graph)"></a>(3.3.1) 调用链路(graph)</h3><p>  <img src="/img/go/pprof/go-pprof-graph.svg"></p>
<h3 id="3-3-2-火焰图-flamegraph"><a href="#3-3-2-火焰图-flamegraph" class="headerlink" title="(3.3.2) 火焰图(flamegraph)"></a>(3.3.2) 火焰图(flamegraph)</h3><p>  <img src="/img/go/pprof/go-pprof-flamegraph.png"></p>
<p>  <img src="/img/go/pprof/go-pprof-flamegraph2.png"></p>
<h3 id="3-3-3-top"><a href="#3-3-3-top" class="headerlink" title="(3.3.3) top"></a>(3.3.3) top</h3><p>  CPU top占用情况</p>
<p>  <img src="/img/go/pprof/go-pprof-top.png"></p>
<h2 id="3-4-分析后的收获"><a href="#3-4-分析后的收获" class="headerlink" title="(3.4) 分析后的收获"></a>(3.4) 分析后的收获</h2><p>  对 runtime.mallogc 的调用过多，意味着我们可以尝试减少过多的小堆分配<br>  在通道操作或互斥锁上花费太多时间，可能表明过度竞争正在损害应用程序的性能<br>  在 syscall.Read 或 syscall.Write 上花费太多时间，意味着应用程序在内核模式下花费了大量时间。处理 I/O 缓冲可能是改进的途径</p>
<br>

 

<h1 id="4-分析内存-堆占用情况"><a href="#4-分析内存-堆占用情况" class="headerlink" title="(4) 分析内存-堆占用情况"></a>(4) 分析内存-堆占用情况</h1><p>  通过 <code>http://127.0.0.1:6060/debug/pprof/heap?debug=1</code> 可以查看堆占用情况 </p>
<h2 id="4-1-堆分析原理"><a href="#4-1-堆分析原理" class="headerlink" title="(4.1) 堆分析原理"></a>(4.1) 堆分析原理</h2><p>  与 CPU 分析一样，堆分析也是基于采样的。</p>
<h2 id="4-2-分析堆占用数字指标"><a href="#4-2-分析堆占用数字指标" class="headerlink" title="(4.2) 分析堆占用数字指标"></a>(4.2) 分析堆占用数字指标</h2><p>  通过 <code>http://127.0.0.1:6060/debug/pprof/heap?debug=1</code> 可以获取堆占用的详细数字指标</p>
<p>  <img src="/img/go/pprof/go_pprof_heap_detail.png"></p>
<h2 id="4-3-通过工具分析"><a href="#4-3-通过工具分析" class="headerlink" title="(4.3) 通过工具分析"></a>(4.3) 通过工具分析</h2><pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token punctuation">[</span>weikeqin<span class="token operator">@</span>computer pprof<span class="token punctuation">]</span><span class="token operator">$</span> go tool pprof <span class="token file-path string">/Users/weikeqin/pprof/go_pprof_heap.out</span>
<span class="token property">Type:</span> inuse_space
<span class="token property">Time:</span> <span class="token date number">Aug 20</span><span class="token punctuation">,</span> <span class="token number">2022</span> at <span class="token number">4</span><span class="token operator">:</span><span class="token number">29pm</span> <span class="token operator">(</span>CST<span class="token operator">)</span>
Entering interactive mode <span class="token operator">(</span>type <span class="token string">"help"</span> for commands<span class="token punctuation">,</span> <span class="token string">"o"</span> for options<span class="token operator">)</span>
<span class="token operator">(</span>pprof<span class="token operator">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token operator">(</span>pprof<span class="token operator">)</span>  svg
Generating report in <span class="token domain constant">profile001.svg</span>
<span class="token operator">(</span>pprof<span class="token operator">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>  生成svg，查看堆占用情况</p>
<h2 id="4-3-通过网页可视化分析"><a href="#4-3-通过网页可视化分析" class="headerlink" title="(4.3) 通过网页可视化分析"></a>(4.3) 通过网页可视化分析</h2><p>  通过 <code>http://127.0.0.1:6060/debug/pprof/heap?debug=0</code> 下载文件，下载的文件可以重名名</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token punctuation">[</span>weikeqin<span class="token operator">@</span>bogon <span class="token operator">~</span><span class="token punctuation">]</span><span class="token operator">$</span> go tool pprof <span class="token operator">-</span>http<span class="token operator">=</span><span class="token operator">:</span><span class="token number">8082</span> <span class="token file-path string">/Users/weikeqin/pprof/go_pprof_heap.out</span>
Serving web UI on <span class="token url">http://localhost:8082</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>  <img src="/img/go/pprof/go_pprof_heap_view.png"></p>
<p>alloc_objects— 分配的对象总数<br>alloc_space— 分配的内存总量<br>inuse_objects— 已分配但尚未释放的对象数<br>inuse_space— 已分配但尚未释放的内存量</p>
<h1 id="5-遇到的问题"><a href="#5-遇到的问题" class="headerlink" title="(5) 遇到的问题"></a>(5) 遇到的问题</h1><h2 id="5-1-Could-not-execute-dot-may-need-to-install-graphviz"><a href="#5-1-Could-not-execute-dot-may-need-to-install-graphviz" class="headerlink" title="(5.1) Could not execute dot; may need to install graphviz."></a>(5.1) Could not execute dot; may need to install graphviz.</h2><pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token punctuation">[</span>weikeqin<span class="token operator">@</span>bogon thrift<span class="token operator">-</span>tutorial<span class="token operator">-</span>go<span class="token operator">-</span>demo <span class="token operator">(</span>master<span class="token operator">)</span><span class="token punctuation">]</span><span class="token operator">$</span> go tool pprof <span class="token operator">-</span>http<span class="token operator">=</span><span class="token operator">:</span><span class="token number">8080</span> <span class="token file-path string">/Users/weikeqin/WorkSpaces/golang/go_profile.out</span> 
Serving web UI on <span class="token url">http://localhost:8080</span>
Failed to execute dot<span class="token punctuation">.</span> Is Graphviz installed<span class="token operator">?</span>
<span class="token property">exec:</span> <span class="token string">"dot"</span><span class="token operator">:</span> executable file not found in <span class="token operator">$</span>PATH
Failed to execute dot<span class="token punctuation">.</span> Is Graphviz installed<span class="token operator">?</span>
<span class="token property">exec:</span> <span class="token string">"dot"</span><span class="token operator">:</span> executable file not found in <span class="token operator">$</span>PATH
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>  到 <a target="_blank" rel="noopener" href="https://www.graphviz.org/download/">https://www.graphviz.org/download/</a> 下载 Graphviz </p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://juejin.cn/post/7002963307787190309">如何排查 Go 程序 CPU 占用过高问题</a><br>[2] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/368567370">Go 程序内存泄露问题快速定位</a><br>[3] <a target="_blank" rel="noopener" href="https://blog.wolfogre.com/posts/go-ppof-practice/">golang pprof 实战</a>  △<br>[4] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/396363069">实用go pprof使用指南</a><br>[5] <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/7_b1NnoLxyE-kp7mnfXj4w">Go 中的性能分析和执行跟踪</a>  ☆<br>[6] <a target="_blank" rel="noopener" href="https://go.dev/doc/diagnostics#profiling">go.dev-doc-diagnostics#profiling</a><br>[7] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/TimLiuDream/p/10038239.html">使用google的pprof工具以及在gin中集成pprof</a><br>[8] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/51559344">Golang性能测试工具PProf应用详解</a><br>[9] <a target="_blank" rel="noopener" href="https://medium.com/@teivah/concurrency-isnt-always-faster-in-go-de325168907c">Concurrency isn’t Always Faster in Go</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/07/30/rocksdb-index-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你要如何衡量你的人生">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 你要如何衡量你的人生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/30/rocksdb-index-model/" class="post-title-link" itemprop="url">RocksDB索引模型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-30 11:43:18" itemprop="dateCreated datePublished" datetime="2022-07-30T11:43:18+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-04-10 08:34:22" itemprop="dateModified" datetime="2023-04-10T08:34:22+08:00">2023-04-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2022/07/30/rocksdb-index-model/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/07/30/rocksdb-index-model/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-RocksDB是什么"><a href="#1-RocksDB是什么" class="headerlink" title="(1) RocksDB是什么"></a>(1) RocksDB是什么</h1><p>  RocksDB是 Facebook 开源的一个高性能持久化 KV 存储。</p>
<p>  RocksDB是一个基于LSM树的键值存储引擎，旨在提供高性能、可扩展性和可靠性。<br>  它的核心思想是将数据分为多个层级，每个层级使用不同的数据结构来存储数据。</p>
<p>  越来越多的新生代数据库，都不约而同地选择 RocksDB 作为它们的存储引擎。<br>  比如 CockroachDB 用到了 RocksDB 作为它的存储引擎;<br>  <a target="_blank" rel="noopener" href="http://myrocks.io/">MyRocks</a> 项目用 RocksDB 给 MySQL 做存储引擎，目的是取代现有的 InnoDB 存储引擎。</p>
<br>


<h1 id="2-为什么要用RocksDB"><a href="#2-为什么要用RocksDB" class="headerlink" title="(2) 为什么要用RocksDB"></a>(2) 为什么要用RocksDB</h1><p>  简单来说有3个主要原因：1:持久化  2:数据量大时用磁盘存储便宜</p>
<p>  来对比一下 RocksDB 和 Redis 这两个 KV 存储。  </p>
<p>  Redis是内存数据库，从官方给出的测试数据来看，它的随机读写性能大约在 50 万次 / 秒左右。<br>  RocksDB 数据存储在磁盘， 相应的随机读写性能大约在 20 万次 / 秒左右。</p>
<p>  虽然性能还不如 Redis，但是已经可以算是同一个量级的水平了。</p>
<p>  Redis 是一个内存数据库，并不是一个可靠的存储。数据写到内存中就算成功了，它并不保证安全地保存到磁盘上。<br>  而 RocksDB 它是一个持久化的 KV 存储，它需要保证每条数据都要安全地写到磁盘上</p>
<br>

<h1 id="3-RocksDB索引模型"><a href="#3-RocksDB索引模型" class="headerlink" title="(3) RocksDB索引模型"></a>(3) RocksDB索引模型</h1><p>  RocksDB 采用了一个非常复杂的数据存储结构，并且这个存储结构采用了内存和磁盘混合存储方式，使用磁盘来保证数据的可靠存储，并且利用速度更快的内存来提升读写性能。这种数据结构就是 <code>LSM-Tree</code> 。</p>
<h2 id="3-1-RocksDB使用的数据结构"><a href="#3-1-RocksDB使用的数据结构" class="headerlink" title="(3.1) RocksDB使用的数据结构"></a>(3.1) RocksDB使用的数据结构</h2><p>  LSM-Tree 的全称是：The Log-Structured Merge-Tree，是一种非常复杂的复合数据结构，它包含了 WAL（Write Ahead Log）、跳表（SkipList）和一个分层的有序表（SSTable，Sorted String Table）。</p>
<p>  <img src="/img/database/storage-engine/rocketsdb/sstable.png"></p>
<p>  LSM-Tree 论文  <a target="_blank" rel="noopener" href="https://ranger.uta.edu/~sjiang/pubs/papers/wang14-LSM-SDF.pdf">https://ranger.uta.edu/~sjiang/pubs/papers/wang14-LSM-SDF.pdf</a></p>
<p>  WAL 保证数据顺序写入<br>  跳表 查询性能O(log N)<br>  分层有序表 排序</p>
<p>  LSM-Tree（Log-Structured Merge Tree）是一种针对写入密集型工作负载进行优化的基于磁盘的数据结构。<br>  它由多个级别组成，每个级别都是键值对的排序运行。<br>  当执行写操作时，新的键值对将添加到内存缓冲区中。一旦缓冲区达到一定大小，它将作为新的排序运行刷新到磁盘上。<br>  当一个级别中的排序运行数量超过一定阈值时，它们将合并为下一个级别中的新的排序运行。</p>
<p>  这个合并过程是LSM-Tree的效率所在。通过合并排序运行而不是单个键值对，LSM-Tree可以减少读取特定键值对所需的磁盘寻道次数。<br>  此外，通过保持内存缓冲区相对较小，LSM-Tree可以减少维护数据结构所需的内存量。</p>
<p>  要实现LSM-Tree，可以使用SkipList数据结构作为每个级别中的排序运行。SkipList的Insert方法可用于将新的键值对添加到内存缓冲区中，FindGreaterOrEqual方法可用于在排序运行中高效地搜索特定键。合并过程可以使用Iterator对象和SkipList的Merge方法的组合来实现。</p>
<p>  总的来说，LSM-Tree是一种强大的数据结构，非常适合写入密集型工作负载。通过利用SkipList和排序运行的原理，LSM-Tree可以提供高效的写入和读取性能，同时最小化维护数据结构所需的内存量。</p>
<h2 id="3-2-新增数据"><a href="#3-2-新增数据" class="headerlink" title="(3.2) 新增数据"></a>(3.2) 新增数据</h2><p> 当 LSM-Tree 收到一个写请求，比如说：PUT foo bar，把 Key foo 的值设置为 bar。<br>  1、操作命令会被写入到磁盘的 WAL 日志中（图中右侧的 Log）。<br>  2、数据会被写入到内存中的 MemTable 中，返回写入成功。<br>  3、MemTable 写满(默认是32M)之后，就被转换成 Immutable MemTable，然后再创建一个空的 MemTable 继续写。<br>  4、后台线程不断把 Immutable MemTable 复制到磁盘文件中，然后释放内存空间。 (此时每个文件里的Key是有序的，但是文件之间是完全无序的)<br>  5、分层合并使文件有序。 (除第0层无序， 第0层是MemTable 直接 dump 出来的磁盘文件所在的那一层)</p>
<h3 id="3-2-1-WAL日志的作用"><a href="#3-2-1-WAL日志的作用" class="headerlink" title="(3.2.1) WAL日志的作用"></a>(3.2.1) WAL日志的作用</h3><p>  写WAL日志是顺序写磁盘，性能较好。<br>  WAL日志可以用于故障恢复，一旦系统宕机，可以从日志中把内存中还没有来得及写入磁盘的数据恢复出来。<br>  WAL日志解决了数据可靠性的问题。</p>
<h3 id="3-2-2-MemTable的作用"><a href="#3-2-2-MemTable的作用" class="headerlink" title="(3.2.2) MemTable的作用"></a>(3.2.2) MemTable的作用</h3><p>  MemTable 是一个按照 Key 组织的跳表（SkipList），查询复杂度是 O(log N)<br>  写 MemTable 是个内存操作，速度也非常快。</p>
<p>  跳表和平衡树有着类似的查找性能，但实现起来更简单一些。</p>
<p> 这里面有一点需要注意的是，LSM-Tree 在处理写入的过程中，直接就往 MemTable 里写，并不去查找这个 Key 是不是已经存在了。</p>
<p> 把 MemTable 写入 SSTable 这个写操作，因为它是把整块内存写入到整个文件中，这同样是一个顺序写操作。</p>
<h3 id="3-2-3-分层合并"><a href="#3-2-3-分层合并" class="headerlink" title="(3.2.3) 分层合并"></a>(3.2.3) 分层合并</h3><p>  SSTable 被分为很多层，越往上层，文件越少，越往底层，文件越多。<br>  每一层的容量都有一个固定的上限，一般来说，下一层的容量是上一层的 10 倍。<br>  当某一层写满了，就会触发后台线程往下一层合并，数据合并到下一层之后，本层的 SSTable 文件就可以删除掉了。<br>  合并的过程也是排序的过程，除 Level 0 以外，每一层内的文件都是有序的，文件内的 KV 也是有序的。</p>
<h2 id="3-3-更新数据"><a href="#3-3-更新数据" class="headerlink" title="(3.3) 更新数据"></a>(3.3) 更新数据</h2><p>  和新增数据一样</p>
<h2 id="3-4-删除数据"><a href="#3-4-删除数据" class="headerlink" title="(3.4) 删除数据"></a>(3.4) 删除数据</h2><p>  LSM-Tree 删除数据：在每条数据上增加一个删除的标志位，查询的时候判断是否已经删除，落盘的时候根据删除标志位合并数据，但是这样会浪费一些空间资源</p>
<p>  标记删除，有墓碑的概念，被删除的条目，如果在memtable里，可以直接通过墓碑标记为删除，如果不在memtable里就插入一条新的删除记录，这两种情况都会在层级合并的时候真正发挥作用，同时WAL里通过一条额外的log记录这个删除操作。</p>
<p>  另外感觉WAL里存储的其实就是操作指令流，和raft里面的日志完全一个概念，所以raft协议和leveldb/rocksdb的组合简直是绝配</p>
<h2 id="3-5-查询数据"><a href="#3-5-查询数据" class="headerlink" title="(3.5) 查询数据"></a>(3.5) 查询数据</h2><p>  查询的过程是按照顺序从一个一个table中去查询，先查内存后查磁盘<br>  Level 0 是无序的，所以一般Level只保存很少的几个文件。Level 0的查找顺序就是按照文件的创建顺序倒序查找，也就是从最新的向最旧的查找。 </p>
<h2 id="3-6-其它"><a href="#3-6-其它" class="headerlink" title="(3.6) 其它"></a>(3.6) 其它</h2><p>  在写入时，数据首先被写入内存中的MemTable，然后根据大小和数量的限制，MemTable会被转换为一个SSTable文件并写入磁盘。<br>  在读取时，RocksDB会首先在内存中的MemTable中查找数据，如果没有找到，则会在磁盘上的SSTable文件中查找。</p>
<p>  为了提高读取性能，RocksDB还使用了Bloom Filter和Skip List等数据结构来加速查找。</p>
<p>  此外，RocksDB还支持多种数据压缩算法，以减少磁盘空间的使用。</p>
<br>


<h1 id="4-RocksDB索引模型源码解读"><a href="#4-RocksDB索引模型源码解读" class="headerlink" title="(4) RocksDB索引模型源码解读"></a>(4) RocksDB索引模型源码解读</h1><h1 id="4-1-源码解析"><a href="#4-1-源码解析" class="headerlink" title="(4.1) 源码解析"></a>(4.1) 源码解析</h1><p>  源码地址: <a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb/tree/v8.0.0/memtable">https://github.com/facebook/rocksdb/tree/v8.0.0/memtable</a></p>
<p>  RocksDB索引模型主要源码<br>  Memtable结构<br>  数据结构-SkipList<br>  分层有序表</p>
<h2 id="4-2-跳表-SkipList-源码解析"><a href="#4-2-跳表-SkipList-源码解析" class="headerlink" title="(4.2) 跳表(SkipList)源码解析"></a>(4.2) 跳表(SkipList)源码解析</h2><p>  SkipList类是一个模板类，它有两个模板参数：Key和Comparator。Key参数指定键值存储中使用的键的类型，而Comparator参数指定用于比较键的比较函数。</p>
<p>  SkipList类提供了几种方法，用于在存储中插入、搜索和迭代键值对。<br>  Insert方法将新的键值对插入存储中；<br>  Contains方法检查给定的键是否存在于存储中；<br>  Iterator类提供了一种按排序顺序迭代存储中键值对的方法。</p>
<p>  SkipList类被设计为线程安全的，写操作需要外部同步，通常是互斥锁。<br>  另一方面，读操作不需要任何内部锁定或同步，但需要保证在读取过程中SkipList不会被销毁。</p>
<p>  总的来说，SkipList类提供了一个高性能、线程安全的数据结构，用于存储和检索RocksDB中的键值对。</p>
<h3 id="4-2-1-跳表结构"><a href="#4-2-1-跳表结构" class="headerlink" title="(4.2.1) 跳表结构"></a>(4.2.1) 跳表结构</h3><p>  <a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb/blob/v8.0.0/memtable/skiplist.h#L170">https://github.com/facebook/rocksdb/blob/v8.0.0/memtable/skiplist.h#L170</a></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// filepath: memtable/skiplist.h</span>

<span class="token comment">// 定义 SkipList 类，模板参数为 Key 和 Comparator</span>
template <span class="token operator">&lt;</span>typename Key<span class="token punctuation">,</span> class Comparator<span class="token operator">></span>

<span class="token comment">// 跳表结构定义</span>
class SkipList <span class="token punctuation">&#123;</span>
 private<span class="token operator">:</span>
  <span class="token comment">// 节点</span>
  <span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">;</span>
                 
 private<span class="token operator">:</span>
  <span class="token comment">// 最大高度</span>
  <span class="token keyword">const</span> <span class="token class-name">uint16_t</span> kMaxHeight_<span class="token punctuation">;</span>
  <span class="token comment">// 分支因子的默认值</span>
  <span class="token keyword">const</span> <span class="token class-name">uint16_t</span> kBranching_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> kScaledInverseBranching_<span class="token punctuation">;</span>

  <span class="token comment">// 构造函数 后 不可更改</span>
  Comparator <span class="token keyword">const</span> compare_<span class="token punctuation">;</span>
  <span class="token comment">// 用于分配节点的分配器</span>
  Allocator<span class="token operator">*</span> <span class="token keyword">const</span> allocator_<span class="token punctuation">;</span> 

  <span class="token comment">// 头节点</span>
  Node<span class="token operator">*</span> <span class="token keyword">const</span> head_<span class="token punctuation">;</span>

  <span class="token comment">// 跳表的高度</span>
  <span class="token comment">// 只能被 Insert() 修改，可以被读取器读取，但是过时的值是可以接受的</span>
  std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> max_height_<span class="token punctuation">;</span>  

  <span class="token comment">// 用于优化顺序插入模式，比较棘手</span>
  <span class="token comment">// prev_[i] 对于 i 小于等于 max_height_ 是 prev_[0] 的前驱节点，prev_height_ 是 prev_[0] 的高度</span>
  <span class="token comment">// 在插入之前，prev_[0] 只能等于 head_，此时 max_height_ 和 prev_height_ 都为 1</span>
  Node<span class="token operator">*</span><span class="token operator">*</span> prev_<span class="token punctuation">;</span>
  <span class="token class-name">int32_t</span> prev_height_<span class="token punctuation">;</span>

 public<span class="token operator">:</span>
  <span class="token comment">// 构造函数，接受比较器和分配器，以及最大高度和分支因子的默认值</span>
  explicit <span class="token function">SkipList</span><span class="token punctuation">(</span>Comparator cmp<span class="token punctuation">,</span> Allocator<span class="token operator">*</span> allocator<span class="token punctuation">,</span>
                    <span class="token class-name">int32_t</span> max_height <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token class-name">int32_t</span> branching_factor <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4-2-2-跳表节点"><a href="#4-2-2-跳表节点" class="headerlink" title="(4.2.2) 跳表节点"></a>(4.2.2) 跳表节点</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// filepath: memtable/skiplist.h</span>

<span class="token comment">// 跳表节点</span>
template <span class="token operator">&lt;</span>typename Key<span class="token punctuation">,</span> class Comparator<span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">SkipList</span><span class="token operator">&lt;</span>Key<span class="token punctuation">,</span> Comparator<span class="token operator">></span><span class="token operator">::</span>Node <span class="token punctuation">&#123;</span>
  explicit <span class="token function">Node</span><span class="token punctuation">(</span><span class="token keyword">const</span> Key<span class="token operator">&amp;</span> k<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">key</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

  <span class="token comment">// 节点的key</span>
  Key <span class="token keyword">const</span> key<span class="token punctuation">;</span>

 private<span class="token operator">:</span>
  <span class="token comment">// 下一个节点(们)  每层指向的下一个节点不一样</span>
  <span class="token comment">// 类似链表的next节点 只不过有多层/多个</span>
  <span class="token comment">// std::atomic 是原子类型对象，是为了解决并发编程中的线程安全提供的api，类似Java里的</span>
  std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>Node<span class="token operator">*</span><span class="token operator">></span> next_<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="4-3-Memtable结构"><a href="#4-3-Memtable结构" class="headerlink" title="(4.3) Memtable结构"></a>(4.3) Memtable结构</h2><p>  MemTable是一个内存中的数据结构，用于存储最近写入的键值对。当MemTable达到一定大小时，它将被转换为SSTable并写入磁盘。SSTable是一种静态的、只读的数据结构，它被用作RocksDB的持久化存储。</p>
<p>  Rocksdb 支持创建多数据结构类型的 Memtable，默认的是 SkipList，即跳跃表。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/225400">后端存储实战课 - 24 | RocksDB：不丢数据的高性能KV存储</a><br>[2] <a target="_blank" rel="noopener" href="https://ranger.uta.edu/~sjiang/pubs/papers/wang14-LSM-SDF.pdf">An Efficient Design and Implementation of LSM-Tree based Key-Value Store on Open-Channel SSD</a><br>[3] <a target="_blank" rel="noopener" href="https://xie.infoq.cn/article/8836cabe7d5959b95a7cebe93">技术贴 | Rocksdb 中 Memtable 源码解析</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/07/16/thrift-processor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你要如何衡量你的人生">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 你要如何衡量你的人生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/16/thrift-processor/" class="post-title-link" itemprop="url">thrift TProcessor</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-16 20:20:35" itemprop="dateCreated datePublished" datetime="2022-07-16T20:20:35+08:00">2022-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-18 21:14:53" itemprop="dateModified" datetime="2022-09-18T21:14:53+08:00">2022-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2022/07/16/thrift-processor/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/07/16/thrift-processor/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  大家有没有想过，调用方调用一个方法，服务端是怎么找到对应方法并处理的？</p>
<p>  很多RPC里是通过反射实现的，但是thrift里通过多态去实现的。  </p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/07/16/thrift-processor/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/07/10/thrift-server/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你要如何衡量你的人生">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 你要如何衡量你的人生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/10/thrift-server/" class="post-title-link" itemprop="url">thrift Server</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-10 20:20:46" itemprop="dateCreated datePublished" datetime="2022-07-10T20:20:46+08:00">2022-07-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-27 23:54:40" itemprop="dateModified" datetime="2022-11-27T23:54:40+08:00">2022-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2022/07/10/thrift-server/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/07/10/thrift-server/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>45k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>41 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-thrift-Server-作用"><a href="#1-thrift-Server-作用" class="headerlink" title="(1) thrift Server 作用"></a>(1) thrift Server 作用</h1><p>Server将 thrift 所有功能整合到一起：</p>
<blockquote>
<p>1、创建一个 Transport；<br>2、创建 Transport 使用的 I/O Protocol；<br>3、为 I/O Protocol 创建 Processor；<br>4、启动服务，等待客户端的连接；</p>
</blockquote>
<p>thrift不同语言实现提供的服务器端的模式不一样 </p>
<p>  thrift Java版本为服务器端提供了多种模式： TSimpleServer 、 TThreadPoolServer 、 TNonblockingServer 、 THsHaServer 、 TThreadedSelectorServer </p>
<p>  Thrift Go版本为服务器端提供了 TSimpleServer </p>
<table>
<thead>
<tr>
<th>IO模型</th>
<th>Java</th>
<th>Go</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>阻塞IO</td>
<td>TSimpleServer</td>
<td>-</td>
<td>只有一个工作线程，循环监听新请求的到来并完成对请求的处理，一次只能接收和处理一个socket连接，效率比较低。</td>
</tr>
<tr>
<td>阻塞IO</td>
<td>TThreadPoolServer</td>
<td>TSimpleServer</td>
<td></td>
</tr>
<tr>
<td>IO多路复用</td>
<td>TNonblockingServer</td>
<td>-</td>
<td>TNonblockingServer 单线程工作，采用NIO的方式，所有的socket都被注册到selector中</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/07/10/thrift-server/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/07/10/thrift-client/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你要如何衡量你的人生">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 你要如何衡量你的人生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/10/thrift-client/" class="post-title-link" itemprop="url">thrift客户端</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-10 15:56:59" itemprop="dateCreated datePublished" datetime="2022-07-10T15:56:59+08:00">2022-07-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-27 23:54:40" itemprop="dateModified" datetime="2022-11-27T23:54:40+08:00">2022-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2022/07/10/thrift-client/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/07/10/thrift-client/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-设计"><a href="#1-设计" class="headerlink" title="(1) 设计"></a>(1) 设计</h1><p>  TClient ，<br>  TStandardClient、WrappedTClient 实现了<code>TClient</code>接口的<code>Call</code>方法 </p>
<p> <img src=""></p>
<h1 id="2-demo"><a href="#2-demo" class="headerlink" title="(2) demo"></a>(2) demo</h1><p>  <a target="_blank" rel="noopener" href="https://github.com/weikeqin/thrift-tutorial-go-demo">https://github.com/weikeqin/thrift-tutorial-go-demo</a> </p>
<p>  以client调用add方法为例</p>
<p>  调用下游Add()方法代码 </p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 创建thrift client</span>
	thriftClient <span class="token operator">:=</span> <span class="token function">getThriftClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 创建 calculatorClientProxy   其实是一个代理类(静态代理) 代理了idl定义的所有方法</span>
	<span class="token comment">// tutorial是由idl生成的</span>
	calculatorClientProxy <span class="token operator">:=</span> tutorial<span class="token punctuation">.</span><span class="token function">NewCalculatorClient</span><span class="token punctuation">(</span>thriftClient<span class="token punctuation">)</span>
	<span class="token comment">// 调用Add方法</span>
	sum<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> calculatorClientProxy<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>defaultCtx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"1+2="</span><span class="token punctuation">,</span> sum<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/07/10/thrift-client/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/07/02/thrift-transport/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你要如何衡量你的人生">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 你要如何衡量你的人生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/02/thrift-transport/" class="post-title-link" itemprop="url">thrift 传输方式(Transport)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-02 15:19:24" itemprop="dateCreated datePublished" datetime="2022-07-02T15:19:24+08:00">2022-07-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-07-17 23:23:54" itemprop="dateModified" datetime="2022-07-17T23:23:54+08:00">2022-07-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2022/07/02/thrift-transport/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/07/02/thrift-transport/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-传输方式-Transport-作用"><a href="#1-传输方式-Transport-作用" class="headerlink" title="(1) 传输方式(Transport)作用"></a>(1) 传输方式(Transport)作用</h1><p>  传输方式(Transport)作为rpc框架接收报文的入口，提供各种底层实现如socket创建、读写、接收连接等。<br>  同时实现各种复写传输层包括http、framed、buffered、压缩传输等。</p>
<h2 id="1-1-支持的传输方式"><a href="#1-1-支持的传输方式" class="headerlink" title="(1.1) 支持的传输方式"></a>(1.1) 支持的传输方式</h2><p>  thrift支持多种传输方式 </p>
<table>
<thead>
<tr>
<th>传输方式</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>TSocket</td>
<td>阻塞型 socket，用于客户端，采用系统函数 read 和 write 进行读写数据。</td>
</tr>
<tr>
<td>TServerSocket</td>
<td>非阻塞型 socket，用于服务器端，accecpt 到的 socket 类型都是 TSocket（即阻塞型 socket）。</td>
</tr>
<tr>
<td>TBufferedTransport</td>
<td></td>
</tr>
<tr>
<td>TFramedTransport</td>
<td></td>
</tr>
<tr>
<td>TMemoryBuffer</td>
<td></td>
</tr>
<tr>
<td>TFileTransport</td>
<td></td>
</tr>
<tr>
<td>TFDTransport</td>
<td></td>
</tr>
<tr>
<td>TSimpleFileTransport</td>
<td></td>
</tr>
<tr>
<td>TZlibTransport</td>
<td></td>
</tr>
<tr>
<td>TSSLSocket</td>
<td></td>
</tr>
<tr>
<td>TSSLServerSocket</td>
<td></td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/07/02/thrift-transport/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/06/26/thrift-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你要如何衡量你的人生">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 你要如何衡量你的人生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/26/thrift-design/" class="post-title-link" itemprop="url">thrift架构设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-26 19:01:13" itemprop="dateCreated datePublished" datetime="2022-06-26T19:01:13+08:00">2022-06-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-07-30 23:44:12" itemprop="dateModified" datetime="2022-07-30T23:44:12+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2022/06/26/thrift-design/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/06/26/thrift-design/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  Thrift是一个轻量、支持多语言、可扩展、高性能的远程服务调用框架。<br>  提供了数据传输、序列化、应用层处理的清晰抽象。</p>
<p>The Apache Thrift software framework, for scalable cross-language services development, combines a software stack with a code generation engine to build services that work efficiently and seamlessly between C++, Java, Python, PHP, Ruby, Erlang, Perl, Haskell, C#, Cocoa, JavaScript, Node.js, Smalltalk, OCaml and Delphi and other languages.</p>
<h1 id="1-thrift架构分层"><a href="#1-thrift架构分层" class="headerlink" title="(1) thrift架构分层"></a>(1) thrift架构分层</h1><p>  <img src="/img/rpc/thrift/thrift-layers.png" alt="thrift-layers"></p>
<table>
<thead>
<tr>
<th>分层</th>
<th>职责</th>
</tr>
</thead>
<tbody><tr>
<td>服务调用层 (客户端/服务端)</td>
<td>客户端、服务端调用。</td>
</tr>
<tr>
<td>协议层</td>
<td>消息解析</td>
</tr>
<tr>
<td>传输层包装</td>
<td>功能增强，实现各种复写传输层包括http、framed、buffered、压缩传输等</td>
</tr>
<tr>
<td>低级传输层</td>
<td>靠近网络层、作为rpc框架接收报文的入口，提供各种底层实现如socket创建、读写、接收连接等。</td>
</tr>
<tr>
<td>语言层</td>
<td>thrift采用接口描述语言定义并创建服务，支持可扩展的跨语言服务开发</td>
</tr>
<tr>
<td>操作系统层</td>
<td>由编程语言提供各种操作系统的支持</td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/06/26/thrift-design/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/06/26/thrift-protocol/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你要如何衡量你的人生">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 你要如何衡量你的人生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/26/thrift-protocol/" class="post-title-link" itemprop="url">thrift 协议(TProtocol)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-26 17:07:14" itemprop="dateCreated datePublished" datetime="2022-06-26T17:07:14+08:00">2022-06-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-01-14 22:32:20" itemprop="dateModified" datetime="2023-01-14T22:32:20+08:00">2023-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2022/06/26/thrift-protocol/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/06/26/thrift-protocol/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>24 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>　协议大家平时都会遇到，只是没有特别注意。<br>　像平时大家阅读文章的时候都是从上到下、从左往右 按行阅读，这可以看做一种阅读协议。 ( 备注: 古人在竹简上写的文字则是从上往下、从右往左 按列阅读。)<br>　更详细的规则比如：作文的第一行是标题，段首要空两格的是一个自然段，遇到一个句号是一句话。</p>
<p>  详细的标点符号用法(通信协议)参考教育部的规范  <a target="_blank" rel="noopener" href="http://www.moe.gov.cn/ewebeditor/uploadfile/2015/01/13/20150113091548267.pdf">标点符号用法 - 教育部</a></p>
<p>  在计算机远程方法调用时，传输的都是二进制的01，调用方(写数据)和被调用方(读数据)怎么约定通信协议的？</p>
<h1 id="1-协议-TProtocol-的作用"><a href="#1-协议-TProtocol-的作用" class="headerlink" title="(1) 协议(TProtocol)的作用"></a>(1) 协议(TProtocol)的作用</h1><p>  协议的作用就类似于文字中的符号，作为应用拆解请求消息的边界，保证二进制数据经过网络传输后，还能被正确地还原语义。</p>
<p>  <img src="/img/rpc/protocol/rpc-protocol-v2.png"></p>
<p>  具体点就是从二进制数据中解析出<code>协议版本</code>、<code>方法名</code>、<code>消息类型</code>、<code>序列Id</code>、<code>序列化方式</code>、<code>消息长度</code>、<code>协议体</code>等内容。</p>
<p>  <img src="/img/rpc/thrift/protocol/thrift-protocol-message.png" alt="thrift-protocol-message"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/06/26/thrift-protocol/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/05/01/kafka-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你要如何衡量你的人生">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 你要如何衡量你的人生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/01/kafka-design/" class="post-title-link" itemprop="url">Kafka架构设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-01 11:14:43" itemprop="dateCreated datePublished" datetime="2022-05-01T11:14:43+08:00">2022-05-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-26 16:08:56" itemprop="dateModified" datetime="2022-11-26T16:08:56+08:00">2022-11-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/basic/" itemprop="url" rel="index"><span itemprop="name">basic</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2022/05/01/kafka-design/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/05/01/kafka-design/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>344</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  Kafka是一个消息队列。被大家用在分布式消息队列或者流数据处理场景。<br>  有几个问题，大家不知道思考过没有？<br>  1、Kafka有哪些组件，作用分别是什么，为什么这么设计？<br>  2、Kafka是怎么保证高性能、高并发、高可用的呢？</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/05/01/kafka-design/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">WKQ</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://fantastic-paletas-170a7a.netlify.app/.netlify/functions/comment","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎评论","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":false,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/page/4/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
