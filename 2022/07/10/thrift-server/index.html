<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"weikeqin.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="(1) thrift Server 作用Server将 thrift 所有功能整合到一起：  1、创建一个 Transport；2、创建 Transport 使用的 I&#x2F;O Protocol；3、为 I&#x2F;O Protocol 创建 Processor；4、启动服务，等待客户端的连接；  thrift不同语言实现提供的服务器端的模式不一样    thrift Java版本为服务器端提供了多种模式：">
<meta property="og:type" content="article">
<meta property="og:title" content="thrift Server">
<meta property="og:url" content="http://weikeqin.com/2022/07/10/thrift-server/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="(1) thrift Server 作用Server将 thrift 所有功能整合到一起：  1、创建一个 Transport；2、创建 Transport 使用的 I&#x2F;O Protocol；3、为 I&#x2F;O Protocol 创建 Processor；4、启动服务，等待客户端的连接；  thrift不同语言实现提供的服务器端的模式不一样    thrift Java版本为服务器端提供了多种模式：">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-10T12:20:46.000Z">
<meta property="article:modified_time" content="2022-11-27T15:54:40.988Z">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="java">
<meta property="article:tag" content="go">
<meta property="article:tag" content="thrift">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://weikeqin.com/2022/07/10/thrift-server/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://weikeqin.com/2022/07/10/thrift-server/","path":"2022/07/10/thrift-server/","title":"thrift Server"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>thrift Server | 天道酬勤</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113485469-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-113485469-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">天道酬勤</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-thrift-Server-%E4%BD%9C%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">(1) thrift Server 作用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Server%E5%90%AF%E5%8A%A8%E5%8F%8A%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">(2) Server启动及处理请求流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Demo-Go"><span class="nav-number">3.</span> <span class="nav-text">(3) Demo-Go</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-go"><span class="nav-number">4.</span> <span class="nav-text">(4) 源码分析-go</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-TSimpleServer"><span class="nav-number">4.1.</span> <span class="nav-text">(4.1) TSimpleServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-Serve"><span class="nav-number">4.1.1.</span> <span class="nav-text">(4.1.1) Serve</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-Listen"><span class="nav-number">4.1.2.</span> <span class="nav-text">(4.1.2) Listen()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-3-AcceptLoop"><span class="nav-number">4.1.3.</span> <span class="nav-text">(4.1.3) AcceptLoop()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-4-innerAccept"><span class="nav-number">4.1.4.</span> <span class="nav-text">(4.1.4) innerAccept</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-5-processRequests"><span class="nav-number">4.1.5.</span> <span class="nav-text">(4.1.5) processRequests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TServerTransport"><span class="nav-number">4.1.6.</span> <span class="nav-text">TServerTransport</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-Demo-Java"><span class="nav-number">5.</span> <span class="nav-text">(5) Demo-Java</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90Java"><span class="nav-number">6.</span> <span class="nav-text">(6) 源码解析Java</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-TServer"><span class="nav-number">6.1.</span> <span class="nav-text">(6.1) TServer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-TSimpleServer"><span class="nav-number">6.2.</span> <span class="nav-text">(6.2) TSimpleServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-1-serve"><span class="nav-number">6.2.1.</span> <span class="nav-text">(6.2.1) serve</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-TThreadPoolServer"><span class="nav-number">6.3.</span> <span class="nav-text">(6.3) TThreadPoolServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-1-serve"><span class="nav-number">6.3.1.</span> <span class="nav-text">(6.3.1) serve()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-AbstractNonblockingServer"><span class="nav-number">6.4.</span> <span class="nav-text">(6.4) AbstractNonblockingServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-1-serve"><span class="nav-number">6.4.1.</span> <span class="nav-text">(6.4.1) serve()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5-TNonblockingServer"><span class="nav-number">6.5.</span> <span class="nav-text">(6.5) TNonblockingServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-1-startThreads"><span class="nav-number">6.5.1.</span> <span class="nav-text">(6.5.1) startThreads()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-2-SelectAcceptThread-%E9%87%8D%E7%82%B9"><span class="nav-number">6.5.2.</span> <span class="nav-text">(6.5.2) SelectAcceptThread 重点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#run"><span class="nav-number">6.5.2.1.</span> <span class="nav-text">run()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#select"><span class="nav-number">6.5.2.2.</span> <span class="nav-text">select()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handleAccept"><span class="nav-number">6.5.2.3.</span> <span class="nav-text">handleAccept()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-2-AbstractNonblockingServer"><span class="nav-number">6.5.3.</span> <span class="nav-text">(6.5.2) AbstractNonblockingServer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#handleRead-key"><span class="nav-number">6.5.3.1.</span> <span class="nav-text">handleRead(key)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handleWrite-key"><span class="nav-number">6.5.3.2.</span> <span class="nav-text">handleWrite(key)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#waitForShutdown"><span class="nav-number">6.5.4.</span> <span class="nav-text">waitForShutdown()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stop"><span class="nav-number">6.5.5.</span> <span class="nav-text">stop()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-6-THsHaServer"><span class="nav-number">6.6.</span> <span class="nav-text">(6.6) THsHaServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-1-createInvokerPool"><span class="nav-number">6.6.1.</span> <span class="nav-text">(6.6.1) createInvokerPool()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-2-requestInvoke"><span class="nav-number">6.6.2.</span> <span class="nav-text">(6.6.2) requestInvoke()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-3-waitForShutdown"><span class="nav-number">6.6.3.</span> <span class="nav-text">(6.6.3) waitForShutdown()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-7-TThreadedSelectorServer"><span class="nav-number">6.7.</span> <span class="nav-text">(6.7) TThreadedSelectorServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-7-1-startThreads"><span class="nav-number">6.7.1.</span> <span class="nav-text">(6.7.1) startThreads()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-7-2-SelectorThread"><span class="nav-number">6.7.2.</span> <span class="nav-text">(6.7.2) SelectorThread</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SelectorThread-run"><span class="nav-number">6.7.2.1.</span> <span class="nav-text">SelectorThread::run()</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SelectorThread-select"><span class="nav-number">6.7.2.1.1.</span> <span class="nav-text">SelectorThread::select()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#processAcceptedConnections"><span class="nav-number">6.7.2.1.2.</span> <span class="nav-text">processAcceptedConnections()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#processInterestChanges"><span class="nav-number">6.7.2.1.3.</span> <span class="nav-text">processInterestChanges();</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AcceptThread"><span class="nav-number">6.7.3.</span> <span class="nav-text">AcceptThread</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AcceptThread-run"><span class="nav-number">6.7.3.1.</span> <span class="nav-text">AcceptThread::run()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AcceptThread-select"><span class="nav-number">6.7.3.2.</span> <span class="nav-text">AcceptThread::select()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#requestInvoke"><span class="nav-number">6.7.4.</span> <span class="nav-text">requestInvoke()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#waitForShutdown-1"><span class="nav-number">6.7.5.</span> <span class="nav-text">waitForShutdown()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stop-1"><span class="nav-number">6.7.6.</span> <span class="nav-text">stop()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">7.</span> <span class="nav-text">问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-read-tcp-i-o-timeout"><span class="nav-number">7.1.</span> <span class="nav-text">(1) read tcp i&#x2F;o timeout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#write-broken-pipe"><span class="nav-number">7.2.</span> <span class="nav-text">write: broken pipe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Incorrect-frame-size"><span class="nav-number">7.3.</span> <span class="nav-text">Incorrect frame size</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#connection-reset-by-peer"><span class="nav-number">7.4.</span> <span class="nav-text">connection reset by peer</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">8.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">277</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/u/0/107737814703120725006" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;u&#x2F;0&#x2F;107737814703120725006" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wkq278276130" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wkq278276130" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/keqin.wei.5" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;keqin.wei.5" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/8054088/wkq" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;8054088&#x2F;wkq" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2022/07/10/thrift-server/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="thrift Server | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          thrift Server
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-10 20:20:46" itemprop="dateCreated datePublished" datetime="2022-07-10T20:20:46+08:00">2022-07-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-27 23:54:40" itemprop="dateModified" datetime="2022-11-27T23:54:40+08:00">2022-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/rpc/" itemprop="url" rel="index"><span itemprop="name">rpc</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>45k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>41 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="1-thrift-Server-作用"><a href="#1-thrift-Server-作用" class="headerlink" title="(1) thrift Server 作用"></a>(1) thrift Server 作用</h1><p>Server将 thrift 所有功能整合到一起：</p>
<blockquote>
<p>1、创建一个 Transport；<br>2、创建 Transport 使用的 I/O Protocol；<br>3、为 I/O Protocol 创建 Processor；<br>4、启动服务，等待客户端的连接；</p>
</blockquote>
<p>thrift不同语言实现提供的服务器端的模式不一样 </p>
<p>  thrift Java版本为服务器端提供了多种模式： TSimpleServer 、 TThreadPoolServer 、 TNonblockingServer 、 THsHaServer 、 TThreadedSelectorServer </p>
<p>  Thrift Go版本为服务器端提供了 TSimpleServer </p>
<table>
<thead>
<tr>
<th>IO模型</th>
<th>Java</th>
<th>Go</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>阻塞IO</td>
<td>TSimpleServer</td>
<td>-</td>
<td>只有一个工作线程，循环监听新请求的到来并完成对请求的处理，一次只能接收和处理一个socket连接，效率比较低。</td>
</tr>
<tr>
<td>阻塞IO</td>
<td>TThreadPoolServer</td>
<td>TSimpleServer</td>
<td></td>
</tr>
<tr>
<td>IO多路复用</td>
<td>TNonblockingServer</td>
<td>-</td>
<td>TNonblockingServer 单线程工作，采用NIO的方式，所有的socket都被注册到selector中</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<span id="more"></span>

<p>从是否为阻塞IO角度划分为：阻塞服务模型、非阻塞服务模型。<br>阻塞服务模型：TSimpleServer、TThreadPoolServer。<br>非阻塞服务模型：TNonblockingServer、THsHaServer 和 TThreadedSelectorServer。</p>
<p>从网络服务模型角度划分为：单线程/协程、多线程/协程、事件驱动</p>
<h1 id="2-Server启动及处理请求流程"><a href="#2-Server启动及处理请求流程" class="headerlink" title="(2) Server启动及处理请求流程"></a>(2) Server启动及处理请求流程</h1><ol>
<li>Server初始化<br>1.1 创建 ServerHandler  对应 calculatorHandler<br>1.2 为 ServerHandler 添加(注册) processor， 这些processor都实现了 <code>thrift.TProcessorFunction</code> 接口<br>1.3 创建 ServerTransport (Server的主要实现)<br>1.4 根据 协议工厂(protocolFactory)、传输方式工厂(transportFactory)、服务传输方式(ServerTransport)、服务类(ServerHandler) 创建Server </li>
<li>Server启动<br> 2.1 启动server 监听配置地址端口，<br> 2.2<br> 2.3 并循环处理请求 </li>
<li>Server处理请求<br> 3.1 获取对应的processor 从ServerHandler注册的</li>
<li>Server关闭</li>
</ol>
<h1 id="3-Demo-Go"><a href="#3-Demo-Go" class="headerlink" title="(3) Demo-Go"></a>(3) Demo-Go</h1><p>  源码  <a target="_blank" rel="noopener" href="https://github.com/weikeqin/thrift-tutorial-go-demo">https://github.com/weikeqin/thrift-tutorial-go-demo</a> </p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	
	addr <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"addr"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9090"</span><span class="token punctuation">,</span> <span class="token string">"Address to listen to"</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> protocolFactory thrift<span class="token punctuation">.</span>TProtocolFactory
	<span class="token keyword">var</span> transportFactory thrift<span class="token punctuation">.</span>TTransportFactory
	<span class="token keyword">var</span> transport thrift<span class="token punctuation">.</span>TServerTransport
	<span class="token comment">// 省略部分代码</span>

	<span class="token comment">// CalculatorHandler 实现了 Calculator 接口</span>
	calculatorHandler <span class="token operator">:=</span> <span class="token function">NewCalculatorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// CalculatorProcessor 实现了 TProcessor 接口</span>
	calculatorProcessor <span class="token operator">:=</span> tutorial<span class="token punctuation">.</span><span class="token function">NewCalculatorProcessor</span><span class="token punctuation">(</span>calculatorHandler<span class="token punctuation">)</span>
	<span class="token comment">// 创建 TSimpleServer</span>
	server <span class="token operator">:=</span> thrift<span class="token punctuation">.</span><span class="token function">NewTSimpleServer4</span><span class="token punctuation">(</span>calculatorProcessor<span class="token punctuation">,</span> transport<span class="token punctuation">,</span> transportFactory<span class="token punctuation">,</span> protocolFactory<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Starting the simple server... on "</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token comment">// 启动server</span>
	err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"server start"</span><span class="token punctuation">)</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h1 id="4-源码分析-go"><a href="#4-源码分析-go" class="headerlink" title="(4) 源码分析-go"></a>(4) 源码分析-go</h1><h2 id="4-1-TSimpleServer"><a href="#4-1-TSimpleServer" class="headerlink" title="(4.1) TSimpleServer"></a>(4.1) TSimpleServer</h2><p>  首先看一下 TSimpleServer 的结构，里面标识了 服务状态、服务任务等待组、互斥锁、处理类的工厂、服务通信方式、输入通信方式工厂 </p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">/*
 * 这不是典型的TSimpleServer，因为它在接受套接字后不会被阻塞。
 * 它更像是一个TThreadedServer，可以在不同的goroutine中处理不同的连接。
 * 如果golang用户在客户端实现了一个类似conn池的东西，这将起作用。
 * 
 * This is not a typical TSimpleServer as it is not blocked after accept a socket.
 * It is more like a TThreadedServer that can handle different connections in different goroutines.
 * This will work if golang user implements a conn-pool like thing in client side.
 */</span>
<span class="token keyword">type</span> TSimpleServer <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	closed <span class="token builtin">int32</span>            <span class="token comment">// 关闭</span>
	wg     sync<span class="token punctuation">.</span>WaitGroup   <span class="token comment">// 等待任务组</span>
	mu     sync<span class="token punctuation">.</span>Mutex       <span class="token comment">// 互斥锁</span>

	processorFactory       TProcessorFactory  <span class="token comment">// 处理器工厂</span>
	serverTransport        TServerTransport   <span class="token comment">// 服务通信   server具体实现</span>
	inputTransportFactory  TTransportFactory  <span class="token comment">// 传输层输入工厂</span>
	outputTransportFactory TTransportFactory  <span class="token comment">// 传输层输出工厂</span>
	inputProtocolFactory   TProtocolFactory   <span class="token comment">// 协议层输入工厂</span>
	outputProtocolFactory  TProtocolFactory   <span class="token comment">// 协议层输出工厂</span>

	<span class="token comment">// Headers to auto forward in THeaderProtocol</span>
	forwardHeaders <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

	logger Logger
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-1-1-Serve"><a href="#4-1-1-Serve" class="headerlink" title="(4.1.1) Serve"></a>(4.1.1) Serve</h3><p>  Serve是启动服务的方法，主要做了2件事<br>1、监听指定地址及端口。<br>2、开始accept阻塞，循环 接收并处理客户端的请求。</p>
<p> <img src="" alt="go-TSimpleServer-流程图"></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// </span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TSimpleServer<span class="token punctuation">)</span> <span class="token function">Serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	p<span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token function">fallbackLogger</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>logger<span class="token punctuation">)</span>

    <span class="token comment">// 开启监听</span>
	err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 阻塞，循环接收并处理客户端的请求</span>
	p<span class="token punctuation">.</span><span class="token function">AcceptLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-1-2-Listen"><a href="#4-1-2-Listen" class="headerlink" title="(4.1.2) Listen()"></a>(4.1.2) Listen()</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 监听</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TSimpleServer<span class="token punctuation">)</span> <span class="token function">Listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> p<span class="token punctuation">.</span>serverTransport<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4-1-3-AcceptLoop"><a href="#4-1-3-AcceptLoop" class="headerlink" title="(4.1.3) AcceptLoop()"></a>(4.1.3) AcceptLoop()</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 循环接收请求</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TSimpleServer<span class="token punctuation">)</span> <span class="token function">AcceptLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 内部接受 </span>
        closed<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">innerAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 这块出错只能是serverTransport接收请求出错</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 出错，跳出循环，返回</span>
			<span class="token keyword">return</span> err
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// closed=0是服务器开启状态  </span>
		<span class="token keyword">if</span> closed <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 服务关闭，跳出循环，返回</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-1-4-innerAccept"><a href="#4-1-4-innerAccept" class="headerlink" title="(4.1.4) innerAccept"></a>(4.1.4) innerAccept</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TSimpleServer<span class="token punctuation">)</span> <span class="token function">innerAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int32</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 接收请求   没有请求会被阻塞到这儿</span>
  client<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>serverTransport<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 加互斥锁 保证处理请求并发安全</span>
	p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取closed的值 </span>
  closed <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>closed<span class="token punctuation">)</span>
  <span class="token comment">// 检查服务是否关闭 closed=1是服务关闭</span>
	<span class="token keyword">if</span> closed <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> closed<span class="token punctuation">,</span> <span class="token boolean">nil</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 从serverTransport接收请求是否异常</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// client是传输方式 </span>
	<span class="token keyword">if</span> client <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// 开一个goroutine单独处理</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">defer</span> p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 处理请求</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">processRequests</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span><span class="token function">logger</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"error processing request: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="4-1-5-processRequests"><a href="#4-1-5-processRequests" class="headerlink" title="(4.1.5) processRequests"></a>(4.1.5) processRequests</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 处理请求 </span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TSimpleServer<span class="token punctuation">)</span> <span class="token function">processRequests</span><span class="token punctuation">(</span>client TTransport<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		err <span class="token operator">=</span> <span class="token function">treatEOFErrorsAsNil</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 获取处理器 </span>
	<span class="token comment">// 这里获取到的是*tutorial.CalculatorProcessor</span>
	processor <span class="token operator">:=</span> p<span class="token punctuation">.</span>processorFactory<span class="token punctuation">.</span><span class="token function">GetProcessor</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	<span class="token comment">// 获取传输层输入</span>
	inputTransport<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>inputTransportFactory<span class="token punctuation">.</span><span class="token function">GetTransport</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// 协议层输入</span>
	inputProtocol <span class="token operator">:=</span> p<span class="token punctuation">.</span>inputProtocolFactory<span class="token punctuation">.</span><span class="token function">GetProtocol</span><span class="token punctuation">(</span>inputTransport<span class="token punctuation">)</span>
	<span class="token keyword">var</span> outputTransport TTransport
	<span class="token keyword">var</span> outputProtocol TProtocol

	<span class="token comment">// for THeaderProtocol, we must use the same protocol instance for</span>
	<span class="token comment">// input and output so that the response is in the same dialect that</span>
	<span class="token comment">// the server detected the request was in.</span>
	headerProtocol<span class="token punctuation">,</span> ok <span class="token operator">:=</span> inputProtocol<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>THeaderProtocol<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ok <span class="token punctuation">&#123;</span>
		outputProtocol <span class="token operator">=</span> inputProtocol
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 传输层输出</span>
		oTrans<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>outputTransportFactory<span class="token punctuation">.</span><span class="token function">GetTransport</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		outputTransport <span class="token operator">=</span> oTrans
		<span class="token comment">// 协议层输出</span>
		outputProtocol <span class="token operator">=</span> p<span class="token punctuation">.</span>outputProtocolFactory<span class="token punctuation">.</span><span class="token function">GetProtocol</span><span class="token punctuation">(</span>outputTransport<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> inputTransport <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">defer</span> inputTransport<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> outputTransport <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">defer</span> outputTransport<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>

		ctx <span class="token operator">:=</span> <span class="token function">SetResponseHelper</span><span class="token punctuation">(</span>
			defaultCtx<span class="token punctuation">,</span>
			TResponseHelper<span class="token punctuation">&#123;</span>
				THeaderResponseHelper<span class="token punctuation">:</span> <span class="token function">NewTHeaderResponseHelper</span><span class="token punctuation">(</span>outputProtocol<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
		<span class="token keyword">if</span> headerProtocol <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// We need to call ReadFrame here, otherwise we won't</span>
			<span class="token comment">// get any headers on the AddReadTHeaderToContext call.</span>
			<span class="token comment">//</span>
			<span class="token comment">// ReadFrame is safe to be called multiple times so it</span>
			<span class="token comment">// won't break when it's called again later when we</span>
			<span class="token comment">// actually start to read the message.</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> headerProtocol<span class="token punctuation">.</span><span class="token function">ReadFrame</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">&#125;</span>
			ctx <span class="token operator">=</span> <span class="token function">AddReadTHeaderToContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> headerProtocol<span class="token punctuation">.</span><span class="token function">GetReadHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			ctx <span class="token operator">=</span> <span class="token function">SetWriteHeaderList</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> p<span class="token punctuation">.</span>forwardHeaders<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		<span class="token comment">// 调用对应处理方法处理请求 </span>
		<span class="token comment">// 返回数据会写入到 outputProtocol的TTransport里</span>
		ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> processor<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> inputProtocol<span class="token punctuation">,</span> outputProtocol<span class="token punctuation">)</span>
		<span class="token comment">// 主动断开</span>
		<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> ErrAbandonRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
			<span class="token comment">// 通信异常</span>
		<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token function">new</span><span class="token punctuation">(</span>TTransportException<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// 经常遇到的错误 read: connection reset by peer 就是这儿返回的 </span>
			<span class="token comment">// read tcp 127.0.0.1:9090->127.0.0.1:58470: read: connection reset by peer</span>
			<span class="token comment">// 还有 EOF </span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">var</span> tae TApplicationException
		<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tae<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> tae<span class="token punctuation">.</span><span class="token function">TypeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> UNKNOWN_METHOD <span class="token punctuation">&#123;</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// </span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TSimpleServer<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 加互斥锁</span>
    <span class="token keyword">defer</span> p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 互斥锁解锁</span>
    <span class="token comment">// 如果已经关闭 直接返回    closed=1是关闭 closed=0是开启</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 设置closed=1 关闭</span>
    atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>closed<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// 发送中断信号</span>
    p<span class="token punctuation">.</span>serverTransport<span class="token punctuation">.</span><span class="token function">Interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 等待所有请求处理完</span>
	p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h3 id="TServerTransport"><a href="#TServerTransport" class="headerlink" title="TServerTransport"></a>TServerTransport</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 服务通信方式 </span>
<span class="token comment">// Server transport. Object which provides client transports.</span>
<span class="token keyword">type</span> TServerTransport <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
	<span class="token function">Listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>TTransport<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token comment">// Optional method implementation. This signals to the server transport</span>
	<span class="token comment">// that it should break out of any accept() or listen() that it is currently</span>
	<span class="token comment">// blocked on. This method, if implemented, MUST be thread safe, as it may</span>
	<span class="token comment">// be called from a different thread context than the other TServerTransport</span>
	<span class="token comment">// methods.</span>
	<span class="token function">Interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  TServerTransport接口的实现类有2个: <code>TServerSocket</code> 、<code>TSSLServerSocket</code>  </p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// </span>
<span class="token keyword">type</span> TServerSocket <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	listener      net<span class="token punctuation">.</span>Listener
	addr          net<span class="token punctuation">.</span>Addr
	clientTimeout time<span class="token punctuation">.</span>Duration

	<span class="token comment">// Protects the interrupted value to make it thread safe.</span>
	mu          sync<span class="token punctuation">.</span>RWMutex
	interrupted <span class="token builtin">bool</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// </span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>TServerSocket<span class="token punctuation">)</span> <span class="token function">Listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 加互斥锁 保护p.listener </span>
	p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 已经在监听 返回</span>
	<span class="token keyword">if</span> p<span class="token punctuation">.</span><span class="token function">IsListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
  <span class="token punctuation">&#125;</span>
	<span class="token comment">// 监听指定地址端口</span>
	l<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>addr<span class="token punctuation">.</span><span class="token function">Network</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>addr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 赋值</span>
	p<span class="token punctuation">.</span>listener <span class="token operator">=</span> l
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="5-Demo-Java"><a href="#5-Demo-Java" class="headerlink" title="(5) Demo-Java"></a>(5) Demo-Java</h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h1 id="6-源码解析Java"><a href="#6-源码解析Java" class="headerlink" title="(6) 源码解析Java"></a>(6) 源码解析Java</h1><h2 id="6-1-TServer"><a href="#6-1-TServer" class="headerlink" title="(6.1) TServer"></a>(6.1) TServer</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>thrift<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 抽象 thrift服务
 * 
 * Generic interface for a Thrift server.
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">TServer</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">/**
   * 核心处理工厂
   * Core processor
   */</span>
  <span class="token keyword">protected</span> <span class="token class-name">TProcessorFactory</span> processorFactory_<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 服务通信
   * Server transport
   */</span>
  <span class="token keyword">protected</span> <span class="token class-name">TServerTransport</span> serverTransport_<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 传输层输入工厂
   * Input Transport Factory
   */</span>
  <span class="token keyword">protected</span> <span class="token class-name">TTransportFactory</span> inputTransportFactory_<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 传输层输出工厂
   * Output Transport Factory
   */</span>
  <span class="token keyword">protected</span> <span class="token class-name">TTransportFactory</span> outputTransportFactory_<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 协议层输入工厂
   * Input Protocol Factory
   */</span>
  <span class="token keyword">protected</span> <span class="token class-name">TProtocolFactory</span> inputProtocolFactory_<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 协议层输出工厂
   * Output Protocol Factory
   */</span>
  <span class="token keyword">protected</span> <span class="token class-name">TProtocolFactory</span> outputProtocolFactory_<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 服务状态  
   * 启动 关闭
   * volatile保证可见性 
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> isServing<span class="token punctuation">;</span>

  <span class="token keyword">protected</span> <span class="token class-name">TServerEventHandler</span> eventHandler_<span class="token punctuation">;</span>

  <span class="token comment">// Flag for stopping the server</span>
  <span class="token comment">// Please see THRIFT-1795 for the usage of this flag</span>
  <span class="token keyword">protected</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> stopped_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 构造方法
   * 设置处理工厂、服务通信方式、输入传输方式、输出通信方式、输入协议工厂、
   */</span>
  <span class="token keyword">protected</span> <span class="token class-name">TServer</span><span class="token punctuation">(</span><span class="token class-name">AbstractServerArgs</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    processorFactory_ <span class="token operator">=</span> args<span class="token punctuation">.</span>processorFactory<span class="token punctuation">;</span>
    serverTransport_ <span class="token operator">=</span> args<span class="token punctuation">.</span>serverTransport<span class="token punctuation">;</span>
    inputTransportFactory_ <span class="token operator">=</span> args<span class="token punctuation">.</span>inputTransportFactory<span class="token punctuation">;</span>
    outputTransportFactory_ <span class="token operator">=</span> args<span class="token punctuation">.</span>outputTransportFactory<span class="token punctuation">;</span>
    inputProtocolFactory_ <span class="token operator">=</span> args<span class="token punctuation">.</span>inputProtocolFactory<span class="token punctuation">;</span>
    outputProtocolFactory_ <span class="token operator">=</span> args<span class="token punctuation">.</span>outputProtocolFactory<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractServerArgs</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Args</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">TServerTransport</span> transport<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * run方法启动服务器并开始运行。
   * 
   * The run method fires up the server and gets things going.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 停止服务
   * 这在每个实现的基础上是可选的。并非所有服务器都要求优雅停止。
   * 
   * Stop the server. This is optional on a per-implementation basis. Not
   * all servers are required to be cleanly stoppable.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到<code>TServer</code>是一个抽象类</p>
<ol>
<li>里面定义了创建server需要的信息：处理器工厂、服务通信方式(server的实现)、传输层输入工厂、传输层输出工厂、协议层输入工厂、协议层输出工厂</li>
<li>定义了TServer的构造方法</li>
<li>服务启动方法<code>serve()</code>是一个抽象方法，需要子类自己去实现; </li>
<li>服务关闭方法<code>stop()</code>是一个普通方法，子类可以选择是否实现。</li>
</ol>
<h2 id="6-2-TSimpleServer"><a href="#6-2-TSimpleServer" class="headerlink" title="(6.2) TSimpleServer"></a>(6.2) TSimpleServer</h2><p>  Java实现的 <code>TSimpleServer</code> 工作模式采用最简单的阻塞IO，实现简洁明了，比较适合入门学习。<br>  用于演示Thrift的工作流程，测试用，不会在正式环境使用。</p>
<p>  Java实现的 <code>TSimpleServer</code> 一次只能接收和处理一个socket连接，效率比较低。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>thrift<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Simple singlethreaded server for testing.
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TSimpleServer</span> <span class="token keyword">extends</span> <span class="token class-name">TServer</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">public</span> <span class="token class-name">TSimpleServer</span><span class="token punctuation">(</span><span class="token class-name">AbstractServerArgs</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="6-2-1-serve"><a href="#6-2-1-serve" class="headerlink" title="(6.2.1) serve"></a>(6.2.1) serve</h3><p>  TSimpleServer启动流程</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 启动serve</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 监听配置的地址和端口  </span>
    serverTransport_<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TTransportException</span> ttx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error occurred during listening."</span><span class="token punctuation">,</span> ttx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// </span>
  <span class="token comment">// Run the preServe event</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler_ <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    eventHandler_<span class="token punctuation">.</span><span class="token function">preServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 设置服务状态为启动</span>
  <span class="token function">setServing</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// </span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 客户端传输方式</span>
    <span class="token class-name">TTransport</span> client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 对应方法的处理器 </span>
    <span class="token class-name">TProcessor</span> processor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 输入传输方式</span>
    <span class="token class-name">TTransport</span> inputTransport <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 输出传输方式</span>
    <span class="token class-name">TTransport</span> outputTransport <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 输入协议</span>
    <span class="token class-name">TProtocol</span> inputProtocol <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 输出协议</span>
    <span class="token class-name">TProtocol</span> outputProtocol <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">ServerContext</span> connectionContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 接收请求   这儿会被阻塞 </span>
      client <span class="token operator">=</span> serverTransport_<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        processor <span class="token operator">=</span> processorFactory_<span class="token punctuation">.</span><span class="token function">getProcessor</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputTransport <span class="token operator">=</span> inputTransportFactory_<span class="token punctuation">.</span><span class="token function">getTransport</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputTransport <span class="token operator">=</span> outputTransportFactory_<span class="token punctuation">.</span><span class="token function">getTransport</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputProtocol <span class="token operator">=</span> inputProtocolFactory_<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span>inputTransport<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputProtocol <span class="token operator">=</span> outputProtocolFactory_<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span>outputTransport<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler_ <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          connectionContext <span class="token operator">=</span> eventHandler_<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>inputProtocol<span class="token punctuation">,</span> outputProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 循环处理请求</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler_ <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// </span>
            eventHandler_<span class="token punctuation">.</span><span class="token function">processContext</span><span class="token punctuation">(</span>connectionContext<span class="token punctuation">,</span> inputTransport<span class="token punctuation">,</span> outputTransport<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// 调对应的方法 处理请求</span>
          processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inputProtocol<span class="token punctuation">,</span> outputProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TTransportException</span> ttx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Client died, just move on</span>
      LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Client Transportation Exception"</span><span class="token punctuation">,</span> ttx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TException</span> tx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Thrift error occurred during processing of message."</span><span class="token punctuation">,</span> tx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error occurred during processing of message."</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 删除上下文</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler_ <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      eventHandler_<span class="token punctuation">.</span><span class="token function">deleteContext</span><span class="token punctuation">(</span>connectionContext<span class="token punctuation">,</span> inputProtocol<span class="token punctuation">,</span> outputProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 关闭 传输层输入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inputTransport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      inputTransport<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 关闭 传输层输出</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outputTransport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      outputTransport<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 设置服务状态为 停止</span>
  <span class="token function">setServing</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>

<h2 id="6-3-TThreadPoolServer"><a href="#6-3-TThreadPoolServer" class="headerlink" title="(6.3) TThreadPoolServer"></a>(6.3) TThreadPoolServer</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 使用Java内置的ThreadPool管理的服务器来生成一个以阻塞方式处理客户端连接的工作线程池。
 * 
 * Server which uses Java's built in ThreadPool management to spawn off
 * a worker pool that deals with client connections in blocking way.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TThreadPoolServer</span> <span class="token keyword">extends</span> <span class="token class-name">TServer</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">// 处理client请求的工作线程  </span>
  <span class="token comment">// Executor service for handling client connections</span>
  <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> executorService_<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TimeUnit</span> stopTimeoutUnit<span class="token punctuation">;</span>
  
  <span class="token comment">// 线程池停止倒计时</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> stopTimeoutVal<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">TThreadPoolServer</span><span class="token punctuation">(</span><span class="token class-name">Args</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    stopTimeoutUnit <span class="token operator">=</span> args<span class="token punctuation">.</span>stopTimeoutUnit<span class="token punctuation">;</span>
    stopTimeoutVal <span class="token operator">=</span> args<span class="token punctuation">.</span>stopTimeoutVal<span class="token punctuation">;</span>

    executorService_ <span class="token operator">=</span> args<span class="token punctuation">.</span>executorService <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
        args<span class="token punctuation">.</span>executorService <span class="token operator">:</span> <span class="token function">createDefaultExecutorService</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * 创建一个线程池
   * 设置了核心线程数、最大线程数、工作线程存活时间、阻塞队列
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">createDefaultExecutorService</span><span class="token punctuation">(</span><span class="token class-name">Args</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>minWorkerThreads<span class="token punctuation">,</span> args<span class="token punctuation">.</span>maxWorkerThreads<span class="token punctuation">,</span> <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"TThreadPoolServer WorkerProcess-%d"</span><span class="token punctuation">,</span> count<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> thread<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="6-3-1-serve"><a href="#6-3-1-serve" class="headerlink" title="(6.3.1) serve()"></a>(6.3.1) serve()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 启动服务
 * 循环处理请求
 * 服务优雅关闭
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 这个方法执行时会阻塞到这儿，直到服务器状态关闭</span>
  <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 线程池优雅关闭</span>
  <span class="token comment">// 关闭线程池 不再接收新的任务</span>
  executorService_<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 等待线程池内任务完成 </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">waitForShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Shutdown is not done after "</span> <span class="token operator">+</span> stopTimeoutVal <span class="token operator">+</span> stopTimeoutUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 设置服务状态为关闭</span>
  <span class="token function">setServing</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
  * 预启动
  */</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">preServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 监听配置地址端口</span>
    serverTransport_<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TTransportException</span> ttx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error occurred during listening."</span><span class="token punctuation">,</span> ttx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Run the preServe event</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler_ <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    eventHandler_<span class="token punctuation">.</span><span class="token function">preServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  stopped_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置服务状态为启动</span>
  <span class="token function">setServing</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 服务器未停止，循环处理</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 接收调用端请求</span>
      <span class="token class-name">TTransport</span> client <span class="token operator">=</span> serverTransport_<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 新建一个任务放入线程池执行</span>
        executorService_<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WorkerProcess</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> ree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 线程池满后拒绝策略 </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"ThreadPool is saturated with incoming requests. Closing latest connection."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 关闭和client的通信传输连接 </span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TTransportException</span> ttx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 和client通信传输异常  不处理 </span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 服务未关闭，打一条warn日志 </span>
        LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Transport error occurred during acceptance of message"</span><span class="token punctuation">,</span> ttx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 线程池优雅停止
 * 等待任务执行完再停止
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">waitForShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 循环直到 awaitTermination 最终返回没有中断的异常。</span>
  <span class="token comment">// 如果我们不这样做，那么我们将过早关闭。我们想让 executorService 清除它的任务队列，适当地关闭客户端套接字。</span>
  <span class="token comment">// </span>
  <span class="token comment">// Loop until awaitTermination finally does return without a interrupted</span>
  <span class="token comment">// exception. If we don't do this, then we'll shut down prematurely. We want</span>
  <span class="token comment">// to let the executorService clear it's task queue, closing client sockets</span>
  <span class="token comment">// appropriately.</span>
  <span class="token keyword">long</span> timeoutMS <span class="token operator">=</span> stopTimeoutUnit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>stopTimeoutVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>timeoutMS <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// </span>
      <span class="token keyword">return</span> executorService_<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span>timeoutMS<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">long</span> newnow <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      timeoutMS <span class="token operator">-=</span> <span class="token punctuation">(</span>newnow <span class="token operator">-</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
      now <span class="token operator">=</span> newnow<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 任务处理线程 
 */</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">WorkerProcess</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">/**
   * Client that this services.
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">TTransport</span> client_<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Default constructor.
   *
   * @param client Transport to process
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">WorkerProcess</span><span class="token punctuation">(</span><span class="token class-name">TTransport</span> client<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    client_ <span class="token operator">=</span> client<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * 一直循环处理客户端的请求
   * 
   * Loops on processing a client forever
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">TProcessor</span> processor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">TTransport</span> inputTransport <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">TTransport</span> outputTransport <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">TProtocol</span> inputProtocol <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">TProtocol</span> outputProtocol <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TServerEventHandler</span><span class="token punctuation">></span></span> eventHandler <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ServerContext</span> connectionContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 获取 处理器</span>
      processor <span class="token operator">=</span> processorFactory_<span class="token punctuation">.</span><span class="token function">getProcessor</span><span class="token punctuation">(</span>client_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取 传输层输入</span>
      inputTransport <span class="token operator">=</span> inputTransportFactory_<span class="token punctuation">.</span><span class="token function">getTransport</span><span class="token punctuation">(</span>client_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取 传输层输出</span>
      outputTransport <span class="token operator">=</span> outputTransportFactory_<span class="token punctuation">.</span><span class="token function">getTransport</span><span class="token punctuation">(</span>client_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取 协议层输入</span>
      inputProtocol <span class="token operator">=</span> inputProtocolFactory_<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span>inputTransport<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取 协议层输出</span>
      outputProtocol <span class="token operator">=</span> outputProtocolFactory_<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span>outputTransport<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 事件处理器</span>
      eventHandler <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token function">getEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        connectionContext <span class="token operator">=</span> eventHandler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>inputProtocol<span class="token punctuation">,</span> outputProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 线程是否中断</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"WorkerProcess requested to shutdown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          eventHandler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processContext</span><span class="token punctuation">(</span>connectionContext<span class="token punctuation">,</span> inputTransport<span class="token punctuation">,</span> outputTransport<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 核心处理逻辑 </span>
        <span class="token comment">// 不能通过中断标识来中断这个线程</span>
        <span class="token comment">// 这个线程处理完后会把消息返回(把消息写入传输层输出)，或者套接字已经超时，此时它将返回并检查线程的中断状态</span>
        <span class="token comment">// </span>
        <span class="token comment">// This process cannot be interrupted by Interrupting the Thread. This</span>
        <span class="token comment">// will return once a message has been processed or the socket timeout</span>
        <span class="token comment">// has elapsed, at which point it will return and check the interrupt</span>
        <span class="token comment">// state of the thread.</span>
        processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inputProtocol<span class="token punctuation">,</span> outputProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Error processing request"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 解析异常 并判断异常是否需要忽略 </span>
      <span class="token comment">// 会忽略掉所有传输层异常 </span>
      <span class="token comment">//</span>
      <span class="token comment">// We'll usually receive RuntimeException types here</span>
      <span class="token comment">// Need to unwrap to ascertain real causing exception before we choose to ignore</span>
      <span class="token comment">// Ignore err-logging all transport-level/type exceptions</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isIgnorableException</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Log the exception at error level and continue</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">TException</span> <span class="token operator">?</span> <span class="token string">"Thrift "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"Error occurred during processing of message."</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// </span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        eventHandler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteContext</span><span class="token punctuation">(</span>connectionContext<span class="token punctuation">,</span> inputProtocol<span class="token punctuation">,</span> outputProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 关闭传输层输入</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>inputTransport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        inputTransport<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 关闭传输层输出</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>outputTransport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        outputTransport<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 关闭 客户端连接</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>client_<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        client_<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * 判断异常是否可以忽略
   * 
   * 可以忽略超时异常 和 文件读结束异常
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isIgnorableException</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">TTransportException</span> tTransportException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">TTransportException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      tTransportException <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TTransportException</span><span class="token punctuation">)</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">TTransportException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      tTransportException <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TTransportException</span><span class="token punctuation">)</span> x<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tTransportException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">switch</span><span class="token punctuation">(</span>tTransportException<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 读完文件</span>
        <span class="token keyword">case</span> <span class="token class-name">TTransportException</span><span class="token punctuation">.</span>END_OF_FILE<span class="token operator">:</span>
        <span class="token comment">// 传输超时</span>
        <span class="token keyword">case</span> <span class="token class-name">TTransportException</span><span class="token punctuation">.</span>TIMED_OUT<span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h2 id="6-4-AbstractNonblockingServer"><a href="#6-4-AbstractNonblockingServer" class="headerlink" title="(6.4) AbstractNonblockingServer"></a>(6.4) AbstractNonblockingServer</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 提供非阻塞TServer实现类的 常用方法和公共类。
 * 
 * Provides common methods and classes used by nonblocking TServer
 * implementations.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNonblockingServer</span> <span class="token keyword">extends</span> <span class="token class-name">TServer</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">/**
   * 我们将一次分配给客户端 IO 缓冲区的最大内存量。
   * 如果没有这个限制，服务器会很乐意将客户端缓冲区分配导致内存不足异常，而不是等待。
   * 
   * The maximum amount of memory we will allocate to client IO buffers at a
   * time. Without this limit, the server will gladly allocate client buffers
   * right into an out of memory exception, rather than waiting.
   */</span>
  <span class="token keyword">final</span> <span class="token keyword">long</span> MAX_READ_BUFFER_BYTES<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 当前分配给读取缓冲区的字节数。
   * 
   * How many bytes are currently allocated to read buffers.
   */</span>
  <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> readBufferBytesAllocated <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">AbstractNonblockingServer</span><span class="token punctuation">(</span><span class="token class-name">AbstractNonblockingServerArgs</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    MAX_READ_BUFFER_BYTES <span class="token operator">=</span> args<span class="token punctuation">.</span>maxReadBufferBytes<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>


<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="6-4-1-serve"><a href="#6-4-1-serve" class="headerlink" title="(6.4.1) serve()"></a>(6.4.1) serve()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token comment">/**
 * 开始接受连接和处理调用。
 * 
 * Begin accepting connections and processing invocations.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 启动任何 IO 线程</span>
  <span class="token comment">// start any IO threads</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">startThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 开始监听 或者退出</span>
  <span class="token comment">// start listening, or exit</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">startListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 设置服务状态为服务中</span>
  <span class="token function">setServing</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 服务时会阻塞在这儿  </span>
  <span class="token comment">// this will block while we serve</span>
  <span class="token function">waitForShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置服务状态为停止服务</span>
  <span class="token function">setServing</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 优雅关闭  </span>
  <span class="token comment">// 做一些清理工作</span>
  <span class="token comment">// do a little cleanup</span>
  <span class="token function">stopListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 启动服务所需的任何线程。
 * 
 * Starts any threads required for serving.
 *
 * @return true if everything went ok, false if threads could not be started.
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">startThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 在处理服务的线程被关闭之前 将阻塞的方法
 * 
 * A method that will block until when threads handling the serving have been
 * shut down.
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">waitForShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 让服务器传输开始接受请求/连接。
 * 
 * Have the server transport start accepting connections.
 *
 * @return true if we started listening successfully, false if something went
 *         wrong.
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">startListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 监听指定地址端口</span>
    serverTransport_<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TTransportException</span> ttx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to start listening on server socket!"</span><span class="token punctuation">,</span> ttx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * 停止监听连接
 * 
 * Stop listening for connections.
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">stopListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  serverTransport_<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * FrameBuffer 状态机的可能状态。
 * 
 * Possible states for the FrameBuffer state machine.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">FrameBufferState</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 从网络读取帧大小的过程中</span>
  <span class="token comment">// in the midst of reading the frame size off the wire</span>
  READING_FRAME_SIZE<span class="token punctuation">,</span>
  
  <span class="token comment">// 在读取实际的帧数据，但还没有全部完成</span>
  <span class="token comment">// reading the actual frame data now, but not all the way done yet</span>
  READING_FRAME<span class="token punctuation">,</span>

  <span class="token comment">// 完全读取帧，因此现在可以进行调用</span>
  <span class="token comment">// completely read the frame, so an invocation can now happen</span>
  READ_FRAME_COMPLETE<span class="token punctuation">,</span>

  <span class="token comment">// 等待切换到监听写事件</span>
  <span class="token comment">// waiting to get switched to listening for write events</span>
  AWAITING_REGISTER_WRITE<span class="token punctuation">,</span>

  <span class="token comment">// 开始写入响应数据，尚未完全完成</span>
  <span class="token comment">// started writing response data, not fully complete yet</span>
  WRITING<span class="token punctuation">,</span>

  <span class="token comment">// 另一个线程希望这个帧缓冲区返回读取</span>
  <span class="token comment">// another thread wants this framebuffer to go back to reading</span>
  AWAITING_REGISTER_READ<span class="token punctuation">,</span>

  <span class="token comment">// 我们希望我们的传输和选择键在选择器线程中失效</span>
  <span class="token comment">// we want our transport and selection key invalidated in the selector</span>
  <span class="token comment">// thread</span>
  AWAITING_CLOSE
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="6-5-TNonblockingServer"><a href="#6-5-TNonblockingServer" class="headerlink" title="(6.5) TNonblockingServer"></a>(6.5) TNonblockingServer</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>thrift<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 
 * 非阻塞 TServer 实现。就调用而言，这允许所有连接的客户端之间的公平性。
 * 
 * 该服务器本质上是单线程的。如果您想要一个有限的线程池以及调用公平，请参阅 THsHaServer。
 * 
 * 要使用此服务器，您必须在最外层传输处使用 TFramedTransport，否则此服务器将无法确定何时已从线路读取整个方法调用。客户端还必须使用 TFramedTransport。
 * 
 * 
 * A nonblocking TServer implementation. This allows for fairness amongst all
 * connected clients in terms of invocations.
 *
 * This server is inherently single-threaded. If you want a limited thread pool
 * coupled with invocation-fairness, see THsHaServer.
 *
 * To use this server, you MUST use a TFramedTransport at the outermost
 * transport, otherwise this server will be unable to determine when a whole
 * method call has been read off the wire. Clients must also use TFramedTransport.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TNonblockingServer</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNonblockingServer</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">// 选择接受线程</span>
  <span class="token keyword">private</span> <span class="token class-name">SelectAcceptThread</span> selectAcceptThread_<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">TNonblockingServer</span><span class="token punctuation">(</span><span class="token class-name">AbstractNonblockingServerArgs</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  TNonblockingServer里有比较重要的几个方法 <code>TNonblockingServer()</code>、 <code>startThreads()</code>、 <code>requestInvoke()</code>、 <code>waitForShutdown()</code>、 <code>joinSelector()</code>、 <code>isStopped()</code>、 <code> stop()</code><br>  以及比较重要的类 <code>SelectAcceptThread</code></p>
<h3 id="6-5-1-startThreads"><a href="#6-5-1-startThreads" class="headerlink" title="(6.5.1) startThreads()"></a>(6.5.1) startThreads()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Start the selector thread to deal with accepts and client messages.
 *
 * @return true if everything went ok, false if we couldn't start for some
 * reason.
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">startThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 启动 选择接受线程</span>
  <span class="token comment">// start the selector</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 新创建一个选择接受线程 </span>
    selectAcceptThread_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SelectAcceptThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TNonblockingServerTransport</span><span class="token punctuation">)</span>serverTransport_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动线程</span>
    selectAcceptThread_<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to start selector thread!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="6-5-2-SelectAcceptThread-重点"><a href="#6-5-2-SelectAcceptThread-重点" class="headerlink" title="(6.5.2) SelectAcceptThread 重点"></a>(6.5.2) SelectAcceptThread 重点</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * The thread that will be doing all the selecting, managing new connections
 * and those that still need to be read.
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">class</span> <span class="token class-name">SelectAcceptThread</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSelectThread</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">// The server transport on which new client transports will be accepted</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TNonblockingServerTransport</span> serverTransport<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Set up the thread that will handle the non-blocking accepts, reads, and
   * writes.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">SelectAcceptThread</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">TNonblockingServerTransport</span> serverTransport<span class="token punctuation">)</span>
  <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serverTransport <span class="token operator">=</span> serverTransport<span class="token punctuation">;</span>
    serverTransport<span class="token punctuation">.</span><span class="token function">registerSelector</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  <code>SelectAcceptThread</code>类比较重要的几个方法 <code>SelectAcceptThread</code>、 <code>run()</code>、 <code>select()</code>、 <code>handleAccept()</code></p>
<h4 id="run"><a href="#run" class="headerlink" title="run()"></a>run()</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 工作循环。
 * 处理选择（所有 IO 操作）和管理所有现有连接的选择首选项。
 * 
 * The work loop. Handles both selecting (all IO operations) and managing
 * the selection preferences of all existing connections.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler_ <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      eventHandler_<span class="token punctuation">.</span><span class="token function">preServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 只要服务不停止，就一直循环</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 选择和处理IO事件</span>
      <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 处理</span>
      <span class="token function">processInterestChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">:</span> selector<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 清理</span>
      <span class="token function">cleanupSelectionKey</span><span class="token punctuation">(</span>selectionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"run() exiting due to uncaught error"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      selector<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Got an IOException while closing selector!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    stopped_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="select"><a href="#select" class="headerlink" title="select()"></a>select()</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token comment">/**
 * 适当地选择和处理 IO 事件：
 *   如果有要接受的连接，请接受它们。
 *   如果存在等待读取的数据的现有连接，则读取它，缓冲直到读取整个帧。
 *   如果有任何待处理的响应，缓冲它们直到它们的目标客户端可用，然后发送数据。
 * 
 * Select and process IO events appropriately:
 * If there are connections to be accepted, accept them.
 * If there are existing connections with data waiting to be read, read it,
 * buffering until a whole frame has been read.
 * If there are any pending responses, buffer them until their target client
 * is available, and then send the data.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 等待IO事件</span>
    <span class="token comment">// wait for io events.</span>
    selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当IO事件到达时处理 </span>
    <span class="token comment">// process the io events we received</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">></span></span> selectedKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 服务器未停止并且有IO事件时 循环处理 </span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_ <span class="token operator">&amp;&amp;</span> selectedKeys<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// </span>
      <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> selectedKeys<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      selectedKeys<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 跳过不可用的事件</span>
      <span class="token comment">// skip if not valid</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">cleanupSelectionKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 如果密钥被标记为接受，那么它必须是服务器传输。 </span>
      <span class="token comment">// if the key is marked Accept, then it has to be the server</span>
      <span class="token comment">// transport.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 处理接受请求/新建连接操作</span>
        <span class="token function">handleAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 处理读取操作</span>
        <span class="token comment">// deal with reads</span>
        <span class="token function">handleRead</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 处理写入操作</span>
        <span class="token comment">// deal with writes</span>
        <span class="token function">handleWrite</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected state in select! "</span> <span class="token operator">+</span> key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Got an IOException while selecting!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="handleAccept"><a href="#handleAccept" class="headerlink" title="handleAccept()"></a>handleAccept()</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 接受新连接 
 * 
 * Accept a new connection.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">SelectionKey</span> clientKey <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token class-name">TNonblockingTransport</span> client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 接受连接</span>
    <span class="token comment">// accept the connection</span>
    client <span class="token operator">=</span> serverTransport<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册选择器 读取操作</span>
    clientKey <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">registerSelector</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  </span>
    <span class="token comment">// add this key to the map</span>
      <span class="token class-name">FrameBuffer</span> frameBuffer <span class="token operator">=</span> <span class="token function">createFrameBuffer</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> clientKey<span class="token punctuation">,</span> <span class="token class-name">SelectAcceptThread</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 在clientKey上附加frameBuffer</span>
      clientKey<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>frameBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TTransportException</span> tte<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// something went wrong accepting.</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception trying to accept!"</span><span class="token punctuation">,</span> tte<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientKey <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token function">cleanupSelectionKey</span><span class="token punctuation">(</span>clientKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">FrameBuffer</span> <span class="token function">createFrameBuffer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">TNonblockingTransport</span> trans<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">SelectionKey</span> selectionKey<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractSelectThread</span> selectThread<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TTransportException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> processorFactory_<span class="token punctuation">.</span><span class="token function">isAsyncProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
              <span class="token keyword">new</span> <span class="token class-name">AsyncFrameBuffer</span><span class="token punctuation">(</span>trans<span class="token punctuation">,</span> selectionKey<span class="token punctuation">,</span> selectThread<span class="token punctuation">)</span> <span class="token operator">:</span>
              <span class="token keyword">new</span> <span class="token class-name">FrameBuffer</span><span class="token punctuation">(</span>trans<span class="token punctuation">,</span> selectionKey<span class="token punctuation">,</span> selectThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="6-5-2-AbstractNonblockingServer"><a href="#6-5-2-AbstractNonblockingServer" class="headerlink" title="(6.5.2) AbstractNonblockingServer"></a>(6.5.2) AbstractNonblockingServer</h3><h4 id="handleRead-key"><a href="#handleRead-key" class="headerlink" title="handleRead(key)"></a>handleRead(key)</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>thrift<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>
<span class="token comment">// class AbstractNonblockingServer</span>

<span class="token comment">/**
 * Do the work required to read from a readable client. If the frame is
 * fully read, then invoke the method call.
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">FrameBuffer</span> buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FrameBuffer</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 数据校验 如果buffer还未读取，直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">cleanupSelectionKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// buffer读取完成，调用方法</span>
  <span class="token comment">// if the buffer's frame read is complete, invoke the method.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">isFrameFullyRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">requestInvoke</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// </span>
      <span class="token function">cleanupSelectionKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>thrift<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>
<span class="token comment">// class TNonblockingServer</span>

<span class="token comment">/**
 * Perform an invocation. This method could behave several different ways
 * - invoke immediately inline, queue for separate execution, etc.
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">requestInvoke</span><span class="token punctuation">(</span><span class="token class-name">FrameBuffer</span> frameBuffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  frameBuffer<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>thrift<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>
<span class="token comment">// class AbstractNonblockingServer</span>

<span class="token comment">/**
 * Actually invoke the method signified by this FrameBuffer.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// </span>
  frameTrans_<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>buffer_<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  response_<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler_ <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      eventHandler_<span class="token punctuation">.</span><span class="token function">processContext</span><span class="token punctuation">(</span>context_<span class="token punctuation">,</span> inTrans_<span class="token punctuation">,</span> outTrans_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 获取处理器处理 </span>
    <span class="token comment">// 调用对应的服务方法执行 </span>
    processorFactory_<span class="token punctuation">.</span><span class="token function">getProcessor</span><span class="token punctuation">(</span>inTrans_<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>inProt_<span class="token punctuation">,</span> outProt_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">responseReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TException</span> te<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception while invoking!"</span><span class="token punctuation">,</span> te<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unexpected throwable while invoking!"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// This will only be reached when there is a throwable.</span>
  state_ <span class="token operator">=</span> <span class="token class-name">FrameBufferState</span><span class="token punctuation">.</span>AWAITING_CLOSE<span class="token punctuation">;</span>
  <span class="token function">requestSelectInterestChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="handleWrite-key"><a href="#handleWrite-key" class="headerlink" title="handleWrite(key)"></a>handleWrite(key)</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="waitForShutdown"><a href="#waitForShutdown" class="headerlink" title="waitForShutdown()"></a>waitForShutdown()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>thrift<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>
<span class="token comment">// class TNonblockingServer </span>

  <span class="token comment">/**
   *  等待服务关闭
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">waitForShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// </span>
    <span class="token function">joinSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * 阻塞 直到 选择接受线程退出
   * 
   * Block until the selector thread exits.
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">joinSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// wait until the selector thread exits</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 等待 选择接受线程 执行完</span>
      selectAcceptThread_<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Interrupted while waiting for accept thread"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="stop"><a href="#stop" class="headerlink" title="stop()"></a>stop()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 停止服务
 * 
 * Stop serving and shut everything down.
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  stopped_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>selectAcceptThread_ <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// </span>
    selectAcceptThread_<span class="token punctuation">.</span><span class="token function">wakeupSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="6-6-THsHaServer"><a href="#6-6-THsHaServer" class="headerlink" title="(6.6) THsHaServer"></a>(6.6) THsHaServer</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>thrift<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 半同步/半异步服务器(THsHaServer)是对TNonblockingServer的扩展。
 * 与 TNonblockingServer 一样，它依赖于 TFramedTransport 的使用。
 * 
 * An extension of the TNonblockingServer to a Half-Sync/Half-Async server.
 * Like TNonblockingServer, it relies on the use of TFramedTransport.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">THsHaServer</span> <span class="token keyword">extends</span> <span class="token class-name">TNonblockingServer</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">// This wraps all the functionality of queueing and thread pool management</span>
  <span class="token comment">// for the passing of Invocations from the Selector to workers.</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> invoker<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Args</span> args<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Create the server with the specified Args configuration
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">THsHaServer</span><span class="token punctuation">(</span><span class="token class-name">Args</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    invoker <span class="token operator">=</span> args<span class="token punctuation">.</span>executorService <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">createInvokerPool</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">:</span> args<span class="token punctuation">.</span>executorService<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-6-1-createInvokerPool"><a href="#6-6-1-createInvokerPool" class="headerlink" title="(6.6.1) createInvokerPool()"></a>(6.6.1) createInvokerPool()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Helper to create an invoker pool
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">createInvokerPool</span><span class="token punctuation">(</span><span class="token class-name">Args</span> options<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> minWorkerThreads <span class="token operator">=</span> options<span class="token punctuation">.</span>minWorkerThreads<span class="token punctuation">;</span>
  <span class="token keyword">int</span> maxWorkerThreads <span class="token operator">=</span> options<span class="token punctuation">.</span>maxWorkerThreads<span class="token punctuation">;</span>
  <span class="token keyword">int</span> stopTimeoutVal <span class="token operator">=</span> options<span class="token punctuation">.</span>stopTimeoutVal<span class="token punctuation">;</span>
  <span class="token class-name">TimeUnit</span> stopTimeoutUnit <span class="token operator">=</span> options<span class="token punctuation">.</span>stopTimeoutUnit<span class="token punctuation">;</span>

  <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">ExecutorService</span> invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>minWorkerThreads<span class="token punctuation">,</span>
    maxWorkerThreads<span class="token punctuation">,</span> stopTimeoutVal<span class="token punctuation">,</span> stopTimeoutUnit<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> invoker<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-6-2-requestInvoke"><a href="#6-6-2-requestInvoke" class="headerlink" title="(6.6.2) requestInvoke()"></a>(6.6.2) requestInvoke()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * We override the standard invoke method here to queue the invocation for
 * invoker service instead of immediately invoking. The thread pool takes care
 * of the rest.
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">requestInvoke</span><span class="token punctuation">(</span><span class="token class-name">FrameBuffer</span> frameBuffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 新建一个线程</span>
    <span class="token class-name">Runnable</span> invocation <span class="token operator">=</span> <span class="token function">getRunnable</span><span class="token punctuation">(</span>frameBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// </span>
    invoker<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> rx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"ExecutorService rejected execution!"</span><span class="token punctuation">,</span> rx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-6-3-waitForShutdown"><a href="#6-6-3-waitForShutdown" class="headerlink" title="(6.6.3) waitForShutdown()"></a>(6.6.3) waitForShutdown()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &#123;@inheritDoc&#125;
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">waitForShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">joinSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gracefullyShutdownInvokerPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">gracefullyShutdownInvokerPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// try to gracefully shut down the executor service</span>
  invoker<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Loop until awaitTermination finally does return without a interrupted</span>
  <span class="token comment">// exception. If we don't do this, then we'll shut down prematurely. We want</span>
  <span class="token comment">// to let the executorService clear it's task queue, closing client sockets</span>
  <span class="token comment">// appropriately.</span>
  <span class="token keyword">long</span> timeoutMS <span class="token operator">=</span> args<span class="token punctuation">.</span>stopTimeoutUnit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>stopTimeoutVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>timeoutMS <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 优雅关闭</span>
      <span class="token comment">// </span>
      invoker<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span>timeoutMS<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">long</span> newnow <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      timeoutMS <span class="token operator">-=</span> <span class="token punctuation">(</span>newnow <span class="token operator">-</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
      now <span class="token operator">=</span> newnow<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h2 id="6-7-TThreadedSelectorServer"><a href="#6-7-TThreadedSelectorServer" class="headerlink" title="(6.7) TThreadedSelectorServer"></a>(6.7) TThreadedSelectorServer</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 
 * 具有单独的线程池来处理非阻塞 I/O 的半同步/半异步服务器。
 * 接受在单个线程上处理，并且可配置数量的非阻塞选择器线程管理客户端连接的读取和写入。
 * 同步工作线程池处理请求的处理。
 * 
 * 当瓶颈是单个选择器线程处理 I/O 上的 CPU 时，在多核环境中的性能优于 TNonblockingServer/THsHaServer。此外，由于接受处理与读/写和调用分离，服务器有更好的能力处理来自新连接的背压（例如，忙时停止接受）。
 * 与 TNonblockingServer 一样，它依赖于 TFramedTransport 的使用。
 * 
 * A Half-Sync/Half-Async server with a separate pool of threads to handle
 * non-blocking I/O. Accepts are handled on a single thread, and a configurable
 * number of nonblocking selector threads manage reading and writing of client
 * connections. A synchronous worker thread pool handles processing of requests.
 *
 * Performs better than TNonblockingServer/THsHaServer in multi-core
 * environments when the the bottleneck is CPU on the single selector thread
 * handling I/O. In addition, because the accept handling is decoupled from
 * reads/writes and invocation, the server has better ability to handle back-
 * pressure from new connections (e.g. stop accepting when busy).
 *
 * Like TNonblockingServer, it relies on the use of TFramedTransport.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TThreadedSelectorServer</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNonblockingServer</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">// 包装队列和线程池管理的所有功能，以便将调用从选择器线程传递到工作线程（如果有）。</span>
  <span class="token comment">// </span>
  <span class="token comment">// This wraps all the functionality of queueing and thread pool management</span>
  <span class="token comment">// for the passing of Invocations from the selector thread(s) to the workers</span>
  <span class="token comment">// (if any).</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> invoker<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Args</span> args<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Create the server with the specified Args configuration
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">TThreadedSelectorServer</span><span class="token punctuation">(</span><span class="token class-name">Args</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    invoker <span class="token operator">=</span> args<span class="token punctuation">.</span>executorService <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">createDefaultExecutor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">:</span> args<span class="token punctuation">.</span>executorService<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> serve流程</p>
<ol>
<li>startThreads();</li>
<li>startListening();</li>
<li>setServing(true);</li>
<li>waitForShutdown();</li>
<li>setServing(false);</li>
<li>stopListening();</li>
</ol>
<h3 id="6-7-1-startThreads"><a href="#6-7-1-startThreads" class="headerlink" title="(6.7.1) startThreads()"></a>(6.7.1) startThreads()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Start the accept and selector threads running to deal with clients.
 *
 * @return true if everything went ok, false if we couldn't start for some
 *         reason.
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">startThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>selectorThreads<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      selectorThreads<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SelectorThread</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>acceptQueueSizePerThread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    acceptThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AcceptThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TNonblockingServerTransport</span><span class="token punctuation">)</span> serverTransport_<span class="token punctuation">,</span>
      <span class="token function">createSelectorThreadLoadBalancer</span><span class="token punctuation">(</span>selectorThreads<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectorThread</span> thread <span class="token operator">:</span> selectorThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// </span>
      thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// </span>
    acceptThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to start threads!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="6-7-2-SelectorThread"><a href="#6-7-2-SelectorThread" class="headerlink" title="(6.7.2) SelectorThread"></a>(6.7.2) SelectorThread</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * The SelectorThread(s) will be doing all the selecting on accepted active
 * connections.
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">class</span> <span class="token class-name">SelectorThread</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSelectThread</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">// Accepted connections added by the accept thread.</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TNonblockingTransport</span><span class="token punctuation">></span></span> acceptedQueue<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> SELECTOR_AUTO_REBUILD_THRESHOLD <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> MONITOR_PERIOD <span class="token operator">=</span> <span class="token number">1000L</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> jvmBug <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Set up the SelectorThread with an unbounded queue for incoming accepts.
   *
   * @throws IOException
   *           if a selector cannot be created
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">SelectorThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TNonblockingTransport</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="SelectorThread-run"><a href="#SelectorThread-run" class="headerlink" title="SelectorThread::run()"></a>SelectorThread::run()</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * The work loop. Handles selecting (read/write IO), dispatching, and
 * managing the selection preferences of all existing connections.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// </span>
      <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// </span>
      <span class="token function">processAcceptedConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// </span>
      <span class="token function">processInterestChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">:</span> selector<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">cleanupSelectionKey</span><span class="token punctuation">(</span>selectionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"run() on SelectorThread exiting due to uncaught error"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      selector<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Got an IOException while closing selector!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// This will wake up the accept thread and the other selector threads</span>
    <span class="token class-name">TThreadedSelectorServer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h5 id="SelectorThread-select"><a href="#SelectorThread-select" class="headerlink" title="SelectorThread::select()"></a>SelectorThread::select()</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Select and process IO events appropriately: If there are existing
 * connections with data waiting to be read, read it, buffering until a
 * whole frame has been read. If there are any pending responses, buffer
 * them until their target client is available, and then send the data.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>

    <span class="token function">doSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// process the io events we received</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">></span></span> selectedKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_ <span class="token operator">&amp;&amp;</span> selectedKeys<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> selectedKeys<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      selectedKeys<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// skip if not valid</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">cleanupSelectionKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// deal with reads</span>
        <span class="token function">handleRead</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// deal with writes</span>
        <span class="token function">handleWrite</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected state in select! "</span> <span class="token operator">+</span> key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Got an IOException while selecting!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><strong>doSelect()</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Do select and judge epoll bug happen.
 * See : https://issues.apache.org/jira/browse/THRIFT-4251
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> beforeSelect <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> selectedNums <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> afterSelect <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedNums <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    jvmBug<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    jvmBug <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">long</span> selectedTime <span class="token operator">=</span> afterSelect <span class="token operator">-</span> beforeSelect<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedTime <span class="token operator">>=</span> MONITOR_PERIOD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    jvmBug <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>jvmBug <span class="token operator">></span> SELECTOR_AUTO_REBUILD_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"In &#123;&#125; ms happen &#123;&#125; times jvm bug; rebuilding selector."</span><span class="token punctuation">,</span> MONITOR_PERIOD<span class="token punctuation">,</span> jvmBug<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rebuildSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jvmBug <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><strong>rebuildSelector()</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Replaces the current Selector of this SelectorThread with newly created Selector to work
 * around the infamous epoll 100% CPU bug.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">rebuildSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">final</span> <span class="token class-name">Selector</span> oldSelector <span class="token operator">=</span> selector<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldSelector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token class-name">Selector</span> newSelector <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    newSelector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Created new Selector."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Create new Selector error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> key <span class="token operator">:</span> oldSelector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token class-name">SelectableChannel</span> channel <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> attachment <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>attachment <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        channel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>newSelector<span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        channel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>newSelector<span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attachment<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClosedChannelException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Register new selector key error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

  selector <span class="token operator">=</span> newSelector<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    oldSelector<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Close old selector error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Replace new selector success."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h5 id="processAcceptedConnections"><a href="#processAcceptedConnections" class="headerlink" title="processAcceptedConnections()"></a>processAcceptedConnections()</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processAcceptedConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Register accepted connections</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">TNonblockingTransport</span> accepted <span class="token operator">=</span> acceptedQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>accepted <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">registerAccepted</span><span class="token punctuation">(</span>accepted<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>  registerAccepted() </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registerAccepted</span><span class="token punctuation">(</span><span class="token class-name">TNonblockingTransport</span> accepted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">SelectionKey</span> clientKey <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    clientKey <span class="token operator">=</span> accepted<span class="token punctuation">.</span><span class="token function">registerSelector</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">FrameBuffer</span> frameBuffer <span class="token operator">=</span> <span class="token function">createFrameBuffer</span><span class="token punctuation">(</span>accepted<span class="token punctuation">,</span> clientKey<span class="token punctuation">,</span> <span class="token class-name">SelectorThread</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    clientKey<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>frameBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">TTransportException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Failed to register accepted connection to selector!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientKey <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">cleanupSelectionKey</span><span class="token punctuation">(</span>clientKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    accepted<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="processInterestChanges"><a href="#processInterestChanges" class="headerlink" title="processInterestChanges();"></a>processInterestChanges();</h5><p>  processInterestChanges()方法用的父类 里的processInterestChanges()</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>thrift<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>
<span class="token comment">// class AbstractNonblockingServer</span>

    <span class="token comment">/**
     * Check to see if there are any FrameBuffers that have switched their
     * interest type from read to write or vice versa.
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processInterestChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>selectInterestChanges<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FrameBuffer</span> fb <span class="token operator">:</span> selectInterestChanges<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          fb<span class="token punctuation">.</span><span class="token function">changeSelectInterests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        selectInterestChanges<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="AcceptThread"><a href="#AcceptThread" class="headerlink" title="AcceptThread"></a>AcceptThread</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * The thread that selects on the server transport (listen socket) and accepts
 * new connections to hand off to the IO selector threads
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">class</span> <span class="token class-name">AcceptThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">// The listen socket to accept on</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TNonblockingServerTransport</span> serverTransport<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Selector</span> acceptSelector<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SelectorThreadLoadBalancer</span> threadChooser<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Set up the AcceptThead
   *
   * @throws IOException
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">AcceptThread</span><span class="token punctuation">(</span><span class="token class-name">TNonblockingServerTransport</span> serverTransport<span class="token punctuation">,</span>
      <span class="token class-name">SelectorThreadLoadBalancer</span> threadChooser<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serverTransport <span class="token operator">=</span> serverTransport<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>threadChooser <span class="token operator">=</span> threadChooser<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>acceptSelector <span class="token operator">=</span> <span class="token class-name">SelectorProvider</span><span class="token punctuation">.</span><span class="token function">provider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serverTransport<span class="token punctuation">.</span><span class="token function">registerSelector</span><span class="token punctuation">(</span>acceptSelector<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="AcceptThread-run"><a href="#AcceptThread-run" class="headerlink" title="AcceptThread::run()"></a>AcceptThread::run()</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * The work loop. Selects on the server transport and accepts. If there was
 * a server transport that had blocking accepts, and returned on blocking
 * client transports, that should be used instead
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler_ <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      eventHandler_<span class="token punctuation">.</span><span class="token function">preServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"run() on AcceptThread exiting due to uncaught error"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      acceptSelector<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Got an IOException while closing accept selector!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// This will wake up the selector threads</span>
    <span class="token class-name">TThreadedSelectorServer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="AcceptThread-select"><a href="#AcceptThread-select" class="headerlink" title="AcceptThread::select()"></a>AcceptThread::select()</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Select and process IO events appropriately: If there are connections to
 * be accepted, accept them.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// wait for connect events.</span>
    acceptSelector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// process the io events we received</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">></span></span> selectedKeys <span class="token operator">=</span> acceptSelector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopped_ <span class="token operator">&amp;&amp;</span> selectedKeys<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> selectedKeys<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      selectedKeys<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// skip if not valid</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 处理</span>
        <span class="token function">handleAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected state in select! "</span> <span class="token operator">+</span> key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Got an IOException while selecting!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><strong>handleAccept()</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Accept a new connection.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">final</span> <span class="token class-name">TNonblockingTransport</span> client <span class="token operator">=</span> <span class="token function">doAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Pass this connection to a selector thread</span>
    <span class="token keyword">final</span> <span class="token class-name">SelectorThread</span> targetThread <span class="token operator">=</span> threadChooser<span class="token punctuation">.</span><span class="token function">nextThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>acceptPolicy <span class="token operator">==</span> <span class="token class-name">Args<span class="token punctuation">.</span>AcceptPolicy</span><span class="token punctuation">.</span>FAST_ACCEPT <span class="token operator">||</span> invoker <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">doAddAccept</span><span class="token punctuation">(</span>targetThread<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// FAIR_ACCEPT</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        invoker<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">doAddAccept</span><span class="token punctuation">(</span>targetThread<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> rx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"ExecutorService rejected accept registration!"</span><span class="token punctuation">,</span> rx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// close immediately</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAddAccept</span><span class="token punctuation">(</span><span class="token class-name">SelectorThread</span> thread<span class="token punctuation">,</span> <span class="token class-name">TNonblockingTransport</span> client<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>thread<span class="token punctuation">.</span><span class="token function">addAcceptedConnection</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="requestInvoke"><a href="#requestInvoke" class="headerlink" title="requestInvoke()"></a>requestInvoke()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * We override the standard invoke method here to queue the invocation for
 * invoker service instead of immediately invoking. If there is no thread
 * pool, handle the invocation inline on this thread
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">requestInvoke</span><span class="token punctuation">(</span><span class="token class-name">FrameBuffer</span> frameBuffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// </span>
  <span class="token class-name">Runnable</span> invocation <span class="token operator">=</span> <span class="token function">getRunnable</span><span class="token punctuation">(</span>frameBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>invoker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// </span>
      invoker<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> rx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"ExecutorService rejected execution!"</span><span class="token punctuation">,</span> rx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Invoke on the caller's thread</span>
    invocation<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Runnable</span> <span class="token function">getRunnable</span><span class="token punctuation">(</span><span class="token class-name">FrameBuffer</span> frameBuffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Invocation</span><span class="token punctuation">(</span>frameBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="waitForShutdown-1"><a href="#waitForShutdown-1" class="headerlink" title="waitForShutdown()"></a>waitForShutdown()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Joins the accept and selector threads and shuts down the executor service.
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">waitForShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token function">joinThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Non-graceful shutdown occurred</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Interrupted while joining threads!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">gracefullyShutdownInvokerPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">joinThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// wait until the io threads exit</span>
  acceptThread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectorThread</span> thread <span class="token operator">:</span> selectorThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">gracefullyShutdownInvokerPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// try to gracefully shut down the executor service</span>
  invoker<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Loop until awaitTermination finally does return without a interrupted</span>
  <span class="token comment">// exception. If we don't do this, then we'll shut down prematurely. We want</span>
  <span class="token comment">// to let the executorService clear it's task queue, closing client sockets</span>
  <span class="token comment">// appropriately.</span>
  <span class="token keyword">long</span> timeoutMS <span class="token operator">=</span> args<span class="token punctuation">.</span>stopTimeoutUnit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>stopTimeoutVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>timeoutMS <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      invoker<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span>timeoutMS<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">long</span> newnow <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      timeoutMS <span class="token operator">-=</span> <span class="token punctuation">(</span>newnow <span class="token operator">-</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
      now <span class="token operator">=</span> newnow<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="stop-1"><a href="#stop-1" class="headerlink" title="stop()"></a>stop()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Stop serving and shut everything down.
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  stopped_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">// Stop queuing connect attempts asap</span>
  <span class="token function">stopListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptThread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    acceptThread<span class="token punctuation">.</span><span class="token function">wakeupSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>selectorThreads <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectorThread</span> thread <span class="token operator">:</span> selectorThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        thread<span class="token punctuation">.</span><span class="token function">wakeupSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><h2 id="1-read-tcp-i-o-timeout"><a href="#1-read-tcp-i-o-timeout" class="headerlink" title="(1) read tcp i/o timeout"></a>(1) read tcp i/o timeout</h2><pre class="line-numbers language-log" data-language="log"><code class="language-log">thrift server start  listened_addr<span class="token operator">:</span><span class="token number">8081</span>

<span class="token time number">17:22:14</span> error processing request<span class="token operator">:</span> read tcp <span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">8081</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">57899</span><span class="token operator">:</span> i<span class="token operator">/</span>o timeout
<span class="token time number">17:22:14</span> errmsg<span class="token operator">=</span>read tcp <span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">8081</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">57899</span><span class="token operator">:</span> i<span class="token operator">/</span>o timeout
<span class="token time number">17:22:14</span> error processing request<span class="token operator">:</span> read tcp <span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">8081</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">57899</span><span class="token operator">:</span> i<span class="token operator">/</span>o timeout

<span class="token time number">17:26:40</span> error processing request<span class="token operator">:</span> read tcp <span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">8081</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">59781</span><span class="token operator">:</span> i<span class="token operator">/</span>o timeout
<span class="token time number">17:26:40</span> error processing request<span class="token operator">:</span> read tcp <span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">8081</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">59781</span><span class="token operator">:</span> i<span class="token operator">/</span>o timeout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  server读数据超时</p>
<h2 id="write-broken-pipe"><a href="#write-broken-pipe" class="headerlink" title="write: broken pipe"></a>write: broken pipe</h2><pre class="line-numbers language-log" data-language="log"><code class="language-log">errmsg<span class="token operator">=</span>write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">57066</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">58842</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">50344</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">38252</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">22356</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">50002</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">32572</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">59450</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">59320</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">41668</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">36668</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">60856</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">49126</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">30506</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">55618</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">22438</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">43892</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe
<span class="token date number">2022/11/18</span> <span class="token time number">11:41:33</span> error processing request<span class="token operator">:</span> write tcp <span class="token ip-address constant">10.157.121.37</span><span class="token operator">:</span><span class="token number">8300</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">10.159.184.191</span><span class="token operator">:</span><span class="token number">26776</span><span class="token operator">:</span> write<span class="token operator">:</span> broken pipe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  这个问题比较有意思，client-&gt;server，client有连接池存了server的ip </p>
<h2 id="Incorrect-frame-size"><a href="#Incorrect-frame-size" class="headerlink" title="Incorrect frame size"></a>Incorrect frame size</h2><pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2022/11/18</span> <span class="token time number">14:46:43</span> error processing request<span class="token operator">:</span> Incorrect frame size <span class="token operator">(</span><span class="token number">1347375956</span><span class="token operator">)</span>
<span class="token date number">2022/11/18</span> <span class="token time number">14:46:43</span> error processing request<span class="token operator">:</span> Incorrect frame size <span class="token operator">(</span><span class="token number">1347375956</span><span class="token operator">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="connection-reset-by-peer"><a href="#connection-reset-by-peer" class="headerlink" title="connection reset by peer"></a>connection reset by peer</h2><pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2022/11/18</span> <span class="token time number">16:31:05</span> error processing request<span class="token operator">:</span> read tcp <span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">8081</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">62781</span><span class="token operator">:</span> read<span class="token operator">:</span> connection reset by peer

<span class="token date number">2022/11/18</span> <span class="token time number">16:31:14</span> error processing request<span class="token operator">:</span> read tcp <span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">8081</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">62635</span><span class="token operator">:</span> read<span class="token operator">:</span> connection reset by peer
<span class="token date number">2022/11/18</span> <span class="token time number">16:31:14</span> error processing request<span class="token operator">:</span> read tcp <span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">8081</span><span class="token operator">-</span><span class="token operator">></span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">62706</span><span class="token operator">:</span> read<span class="token operator">:</span> connection reset by peer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>  在thrift Server这边Debug时，client发送请求早已经超时断开，这个时候Server再往连接管道里写数据，就会报 <code>connection reset by peer</code></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/45194187">Apache Thrift系列详解(二) - 网络服务模型</a><br>[2] <a target="_blank" rel="noopener" href="https://xiaoyaozi.blog.csdn.net/article/details/42779915">由浅入深了解Thrift（三）——Thrift server端的几种工作模式分析</a><br>[3] <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/adee5315aedd">6.Thrift指南 thrift go源码解析 1</a><br>[4] <a target="_blank" rel="noopener" href="https://www.codelast.com/%E5%8E%9F%E5%88%9B%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89java%E7%89%88%E7%9A%84%E5%90%84%E7%A7%8Dthrift-server%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%AF%94%E8%BE%83/">[原创]（翻译）Java版的各种Thrift server实现的比较</a><br>[5] <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016250234">从网络IO到Thrift网络模型</a><br>[6] <a target="_blank" rel="noopener" href="https://juejin.cn/post/6968641908314751012">03. Apache thrift 之网络模型</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="WKQ 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="WKQ 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/go/" rel="tag"># go</a>
              <a href="/tags/thrift/" rel="tag"># thrift</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/07/10/thrift-client/" rel="prev" title="thrift客户端">
                  <i class="fa fa-chevron-left"></i> thrift客户端
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/07/16/thrift-processor/" rel="next" title="thrift TProcessor">
                  thrift TProcessor <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>
</div>
<div class="busuanzi-count">
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://unpkg.com/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
