<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"weikeqin.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="12-14，遇到了一次elasticsearch超时导致商城数十个服务(导购、营销、交易)延迟升高的事故。  从这次事故中，发现了很多由小问题叠加而导致的大事故的教训。  事故时长，数十分钟，影响订单量 xxx     (1) 事故描述  背景  12-13 运营在商城管理后台配置商品营销活动时有一个数字配置错误  12-14 15:00开始 因为昨天错误的商品营销活动配置，风控团队需要重新判">
<meta property="og:type" content="article">
<meta property="og:title" content="那些年在商城奋斗的光辉岁月 - elasticsearch查询超时事故">
<meta property="og:url" content="http://weikeqin.com/2020/12/20/elasticsearch-timeout-accidents/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="12-14，遇到了一次elasticsearch超时导致商城数十个服务(导购、营销、交易)延迟升高的事故。  从这次事故中，发现了很多由小问题叠加而导致的大事故的教训。  事故时长，数十分钟，影响订单量 xxx     (1) 事故描述  背景  12-13 运营在商城管理后台配置商品营销活动时有一个数字配置错误  12-14 15:00开始 因为昨天错误的商品营销活动配置，风控团队需要重新判">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/sub-order-count-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/item-detail-request-latency-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/shop-order-monitor-request-error-counter.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/shop-order-monitor-request-latency.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/user-tcp-socket-inuse-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/user-jvm-thread-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/es-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/es-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/leader-query-order-request-count-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/user-tcp-socket-inuse-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/shop-order-monitor-request-latency.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/shop-order-monitor-request-error-counter.png">
<meta property="article:published_time" content="2020-12-20T03:05:52.000Z">
<meta property="article:modified_time" content="2023-03-12T02:19:00.174Z">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="stability">
<meta property="article:tag" content="trade">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://weikeqin.com/img/business/stability/20201214/sub-order-count-monitor.png">

<link rel="canonical" href="http://weikeqin.com/2020/12/20/elasticsearch-timeout-accidents/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>那些年在商城奋斗的光辉岁月 - elasticsearch查询超时事故 | 天道酬勤</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113485469-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-113485469-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">天道酬勤</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/weikeqin" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/12/20/elasticsearch-timeout-accidents/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          那些年在商城奋斗的光辉岁月 - elasticsearch查询超时事故
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-20 11:05:52" itemprop="dateCreated datePublished" datetime="2020-12-20T11:05:52+08:00">2020-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-12 10:19:00" itemprop="dateModified" datetime="2023-03-12T10:19:00+08:00">2023-03-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/stability/" itemprop="url" rel="index"><span itemprop="name">stability</span></a>
                </span>
            </span>

          
            <span id="/2020/12/20/elasticsearch-timeout-accidents/" class="post-meta-item leancloud_visitors" data-flag-title="那些年在商城奋斗的光辉岁月 - elasticsearch查询超时事故" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/12/20/elasticsearch-timeout-accidents/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/12/20/elasticsearch-timeout-accidents/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>13 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>  12-14，遇到了一次elasticsearch超时导致商城数十个服务(导购、营销、交易)延迟升高的事故。<br>  从这次事故中，发现了很多由小问题叠加而导致的大事故的教训。<br>  事故时长，数十分钟，影响订单量 xxx</p>
<p>  <img alt="订单量统计" src="/img/business/stability/20201214/sub-order-count-monitor.png" width=20% align="center" /> <br></p>
<h1 id="1-事故描述"><a href="#1-事故描述" class="headerlink" title="(1) 事故描述"></a>(1) 事故描述</h1><p>  背景<br>  12-13 运营在<code>商城管理后台</code>配置<code>商品营销活动</code>时有一个数字配置错误<br>  12-14 15:00开始 因为昨天错误的商品营销活动配置，风控团队需要重新判断订单里的用户和团长是否触反作弊，然后回放<code>活动订单打标mq</code>，消费mq查订单时用到了订单宽表索引</p>
<span id="more"></span>

<h2 id="1-1-事故时间线"><a href="#1-1-事故时间线" class="headerlink" title="(1.1) 事故时间线"></a>(1.1) 事故时间线</h2><p>  12-14 16:46:00 es告警 cpu idle 低于40%<br>  12-14 16:54  团长端查不到订单数据，团长在app上疯狂重试，调用团长订单横幅数量暴增，大概是前1小时的7-10倍<br>  12-14 16:54  <code>订单宽表索引</code>查询量翻倍，es集群cpu基本被这个索引用掉</p>
<p>  12-14 16:56:00 es告警 cpu idle 低于20%<br>  12-14 16:56   es查询超时  <strong>事故发生</strong><br>  12-14 16:56  C端商城 用户登录、首页、搜索、标签、商详、下单 等接口延迟升高<br>  12-14 17:02  线下用户、BD、运营反馈 小程序下单异常、管理后台异常</p>
<!-- 
  16:56   用户登录、首页、搜索、标签、商详、用户绑定团长 等接口延迟升高
  16:56   下单延迟开始升高

  16:56   线下运营反馈 "团长管理后台某些功能显示服务器繁忙"
  17:02   线下BD反馈 "团长app 团长订单列表为空"
  17:03   线下运营反馈 "供应商后台看不到订单"
  17:04   线下运营反馈 "采购系统出现问题"
  17:06   线下运营反馈 "C端商城运营后台又崩溃了"
  17:10   线下BD反馈 "取货高峰期，团长端无法通过手机号后四位等信息搜索到顾客订单"
  17:11   线下BD反馈 "小程序下单出现异常"
--> 


<p>  12-14 17:09:00 调小es查询限流阈值  <strong>事故开始解决</strong><br>  12-14 18:22:00 关闭某个月的索引<br>  12-14 18:24    es集群 cpu idle 恢复到20%   <strong>事故解决</strong></p>
<!--
     2020-12-14 16:56  下单延迟开始升高

     2020-12-14 16:59  【下单】依赖方延迟变高 (用户，订单查询，团长信息查询)（1min中内超过3次集群最大延迟>=500ms）

     2020-12-14 17:02 【下单】依赖方延迟升高 （中台-下单)（1min中内超过3次集群最大延迟>=2000ms）

     2020-12-14 17:04 【下单】依赖方延迟变高 (用户，订单查询，团长信息查询)（1min中内超过3次集群最大延迟>=500ms）
-->

<!--
 商城服务总体时间线

    2020-12-14 16:56    商城侧多个服务 接收到报警，依赖方延迟变高   

                                      用户登录、用户绑定团长、首页、搜索、标签、商详、 选品查询标签延迟升高

    2020-12-14 16:58    huanghe-价格计算报警

    2020-12-14 16:59   shop-order 收到报警，依赖方延迟变高 

                                     下单延迟升高

    2020-12-14 17:02 价格计算收到报警 延迟升高

    2020-12-14 17:05 主搜标签接口  （葛晨鑫）怀疑是我们的锅，主动限流，问题并没有恢复

    2020-12-14 17:07 秒杀延迟恢复 

    2020-12-14 17:08 首页延迟恢复 价格计算延迟恢复 

    2020-12-14 17:10 用户登录、用户绑定团长 延迟恢复、订单列表延迟恢复 

    2020-12-14 17:12  下单延迟恢复 

    2020-12-14 17:13  标签中心-查询券的的接口 RT升高，主搜熔断

                                   查询新人活动的接口RT升高

                                   中台消费速度慢，ES索引里商品数据和数据库数据不一致 

   2020-12-14 17:20  商城M端  商品列表查询失败 

   2020-12-14 17:56  供应商查询服务恢复，商城M端商品列表恢复

   2020-12-14 18:21  ES负责人 尝试close cn_wujie_wide_trade_order_info_prod 的11月索引

   2020-12-14 18:35  ES CPU恢复

   2020-12-14 18:36  商详 延迟恢复    

-->


<!--

事故背景介绍
  1. 业务发展迅速，es物理机资源不够，未严格按照业务隔离es索引
  2. es查询未做限流
  3. 业务上未对接口做限流
  4. 事故前一天运营活动配置错误


  这个mq里只有子订单号，需要根据子订单号查询订单信息，查询订单信息用到了`订单宽表索引`，事故主角之一登场 

  mysql库(分身库) -> 发送活动订单打标mq消息-> 风控拿到订单号(再查订单信息，判断是否作弊单）-> 回调团长返回是否作弊


 2020-12-14 16:46:00 收到es集群告警电话，cpu idle 低于40% 告警 
 16:56:00 收到es集群第二次告警电话，再次登录查看发现cpu idle 基本到 20%
 17:09:00 对查询模板1（目前反馈查询耗最高cpu操作的模板）操作限流，反馈 CPU无明显回升
 17:16:00 继续改小限流值，单节点限制10QPS，效果不明显，反馈在查找其他查询频次较高的模板


 18:19:00 es团队提出关闭 cn_wujie_wide_trade_order_info_prod_2020-12 和 cn_wujie_wide_trade_order_info_prod_2020-11 两个分区，综合考虑影响面，同意关闭了 11月分区（不提供读写）

 18:22:00 运维操作关闭cn_wujie_wide_trade_order_info_prod_2020-11索引, 24分恢复到20%，26分恢复到50%，28分恢复到 80%

 18:30:00 外围系统正常流量进行，观察cpu基本稳定，接口成功率整体回升

 19:32:00 期间在群内和es运维同学讨论 集群短时间无法恢复原因及索引使用方式方法问题（反馈因为单节点限制10qps，一条复杂的查询耗时基本就到1s，几个请求进来就会把查询线程阻塞住，本次限流未起到保护集群的功能)


 C端故障时长：12min
 故障影响子订单全天占比：0.51%
 故障期间完单量下跌：44.9%

--> 

<h2 id="1-2-事故关键时间点"><a href="#1-2-事故关键时间点" class="headerlink" title="(1.2) 事故关键时间点"></a>(1.2) 事故关键时间点</h2><p>事故开始时间<br>事故发现时间  12-14 16:56<br>事故止损时间  12-14 17:09<br>事故解决时间  12-14 17:12<br>事故定位时间  </p>
<h2 id="1-3-事故影响"><a href="#1-3-事故影响" class="headerlink" title="(1.3) 事故影响"></a>(1.3) 事故影响</h2><p> C端故障时长：&gt;10min<br> 故障期间完单量下跌：44.9%</p>
<br>



<h1 id="2-事故时现象"><a href="#2-事故时现象" class="headerlink" title="(2) 事故时现象"></a>(2) 事故时现象</h1><h2 id="2-1-商城C端监控"><a href="#2-1-商城C端监控" class="headerlink" title="(2.1) 商城C端监控"></a>(2.1) 商城C端监控</h2><p>  <img src="" alt="登录监控报警"></p>
<p>  <img src="" alt="首页监控报警"></p>
<p>  <img src="" alt="类目监控报警"></p>
<p>  <img src="" alt="搜索监控报警"></p>
<p>  商品详情-平均延迟-监控<br>  <img alt="商品详情-平均延迟-监控" src="/img/business/stability/20201214/item-detail-request-latency-monitor.png" width=60% /> <br></p>
<p>  <img src="" alt="购物车监控报警">  </p>
<p>  交易-下单错误数监控<br>  <img alt="交易-下单延迟监控" src="/img/business/stability/20201214/shop-order-monitor-request-error-counter.png" width=60% /> <br></p>
<br>

<p>  交易-下单延迟监控<br>  <img alt="交易-下单延迟监控" src="/img/business/stability/20201214/shop-order-monitor-request-latency.png" width=60% /> </p>
<h2 id="2-2-用户中心监控"><a href="#2-2-用户中心监控" class="headerlink" title="(2.2) 用户中心监控"></a>(2.2) 用户中心监控</h2><p> 用户服务 TCP-socket-inuse 监控</p>
<p>  <img alt="用户服务 TCP-socket-inuse 监控" src="/img/business/stability/20201214/user-tcp-socket-inuse-monitor.png" width=60% /> <br></p>
<p> 用户服务 JVM线程数监控</p>
<p>  <img alt="用户服务 JVM线程数监控" src="/img/business/stability/20201214/user-jvm-thread-monitor.png" width=60% /> <br></p>
<h2 id="2-3-ES集群监控"><a href="#2-3-ES集群监控" class="headerlink" title="(2.3) ES集群监控"></a>(2.3) ES集群监控</h2><p>  <img alt="Elasticsearch集群监控" src="/img/business/stability/20201214/es-monitor.png" width=30% /> <br></p>
<br>


<h1 id="3-问题分析"><a href="#3-问题分析" class="headerlink" title="(3) 问题分析"></a>(3) 问题分析</h1><h2 id="3-1-事故直接原因"><a href="#3-1-事故直接原因" class="headerlink" title="(3.1) 事故直接原因"></a>(3.1) 事故直接原因</h2><ol>
<li>Elasticsearch集群查询延迟高</li>
<li>Elasticsearch集群查询延迟高导致用户服务查询延迟高</li>
<li>用户服务查询延迟高导致商城C端大部分服务查询延迟高</li>
<li>商城C端服务强依赖用户服务导致接口调用超时，用户无法正常使用</li>
</ol>
<br>



<h2 id="3-2-问题原因"><a href="#3-2-问题原因" class="headerlink" title="(3.2) 问题原因"></a>(3.2) 问题原因</h2><h3 id="3-2-1-为什么Elasticsearch集群查询延迟高"><a href="#3-2-1-为什么Elasticsearch集群查询延迟高" class="headerlink" title="(3.2.1) 为什么Elasticsearch集群查询延迟高?"></a>(3.2.1) 为什么Elasticsearch集群查询延迟高?</h3><p>  以前也在用Elasticsearch集群查询，延迟为什么不高？</p>
<ol>
<li>Elasticsearch索引认知及使用不当，查<code>订单宽表索引</code>会查询6-12月所有分片数据，导致Elasticsearch集群CPU使用率较高，最耗cpu的两个dsl语句，cpu占比为34% 和 17% 。</li>
<li>查询<code>订单宽表索引</code>，未做限流。</li>
<li>Elasticsearch集群没有熔断机制。</li>
<li>Elasticsearch集群未严格按照业务隔离索引。</li>
<li>Elasticsearch集群资源不足。</li>
<li>业务单量不断增长，Elasticsearch集群查询的流量也在自然增长。</li>
</ol>
<p>  Elasticsearch集群查询监控<br>  <img src="/img/business/stability/20201214/es-monitor.png" alt="Elasticsearch集群查询监控"></p>
<p>  团长横幅订单查询QPS是平时10倍<br>  <img src="/img/business/stability/20201214/leader-query-order-request-count-monitor.png" alt="团长横幅订单查询QPS是平时10倍"></p>
<br>


<h3 id="3-2-2-为什么用户服务查询延迟高？"><a href="#3-2-2-为什么用户服务查询延迟高？" class="headerlink" title="(3.2.2) 为什么用户服务查询延迟高？"></a>(3.2.2) 为什么用户服务查询延迟高？</h3><ol>
<li>用户服务离线部分用到了Elasticsearch查询，Elasticsearch查询延迟高，导致用户服务延迟升高。</li>
<li>调用方调用超时后重试，导致用户服务(在线部分)QPS翻倍。</li>
<li>用户服务未做限流。</li>
<li>用户服务<code>延迟升高</code>+<code>QPS翻倍</code>+<code>无限流</code>导致TCP连接数打满、JVM线程数打满(单机 200 -&gt; 640)、socket数增多。(单机 200左右 -&gt; 1000~1500)。</li>
<li>用户服务资源不足(TCP连接数、JVM线程数、socket数)导致延迟继续升高。</li>
<li>服务雪崩。</li>
</ol>
<p>  用户服务socket监控<br>  <img src="/img/business/stability/20201214/user-tcp-socket-inuse-monitor.png" alt="用户服务socket监控"></p>
<br>


<h3 id="3-2-3-为什么商城C端大部分服务查询延迟高？"><a href="#3-2-3-为什么商城C端大部分服务查询延迟高？" class="headerlink" title="(3.2.3) 为什么商城C端大部分服务查询延迟高？"></a>(3.2.3) 为什么商城C端大部分服务查询延迟高？</h3><ol>
<li><strong>当时</strong>商城C端所有服务都有校验用户逻辑，用到了用户服务。</li>
<li>用户服务查询延迟升高导致大部分服务延迟升高。</li>
<li>业务发展迅速+不够重视，<strong>当时</strong>商城大部分服务没来的及添加降级、熔断措施。</li>
<li>用户重试导致流量翻倍，进一步造成雪崩。</li>
</ol>
<p>  <img src="/img/business/stability/20201214/shop-order-monitor-request-latency.png" alt="交易系统-下单服务-延迟-监控"> </p>
<p>  <img src="/img/business/stability/20201214/shop-order-monitor-request-error-counter.png" alt="交易系统-下单服务-错误数-监控"></p>
<br>


<h3 id="3-2-4-为什么用户无法正常使用"><a href="#3-2-4-为什么用户无法正常使用" class="headerlink" title="(3.2.4) 为什么用户无法正常使用"></a>(3.2.4) 为什么用户无法正常使用</h3><ol>
<li><strong>当时</strong>商城C端所有服务强依赖用户服务，调用超时后直接返回网络错误。</li>
<li>商城C端大部分服务调用下游超时时间设置较大。</li>
</ol>
<br>


<h2 id="3-3-部分代码"><a href="#3-3-部分代码" class="headerlink" title="(3.3) 部分代码"></a>(3.3) 部分代码</h2><h3 id="3-3-1-RestHighLevelClient初始化"><a href="#3-3-1-RestHighLevelClient初始化" class="headerlink" title="(3.3.1) RestHighLevelClient初始化"></a>(3.3.1) RestHighLevelClient初始化</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.ip&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> esClientIp<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.port&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Integer</span> esClientPort<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.appid&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> esAppId<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.appsecret&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> appSecret<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.newtradeorderindex&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> tradeOrderNewIndex<span class="token punctuation">;</span> <span class="token comment">//新索引</span>

<span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

<span class="token comment">/**
 * 初始化
 */</span>
<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>
            <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>esClientIp<span class="token punctuation">,</span> esClientPort<span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setRequestConfigCallback</span><span class="token punctuation">(</span>builder <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">//连接超时（默认为1秒）</span>
                                <span class="token punctuation">.</span><span class="token function">setSocketTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//套接字超时（默认为30秒）</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setBasicAuth</span><span class="token punctuation">(</span>esAppId<span class="token punctuation">,</span> appSecret<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setMaxRetryTimeoutMillis</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token comment">//调整最大重试超时时间</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"ElasticSearchClient start: vip:&#123;&#125;, port:&#123;&#125;"</span><span class="token punctuation">,</span> esClientIp<span class="token punctuation">,</span> esClientPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> <code>RestHighLevelClient</code>里超时参数不合理  连接超时时间1s，socketTimeout 5s，最大重试超时时间5s<br>  超时时间过大，对elasticsearch压力也比较大，在高并发极端情况下，服务可能被拖垮。</p>
<br>



<h3 id="3-3-2-分页查询团长下所有用户的订单数据"><a href="#3-3-2-分页查询团长下所有用户的订单数据" class="headerlink" title="(3.3.2) 分页查询团长下所有用户的订单数据"></a>(3.3.2) 分页查询团长下所有用户的订单数据</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 分页查询团长下所有用户的订单数据
 * 一个团长类似一个菜鸟驿站
 * 
 * 类似MySQL  
 *     SELECT * 
 *     FROM order_table
 *     WHERE inviter_id = #&#123;uid&#125; 
 *     GROUP BY user_id 
 *     LIMIT #&#123;page&#125;*#&#123;pageSize&#125;,#&#123;pageSize&#125;
 *
 * 
 *
 * @param uid 邀请人uid
 * @param page 第几页
 * @param pageSize 一页多少条
 * @param isPromoter 是否是推广的
 * @return
 */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TuanUserInfoDTO</span><span class="token punctuation">></span></span> <span class="token function">getTuanUserInfos</span><span class="token punctuation">(</span><span class="token class-name">Long</span> uid<span class="token punctuation">,</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 聚合</span>
        <span class="token comment">// 按照user_id聚合</span>
        <span class="token class-name">TermsAggregationBuilder</span> aggregation <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"by_user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>applicationApolloConfig<span class="token punctuation">.</span><span class="token function">getMaxBucketSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">"sum_payment_money"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"pay_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">"sum_number"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"number"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 构造查询条件</span>
        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>aggregation<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 精确查询</span>
        <span class="token class-name">QueryBuilder</span> queryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"inviter_id"</span><span class="token punctuation">,</span> uid<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"inviter_type"</span><span class="token punctuation">,</span> <span class="token class-name">InviteTypeEnum</span><span class="token punctuation">.</span>PROMOTER<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mustNot</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mustNot</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>queryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 查询订单索引 (类似于MySQL里的订单表)</span>
        <span class="token comment">// 这块踩坑了  这个索引按照月分索引了，但是这儿直接用的 trade_order，会查询所有索引的数据</span>
        <span class="token comment">// 建议用 tradeOrderNewIndex + _yyyy_MM 这种格式 比如 trade_order_2022_12</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>tradeOrderNewIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送请求从elatsicsearch查询数据</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 查询结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TuanUserInfoDTO</span><span class="token punctuation">></span></span> tuanUserInfoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解析查询结果</span>
        <span class="token class-name">Terms</span> userIdTerms <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"by_user_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> userIdBucket <span class="token operator">:</span> userIdTerms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> userId <span class="token operator">=</span> userIdBucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 订单金额</span>
            <span class="token class-name">Sum</span> paymentMoneySum <span class="token operator">=</span> userIdBucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"sum_payment_money"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 订单个数</span>
            <span class="token class-name">Sum</span> numberSum <span class="token operator">=</span> userIdBucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"sum_number"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//单位分转元</span>
            <span class="token class-name">Double</span> amount <span class="token operator">=</span> paymentMoneySum<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
            <span class="token class-name">BigDecimal</span> am <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>amount<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Double</span> orderAmount <span class="token operator">=</span> numberSum<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">TuanUserInfoDTO</span> userInfoDTO <span class="token operator">=</span> <span class="token class-name">TuanUserInfoDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">amount</span><span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span>ROUND_HALF_UP<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orderAmount</span><span class="token punctuation">(</span>orderAmount<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tuanUserInfoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userInfoDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 排序</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>tuanUserInfoList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 查询到全量数据后手动分页  天才</span>
        <span class="token keyword">return</span> <span class="token function">getCurrentPageLists</span><span class="token punctuation">(</span>tuanUserInfoList<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addMsg</span><span class="token punctuation">(</span><span class="token string">"getTuanUserInfos error"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TuanUserInfoDTO</span><span class="token punctuation">></span></span> <span class="token function">getCurrentPageLists</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TuanUserInfoDTO</span><span class="token punctuation">></span></span> infos<span class="token punctuation">,</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>infos <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">int</span> totalInfoSize <span class="token operator">=</span> infos<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>totalInfoSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">int</span> totalPageSize <span class="token operator">=</span> totalInfoSize <span class="token operator">%</span> pageSize <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> totalInfoSize <span class="token operator">/</span> pageSize <span class="token operator">:</span> totalInfoSize <span class="token operator">/</span> pageSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>totalPageSize <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> page <span class="token operator">></span> totalPageSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> end <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>totalPageSize<span class="token punctuation">)</span> <span class="token operator">?</span> totalInfoSize <span class="token operator">:</span> page <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>
    <span class="token comment">// 集合切割</span>
    <span class="token keyword">return</span> infos<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  MySQL的GroupBy函数比较费内存和CPU<br>  elasticsearch的也一样，需要把查询结果排序，比较费CPU和内存，而且每次查询需要查询所有分片，分片越多，最终聚合的时候越费内存和CPU<br>  因为索引里的数据是不断增长的，这块会随着数据量的变大，耗费内存和CPU越多，查询也会变慢</p>
<p>  分页没有用es的排序分页，是查到所有结果后，用Java排序，再分页，天才呀。</p>
<p>  代码里在查询elasticsearch的时候没有指定排序，es会查询所有分片，把每个分片的查询结果获取到后然后才会聚合排序，应该先在每个分片排序过滤，然后再归并聚合排序过滤。</p>
<p>  代码里查询的时候没有指定 索引月份，会查询所有月份的订单索引，elasticsearch需要查询所有分片，从每个分片获取数据后聚合排序，特别耗费CPU和内存。</p>
<br>



<h3 id="3-3-2-查询团长一段时间内的订单量"><a href="#3-3-2-查询团长一段时间内的订单量" class="headerlink" title="(3.3.2) 查询团长一段时间内的订单量"></a>(3.3.2) 查询团长一段时间内的订单量</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 查询团长一段时间内的订单量
 *
 * @param leaderUid 团长id
 * @param startTime 开始时间
 * @param endTime 结束时间
 * @return
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getOrderCountByDevelop</span><span class="token punctuation">(</span><span class="token class-name">Long</span> leaderUid<span class="token punctuation">,</span> <span class="token class-name">String</span> startTime<span class="token punctuation">,</span> <span class="token class-name">String</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 查询订单索引 (类似于MySQL里的订单表)</span>
        <span class="token comment">// 这块踩坑了  这个索引按照月分索引了，但是这儿直接用的 trade_order，会查询所有索引的数据</span>
        <span class="token comment">// 建议用 tradeOrderNewIndex + _yyyy_MM 这种格式 比如 trade_order_2022_12</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>tradeOrderNewIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 聚合</span>
        <span class="token class-name">SumAggregationBuilder</span> sumAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">"orderCount"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"number"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>sumAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 范围查询</span>
        <span class="token class-name">QueryBuilder</span> rangeBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"create_time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 精确查询</span>
        <span class="token class-name">QueryBuilder</span> queryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"leader_uid"</span><span class="token punctuation">,</span> leaderUid<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"status_str"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>rangeBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>queryBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送请求从elatsicsearch查询数据</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 处理聚合结果</span>
        <span class="token class-name">Aggregations</span> agg <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ParsedSum</span> aggregation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ParsedSum</span><span class="token punctuation">)</span>agg<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取结果</span>
        <span class="token class-name">Double</span> dd <span class="token operator">=</span> aggregation<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dd<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"getOrderCountByDevelop error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  代码里查询的时候没有指定 索引月份，会查询所有月份的订单索引，elasticsearch需要查询所有分片，从每个分片获取数据后聚合排序，特别耗费CPU和内存。</p>
<br>



<h3 id="3-3-3-统计团长助手邀请的用户下单量和订单金额"><a href="#3-3-3-统计团长助手邀请的用户下单量和订单金额" class="headerlink" title="(3.3.3) 统计团长助手邀请的用户下单量和订单金额"></a>(3.3.3) 统计团长助手邀请的用户下单量和订单金额</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token comment">/**
 * 统计团长助手邀请的用户下单量和订单金额
 * 
 * @param leaderUid  团长uid
 * @param deputyUserId  助手用户uid
 * @param userIds  新用户id
 * @param startTime  开始时间
 * @param endTime  结束时间
 * @return
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StatOrderDTO</span><span class="token punctuation">></span></span> <span class="token function">statUsersPerformanceOfDeputyLeader</span><span class="token punctuation">(</span><span class="token class-name">Long</span> leaderUid<span class="token punctuation">,</span> <span class="token class-name">Long</span> deputyUserId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> userIds<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span> startTime<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">StatOrderDTO</span><span class="token punctuation">></span></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>userIds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 查询订单索引 (类似于MySQL里的订单表)</span>
        <span class="token comment">// 这块踩坑了  这个索引按照月分索引了，但是这儿直接用的 trade_order，会查询所有索引的数据</span>
        <span class="token comment">// 建议用 tradeOrderNewIndex + _yyyy_MM 这种格式 比如 trade_order_2022_12</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>tradeOrderNewIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//不获取具体的数据</span>

        <span class="token comment">// 聚合</span>
        <span class="token comment">// 按照user_id聚合</span>
        <span class="token class-name">TermsAggregationBuilder</span> groupByUserIdAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"by_user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executionHint</span><span class="token punctuation">(</span><span class="token string">"map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        groupByUserIdAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">"sum_number"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"number"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//组内求订单和</span>
        groupByUserIdAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">"sum_total_price"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"pay_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//组内求子订单支付和</span>

        <span class="token comment">// 范围查询</span>
        <span class="token class-name">RangeQueryBuilder</span> createTimeFilter <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"create_time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>startTime <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            createTimeFilter<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token class-name">DateTimeUtils</span><span class="token punctuation">.</span><span class="token function">formatLocalDateTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>endTime <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            createTimeFilter<span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token class-name">DateTimeUtils</span><span class="token punctuation">.</span><span class="token function">formatLocalDateTime</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 精确查询</span>
        <span class="token class-name">QueryBuilder</span> queryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"leader_uid"</span><span class="token punctuation">,</span> leaderUid<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termsQuery</span><span class="token punctuation">(</span><span class="token string">"group_status"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//状态 0.待付款 1.付款完成 2.订单超时关闭 6.已提货 11.已取消 12.预售成功 13.售后完成 14.预售未支付取消</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"inviter_type"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"inviter_id"</span><span class="token punctuation">,</span> deputyUserId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termsQuery</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userIds<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mustNot</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termsQuery</span><span class="token punctuation">(</span><span class="token string">"trade_after_sale_info_list.type"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token function">buildDistanceFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>createTimeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置查询语句</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>queryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置聚合</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>groupByUserIdAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 发送请求从elatsicsearch查询数据</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 处理结果</span>
        <span class="token class-name">Terms</span> terms <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"by_user_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> terms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 用户id</span>
            <span class="token class-name">String</span> userId <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 用户订单个数</span>
            <span class="token class-name">ParsedSum</span> sumNumber <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"sum_number"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 用户订单金额</span>
            <span class="token class-name">ParsedSum</span> sumTotalPrice <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"sum_total_price"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token class-name">StatOrderDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sumNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> sumNumber<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sumPayAmount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> sumTotalPrice<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"res_size=&#123;&#125;"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"statNewUsersPerformanceOfDeputyLeader dsl:&#123;&#125;"</span><span class="token punctuation">,</span> searchSourceBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ee<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ee<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  代码里查询的时候没有指定 索引月份，会查询所有月份的订单索引，elasticsearch需要查询所有分片，从每个分片获取数据后聚合排序，特别耗费CPU和内存。</p>
<br>



<h3 id="3-3-4-查询用户信息"><a href="#3-3-4-查询用户信息" class="headerlink" title="(3.3.4) 查询用户信息"></a>(3.3.4) 查询用户信息</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token comment">/**
 * 查询用户信息
 *
 * @param userInfoEsQueryDto
 * @param function
 * @param &lt;R>
 * @return
 */</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token class-name">UserInfoResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token class-name">UserInfoEsQueryDto</span> userInfoEsQueryDto<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">></span></span> function<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 对象转map</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> queryEsMap <span class="token operator">=</span> <span class="token class-name">BeanMapper</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>userInfoEsQueryDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">UserInfoResultDto</span> userInfoResultDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfoResultDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">></span></span> assembleOrderEsResDtoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询用户索引</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>userInfoEsIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token class-name">ElasticSearchFactory</span><span class="token punctuation">.</span><span class="token function">getClientInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getUidList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> uidArr <span class="token operator">=</span> userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getUidList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置路由</span>
            searchRequest<span class="token punctuation">.</span><span class="token function">routing</span><span class="token punctuation">(</span>uidArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getUseScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getUseScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getScrollId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 使用scroll遍历数据</span>
            <span class="token class-name">SearchScrollRequest</span> searchScrollRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchScrollRequest</span><span class="token punctuation">(</span>userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getScrollId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            searchScrollRequest<span class="token punctuation">.</span><span class="token function">scroll</span><span class="token punctuation">(</span>userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getScrollTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">scroll</span><span class="token punctuation">(</span>searchScrollRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 组装查询语句</span>
            <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token class-name">BuildUserInfoEsParamUtil</span><span class="token punctuation">.</span><span class="token function">transForEsParam</span><span class="token punctuation">(</span>queryEsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getUseScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getUseScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                searchRequest<span class="token punctuation">.</span><span class="token function">scroll</span><span class="token punctuation">(</span>userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getScrollTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// 发送请求从elatsicsearch查询数据</span>
            searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"UserInfoEsServiceImpl queryUserInfo esQuery=&#123;&#125;"</span><span class="token punctuation">,</span> searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            userInfoResultDto<span class="token punctuation">.</span><span class="token function">setScrollId</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getScrollId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfoEsQueryDto<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                userInfoResultDto<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ParsedCardinality</span><span class="token punctuation">)</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"distinct_group"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                userInfoResultDto<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> searchHit <span class="token operator">:</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                assembleOrderEsResDtoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TransRetrievalBeanUtil</span><span class="token punctuation">.</span><span class="token function">getEsBean</span><span class="token punctuation">(</span><span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> searchHit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//组装非group条件下的字段sum、distinct count的结果</span>
            <span class="token comment">//dealSumAndCountResult(orderEsQueryDto,searchResponse,retrievalResultDto);</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"queryUserInfo error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>function <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        userInfoResultDto<span class="token punctuation">.</span><span class="token function">setResultList</span><span class="token punctuation">(</span>assembleOrderEsResDtoList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>function<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        userInfoResultDto<span class="token punctuation">.</span><span class="token function">setResultList</span><span class="token punctuation">(</span>assembleOrderEsResDtoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"UserInfoEsServiceImpl queryUserInfo response=&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">convertToJson</span><span class="token punctuation">(</span>userInfoResultDto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userInfoResultDto<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  可以看到上面的代码里可能会涉及到聚合查询，比较耗费CPU和内存</p>
<!--

 

public class BuildUserInfoEsParamUtil extends TransEsUtil {
    public static final SortOrder ASC = SortOrder.ASC;
    public static final SortOrder DESC = SortOrder.DESC;


    private static Map<String, List<SortConvert>> sortByMap = Maps.newHashMap();
    private static Map<String, KeyConvert> esFields = Maps.newHashMap();
    private static Map<String, Boolean> noTransFieldMap = Maps.newHashMap();

    static {
        sortByMap.put("sort", Arrays.asList(new SortConvert("id", DESC)));
    }

    static {
        esFields.put("uid", new KeyConvert(TransEsUtil.CTYPE_ENUM, "uid"));
        esFields.put("uidList", new KeyConvert(TransEsUtil.CTYPE_ENUM, "uid"));
        esFields.put("unionId", new KeyConvert(TransEsUtil.CTYPE_ENUM, "union_id"));
        //esFields.put("idList",new KeyConvert(TransEsUtil.CTYPE_ENUM,"id"));
        esFields.put("id", new KeyConvert(TransEsUtil.CTYPE_ENUM, "id"));
        esFields.put("pid", new KeyConvert(TransEsUtil.CTYPE_ENUM, "pid"));
        esFields.put("status", new KeyConvert(TransEsUtil.CTYPE_ENUM, "status"));
    }

    static {
        noTransFieldMap.put("page", true);
        noTransFieldMap.put("size", true);
        noTransFieldMap.put("group", true);
        noTransFieldMap.put("groupSort", true);
        noTransFieldMap.put("filterQueryList", true);
        noTransFieldMap.put("groupPage", true);
        noTransFieldMap.put("groupSize", true);
        noTransFieldMap.put("sumFieldList", true);
        noTransFieldMap.put("countFieldList", true);
        noTransFieldMap.put("groupHit", true);
        noTransFieldMap.put("sumGroup", true);
    }

    public static KeyConvert getIndexColumn(String key) {
        return esFields.get(key);
    }

    /**
     * 将请求参数转换为es对应参数
     *
     * @param requstMap
     * @return
     */
    public static SearchSourceBuilder transForEsParam(Map<String, Object> requstMap) {
        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
        //默认按照 sort 升序排序
        searchSourceBuilder.sort(SortBuilders.fieldSort("id").order(SortOrder.DESC));

        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();
        Iterator<String> iterator = requstMap.keySet().iterator();
        while (iterator.hasNext()) {
            String key = iterator.next();
            // 需要过滤掉的字段（不用进行转换）
            if (noTransFieldMap.containsKey(key)) {
                continue;
            }
            if (key.equals("sort")) {
                // 排序
                orgBuildSort(searchSourceBuilder, requstMap.get(key));
                continue;
            }

            // 精确查询/等值查询
            QueryBuilder queryBuilder = TransEsUtil.transBuilder(key, requstMap.get(key), esFields.get(key));
            if (queryBuilder != null) {
                // 设置精确查询
                boolQueryBuilder.must(queryBuilder);
            }
        }

        // 设置查询语句
        searchSourceBuilder.query(boolQueryBuilder);
        // 聚合
        orgSumFilldBuilder(searchSourceBuilder, requstMap);
        // 去重求和
        orgCountFieldBuilder(searchSourceBuilder, requstMap);
        // 组装group参数
        orgGroupBuilder(searchSourceBuilder, requstMap);
        // 组装groupList参数
        orgGroupListBuilder(searchSourceBuilder, requstMap);
        // 组织filter参数
        orgFilterGroupBuilder(searchSourceBuilder, requstMap);
        // 组装页数和分页大小
        orgBuildPageAndSize(searchSourceBuilder, requstMap);
        // 设置要查询的字段
        setFetchSource(searchSourceBuilder, requstMap);
        return searchSourceBuilder;
    }

    /**
     * 单独请求结果中数据的单个字段累计值
     *
     * @param searchSourceBuilder
     * @param requestMap
     */
    public static void orgSumFilldBuilder(SearchSourceBuilder searchSourceBuilder, Map<String, Object> requestMap) {
        if (requestMap.containsKey("sumFieldList")) {
            List<String> sumFieldList = (List<String>) requestMap.get("sumFieldList");
            for (String field : sumFieldList) {
                // 聚合字段
                SumAggregationBuilder sumAggregationBuilder = AggregationBuilders.sum(String.format("%s_sumList", field)).field(field);
                // 设置聚合
                searchSourceBuilder.aggregation(sumAggregationBuilder);
            }
        }
    }

    /**
     * 单独请求结果中的数据的单个字段的distinct count 值
     *
     * @param searchSourceBuilder
     * @param requestMap
     */
    public static void orgCountFieldBuilder(SearchSourceBuilder searchSourceBuilder, Map<String, Object> requestMap) {
        if (requestMap.containsKey("countFieldList")) {
            List<String> countFieldList = (List<String>) requestMap.get("countFieldList");
            for (String field : countFieldList) {
                // 去重求和  count(distinct(*))
                CardinalityAggregationBuilder caggregation = AggregationBuilders.cardinality(String.format("%s_distinctList", field)).field(field);
                searchSourceBuilder.aggregation(caggregation);
            }
        }
    }

    /**
     * 分组聚合下的字段累计值 和 distinct count值
     *
     * @param searchSourceBuilder
     * @param requestMap
     */
    public static void orgGroupBuilder(SearchSourceBuilder searchSourceBuilder, Map<String, Object> requestMap) {
        if (requestMap.containsKey("group")) {
            TermsAggregationBuilder termAggregation = AggregationBuilders.terms("term_group").field(String.valueOf(requestMap.get("group"))).size(900000);
            if (requestMap.containsKey("groupSize")) {
                termAggregation.size((int) requestMap.get("groupSize"));
            }
            if (requestMap.containsKey("groupSort")) {
                String[] groupSortArr = String.valueOf(requestMap.get("groupSort")).split(" ");
                termAggregation.order(BucketOrder.aggregation(groupSortArr[0], "asc".equals(groupSortArr[1]) ? true : false));
            }
            if (requestMap.containsKey("groupHit")) {
                TopHitsAggregationBuilder topHitsAggregationBuilder = AggregationBuilders.topHits("topGroup").size(50);
                if (requestMap.containsKey("groupHitSize")) {
                    topHitsAggregationBuilder.size((int) requestMap.get("groupHitSize"));
                }

                termAggregation.subAggregation(topHitsAggregationBuilder);
            }
            if (requestMap.get("groupSumFieldList") != null) {
                List<String> sumFieldList = (List<String>) requestMap.get("groupSumFieldList");
                for (String field : sumFieldList) {
                    SumAggregationBuilder sumAggregationBuilder = AggregationBuilders.sum(String.format("%s_sumGroup", field)).field(field);
                    termAggregation.subAggregation(sumAggregationBuilder);
                }
            }
            if (requestMap.get("groupCountFieldList") != null) {
                List<String> countFieldList = (List<String>) requestMap.get("groupCountFieldList");
                for (String distinctCountGroup : countFieldList) {
                    CardinalityAggregationBuilder caggregation = AggregationBuilders.cardinality(String.format("%s_distinctGroup", distinctCountGroup)).field(distinctCountGroup);
                    termAggregation.subAggregation(caggregation);
                }
            }
            CardinalityAggregationBuilder caggregation = AggregationBuilders.cardinality("distinct_group").field(String.valueOf(requestMap.get("group")));  //avg_age 为子聚合名称，名称可随意, 只返回总数
            searchSourceBuilder.aggregation(caggregation);
            searchSourceBuilder.aggregation(termAggregation);
        }
    }

    public static void orgGroupListBuilder(SearchSourceBuilder searchSourceBuilder, Map<String, Object> requestMap) {
        if (!requestMap.containsKey("groupFieldList")) {
            return;
        }
        List<String> groupFieldList = (List<String>) requestMap.get("groupFieldList");

        //
        TermsAggregationBuilder firstAggregation = AggregationBuilders.terms(String.format("%s_group", groupFieldList.get(0))).field(String.valueOf(groupFieldList.get(0))).size(1000);
        //
        TermsAggregationBuilder nextAggregation = firstAggregation, lastAggregation = firstAggregation;
        boolean moreThanOne = false;
        if (CollectionUtils.size(groupFieldList) > 1) {
            moreThanOne = true;
            lastAggregation = AggregationBuilders.terms(String.format("%s_group", groupFieldList.get(groupFieldList.size() - 1))).field(groupFieldList.get(groupFieldList.size() - 1)).size(200);
            for (int i = 1; i < groupFieldList.size() - 1; i++) {
                TermsAggregationBuilder iterAggregation = AggregationBuilders.terms(String.format("%s_group", groupFieldList.get(i))).field(groupFieldList.get(i));
                nextAggregation.subAggregation(iterAggregation);
                nextAggregation = iterAggregation;
            }
        }
        if (requestMap.get("groupSumFieldList") != null) {
            List<String> sumFieldList = (List<String>) requestMap.get("groupSumFieldList");
            for (String field : sumFieldList) {
                SumAggregationBuilder sumAggregationBuilder = AggregationBuilders.sum(String.format("%s_sumGroup", field)).field(field);
                lastAggregation.subAggregation(sumAggregationBuilder);
            }
        }
        if (requestMap.get("groupCountFieldList") != null) {
            List<String> countFieldList = (List<String>) requestMap.get("groupCountFieldList");
            for (String distinctCountGroup : countFieldList) {
                CardinalityAggregationBuilder caggregation = AggregationBuilders.cardinality(String.format("%s_distinctGroup", distinctCountGroup)).field(distinctCountGroup);
                if (requestMap.get("groupCountFilterMinNum") != null) {
                    String distinctGroupStr = String.format("%s_distinctGroup", distinctCountGroup);
                    Map<String, String> bucketsPathsMap = new HashMap<>(8);
                    bucketsPathsMap.put(distinctGroupStr, distinctGroupStr);
                    Script script = new Script(String.format("params.%s >= %s", distinctGroupStr, (int) requestMap.get("groupCountFilterMinNum")));
                    BucketSelectorPipelineAggregationBuilder bs =
                            PipelineAggregatorBuilders.bucketSelector("having", bucketsPathsMap, script);
                    lastAggregation.subAggregation(bs);
                }
                lastAggregation.subAggregation(caggregation);
            }
        }

        if (moreThanOne) {
            nextAggregation.subAggregation(lastAggregation);
        }
        searchSourceBuilder.aggregation(firstAggregation);
    }


    public static void orgFilterGroupBuilder(SearchSourceBuilder searchSourceBuilder, Map<String, Object> requestMap) {
        if (!requestMap.containsKey("filterQueryList")) {
            return;
        }

        // 多个过滤条件
        List<Map<String, Object>> filterGroupList = (List<Map<String, Object>>) requestMap.get("filterQueryList");

        for (int i = 0; i < filterGroupList.size(); i++) {
            Map<String, Object> filterGroupMap = filterGroupList.get(i);
            // 一个过滤条件
            QueryBuilder queryBuilder = (QueryBuilder) filterGroupMap.get("filterQuery");
            // 过滤
            AggregationBuilder filterGroupBuilder = AggregationBuilders.filters("filterQuery" + (i + 1), queryBuilder);
            boolean totalFilterQuery = filterGroupMap.get("filterTotalQuery") != null && (Boolean) filterGroupMap.get("filterTotalQuery");
            if (totalFilterQuery) {
                if (filterGroupMap.get("filterSum") != null) {
                    List<String> sumFieldList = (List<String>) filterGroupMap.get("filterSum");
                    for (String field : sumFieldList) {
                        //
                        SumAggregationBuilder sumAggregationBuilder = AggregationBuilders.sum(String.format("%s_sumTotalFilterGroup", field)).field(field);
                        filterGroupBuilder.subAggregation(sumAggregationBuilder);
                    }
                }
                if (filterGroupMap.get("filterCount") != null) {
                    List<String> countFieldList = (List<String>) filterGroupMap.get("filterCount");
                    for (String distinctCountGroup : countFieldList) {
                        //
                        CardinalityAggregationBuilder caggregation = AggregationBuilders.cardinality(String.format("%s_distinctTotalFilterGroup", distinctCountGroup)).field(distinctCountGroup);
                        filterGroupBuilder.subAggregation(caggregation);
                    }
                }
            }

            if (StringUtils.isNotEmpty(String.valueOf(filterGroupMap.get("filterGroupField")))) {
                TermsAggregationBuilder filterTermAggregation = AggregationBuilders.terms("filter_term_group").field(String.valueOf(filterGroupMap.get("filterGroupField"))).size(900000);
                if (filterGroupMap.get("filterSum") != null) {
                    List<String> sumFieldList = (List<String>) filterGroupMap.get("filterSum");
                    for (String field : sumFieldList) {
                        SumAggregationBuilder sumAggregationBuilder = AggregationBuilders.sum(String.format("%s_sumFilterGroup", field)).field(field);
                        filterTermAggregation.subAggregation(sumAggregationBuilder);
                    }
                }
                if (filterGroupMap.get("filterCount") != null) {
                    List<String> countFieldList = (List<String>) filterGroupMap.get("filterCount");
                    for (String distinctCountGroup : countFieldList) {
                        CardinalityAggregationBuilder caggregation = AggregationBuilders.cardinality(String.format("%s_distinctFilterGroup", distinctCountGroup)).field(distinctCountGroup);
                        filterTermAggregation.subAggregation(caggregation);
                    }
                }
                filterGroupBuilder.subAggregation(filterTermAggregation);
            }

            searchSourceBuilder.aggregation(filterGroupBuilder);
        }

    }

    /**
     * 排序
     *
     * @param searchSourceBuilder
     * @param sortValue
     */
    public static void orgBuildSort(SearchSourceBuilder searchSourceBuilder, Object sortValue) {
        // 多字段排序
        for (String sortValueStr : sortValue.toString().split(",")) {
            // 排序的字段需要在配置的sortByMap内
            List<SortConvert> sortConvertList = sortByMap.get(sortValueStr);
            if (CollectionUtils.isNotEmpty(sortConvertList)) {
                for (SortConvert sortConvert : sortConvertList) {
                    // 设置排序
                    searchSourceBuilder.sort(SortBuilders.fieldSort(sortConvert.getEsKey()).unmappedType("integer").order(sortConvert.getSort()));
                }
            }
        }
    }

    public static void orgBuildPageAndSize(SearchSourceBuilder searchSourceBuilder, Map<String, Object> requestMap) {
        if (requestMap.containsKey("page") && requestMap.containsKey("size")) {
            // offset
            searchSourceBuilder.from(((int) requestMap.get("page") - 1) * (int) requestMap.get("size"));
            // size
            searchSourceBuilder.size((int) requestMap.get("size"));
        }
    }

    public static void setFetchSource(SearchSourceBuilder searchSourceBuilder, Map<String, Object> requestMap) {
        if (requestMap.containsKey("includeFields")) {
            // 要查询的字段
            List<String> includeFields = (List<String>) requestMap.get("includeFields");
            // 不查询的字段
            List<String> excludeFields = (List<String>) requestMap.get("excludeFields");
            searchSourceBuilder.fetchSource((String[]) includeFields.toArray(), CollectionUtils.isEmpty(excludeFields) ? new String[0] : (String[]) excludeFields.toArray());
        }
    }


    public static void main(String[] args) {
        Map<String, Object> requestMap = Maps.newHashMapWithExpectedSize(8);
        requestMap.put("createTime", "2020-10-28 00:00:00~2020-10-28 23:59:59");
        requestMap.put("queryType", 1);
        requestMap.put("groupFieldList", Arrays.asList("sku_id"));
        requestMap.put("groupCountFieldList", Arrays.asList("stock_name"));
        requestMap.put("groupCountFilterMinNum", 2);
        requestMap.put("page", 1);
        requestMap.put("size", 0);
        System.out.println(transForEsParam(requestMap));
    }

}
 

  这个是个组装查询语句的工具类，可以看到如果聚合查询的入参不为空，就会拼接对应的语句。



 
public class TransEsUtil {
    public static final Integer CTYPE_ENUM = 1;
    public static final Integer CTYPE_RANGE = 2;
    public static final Integer CTYPE_MAPPING = 3;
    public static final Integer CTYPE_REWRITE = 4;
    public static final Integer CTYPE_NOT_ENUM = 5;
    public static final Integer CITY_WILDWARD = 6;

    public static QueryBuilder transBuilder(String key, Object paramValue, KeyConvert keyConvert) {
        if (key == null || paramValue == null || keyConvert == null) {
            return null;
        }
        if (CTYPE_ENUM.equals(keyConvert.getConvertType())) {
            return transEnum(key, paramValue, keyConvert);
        } else if (CTYPE_RANGE.equals(keyConvert.getConvertType())) {
            QueryBuilder queryBuilder = transRange(key, paramValue, keyConvert);
            if (queryBuilder != null) {
                return queryBuilder;
            }
        } else if (CTYPE_MAPPING.equals(keyConvert.getConvertType())) {
            return transMapping(key, paramValue, keyConvert);
        } else if (CTYPE_REWRITE.equals(keyConvert.getConvertType())) {
            return transRewrite(key, paramValue, keyConvert);
        } else if (CTYPE_NOT_ENUM.equals(keyConvert.getConvertType())) {
            return transNotEnum(key, paramValue, keyConvert);
        } else if (CITY_WILDWARD.equals(keyConvert.getConvertType())) {
            return transWildWard(key, paramValue, keyConvert);
        }
        return null;
    }

    /**
     * 进行枚举类型的转换（格式为 key=value 或者 key=[v1,v2,v3...]这样格式
     *
     * @param key
     * @param value
     * @param keyConvert
     * @return
     */
    public static QueryBuilder transEnum(String key, Object value, KeyConvert keyConvert) {
        if (value instanceof List) {
            return QueryBuilders.termsQuery(keyConvert.getConvertToKey(), (List) value);
        } else if (String.valueOf(value).contains(",")) {
            List<String> splitVal = Arrays.asList(String.valueOf(value).split(","));
            return QueryBuilders.termsQuery(keyConvert.getConvertToKey(), splitVal);
        } else {
            return QueryBuilders.termQuery(keyConvert.getConvertToKey(), value);
        }
    }

    public static QueryBuilder transNotEnum(String key, Object value, KeyConvert keyConvert) {
        if (value instanceof List) {
            return QueryBuilders.boolQuery().mustNot(QueryBuilders.termQuery(keyConvert.getConvertToKey(), (List) value));
        } else if (String.valueOf(value).contains(",")) {
            List<String> splitVal = Arrays.asList(String.valueOf(value).split(","));
            return QueryBuilders.boolQuery().mustNot(QueryBuilders.termsQuery(keyConvert.getConvertToKey(), splitVal));
        } else {
            return QueryBuilders.boolQuery().mustNot(QueryBuilders.termQuery(keyConvert.getConvertToKey(), value));
        }
    }

    public static QueryBuilder transWildWard(String key, Object value, KeyConvert keyConvert) {
        if (key.equals("fuzzyPhone")) {
            return QueryBuilders.wildcardQuery(keyConvert.getConvertToKey(), String.format("*%s", value));
        } else {
            return QueryBuilders.wildcardQuery(keyConvert.getConvertToKey(), String.format("*%s*", value));
        }
    }

    /**
     * 对范围值进行转换（格式为 key=v1~v2 这样）
     *
     * @param key
     * @param value
     * @param keyConvert
     * @return
     */
    public static QueryBuilder transRange(String key, Object value, KeyConvert keyConvert) {
        List<QueryBuilder> queryBuilderList = new ArrayList<>();
        Iterable<String> splitValue = Splitter.on(",").split(String.valueOf(value));
        for (String item : splitValue) {
            String[] betweenValue = item.split("~");
            if (CollectionUtils.size(betweenValue) == 2) {
                Object min = StringUtils.isNotBlank(betweenValue[0]) ? (betweenValue[0].contains("-") ? betweenValue[0] : Long.parseLong(betweenValue[0])) : null;
                Object max = StringUtils.isNotBlank(betweenValue[1]) ? (betweenValue[1].contains("-") ? betweenValue[1] : Long.parseLong(betweenValue[1])) : null;
                if (min != null && max != null && min.equals(max)) {
                    queryBuilderList.add(QueryBuilders.termQuery(keyConvert.getConvertToKey(), max));
                } else {
                    queryBuilderList.add(QueryBuilders.rangeQuery(keyConvert.getConvertToKey()).gte(min).lte(max));
                }
            } else if (CollectionUtils.size(betweenValue) == 1) {
                Object itemValue = StringUtils.isNotBlank(betweenValue[0]) ? (betweenValue[0].contains("-") ? betweenValue[0] : Long.parseLong(betweenValue[0])) : null;
                if (item.indexOf("~") == 0) {
                    queryBuilderList.add(QueryBuilders.rangeQuery(keyConvert.getConvertToKey()).lte(itemValue));
                } else {
                    queryBuilderList.add(QueryBuilders.rangeQuery(keyConvert.getConvertToKey()).gte(itemValue));
                }
            }
        }
        if (CollectionUtils.isEmpty(queryBuilderList)) {
            return null;
        } else if (CollectionUtils.size(queryBuilderList) == 1) {
            return queryBuilderList.get(0);
        } else {
            BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();
            for (QueryBuilder queryBuilder : queryBuilderList) {
                boolQueryBuilder.should(queryBuilder);
            }
            return boolQueryBuilder;
        }
    }

    /**
     * 进行字段映射的转换，例如 bizType=100 转换为 offerType=1,5,33,37... 这样
     *
     * @param key
     * @param value
     * @param keyConvert
     * @return
     */
    public static QueryBuilder transMapping(String key, Object value, KeyConvert keyConvert) {
        Object transValue = keyConvert.getConvertValue().get(String.valueOf(value));
        if (transValue != null && transValue instanceof List) {
            return QueryBuilders.termsQuery(keyConvert.getConvertToKey(), (List) transValue);
        } else if (transValue != null) {
            return QueryBuilders.termQuery(keyConvert.getConvertToKey(), transValue);
        }
        return null;
    }

    /**
     * 进行字段值重写的转换，例如productLine=4 转换为 businessLine=4 && prime_b=true
     *
     * @param key
     * @param value
     * @param keyConvert
     * @return
     */
    public static QueryBuilder transRewrite(String key, Object value, KeyConvert keyConvert) {
        BoolQueryBuilder queryBuilder = QueryBuilders.boolQuery();
        Iterable<String> iterable = Splitter.on(",").split(String.valueOf(value));
        for (String item : iterable) {
            Object itemConverValue = null;
            if (keyConvert.getConvertValue().containsKey(item)) {
                itemConverValue = keyConvert.getConvertValue().get(item);
            } else {
                itemConverValue = keyConvert.getConvertValue().get("*");
            }
            if (itemConverValue == null) {
                continue;
            } else if (itemConverValue instanceof List) {
                BoolQueryBuilder subQueryBuilder = QueryBuilders.boolQuery();
                for (String itemValue : (List<String>) itemConverValue) {
                    subQueryBuilder.must(QueryBuilders.termQuery(itemValue.split(":")[0], itemValue.split(":")[1]));
                }
                queryBuilder.should(subQueryBuilder);
            } else {
                if (((String) itemConverValue).contains("|")) {
                    String[] splitItemArray = ((String) itemConverValue).split("\\|");
                    for (String splitItem : splitItemArray) {
                        queryBuilder.should(QueryBuilders.termQuery(splitItem.split(":")[0], (splitItem.split(":")[1].replace("{}", item))));
                    }
                } else {
                    queryBuilder.should(QueryBuilders.termQuery(((String) itemConverValue).split(":")[0], ((String) itemConverValue).split(":")[1].replace("{}", item)));
                }
            }
        }
        return queryBuilder;
    }
}


-->

<h2 id="3-4-总结"><a href="#3-4-总结" class="headerlink" title="(3.4) 总结"></a>(3.4) 总结</h2><ol>
<li>Elasticsearch索引认知及使用不当，查<code>订单宽表索引</code>会查询6-12月所有分片数据，导致Elasticsearch集群CPU使用率较高。</li>
<li>消费mq查询<code>订单宽表索引</code>未做限流。</li>
<li>Elasticsearch集群未严格按照业务隔离索引。</li>
<li>Elasticsearch物理机资源不够。</li>
<li>Elasticsearch集群缺乏治理工具。</li>
<li>用户服务当时未做限流、熔断、降级。</li>
<li>用户服务在线部分和离线部分没有隔离部署。</li>
<li>商城C端服务强依赖下游。</li>
<li>商城C端服务调用下游设置的超时时间较大。</li>
</ol>
<br>

 

<h1 id="4-思考"><a href="#4-思考" class="headerlink" title="(4) 思考"></a>(4) 思考</h1><h2 id="4-1-Elasticsearch索引认知及使用不当，为什么以前没出现问题？"><a href="#4-1-Elasticsearch索引认知及使用不当，为什么以前没出现问题？" class="headerlink" title="(4.1) Elasticsearch索引认知及使用不当，为什么以前没出现问题？"></a>(4.1) Elasticsearch索引认知及使用不当，为什么以前没出现问题？</h2><ol>
<li>C端在线部分查订单走的MySQL数据库，而且分库分表了，没有查es</li>
<li>团长查订单用到Elasticsearch，原来数据不多，查询量不大，所以没有问题。</li>
<li>es查询语句问题，原来没暴漏。</li>
<li>目前仅订单索引存在按照日期分区问题，其它索引没有。</li>
</ol>
<br>


<h2 id="4-2-收到es集群告警电话后，为什么没继续关注？"><a href="#4-2-收到es集群告警电话后，为什么没继续关注？" class="headerlink" title="(4.2) 收到es集群告警电话后，为什么没继续关注？"></a>(4.2) 收到es集群告警电话后，为什么没继续关注？</h2><ol>
<li>16:46:00 收到es集群告警电话，cpu idle 低于40% 告警，es运维人员登录集群查看一台机器的cpu 降低到35%左右，其余机器都在40%之上，整体和之前对比基本相同，看了2分钟未再降低，未继续关注；</li>
<li>16:56:00 收到es集群第二次告警电话，再次登录查看发现cpu idle 基本到 20% ,观察到17:02分左右，cpu有一些回升，不明显；</li>
</ol>
<br>


<h2 id="4-2-Elasticsearch集群查询延迟升高的直接触发原因？"><a href="#4-2-Elasticsearch集群查询延迟升高的直接触发原因？" class="headerlink" title="(4.2) Elasticsearch集群查询延迟升高的直接触发原因？"></a>(4.2) Elasticsearch集群查询延迟升高的直接触发原因？</h2><ol>
<li>es查询语句有性能问题</li>
<li>风控反作弊消费mq，查询<code>订单宽表索引</code>获取订单信息，占用了Elasticsearch集群 34% CPU</li>
<li>团长横幅订单查询 占用了Elasticsearch集群 17% CPU</li>
<li>16:54 团长的查询量翻了10倍，触发雪崩</li>
</ol>
<br>




<!--
二、原因分析 

1、资源不够
  目前橙心集群27台物理机，被划分为4个小集群，集群机器分布信息如下：
  (1）仿真10多个小索引，划分2台机器（因为主备最小占用2台）
  (2) 主子订单单独索引，划分6台机器
  (3) 团长小区/围栏信息查询，划分4台机器
  (4) 剩余索引公用剩余15台机器（前面尝试过划分更多独立集群，机器数量不够)

2、从16:54分开始，订单宽表索引 cn_wujie_wide_trade_order_info_prod 查询量激增，存在翻倍查询情况，整体集群 cpu 基本被这个索引占用掉；

3、最耗cpu的两个dsl语句，cpu占比为34% 和 17% ，主要对应的以下两个接口

  (3.1)  数据市场-根据子订单号查询订单信息（风控团队调用,上游业务是团长侧，监听 wj_activity_order_risk_prod 队列消息，后续了解是昨天业务活动配置错误，15-17点在进行消息回放，查询量增大)，对比以往同时间查询流量增长60% ，这个查询传递的时间范围是：2020-11-28 到2020-12-14 其实会查询6-12月所有分片数据。

  中台订单mq -》团长接收落mysql库(查询团长侧活动会给订单打标) -》 发送订单mq消息-》风控拿到订单号（查询GQL再拿订单信息，判断是否作弊单）-》回调团长返回是否作弊

  整体回溯子订单数量 187w

  (3.2)  数据市场-团长订单横幅数量（团长端调用)， 故障期间流量最高翻了约1000%，查询传递的时间范围是：2020-11-28 到2020-12-14 ，同上其实会查询6-12月所有分片数据


  综合分析：两个查询最耗cpu的接口，在故障时间点，均有放量请求导致cpu不够用，影响整体集群，(团长的查询量翻了10倍，个人认为不单单是重试放大造成的，里面应该也伴随着自然查询流量增长的情况）

-->

<!--
三、存在问题
1、es集群隔离问题：由于机器数的影响（有些核心索引 大小只有 几百M 或者 几个G，一个物理机都是几个T)，业务规划时进行物理隔离，但在实际操作时由于索引太小运维未隔离；

     解决方法： 再额外申请3台机器，将核心索引（用户、增长、商城）的索引先和订单的索引分离开；

2、es索引认知及使用层面问题： 索引按照创建时间分片，查询时传递创建时间认为会自动路由到对应时间的分片（例如 2020-11、2020-12分片），es运维同学昨天告知，单传递创建时间无用，仍会查询所有分片，只是其他分片查询查询不到数据，必须代码层面强制指定 索引名，例如 cn_wujie_wide_trade_order_info_prod_2020-12 这样

     昨晚紧急优化：对请求传递订单创建时间的查询（如判断为当月,则指定走当月的分片）---已完成

                              对请求时间范围存在跨月查询的情况，调整为2次查询，每次查询只查询一个月分片，由业务代码对接过进行聚合---待完成

3、熔断降级方案不完整： 故障发生期间外围重试流量在继续请求，对外提供的查询接口无法迅速进行降级，对自己的接口缺乏对应的保护机制；

4、对外暴露接口使用场景不了解： 现在的查询链路都比较长，对上层的业务、查询影响范围缺乏全面梳理；

5、es集群缺乏治理工具：发生问题完全依赖运维同学的处理速度，上层业务对es的流量来源、耗时CPU、查询模板等都无法立即感知；

-->

<!--
四、改进措施
1、es集群隔离问题： 目前已拉 用户/商城/增长-搜索 侧，独立申请机器构建集群，目前正和es运维同学就 qps、存储量级 评估机器数

2、使用层面优化： 就索引查询分片问题，梳理所有接口，对分片可支持的场景先进行替换，对单独分片无法支持的情况，考虑受限使用

3、构建其他数据源，减少es集群压力，例如ClickHouse-对实时性要求不高场景（分钟级别）,历史过往订单走hbase

4、接口降级熔断：对综合查询、数据时长所有接口添加熔断降级方案（本周内完成，如存在降级情况，和提前和业务放沟通）

5、查询QPS限制：梳理各接口可支持的QPS，对异步（可能MQ）查询的，协调业务方限制消费速率，给出参考值；
-->


<!--

 点击 https://im.xiaojukeji.com/channel?uid=188508&token=272ffabe7d1f93dd6cc71f55fa11c844&id=893304920706426880 ，加入D-Chat“五界-线上问题反馈群”

2020-12-14 16:56   团长管理后台，审核通过的团长无法激活，激活显示服务器繁忙，辛苦技术大佬们看下什么原因，城市：自贡、泸州、宜宾、内江
                               贵州这边也是
                               山东橙果之家后台崩溃了
2020-12-14 17:02   团长订单列表为空
                               成都团长端崩了
2020-12-14 17:03   未查询到用户信息

2020-12-14 17:03   供应商后台看不到订单
2020-12-14 17:04   采购系统也有问题
2020-12-14 17:06   橙果之家好了，商城运营后台又崩溃了
2020-12-14 17:07   稍等，现在es集群响应速度慢，正在处理
2020-12-14 17:09   登不上去了，陕西反馈
2020-12-14 17:10   团长端无法通过手机号后四位等信息搜索到顾客订单 取货高峰期，辛苦查一下原因
2020-12-14 17:11   小程序下单出现异常，请协助处理（团长大量反馈）
2020-12-14 17:12   大量团长反馈小程序客户端出现网络错误的提示，用户无法下单
2020-12-14 17:15   川东 这边 团长端 应该有问题 发不出到货通知和联系不到用户
2020-12-14 17:16   登录恢复
2020-12-14 17:16   上饶大面积出现问题： 团长后台看不到东西，订单界面不显示。
2020-12-14 17:16   海南地区供应商后台异常
2020-12-14 17:17   武汉，大面积团长端无法查看订单
                                团长端看不到订单，搜不了电话号码
2020-12-14 17:17   系统压力过大，目前正在恢复中。请稍后再试。
2020-12-14 17:19   点不了发货
2020-12-14 17:27   商城系统也没办法查询了
2020-12-14 17:28   供应商系统崩了
2020-12-14 17:32   供应商系已经恢复了吧 我看商品列表显示出来了
2020-12-14 17:35   团长端的问题什么时候可以处理好呢
2020-12-14 17:39   运营系统啥时候能恢复呀
2020-12-14 17:41   坐标：宜昌，注册团长的时候已经激活团长端显示API接口异常
2020-12-14 17:45   又挂了
2020-12-14 17:55  【故障通报】线上系统数据故障 
                                                    影响面：团长登录、供应商小程序查询，仓库收货
                                                    技术同学正在跟进，请不要在群内重复报问题
2020-12-14 18:55【通告】线上故障已恢复，对业务造成的影响非常抱歉，技术侧会进行针对性复盘和改造

-->


<!--
  [测试 ES集群超时事故复盘]( http://wiki.intra.xiaojukeji.com/pages/viewpage.action?pageId=507509051 )
  [综合 20201214 ES集群故障复盘]( http://wiki.intra.xiaojukeji.com/pages/viewpage.action?pageId=495420292 )
  [商城 2020-12-14 es故障导致多个服务异常复盘]( http://wiki.intra.xiaojukeji.com/pages/viewpage.action?pageId=494069863 )
-->


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/stability/" rel="tag"># stability</a>
              <a href="/tags/trade/" rel="tag"># trade</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/12/13/sentinel-slading-window/" rel="prev" title="Sentinel滑动窗口原理及源码解析">
      <i class="fa fa-chevron-left"></i> Sentinel滑动窗口原理及源码解析
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/12/21/goods-oversold/" rel="next" title="电商经历之令人头疼的商品库存超卖">
      电商经历之令人头疼的商品库存超卖 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E4%BA%8B%E6%95%85%E6%8F%8F%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">(1) 事故描述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E4%BA%8B%E6%95%85%E6%97%B6%E9%97%B4%E7%BA%BF"><span class="nav-number">1.1.</span> <span class="nav-text">(1.1) 事故时间线</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E4%BA%8B%E6%95%85%E5%85%B3%E9%94%AE%E6%97%B6%E9%97%B4%E7%82%B9"><span class="nav-number">1.2.</span> <span class="nav-text">(1.2) 事故关键时间点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E4%BA%8B%E6%95%85%E5%BD%B1%E5%93%8D"><span class="nav-number">1.3.</span> <span class="nav-text">(1.3) 事故影响</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E4%BA%8B%E6%95%85%E6%97%B6%E7%8E%B0%E8%B1%A1"><span class="nav-number">2.</span> <span class="nav-text">(2) 事故时现象</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E5%95%86%E5%9F%8EC%E7%AB%AF%E7%9B%91%E6%8E%A7"><span class="nav-number">2.1.</span> <span class="nav-text">(2.1) 商城C端监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83%E7%9B%91%E6%8E%A7"><span class="nav-number">2.2.</span> <span class="nav-text">(2.2) 用户中心监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-ES%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7"><span class="nav-number">2.3.</span> <span class="nav-text">(2.3) ES集群监控</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">(3) 问题分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E4%BA%8B%E6%95%85%E7%9B%B4%E6%8E%A5%E5%8E%9F%E5%9B%A0"><span class="nav-number">3.1.</span> <span class="nav-text">(3.1) 事故直接原因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"><span class="nav-number">3.2.</span> <span class="nav-text">(3.2) 问题原因</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-%E4%B8%BA%E4%BB%80%E4%B9%88Elasticsearch%E9%9B%86%E7%BE%A4%E6%9F%A5%E8%AF%A2%E5%BB%B6%E8%BF%9F%E9%AB%98"><span class="nav-number">3.2.1.</span> <span class="nav-text">(3.2.1) 为什么Elasticsearch集群查询延迟高?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E6%9F%A5%E8%AF%A2%E5%BB%B6%E8%BF%9F%E9%AB%98%EF%BC%9F"><span class="nav-number">3.2.2.</span> <span class="nav-text">(3.2.2) 为什么用户服务查询延迟高？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%95%86%E5%9F%8EC%E7%AB%AF%E5%A4%A7%E9%83%A8%E5%88%86%E6%9C%8D%E5%8A%A1%E6%9F%A5%E8%AF%A2%E5%BB%B6%E8%BF%9F%E9%AB%98%EF%BC%9F"><span class="nav-number">3.2.3.</span> <span class="nav-text">(3.2.3) 为什么商城C端大部分服务查询延迟高？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-4-%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8%E6%88%B7%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E4%BD%BF%E7%94%A8"><span class="nav-number">3.2.4.</span> <span class="nav-text">(3.2.4) 为什么用户无法正常使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E9%83%A8%E5%88%86%E4%BB%A3%E7%A0%81"><span class="nav-number">3.3.</span> <span class="nav-text">(3.3) 部分代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-RestHighLevelClient%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">3.3.1.</span> <span class="nav-text">(3.3.1) RestHighLevelClient初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E5%9B%A2%E9%95%BF%E4%B8%8B%E6%89%80%E6%9C%89%E7%94%A8%E6%88%B7%E7%9A%84%E8%AE%A2%E5%8D%95%E6%95%B0%E6%8D%AE"><span class="nav-number">3.3.2.</span> <span class="nav-text">(3.3.2) 分页查询团长下所有用户的订单数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-%E6%9F%A5%E8%AF%A2%E5%9B%A2%E9%95%BF%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%86%85%E7%9A%84%E8%AE%A2%E5%8D%95%E9%87%8F"><span class="nav-number">3.3.3.</span> <span class="nav-text">(3.3.2) 查询团长一段时间内的订单量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-%E7%BB%9F%E8%AE%A1%E5%9B%A2%E9%95%BF%E5%8A%A9%E6%89%8B%E9%82%80%E8%AF%B7%E7%9A%84%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E9%87%8F%E5%92%8C%E8%AE%A2%E5%8D%95%E9%87%91%E9%A2%9D"><span class="nav-number">3.3.4.</span> <span class="nav-text">(3.3.3) 统计团长助手邀请的用户下单量和订单金额</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-4-%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="nav-number">3.3.5.</span> <span class="nav-text">(3.3.4) 查询用户信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E6%80%BB%E7%BB%93"><span class="nav-number">3.4.</span> <span class="nav-text">(3.4) 总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E6%80%9D%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">(4) 思考</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Elasticsearch%E7%B4%A2%E5%BC%95%E8%AE%A4%E7%9F%A5%E5%8F%8A%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%BD%93%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BB%A5%E5%89%8D%E6%B2%A1%E5%87%BA%E7%8E%B0%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="nav-number">4.1.</span> <span class="nav-text">(4.1) Elasticsearch索引认知及使用不当，为什么以前没出现问题？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E6%94%B6%E5%88%B0es%E9%9B%86%E7%BE%A4%E5%91%8A%E8%AD%A6%E7%94%B5%E8%AF%9D%E5%90%8E%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%B2%A1%E7%BB%A7%E7%BB%AD%E5%85%B3%E6%B3%A8%EF%BC%9F"><span class="nav-number">4.2.</span> <span class="nav-text">(4.2) 收到es集群告警电话后，为什么没继续关注？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-Elasticsearch%E9%9B%86%E7%BE%A4%E6%9F%A5%E8%AF%A2%E5%BB%B6%E8%BF%9F%E5%8D%87%E9%AB%98%E7%9A%84%E7%9B%B4%E6%8E%A5%E8%A7%A6%E5%8F%91%E5%8E%9F%E5%9B%A0%EF%BC%9F"><span class="nav-number">4.3.</span> <span class="nav-text">(4.2) Elasticsearch集群查询延迟升高的直接触发原因？</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">318</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/weikeqin" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;weikeqin" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/u/0/107737814703120725006" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;u&#x2F;0&#x2F;107737814703120725006" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wkq278276130" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wkq278276130" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/keqin.wei.5" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;keqin.wei.5" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/8054088/wkq" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;8054088&#x2F;wkq" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'Ca876j76FoCQi1SShjT0qC6k-gzGzoHsz',
      appKey     : 'IeozLmM20GuvfcslfWgdNXP0',
      placeholder: "期待您的评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
