<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"weikeqin.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="(1) 事故时间线  12-13 运营在管理后台活动配置错误  12-14 15-17点 风控团队回放活动订单打标mq，重新消费mq判断订单里的用户和团长是否触反作弊   12-14 16:46:00 es告警 cpu idle 低于40%  12-14 16:54  团长端查不到订单数据，团长在app上疯狂重试，调用团长订单横幅数量暴增，大概是前1小时的7-10倍  12-14 16:54  订">
<meta property="og:type" content="article">
<meta property="og:title" content="那些年我们在商城奋斗的光辉岁月 - ElasticSearch查询超时事故">
<meta property="og:url" content="http://weikeqin.com/2020/12/20/elasticsearch-timeout-accidents/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="(1) 事故时间线  12-13 运营在管理后台活动配置错误  12-14 15-17点 风控团队回放活动订单打标mq，重新消费mq判断订单里的用户和团长是否触反作弊   12-14 16:46:00 es告警 cpu idle 低于40%  12-14 16:54  团长端查不到订单数据，团长在app上疯狂重试，调用团长订单横幅数量暴增，大概是前1小时的7-10倍  12-14 16:54  订">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/es-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/leader-query-order-request-count-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/user-tcp-socket-inuse-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/user-jvm-thread-monitor.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/shop-order-monitor-request-latency.png">
<meta property="og:image" content="http://weikeqin.com/img/business/stability/20201214/shop-order-monitor-request-error-counter.png">
<meta property="article:published_time" content="2020-12-20T03:05:52.000Z">
<meta property="article:modified_time" content="2023-02-12T11:06:15.048Z">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="stability">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://weikeqin.com/img/business/stability/20201214/es-monitor.png">


<link rel="canonical" href="http://weikeqin.com/2020/12/20/elasticsearch-timeout-accidents/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://weikeqin.com/2020/12/20/elasticsearch-timeout-accidents/","path":"2020/12/20/elasticsearch-timeout-accidents/","title":"那些年我们在商城奋斗的光辉岁月 - ElasticSearch查询超时事故"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>那些年我们在商城奋斗的光辉岁月 - ElasticSearch查询超时事故 | 天道酬勤</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113485469-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-113485469-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">天道酬勤</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E4%BA%8B%E6%95%85%E6%97%B6%E9%97%B4%E7%BA%BF"><span class="nav-number">1.</span> <span class="nav-text">(1) 事故时间线</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E4%BA%8B%E6%95%85%E5%BD%B1%E5%93%8D"><span class="nav-number">2.</span> <span class="nav-text">(2) 事故影响</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">(3) 问题分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E4%BA%8B%E6%95%85%E7%9B%B4%E6%8E%A5%E5%8E%9F%E5%9B%A0"><span class="nav-number">3.1.</span> <span class="nav-text">(3.1) 事故直接原因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"><span class="nav-number">3.2.</span> <span class="nav-text">(3.2) 问题原因</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-%E4%B8%BA%E4%BB%80%E4%B9%88Elasticsearch%E9%9B%86%E7%BE%A4%E6%9F%A5%E8%AF%A2%E5%BB%B6%E8%BF%9F%E9%AB%98"><span class="nav-number">3.2.1.</span> <span class="nav-text">(3.2.1) 为什么Elasticsearch集群查询延迟高?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E6%9F%A5%E8%AF%A2%E5%BB%B6%E8%BF%9F%E9%AB%98%EF%BC%9F"><span class="nav-number">3.2.2.</span> <span class="nav-text">(3.2.2) 为什么用户服务查询延迟高？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%95%86%E5%9F%8EC%E7%AB%AF%E5%A4%A7%E9%83%A8%E5%88%86%E6%9C%8D%E5%8A%A1%E6%9F%A5%E8%AF%A2%E5%BB%B6%E8%BF%9F%E9%AB%98%EF%BC%9F"><span class="nav-number">3.2.3.</span> <span class="nav-text">(3.2.3) 为什么商城C端大部分服务查询延迟高？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-4-%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8%E6%88%B7%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E4%BD%BF%E7%94%A8"><span class="nav-number">3.2.4.</span> <span class="nav-text">(3.2.4) 为什么用户无法正常使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E6%80%BB%E7%BB%93"><span class="nav-number">3.3.</span> <span class="nav-text">(3.3) 总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E6%80%9D%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">(4) 思考</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Elasticsearch%E7%B4%A2%E5%BC%95%E8%AE%A4%E7%9F%A5%E5%8F%8A%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%BD%93%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BB%A5%E5%89%8D%E6%B2%A1%E5%87%BA%E7%8E%B0%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="nav-number">4.1.</span> <span class="nav-text">(4.1) Elasticsearch索引认知及使用不当，为什么以前没出现问题？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E6%94%B6%E5%88%B0es%E9%9B%86%E7%BE%A4%E5%91%8A%E8%AD%A6%E7%94%B5%E8%AF%9D%E5%90%8E%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%B2%A1%E7%BB%A7%E7%BB%AD%E5%85%B3%E6%B3%A8%EF%BC%9F"><span class="nav-number">4.2.</span> <span class="nav-text">(4.2) 收到es集群告警电话后，为什么没继续关注？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-Elasticsearch%E9%9B%86%E7%BE%A4%E6%9F%A5%E8%AF%A2%E5%BB%B6%E8%BF%9F%E5%8D%87%E9%AB%98%E7%9A%84%E7%9B%B4%E6%8E%A5%E8%A7%A6%E5%8F%91%E5%8E%9F%E5%9B%A0%EF%BC%9F"><span class="nav-number">4.3.</span> <span class="nav-text">(4.2) Elasticsearch集群查询延迟升高的直接触发原因？</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">310</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/u/0/107737814703120725006" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;u&#x2F;0&#x2F;107737814703120725006" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wkq278276130" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wkq278276130" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/keqin.wei.5" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;keqin.wei.5" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/8054088/wkq" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;8054088&#x2F;wkq" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2020/12/20/elasticsearch-timeout-accidents/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="那些年我们在商城奋斗的光辉岁月 - ElasticSearch查询超时事故 | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          那些年我们在商城奋斗的光辉岁月 - ElasticSearch查询超时事故
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-20 11:05:52" itemprop="dateCreated datePublished" datetime="2020-12-20T11:05:52+08:00">2020-12-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-02-12 19:06:15" itemprop="dateModified" datetime="2023-02-12T19:06:15+08:00">2023-02-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/stability/" itemprop="url" rel="index"><span itemprop="name">stability</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="1-事故时间线"><a href="#1-事故时间线" class="headerlink" title="(1) 事故时间线"></a>(1) 事故时间线</h1><p>  12-13 运营在管理后台活动配置错误<br>  12-14 15-17点 风控团队回放<code>活动订单打标mq</code>，重新消费mq判断订单里的用户和团长是否触反作弊</p>
<p>  12-14 16:46:00 es告警 cpu idle 低于40%<br>  12-14 16:54  团长端查不到订单数据，团长在app上疯狂重试，调用团长订单横幅数量暴增，大概是前1小时的7-10倍<br>  12-14 16:54  <code>订单宽表索引</code>查询量翻倍，es集群cpu基本被这个索引用掉</p>
<p>  12-14 16:56:00 es告警 cpu idle 低于20%<br>  12-14 16:56   es查询超时  <strong>事故发生</strong><br>  12-14 16:56  C端商城 用户登录、首页、搜索、标签、商详、下单 等接口延迟升高<br>  12-14 17:02  线下用户、BD、运营反馈 小程序下单异常、管理后台异常</p>
<!-- 
  16:56   用户登录、首页、搜索、标签、商详、用户绑定团长 等接口延迟升高
  16:56   下单延迟开始升高

  16:56   线下运营反馈 "团长管理后台某些功能显示服务器繁忙"
  17:02   线下BD反馈 "团长app 团长订单列表为空"
  17:03   线下运营反馈 "供应商后台看不到订单"
  17:04   线下运营反馈 "采购系统出现问题"
  17:06   线下运营反馈 "C端商城运营后台又崩溃了"
  17:10   线下BD反馈 "取货高峰期，团长端无法通过手机号后四位等信息搜索到顾客订单"
  17:11   线下BD反馈 "小程序下单出现异常"
--> 


<p>  12-14 17:09:00 调小es查询限流阈值  <strong>事故开始解决</strong><br>  12-14 17:16:00 再次调小es查询限流阈值<br>  12-14 18:22:00 订单宽表索引按照月分片，关闭某个月的<code>订单宽表索引</code><br>  12-14 18:24    es集群 cpu idle 恢复到20%   <strong>事故解决</strong></p>
<!--
     2020-12-14 16:56  下单延迟开始升高

     2020-12-14 16:59  【下单】依赖方延迟变高 (用户，订单查询，团长信息查询)（1min中内超过3次集群最大延迟>=500ms）

     2020-12-14 17:02 【下单】依赖方延迟升高 （中台-下单)（1min中内超过3次集群最大延迟>=2000ms）

     2020-12-14 17:04 【下单】依赖方延迟变高 (用户，订单查询，团长信息查询)（1min中内超过3次集群最大延迟>=500ms）
-->

<!--
 商城服务总体时间线

    2020-12-14 16:56    商城侧多个服务 接收到报警，依赖方延迟变高   

                                      用户登录、用户绑定团长、首页、搜索、标签、商详、 选品查询标签延迟升高

    2020-12-14 16:58    huanghe-价格计算报警

    2020-12-14 16:59   shop-order 收到报警，依赖方延迟变高 

                                     下单延迟升高

    2020-12-14 17:02 价格计算收到报警 延迟升高

    2020-12-14 17:05 主搜标签接口  （葛晨鑫）怀疑是我们的锅，主动限流，问题并没有恢复

    2020-12-14 17:07 秒杀延迟恢复 

    2020-12-14 17:08 首页延迟恢复 价格计算延迟恢复 

    2020-12-14 17:10 用户登录、用户绑定团长 延迟恢复、订单列表延迟恢复 

    2020-12-14 17:12  下单延迟恢复 

    2020-12-14 17:13  标签中心-查询券的的接口 RT升高，主搜熔断

                                   查询新人活动的接口RT升高

                                   中台消费速度慢，ES索引里商品数据和数据库数据不一致 

   2020-12-14 17:20  商城M端  商品列表查询失败 

   2020-12-14 17:56  供应商查询服务恢复，商城M端商品列表恢复

   2020-12-14 18:21  ES负责人 尝试close cn_wujie_wide_trade_order_info_prod 的11月索引

   2020-12-14 18:35  ES CPU恢复

   2020-12-14 18:36  商详 延迟恢复    

-->


<!--

事故背景介绍
  1. 业务发展迅速，es物理机资源不够，未严格按照业务隔离es索引
  2. es查询未做限流
  3. 业务上未对接口做限流
  4. 事故前一天运营活动配置错误


  这个mq里只有子订单号，需要根据子订单号查询订单信息，查询订单信息用到了`订单宽表索引`，事故主角之一登场 

  mysql库(分身库) -> 发送活动订单打标mq消息-> 风控拿到订单号(再查订单信息，判断是否作弊单）-> 回调团长返回是否作弊


 2020-12-14 16:46:00 收到es集群告警电话，cpu idle 低于40% 告警 
 16:56:00 收到es集群第二次告警电话，再次登录查看发现cpu idle 基本到 20%
 17:09:00 对查询模板1（目前反馈查询耗最高cpu操作的模板）操作限流，反馈 CPU无明显回升
 17:16:00 继续改小限流值，单节点限制10QPS，效果不明显，反馈在查找其他查询频次较高的模板


 18:19:00 es团队提出关闭 cn_wujie_wide_trade_order_info_prod_2020-12 和 cn_wujie_wide_trade_order_info_prod_2020-11 两个分区，综合考虑影响面，同意关闭了 11月分区（不提供读写）

 18:22:00 运维操作关闭cn_wujie_wide_trade_order_info_prod_2020-11索引, 24分恢复到20%，26分恢复到50%，28分恢复到 80%

 18:30:00 外围系统正常流量进行，观察cpu基本稳定，接口成功率整体回升

 19:32:00 期间在群内和es运维同学讨论 集群短时间无法恢复原因及索引使用方式方法问题（反馈因为单节点限制10qps，一条复杂的查询耗时基本就到1s，几个请求进来就会把查询线程阻塞住，本次限流未起到保护集群的功能)


 C端故障时长：12min
 故障影响子订单全天占比：0.51%
 故障期间完单量下跌：44.9%

--> 


<h1 id="2-事故影响"><a href="#2-事故影响" class="headerlink" title="(2) 事故影响"></a>(2) 事故影响</h1><p> C端故障时长：&gt;10min<br> 故障期间完单量下跌：44.9%</p>
<br>


<h1 id="3-问题分析"><a href="#3-问题分析" class="headerlink" title="(3) 问题分析"></a>(3) 问题分析</h1><h2 id="3-1-事故直接原因"><a href="#3-1-事故直接原因" class="headerlink" title="(3.1) 事故直接原因"></a>(3.1) 事故直接原因</h2><ol>
<li>Elasticsearch集群查询延迟高</li>
<li>Elasticsearch集群查询延迟高导致用户服务查询延迟高</li>
<li>用户服务查询延迟高导致商城C端大部分服务查询延迟高</li>
<li>商城C端服务强依赖用户服务导致接口调用超时，用户无法正常使用</li>
</ol>
<h2 id="3-2-问题原因"><a href="#3-2-问题原因" class="headerlink" title="(3.2) 问题原因"></a>(3.2) 问题原因</h2><h3 id="3-2-1-为什么Elasticsearch集群查询延迟高"><a href="#3-2-1-为什么Elasticsearch集群查询延迟高" class="headerlink" title="(3.2.1) 为什么Elasticsearch集群查询延迟高?"></a>(3.2.1) 为什么Elasticsearch集群查询延迟高?</h3><p>  以前也在用Elasticsearch集群查询，延迟为什么不高？</p>
<ol>
<li>Elasticsearch索引认知及使用不当，查<code>订单宽表索引</code>会查询6-12月所有分片数据，导致Elasticsearch集群CPU使用率较高，最耗cpu的两个dsl语句，cpu占比为34% 和 17% 。</li>
<li>查询<code>订单宽表索引</code>，未做限流。</li>
<li>Elasticsearch集群没有熔断机制。</li>
<li>Elasticsearch集群未严格按照业务隔离索引。</li>
<li>Elasticsearch集群资源不足。</li>
<li>业务单量不断增长，Elasticsearch集群查询的流量也在自然增长。</li>
</ol>
<p>  <img src="/img/business/stability/20201214/es-monitor.png" alt="Elasticsearch集群订单宽表查询监控"></p>
<p>  <img src="/img/business/stability/20201214/leader-query-order-request-count-monitor.png" alt="团长横幅订单查询QPS是平时10倍"></p>
<h3 id="3-2-2-为什么用户服务查询延迟高？"><a href="#3-2-2-为什么用户服务查询延迟高？" class="headerlink" title="(3.2.2) 为什么用户服务查询延迟高？"></a>(3.2.2) 为什么用户服务查询延迟高？</h3><ol>
<li>用户服务离线部分用到了Elasticsearch查询，Elasticsearch查询延迟高，导致用户服务延迟升高。</li>
<li>调用方调用超时后重试，导致用户服务(在线部分)QPS翻倍。</li>
<li>用户服务未做限流。</li>
<li>用户服务<code>延迟升高</code>+<code>QPS翻倍</code>+<code>无限流</code>导致TCP连接数打满、JVM线程数打满(单机 200 -&gt; 640)、socket数增多。(单机 200左右 -&gt; 1000~1500)。</li>
<li>用户服务资源不足(TCP连接数、JVM线程数、socket数)导致延迟继续升高。</li>
<li>服务雪崩。</li>
</ol>
<p>  <img src="/img/business/stability/20201214/user-tcp-socket-inuse-monitor.png" alt="用户服务TCP-socket-inuse-监控"></p>
<p>  <img src="/img/business/stability/20201214/user-jvm-thread-monitor.png" alt="用户服务JVM线程数监控"></p>
<h3 id="3-2-3-为什么商城C端大部分服务查询延迟高？"><a href="#3-2-3-为什么商城C端大部分服务查询延迟高？" class="headerlink" title="(3.2.3) 为什么商城C端大部分服务查询延迟高？"></a>(3.2.3) 为什么商城C端大部分服务查询延迟高？</h3><ol>
<li><strong>当时</strong>商城C端所有服务都有校验用户逻辑，用到了用户服务。</li>
<li>用户服务查询延迟升高导致大部分服务延迟升高。</li>
<li>业务发展迅速+不够重视，<strong>当时</strong>商城大部分服务没来的及添加降级、熔断措施。</li>
<li>用户重试导致流量翻倍，进一步造成雪崩。</li>
</ol>
<p>  <img src="/img/business/stability/20201214/shop-order-monitor-request-latency.png" alt="交易系统-下单服务-延迟-监控"> </p>
<p>  <img src="/img/business/stability/20201214/shop-order-monitor-request-error-counter.png" alt="交易系统-下单服务-错误数-监控"></p>
<h3 id="3-2-4-为什么用户无法正常使用"><a href="#3-2-4-为什么用户无法正常使用" class="headerlink" title="(3.2.4) 为什么用户无法正常使用"></a>(3.2.4) 为什么用户无法正常使用</h3><ol>
<li><strong>当时</strong>商城C端所有服务强依赖用户服务，调用超时后直接返回网络错误。</li>
<li>商城C端大部分服务调用下游超时时间设置较大。</li>
</ol>
<h2 id="3-3-总结"><a href="#3-3-总结" class="headerlink" title="(3.3) 总结"></a>(3.3) 总结</h2><ol>
<li>Elasticsearch索引认知及使用不当，查<code>订单宽表索引</code>会查询6-12月所有分片数据，导致Elasticsearch集群CPU使用率较高。</li>
<li>消费mq查询<code>订单宽表索引</code>未做限流。</li>
<li>Elasticsearch集群未严格按照业务隔离索引。</li>
<li>Elasticsearch物理机资源不够。</li>
<li>Elasticsearch集群缺乏治理工具。</li>
<li>用户服务当时未做限流、熔断、降级。</li>
<li>用户服务在线部分和离线部分没有隔离部署。</li>
<li>商城C端服务强依赖下游。</li>
<li>商城C端服务调用下游设置的超时时间较大。</li>
</ol>
<h1 id="4-思考"><a href="#4-思考" class="headerlink" title="(4) 思考"></a>(4) 思考</h1><h2 id="4-1-Elasticsearch索引认知及使用不当，为什么以前没出现问题？"><a href="#4-1-Elasticsearch索引认知及使用不当，为什么以前没出现问题？" class="headerlink" title="(4.1) Elasticsearch索引认知及使用不当，为什么以前没出现问题？"></a>(4.1) Elasticsearch索引认知及使用不当，为什么以前没出现问题？</h2><ol>
<li>C端在线部分查订单走的数据库，只有离线部分和团长查订单用到Elasticsearch，原来的查询量不大。</li>
<li>目前仅订单索引存在按照日期分区问题，其它索引没有。</li>
</ol>
<br>


<h2 id="4-2-收到es集群告警电话后，为什么没继续关注？"><a href="#4-2-收到es集群告警电话后，为什么没继续关注？" class="headerlink" title="(4.2) 收到es集群告警电话后，为什么没继续关注？"></a>(4.2) 收到es集群告警电话后，为什么没继续关注？</h2><ol>
<li>16:46:00 收到es集群告警电话，cpu idle 低于40% 告警，登录集群查看一台机器的cpu 降低到35%左右，其余机器都在40%之上，整体和之前对比基本相同，看了2分钟未再降低，未继续关注；</li>
<li>16:56:00 收到es集群第二次告警电话，再次登录查看发现cpu idle 基本到 20% ,观察到17:02分左右，cpu有一些回升，不明显；</li>
</ol>
<br>


<h2 id="4-2-Elasticsearch集群查询延迟升高的直接触发原因？"><a href="#4-2-Elasticsearch集群查询延迟升高的直接触发原因？" class="headerlink" title="(4.2) Elasticsearch集群查询延迟升高的直接触发原因？"></a>(4.2) Elasticsearch集群查询延迟升高的直接触发原因？</h2><ol>
<li>风控反作弊消费mq，查询<code>订单宽表索引</code>获取订单信息，占用了Elasticsearch集群 34% CPU</li>
<li>团长横幅订单查询 占用了Elasticsearch集群 17% CPU</li>
<li>16:54 团长的查询量翻了10倍，触发雪崩</li>
</ol>
<br>




<!--
二、原因分析 

1、资源不够
  目前橙心集群27台物理机，被划分为4个小集群，集群机器分布信息如下：
  (1）仿真10多个小索引，划分2台机器（因为主备最小占用2台）
  (2) 主子订单单独索引，划分6台机器
  (3) 团长小区/围栏信息查询，划分4台机器
  (4) 剩余索引公用剩余15台机器（前面尝试过划分更多独立集群，机器数量不够)

2、从16:54分开始，订单宽表索引 cn_wujie_wide_trade_order_info_prod 查询量激增，存在翻倍查询情况，整体集群 cpu 基本被这个索引占用掉；

3、最耗cpu的两个dsl语句，cpu占比为34% 和 17% ，主要对应的以下两个接口

  (3.1)  数据市场-根据子订单号查询订单信息（风控团队调用,上游业务是团长侧，监听 wj_activity_order_risk_prod 队列消息，后续了解是昨天业务活动配置错误，15-17点在进行消息回放，查询量增大)，对比以往同时间查询流量增长60% ，这个查询传递的时间范围是：2020-11-28 到2020-12-14 其实会查询6-12月所有分片数据。

  中台订单mq -》团长接收落mysql库(查询团长侧活动会给订单打标) -》 发送订单mq消息-》风控拿到订单号（查询GQL再拿订单信息，判断是否作弊单）-》回调团长返回是否作弊

  整体回溯子订单数量 187w

  (3.2)  数据市场-团长订单横幅数量（团长端调用)， 故障期间流量最高翻了约1000%，查询传递的时间范围是：2020-11-28 到2020-12-14 ，同上其实会查询6-12月所有分片数据


  综合分析：两个查询最耗cpu的接口，在故障时间点，均有放量请求导致cpu不够用，影响整体集群，(团长的查询量翻了10倍，个人认为不单单是重试放大造成的，里面应该也伴随着自然查询流量增长的情况）

-->

<!--
三、存在问题
1、es集群隔离问题：由于机器数的影响（有些核心索引 大小只有 几百M 或者 几个G，一个物理机都是几个T)，业务规划时进行物理隔离，但在实际操作时由于索引太小运维未隔离；

     解决方法： 再额外申请3台机器，将核心索引（用户、增长、商城）的索引先和订单的索引分离开；

2、es索引认知及使用层面问题： 索引按照创建时间分片，查询时传递创建时间认为会自动路由到对应时间的分片（例如 2020-11、2020-12分片），es运维同学昨天告知，单传递创建时间无用，仍会查询所有分片，只是其他分片查询查询不到数据，必须代码层面强制指定 索引名，例如 cn_wujie_wide_trade_order_info_prod_2020-12 这样

     昨晚紧急优化：对请求传递订单创建时间的查询（如判断为当月,则指定走当月的分片）---已完成

                              对请求时间范围存在跨月查询的情况，调整为2次查询，每次查询只查询一个月分片，由业务代码对接过进行聚合---待完成

3、熔断降级方案不完整： 故障发生期间外围重试流量在继续请求，对外提供的查询接口无法迅速进行降级，对自己的接口缺乏对应的保护机制；

4、对外暴露接口使用场景不了解： 现在的查询链路都比较长，对上层的业务、查询影响范围缺乏全面梳理；

5、es集群缺乏治理工具：发生问题完全依赖运维同学的处理速度，上层业务对es的流量来源、耗时CPU、查询模板等都无法立即感知；

-->

<!--
四、改进措施
1、es集群隔离问题： 目前已拉 用户/商城/增长-搜索 侧，独立申请机器构建集群，目前正和es运维同学就 qps、存储量级 评估机器数

2、使用层面优化： 就索引查询分片问题，梳理所有接口，对分片可支持的场景先进行替换，对单独分片无法支持的情况，考虑受限使用

3、构建其他数据源，减少es集群压力，例如ClickHouse-对实时性要求不高场景（分钟级别）,历史过往订单走hbase

4、接口降级熔断：对综合查询、数据时长所有接口添加熔断降级方案（本周内完成，如存在降级情况，和提前和业务放沟通）

5、查询QPS限制：梳理各接口可支持的QPS，对异步（可能MQ）查询的，协调业务方限制消费速率，给出参考值；
-->


<!--

 点击 https://im.xiaojukeji.com/channel?uid=188508&token=272ffabe7d1f93dd6cc71f55fa11c844&id=893304920706426880 ，加入D-Chat“五界-线上问题反馈群”

2020-12-14 16:56   团长管理后台，审核通过的团长无法激活，激活显示服务器繁忙，辛苦技术大佬们看下什么原因，城市：自贡、泸州、宜宾、内江
                               贵州这边也是
                               山东橙果之家后台崩溃了
2020-12-14 17:02   团长订单列表为空
                               成都团长端崩了
2020-12-14 17:03   未查询到用户信息

2020-12-14 17:03   供应商后台看不到订单
2020-12-14 17:04   采购系统也有问题
2020-12-14 17:06   橙果之家好了，商城运营后台又崩溃了
2020-12-14 17:07   稍等，现在es集群响应速度慢，正在处理
2020-12-14 17:09   登不上去了，陕西反馈
2020-12-14 17:10   团长端无法通过手机号后四位等信息搜索到顾客订单 取货高峰期，辛苦查一下原因
2020-12-14 17:11   小程序下单出现异常，请协助处理（团长大量反馈）
2020-12-14 17:12   大量团长反馈小程序客户端出现网络错误的提示，用户无法下单
2020-12-14 17:15   川东 这边 团长端 应该有问题 发不出到货通知和联系不到用户
2020-12-14 17:16   登录恢复
2020-12-14 17:16   上饶大面积出现问题： 团长后台看不到东西，订单界面不显示。
2020-12-14 17:16   海南地区供应商后台异常
2020-12-14 17:17   武汉，大面积团长端无法查看订单
                                团长端看不到订单，搜不了电话号码
2020-12-14 17:17   系统压力过大，目前正在恢复中。请稍后再试。
2020-12-14 17:19   点不了发货
2020-12-14 17:27   商城系统也没办法查询了
2020-12-14 17:28   供应商系统崩了
2020-12-14 17:32   供应商系已经恢复了吧 我看商品列表显示出来了
2020-12-14 17:35   团长端的问题什么时候可以处理好呢
2020-12-14 17:39   运营系统啥时候能恢复呀
2020-12-14 17:41   坐标：宜昌，注册团长的时候已经激活团长端显示API接口异常
2020-12-14 17:45   又挂了
2020-12-14 17:55  【故障通报】线上系统数据故障 
                                                    影响面：团长登录、供应商小程序查询，仓库收货
                                                    技术同学正在跟进，请不要在群内重复报问题
2020-12-14 18:55【通告】线上故障已恢复，对业务造成的影响非常抱歉，技术侧会进行针对性复盘和改造

-->


<!--
  [测试 ES集群超时事故复盘]( http://wiki.intra.xiaojukeji.com/pages/viewpage.action?pageId=507509051 )
  [综合 20201214 ES集群故障复盘]( http://wiki.intra.xiaojukeji.com/pages/viewpage.action?pageId=495420292 )
  [商城 2020-12-14 es故障导致多个服务异常复盘]( http://wiki.intra.xiaojukeji.com/pages/viewpage.action?pageId=494069863 )
-->

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="WKQ 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="WKQ 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/stability/" rel="tag"># stability</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/12/13/sentinel-slading-window/" rel="prev" title="Sentinel滑动窗口原理及源码解析">
                  <i class="fa fa-chevron-left"></i> Sentinel滑动窗口原理及源码解析
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/12/21/goods-oversold/" rel="next" title="电商经历之令人头疼的商品库存超卖">
                  电商经历之令人头疼的商品库存超卖 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>
</div>
<div class="busuanzi-count">
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://unpkg.com/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
