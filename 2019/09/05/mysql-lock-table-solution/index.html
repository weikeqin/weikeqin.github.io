<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"weikeqin.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="前几天同事在晚上上线的时候执行sql语句造成锁表，想总结一下以避免后续发生。 (1)  遇到锁表快速解决办法　　依次执行1-6步，运行第6步生成的语句即可。 　　如果特别着急，运行 1  2  6 步 以及第6步生成的kill语句 即可。   第1步　查看表是否在使用。   show open tables where in_use &gt; 0 ;如果查询结果为空。则证明表没有在使用。结束。">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL 锁表后快速解决方法 及 MySQL中的锁">
<meta property="og:url" content="http://weikeqin.com/2019/09/05/mysql-lock-table-solution/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="前几天同事在晚上上线的时候执行sql语句造成锁表，想总结一下以避免后续发生。 (1)  遇到锁表快速解决办法　　依次执行1-6步，运行第6步生成的语句即可。 　　如果特别着急，运行 1  2  6 步 以及第6步生成的kill语句 即可。   第1步　查看表是否在使用。   show open tables where in_use &gt; 0 ;如果查询结果为空。则证明表没有在使用。结束。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-09-05T14:14:48.000Z">
<meta property="article:modified_time" content="2022-12-04T13:23:11.830Z">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://weikeqin.com/2019/09/05/mysql-lock-table-solution/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MySQL 锁表后快速解决方法 及 MySQL中的锁 | 天道酬勤</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113485469-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-113485469-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <script>
    !function(e,t,n,g,i){e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=('https:'==document.location.protocol?'https://':'http://')+g,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.growingio.com/2.1/gio.js","gio");
    gio('init', 'b1961366471d57d5', {});
    gio('send');
  </script>


  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">天道酬勤</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/weikeqin" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2019/09/05/mysql-lock-table-solution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL 锁表后快速解决方法 及 MySQL中的锁
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-05 22:14:48" itemprop="dateCreated datePublished" datetime="2019-09-05T22:14:48+08:00">2019-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-12-04 21:23:11" itemprop="dateModified" datetime="2022-12-04T21:23:11+08:00">2022-12-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          
            <span id="/2019/09/05/mysql-lock-table-solution/" class="post-meta-item leancloud_visitors" data-flag-title="MySQL 锁表后快速解决方法 及 MySQL中的锁" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/09/05/mysql-lock-table-solution/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/09/05/mysql-lock-table-solution/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>  前几天同事在晚上上线的时候执行sql语句造成锁表，想总结一下以避免后续发生。</p>
<h1 id="1-遇到锁表快速解决办法"><a href="#1-遇到锁表快速解决办法" class="headerlink" title="(1)  遇到锁表快速解决办法"></a>(1)  遇到锁表快速解决办法</h1><p>　　依次执行1-6步，运行第6步生成的语句即可。</p>
<p>　　如果特别着急，运行 1  2  6 步 以及第6步生成的kill语句 即可。  </p>
<p><strong>第1步　查看表是否在使用。</strong></p>
<blockquote>
<p> <code>show open tables where in_use &gt; 0 ;</code><br>如果查询结果为空。则证明表没有在使用。结束。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span>  <span class="token keyword">show</span> <span class="token keyword">open</span> <span class="token keyword">tables</span> <span class="token keyword">where</span> in_use <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">;</span>
Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p> 如果查询结果不为空，继续后续的步骤。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span>  <span class="token keyword">show</span> <span class="token keyword">open</span> <span class="token keyword">tables</span> <span class="token keyword">where</span> in_use <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+-------+--------+-------------+</span>
<span class="token operator">|</span> <span class="token keyword">Database</span> <span class="token operator">|</span> <span class="token keyword">Table</span> <span class="token operator">|</span> In_use <span class="token operator">|</span> Name_locked <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+-------+--------+-------------+</span>
<span class="token operator">|</span> test     <span class="token operator">|</span> t     <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+-------+--------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>　</p>
<p><strong>第2步　查看数据库当前的进程，看一下有无正在执行的慢SQL记录线程。</strong></p>
<blockquote>
<p> <code>show  processlist;</code><br> 注意：show processlist 是显示用户正在运行的线程，需要注意的是，除了 root 用户能看到所有正在运行的线程外，其他用户都只能看到自己正在运行的线程，看不到其它用户正在运行的线程。<br> SHOW PROCESSLIST shows which threads are running. If you have the PROCESS privilege, you can see all threads. Otherwise, you can see only your own threads (that is, threads associated with the MySQL account that you are using). If you do not use the FULL keyword, only the first 100 characters of each statement are shown in the Info field.
　</p>
</blockquote>
<p><strong>第3步　当前运行的所有事务</strong></p>
<blockquote>
<p><code>SELECT * FROM information_schema.INNODB_TRX;</code>
　</p>
</blockquote>
<p><strong>第4步　当前出现的锁</strong></p>
<blockquote>
<p><code>SELECT * FROM information_schema.INNODB_LOCKs;</code>
　</p>
</blockquote>
<p><strong>第5步　锁等待的对应关系</strong></p>
<blockquote>
<p><code>SELECT * FROM information_schema.INNODB_LOCK_waits;</code><br> 看事务表INNODB_TRX，里面是否有正在锁定的事务线程，看看ID是否在show processlist里面的sleep线程中，如果是，就证明这个sleep的线程事务一直没有commit或者rollback而是卡住了，我们需要手动kill掉。<br> 搜索的结果是在事务表发现了很多任务，这时候最好都kill掉。
　</p>
</blockquote>
<p><strong>第6步　批量删除事务表中的事务</strong></p>
<blockquote>
<p> 这里用的方法是：通过information_schema.processlist表中的连接信息生成需要处理掉的MySQL连接的语句临时文件，然后执行临时文件中生成的指令。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> concat<span class="token punctuation">(</span><span class="token string">'KILL '</span><span class="token punctuation">,</span>id<span class="token punctuation">,</span><span class="token string">';'</span><span class="token punctuation">)</span> 
<span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>processlist p 
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span>  information_schema<span class="token punctuation">.</span>INNODB_TRX x 
<span class="token keyword">ON</span> p<span class="token punctuation">.</span>id<span class="token operator">=</span>x<span class="token punctuation">.</span>trx_mysql_thread_id 
<span class="token keyword">WHERE</span> db<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p> 记得修改对应的数据库名。</p>
</blockquote>
<blockquote>
<p> 这个语句执行后结果如下：</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span>  <span class="token keyword">SELECT</span> concat<span class="token punctuation">(</span><span class="token string">'KILL '</span><span class="token punctuation">,</span>id<span class="token punctuation">,</span><span class="token string">';'</span><span class="token punctuation">)</span>  <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>processlist p  <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span>  information_schema<span class="token punctuation">.</span>INNODB_TRX x  <span class="token keyword">ON</span> p<span class="token punctuation">.</span>id<span class="token operator">=</span>x<span class="token punctuation">.</span>trx_mysql_thread_id  <span class="token keyword">WHERE</span> db<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------------+</span>
<span class="token operator">|</span> concat<span class="token punctuation">(</span><span class="token string">'KILL '</span><span class="token punctuation">,</span>id<span class="token punctuation">,</span><span class="token string">';'</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+</span>
<span class="token operator">|</span> <span class="token keyword">KILL</span> <span class="token number">42</span><span class="token punctuation">;</span>               <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">KILL</span> <span class="token number">40</span><span class="token punctuation">;</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p> 执行结果里的两个kill语句即可解决锁表。
　</p>
</blockquote>
<span id="more"></span>  
<p>　首先问几个问题：</p>
<ol>
<li>MySQL里有哪些锁？</li>
<li>如何造成锁表？</li>
<li>如何造成死锁？</li>
<li>全局锁加锁方法的执行命令是什么?主要的应用场景是什么?</li>
<li>做整库备份时为什么要加全局锁?</li>
<li>MySQL的自带备份工具, 使用什么参数可以确保一致性视图, 在什么场景下不适用?</li>
<li>不建议使用set global readonly = true的方法加全局锁有哪两点原因?</li>
<li>表级锁有哪两种类型? 各自的使用场景是什么?</li>
<li>MDL中读写锁之间的互斥关系怎样的?</li>
<li>如何安全的给小表增加字段?</li>
</ol>
<h1 id="2-思考总结"><a href="#2-思考总结" class="headerlink" title="(2) 思考总结"></a>(2) 思考总结</h1><blockquote>
<p> 自己创建了一个测试的表<code>t</code>，插入了两条数据。然后手动构造锁表和死锁模拟。<br> 测试的时候用的root用户测试</p>
</blockquote>
<blockquote>
<p> show processlist 是显示用户正在运行的线程，需要注意的是，除了 root 用户能看到所有正在运行的线程外，其他用户都只能看到自己正在运行的线程，看不到其它用户正在运行的线程。<br> SHOW PROCESSLIST shows which threads are running. If you have the PROCESS privilege, you can see all threads. Otherwise, you can see only your own threads (that is, threads associated with the MySQL account that you are using). If you do not use the FULL keyword, only the first 100 characters of each statement are shown in the Info field.</p>
</blockquote>
<h2 id="2-1-创建表t并插入2条数据"><a href="#2-1-创建表t并插入2条数据" class="headerlink" title="(2.1) 创建表t并插入2条数据"></a>(2.1) 创建表t并插入2条数据</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> 
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-2-准备多个shell模拟锁表"><a href="#2-2-准备多个shell模拟锁表" class="headerlink" title="(2.2) 准备多个shell模拟锁表"></a>(2.2) 准备多个shell模拟锁表</h2><pre><code>可以看到我打开三个shell，用root创建了三个连接，分别是 15  40  41 
</code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> processlist <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> <span class="token keyword">User</span>        <span class="token operator">|</span> Host            <span class="token operator">|</span> db   <span class="token operator">|</span> Command <span class="token operator">|</span> <span class="token keyword">Time</span> <span class="token operator">|</span> State                    <span class="token operator">|</span> Info             <span class="token operator">|</span> Progress <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> coordinator <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">shutdown</span> <span class="token keyword">handler</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">15</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">49914</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> Init                     <span class="token operator">|</span> <span class="token keyword">show</span> processlist <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token number">6</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span>
mysql<span class="token operator">></span> <span class="token keyword">show</span> processlist <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> <span class="token keyword">User</span>        <span class="token operator">|</span> Host            <span class="token operator">|</span> db   <span class="token operator">|</span> Command <span class="token operator">|</span> <span class="token keyword">Time</span> <span class="token operator">|</span> State                    <span class="token operator">|</span> Info             <span class="token operator">|</span> Progress <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> coordinator <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">shutdown</span> <span class="token keyword">handler</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">15</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">49914</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> Init                     <span class="token operator">|</span> <span class="token keyword">show</span> processlist <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">40</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">50872</span> <span class="token operator">|</span> test <span class="token operator">|</span> Sleep   <span class="token operator">|</span>   <span class="token number">41</span> <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token number">7</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span>
mysql<span class="token operator">></span> <span class="token keyword">show</span> processlist <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> <span class="token keyword">User</span>        <span class="token operator">|</span> Host            <span class="token operator">|</span> db   <span class="token operator">|</span> Command <span class="token operator">|</span> <span class="token keyword">Time</span> <span class="token operator">|</span> State                    <span class="token operator">|</span> Info             <span class="token operator">|</span> Progress <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> coordinator <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">shutdown</span> <span class="token keyword">handler</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">15</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">49914</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> Init                     <span class="token operator">|</span> <span class="token keyword">show</span> processlist <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">40</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">50872</span> <span class="token operator">|</span> test <span class="token operator">|</span> Sleep   <span class="token operator">|</span>   <span class="token number">64</span> <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">41</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">50888</span> <span class="token operator">|</span> test <span class="token operator">|</span> Sleep   <span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token number">8</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-3-模拟锁表"><a href="#2-3-模拟锁表" class="headerlink" title="(2.3) 模拟锁表"></a>(2.3) 模拟锁表</h2><p>  在第一个shell里观察</p>
<p>  在第二个shell里执行 <code>start transaction; delete from t where c=1 ;</code>  故意打开事务，然后执行语句不提交，占用写锁。</p>
<p>  在第三个shell里执行 <code>delete from t where c=1 ;</code> 执行删除语句，造成锁等待。</p>
<p>  这个时候 session3在等待session2释放写锁。</p>
<p>  如果再在 第三个shell里执行 <code>delete from t where c=2 ;</code></p>
<p>  在 第二个shell里执行 <code>delete from t where c=1 ;</code> </p>
<p>  就会相互等待，造成死锁。</p>
<h2 id="2-4-锁表后查看"><a href="#2-4-锁表后查看" class="headerlink" title="(2.4) 锁表后查看"></a>(2.4) 锁表后查看</h2><p>  然后在第一个shell里查看 </p>
<h3 id="2-4-1-查看是否锁表"><a href="#2-4-1-查看是否锁表" class="headerlink" title="(2.4.1)查看是否锁表"></a>(2.4.1)查看是否锁表</h3><p>  可以看到下面的查询语句有结果，确实是锁表了。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span>  <span class="token keyword">show</span> <span class="token keyword">open</span> <span class="token keyword">tables</span> <span class="token keyword">where</span> in_use <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+-------+--------+-------------+</span>
<span class="token operator">|</span> <span class="token keyword">Database</span> <span class="token operator">|</span> <span class="token keyword">Table</span> <span class="token operator">|</span> In_use <span class="token operator">|</span> Name_locked <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+-------+--------+-------------+</span>
<span class="token operator">|</span> test     <span class="token operator">|</span> t     <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+-------+--------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-4-2-查看数据库当前的进程"><a href="#2-4-2-查看数据库当前的进程" class="headerlink" title="(2.4.2) 查看数据库当前的进程"></a>(2.4.2) 查看数据库当前的进程</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> processlist <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+-------------------------+----------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> <span class="token keyword">User</span>        <span class="token operator">|</span> Host            <span class="token operator">|</span> db   <span class="token operator">|</span> Command <span class="token operator">|</span> <span class="token keyword">Time</span> <span class="token operator">|</span> State                    <span class="token operator">|</span> Info                    <span class="token operator">|</span> Progress <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+-------------------------+----------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>                    <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>                    <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> coordinator <span class="token operator">|</span> <span class="token boolean">NULL</span>                    <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>                    <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">shutdown</span> <span class="token keyword">handler</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>                    <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">15</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">49914</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> Init                     <span class="token operator">|</span> <span class="token keyword">show</span> processlist        <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">40</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">50872</span> <span class="token operator">|</span> test <span class="token operator">|</span> Sleep   <span class="token operator">|</span>   <span class="token number">15</span> <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token boolean">NULL</span>                    <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">41</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">50888</span> <span class="token operator">|</span> test <span class="token operator">|</span> Query   <span class="token operator">|</span>   <span class="token number">11</span> <span class="token operator">|</span> Updating                 <span class="token operator">|</span> <span class="token keyword">delete</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> c<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+-------------------------+----------+</span>
<span class="token number">8</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="2-4-3-当前运行的所有事务"><a href="#2-4-3-当前运行的所有事务" class="headerlink" title="(2.4.3) 当前运行的所有事务"></a>(2.4.3) 当前运行的所有事务</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span>  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>INNODB_TRX<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+------------------+----------------------------+</span>
<span class="token operator">|</span> trx_id <span class="token operator">|</span> trx_state <span class="token operator">|</span> trx_started         <span class="token operator">|</span> trx_requested_lock_id <span class="token operator">|</span> trx_wait_started    <span class="token operator">|</span> trx_weight <span class="token operator">|</span> trx_mysql_thread_id <span class="token operator">|</span> trx_query               <span class="token operator">|</span> trx_operation_state <span class="token operator">|</span> trx_tables_in_use <span class="token operator">|</span> trx_tables_locked <span class="token operator">|</span> trx_lock_structs <span class="token operator">|</span> trx_lock_memory_bytes <span class="token operator">|</span> trx_rows_locked <span class="token operator">|</span> trx_rows_modified <span class="token operator">|</span> trx_concurrency_tickets <span class="token operator">|</span> trx_isolation_level <span class="token operator">|</span> trx_unique_checks <span class="token operator">|</span> trx_foreign_key_checks <span class="token operator">|</span> trx_last_foreign_key_error <span class="token operator">|</span> trx_is_read_only <span class="token operator">|</span> trx_autocommit_non_locking <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+------------------+----------------------------+</span>
<span class="token operator">|</span> <span class="token number">23312</span>  <span class="token operator">|</span> <span class="token keyword">LOCK</span> WAIT <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">23</span>:<span class="token number">16</span>:<span class="token number">18</span> <span class="token operator">|</span> <span class="token number">23312</span>:<span class="token number">78</span>:<span class="token number">3</span>:<span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">23</span>:<span class="token number">16</span>:<span class="token number">18</span> <span class="token operator">|</span>          <span class="token number">2</span> <span class="token operator">|</span>                  <span class="token number">41</span> <span class="token operator">|</span> <span class="token keyword">delete</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> c<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">starting</span> <span class="token keyword">index</span> <span class="token keyword">read</span> <span class="token operator">|</span>                 <span class="token number">1</span> <span class="token operator">|</span>                 <span class="token number">1</span> <span class="token operator">|</span>                <span class="token number">2</span> <span class="token operator">|</span>                  <span class="token number">1136</span> <span class="token operator">|</span>               <span class="token number">1</span> <span class="token operator">|</span>                 <span class="token number">0</span> <span class="token operator">|</span>                       <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span>     <span class="token operator">|</span>                 <span class="token number">1</span> <span class="token operator">|</span>                      <span class="token number">1</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>                       <span class="token operator">|</span>                <span class="token number">0</span> <span class="token operator">|</span>                          <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">23311</span>  <span class="token operator">|</span> RUNNING   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">23</span>:<span class="token number">16</span>:<span class="token number">13</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>                  <span class="token operator">|</span> <span class="token boolean">NULL</span>                <span class="token operator">|</span>          <span class="token number">3</span> <span class="token operator">|</span>                  <span class="token number">40</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>                    <span class="token operator">|</span> <span class="token boolean">NULL</span>                <span class="token operator">|</span>                 <span class="token number">0</span> <span class="token operator">|</span>                 <span class="token number">1</span> <span class="token operator">|</span>                <span class="token number">2</span> <span class="token operator">|</span>                  <span class="token number">1136</span> <span class="token operator">|</span>               <span class="token number">3</span> <span class="token operator">|</span>                 <span class="token number">1</span> <span class="token operator">|</span>                       <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span>     <span class="token operator">|</span>                 <span class="token number">1</span> <span class="token operator">|</span>                      <span class="token number">1</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>                       <span class="token operator">|</span>                <span class="token number">0</span> <span class="token operator">|</span>                          <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+------------------+----------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-4-4-当前出现的锁"><a href="#2-4-4-当前出现的锁" class="headerlink" title="(2.4.4) 当前出现的锁"></a>(2.4.4) 当前出现的锁</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span>  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>INNODB_LOCKs<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="token operator">|</span> lock_id      <span class="token operator">|</span> lock_trx_id <span class="token operator">|</span> lock_mode <span class="token operator">|</span> lock_type <span class="token operator">|</span> lock_table <span class="token operator">|</span> lock_index <span class="token operator">|</span> lock_space <span class="token operator">|</span> lock_page <span class="token operator">|</span> lock_rec <span class="token operator">|</span> lock_data <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="token operator">|</span> <span class="token number">23312</span>:<span class="token number">78</span>:<span class="token number">3</span>:<span class="token number">2</span> <span class="token operator">|</span> <span class="token number">23312</span>       <span class="token operator">|</span> X         <span class="token operator">|</span> RECORD    <span class="token operator">|</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span>         <span class="token number">78</span> <span class="token operator">|</span>         <span class="token number">3</span> <span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">23311</span>:<span class="token number">78</span>:<span class="token number">3</span>:<span class="token number">2</span> <span class="token operator">|</span> <span class="token number">23311</span>       <span class="token operator">|</span> X         <span class="token operator">|</span> RECORD    <span class="token operator">|</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span>         <span class="token number">78</span> <span class="token operator">|</span>         <span class="token number">3</span> <span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-4-5-锁等待的对应关系"><a href="#2-4-5-锁等待的对应关系" class="headerlink" title="(2.4.5) 锁等待的对应关系"></a>(2.4.5) 锁等待的对应关系</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span>  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>INNODB_LOCK_waits<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------------+------------------+</span>
<span class="token operator">|</span> requesting_trx_id <span class="token operator">|</span> requested_lock_id <span class="token operator">|</span> blocking_trx_id <span class="token operator">|</span> blocking_lock_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------------+------------------+</span>
<span class="token operator">|</span> <span class="token number">23312</span>             <span class="token operator">|</span> <span class="token number">23312</span>:<span class="token number">78</span>:<span class="token number">3</span>:<span class="token number">2</span>      <span class="token operator">|</span> <span class="token number">23311</span>           <span class="token operator">|</span> <span class="token number">23311</span>:<span class="token number">78</span>:<span class="token number">3</span>:<span class="token number">2</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------------+------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-4-6-删除事务表中的事务"><a href="#2-4-6-删除事务表中的事务" class="headerlink" title="(2.4.6) 删除事务表中的事务"></a>(2.4.6) 删除事务表中的事务</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span>   <span class="token keyword">SELECT</span>   p<span class="token punctuation">.</span>id<span class="token punctuation">,</span>   p<span class="token punctuation">.</span><span class="token keyword">time</span><span class="token punctuation">,</span>         i<span class="token punctuation">.</span>trx_id<span class="token punctuation">,</span>       i<span class="token punctuation">.</span>trx_state<span class="token punctuation">,</span>    p<span class="token punctuation">.</span>info <span class="token keyword">FROM</span>     INFORMATION_SCHEMA<span class="token punctuation">.</span>PROCESSLIST p<span class="token punctuation">,</span>       INFORMATION_SCHEMA<span class="token punctuation">.</span>INNODB_TRX  i <span class="token keyword">WHERE</span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> i<span class="token punctuation">.</span>trx_mysql_thread_id    <span class="token operator">AND</span> i<span class="token punctuation">.</span>trx_state <span class="token operator">=</span> <span class="token string">'LOCK WAIT'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+--------+-----------+-------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> <span class="token keyword">time</span> <span class="token operator">|</span> trx_id <span class="token operator">|</span> trx_state <span class="token operator">|</span> info                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+--------+-----------+-------------------------+</span>
<span class="token operator">|</span> <span class="token number">41</span> <span class="token operator">|</span>   <span class="token number">27</span> <span class="token operator">|</span> <span class="token number">23312</span>  <span class="token operator">|</span> <span class="token keyword">LOCK</span> WAIT <span class="token operator">|</span> <span class="token keyword">delete</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> c<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+--------+-----------+-------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-4-7-kill掉锁表的语句"><a href="#2-4-7-kill掉锁表的语句" class="headerlink" title="(2.4.7) kill掉锁表的语句"></a>(2.4.7) kill掉锁表的语句</h3><p>  这儿有两种观点，一种是只kill掉后面等待的那个语句。还有一种是把两个语句都kill掉。这个根据实际情况处理。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">kill</span> <span class="token number">41</span> <span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span>   <span class="token keyword">SELECT</span>   p<span class="token punctuation">.</span>id<span class="token punctuation">,</span>   p<span class="token punctuation">.</span><span class="token keyword">time</span><span class="token punctuation">,</span>         i<span class="token punctuation">.</span>trx_id<span class="token punctuation">,</span>       i<span class="token punctuation">.</span>trx_state<span class="token punctuation">,</span>    p<span class="token punctuation">.</span>info <span class="token keyword">FROM</span>     INFORMATION_SCHEMA<span class="token punctuation">.</span>PROCESSLIST p<span class="token punctuation">,</span>       INFORMATION_SCHEMA<span class="token punctuation">.</span>INNODB_TRX  i <span class="token keyword">WHERE</span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> i<span class="token punctuation">.</span>trx_mysql_thread_id    <span class="token operator">AND</span> i<span class="token punctuation">.</span>trx_state <span class="token operator">=</span> <span class="token string">'LOCK WAIT'</span><span class="token punctuation">;</span>
Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  杀掉41</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> processlist <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> <span class="token keyword">User</span>        <span class="token operator">|</span> Host            <span class="token operator">|</span> db   <span class="token operator">|</span> Command <span class="token operator">|</span> <span class="token keyword">Time</span> <span class="token operator">|</span> State                    <span class="token operator">|</span> Info             <span class="token operator">|</span> Progress <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> coordinator <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">purge</span> worker      <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> system <span class="token keyword">user</span> <span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Daemon  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token keyword">InnoDB</span> <span class="token keyword">shutdown</span> <span class="token keyword">handler</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">15</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">49914</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> Init                     <span class="token operator">|</span> <span class="token keyword">show</span> processlist <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">40</span> <span class="token operator">|</span> root        <span class="token operator">|</span> localhost:<span class="token number">50872</span> <span class="token operator">|</span> test <span class="token operator">|</span> Sleep   <span class="token operator">|</span>   <span class="token number">56</span> <span class="token operator">|</span>                          <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>    <span class="token number">0.000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
<span class="token number">7</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  然后到第3个shell窗口查看，可以看到</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">delete</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> c<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">;</span>
ERROR <span class="token number">1205</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>  因为第3个shell里执行的语句被kill掉了。</p>
<p>  到这儿可以看到死锁解决了。</p>
<p>  但其实有个问题。第3个shell里的语句被kill掉了。但第2个shell里的语句还在执行。如果第二个shell里的事务不提交或者kill，在第3个shell里执行删除语句还会造成锁等待。</p>
<p>  第二种观点的办法  </p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	p<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
	p<span class="token punctuation">.</span><span class="token keyword">time</span><span class="token punctuation">,</span>
	x<span class="token punctuation">.</span>trx_id<span class="token punctuation">,</span>
	x<span class="token punctuation">.</span>trx_state<span class="token punctuation">,</span>
	p<span class="token punctuation">.</span>info 
<span class="token keyword">FROM</span>
	INFORMATION_SCHEMA<span class="token punctuation">.</span>PROCESSLIST p<span class="token punctuation">,</span>
	INFORMATION_SCHEMA<span class="token punctuation">.</span>INNODB_TRX  x 
<span class="token keyword">WHERE</span>
	p<span class="token punctuation">.</span>id <span class="token operator">=</span> x<span class="token punctuation">.</span>trx_mysql_thread_id  <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span>   p<span class="token punctuation">.</span>id<span class="token punctuation">,</span>   p<span class="token punctuation">.</span><span class="token keyword">time</span><span class="token punctuation">,</span>         x<span class="token punctuation">.</span>trx_id<span class="token punctuation">,</span>       x<span class="token punctuation">.</span>trx_state<span class="token punctuation">,</span>    p<span class="token punctuation">.</span>info <span class="token keyword">FROM</span>     INFORMATION_SCHEMA<span class="token punctuation">.</span>PROCESSLIST p<span class="token punctuation">,</span>       INFORMATION_SCHEMA<span class="token punctuation">.</span>INNODB_TRX  x <span class="token keyword">WHERE</span>
p<span class="token punctuation">.</span>id <span class="token operator">=</span> x<span class="token punctuation">.</span>trx_mysql_thread_id  <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+--------+-----------+-------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> <span class="token keyword">time</span> <span class="token operator">|</span> trx_id <span class="token operator">|</span> trx_state <span class="token operator">|</span> info                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+--------+-----------+-------------------------+</span>
<span class="token operator">|</span> <span class="token number">42</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span> <span class="token number">23317</span>  <span class="token operator">|</span> <span class="token keyword">LOCK</span> WAIT <span class="token operator">|</span> <span class="token keyword">delete</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> c<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">40</span> <span class="token operator">|</span> <span class="token number">1792</span> <span class="token operator">|</span> <span class="token number">23311</span>  <span class="token operator">|</span> RUNNING   <span class="token operator">|</span> <span class="token boolean">NULL</span>                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+--------+-----------+-------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  然后同时杀掉 40  42 就可以。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] <a target="_blank" rel="noopener" href="https://blog.csdn.net/dujianxiong/article/details/90770301">Mysql 锁、事务强制手动kill/释放</a><br>[2] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/74687">19 | 为什么我只查一行的语句，也执行这么慢？MySQL实战45讲 </a><br>[3] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/69862">06 | 全局锁和表锁 ：给表加个字段怎么有这么多阻碍？MySQL实战45讲 </a><br>[4] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/70215">07 | 行锁功过：怎么减少行锁对性能的影响？MySQL实战45讲</a><br>[5] <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/lock-tables.html">mysql 5.7 lock-tables</a><br>[6] <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html">MySQL 5.7 Reference Manual  /  The InnoDB Storage Engine  /  Locks Set by Different SQL Statements in InnoDB</a><br>[7] <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html">MySQL 5.7 Reference Manual  /  The InnoDB Storage Engine  /  InnoDB Startup Options and System Variables</a><br>[8] 《高性能MySQL》 O’REILLY<br>[9] <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/show-open-tables.html">mysql-show-open-tables</a><br>[10] <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/show-processlist.html">mysql-show-processlist</a><br>[11] <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html">innodb-locking</a><br>[12] <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-index-types.html">innodb-index-types</a><br>[13] <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/uoUS2NCG0Z7cmC2WkDh6MA">面试官：同学，分析一下MySQL/InnoDB的加锁过程吧</a><br>[14] <a target="_blank" rel="noopener" href="https://www.aneasystone.com/archives/2017/12/solving-dead-locks-three.html">解决死锁之路 - 常见 SQL 语句的加锁分析</a><br>[15] <a target="_blank" rel="noopener" href="https://blog.csdn.net/zhanghongzheng3213/article/details/53436240">mysql insert锁机制</a></p>
<!--
插入10万数据

delimiter ;;
create procedure idata()
begin
  declare i int;
  set i=1;
  while(i<=100000) do
    insert into t values(i,i);
    set i=i+1;
  end while;
end;;
delimiter ;

call idata();
-->

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/09/01/mysql-lock/" rel="prev" title="MySQL中的锁">
      <i class="fa fa-chevron-left"></i> MySQL中的锁
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/09/08/redis-solve-what-problem/" rel="next" title="Redis的各项功能解决了哪些问题">
      Redis的各项功能解决了哪些问题 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E9%81%87%E5%88%B0%E9%94%81%E8%A1%A8%E5%BF%AB%E9%80%9F%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="nav-number">1.</span> <span class="nav-text">(1)  遇到锁表快速解决办法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93"><span class="nav-number">2.</span> <span class="nav-text">(2) 思考总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E5%88%9B%E5%BB%BA%E8%A1%A8t%E5%B9%B6%E6%8F%92%E5%85%A52%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.</span> <span class="nav-text">(2.1) 创建表t并插入2条数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E5%87%86%E5%A4%87%E5%A4%9A%E4%B8%AAshell%E6%A8%A1%E6%8B%9F%E9%94%81%E8%A1%A8"><span class="nav-number">2.2.</span> <span class="nav-text">(2.2) 准备多个shell模拟锁表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E6%A8%A1%E6%8B%9F%E9%94%81%E8%A1%A8"><span class="nav-number">2.3.</span> <span class="nav-text">(2.3) 模拟锁表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E9%94%81%E8%A1%A8%E5%90%8E%E6%9F%A5%E7%9C%8B"><span class="nav-number">2.4.</span> <span class="nav-text">(2.4) 锁表后查看</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E9%94%81%E8%A1%A8"><span class="nav-number">2.4.1.</span> <span class="nav-text">(2.4.1)查看是否锁表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BD%93%E5%89%8D%E7%9A%84%E8%BF%9B%E7%A8%8B"><span class="nav-number">2.4.2.</span> <span class="nav-text">(2.4.2) 查看数据库当前的进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-3-%E5%BD%93%E5%89%8D%E8%BF%90%E8%A1%8C%E7%9A%84%E6%89%80%E6%9C%89%E4%BA%8B%E5%8A%A1"><span class="nav-number">2.4.3.</span> <span class="nav-text">(2.4.3) 当前运行的所有事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-4-%E5%BD%93%E5%89%8D%E5%87%BA%E7%8E%B0%E7%9A%84%E9%94%81"><span class="nav-number">2.4.4.</span> <span class="nav-text">(2.4.4) 当前出现的锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-5-%E9%94%81%E7%AD%89%E5%BE%85%E7%9A%84%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="nav-number">2.4.5.</span> <span class="nav-text">(2.4.5) 锁等待的对应关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-6-%E5%88%A0%E9%99%A4%E4%BA%8B%E5%8A%A1%E8%A1%A8%E4%B8%AD%E7%9A%84%E4%BA%8B%E5%8A%A1"><span class="nav-number">2.4.6.</span> <span class="nav-text">(2.4.6) 删除事务表中的事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-7-kill%E6%8E%89%E9%94%81%E8%A1%A8%E7%9A%84%E8%AF%AD%E5%8F%A5"><span class="nav-number">2.4.7.</span> <span class="nav-text">(2.4.7) kill掉锁表的语句</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">3.</span> <span class="nav-text">References</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">310</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/weikeqin" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;weikeqin" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/u/0/107737814703120725006" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;u&#x2F;0&#x2F;107737814703120725006" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wkq278276130" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wkq278276130" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/keqin.wei.5" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;keqin.wei.5" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/8054088/wkq" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;8054088&#x2F;wkq" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



<script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5rcgvdncuwu&amp;m=7&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>


      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'Ca876j76FoCQi1SShjT0qC6k-gzGzoHsz',
      appKey     : 'IeozLmM20GuvfcslfWgdNXP0',
      placeholder: "期待您的评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
