<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"weikeqin.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true,"width":240},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="在Redis的命令中，用于对键(key)进行处理的命令占了很大一部分， 而对于键所保存的值的类型(后简称”键的类型”)，键能执行的命令又各不相同。    比如 string list hash set zset 怎么处理key的过期时间？    这就涉及到Redis的对象系统了。    (1) Redis对象系统是什么为了应对不同的对象类型(type)和对象编码(encoding)，Redi">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 对象处理机制 redisObject">
<meta property="og:url" content="http://weikeqin.com/2023/01/08/redis-datatype-object/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="在Redis的命令中，用于对键(key)进行处理的命令占了很大一部分， 而对于键所保存的值的类型(后简称”键的类型”)，键能执行的命令又各不相同。    比如 string list hash set zset 怎么处理key的过期时间？    这就涉及到Redis的对象系统了。    (1) Redis对象系统是什么为了应对不同的对象类型(type)和对象编码(encoding)，Redi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/redis-object/redis-object.svg">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/redis-object/redis-object.svg">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/redis-object/redis-object.svg">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/redis-object-object-encoding-mapping.svg">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/redis-object/redis-object.svg">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/redis-object/string/redis-object-encoding-raw-string-memory-structure.svg">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/redis-object/string/redis-object-encoding-emb-str-memory-structure.svg">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/data-structure/sds/embedded-string/embedded-string.png">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/data-structure/sds/embedded-string/embedded-string.png">
<meta property="article:published_time" content="2023-01-08T15:25:58.000Z">
<meta property="article:modified_time" content="2023-02-05T13:33:33.081Z">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="database">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://weikeqin.com/img/database/redis/redis-object/redis-object.svg">

<link rel="canonical" href="http://weikeqin.com/2023/01/08/redis-datatype-object/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Redis 对象处理机制 redisObject | 天道酬勤</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113485469-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-113485469-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">天道酬勤</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">坚持，努力，让好事发生</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2023/01/08/redis-datatype-object/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis 对象处理机制 redisObject
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-08 23:25:58" itemprop="dateCreated datePublished" datetime="2023-01-08T23:25:58+08:00">2023-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-05 21:33:33" itemprop="dateModified" datetime="2023-02-05T21:33:33+08:00">2023-02-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          
            <span id="/2023/01/08/redis-datatype-object/" class="post-meta-item leancloud_visitors" data-flag-title="Redis 对象处理机制 redisObject" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2023/01/08/redis-datatype-object/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/01/08/redis-datatype-object/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>   在Redis的命令中，用于对键(key)进行处理的命令占了很大一部分， 而对于键所保存的值的类型(后简称”键的类型”)，键能执行的命令又各不相同。</p>
<p>   比如 string list hash set zset 怎么处理key的过期时间？</p>
<p>   这就涉及到Redis的对象系统了。</p>
<p>  <img data-src="/img/database/redis/redis-object/redis-object.svg" alt="redisObject"></p>
<h1 id="1-Redis对象系统是什么"><a href="#1-Redis对象系统是什么" class="headerlink" title="(1) Redis对象系统是什么"></a>(1) Redis对象系统是什么</h1><p>为了应对不同的对象类型(type)和对象编码(encoding)，Redis构建了自己的类型系统，这个系统的主要功能包括：</p>
<ol>
<li>redisObject 对象。</li>
<li>基于 redisObject 对象的类型检查。</li>
<li>基于 redisObject 对象的显式多态函数。</li>
<li>对 redisObject 进行分配、共享和销毁的机制。</li>
</ol>
<p>  Redis 的 key 是 String 类型，但 value 可以是很多类型（String/List/Hash/Set/ZSet等），所以 Redis 要想存储多种数据类型，就要设计一个通用的对象进行封装，这个对象就是 redisObject。</p>
<p>  <code>redisObject</code> 是Redis类型系统的核心， 数据库中的每个键、值，以及Redis本身处理的参数，都表示为这种数据类型。</p>
<h2 id="1-1-redisObject结构"><a href="#1-1-redisObject结构" class="headerlink" title="(1.1) redisObject结构"></a>(1.1) redisObject结构</h2><p>  Redis 使用的基本数据对象结构体 redisObject</p>
<p>  <img data-src="/img/database/redis/redis-object/redis-object.svg" alt="redisObject"></p>
<span id="more"></span>

<br>


<h1 id="2-redisObject的作用"><a href="#2-redisObject的作用" class="headerlink" title="(2) redisObject的作用"></a>(2) redisObject的作用</h1><p>redisObject 的作用在于：</p>
<ol>
<li>为多种数据类型提供统一的表示方式</li>
<li>同一种数据类型，底层可以对应不同实现，节省内存</li>
<li>支持对象共享和引用计数，共享对象存储一份，可多次使用，节省内存</li>
</ol>
<p>redisObject 更像是连接「上层数据类型」和「底层数据结构」之间的桥梁。</p>
<h1 id="3-redisObject原理"><a href="#3-redisObject原理" class="headerlink" title="(3) redisObject原理"></a>(3) redisObject原理</h1><p>  <img data-src="/img/database/redis/redis-object/redis-object.svg" alt="redisObject"></p>
<p>  实际上，Redis每个键都带有类型信息、编码方式(数据结构)、过期时间 等。</p>
<p>  另外，Redis 的每一种数据类型，比如字符串、列表、有序集， 它们都拥有不只一种底层实现(Redis内部称之为编码，encoding)，这说明，每当对某种数据类型的键进行操作时，程序都必须根据键所采取的编码，进行不同的操作。</p>
<h2 id="3-1-redisObject里type对应的Redis对象"><a href="#3-1-redisObject里type对应的Redis对象" class="headerlink" title="(3.1) redisObject里type对应的Redis对象"></a>(3.1) redisObject里type对应的Redis对象</h2><p><code>type</code>对应<code>redisObject</code>的数据类型，对应redis里的<code>string</code> <code>list</code> <code>set</code> <code>sorted set</code> <code>hash</code>  <code>stream</code> 等。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.h</span>

<span class="token comment">/* 
 * 实际的Redis对象 
 * The actual Redis Object 
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_STRING</span> <span class="token expression"><span class="token number">0</span>    </span><span class="token comment">/* String object. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_LIST</span> <span class="token expression"><span class="token number">1</span>      </span><span class="token comment">/* List object. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_SET</span> <span class="token expression"><span class="token number">2</span>       </span><span class="token comment">/* Set object. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ZSET</span> <span class="token expression"><span class="token number">3</span>      </span><span class="token comment">/* Sorted set object. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_HASH</span> <span class="token expression"><span class="token number">4</span>      </span><span class="token comment">/* Hash object. */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_MODULE</span> <span class="token expression"><span class="token number">5</span>    </span><span class="token comment">/* Module object. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_STREAM</span> <span class="token expression"><span class="token number">6</span>    </span><span class="token comment">/* Stream object. */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="3-2-redisObject里encoding对应的对象编码"><a href="#3-2-redisObject里encoding对应的对象编码" class="headerlink" title="(3.2) redisObject里encoding对应的对象编码"></a>(3.2) redisObject里encoding对应的对象编码</h2><p>  <code>encoding</code>对应redis里的编码方式，有 <code>raw</code> <code>int</code> <code>ht</code> <code>zipmap</code> <code>linkedlist</code> <code>ziplist</code> <code>intset</code> <code>skiplist</code> <code>embstr</code> <code>quicklist</code> <code>stream</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.h</span>

<span class="token comment">/* 
 * 对象编码。 
 * 某些类型的对象（如字符串和哈希）可以在内部以多种方式表示。 
 * 对象的"encoding"字段设置为此对象的此字段之一。
 *
 * Objects encoding. 
 * Some kind of objects like Strings and Hashes can be internally represented in multiple ways. 
 * The 'encoding' field of the object is set to one of this fields for this object. 
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_RAW</span> <span class="token expression"><span class="token number">0</span>     </span><span class="token comment">/* Raw representation */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_INT</span> <span class="token expression"><span class="token number">1</span>     </span><span class="token comment">/* Encoded as integer */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_HT</span> <span class="token expression"><span class="token number">2</span>      </span><span class="token comment">/* Encoded as hash table */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_ZIPMAP</span> <span class="token expression"><span class="token number">3</span>  </span><span class="token comment">/* Encoded as zipmap */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_LINKEDLIST</span> <span class="token expression"><span class="token number">4</span> </span><span class="token comment">/* No longer used: old list encoding. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_ZIPLIST</span> <span class="token expression"><span class="token number">5</span> </span><span class="token comment">/* Encoded as ziplist */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_INTSET</span> <span class="token expression"><span class="token number">6</span>  </span><span class="token comment">/* Encoded as intset */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_SKIPLIST</span> <span class="token expression"><span class="token number">7</span>  </span><span class="token comment">/* Encoded as skiplist */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_EMBSTR</span> <span class="token expression"><span class="token number">8</span>  </span><span class="token comment">/* Embedded sds string encoding */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_QUICKLIST</span> <span class="token expression"><span class="token number">9</span> </span><span class="token comment">/* Encoded as linked list of ziplists */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_STREAM</span> <span class="token expression"><span class="token number">10</span> </span><span class="token comment">/* Encoded as a radix tree of listpacks */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> <code>redisObject</code> 、<code>Redis对象(Redis Object)</code> 以及 <code>对象编码(Objects encoding)</code> 三者之间的关系：</p>
<p>  <img data-src="/img/database/redis/redis-object-object-encoding-mapping.svg" alt="redisObject-object-encoding-mapping"></p>
<br>









<h1 id="4-redisObject源码解析"><a href="#4-redisObject源码解析" class="headerlink" title="(4) redisObject源码解析"></a>(4) redisObject源码解析</h1><p>  源码: <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/6.0/src/server.h#L633">https://github.com/redis/redis/blob/6.0/src/server.h#L633</a></p>
<h2 id="4-1-redisObject结构定义"><a href="#4-1-redisObject结构定义" class="headerlink" title="(4.1) redisObject结构定义"></a>(4.1) redisObject结构定义</h2><p>  <img data-src="/img/database/redis/redis-object/redis-object.svg" alt="redisObject"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.h </span>

<span class="token comment">/*
 * redis对象
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObject</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 数据类型 （string/list/hash/set/zset等）</span>
    <span class="token keyword">unsigned</span> encoding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 编码方式 </span>
    <span class="token keyword">unsigned</span> lru<span class="token operator">:</span>LRU_BITS<span class="token punctuation">;</span>  <span class="token comment">// LRU时间(相对于全局 lru_clock) </span>
                            <span class="token comment">// 或 LFU数据(低8位保存频率 和 高16位保存访问时间)。  </span>
                            <span class="token comment">// LRU_BITS为24个bits</span>
    <span class="token keyword">int</span> refcount<span class="token punctuation">;</span>  <span class="token comment">// 引用计数  4字节</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>  <span class="token comment">// 指针 指向对象的值  8字节</span>
<span class="token punctuation">&#125;</span> robj<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  <code>type</code>占用内存空间 4bits<br>  <code>encoding</code>占用内存空间 4bits<br>  <code>lru</code>占用内存空间24bits<br>  <code>refcount</code>占用内存空间4字节<br>  <code>*ptr</code>占用内存空间8字节<br>  redisObject总共占用内存空间 16字节</p>
<br>


<h2 id="4-2-创建对象-createObject"><a href="#4-2-创建对象-createObject" class="headerlink" title="(4.2) 创建对象-createObject"></a>(4.2) 创建对象-createObject</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/object.c</span>

<span class="token comment">/*
 * 创建一个redisObject对象
 *
 * @param type redisObject的类型
 * @param *ptr 值的指针
 */</span>
robj <span class="token operator">*</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 为redisObject结构体分配内存空间</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置redisObject的类型</span>
    o<span class="token operator">-></span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    <span class="token comment">// 设置默认encoding为raw，后面可能会更改 </span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_RAW<span class="token punctuation">;</span>
    <span class="token comment">// 直接将传入的指针赋值给redisObject中的指针。 指向 char[]</span>
    o<span class="token operator">-></span>ptr <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
    <span class="token comment">// 引用计数设置成1 </span>
    o<span class="token operator">-></span>refcount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 将lru字段设置为当前的 lruclock（分钟分辨率），或者 LFU 计数器。 </span>
    <span class="token comment">// 判断内存过期策略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lfu </span>
        <span class="token comment">// LFU_INIT_VAL=5 对应二进制是 0101 </span>
        <span class="token comment">// 或运算 </span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lru </span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h2 id="4-3-创建字符串对象"><a href="#4-3-创建字符串对象" class="headerlink" title="(4.3) 创建字符串对象"></a>(4.3) 创建字符串对象</h2><p>  创建字符串对象有3种方法，创建整数对象、创建嵌入字符串对象 和 原始(raw)字符串对象</p>
<h3 id="4-3-1-创建一个原始-raw-字符串对象"><a href="#4-3-1-创建一个原始-raw-字符串对象" class="headerlink" title="(4.3.1) 创建一个原始(raw)字符串对象"></a>(4.3.1) 创建一个原始(raw)字符串对象</h3><p>  <img data-src="/img/database/redis/redis-object/string/redis-object-encoding-raw-string-memory-structure.svg" alt="RedisObject-SDS-RAW编码字符串-内存结构"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/object.c </span>

<span class="token comment">/*
 * 使用编码OBJ_ENCODING_RAW创建一个字符串对象，
 * 这是一个纯字符串对象，其中 o->ptr 指向正确的 sds 字符串。
 */</span>
robj <span class="token operator">*</span><span class="token function">createRawStringObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// redisObject对象  类型为string，编码为raw  </span>
    <span class="token keyword">return</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span> <span class="token function">sdsnewlen</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>



<h3 id="4-3-2-创建嵌入式字符串对象-createEmbeddedStringObject"><a href="#4-3-2-创建嵌入式字符串对象-createEmbeddedStringObject" class="headerlink" title="(4.3.2) 创建嵌入式字符串对象-createEmbeddedStringObject"></a>(4.3.2) 创建嵌入式字符串对象-createEmbeddedStringObject</h3><p>  <img data-src="/img/database/redis/redis-object/string/redis-object-encoding-emb-str-memory-structure.svg" alt="RedisObject-SDS-EMB编码字符串-内存结构"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/object.c</span>

<span class="token comment">/* 
 * 创建一个编码为 OBJ_ENCODING_EMBSTR 的字符串对象，
 * 这是一个对象，其中 sds 字符串实际上是一个不可修改的字符串，分配在与对象本身相同的块中。
 *  
 * @param *ptr
 * @param len
 */</span>
robj <span class="token operator">*</span><span class="token function">createEmbeddedStringObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 分配内存空间 </span>
    <span class="token comment">// 包括 redisObject结构体空间、sdshdr8结构体空间、字符串长度、以及结束符"\0"的长度1 </span>
    <span class="token comment">// robj长度是16字节  sdshdr8长度是3字节 </span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>robj<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sdshdr8</span><span class="token punctuation">)</span><span class="token operator">+</span>len<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// o是redisObject结构体的变量，o+1 表示将内存地址从变量o开始往后移动1，这个位置是sdshdr8结构体内存地址开始的地方。</span>
    <span class="token keyword">struct</span> <span class="token class-name">sdshdr8</span> <span class="token operator">*</span>sh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>o<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// redisObject 类型为string，编码为embstr </span>
    o<span class="token operator">-></span>type <span class="token operator">=</span> OBJ_STRING<span class="token punctuation">;</span>
    <span class="token comment">// 编码 设置为 OBJ_ENCODING_EMBSTR</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_EMBSTR<span class="token punctuation">;</span>
    <span class="token comment">// 把 redisObject 中的指针 ptr，指向 SDS 结构中的字符数组</span>
    <span class="token comment">// sh+1 表示将内存地址从变量sh开始往后移动1，这个位置是字符串内存地址开始的地方。</span>
    o<span class="token operator">-></span>ptr <span class="token operator">=</span> sh<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 引用计数设置为1 </span>
    o<span class="token operator">-></span>refcount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置内存淘汰策略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    sh<span class="token operator">-></span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>
    sh<span class="token operator">-></span>alloc <span class="token operator">=</span> len<span class="token punctuation">;</span>
    sh<span class="token operator">-></span>flags <span class="token operator">=</span> SDS_TYPE_8<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> SDS_NOINIT<span class="token punctuation">)</span>
        sh<span class="token operator">-></span>buf<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>sh<span class="token operator">-></span>buf<span class="token punctuation">,</span>ptr<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sh<span class="token operator">-></span>buf<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>sh<span class="token operator">-></span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  <img data-src="/img/database/redis/data-structure/sds/embedded-string/embedded-string.png" alt="嵌入字符串"></p>
<p>  使用一块连续的内存空间，来同时保存 <code>redisObject</code> 和 <code>SDS</code> 结构。这样一来，内存分配只有一次，而且也避免了内存碎片。</p>
<br>


<h3 id="4-3-3-创建整数型字符串"><a href="#4-3-3-创建整数型字符串" class="headerlink" title="(4.3.3) 创建整数型字符串"></a>(4.3.3) 创建整数型字符串</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * createStringObjectFromLongLongWithOptions() 的包装器总是要求尽可能创建一个共享对象。
 */</span>
robj <span class="token operator">*</span><span class="token function">createStringObjectFromLongLong</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">createStringObjectFromLongLongWithOptions</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/object.c</span>

<span class="token comment">/* 
 * 从 long long value创建一个字符串对象。 如果可能，返回一个共享整数对象，或者至少是一个整数编码对象。
 *
 * 如果 valueobj 不为零，该函数将避免返回共享整数，因为该对象将用作Redis键空间中的值
 * (例如，当使用INCR命令时)，因此我们希望 每一个key的 LFU/LRU 值都是特别的。
 *
 * 在 src/slowlog.c module.c文件里用到了
 */</span>
robj <span class="token operator">*</span><span class="token function">createStringObjectFromLongLongWithOptions</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> valueobj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    robj <span class="token operator">*</span>o<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_NO_SHARED_INTEGERS<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果 maxmemory 策略允许，即使 valueobj 为真，我们仍然可以返回共享整数。 </span>
        valueobj <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 默认 0 &lt;= value &lt; 10000 并且  valueobj == 0 时，使用享元模式，节省内存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">&lt;</span> OBJ_SHARED_INTEGERS <span class="token operator">&amp;&amp;</span> valueobj <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 引用次数+1</span>
        <span class="token function">incrRefCount</span><span class="token punctuation">(</span>shared<span class="token punctuation">.</span>integers<span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// redisObject 赋值</span>
        o <span class="token operator">=</span> shared<span class="token punctuation">.</span>integers<span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">>=</span> LONG_MIN <span class="token operator">&amp;&amp;</span> value <span class="token operator">&lt;=</span> LONG_MAX<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 创建redisObject，type为string，编码为int</span>
            o <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_INT<span class="token punctuation">;</span>
            o<span class="token operator">-></span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 创建redisObject，type为string，编码为raw</span>
            o <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span><span class="token function">sdsfromlonglong</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h3 id="4-3-4-复制字符串对象-dupStringObject"><a href="#4-3-4-复制字符串对象-dupStringObject" class="headerlink" title="(4.3.4) 复制字符串对象-dupStringObject"></a>(4.3.4) 复制字符串对象-dupStringObject</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * 复制一个字符串对象，并保证返回的对象与原始对象具有相同的编码。
 *
 * 此函数还保证复制一个小整数对象(或包含一个小整数表示的字符串对象)将始终产生一个未共享的新对象(refcount == 1)。
 *
 * 生成的对象始终将引用次数设置为 1。
 */</span>
robj <span class="token operator">*</span><span class="token function">dupStringObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    robj <span class="token operator">*</span>d<span class="token punctuation">;</span>

    <span class="token function">serverAssert</span><span class="token punctuation">(</span>o<span class="token operator">-></span>type <span class="token operator">==</span> OBJ_STRING<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断string类型的编码类型</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>o<span class="token operator">-></span>encoding<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> OBJ_ENCODING_RAW<span class="token operator">:</span>  <span class="token comment">// 原始字符串</span>
        <span class="token keyword">return</span> <span class="token function">createRawStringObject</span><span class="token punctuation">(</span>o<span class="token operator">-></span>ptr<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>o<span class="token operator">-></span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OBJ_ENCODING_EMBSTR<span class="token operator">:</span>  <span class="token comment">// 嵌入式字符串</span>
        <span class="token keyword">return</span> <span class="token function">createEmbeddedStringObject</span><span class="token punctuation">(</span>o<span class="token operator">-></span>ptr<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>o<span class="token operator">-></span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OBJ_ENCODING_INT<span class="token operator">:</span>  <span class="token comment">// 整数</span>
        d <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_INT<span class="token punctuation">;</span>
        d<span class="token operator">-></span>ptr <span class="token operator">=</span> o<span class="token operator">-></span>ptr<span class="token punctuation">;</span>
        <span class="token keyword">return</span> d<span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"Wrong encoding."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h2 id="2-4-创建列表对象"><a href="#2-4-创建列表对象" class="headerlink" title="(2.4) 创建列表对象"></a>(2.4) 创建列表对象</h2><p>  创建列表对象有2种方法，创建快速列表对象 和 创建压缩列表对象<br>  创建快速列表对象 createQuicklistObject<br>  创建压缩列表对象 createZiplistObject</p>
<h3 id="2-4-1-创建快速列表对象-createQuicklistObject"><a href="#2-4-1-创建快速列表对象-createQuicklistObject" class="headerlink" title="(2.4.1) 创建快速列表对象-createQuicklistObject"></a>(2.4.1) 创建快速列表对象-createQuicklistObject</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * 创建快速列表对象
 * 
 * 在 src/t_list.c 文件里用到了 lobj = createQuicklistObject(); 
 */</span>
robj <span class="token operator">*</span><span class="token function">createQuicklistObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建快速列表</span>
    quicklist <span class="token operator">*</span>l <span class="token operator">=</span> <span class="token function">quicklistCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建redisObject 类型是list，编码是quicklist </span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_LIST<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_QUICKLIST<span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="2-4-2-创建压缩列表对象-createZiplistObject"><a href="#2-4-2-创建压缩列表对象-createZiplistObject" class="headerlink" title="(2.4.2) 创建压缩列表对象-createZiplistObject"></a>(2.4.2) 创建压缩列表对象-createZiplistObject</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 *
 */</span>
robj <span class="token operator">*</span><span class="token function">createZiplistObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建压缩列表</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>zl <span class="token operator">=</span> <span class="token function">ziplistNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建redisObject 类型是list，编码是ziplist </span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_LIST<span class="token punctuation">,</span>zl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_ZIPLIST<span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h2 id="2-5-集合"><a href="#2-5-集合" class="headerlink" title="(2.5) 集合"></a>(2.5) 集合</h2><h2 id="2-5-1-创建集合-createSetObject"><a href="#2-5-1-创建集合-createSetObject" class="headerlink" title="(2.5.1) 创建集合-createSetObject"></a>(2.5.1) 创建集合-createSetObject</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * 创建set对象
 * 
 * 在 t_set.c、rdb.c 用到了
 */</span>
robj <span class="token operator">*</span><span class="token function">createSetObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建哈希表</span>
    dict <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token function">dictCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>setDictType<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建redisObject  类型set，编码方式ht(哈希表)</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_SET<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_HT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="2-5-2-创建整数集合-createIntsetObject"><a href="#2-5-2-创建整数集合-createIntsetObject" class="headerlink" title="(2.5.2) 创建整数集合-createIntsetObject"></a>(2.5.2) 创建整数集合-createIntsetObject</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * 创建整数集合对象
 * 
 * 在 t_set.c、rdb.c 用到了
 */</span>
robj <span class="token operator">*</span><span class="token function">createIntsetObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建整数集合</span>
    intset <span class="token operator">*</span>is <span class="token operator">=</span> <span class="token function">intsetNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建redisObject  类型set，编码方式intset(整数集合)</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_SET<span class="token punctuation">,</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_INTSET<span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-6-有序集合"><a href="#2-6-有序集合" class="headerlink" title="(2.6) 有序集合"></a>(2.6) 有序集合</h2><h3 id="2-6-1-创建有序集合对象-createZsetObject"><a href="#2-6-1-创建有序集合对象-createZsetObject" class="headerlink" title="(2.6.1) 创建有序集合对象-createZsetObject"></a>(2.6.1) 创建有序集合对象-createZsetObject</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">robj <span class="token operator">*</span><span class="token function">createZsetObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 分配内存</span>
    zset <span class="token operator">*</span>zs <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>zs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    robj <span class="token operator">*</span>o<span class="token punctuation">;</span>
    <span class="token comment">// 创建哈希表</span>
    zs<span class="token operator">-></span>dict <span class="token operator">=</span> <span class="token function">dictCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zsetDictType<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建跳表</span>
    zs<span class="token operator">-></span>zsl <span class="token operator">=</span> <span class="token function">zslCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建redisObject， 类型zset，编码方式skiplist(跳表)</span>
    o <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_ZSET<span class="token punctuation">,</span>zs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_SKIPLIST<span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="2-6-2-创建编码为压缩列表的有序集合对象-createZsetZiplistObject"><a href="#2-6-2-创建编码为压缩列表的有序集合对象-createZsetZiplistObject" class="headerlink" title="(2.6.2) 创建编码为压缩列表的有序集合对象-createZsetZiplistObject"></a>(2.6.2) 创建编码为压缩列表的有序集合对象-createZsetZiplistObject</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">robj <span class="token operator">*</span><span class="token function">createZsetZiplistObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建压缩列表</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>zl <span class="token operator">=</span> <span class="token function">ziplistNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建redisObject， 类型zset，编码方式ziplist(压缩列表)</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_ZSET<span class="token punctuation">,</span>zl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_ZIPLIST<span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-7-哈希"><a href="#2-7-哈希" class="headerlink" title="(2.7) 哈希"></a>(2.7) 哈希</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">robj <span class="token operator">*</span><span class="token function">createHashObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>zl <span class="token operator">=</span> <span class="token function">ziplistNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建redisObject，类型hash，编码方式ziplist(压缩列表)</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_HASH<span class="token punctuation">,</span> zl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_ZIPLIST<span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-8-模块"><a href="#2-8-模块" class="headerlink" title="(2.8) 模块"></a>(2.8) 模块</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">robj <span class="token operator">*</span><span class="token function">createModuleObject</span><span class="token punctuation">(</span>moduleType <span class="token operator">*</span>mt<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// </span>
    moduleValue <span class="token operator">*</span>mv <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>mv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mv<span class="token operator">-></span>type <span class="token operator">=</span> mt<span class="token punctuation">;</span>
    mv<span class="token operator">-></span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token comment">// 创建redisObject</span>
    <span class="token keyword">return</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_MODULE<span class="token punctuation">,</span>mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-9-流"><a href="#2-9-流" class="headerlink" title="(2.9) 流"></a>(2.9) 流</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">robj <span class="token operator">*</span><span class="token function">createStreamObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    stream <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token function">streamNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建redisObject，类型stream，编码方式stream</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STREAM<span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_STREAM<span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Set a special refcount in the object to make it "shared":
 * incrRefCount and decrRefCount() will test for this special refcount
 * and will not touch the object. This way it is free to access shared
 * objects such as small integers from different threads without any
 * mutex.
 *
 * A common patter to create shared objects:
 *
 * robj *myobject = makeObjectShared(createObject(...));
 *
 */</span>
robj <span class="token operator">*</span><span class="token function">makeObjectShared</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">serverAssert</span><span class="token punctuation">(</span>o<span class="token operator">-></span>refcount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-></span>refcount <span class="token operator">=</span> OBJ_SHARED_REFCOUNT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<br>


<h1 id="3-redisObject里内存优化"><a href="#3-redisObject里内存优化" class="headerlink" title="(3) redisObject里内存优化"></a>(3) redisObject里内存优化</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: server.h </span>

<span class="token comment">/*
 * redis对象
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObject</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 数据类型  4个bits</span>
    <span class="token keyword">unsigned</span> encoding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 编码方式 4个bits</span>
    <span class="token keyword">unsigned</span> lru<span class="token operator">:</span>LRU_BITS<span class="token punctuation">;</span>  <span class="token comment">// LRU时间(相对于全局 lru_clock) </span>
                            <span class="token comment">// 或 LFU数据(低8位保存频率 和 高16位保存访问时间)。  </span>
                            <span class="token comment">// LRU_BITS为24个bits</span>
    <span class="token keyword">int</span> refcount<span class="token punctuation">;</span>  <span class="token comment">// 引用计数  4字节</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>  <span class="token comment">// 指针 指向对象的值  8字节</span>
<span class="token punctuation">&#125;</span> robj<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="3-1-位域定义方法"><a href="#3-1-位域定义方法" class="headerlink" title="(3.1) 位域定义方法"></a>(3.1) 位域定义方法</h2><p>  在 <code>type</code>、<code>encoding</code> 和 <code>lru</code> 三个变量后面都有一个冒号，并紧跟着一个数值，表示该元数据占用的比特数。<br>  其中，<code>type</code> 和 <code>encoding</code> 分别占 <code>4bits</code>， <code>lru</code> 占用 <code>24bits</code> (LRU_BITS = 24bits) ，三个字段一共占用32bits=4字节</p>
<p>  变量后使用冒号和数值的定义方法。是C语言中的位域定义方法，可以用来有效地节省内存开销。</p>
<p>  当一个变量占用不了一个数据类型的所有 bits 时，就可以使用位域定义方法，把一个数据类型中的 bits，划分成多个位域，每个位域占一定的 bit 数。这样一来，一个数据类型的所有 bits 就可以定义多个变量了，从而也就有效节省了内存开销。</p>
<h2 id="3-2-嵌入式字符串"><a href="#3-2-嵌入式字符串" class="headerlink" title="(3.2) 嵌入式字符串"></a>(3.2) 嵌入式字符串</h2><p>  SDS 在保存比较小的字符串时，会使用嵌入式字符串的设计方法，将字符串直接保存在 redisObject 结构体中。然后在 redisObject 结构体中，存在一个指向值的指针 ptr，而一般来说，这个 ptr 指针会指向值的数据结构。</p>
<p>  以创建一个 String 类型的值为例，Redis 会调用 createStringObject 函数，来创建相应的 redisObject，而这个 redisObject 中的 ptr 指针，就会指向 SDS 数据结构，如下图所示。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: object.c</span>

<span class="token comment">/* 
 * 如果&lt;=44，EMBSTR 编码创建一个字符串对象，否则使用 RAW 编码。
 *
 * The current limit of 44 is chosen so that the biggest string object
 * we allocate as EMBSTR will still fit into the 64 byte arena of jemalloc. 
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OBJ_ENCODING_EMBSTR_SIZE_LIMIT</span> <span class="token expression"><span class="token number">44</span></span></span>
robj <span class="token operator">*</span><span class="token function">createStringObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 判断字符长度， &lt;=44 使用 EMBSTR，否则使用 RAW </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> OBJ_ENCODING_EMBSTR_SIZE_LIMIT<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">createEmbeddedStringObject</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// EMBSTR编码</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token function">createRawStringObject</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// RAW编码</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  String对象类型，存储的字符串长度&lt;=44时，用embstr(嵌入式字符串，redisObject和SDS分配的内存是连起来的)；字符串长度&gt;44时，使用raw格式存储；存储的的是一个「数字」时，会使用long long类型来存储，节省内存。</p>
<p>  同理，hash / set / zset 在数据量少时，采用 压缩列表(ziplist) 存储，否则就转为 哈希表(dictht) 来存。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: object.c</span>

<span class="token comment">/* 
 * 创建一个编码为 OBJ_ENCODING_EMBSTR 的字符串对象，
 * 这是一个对象，其中 sds 字符串实际上是一个不可修改的字符串，分配在与对象本身相同的块中。
 *  
 * @param *ptr
 * @param len
 */</span>
robj <span class="token operator">*</span><span class="token function">createEmbeddedStringObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 分配内存空间 </span>
    <span class="token comment">// 包括 redisObject结构体空间、sdshdr8结构体空间、字符串长度、以及结束符"\0"的长度1 </span>
    <span class="token comment">// robj长度是16字节  sdshdr8长度是3字节 </span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>robj<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sdshdr8</span><span class="token punctuation">)</span><span class="token operator">+</span>len<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// o是redisObject结构体的变量，o+1 表示将内存地址从变量o开始往后移动1，这个位置是sdshdr8结构体内存地址开始的地方。</span>
    <span class="token keyword">struct</span> <span class="token class-name">sdshdr8</span> <span class="token operator">*</span>sh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>o<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// </span>
    o<span class="token operator">-></span>type <span class="token operator">=</span> OBJ_STRING<span class="token punctuation">;</span>
    <span class="token comment">// 编码 设置为 OBJ_ENCODING_EMBSTR</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_EMBSTR<span class="token punctuation">;</span>
    <span class="token comment">// 把 redisObject 中的指针 ptr，指向 SDS 结构中的字符数组</span>
    <span class="token comment">// sh+1 表示将内存地址从变量sh开始往后移动1，这个位置是字符串内存地址开始的地方。</span>
    o<span class="token operator">-></span>ptr <span class="token operator">=</span> sh<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 引用计数设置为1 </span>
    o<span class="token operator">-></span>refcount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置内存淘汰策略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    sh<span class="token operator">-></span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>
    sh<span class="token operator">-></span>alloc <span class="token operator">=</span> len<span class="token punctuation">;</span>
    sh<span class="token operator">-></span>flags <span class="token operator">=</span> SDS_TYPE_8<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> SDS_NOINIT<span class="token punctuation">)</span>
        sh<span class="token operator">-></span>buf<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>sh<span class="token operator">-></span>buf<span class="token punctuation">,</span>ptr<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sh<span class="token operator">-></span>buf<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>sh<span class="token operator">-></span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  <img data-src="/img/database/redis/data-structure/sds/embedded-string/embedded-string.png" alt="嵌入字符串"></p>
<p>  使用一块连续的内存空间，来同时保存 <code>redisObject</code> 和 <code>SDS</code> 结构。这样一来，内存分配只有一次，而且也避免了内存碎片。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: object.c</span>

<span class="token comment">/* 
 * 创建一个编码为 OBJ_ENCODING_RAW 的字符串对象，这是一个普通字符串对象，其中 o->ptr 指向正确的 sds 字符串。
 * 
 * @param *ptr
 * @param len
 */</span>
robj <span class="token operator">*</span><span class="token function">createRawStringObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建一个字符串对象 type是OBJ_STRING  encoding是OBJ_ENCODING_RAW  长度是字符串长度</span>
    <span class="token keyword">return</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span> <span class="token function">sdsnewlen</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: object.c</span>

robj <span class="token operator">*</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 为redisObject结构体分配内存空间</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置redisObject的类型</span>
    o<span class="token operator">-></span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    <span class="token comment">// 设置redisObject的编码类型，此处是OBJ_ENCODING_RAW，表示常规的SDS</span>
    o<span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_RAW<span class="token punctuation">;</span>
    <span class="token comment">// 直接将传入的指针赋值给redisObject中的指针。 指向 char[]</span>
    o<span class="token operator">-></span>ptr <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
    <span class="token comment">// 引用计数设置成1 </span>
    o<span class="token operator">-></span>refcount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 将lru字段设置为当前的 lruclock（分钟分辨率），或者 LFU 计数器。 </span>
    <span class="token comment">// 判断内存过期策略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lfu </span>
        <span class="token comment">// LFU_INIT_VAL=5 对应二进制是 0101 </span>
        <span class="token comment">// 或运算 </span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 对应lru </span>
        o<span class="token operator">-></span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  在创建普通字符串时，Redis需要分别给 <code>redisObject</code> 和 <code>SDS</code> 分别分配一次内存，这样就既带来了内存分配开销，同时也会导致内存碎片。</p>
<h3 id="3-2-1-为什么EMBSTR的大小要-lt-44"><a href="#3-2-1-为什么EMBSTR的大小要-lt-44" class="headerlink" title="(3.2.1) 为什么EMBSTR的大小要&lt;=44"></a>(3.2.1) 为什么EMBSTR的大小要&lt;=44</h3><p>  <code>44</code>是因为 N = <code>64(CPU缓存行大小)</code> - <code>16(redisObject结构体占用内存大小)</code> - <code>3(sdshr8结构体占用内存大小)</code> - <code>1(结束符大小&#39;\0&#39;)</code>， N = 44 字节。<br>  那么为什么是64减呢，为什么不是别的，CPU访问内存读取数据时以cache line为单位，在目前的x86体系下，一般的缓存行大小是64字节，如果整个结构体起始地址64字节对齐，一次内存IO就可以读取全部数据，redis为了一次能加载完成，因此采用64自己作为embstr类型(保存redisObject)的最大长度。</p>
<br>




<h1 id="4-命令的类型检查和多态"><a href="#4-命令的类型检查和多态" class="headerlink" title="(4) 命令的类型检查和多态"></a>(4) 命令的类型检查和多态</h1><p>有了 redisObject 结构的存在， 在执行处理数据类型的命令时， 进行类型检查和对编码进行多态操作就简单得多了。</p>
<p>当执行一个处理数据类型的命令时， Redis 执行以下步骤：</p>
<ol>
<li>根据给定 key ，在数据库字典中查找和它相对应的 redisObject ，如果没找到，就返回 NULL 。</li>
<li>检查 redisObject 的 type 属性和执行命令所需的类型是否相符，如果不相符，返回类型错误。</li>
<li>根据 redisObject 的 encoding 属性所指定的编码，选择合适的操作函数来处理底层的数据结构。</li>
<li>返回数据结构的操作结果作为命令的返回值。</li>
</ol>
<p>  比如在 list 类型上使用 get命令会提示 <code>WRONGTYPE</code></p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span> lpush key_list_msg msg_1
<span class="token operator">(</span>integer<span class="token operator">)</span> <span class="token number">1</span>
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span> get key_list_msg
<span class="token operator">(</span>error<span class="token operator">)</span> WRONGTYPE Operation against a key holding the wrong kind of value
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span>
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span> llen  key_list_msg
<span class="token operator">(</span>integer<span class="token operator">)</span> <span class="token number">1</span>
<span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">6379</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/object.c</span>

<span class="token keyword">int</span> <span class="token function">checkType</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">,</span> robj <span class="token operator">*</span>o<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 如果类型不一致</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>type <span class="token operator">!=</span> type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">addReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>shared<span class="token punctuation">.</span>wrongtypeerr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>



<h1 id="5-对象共享"><a href="#5-对象共享" class="headerlink" title="(5) 对象共享"></a>(5) 对象共享</h1><p>有一些对象在 Redis 中非常常见， 比如命令的返回值 OK、ERROR、WRONGTYPE 等字符， 另外，一些小范围的整数，比如个位、十位、百位的整数都非常常见。</p>
<p>为了利用这种常见情况，Redis在内部使用了享元模式(Flyweight Pattern)，通过预分配一些常见的值对象，并在多个数据结构之间共享这些对象，避免了重复分配的麻烦，也节约了一些CPU时间。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/server.c </span>

<span class="token keyword">void</span> <span class="token function">createSharedObjects</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 共享整数型redisObject  默认0-~10000</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> OBJ_SHARED_INTEGERS<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// </span>
        shared<span class="token punctuation">.</span>integers<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span>
            <span class="token function">makeObjectShared</span><span class="token punctuation">(</span><span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// redisObject编码设置为int     </span>
        shared<span class="token punctuation">.</span>integers<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-></span>encoding <span class="token operator">=</span> OBJ_ENCODING_INT<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="6-引用计数以及对象的销毁"><a href="#6-引用计数以及对象的销毁" class="headerlink" title="(6) 引用计数以及对象的销毁"></a>(6) 引用计数以及对象的销毁</h1><p>当将<code>redisObject</code>用作数据库的键或者值，而不是用来储存参数时，对象的生命期是非常长的，因为C语言本身没有自动释放内存的相关机制。</p>
<p>另一方面，一个共享对象可能被多个数据结构所引用，这时像是”这个对象被引用了多少次？”之类的问题就会出现。</p>
<p>为了解决以上两个问题， Redis 的对象系统使用了引用计数技术来负责维持和销毁对象， 它的运作机制如下：</p>
<ol>
<li>每个 redisObject 结构都带有一个 refcount 属性，指示这个对象被引用了多少次。</li>
<li>当新创建一个对象时，它的 refcount 属性被设置为 1 。</li>
<li>当对一个对象进行共享时，Redis 将这个对象的 refcount 增一。</li>
<li>当使用完一个对象之后，或者取消对共享对象的引用之后，程序将对象的 refcount 减一。</li>
<li>当对象的 refcount 降至 0 时，这个 redisObject 结构，以及它所引用的数据结构的内存，都会被释放。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: src/object.c</span>

<span class="token keyword">void</span> <span class="token function">decrRefCount</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 引用次数为1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>refcount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
        <span class="token keyword">switch</span><span class="token punctuation">(</span>o<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> OBJ_STRING<span class="token operator">:</span> <span class="token function">freeStringObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_LIST<span class="token operator">:</span> <span class="token function">freeListObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_SET<span class="token operator">:</span> <span class="token function">freeSetObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_ZSET<span class="token operator">:</span> <span class="token function">freeZsetObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_HASH<span class="token operator">:</span> <span class="token function">freeHashObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_MODULE<span class="token operator">:</span> <span class="token function">freeModuleObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_STREAM<span class="token operator">:</span> <span class="token function">freeStreamObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"Unknown object type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">zfree</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>refcount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"decrRefCount against refcount &lt;= 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>refcount <span class="token operator">!=</span> OBJ_SHARED_REFCOUNT<span class="token punctuation">)</span> o<span class="token operator">-></span>refcount<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h1 id="7-总结"><a href="#7-总结" class="headerlink" title="(7) 总结"></a>(7) 总结</h1><p>1、要想理解 Redis 数据类型的设计，必须要先了解 redisObject。</p>
<p>Redis 的 key 是 String 类型，但 value 可以是很多类型（String/List/Hash/Set/ZSet等），所以 Redis 要想存储多种数据类型，就要设计一个通用的对象进行封装，这个对象就是 redisObject。</p>
<p>其中，最重要的 2 个字段：</p>
<ul>
<li>type：面向用户的数据类型（String/List/Hash/Set/ZSet等）</li>
<li>encoding：每一种数据类型，可以对应不同的底层数据结构来实现（SDS/ziplist/intset/hashtable/skiplist等）</li>
</ul>
<p>例如 String，可以用 embstr（嵌入式字符串，redisObject 和 SDS 一起分配内存），也可以用 rawstr（redisObject 和 SDS 分开存储）实现。</p>
<p>又或者，当用户写入的是一个「数字」时，底层会转成 long 来存储，节省内存。</p>
<p>同理，Hash/Set/ZSet 在数据量少时，采用 ziplist 存储，否则就转为 hashtable 来存。</p>
<p>所以，redisObject 的作用在于：</p>
<ol>
<li>为多种数据类型提供统一的表示方式</li>
<li>同一种数据类型，底层可以对应不同实现，节省内存<br>3）支持对象共享和引用计数，共享对象存储一份，可多次使用，节省内存</li>
</ol>
<p>redisObject 更像是连接「上层数据类型」和「底层数据结构」之间的桥梁。</p>
<p>2、关于 String 类型的实现，底层对应 3 种数据结构：</p>
<ul>
<li>embstr：小于等于 44 字节，嵌入式存储，redisObject 和 SDS 一起分配内存，只分配 1 次内存</li>
<li>rawstr：大于 44 字节，redisObject 和 SDS 分开存储，需分配 2 次内存</li>
<li>long：整数存储（小于 10000，使用共享对象池存储，但有个前提：Redis 没有设置淘汰策略，详见 object.c 的 tryObjectEncoding 函数）</li>
</ul>
<p>3、ziplist 的特点：</p>
<ol>
<li>连续内存存储：每个元素紧凑排列，内存利用率高</li>
<li>变长编码：存储数据时，采用变长编码（满足数据长度的前提下，尽可能少分配内存）<br>3）寻找元素需遍历：存放太多元素，性能会下降（适合少量数据存储）</li>
<li>级联更新：更新、删除元素，会引发级联更新（因为内存连续，前面数据膨胀/删除了，后面要跟着一起动）<br>List、Hash、Set、ZSet 底层都用到了 ziplist。</li>
</ol>
<p>4、intset 的特点：</p>
<ol>
<li>Set 存储如果都是数字，采用 intset 存储</li>
<li>变长编码：数字范围不同，intset 会选择 int16/int32/int64 编码（intset.c 的 _intsetValueEncoding 函数）<br>3）有序：intset 在存储时是有序的，这意味着查找一个元素，可使用「二分查找」（intset.c 的 intsetSearch 函数）</li>
<li>编码升级/降级：添加、更新、删除元素，数据范围发生变化，会引发编码长度升级</li>
</ol>
<p>了解一下jemalloc 分配内存机制，jemalloc 为了方便管理，在每次分配内存的时候都会返回2的幂次的空间大小，比如我需要分配5字节空间，jemalloc 会返回8字节，15字节会返回16字节。其常见的分配空间大小有： 8, 16, 32, 64, …, 2kb, 4kb, 8kb。</p>
<p>但是这种方式也可能会造成，空间的浪费，比如我需要33字节，结果给我64字节，为了解决这个问题jemalloc将内存分配划分为，小内存（small_class）和大内存（large_class）通过不同的内存大小使用不同阶级策略。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://redisbook.readthedocs.io/en/latest/datatype/object.html">Redis设计与实现-对象处理机制</a><br>[2] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/402223">Redis源码剖析与实战 - 04 内存友好的数据结构该如何细化设计？</a><br>[3] <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/6.0/src/object.c">Redis源码-github</a></p>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2023/04/16/redis-aof-rewrite/" rel="bookmark">Redis AOF 重写</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2023/01/07/redis-data-structure-hash-tables/" rel="bookmark">Redis 数据结构 哈希表(hashtable/dict/map)</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2023/01/15/redis-data-structure-intset/" rel="bookmark">Redis 数据结构 整数集合(intset)</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2023/01/01/redis-data-structure-simple-dynamic-string/" rel="bookmark">Redis 数据结构 简单动态字符串(SDS)</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2023/01/21/redis-data-structure-quicklist/" rel="bookmark">Redis 数据结构 快速列表(quicklist)</a></div>
    </li>
  </ul>

        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/img/pay/wechatpay.png" alt="WKQ 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/img/pay/alipay.png" alt="WKQ 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/redis/" rel="tag"># redis</a>
              <a href="/tags/database/" rel="tag"># database</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/01/07/redis-data-structure-hash-tables/" rel="prev" title="Redis 数据结构 哈希表(hashtable/dict/map)">
      <i class="fa fa-chevron-left"></i> Redis 数据结构 哈希表(hashtable/dict/map)
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/01/14/redis-data-structure-ziplist/" rel="next" title="Redis 数据结构 压缩列表(ziplist)">
      Redis 数据结构 压缩列表(ziplist) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-Redis%E5%AF%B9%E8%B1%A1%E7%B3%BB%E7%BB%9F%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-text">(1) Redis对象系统是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-redisObject%E7%BB%93%E6%9E%84"><span class="nav-text">(1.1) redisObject结构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-redisObject%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-text">(2) redisObject的作用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-redisObject%E5%8E%9F%E7%90%86"><span class="nav-text">(3) redisObject原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-redisObject%E9%87%8Ctype%E5%AF%B9%E5%BA%94%E7%9A%84Redis%E5%AF%B9%E8%B1%A1"><span class="nav-text">(3.1) redisObject里type对应的Redis对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-redisObject%E9%87%8Cencoding%E5%AF%B9%E5%BA%94%E7%9A%84%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A0%81"><span class="nav-text">(3.2) redisObject里encoding对应的对象编码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-redisObject%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-text">(4) redisObject源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-redisObject%E7%BB%93%E6%9E%84%E5%AE%9A%E4%B9%89"><span class="nav-text">(4.1) redisObject结构定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1-createObject"><span class="nav-text">(4.2) 创建对象-createObject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E5%88%9B%E5%BB%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1"><span class="nav-text">(4.3) 创建字符串对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8E%9F%E5%A7%8B-raw-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1"><span class="nav-text">(4.3.1) 创建一个原始(raw)字符串对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-%E5%88%9B%E5%BB%BA%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1-createEmbeddedStringObject"><span class="nav-text">(4.3.2) 创建嵌入式字符串对象-createEmbeddedStringObject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-%E5%88%9B%E5%BB%BA%E6%95%B4%E6%95%B0%E5%9E%8B%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-text">(4.3.3) 创建整数型字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-4-%E5%A4%8D%E5%88%B6%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1-dupStringObject"><span class="nav-text">(4.3.4) 复制字符串对象-dupStringObject</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E5%88%9B%E5%BB%BA%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1"><span class="nav-text">(2.4) 创建列表对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-%E5%88%9B%E5%BB%BA%E5%BF%AB%E9%80%9F%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1-createQuicklistObject"><span class="nav-text">(2.4.1) 创建快速列表对象-createQuicklistObject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-%E5%88%9B%E5%BB%BA%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1-createZiplistObject"><span class="nav-text">(2.4.2) 创建压缩列表对象-createZiplistObject</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E9%9B%86%E5%90%88"><span class="nav-text">(2.5) 集合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-1-%E5%88%9B%E5%BB%BA%E9%9B%86%E5%90%88-createSetObject"><span class="nav-text">(2.5.1) 创建集合-createSetObject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-2-%E5%88%9B%E5%BB%BA%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88-createIntsetObject"><span class="nav-text">(2.5.2) 创建整数集合-createIntsetObject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88"><span class="nav-text">(2.6) 有序集合</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-1-%E5%88%9B%E5%BB%BA%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1-createZsetObject"><span class="nav-text">(2.6.1) 创建有序集合对象-createZsetObject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-2-%E5%88%9B%E5%BB%BA%E7%BC%96%E7%A0%81%E4%B8%BA%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E7%9A%84%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1-createZsetZiplistObject"><span class="nav-text">(2.6.2) 创建编码为压缩列表的有序集合对象-createZsetZiplistObject</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-7-%E5%93%88%E5%B8%8C"><span class="nav-text">(2.7) 哈希</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-8-%E6%A8%A1%E5%9D%97"><span class="nav-text">(2.8) 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-9-%E6%B5%81"><span class="nav-text">(2.9) 流</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-redisObject%E9%87%8C%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="nav-text">(3) redisObject里内存优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E4%BD%8D%E5%9F%9F%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95"><span class="nav-text">(3.1) 位域定义方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-text">(3.2) 嵌入式字符串</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-%E4%B8%BA%E4%BB%80%E4%B9%88EMBSTR%E7%9A%84%E5%A4%A7%E5%B0%8F%E8%A6%81-lt-44"><span class="nav-text">(3.2.1) 为什么EMBSTR的大小要&lt;&#x3D;44</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E5%91%BD%E4%BB%A4%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%9F%A5%E5%92%8C%E5%A4%9A%E6%80%81"><span class="nav-text">(4) 命令的类型检查和多态</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB"><span class="nav-text">(5) 对象共享</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E4%BB%A5%E5%8F%8A%E5%AF%B9%E8%B1%A1%E7%9A%84%E9%94%80%E6%AF%81"><span class="nav-text">(6) 引用计数以及对象的销毁</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-%E6%80%BB%E7%BB%93"><span class="nav-text">(7) 总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">313</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



<script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5rcgvdncuwu&amp;m=7&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>


      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'Ca876j76FoCQi1SShjT0qC6k-gzGzoHsz',
      appKey     : 'IeozLmM20GuvfcslfWgdNXP0',
      placeholder: "期待您的评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
