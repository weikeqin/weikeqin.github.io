<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="msvalidate.01" content="CBB4A6675274A9B82BB82B104F7915A7">
  <meta name="yandex-verification" content="4fa4531dcc9e1bfd">
  <meta name="baidu-site-verification" content="1d263b839540cec80d3497b2f877c5da">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"weikeqin.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"waline","storage":true,"lazyload":false,"nav":null,"activeClass":"waline"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="哈希表是一种非常关键的数据结构，在计算机系统中发挥着重要作用。  它的底层是数组+链表，通过哈希计算，能以 O(1) 的复杂度快速根据key查询到数据。 (1) 数据结构-哈希表  假设让我们自己实现一个哈希表，我们要考虑哪些方面？  哈希表提供的功能 哈希表操作的时间复杂度为O(1) 哈希表的容量与扩容  (1.1) 哈希表的常用方法  新建哈希表、新增数据、修改数据、删除数据、查询数据 (">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 数据结构 哈希表(hashtable&#x2F;dict&#x2F;map)">
<meta property="og:url" content="http://weikeqin.com/2023/01/07/redis-data-structure-hash-tables/index.html">
<meta property="og:site_name" content="天道酬勤">
<meta property="og:description" content="哈希表是一种非常关键的数据结构，在计算机系统中发挥着重要作用。  它的底层是数组+链表，通过哈希计算，能以 O(1) 的复杂度快速根据key查询到数据。 (1) 数据结构-哈希表  假设让我们自己实现一个哈希表，我们要考虑哪些方面？  哈希表提供的功能 哈希表操作的时间复杂度为O(1) 哈希表的容量与扩容  (1.1) 哈希表的常用方法  新建哈希表、新增数据、修改数据、删除数据、查询数据 (">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/data-structure/hashtable/hash-function.svg">
<meta property="og:image" content="http://weikeqin.com/img/database/redis/data-structure/hashtable/hashtable.svg">
<meta property="article:published_time" content="2023-01-07T12:39:57.000Z">
<meta property="article:modified_time" content="2023-03-05T03:25:51.471Z">
<meta property="article:author" content="WKQ">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="database">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://weikeqin.com/img/database/redis/data-structure/hashtable/hash-function.svg">


<link rel="canonical" href="http://weikeqin.com/2023/01/07/redis-data-structure-hash-tables/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://weikeqin.com/2023/01/07/redis-data-structure-hash-tables/","path":"2023/01/07/redis-data-structure-hash-tables/","title":"Redis 数据结构 哈希表(hashtable/dict/map)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Redis 数据结构 哈希表(hashtable/dict/map) | 天道酬勤</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?d1ad0ae2a9976c44d556abc07cda1365"></script>






<link rel="dns-prefetch" href="waline-server-one-omega.vercel.app">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">天道酬勤</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">坚持，努力，让好事发生</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%93%88%E5%B8%8C%E8%A1%A8"><span class="nav-number">1.</span> <span class="nav-text">(1) 数据结构-哈希表</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E5%93%88%E5%B8%8C%E8%A1%A8%E7%9A%84%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">1.1.</span> <span class="nav-text">(1.1) 哈希表的常用方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0-%E4%BC%98%E5%8C%96%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E7%9A%84%E5%88%A9%E5%99%A8"><span class="nav-number">1.2.</span> <span class="nav-text">(1.2) 哈希函数-优化时间复杂度的利器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E5%93%88%E5%B8%8C%E8%A1%A8%E5%AE%B9%E9%87%8F%E4%B8%8E%E6%89%A9%E5%AE%B9"><span class="nav-number">1.3.</span> <span class="nav-text">(1.3) 哈希表容量与扩容</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Redis%E9%87%8C%E7%9A%84%E5%93%88%E5%B8%8C%E8%A1%A8"><span class="nav-number">2.</span> <span class="nav-text">(2) Redis里的哈希表</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E5%93%88%E5%B8%8C%E8%A1%A8%E7%BB%93%E6%9E%84%E5%AE%9A%E4%B9%89"><span class="nav-number">2.1.</span> <span class="nav-text">(2.1) 哈希表结构定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E5%93%88%E5%B8%8C%E8%A1%A8%E6%8F%90%E4%BE%9B%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-number">2.2.</span> <span class="nav-text">(2.2) 哈希表提供的功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%93%88%E5%B8%8C%E8%A1%A8"><span class="nav-number">2.2.1.</span> <span class="nav-text">(2.2.1) 创建一个哈希表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-%E5%93%88%E5%B8%8C%E8%A1%A8%E6%B7%BB%E5%8A%A0%E5%85%83%E7%B4%A0"><span class="nav-number">2.2.2.</span> <span class="nav-text">(2.2.2) 哈希表添加元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-%E5%93%88%E5%B8%8C%E8%A1%A8%E6%9B%B4%E6%96%B0%E5%85%83%E7%B4%A0"><span class="nav-number">2.2.3.</span> <span class="nav-text">(2.2.3) 哈希表更新元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-4-%E5%93%88%E5%B8%8C%E8%A1%A8%E6%9F%A5%E6%89%BE%E5%85%83%E7%B4%A0"><span class="nav-number">2.2.4.</span> <span class="nav-text">(2.2.4) 哈希表查找元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-5-%E5%93%88%E5%B8%8C%E8%A1%A8%E5%88%A0%E9%99%A4%E5%85%83%E7%B4%A0"><span class="nav-number">2.2.5.</span> <span class="nav-text">(2.2.5) 哈希表删除元素</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-5-%E6%9F%A5%E6%89%BEkey%E7%9A%84%E4%B8%8B%E6%A0%87"><span class="nav-number">2.3.</span> <span class="nav-text">(2.2.5) 查找key的下标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E5%93%88%E5%B8%8C%E8%A1%A8%E6%89%A9%E5%AE%B9"><span class="nav-number">2.4.</span> <span class="nav-text">(2.3) 哈希表扩容</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E6%B8%90%E8%BF%9B%E5%BC%8Frehash"><span class="nav-number">3.</span> <span class="nav-text">(3) 渐进式rehash</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-rehash%E7%9A%84%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%8F%91%E7%94%9Frehash"><span class="nav-number">3.1.</span> <span class="nav-text">(3.1) rehash的触发条件-什么时候发生rehash</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-%E5%9C%A8%E5%93%AA%E4%BA%9B%E5%87%BD%E6%95%B0%E9%87%8C%E8%B0%83%E7%94%A8%E4%BA%86-dictExpandIfNeeded"><span class="nav-number">3.1.1.</span> <span class="nav-text">(3.1.1) 在哪些函数里调用了_dictExpandIfNeeded</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%B8%90%E8%BF%9B%E5%BC%8Frehash%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%EF%BC%9F"><span class="nav-number">3.2.</span> <span class="nav-text">(3.2) 渐进式rehash如何执行？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E6%B8%90%E8%BF%9B%E5%BC%8Frehash%E6%97%B6%EF%BC%8C%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E6%93%8D%E4%BD%9C%E5%93%AA%E4%B8%AA%E5%93%88%E5%B8%8C%E8%A1%A8"><span class="nav-number">3.3.</span> <span class="nav-text">(3.3) 渐进式rehash时，增删改查操作哪个哈希表?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-rehash%E6%89%A9%E5%AE%B9%E5%90%8E%E6%9C%89%E5%A4%9A%E5%A4%A7-rehash%E7%9A%84%E7%BB%93%E6%9E%9C"><span class="nav-number">3.4.</span> <span class="nav-text">(3.4) rehash扩容后有多大-rehash的结果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-Redis%E9%87%8C%E7%9A%84Hash%E5%87%BD%E6%95%B0"><span class="nav-number">4.</span> <span class="nav-text">(4) Redis里的Hash函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E6%80%BB%E7%BB%93"><span class="nav-number">5.</span> <span class="nav-text">(5) 总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">6.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WKQ</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">315</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:weikeqin.cn@gmail.com" title="E-Mail → mailto:weikeqin.cn@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

<script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5rcgvdncuwu&amp;m=7&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>


        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2023/01/07/redis-data-structure-hash-tables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WKQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天道酬勤">
      <meta itemprop="description" content="不积跬步无以至千里">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Redis 数据结构 哈希表(hashtable/dict/map) | 天道酬勤">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis 数据结构 哈希表(hashtable/dict/map)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-01-07 20:39:57" itemprop="dateCreated datePublished" datetime="2023-01-07T20:39:57+08:00">2023-01-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-03-05 11:25:51" itemprop="dateModified" datetime="2023-03-05T11:25:51+08:00">2023-03-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/01/07/redis-data-structure-hash-tables/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/01/07/redis-data-structure-hash-tables/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>17k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>16 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>  哈希表是一种非常关键的数据结构，在计算机系统中发挥着重要作用。<br>  它的底层是数组+链表，通过哈希计算，能以 O(1) 的复杂度快速根据key查询到数据。</p>
<h1 id="1-数据结构-哈希表"><a href="#1-数据结构-哈希表" class="headerlink" title="(1) 数据结构-哈希表"></a>(1) 数据结构-哈希表</h1><p>  假设让我们自己实现一个哈希表，我们要考虑哪些方面？</p>
<ol>
<li>哈希表提供的功能</li>
<li>哈希表操作的时间复杂度为O(1)</li>
<li>哈希表的容量与扩容</li>
</ol>
<h2 id="1-1-哈希表的常用方法"><a href="#1-1-哈希表的常用方法" class="headerlink" title="(1.1) 哈希表的常用方法"></a>(1.1) 哈希表的常用方法</h2><p>  新建哈希表、新增数据、修改数据、删除数据、查询数据</p>
<h2 id="1-2-哈希函数-优化时间复杂度的利器"><a href="#1-2-哈希函数-优化时间复杂度的利器" class="headerlink" title="(1.2) 哈希函数-优化时间复杂度的利器"></a>(1.2) 哈希函数-优化时间复杂度的利器</h2><p>  要想使时间复杂度为O(1)，要通过高效的定位方法，比如hash函数 </p>
<p>  <img src="/img/database/redis/data-structure/hashtable/hash-function.svg" alt="哈希函数"></p>
<span id="more"></span>

<p>  但是hash函数有个问题，可能会哈希冲突，冲突后有多种方法 <code>链地址法</code>、 <code>开放定位法</code>、 <code>再哈希法</code>，这里我们使用链地址法实现。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* 哈希函数 */</span>
<span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> h<span class="token punctuation">;</span>
    <span class="token comment">// h = key.hashCode() 为第一步 取hashCode值</span>
    <span class="token comment">// h ^ (h >>> 16)  为第二步 高位参与运算</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  链式哈希的链不能太长，否则会降低 哈希表性能。<br>  链表哈希的链表太长时可以转换为红黑树提高查询性能。</p>
<br>

<h2 id="1-3-哈希表容量与扩容"><a href="#1-3-哈希表容量与扩容" class="headerlink" title="(1.3) 哈希表容量与扩容"></a>(1.3) 哈希表容量与扩容</h2><p>  这里我们在创建哈希表的时候支持指定容量<br>  扩容时容量是原来的2倍</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>  如果容量特别大，内存不够怎么办？</p>
<br>


<h1 id="2-Redis里的哈希表"><a href="#2-Redis里的哈希表" class="headerlink" title="(2) Redis里的哈希表"></a>(2) Redis里的哈希表</h1><p>  对于 Redis 键值数据库来说，哈希表既是键值对中的一种值类型，同时，Redis 也使用一个全局 哈希表来保存所有的键值对，从而既满足应用存取 Hash 结构数据需求，又能提供快速查询功能。</p>
<p>  在实际应用 哈希表时，当数据量不断增加，它的性能就经常会受到<code>哈希冲突</code>和 <code>rehash</code> 开销的影响。</p>
<p>  针对哈希冲突，Redis 采用了链式哈希，在不扩容哈希表的前提下，将具有相同哈希值的数据链接起来，以便这些数据在表中仍然可以被查询到；<br>  对于 rehash 开销，Redis 实现了渐进式 rehash 设计，进而缓解了 rehash 操作带来的额外开销对系统的性能影响。</p>
<p>  <code>dict.h</code> 文件定义了 哈希表的结构、哈希项，以及 哈希表的各种操作函数，<br>  <code>dict.c</code> 文件包含了 哈希表各种操作的具体实现代码。  </p>
<p>  源码  <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/6.0/src/dict.h">https://github.com/redis/redis/blob/6.0/src/dict.h</a><br>       <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/6.0/src/dict.c">https://github.com/redis/redis/blob/6.0/src/dict.c</a></p>
<br>

<h2 id="2-1-哈希表结构定义"><a href="#2-1-哈希表结构定义" class="headerlink" title="(2.1) 哈希表结构定义"></a>(2.1) 哈希表结构定义</h2><p>  <img src="/img/database/redis/data-structure/hashtable/hashtable.svg" alt="哈希表结构"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * 这是哈希表结构。
 * 每个字典都有两个这样的字典，因为我们实现了增量重新哈希，从旧表到新表。 
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictht</span> <span class="token punctuation">&#123;</span>
    dictEntry <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">;</span>  <span class="token comment">// 哈希节点数组  一维数组的指针</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>  <span class="token comment">// 哈希表大小</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sizemask<span class="token punctuation">;</span>  <span class="token comment">// 哈希表大小掩码，用于计算索引值，等于 size - 1</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">;</span>  <span class="token comment">// 哈希表已使用节点个数</span>
<span class="token punctuation">&#125;</span> dictht<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * 哈希表节点
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">;</span> <span class="token comment">// key的指针</span>
    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>
        <span class="token class-name">uint64_t</span> u64<span class="token punctuation">;</span>
        <span class="token class-name">int64_t</span> s64<span class="token punctuation">;</span>
        <span class="token keyword">double</span> d<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> v<span class="token punctuation">;</span>  <span class="token comment">// value  联合结构体(不同场景使用不同大小，省内存)</span>
    <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment">// 链表的下一个节点的指针</span>
<span class="token punctuation">&#125;</span> dictEntry<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  可以看到 哈希表<code>dictht</code>里定义了 二维数组()、哈希表大小、<br>  哈希节点里定义了 键(key)、值(v)、链表的下一个节点(next)，其中值(v)是一个联合体，联合体中包含了指向实际值的指针 *val，还包含了无符号的 64 位整数、有符号的 64 位整数，以及 double 类的值。</p>
<p>  为什么要使用联合体呢？<br>  这种实现方法是一种节省内存的小技巧，因为当值为整数或双精度浮点数时，由于其本身就是64位，就可以不用指针指向了，而是可以直接存在键值对的结构体中，这样就避免了再用一个指针，从而节省了内存空间。</p>
<br>


<h2 id="2-2-哈希表提供的功能"><a href="#2-2-哈希表提供的功能" class="headerlink" title="(2.2) 哈希表提供的功能"></a>(2.2) 哈希表提供的功能</h2><table>
<thead>
<tr>
<th>操作</th>
<th>函数</th>
<th>算法复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>创建一个新字典</td>
<td>dictCreate</td>
<td>O(1)</td>
</tr>
<tr>
<td>添加新键值对到字典</td>
<td>dictAdd</td>
<td>O(1)</td>
</tr>
<tr>
<td>添加或更新给定键的值</td>
<td>dictReplace</td>
<td>O(1)</td>
</tr>
<tr>
<td>在字典中查找给定键所在的节点</td>
<td>dictFind</td>
<td>O(1)</td>
</tr>
<tr>
<td>在字典中查找给定键的值</td>
<td>dictFetchValue</td>
<td>O(1)</td>
</tr>
<tr>
<td>从字典中随机返回一个节点</td>
<td>dictGetRandomKey</td>
<td>O(1)</td>
</tr>
<tr>
<td>根据给定键，删除字典中的键值对</td>
<td>dictDelete</td>
<td>O(1)</td>
</tr>
<tr>
<td>清空并释放字典</td>
<td>dictRelease</td>
<td>O(N)</td>
</tr>
<tr>
<td>清空并重置（但不释放）字典</td>
<td>dictEmpty</td>
<td>O(N)</td>
</tr>
<tr>
<td>缩小字典</td>
<td>dictResize</td>
<td>O(N)</td>
</tr>
<tr>
<td>扩大字典</td>
<td>dictExpand</td>
<td>O(N)</td>
</tr>
<tr>
<td>对字典进行给定步数的 rehash</td>
<td>dictRehash</td>
<td>O(N)</td>
</tr>
<tr>
<td>在给定毫秒内，对字典进行rehash</td>
<td>dictRehashMilliseconds</td>
<td>O(N)</td>
</tr>
</tbody></table>
<br>


<h3 id="2-2-1-创建一个哈希表"><a href="#2-2-1-创建一个哈希表" class="headerlink" title="(2.2.1) 创建一个哈希表"></a>(2.2.1) 创建一个哈希表</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 创建一个新的哈希表 */</span>
dict <span class="token operator">*</span><span class="token function">dictCreate</span><span class="token punctuation">(</span>dictType <span class="token operator">*</span>type<span class="token punctuation">,</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>privDataPtr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 分配内存</span>
    dict <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化</span>
    <span class="token function">_dictInit</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span>type<span class="token punctuation">,</span>privDataPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> d<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 初始化哈希表 */</span>
<span class="token keyword">int</span> <span class="token function">_dictInit</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> dictType <span class="token operator">*</span>type<span class="token punctuation">,</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>privDataPtr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">_dictReset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重置ht[0]</span>
    <span class="token function">_dictReset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重置ht[1]</span>
    d<span class="token operator">-></span>type <span class="token operator">=</span> type<span class="token punctuation">;</span> <span class="token comment">// 设置哈希表类型</span>
    d<span class="token operator">-></span>privdata <span class="token operator">=</span> privDataPtr<span class="token punctuation">;</span> <span class="token comment">// </span>
    d<span class="token operator">-></span>rehashidx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 设置成-1 代表没有进行rehash</span>
    d<span class="token operator">-></span>iterators <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// </span>
    <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 重置已经初始化的哈希表
 * NOTE: This function should only be called by ht_destroy(). */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_dictReset</span><span class="token punctuation">(</span>dictht <span class="token operator">*</span>ht<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    ht<span class="token operator">-></span>table <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 哈希表的数组置为null</span>
    ht<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 哈希表长度设置为0</span>
    ht<span class="token operator">-></span>sizemask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 掩码设置为0</span>
    ht<span class="token operator">-></span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 已使用空间设置为0</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>


<h3 id="2-2-2-哈希表添加元素"><a href="#2-2-2-哈希表添加元素" class="headerlink" title="(2.2.2) 哈希表添加元素"></a>(2.2.2) 哈希表添加元素</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: dict.c</span>

<span class="token comment">/* 
 * 往哈希表添加一个元素
 * 
 * @param *d
 * @param *key
 * @param *val
 */</span>
<span class="token keyword">int</span> <span class="token function">dictAdd</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建哈希节点 并设置key  (这个时候没有往哈希表设置val)</span>
    dictEntry <span class="token operator">*</span>entry <span class="token operator">=</span> <span class="token function">dictAddRaw</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span> <span class="token keyword">return</span> DICT_ERR<span class="token punctuation">;</span>
    <span class="token comment">// 哈希表设置val</span>
    <span class="token function">dictSetVal</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 *  低级添加或查找：
 *  此函数添加条目但不是设置值，而是将 dictEntry 结构返回给用户，这将确保按照他的意愿填充值字段。
 *
 *  这个函数也是直接暴露给用户API调用的，主要是为了在hash值里面存储非指针，例如：
 *
 *    entry = dictAddRaw(dict,mykey,NULL);
 *    if (entry != NULL) dictSetSignedIntegerVal(entry,1000);
 *
 *  返回值：
 *    如果键已经存在，则返回 NULL，如果 existing 不为 NULL，则“*existing”将填充现有条目。
 *    如果添加了键，则返回哈希条目以供调用者操作。
 */</span>
dictEntry <span class="token operator">*</span><span class="token function">dictAddRaw</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> dictEntry <span class="token operator">*</span><span class="token operator">*</span>existing<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> index<span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>entry<span class="token punctuation">;</span>
    dictht <span class="token operator">*</span>ht<span class="token punctuation">;</span>

    <span class="token comment">// 如果正在rehash，进行rehash   这里只迁移一个桶，几乎对性能无影响</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">_dictRehashStep</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取元素下标  如果元素已经存在返回-1 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token function">_dictKeyIndex</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">dictHashKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> existing<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">/* 分配内存并存储新条目。
     * 在顶部插入元素，假设在数据库系统中，最近添加的条目更有可能被更频繁地访问。*/</span>

    <span class="token comment">// 如果在进行rehash，往ht[1]里添加元素 </span>
    ht <span class="token operator">=</span> <span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">&amp;</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 为新节点分配内存</span>
    entry <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 把新节点插入到链表的头部</span>
    entry<span class="token operator">-></span>next <span class="token operator">=</span> ht<span class="token operator">-></span>table<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新链表头结点</span>
    ht<span class="token operator">-></span>table<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token comment">// 哈希表已使用节点数+1</span>
    ht<span class="token operator">-></span>used<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment">/* Set the hash entry fields. */</span>
    <span class="token function">dictSetKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file:  dict.h</span>

<span class="token comment">/* 设置key */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">dictSetKey</span><span class="token expression"><span class="token punctuation">(</span>d<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> _key_<span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">-></span>type<span class="token operator">-></span>keyDup<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token operator">-></span>key <span class="token operator">=</span> <span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">-></span>type<span class="token operator">-></span><span class="token function">keyDup</span><span class="token punctuation">(</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">-></span>privdata<span class="token punctuation">,</span> _key_<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">else</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token operator">-></span>key <span class="token operator">=</span> <span class="token punctuation">(</span>_key_<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file:  dict.h</span>

<span class="token comment">/* 设置val */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">dictSetVal</span><span class="token expression"><span class="token punctuation">(</span>d<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> _val_<span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">-></span>type<span class="token operator">-></span>valDup<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token operator">-></span>v<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">-></span>type<span class="token operator">-></span><span class="token function">valDup</span><span class="token punctuation">(</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">-></span>privdata<span class="token punctuation">,</span> _val_<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">else</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token operator">-></span>v<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token punctuation">(</span>_val_<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>

<h3 id="2-2-3-哈希表更新元素"><a href="#2-2-3-哈希表更新元素" class="headerlink" title="(2.2.3) 哈希表更新元素"></a>(2.2.3) 哈希表更新元素</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * 添加或覆盖：
 *  添加一个元素，如果键已经存在则丢弃旧值。
 *  如果该键是从头开始添加的，则返回 1，
 *  如果已经存在具有该键的元素，则返回 0，并且 dictReplace() 刚刚执行了值更新操作。
 */</span>
<span class="token keyword">int</span> <span class="token function">dictReplace</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    dictEntry <span class="token operator">*</span>entry<span class="token punctuation">,</span> <span class="token operator">*</span>existing<span class="token punctuation">,</span> auxentry<span class="token punctuation">;</span>

    <span class="token comment">// 添加条目</span>
    entry <span class="token operator">=</span> <span class="token function">dictAddRaw</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token operator">&amp;</span>existing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 设置值</span>
        <span class="token function">dictSetVal</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* 设置新值并释放旧值。 
     * 请注意，按此顺序执行此操作很重要，因为值可能与前一个值完全相同。 
     * 在这种情况下，想想引用计数，你想要递增（设置），然后递减（自由），而不是相反。
     */</span>
    auxentry <span class="token operator">=</span> <span class="token operator">*</span>existing<span class="token punctuation">;</span>
    <span class="token comment">// 覆盖值</span>
    <span class="token function">dictSetVal</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> existing<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 释放原来的</span>
    <span class="token function">dictFreeVal</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token operator">&amp;</span>auxentry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>

<h3 id="2-2-4-哈希表查找元素"><a href="#2-2-4-哈希表查找元素" class="headerlink" title="(2.2.4) 哈希表查找元素"></a>(2.2.4) 哈希表查找元素</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * 
 * @param *d
 * @param *key
 */</span>
dictEntry <span class="token operator">*</span><span class="token function">dictFind</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    dictEntry <span class="token operator">*</span>he<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> h<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> table<span class="token punctuation">;</span>

    <span class="token comment">// 字典是空的，字典里两个哈希表都是空的 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictSize</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* dict is empty */</span>
    <span class="token comment">// 哈希表正在rehash，执行rehash</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">_dictRehashStep</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算key的hash</span>
    h <span class="token operator">=</span> <span class="token function">dictHashKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 有2个哈希表 ht[0] ht[1]，有可能正在rehash，所以都要查，对应代码是 table=0 table&lt;=1 </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> table <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> table<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取数组索引下标</span>
        idx <span class="token operator">=</span> h <span class="token operator">&amp;</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span>
        <span class="token comment">// 桶/链表头结点</span>
        he <span class="token operator">=</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历链表</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>he<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// key相同 或 key对比相等</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token operator">==</span>he<span class="token operator">-></span>key <span class="token operator">||</span> <span class="token function">dictCompareKeys</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">,</span> he<span class="token operator">-></span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> he<span class="token punctuation">;</span> <span class="token comment">// 返回对应节点</span>
            he <span class="token operator">=</span> he<span class="token operator">-></span>next<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>

<h3 id="2-2-5-哈希表删除元素"><a href="#2-2-5-哈希表删除元素" class="headerlink" title="(2.2.5) 哈希表删除元素"></a>(2.2.5) 哈希表删除元素</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * 删除一个元素
 * 成功时返回 DICT_OK，如果找不到该元素则返回 DICT_ERR。 
 * 
 * @param *ht
 * @param *key
 */</span>
<span class="token keyword">int</span> <span class="token function">dictDelete</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>ht<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">dictGenericDelete</span><span class="token punctuation">(</span>ht<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> DICT_OK <span class="token operator">:</span> DICT_ERR<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * 搜索并删除元素。
 * 这是 dictDelete() 和 dictUnlink()的辅助函数，请检查这些函数的顶部注释。
 * 
 * @param *d
 * @param *key 
 * @param nofree 
 */</span>
<span class="token keyword">static</span> dictEntry <span class="token operator">*</span><span class="token function">dictGenericDelete</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> nofree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint64_t</span> h<span class="token punctuation">,</span> idx<span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>he<span class="token punctuation">,</span> <span class="token operator">*</span>prevHe<span class="token punctuation">;</span>
    <span class="token keyword">int</span> table<span class="token punctuation">;</span>

    <span class="token comment">// ht[0] ht[1] 已使用大小为0，返回null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果正在rehash，执行rehash</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">_dictRehashStep</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取hash值</span>
    h <span class="token operator">=</span> <span class="token function">dictHashKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ht[0] ht[1] 都会查，所以 table=0 table&lt;=1 </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> table <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> table<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取下标</span>
        idx <span class="token operator">=</span> h <span class="token operator">&amp;</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span>
        <span class="token comment">// 获取桶</span>
        he <span class="token operator">=</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        prevHe <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历链表</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>he<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token operator">==</span>he<span class="token operator">-></span>key <span class="token operator">||</span> <span class="token function">dictCompareKeys</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">,</span> he<span class="token operator">-></span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/* Unlink the element from the list */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prevHe<span class="token punctuation">)</span>
                    prevHe<span class="token operator">-></span>next <span class="token operator">=</span> he<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// 移除链表里的当前节点</span>
                <span class="token keyword">else</span>
                    d<span class="token operator">-></span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> he<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// 设置next节点为头结点，next有可能是null</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nofree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 释放key</span>
                    <span class="token function">dictFreeKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> he<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 释放val</span>
                    <span class="token function">dictFreeVal</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> he<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 释放entry</span>
                    <span class="token function">zfree</span><span class="token punctuation">(</span>he<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// 更新使用元素个数</span>
                d<span class="token operator">-></span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> he<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// 更新前驱节点</span>
            prevHe <span class="token operator">=</span> he<span class="token punctuation">;</span>
            <span class="token comment">// 处理下一个节点</span>
            he <span class="token operator">=</span> he<span class="token operator">-></span>next<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 没有找到key</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="2-2-5-查找key的下标"><a href="#2-2-5-查找key的下标" class="headerlink" title="(2.2.5) 查找key的下标"></a>(2.2.5) 查找key的下标</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Returns the index of a free slot that can be populated with
 * a hash entry for the given 'key'.
 * If the key already exists, -1 is returned
 * and the optional output parameter may be filled.
 *
 * Note that if we are in the process of rehashing the hash table, the
 * index is always returned in the context of the second (new) hash table. 
 *
 * @param *d 哈希表
 * @param *key key的指针
 * @param hash key的哈希值
 * @param **existing 已存在的哈希节点指针
 */</span>
<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">_dictKeyIndex</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> hash<span class="token punctuation">,</span> dictEntry <span class="token operator">*</span><span class="token operator">*</span>existing<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> idx<span class="token punctuation">,</span> table<span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>he<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existing<span class="token punctuation">)</span> <span class="token operator">*</span>existing <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果哈希表正在扩容返回 DICT_ERR 返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_dictExpandIfNeeded</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">==</span> DICT_ERR<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历2个哈希表     </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> table <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> table<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取key的数组下标</span>
        idx <span class="token operator">=</span> hash <span class="token operator">&amp;</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span>
        <span class="token comment">/* Search if this slot does not already contain the given key */</span>
        <span class="token comment">// 链表节点</span>
        he <span class="token operator">=</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历链表</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>he<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token operator">==</span>he<span class="token operator">-></span>key <span class="token operator">||</span> <span class="token function">dictCompareKeys</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">,</span> he<span class="token operator">-></span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// key已存在，existing的指针指向哈希节点he</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>existing<span class="token punctuation">)</span> <span class="token operator">*</span>existing <span class="token operator">=</span> he<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            he <span class="token operator">=</span> he<span class="token operator">-></span>next<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> idx<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<br>

<h2 id="2-3-哈希表扩容"><a href="#2-3-哈希表扩容" class="headerlink" title="(2.3) 哈希表扩容"></a>(2.3) 哈希表扩容</h2><p>  哈希表扩容是指 rehash 操作，其实就是指扩大 哈希表空间。</p>
<p>Redis rehash流程</p>
<ol>
<li>Redis里保存了两个 Hash表 <code>ht[0]</code>和 <code>ht[1]</code>，用于 rehash 时交替保存数据；</li>
<li>在正常服务请求阶段，所有的键值对写入哈希表 ht[0]；</li>
<li>当进行 rehash 时，键值对被迁移到哈希表 ht[1]中；</li>
<li>当迁移完成后，ht[0]的空间会被释放，并把 ht[1]的地址赋值给 ht[0]，ht[1]的表大小设置为 0</li>
</ol>
<p>  这样一来，又回到了正常服务请求的阶段，ht[0]接收和服务请求，ht[1]作为下一次 rehash 时的迁移表。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dict</span> <span class="token punctuation">&#123;</span>
    dictType <span class="token operator">*</span>type<span class="token punctuation">;</span> <span class="token comment">// 类型</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">;</span> <span class="token comment">//</span>
    dictht ht<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 2个哈希表</span>
    <span class="token keyword">long</span> rehashidx<span class="token punctuation">;</span> <span class="token comment">// rehashidx == -1 则rehashing没有进行  </span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> iterators<span class="token punctuation">;</span> <span class="token comment">// 当前正在运行的迭代器数</span>
<span class="token punctuation">&#125;</span> dict<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  在rehashing时，<code>rehashidx</code>对应要操作的 <code>ht[0].table[rehashidx]</code> 的桶</p>
<br>



<h1 id="3-渐进式rehash"><a href="#3-渐进式rehash" class="headerlink" title="(3) 渐进式rehash"></a>(3) 渐进式rehash</h1><p>  rehash的整体流程</p>
<h2 id="3-1-rehash的触发条件-什么时候发生rehash"><a href="#3-1-rehash的触发条件-什么时候发生rehash" class="headerlink" title="(3.1) rehash的触发条件-什么时候发生rehash"></a>(3.1) rehash的触发条件-什么时候发生rehash</h2><ol>
<li><p>在哈希表为空时，调用<code>_dictExpandIfNeeded</code>会触发哈希表初始化，默认大小为4。</p>
</li>
<li><p>在哈希表不为空时，触发rehash需要同时满足2个条件:</p>
</li>
</ol>
<ul>
<li>已使用桶数量:哈希表桶容量 达到了 1:1 的比例 (<code>ht[0].used &gt; ht[0].size</code>)</li>
<li>允许调整哈希表的大小(<code>dict_can_resize=1</code>) 或者 元素/桶 &gt; 5 (<code>dict_force_resize_ratio&gt;5</code>)</li>
</ul>
<p>  具体代码如下:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: dict.c </span>

<span class="token comment">/* 
 * 如果需要扩展哈希表
 *
 * @param *d
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">_dictExpandIfNeeded</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 增量rehash正在进行中，返回   通过 rehashidx != -1 判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>

    <span class="token comment">// 如果哈希表为空，则将其扩展到初始大小。 初始大小默认为4 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">dictExpand</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> DICT_HT_INITIAL_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 
     * 如果 已使用桶数量:哈希表桶容量 达到了 1:1 的比例，
     * 并且我们被允许调整哈希表的大小(全局设置) 或者 应该避免它但是元素/桶之间的比例超过了“安全”阈值 5 ，
     * 我们调整大小使桶的数量为原来2倍。
     * 
     * If we reached the 1:1 ratio, and we are allowed to resize the hash
     * table (global setting) or we should avoid it but the ratio between
     * elements/buckets is over the "safe" threshold, we resize doubling
     * the number of buckets. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">>=</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>dict_can_resize <span class="token operator">||</span>
         d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token operator">/</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">></span> dict_force_resize_ratio<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// dict_force_resize_ratio 默认为5 </span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 扩容</span>
        <span class="token keyword">return</span> <span class="token function">dictExpand</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>dict_can_resize</code> 变量值默认是1，可以在 <code>dictEnableResize</code>、 <code>dictDisableResize</code> 函数中设置</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// file: dict.c </span>

<span class="token comment">/* 
 * 使用 dictEnableResize() / dictDisableResize() 我们可以根据需要启用/禁用哈希表的大小调整。 
 * 这对 Redis 来说非常重要，因为我们使用写时复制，并且不想在有子进程正在执行保存操作时移动太多内存。
 *
 * 请注意，即使将 dict_can_resize 设置为 0，也不会阻止所有调整大小：
 *   如果元素数量与桶数之间的比率 > dict_force_resize_ratio，则哈希表仍然允许增长。
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> dict_can_resize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">dictEnableResize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    dict_can_resize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">dictDisableResize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    dict_can_resize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>dict_force_resize_ratio</code> 值在 <code>dict.c</code> 文件中定义，默认是5</p>
<h3 id="3-1-1-在哪些函数里调用了-dictExpandIfNeeded"><a href="#3-1-1-在哪些函数里调用了-dictExpandIfNeeded" class="headerlink" title="(3.1.1) 在哪些函数里调用了_dictExpandIfNeeded"></a>(3.1.1) 在哪些函数里调用了_dictExpandIfNeeded</h3><p> <code>_dictExpandIfNeeded</code> 是被 <code>_dictKeyIndex</code> 函数调用的<br> <code>_dictKeyIndex</code> 函数又会被 <code>dictAddRaw</code> 函数调用<br> <code>dictAddRaw</code> 会被 <code>dictAdd</code> <code>dictRelace</code> <code>dictAddorFind</code> <code>sentinelLeaderIncr</code> <code>setTypeAdd</code> <code>zunionInterGenericCommand</code> 函数调用</p>
<p>  当我们往 Redis 中写入新的键值对或是修改键值对时，Redis 都会判断下是否需要进行 rehash。<br>  这里你可以参考下面给出的示意图，其中就展示了 _dictExpandIfNeeded 被调用的关系。</p>
<br>


<h2 id="3-2-渐进式rehash如何执行？"><a href="#3-2-渐进式rehash如何执行？" class="headerlink" title="(3.2) 渐进式rehash如何执行？"></a>(3.2) 渐进式rehash如何执行？</h2><p>  为什么要实现渐进式rehash？</p>
<p>  因为哈希表在执行rehash时，由于哈希表扩容，key对应的位置会改变，很多key就需要从原来的位置复制到新的位置。<br>  而在键复制时，由于Redis主线程无法执行其他请求，会阻塞主线程，如果要复制的键特别多，Redis在执行哈希表扩容时，此时Redis Server对外是不可用的，这个是我们不能接受的。</p>
<p>  为了避免Redis Server在哈希表扩容时不可用，提出了渐进式 rehash 的方法。<br>  相当于把一次要干的很多事情分成多次要做的小事情。 把一次要复制的100万个key 转换为 10万次每次复制10个key，这样既不影响其他请求，也把哈希表扩容了。</p>
<p>渐进式rehash在代码层面是如何实现的呢？<br>  有两个关键函数：<code>dictRehash</code> 和 <code>_dictRehashStep</code>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * 执行N步增量rehashing。 
 * 如果仍有键从旧哈希表移动到新哈希表，则返回 1，否则返回 0。
 *
 * 请注意，重新散列步骤包括将一个桶(在使用链表时可能有不止一个键)从旧哈希表移动到新哈希表，
 * 但是由于哈希表的一部分可能由空白组成，因此不能保证 这个函数甚至会重新散列一个桶，
 * 因为它总共最多访问 N*10 个空桶，避免它所做的工作量将不受限制，并且该函数可能会阻塞很长时间。
 *
 * @param *d
 * @param n
 */</span>
<span class="token keyword">int</span> <span class="token function">dictRehash</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> empty_visits <span class="token operator">=</span> n<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 最多访问10倍的空桶 一个桶对应一个数组下标</span>
    <span class="token comment">// 如果哈希表没有进行rehashing 返回0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 循环</span>
    <span class="token comment">// n>0 并且 哈希表里已使用元素 > 0 时，进行</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>n<span class="token operator">--</span> <span class="token operator">&amp;&amp;</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">,</span> <span class="token operator">*</span>nextde<span class="token punctuation">;</span>

        <span class="token comment">// 避免ht[0]数组下标越界 </span>
        <span class="token function">assert</span><span class="token punctuation">(</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>d<span class="token operator">-></span>rehashidx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 哈希表ht[0]对应数组下标的元素为null 也就是 桶对应的元素为null</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>d<span class="token operator">-></span>rehashidx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 全局rehashidx+1  这里的rehashidx 就是要操作的 ht[0].table的下标对应的桶</span>
            d<span class="token operator">-></span>rehashidx<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>empty_visits <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 获取ht[0].table[rehashidx] 对应的桶 也就是链表(头)节点</span>
        <span class="token comment">// 备注 de是一个指针</span>
        de <span class="token operator">=</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>d<span class="token operator">-></span>rehashidx<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历链表  将这个桶中的所有键从旧的ht[0] 移到新的ht[1] </span>
        <span class="token comment">// de是链表头节点</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 不为空</span>
            <span class="token class-name">uint64_t</span> h<span class="token punctuation">;</span>
            
            nextde <span class="token operator">=</span> de<span class="token operator">-></span>next<span class="token punctuation">;</span>  <span class="token comment">// 后继节点</span>

            <span class="token comment">// 获取key在新ht[1]的下标</span>
            h <span class="token operator">=</span> <span class="token function">dictHashKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> de<span class="token operator">-></span>key<span class="token punctuation">)</span> <span class="token operator">&amp;</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span>
            <span class="token comment">// 尾插法</span>
            <span class="token comment">// 插入到 原来链表节点(可能为空)的前面</span>
            <span class="token comment">// de->next 是一个指针，操作会比较快</span>
            de<span class="token operator">-></span>next <span class="token operator">=</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新桶里链表的头节点</span>
            <span class="token comment">// 备注: de是一个指针，所以操作会比较快，不会太耗时</span>
            d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> de<span class="token punctuation">;</span>

            d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">// 更新ht[0]已使用个数</span>
            d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 更新ht[1]已使用个数</span>

            de <span class="token operator">=</span> nextde<span class="token punctuation">;</span> <span class="token comment">// 指向下一个链表节点</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 把ht[0].table[d->rehashidx] 对应桶的链表置空  </span>
        d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>d<span class="token operator">-></span>rehashidx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        d<span class="token operator">-></span>rehashidx<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 更新rehashidx</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 判断ht[0]的数据是否全部迁移完成 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 释放ht[0]内存空间</span>
        <span class="token function">zfree</span><span class="token punctuation">(</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把ht[0]指向ht[1]，以便接受正常的请求</span>
        d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 重置ht[1]的大小为0</span>
        <span class="token function">_dictReset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置全局哈希表的rehashidx标识为-1，表示rehash结束</span>
        d<span class="token operator">-></span>rehashidx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//返回0，表示ht[0]中所有元素都迁移完</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//返回1，表示ht[0]中仍然有元素没有迁移完</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * 此函数仅执行一个重新散列步骤，并且仅当没有安全迭代器绑定到我们的散列表时。 
 * 当在重新散列中间有迭代器时，不能弄乱两个散列表，否则某些元素可能会丢失或重复。
 *
 * 此函数由字典中的常见查找或更新操作调用，以便哈希表在主动使用时自动从 H1 迁移到 H2。
 *
 * @param *d
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_dictRehashStep</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// rehash一个桶的数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>iterators <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">dictRehash</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 
 * 以 ms+"delta" 毫秒rehash。 
 * "delta" 的值大于0，多数情况下小于1。 
 * 确切的上限取决于 dictRehash(d,100) 的运行时间。
 * 
 * @param *d
 * @param ms
 */</span>
<span class="token keyword">int</span> <span class="token function">dictRehashMilliseconds</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">int</span> ms<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">timeInMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ms时间戳</span>
    <span class="token keyword">int</span> rehashes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">dictRehash</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 一次rehash 100个桶</span>
        rehashes <span class="token operator">+=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token comment">// 超过指定时间，break</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">timeInMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start <span class="token operator">></span> ms<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> rehashes<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>dictAddRaw  -&gt; _dictRehashStep<br>dictGenericDelete -&gt; _dictRehashStep<br>dictFind -&gt; _dictRehashStep<br>dictGetRandomKey -&gt; _dictRehashStep<br>dictGetSomeKeys -&gt; _dictRehashStep </p>
<p>_dictRehashStep -&gt; dictRehash<br>incrementallyRehash -&gt; dictRehashMilliseconds -&gt; dictRehash </p>
<h2 id="3-3-渐进式rehash时，增删改查操作哪个哈希表"><a href="#3-3-渐进式rehash时，增删改查操作哪个哈希表" class="headerlink" title="(3.3) 渐进式rehash时，增删改查操作哪个哈希表?"></a>(3.3) 渐进式rehash时，增删改查操作哪个哈希表?</h2><p>  当部分bucket 执行 rehash，部分bucket还没有执行rehash，这时增删查请求操作是对ht[1]操作，还是ht[0] ?</p>
<p>  在新增操作时，调用<code>dictAdd</code>，会调用<code>dictAddRaw</code>，有一行代码专门对rehash做了处理，会保存到<code>ht[1]</code>，<code>ht = dictIsRehashing(d) ? &amp;d-&gt;ht[1] : &amp;d-&gt;ht[0];</code></p>
<p>  在更新操作时，调用<code>dictReplace</code>，会调用<code>dictAddRaw</code> -&gt; <code>_dictKeyIndex</code>，在查找key时有个判断 <code>for (table = 0; table &lt;= 1; table++)</code>，会在2个哈希表查找，然后通过指针替换entry，操作的是key所在的哈希表。</p>
<p>  在删除操作时，调用<code>dictDelete</code>方法，会对<code>ht[0]</code>和<code>ht[1]</code>都做删除， <code>for (table = 0; table &lt;= 1; table++)</code> 这行代码就是要对2个哈希表分表处理</p>
<p>  查询操作，调用<code>dictFind</code>方法，也是会对两个ht都查询，<code>for (table = 0; table &lt;= 1; table++)</code>，先查<code>ht[0]</code>，查到了返回，没有查到再查<code>ht[1]</code></p>
<h2 id="3-4-rehash扩容后有多大-rehash的结果"><a href="#3-4-rehash扩容后有多大-rehash的结果" class="headerlink" title="(3.4) rehash扩容后有多大-rehash的结果"></a>(3.4) rehash扩容后有多大-rehash的结果</h2><p>  在 Redis 中，rehash 对 哈希表空间的扩容是通过调用 dictExpand 函数来完成的。</p>
<p>  dictExpand 函数的参数有两个，一个是要扩容的 哈希表，另一个是要扩到的容量</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">
<span class="token comment">/*
 * 扩展或创建哈希表
 * 
 * @param *d 要扩容的哈希表
 * @param size 扩容后的容量
 */</span>
<span class="token keyword">int</span> <span class="token function">dictExpand</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 校验</span>
    <span class="token comment">// 如果已经在扩容 或者 扩容后的大小&lt;哈希表中已有的元素数 返回错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">||</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">></span> size<span class="token punctuation">)</span>
        <span class="token keyword">return</span> DICT_ERR<span class="token punctuation">;</span>

    dictht n<span class="token punctuation">;</span> <span class="token comment">// 新哈希表</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> realsize <span class="token operator">=</span> <span class="token function">_dictNextPower</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取扩容后的大小 (realsize >= size 并且 realsize是2的幂次方)</span>

    <span class="token comment">// 扩容后的大小 = 当前大小，返回错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>realsize <span class="token operator">==</span> d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token keyword">return</span> DICT_ERR<span class="token punctuation">;</span>

    <span class="token comment">// 为新的哈希表分配内存 并 将所有指针初始化为NULL</span>
    n<span class="token punctuation">.</span>size <span class="token operator">=</span> realsize<span class="token punctuation">;</span> <span class="token comment">// 大小</span>
    n<span class="token punctuation">.</span>sizemask <span class="token operator">=</span> realsize<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//  </span>
    n<span class="token punctuation">.</span>table <span class="token operator">=</span> <span class="token function">zcalloc</span><span class="token punctuation">(</span>realsize<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>dictEntry<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 分配内存</span>
    n<span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 未使用</span>

    <span class="token comment">// 这是第一次初始化吗？ 如果是这样，那不是真正的重新哈希，我们只是设置第一个哈希表，以便它可以接受keys。  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 未初始化</span>
        d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token punctuation">;</span>
        <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 为 增量哈希 准备第二个哈希表 // Prepare a second hash table for incremental rehashing</span>
    d<span class="token operator">-></span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token punctuation">;</span> <span class="token comment">// 设置哈希表</span>
    d<span class="token operator">-></span>rehashidx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 设置 rehash index</span>
    <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 哈希表的容量是2的幂次方 */</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">_dictNextPower</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> i <span class="token operator">=</span> DICT_HT_INITIAL_SIZE<span class="token punctuation">;</span> <span class="token comment">// 哈希表初始大小默认是4 </span>

    <span class="token comment">// 如果要扩容的大小已经超过最大值，则返回最大值加1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">>=</span> LONG_MAX<span class="token punctuation">)</span> <span class="token keyword">return</span> LONG_MAX <span class="token operator">+</span> <span class="token number">1LU</span><span class="token punctuation">;</span>

    <span class="token comment">// 这里是计算2的幂次方 获取一个>=size 的最小2的幂次方</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果扩容大小大于等于要扩容的值，就返回当前值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> size<span class="token punctuation">)</span>
            <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        i <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  为什么哈希表的容量要是2的幂次方？<br>  因为容量是2的幂次方，进行计算可以转换为位运算，位运算计算比较快。</p>
<br>

<h1 id="4-Redis里的Hash函数"><a href="#4-Redis里的Hash函数" class="headerlink" title="(4) Redis里的Hash函数"></a>(4) Redis里的Hash函数</h1><p>  当要将一个新的键值对添加到字典里面时， 程序需要先根据键值对的键计算出哈希值和索引值，然后再根据索引值，将包含新键值对的哈希表节点放到哈希表数组的指定索引上面。</p>
<p>  Hash 函数会影响 哈希表的查询效率及哈希冲突情况，那么，你能从 Redis 的源码中，找到 哈希表使用的是哪一种 Hash 函数吗？</p>
<p>  在rehash时，<code>dictRehash</code>函数里 从老的<code>ht[0]</code>把数据迁移到<code>ht[1]</code>的时候，需要计算key的hash，与sizemask计算获取数组下标，对应代码是 <code>h = dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[1].sizemask;</code></p>
<p>  <code>dictHashKey(d, de-&gt;key)</code> 调用了哈希函数，点进这个方法</p>
<p>  调用 <code>#define dictHashKey(d, key) (d)-&gt;type-&gt;hashFunction(key)</code>，也就是使用的 <code>hashFunction(key)</code> 这个函数</p>
<p>  想了想，Hash有多种实现，而且<code>struct dict</code>也定义了<code>dictType *type</code> </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictType</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint64_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>hashFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>keyDup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>valDup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>keyCompare<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>keyDestructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>valDestructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> dictType<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  看到这儿时，找了一下引用<code>dictType</code>的地方，发现有很多，排除掉<code>redis-cli.c</code> <code>sentinel.c</code> 感觉 <code>dict.c</code> 和 <code>server.c</code>里的概率更大<br>  看了一下<code>server.c</code>里的引用，有<code>setDictType</code> <code>zsetDictType</code> <code>dbDictType</code> 而且注释里写着 <code>/* hash function */</code><br>  看了<code>dictSdsHash</code>，对应 <code>dictGenHashFunction</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint64_t</span> <span class="token function">dictGenHashFunction</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">siphash</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>len<span class="token punctuation">,</span>dict_hash_function_seed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>  发现使用的<code>siphash.c</code>文件里的<code>siphash</code></p>
<p>  这个方法不太容易看懂，但是作用是计算一个key的hash值</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint64_t</span> <span class="token function">siphash</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">size_t</span> inlen<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">UNALIGNED_LE_CPU</span></span>
    <span class="token class-name">uint64_t</span> hash<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> <span class="token operator">*</span>out <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>hash<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token class-name">uint64_t</span> v0 <span class="token operator">=</span> <span class="token number">0x736f6d6570736575ULL</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> v1 <span class="token operator">=</span> <span class="token number">0x646f72616e646f6dULL</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> v2 <span class="token operator">=</span> <span class="token number">0x6c7967656e657261ULL</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> v3 <span class="token operator">=</span> <span class="token number">0x7465646279746573ULL</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> k0 <span class="token operator">=</span> <span class="token function">U8TO64_LE</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> k1 <span class="token operator">=</span> <span class="token function">U8TO64_LE</span><span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> m<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>end <span class="token operator">=</span> in <span class="token operator">+</span> inlen <span class="token operator">-</span> <span class="token punctuation">(</span>inlen <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> left <span class="token operator">=</span> inlen <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>inlen<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">56</span><span class="token punctuation">;</span>
    v3 <span class="token operator">^=</span> k1<span class="token punctuation">;</span>
    v2 <span class="token operator">^=</span> k0<span class="token punctuation">;</span>
    v1 <span class="token operator">^=</span> k1<span class="token punctuation">;</span>
    v0 <span class="token operator">^=</span> k0<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> in <span class="token operator">!=</span> end<span class="token punctuation">;</span> in <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        m <span class="token operator">=</span> <span class="token function">U8TO64_LE</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        v3 <span class="token operator">^=</span> m<span class="token punctuation">;</span>

        SIPROUND<span class="token punctuation">;</span>

        v0 <span class="token operator">^=</span> m<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span> b <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>in<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">48</span><span class="token punctuation">;</span> <span class="token comment">/* fall-thru */</span>
    <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span> b <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>in<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">40</span><span class="token punctuation">;</span> <span class="token comment">/* fall-thru */</span>
    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span> b <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>in<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> <span class="token comment">/* fall-thru */</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> b <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>in<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">;</span> <span class="token comment">/* fall-thru */</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> b <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>in<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token comment">/* fall-thru */</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> b <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>in<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">/* fall-thru */</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> b <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span>in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    v3 <span class="token operator">^=</span> b<span class="token punctuation">;</span>

    SIPROUND<span class="token punctuation">;</span>

    v0 <span class="token operator">^=</span> b<span class="token punctuation">;</span>
    v2 <span class="token operator">^=</span> <span class="token number">0xff</span><span class="token punctuation">;</span>

    SIPROUND<span class="token punctuation">;</span>
    SIPROUND<span class="token punctuation">;</span>

    b <span class="token operator">=</span> v0 <span class="token operator">^</span> v1 <span class="token operator">^</span> v2 <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">UNALIGNED_LE_CPU</span></span>
    <span class="token function">U64TO8_LE</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> hash<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="(5) 总结"></a>(5) 总结</h1><p>1、Redis 中的 dict 数据结构，采用「链式哈希」的方式存储，当哈希冲突严重时，会开辟一个新的哈希表，翻倍扩容，并采用「渐进式 rehash」的方式迁移数据</p>
<p>2、所谓「渐进式 rehash」是指，把很大块迁移数据的开销，平摊到多次小的操作中，目的是降低主线程的性能影响</p>
<p>3、Redis 中凡是需要 O(1) 时间获取 k-v 数据的场景，都使用了 dict 这个数据结构，也就是说 dict 是 Redis 中重中之重的「底层数据结构」</p>
<p>4、dict 封装好了友好的「增删改查」API，并在适当时机「自动扩容、缩容」，这给上层数据类型（Hash/Set/Sorted Set）、全局哈希表的实现提供了非常大的便利</p>
<p>5、例如，Redis 中每个 DB 存放数据的「全局哈希表、过期key」都用到了 dict：</p>
<p>6、「全局哈希表」在触发渐进式 rehash 的情况有 2 个：</p>
<ul>
<li>增删改查哈希表时：每次迁移 1 个哈希桶（文章提到的 dict.c 中的 _dictRehashStep 函数）</li>
<li>定时 rehash：如果 dict 一直没有操作，无法渐进式迁移数据，那主线程会默认每间隔 100ms 执行一次迁移操作。这里一次会以 100 个桶为基本单位迁移数据，并限制如果一次操作耗时超时 1ms 就结束本次任务，待下次再次触发迁移（文章没提到这个，详见 dict.c 的 dictRehashMilliseconds 函数）</li>
</ul>
<p>（注意：定时 rehash 只会迁移全局哈希表中的数据，不会定时迁移 Hash/Set/Sorted Set 下的哈希表的数据，这些哈希表只会在操作数据时做实时的渐进式 rehash）</p>
<p>7、dict 在负载因子超过 1 时（used: bucket size &gt;= 1），会触发 rehash。但如果 Redis 正在 RDB 或 AOF rewrite，为避免父进程大量写时复制，会暂时关闭触发 rehash。但这里有个例外，如果负载因子超过了 5（哈希冲突已非常严重），依旧会强制做 rehash（重点）</p>
<p>8、dict 在 rehash 期间，查询旧哈希表找不到结果，还需要在新哈希表查询一次</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/400379">Redis源码剖析与实战 - 03 如何实现一个性能优异的Hash表？</a><br>[2] <a target="_blank" rel="noopener" href="https://redisbook.readthedocs.io/en/latest/internal-datastruct/dict.html">Redis设计与实现 - 字典</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/redis/" rel="tag"># redis</a>
              <a href="/tags/database/" rel="tag"># database</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/01/01/redis-data-structure-simple-dynamic-string/" rel="prev" title="Redis 数据结构 简单动态字符串(SDS)">
                  <i class="fa fa-angle-left"></i> Redis 数据结构 简单动态字符串(SDS)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/01/08/redis-datatype-object/" rel="next" title="Redis 对象处理机制 redisObject">
                  Redis 对象处理机制 redisObject <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">WKQ</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"waline-server-one-omega.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎评论","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":false,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2023/01/07/redis-data-structure-hash-tables/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
